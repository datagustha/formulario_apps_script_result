<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gest√£o de Cadastros - RESULT</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    /* üî• ESTILOS DO SISTEMA */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    
    :root {
      --primary: #7E3E9A;
      --secondary: #A1CC4C;
      --accent: #FF6B35;
      --dark: #2D3047;
      --light: #FFFFFF;
      --success: #28A745;
      --warning: #FFC107;
      --danger: #DC3545;
      --info: #17A2B8;
      --gray: #6C757D;
      --border: #E0E0E0;
      --background: #F8F9FA;
    }
    
    body {
      background: var(--background);
      min-height: 100vh;
      padding: 20px;
      color: var(--dark);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--light);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .header {
      background: var(--primary);
      padding: 30px 40px;
      color: white;
      text-align: center;
    }

    
    .logo-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
    }
    
    .logo {
      width: 120px;
      height: 120px;
      background: white;
      padding: 15px;
      border-radius: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      object-fit: contain;
    }
    
    h1 {
      font-size: 2.8rem;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .subtitle {
      font-size: 1.3rem;
      opacity: 0.9;
    }
    
    .content {
      padding: 40px;
    }
    
 .card {
  background: var(--light);
  border-radius: 12px;
  padding: 30px;
  margin-bottom: 25px;
  margin-top: 40px; /* üî• ADICIONE ESTA LINHA - ESPA√áO ACIMA */
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
  border: 1px solid var(--border);
}
    
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 3px solid var(--primary);
    }
    
    .card-header i {
      color: var(--primary);
      font-size: 1.8rem;
    }
    
    .card-title {
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--primary);
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #6a2e82;
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-warning {
      background: var(--warning);
      color: var(--dark);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-info {
      background: var(--info);
      color: white;
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-sm {
      padding: 8px 16px;
      font-size: 0.9rem;
    }

 /* üî• ESTILOS PARA BOT√ïES DE FILTRO ATIVOS */
.filtros-container .btn.active {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(126, 62, 154, 0.3);
  border: 2px solid var(--primary) !important;
}

/* Estilo espec√≠fico para o bot√£o "Todos" quando ativo */
.filtros-container .btn.active[onclick="filtrarTabela('all')"] {
  background: var(--primary) !important;
  color: white !important;
  border-color: var(--primary) !important;
}

/* Estilo para os outros bot√µes quando ativos */
.filtros-container .btn.active:not([onclick="filtrarTabela('all')"]) {
  border: 2px solid var(--primary) !important;
  box-shadow: 0 0 0 3px rgba(126, 62, 154, 0.2) !important;
}
    
    .btn-group {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }
    
    .message {
      padding: 15px 20px;
      border-radius: 8px;
      margin: 15px 0;
      display: none;
      align-items: center;
      gap: 10px;
    }
    
    .success {
      background: #d4edda;
      color: var(--success);
      border: 1px solid #c3e6cb;
    }
    
    .error {
      background: #f8d7da;
      color: var(--danger);
      border: 1px solid #f5c6cb;
    }
    
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    /* üî• ESTILOS DE LOADING */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* üî• ESTILOS DA TABELA */
    .table-container {
      margin-top: 20px;
      overflow: hidden;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .table-responsive {
      overflow-x: auto;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      table-layout: fixed;
    }
    
    .data-table th {
      background: var(--primary);
      color: white;
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 0.9rem;
      position: sticky;
      top: 0;
    }
    
    .data-table td {
      padding: 12px 8px;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
      word-wrap: break-word;
    }
    
    .data-table tbody tr {
      transition: all 0.3s ease;
      display: table-row;
    }
    
    .data-table tbody tr:hover {
      background: #f8f9fa;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .data-table .btn-sm {
      padding: 6px 12px;
      font-size: 0.8rem;
      margin: 2px;
    }
    
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-align: center;
      display: inline-block;
      min-width: 80px;
    }
    
    .acoes-cell {
      display: flex;
      gap: 5px;
      justify-content: center;
      align-items: center;
    }
    
.action-buttons {
  display: flex;
  gap: 15px;
  margin: 40px 0 20px 0; /* üî• ADICIONA ESPA√áO ACIMA E ABAIXO */
  flex-wrap: wrap;
  /* REMOVE: padding, background, border, border-radius */
}
    
    .cadastros-container {
      margin-top: 30px;
      padding: 25px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border: 2px solid var(--primary);
    }
    
    .cadastros-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .cadastro-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      border: 2px solid var(--border);
      transition: all 0.3s ease;
    }
    
    .cadastro-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .cadastro-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }
    
    .cadastro-nome {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--dark);
    }
    
    .cadastro-situacao {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .situacao-cadastrado {
      background: #D1E7DD;
      color: #0F5132;
    }

    .situacao-novo-registro {
      background-color: #bfe1f6 !important;
      color: #0c5aa3 !important;
      border: 1px solid #8bc9f0 !important;
    }
    
    .situacao-andamento {
      background: #FFF3CD;
      color: #856404;
    }
    
    .situacao-rejeitado {
      background: #E2E3E5;
      color: #383D41;
    }
    
    .situacao-descredenciado {
      background: #F8D7DA;
      color: #721C24;
    }

    .situacao-desistiu {
      background: #e6cff2 !important;
      color: #4a1e6b !important;
      border: 1px solid #d4b5e6 !important;
    }
    
    .cadastro-info {
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    
    .cadastro-info strong {
      color: var(--primary);
    }
    
    .mensalidade-badge {
      background: var(--primary);
      color: white;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .filtros-container {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 10px; /* üî• ADICIONE ESTA LINHA */
    }

    .filtros-eventos {
      display: none;
      margin-top: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

/* üî• ESTILOS PARA FILTRO DE EVENTOS COM SEARCH */
.filtro-search-container {
  margin: 15px 0;
  padding: 15px;
  background: var(--light);
  border-radius: 10px;
  border: 1px solid var(--border);
}

.suggestions-evento {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid var(--primary);
  border-top: none;
  border-radius: 0 0 8px 8px;
  z-index: 1000;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  max-height: 200px;
  overflow-y: auto;
  margin-top: -2px;
}

.suggestion-evento-item {
  padding: 10px 15px;
  cursor: pointer;
  border-bottom: 1px solid var(--border);
  transition: all 0.2s ease;
  font-size: 0.9rem;
}

.suggestion-evento-item:hover {
  background: var(--primary);
  color: white;
}

.suggestion-evento-item:last-child {
  border-bottom: none;
}

.suggestion-evento-section {
  background: var(--primary);
  color: white;
  font-weight: 700;
  padding: 8px 15px;
  font-size: 0.8rem;
  border-bottom: 1px solid var(--border);
}

.filtro-chip {
  background: white;
  border: 2px solid var(--border);
  border-radius: 20px;
  padding: 6px 12px;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
}

.filtro-chip.ativo {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.filtro-chip .remover {
  background: none;
  border: none;
  color: inherit;
  cursor: pointer;
  padding: 0;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
}

.filtro-chip .remover:hover {
  background: rgba(255,255,255,0.3);
}
    
    /* üî• ESTILOS PARA PESQUISA */
    .search-container {
      position: relative;
    }

    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--primary);
      border-top: none;
      border-radius: 0 0 10px 10px;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      margin-top: -2px;
      max-height: 300px;
      overflow-y: auto;
    }

    .suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: all 0.2s ease;
      font-size: 1rem;
      font-weight: 500;
    }

    .suggestion-item:hover {
      background: var(--primary);
      color: white;
      font-weight: 600;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-section {
      background: var(--primary);
      color: white;
      font-weight: 700;
      padding: 10px 16px;
      font-size: 0.9rem;
      border-bottom: 1px solid var(--border);
    }

    .contador-lojas {
      background: var(--primary);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    /* üî• ESTILOS PARA CAMPOS OBRIGAT√ìRIOS */
    .form-label.obrigatorio::after {
      content: " *";
      color: var(--danger);
      font-weight: bold;
      margin-left: 2px;
    }

    .campo-obrigatorio {
      border-left: 4px solid var(--danger) !important;
      background-color: #fff5f5 !important;
    }

    .aviso-obrigatorio {
      color: var(--danger);
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 5px;
      display: none;
    }

    /* üî•üî•üî• ADICIONE ESTE CSS AQUI - ESTILOS MELHORADOS PARA VALIDA√á√ÉO */
    .form-control.campo-obrigatorio,
    select.campo-obrigatorio {
      border: 2px solid var(--danger) !important;
      background-color: #fff5f5 !important;
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1) !important;
      animation: pulse 0.5s ease-in-out;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

    /* Destaque para a se√ß√£o de fornecedores quando inv√°lida */
    .fornecedores-invalido {
      border: 2px solid var(--danger) !important;
      background: #fff5f5 !important;
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    /* üî• ESTILOS PARA BOT√ïES DE A√á√ÉO NA TABELA */
    .btn-editar {
      background: var(--primary);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }
    
    .btn-editar:hover {
      background: #6a2e82;
    }
    
    .btn-visualizar {
      background: var(--info);
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }
    
    .btn-visualizar:hover {
      background: #138496;
    }

    /* üîÑ ESTILOS PARA O LOADING OVERLAY */
    #loadingOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .loading-content {
      background: white;
      padding: 40px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      min-width: 300px;
      border: 3px solid var(--primary);
    }

    .loading-spinner-large {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    .loading-text {
      margin: 0;
      color: var(--dark);
      font-weight: bold;
      font-size: 18px;
    }

    .loading-subtext {
      margin: 8px 0 0 0;
      color: var(--gray);
      font-size: 14px;
    }

    /* üî• ESTILOS PARA O MODAL DE DETALHES */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      border: 3px solid var(--primary);
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--primary);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
    }

    .btn-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray);
      padding: 5px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .btn-close:hover {
      background: var(--danger);
      color: white;
    }

    .detalhes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .detalhe-item {
      margin-bottom: 12px;
    }

    .detalhe-label {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 5px;
      display: block;
    }

    .detalhe-valor {
      color: var(--dark);
      background: #f8f9fa;
      padding: 8px 12px;
      border-radius: 8px;
      border-left: 3px solid var(--primary);
    }

    
/* üî•üî•üî• CORRE√á√ÉO DEFINITIVA - LARGURAS E ALINHAMENTO */
.data-table {
  table-layout: fixed;
  width: 100%;
}

/* üî• LARGURAS DAS COLUNAS */
.data-table th:nth-child(1),
.data-table td:nth-child(1) {
  width: 25%; /* Raz√£o Social */
}

.data-table th:nth-child(2),
.data-table td:nth-child(2) {
  width: 14%; /* CNPJ */
}

.data-table th:nth-child(3),
.data-table td:nth-child(3) {
  width: 20%; /* Fornecedor */
}

.data-table th:nth-child(4),
.data-table td:nth-child(4) {
  width: 12%; /* Mensalidade */
}

.data-table th:nth-child(5),
.data-table td:nth-child(5) {
  width: 12%; /* Ades√£o */
}

.data-table th:nth-child(6),
.data-table td:nth-child(6) {
  width: 17%; /* A√ß√µes */
}



/* üî• CORRE√á√ÉO ESPEC√çFICA PARA O BOT√ÉO VISUALIZAR */
.btn-visualizar-compact {
  padding: 8px 12px !important;
  font-size: 0.8rem !important;
  min-width: 100px;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
}

/* üî• GARANTIR QUE TODAS AS C√âLULAS TENHAM MESMA ALTURA */
.data-table tbody tr {
}


/* üî• EXCE√á√ÉO: Primeira coluna alinhada √† esquerda */
.data-table td:nth-child(1) {
  text-align: left;
  vertical-align: top !important;
}

/* üî• LARGURAS DAS COLUNAS */
.data-table th:nth-child(6),
.data-table td:nth-child(6) {
  width: 17%; /* A√ß√µes */
}




/* üî• ESTILOS MELHORADOS PARA O CAMPO DE EVENTO SEARCH - CAIXA MAIOR */
#inputEventoSearch {
  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%237E3E9A" width="18" height="18"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>');
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 18px;
  padding-right: 40px;
  cursor: pointer;
  
  /* üî• AUMENTAR TAMANHO DA FONTE E ALTURA */
  font-size: 16px;
  padding: 15px 20px;
  height: auto;
  min-height: 50px;
}

/* üî• CORRE√á√ÉO DEFINITIVA - REMOVER SCROLL HORIZONTAL */
.suggestions-evento-search {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 2px solid var(--primary);
  border-top: none;
  border-radius: 0 0 10px 10px;
  z-index: 1000;
  max-height: 300px;
  overflow-y: auto;
  overflow-x: hidden !important; /* üî• FOR√áA REMOVER SCROLL HORIZONTAL */
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  
  /* üî• GARANTIR QUE OS TEXTOS N√ÉO CAUSEM SCROLL */
  white-space: normal !important; /* üî• PERMITE QUEBRA DE LINHA */
  word-wrap: break-word !important; /* üî• QUEBRA PALAVRAS LONGAS */
  width: 100% !important; /* üî• GARANTIR LARGURA CORRETA */
}

/* üî• GARANTIR QUE OS ITENS QUEBREM LINHA SE PRECISAR */
.suggestion-evento-item-search {
  padding: 12px 16px;
  cursor: pointer;
  border-bottom: 1px solid var(--border);
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 10px;
  
  /* üî• PERMITIR QUEBRA DE TEXTO */
  white-space: normal !important;
  word-wrap: break-word !important;
  overflow-wrap: break-word !important;
  line-height: 1.4; /* üî• MELHOR ESPA√áAMENTO */
}

.suggestion-evento-item-search:hover {
  background: var(--primary);
  color: white;
  transform: translateX(5px);
}

.suggestion-evento-item-search:last-child {
  border-bottom: none;
}

/* üî• SE√á√ïES TAMB√âM */
.suggestion-evento-section-search {
  background: var(--primary);
  color: white;
  font-weight: 700;
  padding: 10px 16px;
  font-size: 0.9rem;
  border-bottom: 1px solid rgba(255,255,255,0.2);
  position: sticky;
  top: 0;
  display: flex;
  align-items: center;
  gap: 8px;
  
  white-space: normal !important;
  word-wrap: break-word !important;
  line-height: 1.4; /* üî• MELHOR ESPA√áAMENTO */
}

/* üî• CORRE√á√ÉO ADICIONAL PARA O CONTAINER DO INPUT */
#eventoFormGroup {
  position: relative;
  width: 100%;
}

#eventoFormGroup .suggestions-evento {
  width: 100% !important;
  left: 0 !important;
  right: 0 !important;
}

/* üî• CORRE√á√ÉO DO LABEL DA OBSERVA√á√ÉO */
.form-group:has(#observacoes) .form-label {
  margin-left: 100px !important;
  width: 85% !important;
}

/* üî• OBSERVA√á√ÉO MAIS PARA DIREITA */
#observacoes {
  margin-left: 50px !important;
  width: 90% !important;
  min-height: 100px;
}

/* üî• BOT√ïES MAIS PARA DIREITA */
.btn-group {
  display: flex;
  gap: 15px;
  margin-top: 25px;
  justify-content: flex-end !important; /* üî• ALINHA √Ä DIREITA */
  margin-left: auto; /* üî• EMPURRA PARA DIREITA */
  width: fit-content; /* üî• S√ì OCUPA O ESPA√áO NECESS√ÅRIO */
}

/* üî• OU SE PREFERIR ALINHAMENTO MAIS √Ä DIREITA */
.form-group:last-of-type {
  display: flex;
  justify-content: flex-end;
}

.form-group:last-of-type textarea {
  width: 95%;
  margin-left: auto;
}

  /* üî•üî•üî• CORRE√á√ÉO DEFINITIVA - ALINHAMENTO VERTICAL DA COLUNA A√á√ïES */
.data-table tbody tr {
    display: table-row;
    height: auto;
}

.data-table td {
    vertical-align: middle !important;
    padding: 15px 8px !important;
    height: 100% !important;
    border-bottom: 1px solid var(--border);
}

/* üî•üî•üî• CORRE√á√ÉO URGENTE - BOT√ÉO NO MEIO DA C√âLULA */
.data-table td:nth-child(6) {
    height: 100% !important;
    min-height: 100% !important;
    vertical-align: middle !important;
    padding: 0 !important;
    display: table-cell !important;
}

.acoes-cell {
    height: 100% !important;
    min-height: 100% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 0 !important;
    margin: 0 !important;
}

/* üî• GARANTIR QUE O BOT√ÉO OCUPE TODA A ALTURA */
.btn-visualizar-compact {
    height: 100% !important;
    min-height: 40px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 8px 12px !important;
    margin: 0 !important;
    width: 100%;
    border-radius: 6px !important;
}

/* üî• CORRE√á√ÉO DA PRIMEIRA COLUNA (mant√©m alinhamento ao topo) */
.data-table td:nth-child(1) {
    vertical-align: top !important;
}

/* üî• CORRE√á√ÉO DAS OUTRAS COLUNAS (alinhamento no meio) */
.data-table td:nth-child(2),
.data-table td:nth-child(3),
.data-table td:nth-child(4),
.data-table td:nth-child(5),
.data-table td:nth-child(6) {
    vertical-align: middle !important;
}

/* üî•üî•üî• ESTILOS PARA WAITLABELS */
.waitlabel-selector {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  padding: 20px;
  border-radius: 12px;
  border: 2px solid var(--border);
  margin-bottom: 25px;
}

.waitlabel-title {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.waitlabel-buttons {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.waitlabel-btn {
  padding: 12px 20px;
  border: 2px solid var(--border);
  border-radius: 8px;
  background: white;
  color: var(--dark);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 140px;
  justify-content: center;
}

.waitlabel-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.waitlabel-btn.active {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  border-width: 3px;
}

.waitlabel-indicator {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin-right: 5px;
}



.btn-aplicar-todos:hover {
  background: linear-gradient(135deg, #E55A2B 0%, #E57C2B 100%) !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3) !important;
}

/* üî• ESTILOS PARA CHECKBOXES APLICAR A TODOS */
.checkbox-aplicar-todos {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 8px;
  padding: 8px 12px;
  background: #fff8f0;
  border-radius: 6px;
  border-left: 3px solid #FF6B35;
}

.checkbox-aplicar-todos input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: #FF6B35;
}

.checkbox-aplicar-todos label {
  font-size: 0.85rem;
  color: #FF6B35;
  font-weight: 600;
  cursor: pointer;
}

/* üî• MODO APLICAR A TODOS ATIVO */
.modo-aplicar-todos .form-group {
  border: 2px solid #fff8f0;
  border-radius: 8px;
  padding: 15px;
  background: #fffdfa;
}

.modo-aplicar-todos .card-header {
  background: linear-gradient(135deg, #fff8f0 0%, #fff0e0 100%);
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 20px;
}
  
    @media (max-width: 768px) {
      .content {
        padding: 20px;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .btn-group {
        flex-direction: column;
      }

        h1 {
        font-size: 2.2rem;
      }
      
      .logo {
        width: 80px;
        height: 80px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .cadastros-grid {
        grid-template-columns: 1fr;
      }
      
      .card-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .filtros-container {
        margin-top: 15px;
      }
      
      .data-table {
        font-size: 0.8rem;
      }
      
      .acoes-cell {
        flex-direction: column;
      }
      
      .waitlabel-buttons {
        flex-direction: column;
      }
      
      .waitlabel-btn {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo-container">
        <img src="https://i.ibb.co/B2r5xtbS/sim-cred-5.png" class="logo" alt="SIM CRED">
        <div class="header-content">
          <h1>Sistema de Cadastros de Lojas</h1>
          <div class="subtitle">Situa√ß√£o e Acompanhamento de Lojas</div>
          <div class="version">
            <i class="fas fa-rocket"></i>
            Vers√£o 2.0
          </div>
        </div>
      </div>
    </div>
    
    <div class="content">
      <!-- üî•üî•üî• SE√á√ÉO WAITLABELS - ADICIONADA AQUI -->
      <div class="waitlabel-selector">
        <div class="waitlabel-title">
          <i class="fas fa-layer-group"></i>
          Selecione o White Label:
        </div>
        <div class="waitlabel-buttons" id="waitlabelButtons">
          <!-- Os bot√µes ser√£o preenchidos via JavaScript -->
        </div>
      </div>

      <!-- BOT√ïES DE A√á√ÉO SIMPLIFICADOS -->
      <div class="action-buttons">
        <button type="button" class="btn btn-primary" onclick="mostrarTodosCadastros()">
          <i class="fas fa-store"></i>
          Ver Todos os Cadastros
        </button>
        <button type="button" class="btn btn-info" onclick="limparBusca()">
          <i class="fas fa-broom"></i>
          Limpar Busca
        </button>
      </div>

      <!-- CARD DADOS DO CADASTRO -->
      <div class="card" id="cardCadastro">
        <div class="card-header">
          <i class="fas fa-info-circle"></i>
          <h2 class="card-title">Dados do Cadastro</h2>
          <!-- üî• LOCAL PARA T√çTULO DO MODO APLICAR A TODOS -->
          <div id="tituloAplicarTodos" style="display: none;"></div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-building"></i>
              Raz√£o Social
            </label>
            <input type="text" id="razao_social" class="form-control">
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-signature"></i>
              Nome Fantasia
            </label>
            <input type="text" id="nome_fantasia" class="form-control">
          </div>
          
          <!-- üî• CAMPO CNPJ ADICIONADO AQUI -->
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-id-card"></i>
              CNPJ
            </label>
            <input type="text" id="cnpj_cadastro" class="form-control" 
                   placeholder="Digite o CNPJ para cadastro..."
                   oninput="formatarCNPJ(this)">
          </div>
          
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-tag"></i>
              Tipo
            </label>
            <select id="tipo" class="form-control">
              <option value="">-- Selecione --</option>
              <option value="GERAL">GERAL</option>
              <option value="SORRIA SIM">SORRIA SIM</option>
              <option value="SORRIFACIL">SORRIFACIL</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-file-contract"></i>
              Contrato Enviado
            </label>
            <select id="contrato_enviado" class="form-control">
              <option value="">-- Selecione --</option>
              <option value="SIM">SIM</option>
              <option value="NAO">NAO</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-file-signature"></i>
              Contrato Assinado
            </label>
            <select id="contrato_assinado" class="form-control">
              <option value="">-- Selecione --</option>
              <option value="SIM">SIM</option>
              <option value="NAO">NAO</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-play-circle"></i>
              Ativa√ß√£o
            </label>
            <input type="date" id="ativacao" class="form-control">
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-link"></i>
              Link
            </label>
            <input type="text" id="link" class="form-control" placeholder="https://...">
          </div>
          
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-money-bill-wave"></i>
              Mensalidade
            </label>
            <input type="text" id="mensalidade" class="form-control" placeholder="R$ 0,00" oninput="formatarMoeda(this)">
          </div>

          <!-- üî• ADICIONE ESTE CAMPO AQUI - DEPOIS DO CAMPO MENSALIDADE -->
           <!-- ‚úÖ CORRETO - DEIXE ASSIM SIMPLES -->
            <div class="form-group">
  <label class="form-label" style="color: var(--primary); font-weight: 700;">
    <i class="fas fa-money-bill-wave" style="color: var(--primary);"></i>
    Mensalidade SIM
  </label>
  <input type="text" id="mensalidade_sim" name="mensalidade_sim" class="form-control" placeholder="R$ 0,00" oninput="formatarMoeda(this)">
</div>

          <!-- üî• CAMPO ADES√ÉO -->
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-handshake"></i>
              Ades√£o
            </label>
            <input type="text" id="adesao" class="form-control" placeholder="R$ 0,00" oninput="formatarMoeda(this)" value="R$ 0,00">
            <small style="color: var(--gray); font-size: 0.8rem;">
              <i class="fas fa-info-circle"></i> Valor "0,00" ser√° salvo como "Isento"
            </small>
          </div>
          
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-flag"></i>
              Situa√ß√£o
            </label>
            <select id="situacao" class="form-control">
              <option value="NOVO REGISTRO">NOVO REGISTRO</option>
              <option value="CADASTRADO">CADASTRADO</option>
              <option value="EM ANDAMENTO">EM ANDAMENTO</option>
              <option value="REJEITADO">REJEITADO</option>
              <option value="DESCREDENCIADO">DESCREDENCIADO</option>
              <option value="DESISTIU">DESISTIU</option>
            </select>
          </div>

          <!-- üî• FORNECEDORES COM TARIFAS INDIVIDUAIS -->
          <div class="form-group" style="grid-column: 1 / -1;">
            <label class="form-label">
              <i class="fas fa-truck"></i>
              Fornecedor(es) - <span style="color: var(--primary); font-weight: 600;">Selecione e configure cada um</span>
            </label>
            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 12px; border: 2px dashed var(--primary);">
              
              <!-- FORNECEDOR Agil -->
              <div class="fornecedor-item" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                  <input type="checkbox" name="fornecedor" value="Agil" style="width: 20px; height: 20px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'agil')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1.1rem;">AGIL</span>
                </div>
                <div id="config-agil" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 15px;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_agil" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_agil" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Valor da Tarifa</label>
                    <select name="percentual_agil" style="width: 100%; padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px;">
                      <option value="0%">0%</option>
                      <option value="1%">1%</option>
                      <option value="2%">2%</option>
                      <option value="3%">3%</option>
                      <option value="4%">4%</option>
                      <option value="5%">5%</option>
                      <option value="6%">6%</option>
                      <option value="7%">7%</option>
                      <option value="8%">8%</option>
                      <option value="9%">9%</option>
                      <option value="10%">10%</option>
                      <option value="11%">11%</option>
                      <option value="12%">12%</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- FORNECEDOR BC -->
              <div class="fornecedor-item" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                  <input type="checkbox" name="fornecedor" value="BC" style="width: 20px; height: 20px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'bc')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1.1rem;">BC</span>
                </div>
                <div id="config-bc" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 15px;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_bc" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_bc" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Valor da Tarifa</label>
                    <select name="percentual_bc" style="width: 100%; padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px;">
                      <option value="0%">0%</option>
                      <option value="1%">1%</option>
                      <option value="2%">2%</option>
                      <option value="3%">3%</option>
                      <option value="4%">4%</option>
                      <option value="5%">5%</option>
                      <option value="6%">6%</option>
                      <option value="7%">7%</option>
                      <option value="8%">8%</option>
                      <option value="9%">9%</option>
                      <option value="10%">10%</option>
                      <option value="11%">11%</option>
                      <option value="12%">12%</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- FORNECEDOR PARCELEX -->
              <div class="fornecedor-item" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                  <input type="checkbox" name="fornecedor" value="Parcelex" style="width: 20px; height: 20px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'parcelex')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1.1rem;">PARCELEX</span>
                </div>
                <div id="config-parcelex" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 15px;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_parcelex" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_parcelex" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Valor da Tarifa</label>
                    <select name="percentual_parcelex" style="width: 100%; padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px;">
                      <option value="0%">0%</option>
                      <option value="1%">1%</option>
                      <option value="2%">2%</option>
                      <option value="3%">3%</option>
                      <option value="4%">4%</option>
                      <option value="5%">5%</option>
                      <option value="6%">6%</option>
                      <option value="7%">7%</option>
                      <option value="8%">8%</option>
                      <option value="9%">9%</option>
                      <option value="10%">10%</option>
                      <option value="11%">11%</option>
                      <option value="12%">12%</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- FORNECEDOR AGORACRED -->
              <div class="fornecedor-item" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                  <input type="checkbox" name="fornecedor" value="Agoracred" style="width: 20px; height: 20px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'agoracred')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1.1rem;">AGORACRED</span>
                </div>
                <div id="config-agoracred" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 15px;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_agoracred" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_agoracred" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Valor da Tarifa</label>
                    <select name="percentual_agoracred" style="width: 100%; padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px;">
                      <option value="0%">0%</option>
                      <option value="1%">1%</option>
                      <option value="2%">2%</option>
                      <option value="3%">3%</option>
                      <option value="4%">4%</option>
                      <option value="5%">5%</option>
                      <option value="6%">6%</option>
                      <option value="7%">7%</option>
                      <option value="8%">8%</option>
                      <option value="9%">9%</option>
                      <option value="10%">10%</option>
                      <option value="11%">11%</option>
                      <option value="12%">12%</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- FORNECEDOR AFINZ -->
              <div class="fornecedor-item" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                  <input type="checkbox" name="fornecedor" value="Afinz" style="width: 20px; height: 20px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'afinz')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1.1rem;">AFINZ</span>
                </div>
                <div id="config-afinz" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 15px;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_afinz" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_afinz" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Valor da Tarifa</label>
                    <select name="percentual_afinz" style="width: 100%; padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px;">
                      <option value="0%">0%</option>
                      <option value="1%">1%</option>
                      <option value="2%">2%</option>
                      <option value="3%">3%</option>
                      <option value="4%">4%</option>
                      <option value="5%">5%</option>
                      <option value="6%">6%</option>
                      <option value="7%">7%</option>
                      <option value="8%">8%</option>
                      <option value="9%">9%</option>
                      <option value="10%">10%</option>
                      <option value="11%">11%</option>
                      <option value="12%">12%</option>
                    </select>
                  </div>
                </div>
              </div>

            </div>
          </div>

                    <!-- üî• MANTENHA EXATAMENTE ASSIM - S√ì ADICIONE UM ID NO FORM-GROUP -->
          <div class="form-group" id="eventoFormGroup">
            <label class="form-label">
              <i class="fas fa-calendar-check"></i>
              Evento
            </label>
            
            <!-- üî• MANTENHA O SELECT ORIGINAL, MAS VAMOS ESCONDER ELE -->
            <select id="evento" class="form-control" style="display: none;">
              <option value="">-- Selecione um evento --</option>
            </select>
            
            <!-- üî• AUMENTAR LARGURA DIRETAMENTE NO INPUT -->
            <div style="position: relative; width: 100%;">
              <input type="text" 
                     id="inputEventoSearch" 
                     class="form-control" 
                     placeholder="Digite para buscar evento..."
                     oninput="filtrarSugestoesEventoSearch()"
                     style="padding-right: 40px; width: 100%; min-width: 400px;">
              
              <div class="suggestions-evento" id="suggestionsEventoSearch" style="display: none;">
              </div>
            </div>

            <!-- ‚úÖ ‚úÖ ‚úÖ CORRE√á√ÉO DO CHECKBOX - MUDAR data-campo para "inputEventoSearch" -->
            <div class="checkbox-aplicar-todos">
              <input type="checkbox" id="check_eventos" data-campo="inputEventoSearch" onchange="toggleCampoParaTodos('inputEventoSearch')">
              <label for="check_eventos">
                  <i class="fas fa-copy"></i> Aplicar Evento a todos
              </label>
            </div>
          </div> <!-- ‚Üê ESTE </div> FECHA TUDO -->

          

 
<!-- OBSERVA√á√ÉO ALINHADA √Ä DIREITA -->
<div class="form-group" style="display: flex; justify-content: flex-end;">
  <div style="width: 95%;">
    <label class="form-label">
      <i class="fas fa-sticky-note"></i>
      Observa√ß√£o
    </label>
    <textarea id="observacoes" class="form-control" rows="3" style="width: 100%;"></textarea>
    <!-- üî• REMOVIDO O CHECKBOX DA OBSERVA√á√ÉO -->
  </div>
</div>

          <!-- BOT√ïES ALINHADOS √Ä DIREITA -->
          <div class="btn-group" style="justify-content: flex-end; margin-left: auto; width: fit-content;">
            <button type="button" class="btn btn-success" onclick="cadastrar()" id="btnCadastrar">
              <i class="fas fa-plus-circle"></i>
              Cadastrar
            </button>
            <button type="button" class="btn btn-warning" onclick="atualizar()" id="btnAtualizar" style="display: none;">
              <i class="fas fa-save"></i>
              Atualizar
            </button>

            <!-- üî• BOT√ÉO APLICAR A TODOS (APARECE QUANDO CONFIGURADO) -->
            <button type="button" class="btn btn-aplicar-todos" id="btnAplicarATodos" onclick="aplicarAlteracoesATodos()" style="display: none;">
              <i class="fas fa-copy"></i>
              Aplicar a Todos
            </button>
          </div>
        </div>
      </div>

      <!-- SE√á√ÉO: TODOS OS CADASTROS -->
      <div class="cadastros-container" id="secaoCadastros" style="display: none;">
        <div class="card-header">
          <i class="fas fa-store"></i>
          <h2 class="card-title" id="tituloCadastros">Todos os Cadastros</h2>
        </div>

        <!-- NOVA SE√á√ÉO: FILTRO POR SITUA√á√ÉO -->
        <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--primary);">
          <div style="font-weight: 600; color: var(--primary); margin-bottom: 10px;">
            <i class="fas fa-filter"></i> Filtrar por Situa√ß√£o:
          </div>
          <div class="filtros-container" id="filtrosContainer" style="display: none;">
            <button type="button" class="btn btn-outline btn-sm" onclick="filtrarTabela('all')">
              Todos
            </button>
            <button type="button" class="btn btn-sm" onclick="filtrarTabela('NOVO REGISTRO')" style="background-color: #bfe1f6; color: #2D3047; border: 1px solid #a1c9e4;">
              Novos
            </button>
            <button type="button" class="btn btn-success btn-sm" onclick="filtrarTabela('CADASTRADO')">
              Cadastrados
            </button>
            <button type="button" class="btn btn-warning btn-sm" onclick="filtrarTabela('EM ANDAMENTO')">
              Em Andamento
            </button>
            <!-- üî• CORRE√á√ÉO: REJEITADO AGORA √â CINZA -->
            <button type="button" class="btn btn-secondary btn-sm" onclick="filtrarTabela('REJEITADO')">
              Rejeitado
            </button>
            <!-- üî• CORRE√á√ÉO: DESCREDENCIADO AGORA √â VERMELHO -->
            <button type="button" class="btn btn-danger btn-sm" onclick="filtrarTabela('DESCREDENCIADO')">
              Descredenciados
            </button>
            <!-- NOVO BOT√ÉO DESISTIU -->
            <button type="button" class="btn btn-sm" onclick="filtrarTabela('DESISTIU')" style="background-color: #e6cff2; color: #4a1e6b; border: 1px solid #d4b5e6;">
              Desistiu
            </button>
          </div>

          <!-- BARRA DE PESQUISA MELHORADA -->
          <div class="form-group" style="margin-bottom: 20px;">
            <div class="search-container">
              <input type="text" id="pesquisaCadastros" class="form-control" 
                     placeholder="Pesquisar por nome, CNPJ ou fornecedor..."
                     oninput="filtrarPesquisa()">
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
              <span class="contador-lojas" id="contadorCadastros">0 cadastros</span>
              
              <div style="display: flex; gap: 10px; align-items: center;">
                <select id="ordenacaoCadastros" onchange="ordenarCadastros()" style="padding: 8px 12px; border: 2px solid var(--border); border-radius: 8px;">
                  <option value="razao_social">Ordenar por Raz√£o Social</option>
                  <option value="nome_fantasia">Ordenar por Nome Fantasia</option>
                  <option value="fornecedor">Ordenar por Fornecedor</option>
                  <option value="situacao">Ordenar por Situa√ß√£o</option>
                  <option value="defasagem">Ordenar por Defasagem</option>
                </select>
                
                <button type="button" class="btn btn-info btn-sm" onclick="recarregarCadastros()">
                  <i class="fas fa-sync-alt"></i> Atualizar
                </button>
              </div>
            </div>
          </div>

          <!-- üî• FILTRO DE EVENTOS COM SEARCH -->
          <div class="filtro-search-container" id="filtroEventoContainer" style="display: none; position: relative;">
            <div style="position: relative; width: 300px;">
              <input type="text" 
                     id="inputFiltroEvento" 
                     class="form-control" 
                     placeholder="Digite o evento para filtrar..."
                     oninput="filtrarSugestoesEvento()">
            </div>
            
            <div class="suggestions-evento" id="suggestionsEvento" style="display: none;">
              <!-- Sugest√µes aparecer√£o aqui -->
            </div>
            
            <!-- TAGS DE FILTROS ATIVOS -->
            <div id="tagsFiltrosAtivos" style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;"></div>
          </div>

          <!-- LOADING -->
          <div class="loading-container" id="loadingCadastros" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Carregando cadastros...</p>
          </div>
          
          <!-- TABELA MELHORADA -->
          <div class="table-container" id="tableContainer" style="display: none;">
            <div class="table-responsive">
              <table class="data-table" id="tabelaCadastros">
                <thead>
                  <tr>
                    <th>Raz√£o Social</th>
                    <th>CNPJ</th>
                    <th>Fornecedor</th>
                    <th>Mensalidade</th>
                    <th>Ades√£o</th>
                    <th>A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="tabelaCadastrosBody">
                  <!-- Dados ser√£o preenchidos via JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- MENSAGENS DO SISTEMA -->
      <div id="messageSuccess" class="message success" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <span></span>
      </div>
      
      <div id="messageError" class="message error" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span></span>
      </div>

      <div id="messageInfo" class="message info" style="display: none;">
        <i class="fas fa-info-circle"></i>
        <span></span>
      </div>
    </div>
  </div>

  <!-- üîÑ OVERLAY DE CARREGAMENTO -->
  <div id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner-large"></div>
      <p class="loading-text">Salvando dados...</p>
      <p class="loading-subtext">Aguarde um momento</p>
    </div>
  </div>

  <!-- üî• MODAL DE DETALHES - ESTRUTURA CORRIGIDA -->
  <div id="modalDetalhes" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">üìã Detalhes do Cadastro</h3>
        <button class="btn-close" onclick="fecharModalDetalhes()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div id="modalDetalhesContent">
        <!-- Conte√∫do ser√° preenchido via JavaScript -->
      </div>

      <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border);">
        <button class="btn btn-primary" onclick="fecharModalDetalhes()">
          <i class="fas fa-check"></i> Fechar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Senha - VERS√ÉO CORRIGIDA -->
  <div id="modalSenha" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">üîí Acesso Restrito</h3>
        <button class="btn-close" onclick="fecharModalSenha()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div style="padding: 20px;">
        <p>Para editar este campo √© necess√°rio informar a senha:</p>
        <input type="password" id="inputSenha" class="form-control" placeholder="Digite a senha" style="margin: 15px 0;">
        <div class="btn-group">
          <button class="btn btn-primary" onclick="validarSenha()">
            <i class="fas fa-check"></i> Validar
          </button>
          <button class="btn btn-outline" onclick="fecharModalSenha()">
            <i class="fas fa-times"></i> Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
// üî• VARI√ÅVEIS GLOBAIS

// üî• VARI√ÅVEIS PARA "APLICAR A TODOS"
let camposParaAplicarATodos = {};
let cnpjAtualParaAplicar = null;
let cadastroAtualId = null;
let todosCadastros = [];
let cadastrosFiltrados = [];
let campoEditavel = null;
const SENHA_PERMITIDA = '519901';
let waitlabelAtual = 'Sim_Facilita'; // üî• VARI√ÅVEL PARA WAITLABEL ATUAL

// üî• CONFIGURA√á√ÉO DOS WAITLABELS
const WAITLABELS_CONFIG = {
  WAITLABELS: ['Sim_Facilita', 'Result', 'Set_9', 'Doktorbank', 'Dr_Parcela'],
  CORES: {
    'Sim_Facilita': '#7E3E9A',
    'Result': '#2EBE76', 
    'Set_9': '#0682c5',
    'Doktorbank': '#E61B72',
    'Dr_Parcela': '#696969'
  }
};

// üî• VARI√ÅVEIS DOS EVENTOS PARA FILTRO - CONVERTIDAS PARA MAI√öSCULAS
const eventosNovoRegistro = [
  "NOVO CADASTRO", "PRIMEIRO CONTATO", "CLIENTE INTERESSADO", "SOLICITOU MAIS INFORMACOES",
  "AGENDAMENTO DE DEMONSTRACAO", "PROPOSTA ENVIADA", "AGUARDANDO RETORNO"
].sort();

const eventosCadastrado = [
  "LOJA CADASTRADA", "DOCUMENTACAO RECEBIDA", "CONTRATO ENVIADO", "AGUARDANDO ASSINATURA",
  "CADASTRO APROVADO", "AGUARDANDO ATIVACAO"
].sort();

const eventosEmAndamento = [
  "AGUARDANDO ACEITE DA LOJA", "AGUARDANDO ACEITE DO FORNECEDOR", "AGUARDANDO DOCUMENTOS",
  "AGUARDANDO RETORNO", "AGENDAMENTO DE DEMONSTRACAO", "CLIENTE INTERESSADO", 
  "CLIENTE NAO INTERESSADO", "CONDICAO ESPECIAL", "CONTRATO ASSINADO", "DESISTIU",
  "DOCUMENTACAO INCOMPLETA", "EM IMPLANTACAO", "EM TREINAMENTO", "ENVIO DE BOLETO",
  "ENVIO DE WHATSAPP", "FOLLOW-UP NECESSARIO", "FORNECEDOR ALTERADO", "LIGACAO REALIZADA",
  "NEGOCIACAO EM ANDAMENTO", "PAGAMENTO EFETUADO", "PAGAMENTO PENDENTE", "PROPOSTA ENVIADA",
  "QUANTIDADE DE LOJAS ALTERADA", "RECADO REGISTRADO", "REUNIAO AGENDADA", "SEM RETORNO",
  "SOLICITOU MAIS INFORMACOES", "TELEFONE ALTERADO"
].sort();

const eventosRejeitado = [
  "REJEITADO", "BLOQUEADO", "DESISTIU", "CLIENTE NAO INTERESSADO", "SEM RETORNO",
  "NEGOCIACAO PARADA", "PROCESSO ESTAGNADO"
].sort();

const eventosDescredenciado = [
  "DESCREDENCIADO", "CONTRATO CANCELADO", "LOJA DESATIVADA", "FORNECEDOR REMOVIDO",
  "PROCESSO ENCERRADO", "CADASTRO EXPIRADO"
].sort();

// üî• NOVOS EVENTOS PARA SITUA√á√ÉO "DESISTIU"
const eventosDesistiu = [
  "DESISTIU", "CLIENTE DESISTIU", "DESIST√äNCIA DO CLIENTE", "DESIST√äNCIA VOLUNT√ÅRIA",
  "DESISTIU DO PROCESSO", "DESISTIU DA NEGOCIA√á√ÉO", "DESISTIU DO CADASTRO",
  "N√ÉO QUIS CONTINUAR", "DESINTERESSE DO CLIENTE", "ABANDONOU O PROCESSO"
].sort();

// ‚úÖ VERIFICAR SE USU√ÅRIO J√Å EST√Å AUTORIZADO AO CARREGAR A P√ÅGINA
document.addEventListener('DOMContentLoaded', function() {
  console.log('Sistema de Gest√£o de Cadastros - RESULT inicializado');
  
  // üî• INICIALIZAR WAITLABELS
  inicializarWaitlabels();
  
  // Inicializar valores padr√£o
  document.getElementById('mensalidade').value = 'R$ 0,00';
  document.getElementById('situacao').value = 'Cadastrado';
  
  // Configura√ß√µes iniciais
  configurarValidacaoEmTempoReal();
  document.getElementById('situacao').addEventListener('change', atualizarEventos);
  atualizarEventos();
  
  // üî• CORRE√á√ÉO: Configurar prote√ß√£o AP√ìS o DOM estar carregado
  setTimeout(() => {
    configurarCamposProtegidos();
  }, 500);
  
  // Configurar eventos do modal de senha
  configurarModalSenha();
  
  // üî•üî•üî• NOVA LINHA: Sincronizar campos de evento
  sincronizarCamposEvento();
  
  // üî•üî•üî• CORRE√á√ÉO: Configurar evento do campo de evento
  const inputEvento = document.getElementById('inputEventoSearch');
  if (inputEvento) {
    inputEvento.addEventListener('focus', function() {
      console.log("üéØ Campo de evento recebeu foco - mostrando sugest√µes");
      filtrarSugestoesEventoSearch();
    });
  }
});

// üî•üî•üî• FUN√á√ïES PARA WAITLABELS
function inicializarWaitlabels() {
  console.log("üéØ Inicializando waitlabels...");
  
  // Buscar waitlabel atual do servidor
  google.script.run
    .withSuccessHandler(function(waitlabel) {
      waitlabelAtual = waitlabel;
      console.log("‚úÖ Waitlabel atual:", waitlabelAtual);
      criarBotoesWaitlabels();
      atualizarInterfaceWaitlabel();
    })
    .withFailureHandler(function(error) {
      console.error("‚ùå Erro ao buscar waitlabel:", error);
      criarBotoesWaitlabels(); // Criar mesmo com erro
    })
    .getWaitlabelAtual();
}

// üî• FUN√á√ïES PARA "APLICAR A TODOS"
function toggleCampoParaTodos(campoId) {
    console.log("üéØ Toggle campo para aplicar a todos:", campoId);
    
    // ‚úÖ CORRE√á√ÉO: Se for o campo de evento search, usar 'evento' como ID
    const campoParaAplicar = campoId === 'inputEventoSearch' ? 'evento' : campoId;
    
    // Alternar estado do campo
    camposParaAplicarATodos[campoParaAplicar] = !camposParaAplicarATodos[campoParaAplicar];
    
    // Atualizar visual do checkbox
    const checkbox = document.querySelector(`[data-campo="${campoId}"]`);
    if (checkbox) {
        checkbox.checked = camposParaAplicarATodos[campoParaAplicar];
    }
    
    console.log("üìã Campos selecionados para aplicar:", camposParaAplicarATodos);
}

function aplicarAlteracoesATodos() {
    console.log("üéØ Aplicando altera√ß√µes a todos do mesmo CNPJ...");
    
    const btnAplicar = document.getElementById('btnAplicarATodos');
    if (btnAplicar && btnAplicar.disabled) {
        console.log("‚è≥ Bot√£o j√° est√° processando, aguarde...");
        return;
    }
    
    if (btnAplicar) {
        btnAplicar.disabled = true;
        btnAplicar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aplicando...';
    }
    
    const camposSelecionados = Object.keys(camposParaAplicarATodos).filter(campo => camposParaAplicarATodos[campo]);
    
    if (camposSelecionados.length === 0) {
        showMessage('error', '‚ùå Selecione pelo menos um campo para aplicar a todos!');
        if (btnAplicar) {
            btnAplicar.disabled = false;
            btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
        }
        return;
    }
    
    const dadosAtuais = coletarDadosFormulario();
    if (!dadosAtuais) {
        showMessage('error', '‚ùå Erro ao coletar dados do formul√°rio');
        if (btnAplicar) {
            btnAplicar.disabled = false;
            btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
        }
        return;
    }
    
    const cnpjCorreto = document.getElementById('cnpj_cadastro')?.value || dadosAtuais.cnpj;
    
    if (!cnpjCorreto) {
        showMessage('error', '‚ùå CNPJ n√£o identificado!');
        if (btnAplicar) {
            btnAplicar.disabled = false;
            btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
        }
        return;
    }
    
    // MOSTRAR POPUP BONITO EM VEZ DO CONFIRM
    mostrarPopupAplicarTodos(cnpjCorreto, camposSelecionados, dadosAtuais);
}
    
// Fun√ß√£o para popup MAIS BONITO com tema roxo
// Fun√ß√£o para popup MAIS BONITO com tema roxo
function mostrarPopupAplicarTodos(cnpj, camposSelecionados, dados) {
    // ‚úÖ CORRE√á√ÉO: Formatar os valores ANTES de mostrar no popup
    const formatarValorParaPopup = (campo, valor) => {
        // Formatar data
        if (campo === 'ativacao' && valor && valor !== 'N√£o preenchido') {
            if (valor.includes('-')) {
                const partes = valor.split('-');
                if (partes.length === 3) {
                    return `${partes[2]}/${partes[1]}/${partes[0]}`;
                }
            }
            return valor;
        }
        
        // Formatar moeda
        if ((campo === 'mensalidade' || campo === 'adesao') && valor && valor !== 'N√£o preenchido') {
            if (typeof valor === 'number' || !isNaN(parseFloat(valor))) {
                const numero = parseFloat(valor);
                return numero.toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                });
            } else if (typeof valor === 'string') {
                // Tentar extrair n√∫mero da string
                const numeroMatch = valor.match(/[\d,\.]+/);
                if (numeroMatch) {
                    const numero = parseFloat(numeroMatch[0].replace(/\./g, '').replace(',', '.'));
                    if (!isNaN(numero)) {
                        return numero.toLocaleString('pt-BR', {
                            style: 'currency',
                            currency: 'BRL'
                        });
                    }
                }
            }
        }
        
        // Capitalizar evento
        if (campo === 'evento' && valor && valor !== 'N√£o preenchido') {
            return valor.charAt(0).toUpperCase() + valor.slice(1).toLowerCase();
        }
        
        return valor;
    };

    // Criar modal customizado ESTILOSO
    const modalHTML = `
        <div id="modalAplicarTodos" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:9999; font-family: 'Segoe UI', Arial, sans-serif;">
            <div style="background:linear-gradient(135deg, #ffffff 0%, #f8f6ff 100%); padding:25px; border-radius:15px; width:450px; box-shadow:0 10px 30px rgba(0,0,0,0.3); border:3px solid #8B5FBF; position:relative;">
                <!-- Header com gradiente roxo -->
                <div style="background:linear-gradient(135deg, #8B5FBF 0%, #6A4C9C 100%); color:white; padding:15px; margin:-25px -25px 20px -25px; border-radius:12px 12px 0 0; text-align:center;">
                    <h3 style="margin:0; font-size:20px; font-weight:600;">üéØ Aplicar Altera√ß√µes em Lote</h3>
                </div>
                
                <!-- Informa√ß√µes -->
                <div style="margin-bottom:20px;">
                    <div style="display:flex; align-items:center; margin-bottom:10px;">
                        <span style="background:#8B5FBF; color:white; padding:5px 10px; border-radius:20px; font-size:12px; font-weight:bold;">üìã CNPJ</span>
                        <span style="margin-left:10px; font-weight:600; color:#333;">${cnpj}</span>
                    </div>
                    
                    <div style="display:flex; align-items:center; margin-bottom:15px;">
                        <span style="background:#8B5FBF; color:white; padding:5px 10px; border-radius:20px; font-size:12px; font-weight:bold;">üè¢ Registros</span>
                        <span style="margin-left:10px; color:#666;">Todos com este CNPJ</span>
                    </div>
                </div>
                
                <!-- Campos que ser√£o alterados -->
                <div style="background:#f0ebfa; padding:15px; border-radius:10px; margin-bottom:20px; border-left:4px solid #8B5FBF;">
                    <div style="display:flex; align-items:center; margin-bottom:10px;">
                        <span style="color:#8B5FBF; font-weight:bold; font-size:16px;">üìù Campos Selecionados</span>
                    </div>
                    <div style="max-height:150px; overflow-y:auto;">
                      ${camposSelecionados.map(campo => {
                          const nomeCampo = formatarNomeCampoPopup(campo); // ‚úÖ USA A NOVA FUN√á√ÉO
                          let valorCampo = dados[campo] || document.getElementById(campo)?.value || 'N√£o preenchido';

                          // ‚úÖ APLICAR FORMATA√á√ÉO DIRETAMENTE AQUI
                          valorCampo = formatarValorParaPopup(campo, valorCampo);

                          return `
                              <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 5px; border-bottom:1px solid #e0e0e0;">
                                  <span style="color:#555; font-weight:500;">${nomeCampo}</span>
                                  <span style="background:#8B5FBF; color:white; padding:4px 8px; border-radius:12px; font-size:12px; font-weight:bold;">${valorCampo}</span>
                              </div>
                          `;
                      }).join('')}
                    </div>
                </div>
                
                <!-- Aviso -->
                <div style="background:#fff3cd; border:2px solid #ffc107; padding:12px; border-radius:8px; margin-bottom:20px; display:flex; align-items:center;">
                    <span style="color:#856404; font-size:24px; margin-right:10px;">‚ö†Ô∏è</span>
                    <span style="color:#856404; font-size:13px; font-weight:500;">Esta a√ß√£o atualizar√° TODOS os registros e n√£o pode ser desfeita</span>
                </div>
                
                <!-- Bot√µes -->
                <div style="display:flex; gap:12px; justify-content:flex-end;">
                    <button onclick="fecharPopupAplicarTodos(false)" style="padding:12px 20px; border:2px solid #6c757d; background:white; color:#6c757d; border-radius:8px; cursor:pointer; font-weight:600; transition:all 0.3s; display:flex; align-items:center; gap:5px;">
                        <span>‚úñ</span> Cancelar
                    </button>
                    <button onclick="fecharPopupAplicarTodos(true)" style="padding:12px 25px; background:linear-gradient(135deg, #28a745 0%, #20c997 100%); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; transition:all 0.3s; display:flex; align-items:center; gap:5px; box-shadow:0 4px 15px rgba(40, 167, 69, 0.3);">
                        <span>‚úÖ</span> Aplicar a Todos
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Fun√ß√µes auxiliares
// ‚úÖ CORRE√á√ÉO: Fun√ß√£o para padronizar nomes dos campos
const formatarNomeCampoPopup = (campo) => {
    const nomes = {
        'razao_social': 'Raz√£o Social',
        'nome_fantasia': 'Nome Fantasia', 
        'cnpj_cadastro': 'CNPJ',
        'tipo': 'Tipo',
        'contrato_enviado': 'Contrato Enviado',
        'contrato_assinado': 'Contrato Assinado',
        'ativacao': 'Ativa√ß√£o',
        'link': 'Link',
        'mensalidade': 'Mensalidade',
        'adesao': 'Ades√£o',
        'situacao': 'Situa√ß√£o',
        'evento': 'Evento',
        'observacoes': 'Observa√ß√µes',
        'inputEventoSearch': 'Evento'
    };
    
    return nomes[campo] || campo;
};

function obterValorCampo(campo, dados) {
    let valor = dados[campo] || document.getElementById(campo)?.value || 'N√£o preenchido';
    
    // ‚úÖ CORRE√á√ÉO 1: Formatar data para BR
    if (campo === 'ativacao' && valor && valor !== 'N√£o preenchido') {
        // Formato: 2025-10-02 ‚Üí 02/10/2025
        if (valor.includes('-')) {
            const partes = valor.split('-');
            if (partes.length === 3) {
                valor = `${partes[2]}/${partes[1]}/${partes[0]}`;
            }
        }
    }
    
    // ‚úÖ CORRE√á√ÉO 2: Formatar moeda para Mensalidade e Ades√£o
    if ((campo === 'mensalidade' || campo === 'adesao') && valor && valor !== 'N√£o preenchido') {
        if (typeof valor === 'number' || !isNaN(parseFloat(valor))) {
            // Se for n√∫mero, formatar como moeda
            const numero = parseFloat(valor);
            valor = numero.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        } else if (typeof valor === 'string' && !valor.includes('R$')) {
            // Se for string sem formata√ß√£o, tentar converter
            const numero = parseFloat(valor.replace(/[^\d,]/g, '').replace(',', '.'));
            if (!isNaN(numero)) {
                valor = numero.toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                });
            }
        }
    }
    
    // ‚úÖ CORRE√á√ÉO 3: Capitalizar primeira letra do Evento
    if (campo === 'evento' && valor && valor !== 'N√£o preenchido') {
        valor = valor.charAt(0).toUpperCase() + valor.slice(1).toLowerCase();
    }
    
    return valor;
}

function fecharPopupAplicarTodos(confirmado) {
    const modal = document.getElementById('modalAplicarTodos');
    if (modal) modal.remove();
    
    if (confirmado) {
        // Continuar com o processo original de aplicar a todos
        const btnAplicar = document.getElementById('btnAplicarATodos');
        const camposSelecionados = Object.keys(camposParaAplicarATodos).filter(campo => camposParaAplicarATodos[campo]);
        const dadosAtuais = coletarDadosFormulario();
        const cnpjCorreto = document.getElementById('cnpj_cadastro')?.value || dadosAtuais.cnpj;
        
        console.log("üöÄ CHAMANDO GOOGLE APPS SCRIPT...");
        showLoading(`Aplicando altera√ß√µes para ${camposSelecionados.length} campo(s)...`, "Atualizando todos os registros do mesmo CNPJ");
        
        google.script.run
            .withSuccessHandler(function(res) {
                console.log("‚úÖ RESPOSTA DO GS:", res);
                hideLoading();
                
                if (btnAplicar) {
                    btnAplicar.disabled = false;
                    btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
                }
                
                if (res && res.success) {
                    showMessage('success', `‚úÖ ${res.registrosAtualizados} registro(s) atualizado(s) com sucesso!`);
                    limparSelecaoAplicarATodos();
                    if (document.getElementById('secaoCadastros').style.display === 'block') {
                        mostrarTodosCadastros();
                    }
                } else {
                    showMessage('error', '‚ùå ' + (res ? res.message : 'Erro ao aplicar altera√ß√µes'));
                }
            })
            .withFailureHandler(function(error) {
                console.error("‚ùå ERRO DO GS:", error);
                hideLoading();
                
                if (btnAplicar) {
                    btnAplicar.disabled = false;
                    btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
                }
                
                showMessage('error', '‚ùå Erro: ' + error.message);
            })
            .aplicarAlteracoesATodos(cnpjCorreto, dadosAtuais, camposSelecionados);
    } else {
        // Usu√°rio cancelou - reativar bot√£o
        const btnAplicar = document.getElementById('btnAplicarATodos');
        if (btnAplicar) {
            btnAplicar.disabled = false;
            btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
        }
    }
}

function limparSelecaoAplicarATodos() {
    camposParaAplicarATodos = {};
    cnpjAtualParaAplicar = null;
    
    // Limpar checkboxes visuais
    document.querySelectorAll('[data-campo]').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Remover bot√£o "Aplicar a Todos"
    const btnAplicar = document.getElementById('btnAplicarATodos');
    if (btnAplicar) {
        btnAplicar.style.display = 'none';
    }
    
    // Remover checkboxes dos campos
    document.querySelectorAll('.checkbox-aplicar-todos').forEach(checkbox => {
        checkbox.remove();
    });
    
    // Remover t√≠tulo
    const titulo = document.getElementById('tituloAplicarTodos');
    if (titulo) {
        titulo.style.display = 'none';
        titulo.innerHTML = '';
    }
    
    // Remover classe do card
    document.getElementById('cardCadastro').classList.remove('modo-aplicar-todos');
}

// üî• FUN√á√ÉO PARA CONFIGURAR "APLICAR A TODOS"
function configurarAplicarATodos(cnpj, id) {
    console.log("üéØ CONFIGURANDO APLICAR A TODOS - CNPJ:", cnpj, "ID:", id);
    
    // Fechar modal atual
    fecharModalDetalhes();
    
    // Carregar o cadastro para edi√ß√£o
    editarCadastroModal(id);
    
    // Configurar para aplicar a todos do mesmo CNPJ
    setTimeout(() => {
        cnpjAtualParaAplicar = cnpj;
        cadastroAtualId = id;
        
        // Mostrar interface de "Aplicar a Todos"
        mostrarInterfaceAplicarATodos();
        
        showMessage('info', 'üéØ Modo "Aplicar a Todos" ativado! Selecione os campos que deseja aplicar.');
    }, 1000);
}

// üî• FUN√á√ÉO PARA MOSTRAR INTERFACE "APLICAR A TODOS"
function mostrarInterfaceAplicarATodos() {
    // Adicionar checkboxes em todos os campos
    adicionarCheckboxesAosCampos();
    
    // Mostrar bot√£o principal
    mostrarBotaoAplicarATodos();
    
    // Adicionar t√≠tulo especial
    const titulo = document.getElementById('tituloAplicarTodos');
    if (titulo) {
        titulo.style.display = 'block';
        titulo.innerHTML = `
            <div style="background: linear-gradient(135deg, #FF6B35 0%, #FF8E35 100%); color: white; padding: 10px 15px; border-radius: 8px; margin-top: 10px; text-align: center;">
                <i class="fas fa-copy"></i> <strong>MODO APLICAR A TODOS</strong> - CNPJ: ${cnpjAtualParaAplicar}
                <br><small>Selecione os campos que deseja aplicar a todos os registros deste CNPJ</small>
            </div>
        `;
    }
    
    // Adicionar classe especial ao card
    document.getElementById('cardCadastro').classList.add('modo-aplicar-todos');
}

// üî• FUN√á√ÉO PARA ADICIONAR CHECKBOXES AOS CAMPOS
function adicionarCheckboxesAosCampos() {
  const camposAplicaveis = [
    'razao_social', 'nome_fantasia', 'tipo', 'contrato_enviado', 
    'contrato_assinado', 'ativacao', 'link', 'mensalidade', 
    'mensalidade_sim', 'adesao', 'situacao', 'inputEventoSearch' // ‚úÖ J√Å EST√Å AQUI
  ];
    
    camposAplicaveis.forEach(campoId => {
        const campoElement = document.getElementById(campoId);
        if (campoElement) {
            const formGroup = campoElement.closest('.form-group');
            if (formGroup && !formGroup.querySelector('.checkbox-aplicar-todos')) {
                const checkboxHtml = `
                    <div class="checkbox-aplicar-todos">
                        <input type="checkbox" id="check_${campoId}" data-campo="${campoId}" 
                               onchange="toggleCampoParaTodos('${campoId}')">
                        <label for="check_${campoId}">
                            <i class="fas fa-copy"></i> Aplicar este campo a todos
                        </label>
                    </div>
                `;
                formGroup.insertAdjacentHTML('beforeend', checkboxHtml);
            }
        }
    });
}

// üî• DEBUG COMPLETO DO BOT√ÉO - COLE ISSO NO SEU C√ìDIGO
function debugBotaoAplicarTodos() {
    console.log("=== üêõ DEBUG INICIADO ===");
    
    // 1. Verificar se o bot√£o existe
    const btn = document.getElementById('btnAplicarATodos');
    console.log("1. Bot√£o encontrado?", !!btn);
    
    if (!btn) {
        console.log("‚ùå ERRO: Bot√£o n√£o existe no DOM!");
        console.log("üîç Procurando por qualquer bot√£o...");
        const todosBotoes = document.querySelectorAll('button');
        console.log("Total de bot√µes na p√°gina:", todosBotoes.length);
        todosBotoes.forEach((botao, index) => {
            console.log(`Bot√£o ${index}:`, botao.textContent, botao.id);
        });
        return;
    }
    
    // 2. Verificar estilo e visibilidade
    console.log("2. Display:", btn.style.display);
    console.log("3. Visibilidade:", btn.style.visibility);
    console.log("4. Opacidade:", btn.style.opacity);
    console.log("5. Desabilitado:", btn.disabled);
    console.log("6. Posi√ß√£o:", btn.getBoundingClientRect());
    
    // 3. Verificar eventos
    console.log("7. Tem onclick?", !!btn.onclick);
    console.log("8. Tem event listeners?", btn.hasAttribute('onclick'));
    
    // 4. For√ßar visibilidade para teste
    btn.style.display = 'block';
    btn.style.background = '#ff0000';
    btn.style.color = 'white';
    btn.style.border = '3px solid yellow';
    btn.style.fontSize = '16px';
    btn.style.fontWeight = 'bold';
    btn.style.zIndex = '99999';
    
    // 5. Adicionar evento de clique DIRETO
    btn.onclick = function(e) {
        console.log("üéØüéØüéØ CLIQUE CAPTURADO DIRETAMENTE!");
        e.preventDefault();
        e.stopPropagation();
        alert("BOT√ÉO CLICADO - FUNCIONA!");
        return false;
    };
    
    console.log("‚úÖ Bot√£o configurado para teste - deve estar VERMELHO!");
}

// üî• FUN√á√ÉO PARA MOSTRAR BOT√ÉO PRINCIPAL "APLICAR A TODOS"
function mostrarBotaoAplicarATodos() {
    const btnAplicar = document.getElementById('btnAplicarATodos');
    if (btnAplicar) {
        btnAplicar.style.display = 'block';
    }
}

function criarBotoesWaitlabels() {
  const container = document.getElementById('waitlabelButtons');
  let html = '';
  
  WAITLABELS_CONFIG.WAITLABELS.forEach(waitlabel => {
    const cor = WAITLABELS_CONFIG.CORES[waitlabel];
    const isActive = waitlabel === waitlabelAtual;
    const classeAtiva = isActive ? 'active' : '';
    
    // üî• CORRE√á√ÉO: Aplicar cor dinamicamente via style
    html += `
      <button class="waitlabel-btn ${classeAtiva}" 
              onclick="selecionarWaitlabel('${waitlabel}')"
              style="border-color: ${cor}; ${isActive ? `background: ${cor}; color: white;` : `color: ${cor};`}">
        <span class="waitlabel-indicator" style="background: ${cor};"></span>
        ${formatarNomeWaitlabel(waitlabel)}
      </button>
    `;
  });
  
  container.innerHTML = html;
}

function formatarNomeWaitlabel(nome) {
  const formatacoes = {
    'Sim_Facilita': 'Sim Facilita',
    'Set_9': 'Set 9',
    'Doktorbank': 'DoktorBank',
    'Dr_Parcela': 'Dr Parcela',
    'Result': 'Result'
  };
  return formatacoes[nome] || nome;
}

function selecionarWaitlabel(waitlabel) {
  console.log("üéØ Selecionando waitlabel:", waitlabel);
  
  // Atualizar visualmente
  waitlabelAtual = waitlabel;
  criarBotoesWaitlabels();
  atualizarInterfaceWaitlabel();
  
  // Salvar no servidor
  google.script.run
    .withSuccessHandler(function(res) {
      console.log("‚úÖ Waitlabel salvo:", res);
      showMessage('success', `‚úÖ Waitlabel alterado para: ${formatarNomeWaitlabel(waitlabel)}`);
    })
    .withFailureHandler(function(error) {
      console.error("‚ùå Erro ao salvar waitlabel:", error);
      showMessage('error', '‚ùå Erro ao alterar waitlabel');
    })
    .setWaitlabelAtual(waitlabel);
}

function atualizarInterfaceWaitlabel() {
  // Atualizar cor do header baseado no waitlabel
  const header = document.querySelector('.header');
  const cor = WAITLABELS_CONFIG.CORES[waitlabelAtual] || '#7E3E9A';
  header.style.background = cor;
  
  // Atualizar t√≠tulo da se√ß√£o de cadastros
  const titulo = document.getElementById('tituloCadastros');
  if (titulo) {
    titulo.textContent = `Cadastros - ${formatarNomeWaitlabel(waitlabelAtual)}`;
  }
  
  console.log("üé® Interface atualizada para waitlabel:", waitlabelAtual);
}

// üî• MODIFICAR FUN√á√ïES EXISTENTES PARA USAR WAITLABEL
function cadastrar() {
  console.log("üéØ CADASTRAR: Iniciando cadastro no waitlabel:", waitlabelAtual);
  
  // ‚úÖ VALIDA√á√ÉO DE CAMPOS OBRIGAT√ìRIOS
  const camposInvalidos = validarCamposObrigatorios();
  if (camposInvalidos.length > 0) {
    showMessage('error', `‚ùå Preencha os campos obrigat√≥rios: ${camposInvalidos.join(', ')}`);
    return;
  }

  // ‚úÖ VALIDA√á√ÉO DE FORNECEDORES
  const fornecedoresSelecionados = document.querySelectorAll('input[name="fornecedor"]:checked');
  if (fornecedoresSelecionados.length === 0) {
    showMessage('error', '‚ùå Selecione pelo menos um fornecedor!');
    return;
  }

  // Coletar dados BASE (comuns a todos os fornecedores)
  const dadosBase = coletarDadosFormulario();
  if (!dadosBase) {
    showMessage('error', '‚ùå Erro ao coletar dados do formul√°rio');
    return;
  }

  console.log("üî¢ Fornecedores selecionados:", dadosBase.fornecedores.length);
  console.log("üìã Lista de fornecedores:", dadosBase.fornecedores);

  // ‚úÖ CORRE√á√ÉO CR√çTICA: Para CADASTRO, evento √© FIXO "Novo cadastro"
  dadosBase.evento = "Novo cadastro";
  dadosBase.acao = 'cadastrar';

  // Mostrar loading
  showLoading(`Cadastrando ${dadosBase.fornecedores.length} fornecedor(es) no ${formatarNomeWaitlabel(waitlabelAtual)}...`, `Loja: ${dadosBase.razao_social}`);

  const btnCadastrar = document.getElementById('btnCadastrar');
  btnCadastrar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cadastrando...';
  btnCadastrar.disabled = true;

  // ‚úÖ ENVIAR para Google Apps Script - USANDO WAITLABEL
  google.script.run
    .withSuccessHandler(function(res) {
      console.log("‚úÖ Resposta do cadastro MULTIPLO:", res);
      hideLoading();
      
      btnCadastrar.innerHTML = '<i class="fas fa-plus-circle"></i> Cadastrar';
      btnCadastrar.disabled = false;
      
      if (res.success) {
        showMessage('success', `‚úÖ ${res.message} - ${res.registrosCriados} registro(s) criado(s)`);
        limparFormulario();
      } else {
        showMessage('error', '‚ùå ' + res.message);
      }
    })
    .withFailureHandler(function(error) {
      console.error("‚ùå Erro no cadastro:", error);
      hideLoading();
      
      btnCadastrar.innerHTML = '<i class="fas fa-plus-circle"></i> Cadastrar';
      btnCadastrar.disabled = false;
      showMessage('error', '‚ùå Erro: ' + error.message);
    })
    .processarCadastroComWaitlabel(dadosBase, waitlabelAtual);
}

function atualizar() {
  console.log("üéØ ATUALIZAR: Iniciando atualiza√ß√£o no waitlabel:", waitlabelAtual);
  
  // ‚úÖ DEBUG 1: Verificar se tem ID
  console.log("üîç DEBUG 1: cadastroAtualId =", cadastroAtualId);
  
  if (!cadastroAtualId) {
    showMessage('error', '‚ùå Nenhum cadastro selecionado para atualizar!');
    return;
  }

  // ‚úÖ VALIDA√á√ÉO DE CAMPOS OBRIGAT√ìRIOS
  const camposInvalidos = validarCamposObrigatorios();
  console.log("üîç DEBUG 2: Campos inv√°lidos:", camposInvalidos);
  
  if (camposInvalidos.length > 0) {
    showMessage('error', `‚ùå Preencha os campos obrigat√≥rios: ${camposInvalidos.join(', ')}`);
    return;
  }

  // ‚úÖ VALIDA√á√ÉO DE FORNECEDORES
  const fornecedoresSelecionados = document.querySelectorAll('input[name="fornecedor"]:checked');
  console.log("üîç DEBUG 3: Fornecedores selecionados:", fornecedoresSelecionados.length);
  
  if (fornecedoresSelecionados.length === 0) {
    showMessage('error', '‚ùå Selecione pelo menos um fornecedor!');
    return;
  }

  // Coletar dados
  console.log("üîç DEBUG 4: Chamando coletarDadosFormulario()...");
  const dados = coletarDadosFormulario();
  console.log("üîç DEBUG 5: Dados coletados:", dados);
  
  if (!dados) {
    showMessage('error', '‚ùå Erro ao coletar dados do formul√°rio');
    return;
  }
  
  dados.acao = 'atualizar';
  dados.id = cadastroAtualId;
  
  console.log("üì§ Dados para atualiza√ß√£o:", dados);

  // Mostrar loading
  showLoading(`Atualizando ${dados.fornecedores.length} fornecedor(es) no ${formatarNomeWaitlabel(waitlabelAtual)}...`, `Loja: ${dados.razao_social}`);

  const btnAtualizar = document.getElementById('btnAtualizar');
  const btnOriginalHTML = btnAtualizar.innerHTML;
  btnAtualizar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
  btnAtualizar.disabled = true;

  console.log("üîç DEBUG 6: Chamando Google Apps Script...");

  // ‚úÖ CORRE√á√ÉO CR√çTICA: Usar processarCadastroComWaitlabel
  google.script.run
    .withSuccessHandler(function(res) {
      console.log("‚úÖ DEBUG 7: Resposta da atualiza√ß√£o:", res);
      hideLoading();
      
      btnAtualizar.innerHTML = btnOriginalHTML;
      btnAtualizar.disabled = false;
      
      if (res && res.success) {
        showMessage('success', '‚úÖ ' + res.message);
        
        // Atualizar a lista de cadastros se estiver vis√≠vel
        if (document.getElementById('secaoCadastros').style.display === 'block') {
          mostrarTodosCadastros();
        }
        
        // Voltar para modo cadastro
        limparFormulario();
      } else {
        showMessage('error', '‚ùå ' + (res ? res.message : 'Resposta inv√°lida do servidor'));
      }
    })
    .withFailureHandler(function(error) {
      console.error("‚ùå DEBUG 8: Erro na atualiza√ß√£o:", error);
      hideLoading();
      
      btnAtualizar.innerHTML = btnOriginalHTML;
      btnAtualizar.disabled = false;
      showMessage('error', '‚ùå Erro ao atualizar: ' + error.message);
    })
    .processarCadastroComWaitlabel(dados, waitlabelAtual);
}

function mostrarTodosCadastros() {
  console.log("üéØ Iniciando carregamento de cadastros do waitlabel:", waitlabelAtual);
  
  // üîÑ MOSTRAR LOADING
  showLoading(`Carregando cadastros do ${formatarNomeWaitlabel(waitlabelAtual)}...`, "Buscando todos os registros");
  
  // Mostrar loading da tabela tamb√©m
  const loading = document.getElementById('loadingCadastros');
  const tableContainer = document.getElementById('tableContainer');
  const filtrosContainer = document.getElementById('filtrosContainer');
  const secao = document.getElementById('secaoCadastros');

  loading.style.display = 'flex';
  tableContainer.style.display = 'none';
  filtrosContainer.style.display = 'none';
  secao.style.display = 'block';

  // ‚úÖ USAR FUN√á√ÉO COM WAITLABEL
  google.script.run
    .withSuccessHandler(function(cadastros) {
      // üîÑ ESCONDER LOADING
      hideLoading();
      
      console.log("‚úÖ Cadastros recebidos:", cadastros);
      
      if (cadastros && cadastros.length > 0) {
        // ‚úÖ ORDENAR POR NOME AUTOMATICAMENTE
        const cadastrosOrdenados = cadastros.sort((a, b) => {
          const nomeA = (a.razao_social || '').toLowerCase();
          const nomeB = (b.razao_social || '').toLowerCase();
          return nomeA.localeCompare(nomeB);
        });
        
        todosCadastros = cadastrosOrdenados;
        cadastrosFiltrados = [...cadastrosOrdenados];
        
        // ‚úÖ CORRE√á√ÉO: Usar a fun√ß√£o agrupada
        const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosOrdenados);
        exibirTabelaCadastrosAgrupada(cadastrosAgrupados, `Cadastros - ${formatarNomeWaitlabel(waitlabelAtual)}`);
        
        document.getElementById('filtrosContainer').style.display = 'flex';
        configurarFiltroEvento('all'); // ‚úÖ MOSTRAR FILTRO DE EVENTOS
        
        showMessage('success', `‚úÖ ${cadastros.length} cadastros carregados do ${formatarNomeWaitlabel(waitlabelAtual)}!`);
      } else {
        loading.style.display = 'none';
        tableContainer.style.display = 'block';
        document.getElementById('tabelaCadastrosBody').innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 40px;">
              <i class="fas fa-inbox" style="font-size: 3rem; color: var(--gray); margin-bottom: 15px;"></i>
              <h3>Nenhum cadastro encontrado</h3>
              <p>N√£o h√° cadastros no waitlabel ${formatarNomeWaitlabel(waitlabelAtual)}.</p>
            </td>
          </tr>
        `;
        showMessage('info', `üìù Nenhum cadastro encontrado no ${formatarNomeWaitlabel(waitlabelAtual)}.`);
      }
    })
    .withFailureHandler(function(error) {
      // üîÑ ESCONDER LOADING EM CASO DE ERRO
      hideLoading();
      
      console.error("‚ùå Erro ao carregar cadastros:", error);
      loading.style.display = 'none';
      showMessage('error', '‚ùå Erro ao carregar cadastros: ' + error.message);
    })
    .buscarTodosCadastrosComWaitlabel(waitlabelAtual);
}

// üî• ADICIONAR: Fun√ß√£o para buscar cadastro por CNPJ considerando waitlabel
function buscarPorCNPJComWaitlabel() {
  const cnpjBusca = document.getElementById('cnpj').value.replace(/\D/g, '');
  
  if (!cnpjBusca) {
    showMessage('error', 'Digite um CNPJ para buscar');
    return;
  }

  showMessage('info', `üîç Buscando cadastro no ${formatarNomeWaitlabel(waitlabelAtual)}...`);

  google.script.run
    .withSuccessHandler(function(dados) {
      preencherDadosCadastro(dados);
    })
    .withFailureHandler(function(error) {
      showMessage('error', 'Erro: ' + error.message);
    })
    .buscarTodosCadastrosPorCNPJComWaitlabel(cnpjBusca, waitlabelAtual);
}

// üî• CORRE√á√ÉO EXTRA - REMOVER SCROLL HORIZONTAL DINAMICAMENTE
function corrigirScrollHorizontal() {
  const suggestions = document.getElementById('suggestionsEventoSearch');
  if (suggestions) {
    suggestions.style.overflowX = 'hidden';
    suggestions.style.width = '100%';
    
    // For√ßar remo√ß√£o de scroll horizontal em todos os elementos filhos
    const allElements = suggestions.getElementsByTagName('*');
    for (let element of allElements) {
      element.style.overflowX = 'hidden';
      element.style.maxWidth = '100%';
    }
  }
}

// Executar quando as sugest√µes forem mostradas
document.addEventListener('click', function(e) {
  if (e.target.id === 'inputEventoSearch' || 
      (e.target.closest && e.target.closest('#suggestionsEventoSearch'))) {
    setTimeout(corrigirScrollHorizontal, 10);
  }
});

// Tamb√©m executar quando as sugest√µes forem atualizadas
const originalFiltrarSugestoesEventoSearch = filtrarSugestoesEventoSearch;
filtrarSugestoesEventoSearch = function() {
  originalFiltrarSugestoesEventoSearch();
  setTimeout(corrigirScrollHorizontal, 10);
};

// üî• C√ìDIGO TEMPOR√ÅRIO PARA DEBUG - TESTAR SE A FUN√á√ÉO √â CHAMADA
function testarAtualizacaoEventos() {
  console.log("üß™ TESTE: Chamando atualizarEventos() manualmente...");
  atualizarEventos();
}

// Testa ap√≥s 2 segundos (para voc√™ ver no console)
setTimeout(testarAtualizacaoEventos, 2000);

// üî• FUN√á√ïES DO MODAL DE SENHA - CORRIGIDAS
function configurarModalSenha() {
  // Configurar evento de Enter no input de senha
  const inputSenha = document.getElementById('inputSenha');
  if (inputSenha) {
    inputSenha.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        validarSenha();
      }
    });
  }
  
  // Fechar modal ao clicar fora
  const modalSenha = document.getElementById('modalSenha');
  if (modalSenha) {
    modalSenha.addEventListener('click', function(e) {
      if (e.target === this) {
        fecharModalSenha();
      }
    });
  }
  
  // Fechar modal com ESC
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('modalSenha').style.display === 'flex') {
      fecharModalSenha();
    }
  });
}

function solicitarSenha(campo) {
  campoEditavel = campo;
  
  // Mostrar modal
  document.getElementById('modalSenha').style.display = 'flex';
  
  // Limpar e focar no input
  const inputSenha = document.getElementById('inputSenha');
  if (inputSenha) {
    inputSenha.value = '';
    inputSenha.focus();
  }
}

function validarSenha() {
  const inputSenha = document.getElementById('inputSenha');
  if (!inputSenha) {
    console.log("‚ùå inputSenha n√£o encontrado");
    return;
  }
  
  const senha = inputSenha.value;
  console.log("üîê Validando senha:", senha);
  
  if (senha === SENHA_PERMITIDA) {
    console.log("‚úÖ SENHA CORRETA - Configurando autoriza√ß√£o di√°ria");
    
    // üî• CALCULAR EXPIRA√á√ÉO PARA 24 HORAS
    const agora = new Date();
    const expiracao = new Date(agora.getTime() + (24 * 60 * 60 * 1000)); // 24 horas
    
    // üî• SALVAR NO LOCALSTORAGE COM EXPIRA√á√ÉO
    localStorage.setItem('usuarioAutorizado', 'true');
    localStorage.setItem('autorizacaoExpiracao', expiracao.getTime().toString());
    localStorage.setItem('ultimaAutorizacao', agora.getTime().toString());
    
    console.log("üíæ Autoriza√ß√£o salva at√©:", expiracao.toLocaleString('pt-BR'));
    
    fecharModalSenha();
    
    // Liberar TODOS os campos protegidos
    liberarTodosCamposProtegidos();
    
    showMessage('success', '‚úÖ Todos os campos liberados por 24 horas!');
    
  } else {
    console.log("‚ùå SENHA INCORRETA");
    showMessage('error', '‚ùå Senha incorreta!');
    inputSenha.value = '';
    inputSenha.focus();
  }
}

function coletarDadosFormularioTemporario() {
  const dados = {
    razao_social: document.getElementById('razao_social').value,
    nome_fantasia: document.getElementById('nome_fantasia').value,
    cnpj_cadastro: document.getElementById('cnpj_cadastro').value,
    tipo: document.getElementById('tipo').value,
    observacoes: document.getElementById('observacoes').value,
    contrato_enviado: document.getElementById('contrato_enviado').value,
    contrato_assinado: document.getElementById('contrato_assinado').value,
    ativacao: document.getElementById('ativacao').value,
    link: document.getElementById('link').value,
    mensalidade: document.getElementById('mensalidade').value,
    situacao: document.getElementById('situacao').value,
    adesao: document.getElementById('adesao').value,
    evento: document.getElementById('inputEventoSearch').value
  };
  
  // Coletar fornecedores selecionados
  const fornecedoresSelecionados = [];
  const checkboxes = document.querySelectorAll('input[name="fornecedor"]:checked');
  checkboxes.forEach(checkbox => {
    const fornecedorNome = checkbox.value;
    const fornecedorId = fornecedorNome.toLowerCase();
    const configDiv = document.getElementById(`config-${fornecedorId}`);
    
    if (configDiv && configDiv.style.display === 'grid') {
      const tarifaRadio = document.querySelector(`input[name="tarifa_${fornecedorId}"]:checked`);
      const percentualSelect = document.querySelector(`select[name="percentual_${fornecedorId}"]`);
      
      fornecedoresSelecionados.push({
        nome: fornecedorNome,
        tarifa: tarifaRadio ? tarifaRadio.value : '',
        percentual: percentualSelect ? percentualSelect.value : ''
      });
    }
  });
  
  dados.fornecedores = fornecedoresSelecionados;
  return dados;
}

// üî• ADICIONAR: Fun√ß√£o para restaurar dados ap√≥s liberar campos
function restaurarDadosFormulario(dados) {
  if (!dados) return;
  
  console.log("üîÑ Restaurando dados do formul√°rio:", dados);
  
  // Restaurar campos b√°sicos
  document.getElementById('razao_social').value = dados.razao_social || '';
  document.getElementById('nome_fantasia').value = dados.nome_fantasia || '';
  document.getElementById('cnpj_cadastro').value = dados.cnpj_cadastro || '';
  document.getElementById('tipo').value = dados.tipo || '';
  document.getElementById('observacoes').value = dados.observacoes || '';
  document.getElementById('contrato_enviado').value = dados.contrato_enviado || '';
  document.getElementById('contrato_assinado').value = dados.contrato_assinado || '';
  document.getElementById('ativacao').value = dados.ativacao || '';
  document.getElementById('link').value = dados.link || '';
  document.getElementById('mensalidade').value = dados.mensalidade || 'R$ 0,00';
  document.getElementById('situacao').value = dados.situacao || 'Novo registro';
  document.getElementById('adesao').value = dados.adesao || 'R$ 0,00';
  document.getElementById('inputEventoSearch').value = dados.evento || '';
  
  // Restaurar fornecedores
  if (dados.fornecedores && dados.fornecedores.length > 0) {
    dados.fornecedores.forEach(fornecedor => {
      const checkbox = document.querySelector(`input[name="fornecedor"][value="${fornecedor.nome}"]`);
      if (checkbox) {
        checkbox.checked = true;
        const fornecedorId = fornecedor.nome.toLowerCase();
        const configDiv = document.getElementById(`config-${fornecedorId}`);
        
        if (configDiv) {
          configDiv.style.display = 'grid';
          
          // Restaurar tarifa
          if (fornecedor.tarifa) {
            const tarifaRadio = document.querySelector(`input[name="tarifa_${fornecedorId}"][value="${fornecedor.tarifa}"]`);
            if (tarifaRadio) {
              tarifaRadio.checked = true;
            }
          }
          
          // Restaurar percentual
          if (fornecedor.percentual) {
            const percentualSelect = document.querySelector(`select[name="percentual_${fornecedorId}"]`);
            if (percentualSelect) {
              percentualSelect.value = fornecedor.percentual;
            }
          }
        }
      }
    });
  }
  
  console.log("‚úÖ Dados restaurados com sucesso!");
}

function fecharModalSenha() {
  document.getElementById('modalSenha').style.display = 'none';
  campoEditavel = null;
}

// üî• FUN√á√ÉO PARA LIBERAR TODOS OS CAMPOS PROTEGIDOS - CORRIGIDA
function liberarTodosCamposProtegidos() {
  console.log("üîì LIBERANDO TODOS OS CAMPOS...");
  
  // üî• CORRE√á√ÉO: SALVAR OS DADOS ANTES DE LIBERAR
  const dadosAtuais = coletarDadosFormularioTemporario();
  
  // Liberar campos principais
  const camposProtegidos = [
    'razao_social', 'nome_fantasia', 'cnpj_cadastro', 'tipo', 
    'mensalidade', 'adesao', 'situacao', 'data_status',
    'contrato_enviado', 'contrato_assinado', 'ativacao', 'link'
  ];
  
  camposProtegidos.forEach(id => {
    const campo = document.getElementById(id);
    if (campo) {
      console.log(`üîì Liberando: ${id}`);
      
      const novoCampo = campo.cloneNode(true);
      novoCampo.removeAttribute('readonly');
      novoCampo.disabled = false;
      novoCampo.style.backgroundColor = '';
      novoCampo.style.cursor = 'text';
      novoCampo.style.opacity = '1';
      
      novoCampo.onfocus = null;
      novoCampo.onclick = null;
      
      campo.parentNode.replaceChild(novoCampo, campo);
      
      console.log(`‚úÖ ${id} liberado completamente`);
    }
  });
  
  // Liberar campos dos fornecedores
  console.log("üîì Liberando campos dos fornecedores...");
  const camposFornecedor = document.querySelectorAll(`
    input[name="fornecedor"], 
    input[name^="tarifa_"], 
    select[name^="percentual_"]
  `);
  
  camposFornecedor.forEach(campo => {
    const novoCampo = campo.cloneNode(true);
    novoCampo.disabled = false;
    novoCampo.style.cursor = '';
    novoCampo.style.opacity = '1';
    novoCampo.style.backgroundColor = '';
    
    novoCampo.onclick = null;
    novoCampo.onfocus = null;
    novoCampo.onmousedown = null;
    
    campo.parentNode.replaceChild(novoCampo, campo);
  });
  
  // üî• CORRE√á√ÉO: RESTAURAR OS DADOS AP√ìS LIBERAR
  setTimeout(() => {
    restaurarDadosFormulario(dadosAtuais);
  }, 100);
  
  console.log("üéØ TODOS OS CAMPOS FORAM LIBERADOS COM SUCESSO!");
}

// üî• FUN√á√ÉO PRINCIPAL PARA CONFIGURAR PROTE√á√ÉO
function configurarCamposProtegidos() {
  console.log("üéØ CONFIGURAR CAMPOS PROTEGIDOS - VERIFICANDO AUTORIZA√á√ÉO DI√ÅRIA");
  
  // üî• VERIFICAR SE TEM AUTORIZA√á√ÉO V√ÅLIDA (1 VEZ POR DIA)
  const autorizado = localStorage.getItem('usuarioAutorizado');
  const expiracao = localStorage.getItem('autorizacaoExpiracao');
  const agora = new Date().getTime();
  
  let usuarioEstaAutorizado = false;
  
  if (autorizado === 'true' && expiracao) {
    const tempoExpiracao = parseInt(expiracao);
    
    if (agora < tempoExpiracao) {
      // üî• AUTORIZA√á√ÉO AINDA V√ÅLIDA - LIBERAR CAMPOS
      console.log("‚úÖ Autoriza√ß√£o v√°lida at√©:", new Date(tempoExpiracao).toLocaleString('pt-BR'));
      usuarioEstaAutorizado = true;
      
      // Liberar campos imediatamente
      setTimeout(() => {
        liberarTodosCamposProtegidos();
        console.log("üîì Campos liberados automaticamente (autoriza√ß√£o di√°ria ativa)");
      }, 100);
      
    } else {
      // üî• AUTORIZA√á√ÉO EXPIRADA - LIMPAR
      console.log("‚ùå Autoriza√ß√£o expirada - limpando dados");
      localStorage.removeItem('usuarioAutorizado');
      localStorage.removeItem('autorizacaoExpiracao');
      localStorage.removeItem('ultimaAutorizacao');
    }
  }
  
  if (!usuarioEstaAutorizado) {
    console.log("üîí PROTEC√á√ÉO ATIVA: Usu√°rio n√£o autorizado hoje");
    
    // üî• SALVAR OS DADOS EXISTENTES ANTES DE PROTEGER
    const dadosAtuais = coletarDadosFormularioTemporario();
    
    const camposProtegidos = [
      'razao_social', 'nome_fantasia', 'cnpj_cadastro', 'tipo', 
      'mensalidade', 'adesao', 'situacao', 'data_status',
      'contrato_enviado', 'contrato_assinado', 'ativacao', 'link'
    ];
    
    console.log("üîí Protegendo campos principais...");
    
    // Proteger campos principais
    camposProtegidos.forEach(id => {
      const campo = document.getElementById(id);
      if (campo) {
        console.log(`üîí Protegendo: ${id}`);
        campo.setAttribute('readonly', 'true');
        campo.disabled = false;
        campo.style.backgroundColor = '#f8f9fa';
        campo.style.cursor = 'not-allowed';
        campo.style.opacity = '1';
        
        // Remover qualquer event listener anterior
        const novoCampo = campo.cloneNode(true);
        campo.parentNode.replaceChild(novoCampo, campo);
        
        // Adicionar novo event listener
        document.getElementById(id).addEventListener('focus', function(e) {
          e.preventDefault();
          console.log(`üîì Campo ${id} solicitando senha`);
          solicitarSenha(this);
        });
      }
    });
    
    // Proteger APENAS checkboxes dos fornecedores
console.log("üîí Protegendo APENAS checkboxes dos fornecedores...");
const checkboxesFornecedor = document.querySelectorAll('input[name="fornecedor"]');
const radiosTarifa = document.querySelectorAll('input[name^="tarifa_"]');
const selectsPercentual = document.querySelectorAll('select[name^="percentual_"]');

// ‚ùå BLOQUEAR checkboxes (n√£o pode mudar fornecedor)
checkboxesFornecedor.forEach(checkbox => {
  checkbox.disabled = true;
  checkbox.style.cursor = 'not-allowed';
  checkbox.style.opacity = '0.6';
});

// ‚úÖ LIBERAR tarifas e percentuais
radiosTarifa.forEach(radio => {
  radio.disabled = false;
  radio.style.cursor = 'pointer';
  radio.style.opacity = '1';
});

selectsPercentual.forEach(select => {
  select.disabled = false;
  select.style.cursor = 'pointer';
  select.style.opacity = '1';
});
    
    // üî• CORRE√á√ÉO CR√çTICA: RESTAURAR OS DADOS AP√ìS CONFIGURAR A PROTE√á√ÉO
    setTimeout(() => {
      if (dadosAtuais && (dadosAtuais.razao_social || dadosAtuais.cnpj_cadastro)) {
        console.log("üîÑ Restaurando dados ap√≥s prote√ß√£o:", dadosAtuais);
        restaurarDadosFormulario(dadosAtuais);
      } else {
        console.log("‚ÑπÔ∏è Nenhum dado para restaurar - formul√°rio vazio");
      }
    }, 300);
  }
  
  // Campos liberados (n√£o proteger) - SEMPRE
  console.log("‚úÖ Liberando campos permitidos...");
  const camposLiberados = ['evento', 'observacoes', 'inputEventoSearch'];
  camposLiberados.forEach(id => {
    const campo = document.getElementById(id);
    if (campo) {
      campo.removeAttribute('readonly');
      campo.disabled = false;
      campo.style.backgroundColor = '';
      campo.style.cursor = 'text';
      campo.style.opacity = '1';
    }
  });
  
  console.log("üéØ CONFIGURA√á√ÉO DE PROTEC√á√ÉO FINALIZADA");
}

function verificarStatusAutorizacao() {
  const autorizado = localStorage.getItem('usuarioAutorizado');
  const expiracao = localStorage.getItem('autorizacaoExpiracao');
  const ultimaAuth = localStorage.getItem('ultimaAutorizacao');
  
  const agora = new Date();
  
  console.log("=== üîê STATUS DA AUTORIZA√á√ÉO ===");
  console.log("Autorizado:", autorizado);
  
  if (expiracao) {
    const dataExpiracao = new Date(parseInt(expiracao));
    console.log("Expira em:", dataExpiracao.toLocaleString('pt-BR'));
    console.log("Tempo restante:", Math.round((dataExpiracao - agora) / (1000 * 60 * 60)) + " horas");
  }
  
  if (ultimaAuth) {
    const dataUltimaAuth = new Date(parseInt(ultimaAuth));
    console.log("√öltima autoriza√ß√£o:", dataUltimaAuth.toLocaleString('pt-BR'));
  }
  
  if (autorizado === 'true' && expiracao && agora.getTime() < parseInt(expiracao)) {
    console.log("‚úÖ AUTORIZA√á√ÉO ATIVA - Campos liberados");
    return true;
  } else {
    console.log("‚ùå AUTORIZA√á√ÉO INATIVA - Campos protegidos");
    return false;
  }
}

// üî• TESTE: Adicione este bot√£o temporariamente para ver o status
function adicionarBotaoStatus() {
  const btnStatus = document.createElement('button');
  btnStatus.innerHTML = 'üîê Status Autoriza√ß√£o';
  btnStatus.style.position = 'fixed';
  btnStatus.style.top = '10px';
  btnStatus.style.right = '10px';
  btnStatus.style.zIndex = '9999';
  btnStatus.style.background = '#FF6B35';
  btnStatus.style.color = 'white';
  btnStatus.style.border = 'none';
  btnStatus.style.padding = '10px';
  btnStatus.style.borderRadius = '5px';
  btnStatus.style.cursor = 'pointer';
  
  btnStatus.onclick = function() {
    verificarStatusAutorizacao();
    alert('Verifique o console (F12) para ver o status da autoriza√ß√£o!');
  };
  
  document.body.appendChild(btnStatus);
}

// Executar quando a p√°gina carregar
setTimeout(adicionarBotaoStatus, 2000);

// üî• FUN√á√ÉO TEMPOR√ÅRIA PARA TESTAR ENVIO DO FORMUL√ÅRIO
function testarEnvioFormulario() {
  console.log("üß™ TESTANDO ENVIO DO FORMUL√ÅRIO...");
  
  // Coletar dados do formul√°rio normalmente (a mesma fun√ß√£o que o cadastrar usa)
  const dados = coletarDadosFormulario();
  
  console.log("üì§ Dados coletados para envio:", dados);
  console.log("üî¢ Fornecedores coletados:", dados.fornecedores);
  
  if (!dados.fornecedores || dados.fornecedores.length === 0) {
    alert("‚ùå Nenhum fornecedor selecionado! Selecione pelo menos um.");
    return;
  }
  
  // Enviar para debug no GS
  google.script.run
    .withSuccessHandler(function(res) {
      console.log("‚úÖ RESPOSTA DO DEBUG:", res);
      alert(`DEBUG CONCLU√çDO:\n\n‚Ä¢ Fornecedores enviados: ${res.quantidadeFornecedores}\n‚Ä¢ Estrutura: ${JSON.stringify(res.estruturaFornecedores, null, 2)}\n\nVerifique o console do GS para detalhes completos.`);
    })
    .withFailureHandler(function(error) {
      console.error("‚ùå ERRO NO DEBUG:", error);
      alert("Erro no debug: " + error.message);
    })
    .debugFormulario(dados);
}

function formatarCNPJ(input) {
  // Salva a posi√ß√£o do cursor
  const cursorPos = input.selectionStart;
  
  let value = input.value.replace(/\D/g, '');
  
  // Aplica a formata√ß√£o
  if (value.length > 12) {
    value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
  } else if (value.length > 8) {
    value = value.replace(/^(\d{2})(\d{3})(\d{3})/, '$1.$2.$3/');
  } else if (value.length > 5) {
    value = value.replace(/^(\d{2})(\d{3})/, '$1.$2.');
  } else if (value.length > 2) {
    value = value.replace(/^(\d{2})/, '$1.');
  }
  
  input.value = value;
  
  // Restaura a posi√ß√£o do cursor
  input.setSelectionRange(cursorPos, cursorPos);
}


// üî• FUN√á√ÉO SIMPLES: Para usar ENQUANTO n√£o corrige o Google Sheets
function formatarCNPJParaExibicao(cnpj) {
    if (!cnpj || cnpj === 'N/A' || cnpj === '') return 'N/A';
    
    // üî• MOSTRA EXATAMENTE O QUE VEIO - o problema √© na origem
    return cnpj.toString();
}

function formatarMoeda(input) {
  let value = input.value.replace(/\D/g, '');
  value = (value / 100).toFixed(2);
  value = value.replace('.', ',');
  value = value.replace(/(\d)(?=(\d{3})+\,)/g, "$1.");
  input.value = 'R$ ' + value;
}

function formatarMoedaParaInput(valor) {
  if (!valor) return 'R$ 0,00';
  const numero = typeof valor === 'number' ? valor : parseFloat(valor);
  return 'R$ ' + numero.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
}

function showMessage(type, text) {
  const successEl = document.getElementById('messageSuccess');
  const errorEl = document.getElementById('messageError');
  const infoEl = document.getElementById('messageInfo');

  successEl.style.display = 'none';
  errorEl.style.display = 'none';
  infoEl.style.display = 'none';

  if (type === 'success') {
    successEl.querySelector('span').textContent = text;
    successEl.style.display = 'flex';
  } else if (type === 'error') {
    errorEl.querySelector('span').textContent = text;
    errorEl.style.display = 'flex';
  } else if (type === 'info') {
    infoEl.querySelector('span').textContent = text;
    infoEl.style.display = 'flex';
  }

  setTimeout(() => {
    successEl.style.display = 'none';
    errorEl.style.display = 'none';
    infoEl.style.display = 'none';
  }, 5000);
}

// üî• FUN√áOES AUXILIAR

// üî• ADICIONE ESTA FUN√á√ÉO AUXILIAR PARA PADRONIZAR FORNECEDORES
function padronizarNomeFornecedor(nome) {
  if (!nome) return '';
  
  // Lista de fornecedores conhecidos em MAI√öSCULAS
  const fornecedoresPadronizados = {
    'agil': 'AGIL',
    'bc': 'BC', 
    'parcelex': 'PARCELEX',
    'agoracred': 'AGORACRED',
    'afinz': 'AFINZ'
  };
  
  const nomeLower = nome.toLowerCase();
  return fornecedoresPadronizados[nomeLower] || nome.toUpperCase();
}



function coletarDadosFormulario() {
  console.log("üîç COLETANDO DADOS - INICIANDO");
  
  try {
    // ‚úÖ VALIDA√á√ÉO B√ÅSICA DOS CAMPOS PRINCIPAIS
    const razaoSocial = document.getElementById('razao_social').value.trim();
    const cnpj = document.getElementById('cnpj_cadastro').value.trim();
    
    if (!razaoSocial || !cnpj) {
      showMessage('error', '‚ùå Raz√£o Social e CNPJ s√£o obrigat√≥rios!');
      return null;
    }

    // ‚úÖ GARANTIR QUE O CNPJ MANTENHA A M√ÅSCARA
    const cnpjInput = document.getElementById('cnpj_cadastro');
    const cnpjFormatado = cnpjInput.value;

    // ‚úÖ Processar ades√£o - CORRE√á√ÉO APLICADA
      let adesaoValue = document.getElementById('adesao').value;
      console.log("üí∞ Ades√£o original:", adesaoValue);

      if (adesaoValue === 'R$ 0,00' || adesaoValue === '0,00' || adesaoValue === '0' || adesaoValue === 'R$ 0') {
        adesaoValue = 0;
        console.log("‚úÖ Ades√£o definida como isenta (0)");
      } else {
        // ‚úÖ CORRE√á√ÉO: Usar a fun√ß√£o normal (j√° corrigida)
        adesaoValue = converterMoedaParaNumero(adesaoValue);
        console.log("‚úÖ Ades√£o convertida para n√∫mero:", adesaoValue);
      }
      console.log("üéØüéØüéØ ADES√ÉO FINAL PARA ENVIO:", adesaoValue, "Tipo:", typeof adesaoValue);

    // ‚úÖ CORRE√á√ÉO CR√çTICA: Coletar evento do campo CORRETO
    const eventoValue = document.getElementById('inputEventoSearch').value || 
                       document.getElementById('evento').value || '';
    console.log("‚úÖ Evento coletado:", eventoValue);

    // ‚úÖ CORRE√á√ÉO CR√çTICA: Coletar TODOS os fornecedores COM VALIDA√á√ÉO
    const checkboxesFornecedores = document.querySelectorAll('input[name="fornecedor"]:checked');
    const fornecedoresComConfiguracoes = [];

    if (checkboxesFornecedores.length === 0) {
      showMessage('error', '‚ùå Selecione pelo menos um fornecedor!');
      return null;
    }

    checkboxesFornecedores.forEach(checkbox => {
      const fornecedorNome = checkbox.value;
      // üî• CORRE√á√ÉO: Padronizar para MAI√öSCULAS
      const fornecedorPadronizado = padronizarNomeFornecedor(fornecedorNome);
      const fornecedorId = fornecedorNome.toLowerCase();
      
      // Verificar se tem configura√ß√£o ativa
      const configDiv = document.getElementById(`config-${fornecedorId}`);
      if (!configDiv || configDiv.style.display !== 'grid') {
        console.warn(`‚ùå Fornecedor ${fornecedorNome} n√£o tem configura√ß√£o ativa!`);
        return;
      }
      
      // Coletar configura√ß√µes de tarifa
      const tarifaRadio = document.querySelector(`input[name="tarifa_${fornecedorId}"]:checked`);
      const percentualSelect = document.querySelector(`select[name="percentual_${fornecedorId}"]`);
      
      // üî• CORRE√á√ÉO: Se n√£o tem tarifa selecionada, seleciona MDR automaticamente
      let tarifaSelecionada = tarifaRadio ? tarifaRadio.value : 'MDR';
      let percentualSelecionado = percentualSelect ? percentualSelect.value : '0%';
      
      // Se n√£o tinha tarifa selecionada, seleciona MDR agora
      if (!tarifaRadio) {
        const radioMDR = document.querySelector(`input[name="tarifa_${fornecedorId}"][value="MDR"]`);
        if (radioMDR) {
          radioMDR.checked = true;
          console.log(`‚úÖ MDR selecionado automaticamente para ${fornecedorNome}`);
        }
      }
      
      // Adiciona aos dados
      fornecedoresComConfiguracoes.push({
        nome: fornecedorPadronizado,
        tarifa: tarifaSelecionada,
        percentual_tarifa: percentualSelecionado
      });
    });

    // ‚úÖ MONTAR OBJETO DE DADOS CORRETAMENTE
    const dados = {
      razao_social: razaoSocial,
      nome_fantasia: document.getElementById('nome_fantasia').value,
      cnpj: cnpjFormatado,
      tipo: document.getElementById('tipo').value,
      adesao: adesaoValue,
      fornecedores: fornecedoresComConfiguracoes,
      fornecedor: fornecedoresComConfiguracoes.length > 0 ? fornecedoresComConfiguracoes[0].nome : '',
      tarifa: fornecedoresComConfiguracoes.length > 0 ? fornecedoresComConfiguracoes[0].tarifa : '',
      percentual_tarifa: fornecedoresComConfiguracoes.length > 0 ? fornecedoresComConfiguracoes[0].percentual_tarifa : '0%',
      observacoes: document.getElementById('observacoes').value,
      contrato_enviado: document.getElementById('contrato_enviado').value,
      contrato_assinado: document.getElementById('contrato_assinado').value,
      ativacao: document.getElementById('ativacao').value,
      link: document.getElementById('link').value,
      mensalidade: converterMoedaParaNumero(document.getElementById('mensalidade').value),
      mensalidade_sim: converterMoedaParaNumero(document.getElementById('mensalidade_sim').value),
      situacao: document.getElementById('situacao').value,
      evento: eventoValue // ‚úÖ AGORA CORRETO - PEGA DO CAMPO CERTO
    };

    console.log("üì¶ DADOS FINAIS PARA ENVIO:", dados);
    return dados;

  } catch (error) {
    console.error("‚ùå ERRO CR√çTICO ao coletar dados:", error);
    showMessage('error', '‚ùå Erro interno ao processar formul√°rio');
    return null;
  }
}

// üî• CORRE√á√ÉO DEFINITIVA - FUN√á√ÉO CALCULAR DEFASAGEM MELHORADA
function calcularDefasagem(dataUltimoEvento) {
    console.log("üîÑ CALCULANDO DEFASAGEM - Data recebida:", dataUltimoEvento);
    
    if (!dataUltimoEvento || dataUltimoEvento === 'N/A' || dataUltimoEvento === '' || dataUltimoEvento === 'Data inv√°lida') {
        console.log("‚ùå Sem data v√°lida para calcular defasagem");
        return 'N/A';
    }
    
    try {
        // üî• CORRE√á√ÉO: Tentar diferentes formatos de data de forma mais robusta
        let dataEvento;
        
        // Formato brasileiro (dd/mm/aaaa)
        if (typeof dataUltimoEvento === 'string' && dataUltimoEvento.includes('/')) {
            const partesData = dataUltimoEvento.split('/');
            if (partesData.length === 3) {
                const dia = parseInt(partesData[0], 10);
                const mes = parseInt(partesData[1], 10) - 1; // M√™s √© 0-indexed
                const ano = parseInt(partesData[2], 10);
                dataEvento = new Date(ano, mes, dia);
            }
        } 
        // Formato ISO (aaaa-mm-dd)
        else if (typeof dataUltimoEvento === 'string' && dataUltimoEvento.includes('-')) {
            dataEvento = new Date(dataUltimoEvento);
        }
        // Se j√° √© um objeto Date
        else if (dataUltimoEvento instanceof Date) {
            dataEvento = dataUltimoEvento;
        }
        // Tentar parse direto como √∫ltimo recurso
        else {
            dataEvento = new Date(dataUltimoEvento);
        }
        
        // Verificar se a data √© v√°lida
        if (!dataEvento || isNaN(dataEvento.getTime())) {
            console.log("‚ùå Data inv√°lida ap√≥s parsing:", dataUltimoEvento);
            return 'Data inv√°lida';
        }
        
        const hoje = new Date();
        
        // üî• CORRE√á√ÉO: Zerar horas para comparar apenas datas
        hoje.setHours(0, 0, 0, 0);
        dataEvento.setHours(0, 0, 0, 0);
        
        // Calcular diferen√ßa em dias
        const diffTempo = hoje.getTime() - dataEvento.getTime();
        const diffDias = Math.floor(diffTempo / (1000 * 3600 * 24));
        
        console.log("üìä Resultado c√°lculo:");
        console.log("Data evento:", dataEvento);
        console.log("Data hoje:", hoje);
        console.log("Diferen√ßa em dias:", diffDias);
        
        if (diffDias === 0) return 'Hoje';
        if (diffDias === 1) return '1 dia';
        if (diffDias > 1) return `${diffDias} dias`;
        if (diffDias < 0) return 'Data futura';
        
        return 'N/A';
        
    } catch (error) {
        console.error("‚ùå Erro ao calcular defasagem:", error);
        console.error("Data que causou erro:", dataUltimoEvento);
        return 'Erro no c√°lculo';
    }
}

// üî• FUN√á√ÉO: Formatar percentual para exibi√ß√£o (0.03 ‚Üí 3%) - VERS√ÉO CORRIGIDA
function formatarPercentualParaExibicao(percentual) {
  if (!percentual && percentual !== 0) return '';
  
  console.log("üîç Percentual recebido:", percentual, "Tipo:", typeof percentual);
  
  try {
    // Se j√° est√° em formato de string com %, retorna como est√°
    if (typeof percentual === 'string' && percentual.includes('%')) {
      return percentual;
    }
    
    // Converter para n√∫mero
    let numero;
    if (typeof percentual === 'string') {
      // Remove poss√≠veis caracteres n√£o num√©ricos, mantendo ponto decimal
      const valorLimpo = percentual.replace(/[^\d.,]/g, '').replace(',', '.');
      numero = parseFloat(valorLimpo);
    } else {
      numero = parseFloat(percentual);
    }
    
    // Se n√£o √© um n√∫mero v√°lido, retorna original
    if (isNaN(numero)) {
      return percentual;
    }
    
    // üî• CORRE√á√ÉO DEFINITIVA: Se o n√∫mero √© menor que 1, converte para porcentagem
    if (numero < 1) {
      return Math.round(numero * 100) + '%';
    } else {
      // Se o n√∫mero √© 1 ou maior, assume que j√° √© porcentagem
      return Math.round(numero) + '%';
    }
    
  } catch (error) {
    console.error("‚ùå Erro ao formatar percentual:", error);
    return percentual;
  }
}

function toggleFornecedorConfig(checkbox, fornecedorId) {
  const configDiv = document.getElementById(`config-${fornecedorId}`);
  
  if (checkbox.checked) {
    configDiv.style.display = 'grid';
  } else {
    configDiv.style.display = 'none';
    // Limpar sele√ß√µes quando desmarcar
    const radios = configDiv.querySelectorAll('input[type="radio"]');
    radios.forEach(radio => radio.checked = false);
    const select = configDiv.querySelector('select');
    if (select) select.value = '0%';
  }
  
  // üî• NOVO: Atualizar tarifa principal quando mudar sele√ß√£o
  atualizarTarifaPrincipal();
}

// üî• ADICIONAR: Fun√ß√£o para atualizar tarifa principal
function atualizarTarifaPrincipal() {
  const checkboxesFornecedores = document.querySelectorAll('input[name="fornecedor"]:checked');
  if (checkboxesFornecedores.length > 0) {
    const primeiroFornecedor = checkboxesFornecedores[0].value.toLowerCase();
    // As tarifas ser√£o coletadas na fun√ß√£o coletarDadosFormulario
  }
}


function converterMoedaParaNumero(valorMoeda) {
  if (!valorMoeda) return 0;
  
  try {
    console.log("üî¢ CONVERTENDO MOEDA - Valor original:", valorMoeda, "Tipo:", typeof valorMoeda);
    
    // Se j√° √© n√∫mero, retorna como est√°
    if (typeof valorMoeda === 'number') {
      console.log("‚úÖ J√° √© n√∫mero, retornando:", valorMoeda);
      return valorMoeda;
    }
    
    if (typeof valorMoeda === 'string') {
      // ‚úÖ CORRE√á√ÉO DEFINITIVA: REMOVER a multiplica√ß√£o por 100
      let valorLimpo = valorMoeda
        .replace('R$', '')
        .replace(/\./g, '')
        .replace(',', '.')
        .trim();
      
      console.log("üîß Valor limpo:", valorLimpo);
      
      const numero = parseFloat(valorLimpo);
      
      if (isNaN(numero)) {
        console.log("‚ùå N√£o √© um n√∫mero v√°lido:", valorLimpo);
        return 0;
      }
      
      // ‚úÖ‚úÖ‚úÖ CORRE√á√ÉO: REMOVER COMPLETAMENTE a multiplica√ß√£o por 100
      console.log("‚úÖ N√∫mero convertido (SEM multiplica√ß√£o):", numero);
      return numero;
    }
    
    return parseFloat(valorMoeda) || 0;
    
  } catch (error) {
    console.error("‚ùå ERRO CR√çTICO ao converter moeda:", valorMoeda, error);
    return 0;
  }
}

// üî• FUN√á√ÉO DE DEBUG DETALHADA - Contrato Enviado
function debugContratoEnviado(dados) {
  console.log("üîçüîçüîç DEBUG CONTRATO ENVIADO:");
  console.log("üì¶ Todos os dados recebidos:", dados);
  console.log("‚ùì Tem contrato_enviado?", 'contrato_enviado' in dados);
  console.log("üìã Valor de contrato_enviado:", dados.contrato_enviado);
  console.log("üìã Tipo de contrato_enviado:", typeof dados.contrato_enviado);
  console.log("üìã Valor bruto:", dados.contrato_enviado);
  console.log("üìã Convertido para string:", String(dados.contrato_enviado));
  console.log("üìã Em mai√∫sculas:", String(dados.contrato_enviado).toUpperCase());
  
  // Verificar todos os campos dispon√≠veis
  console.log("üîë Todas as chaves dispon√≠veis:", Object.keys(dados));
}

// üî• FUN√á√ÉO COM DEBUG: Preencher dados do cadastro
function preencherDadosCadastro(dados) {
  console.log("üéØ PREENCHER DADOS CADASTRO: Iniciando");
  console.log("üì¶ Dados recebidos:", dados);

  // DEBUG ESPEC√çFICO DOS CAMPOS DE CONTRATO
  console.log("üîç DEBUG CONTRATO ENVIADO:", dados.contrato_enviado);
  console.log("üîç DEBUG CONTRATO ASSINADO:", dados.contrato_assinado);
  console.log("üîç TIPO CONTRATO ENVIADO:", typeof dados.contrato_enviado);
  console.log("üîç TIPO CONTRATO ASSINADO:", typeof dados.contrato_assinado);

  if (!dados.encontrado) {
    showMessage('error', '‚ùå ' + dados.mensagem);
    return;
  }

  // Preencher campos b√°sicos
  document.getElementById('razao_social').value = dados.razao_social || '';
  document.getElementById('nome_fantasia').value = dados.nome_fantasia || '';
  document.getElementById('cnpj_cadastro').value = dados.cnpj || '';
  document.getElementById('tipo').value = dados.tipo || '';
  document.getElementById('observacoes').value = dados.observacoes || '';
  
  // üî•üî•üî• CORRE√á√ÉO CR√çTICA: Preencher CAMPOS DE CONTRATO CORRETAMENTE
  console.log("üéØ PREENCHENDO CAMPOS DE CONTRATO:");
  
  // Contrato Enviado
  const contratoEnviadoValue = dados.contrato_enviado || '';
  document.getElementById('contrato_enviado').value = contratoEnviadoValue;
  console.log("‚úÖ Contrato Enviado definido como:", contratoEnviadoValue);
  
  // Contrato Assinado 
  const contratoAssinadoValue = dados.contrato_assinado || '';
  document.getElementById('contrato_assinado').value = contratoAssinadoValue;
  console.log("‚úÖ Contrato Assinado definido como:", contratoAssinadoValue);
  
  // Verificar se os valores foram realmente definidos
  console.log("üîç VERIFICA√á√ÉO P√ìS-PREENCHIMENTO:");
  console.log("Contrato Enviado no select:", document.getElementById('contrato_enviado').value);
  console.log("Contrato Assinado no select:", document.getElementById('contrato_assinado').value);

  // Outros campos
  document.getElementById('ativacao').value = dados.ativacao || '';
  document.getElementById('link').value = dados.link || '';
  document.getElementById('mensalidade').value = formatarMoedaParaInput(dados.mensalidade);
  document.getElementById('mensalidade_sim').value = formatarMoedaParaInput(dados.mensalidade_sim); 
  document.getElementById('situacao').value = dados.situacao || 'Novo registro';
  document.getElementById('adesao').value = dados.adesao === 'Isento' || dados.adesao === 0 ? 'R$ 0,00' : formatarMoedaParaInput(dados.adesao);
  
  // ‚úÖ‚úÖ‚úÖ CORRE√á√ÉO CR√çTICA: Preencher evento nos DOIS campos
  if (dados.evento) {
    document.getElementById('inputEventoSearch').value = dados.evento;
    document.getElementById('evento').value = dados.evento;
    console.log("‚úÖ Evento preenchido nos dois campos:", dados.evento);
  } else {
    // Limpar se n√£o tiver evento
    document.getElementById('inputEventoSearch').value = '';
    document.getElementById('evento').value = '';
  }
  
  // Preencher fornecedor
  preencherFornecedorComTarifas(dados);

  // üî• CORRE√á√ÉO: BLOQUEAR APENAS CHECKBOX, LIBERAR TARIFA E %
console.log("üîí BLOQUEANDO APENAS CHECKBOX - LIBERANDO TARIFA E %");
const checkboxesFornecedores = document.querySelectorAll('input[name="fornecedor"]');
const configsFornecedores = document.querySelectorAll('[id^="config-"]');

// ‚úÖ BLOQUEAR apenas os checkboxes (n√£o pode mudar fornecedor)
checkboxesFornecedores.forEach(checkbox => {
    checkbox.disabled = true;
    checkbox.style.cursor = 'not-allowed';
    checkbox.style.opacity = '0.7';
});

// ‚úÖ LIBERAR tarifa e percentual dentro das configura√ß√µes
configsFornecedores.forEach(config => {
    const radiosTarifa = config.querySelectorAll('input[type="radio"]'); // MDR/TIS
    const selectsPercentual = config.querySelectorAll('select'); // 0%, 1%, 2%, etc.
    
    // üî• LIBERAR Radio buttons (MDR/TIS)
    radiosTarifa.forEach(radio => {
        radio.disabled = false;
        radio.style.cursor = 'pointer';
        radio.style.opacity = '1';
    });
    
    // üî• LIBERAR Selects (percentual)
    selectsPercentual.forEach(select => {
        select.disabled = false;
        select.style.cursor = 'pointer';
        select.style.opacity = '1';
    });
});
  
  // Atualizar eventos
  atualizarEventos();
  
  // Configurar modo de atualiza√ß√£o
  cadastroAtualId = dados.id;
  document.getElementById('btnCadastrar').style.display = 'none';
  document.getElementById('btnAtualizar').style.display = 'block';
  
  console.log("‚úÖ Formul√°rio preenchido com sucesso!");
  
  // Scroll para o formul√°rio
  document.querySelector('.card').scrollIntoView({ behavior: 'smooth', block: 'start' });
  
  showMessage('success', '‚úÖ Cadastro carregado para edi√ß√£o!');
}


// üî•üî•üî• CORRE√á√ÉO DA VALIDA√á√ÉO DE CAMPOS OBRIGAT√ìRIOS
function validarCamposObrigatorios() {
  console.log("üîç Validando campos obrigat√≥rios...");
  
  // Remover destaque anterior
  document.querySelectorAll('.campo-obrigatorio').forEach(campo => {
    campo.classList.remove('campo-obrigatorio');
  });

  let camposInvalidos = [];

  // ‚úÖ CORRE√á√ÉO DEFINITIVA: Na ATUALIZA√á√ÉO, s√≥ validar campos CR√çTICOS
  const isAtualizacao = cadastroAtualId !== null;
  
  console.log("üîç Modo:", isAtualizacao ? "ATUALIZA√á√ÉO" : "CADASTRO");

  // ‚úÖ CAMPOS SEMPRE OBRIGAT√ìRIOS (em ambos os modos)
  const camposSempreObrigatorios = [
    { 
      id: 'razao_social', 
      nome: 'Raz√£o Social', 
      elemento: document.getElementById('razao_social'),
      tipo: 'text'
    },
    { 
      id: 'cnpj_cadastro', 
      nome: 'CNPJ', 
      elemento: document.getElementById('cnpj_cadastro'),
      tipo: 'text'
    },
    { 
      id: 'tipo', 
      nome: 'Tipo', 
      elemento: document.getElementById('tipo'),
      tipo: 'select'
    },
    { 
      id: 'mensalidade', 
      nome: 'Mensalidade', 
      elemento: document.getElementById('mensalidade'),
      tipo: 'moeda'
    },
    { 
      id: 'situacao', 
      nome: 'Situa√ß√£o', 
      elemento: document.getElementById('situacao'),
      tipo: 'select'
    }
  ];

  // ‚úÖ CAMPOS OBRIGAT√ìRIOS APENAS NO CADASTRO (N√ÉO na atualiza√ß√£o)
  const camposApenasCadastro = [
    { 
      id: 'contrato_enviado', 
      nome: 'Contrato Enviado', 
      elemento: document.getElementById('contrato_enviado'),
      tipo: 'select'
    },
    { 
      id: 'contrato_assinado', 
      nome: 'Contrato Assinado', 
      elemento: document.getElementById('contrato_assinado'),
      tipo: 'select'
    }
  ];

  // Juntar os campos a validar
  let camposParaValidar = [...camposSempreObrigatorios];
  
  // ‚úÖ CORRE√á√ÉO: S√≥ adicionar campos de contrato se for NOVO CADASTRO
  if (!isAtualizacao) {
    camposParaValidar = [...camposParaValidar, ...camposApenasCadastro];
  }

  // Validar cada campo
  for (const campo of camposParaValidar) {
    let valor = campo.elemento.value;
    let estaVazio = false;

    switch(campo.tipo) {
      case 'select':
        estaVazio = !valor || valor === '' || valor === '-- Selecione --';
        break;
      case 'moeda':
          estaVazio = !valor || valor.toString().trim() === '';
        break;
      default:
        estaVazio = !valor || valor.toString().trim() === '';
    }

    if (estaVazio) {
      campo.elemento.classList.add('campo-obrigatorio');
      camposInvalidos.push(campo.nome);
      
      // Scroll para o primeiro campo inv√°lido
      if (camposInvalidos.length === 1) {
        campo.elemento.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  }

  console.log(`üìä Valida√ß√£o: ${camposInvalidos.length} campos inv√°lidos`);
  console.log(`üîç Campos inv√°lidos:`, camposInvalidos);
  return camposInvalidos;
}

function mostrarPopupResultado(mensagemPrincipal, detalhes) {
  // Usar o modal de detalhes TEMPORARIAMENTE
  const modal = document.getElementById('modalDetalhes');
  const content = document.getElementById('modalDetalhesContent');
  
  let detalhesHTML = '';
  if (detalhes && Array.isArray(detalhes)) {
    detalhesHTML = `
      <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <h4 style="color: var(--primary); margin-bottom: 10px;">üìã Detalhes do Cadastro:</h4>
        <div style="max-height: 200px; overflow-y: auto;">
          ${detalhes.map(detalhe => `
            <div style="padding: 5px 0; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; gap: 8px;">
              ${detalhe.includes('‚úÖ') ? 
                '<span style="color: var(--success);">‚úÖ</span>' : 
                '<span style="color: var(--danger);">‚ùå</span>'
              }
              <span>${detalhe.replace('‚úÖ', '').replace('‚ùå', '')}</span>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  content.innerHTML = `
    <div style="text-align: center; padding: 20px;">
      <div style="font-size: 4rem; color: var(--success); margin-bottom: 15px;">‚úÖ</div>
      <h3 style="color: var(--success); margin-bottom: 15px;">Cadastro Realizado!</h3>
      <p style="font-size: 1.1rem; margin-bottom: 20px; line-height: 1.4;">${mensagemPrincipal}</p>
      ${detalhesHTML}
      <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border);">
        <button class="btn btn-success" onclick="fecharModalDetalhes()">
          <i class="fas fa-check"></i> Continuar
        </button>
      </div>
    </div>
  `;
  
  modal.style.display = 'flex';
}


function limparFormulario() {
  document.getElementById('razao_social').value = '';
  document.getElementById('nome_fantasia').value = '';
  document.getElementById('cnpj_cadastro').value = '';
  document.getElementById('tipo').value = '';
  
  // üî• CORRE√á√ÉO: Limpar checkboxes E configura√ß√µes de fornecedor
  const checkboxes = document.querySelectorAll('input[name="fornecedor"]');
  checkboxes.forEach(cb => {
    cb.checked = false;
    const fornecedorId = cb.getAttribute('onchange').split("'")[1];
    const configDiv = document.getElementById(`config-${fornecedorId}`);
    if (configDiv) {
      configDiv.style.display = 'none';
      // Limpar sele√ß√µes dentro da configura√ß√£o
      const radios = configDiv.querySelectorAll('input[type="radio"]');
      radios.forEach(radio => radio.checked = false);
      const select = configDiv.querySelector('select');
      if (select) select.value = '0%';
    }
  });
  
  document.getElementById('observacoes').value = '';
  document.getElementById('contrato_enviado').value = '';
  document.getElementById('contrato_assinado').value = '';
  document.getElementById('ativacao').value = '';
  document.getElementById('link').value = '';
  document.getElementById('mensalidade').value = 'R$ 0,00';
  document.getElementById('mensalidade_sim').value = 'R$ 0,00'; // üî• NOVA LINHA
  
  // üî• CORRE√á√ÉO: Resetar situa√ß√£o para "Novo registro" e ades√£o para "R$ 0,00"
  document.getElementById('situacao').value = 'Novo registro';
  document.getElementById('adesao').value = 'R$ 0,00';
  
  // üî•üî•üî• ADICIONE ESTAS 3 LINHAS AQUI - LIMPAR EVENTO SEARCH
  document.getElementById('inputEventoSearch').value = '';
  document.getElementById('evento').value = '';
  document.getElementById('suggestionsEventoSearch').style.display = 'none';
  
  // üî• CORRE√á√ÉO: Atualizar eventos baseado na nova situa√ß√£o
  atualizarEventos();
  
  document.getElementById('btnCadastrar').style.display = 'block';
  document.getElementById('btnAtualizar').style.display = 'none';
  cadastroAtualId = null;
  
  // üî• CORRE√á√ÉO: LIBERAR CAMPOS DE FORNECEDOR QUANDO VOLTAR AO MODO CADASTRO
  console.log("üîì LIBERANDO CAMPOS DE FORNECEDOR PARA NOVO CADASTRO");
  const checkboxesFornecedores = document.querySelectorAll('input[name="fornecedor"]');
  const configsFornecedores = document.querySelectorAll('[id^="config-"]');

  checkboxesFornecedores.forEach(checkbox => {
      checkbox.disabled = false;
      checkbox.style.cursor = 'pointer';
      checkbox.style.opacity = '1';
  });

  configsFornecedores.forEach(config => {
      const inputs = config.querySelectorAll('input, select');
      inputs.forEach(input => {
          input.disabled = false;
          input.style.cursor = 'pointer';
          input.style.opacity = '1';
      });
  });
  
  // üî• CORRE√á√ÉO: Remover destaque de campos obrigat√≥rios
  document.querySelectorAll('.campo-obrigatorio').forEach(campo => {
    campo.classList.remove('campo-obrigatorio');
    campo.style.borderColor = '';
    campo.style.backgroundColor = '';
  });
  
  // üî•üî•üî• NOVA LINHA: Limpar sele√ß√£o "Aplicar a Todos"
  limparSelecaoAplicarATodos();
  
  // üî•üî•üî• ESCONDER BOT√ÉO "APLICAR A TODOS" AO LIMPAR
  document.getElementById('btnAplicarATodos').style.display = 'none';
}

// üî• CONFIGURAR BOT√ïES "APLICAR A TODOS" NO FORMUL√ÅRIO
function configurarBotoesAplicarATodos(cnpj) {
    console.log("üéØ Configurando bot√µes aplicar a todos para CNPJ:", cnpj);
    cnpjAtualParaAplicar = cnpj;
    
    // Limpar sele√ß√£o anterior
    limparSelecaoAplicarATodos();
    
    // üî• ADICIONAR CHECKBOXES AOS CAMPOS
    adicionarCheckboxesAosCampos();
    
    // üî• MOSTRAR BOT√ÉO "APLICAR A TODOS"
    mostrarBotaoAplicarATodos();
}

function filtrarTabela(situacao) {
  // Remover classe active de todos os bot√µes
  document.querySelectorAll('.filtros-container .btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Adicionar classe active ao bot√£o clicado
  const botaoClicado = event.target;
  botaoClicado.classList.add('active');

  configurarFiltroEvento(situacao);
  
  let cadastrosFiltradosTemp = todosCadastros;
  let titulo = `Cadastros - ${formatarNomeWaitlabel(waitlabelAtual)}`;

  if (situacao !== 'all') {
    // ‚úÖ CORRE√á√ÉO: Filtrar pela situa√ß√£o correta
    cadastrosFiltradosTemp = todosCadastros.filter(cad => cad.situacao === situacao);
    titulo = `Cadastros - ${formatarNomeWaitlabel(waitlabelAtual)} - ${situacao}`;
  }

  // ‚úÖ CORRE√á√ÉO: SEMPRE AGRUPAR OS CADASTROS POR CNPJ
  cadastrosFiltrados = cadastrosFiltradosTemp;
  
  // ‚úÖ CORRE√á√ÉO: Usar a fun√ß√£o de exibi√ß√£o agrupada
  const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosFiltradosTemp);
  exibirTabelaCadastrosAgrupada(cadastrosAgrupados, titulo);
}

function limparDados() {
  limparFormulario();
  showMessage('info', 'Formul√°rio limpo! Pronto para novo cadastro.');
}

function buscarPorCNPJ() {
  // üî• CORRE√á√ÉO: Pegar CNPJ do campo de busca e remover formata√ß√£o
  const cnpjBusca = document.getElementById('cnpj').value.replace(/\D/g, '');
  
  if (!cnpjBusca) {
    showMessage('error', 'Digite um CNPJ para buscar');
    return;
  }

  showMessage('info', `üîç Buscando cadastro no ${formatarNomeWaitlabel(waitlabelAtual)}...`);

  google.script.run
    .withSuccessHandler(function(dados) {
      preencherDadosCadastro(dados);
    })
    .withFailureHandler(function(error) {
      showMessage('error', 'Erro: ' + error.message);
    })
    .buscarCadastroPorCNPJ(cnpjBusca); // ‚úÖ Envia apenas n√∫meros
}

function preencherFornecedorComTarifas(dados) {
  console.log("üîß PREENCHER FORNECEDOR - INICIANDO");
  console.log("üì¶ Dados recebidos:", dados);
  
  // Limpar sele√ß√µes anteriores
  const checkboxes = document.querySelectorAll('input[name="fornecedor"]');
  checkboxes.forEach(cb => {
    cb.checked = false;
    const fornecedorId = cb.value.toLowerCase();
    const configDiv = document.getElementById(`config-${fornecedorId}`);
    if (configDiv) {
      configDiv.style.display = 'none';
      const radios = configDiv.querySelectorAll('input[type="radio"]');
      radios.forEach(radio => radio.checked = false);
      const select = configDiv.querySelector('select');
      if (select) select.value = '0%';
    }
  });
  
  if (!dados.fornecedor) {
    console.log("‚ÑπÔ∏è Nenhum fornecedor para preencher");
    return;
  }
  
  // üî• CORRE√á√ÉO CR√çTICA: Buscar fornecedor de forma mais flex√≠vel
  const fornecedorBuscado = dados.fornecedor.toUpperCase().trim();
  console.log("üéØ Buscando fornecedor:", fornecedorBuscado);
  
  let checkboxEncontrado = null;
  
  // Buscar em TODOS os checkboxes
  checkboxes.forEach(cb => {
    const checkboxValor = cb.value.toUpperCase().trim();
    console.log(`üîç Comparando: "${checkboxValor}" com "${fornecedorBuscado}"`);
    
    if (checkboxValor === fornecedorBuscado) {
      checkboxEncontrado = cb;
    }
  });
  
  if (checkboxEncontrado) {
    console.log("‚úÖ Fornecedor encontrado:", checkboxEncontrado.value);
    checkboxEncontrado.checked = true;
    
    // Ativar configura√ß√µes
    const fornecedorId = checkboxEncontrado.value.toLowerCase();
    const configDiv = document.getElementById(`config-${fornecedorId}`);
    
    if (configDiv) {
      configDiv.style.display = 'grid';
      
      // üî• CORRE√á√ÉO: Preencher tarifa
      if (dados.tarifa) {
        const tarifaBuscada = dados.tarifa.toUpperCase().trim();
        console.log("üí∞ Buscando tarifa:", tarifaBuscada);
        
        const radioTarifa = configDiv.querySelector(`input[name="tarifa_${fornecedorId}"][value="${tarifaBuscada}"]`);
        if (radioTarifa) {
          radioTarifa.checked = true;
          console.log("‚úÖ Tarifa selecionada:", tarifaBuscada);
        } else {
          console.log("‚ö†Ô∏è Tarifa n√£o encontrada, usando MDR como padr√£o");
          const radioMDR = configDiv.querySelector(`input[name="tarifa_${fornecedorId}"][value="MDR"]`);
          if (radioMDR) {
            radioMDR.checked = true;
          }
        }
      }
      
      // üî• CORRE√á√ÉO: Preencher percentual tarifa
      if (dados.percentual_tarifa !== undefined && dados.percentual_tarifa !== null) {
        const selectPercentual = configDiv.querySelector(`select[name="percentual_${fornecedorId}"]`);
        if (selectPercentual) {
          let percentualParaSelect = dados.percentual_tarifa;
          
          console.log("üìä Percentual original:", percentualParaSelect, "Tipo:", typeof percentualParaSelect);
          
          // Converter para formato do select (ex: 0.03 ‚Üí 3%)
          if (typeof percentualParaSelect === 'number') {
            if (percentualParaSelect < 1) {
              percentualParaSelect = Math.round(percentualParaSelect * 100) + '%';
            } else {
              percentualParaSelect = Math.round(percentualParaSelect) + '%';
            }
          } else if (typeof percentualParaSelect === 'string') {
            // Se √© string sem %, adicionar %
            if (percentualParaSelect && !percentualParaSelect.includes('%')) {
              percentualParaSelect = percentualParaSelect + '%';
            }
          }
          
          console.log("‚úÖ Percentual para select:", percentualParaSelect);
          selectPercentual.value = percentualParaSelect;
          
          // Se n√£o encontrou, tentar op√ß√£o mais pr√≥xima
          if (!selectPercentual.value) {
            const valorNumerico = parseFloat(percentualParaSelect.replace('%', '').replace(',', '.'));
            if (!isNaN(valorNumerico)) {
              const opcoes = Array.from(selectPercentual.options);
              const opcaoCorrespondente = opcoes.find(opt => {
                const optValor = parseFloat(opt.value.replace('%', ''));
                return !isNaN(optValor) && optValor === valorNumerico;
              });
              if (opcaoCorrespondente) {
                selectPercentual.value = opcaoCorrespondente.value;
                console.log("‚úÖ Usando op√ß√£o correspondente:", opcaoCorrespondente.value);
              }
            }
          }
        }
      }
    }
  } else {
    console.log("‚ùå Fornecedor N√ÉO encontrado:", fornecedorBuscado);
    console.log("üîç Checkboxes dispon√≠veis:", Array.from(checkboxes).map(cb => cb.value));
  }
}

// üî• ADICIONE ESTA FUN√á√ÉO DE DEBUG PARA VERIFICAR OS DADOS
function debugDadosTarifa(dados) {
  console.log("üîçüîçüîç DEBUG DADOS TARIFA:");
  console.log("üì¶ Todos os dados:", dados);
  console.log("üí∞ Fornecedor:", dados.fornecedor);
  console.log("üíµ Tarifa:", dados.tarifa, "Tipo:", typeof dados.tarifa);
  console.log("üìä Percentual Tarifa:", dados.percentual_tarifa, "Tipo:", typeof dados.percentual_tarifa);
  console.log("üîç Chaves dispon√≠veis:", Object.keys(dados));
  
  // Verificar se h√° outras varia√ß√µes do nome do campo
  const chavesPercentual = Object.keys(dados).filter(key => 
    key.toLowerCase().includes('percent') || 
    key.toLowerCase().includes('tarifa')
  );
  console.log("üéØ Chaves relacionadas a tarifa/percentual:", chavesPercentual);
}

function limparBusca() {
  limparFormulario();
  
  // üî• CORRE√á√ÉO: Esconder a tabela tamb√©m
  document.getElementById('secaoCadastros').style.display = 'none';
  showMessage('info', 'Formul√°rio limpo e busca cancelada!');
}

// üî• CORRE√á√ÉO DA FUN√á√ÉO atualizarEventos()
function atualizarEventos() {
  const situacao = document.getElementById('situacao').value;
  const selectEvento = document.getElementById('evento');
  
  console.log("üéØ Atualizando eventos para situa√ß√£o:", situacao);
  
  // Limpar op√ß√µes atuais
  selectEvento.innerHTML = '<option value="">-- Selecione um evento --</option>';
  
  let eventos = [];
  
  // ‚úÖ CORRE√á√ÉO: Usar compara√ß√µes consistentes
  if (situacao === 'NOVO REGISTRO' || situacao === 'EM ANDAMENTO') {
    eventos = eventosEmAndamento;
  } else if (situacao === 'REJEITADO') {
    eventos = eventosRejeitado;
  } else if (situacao === 'CADASTRADO') {
    eventos = eventosCadastrado;
  } else if (situacao === 'DESCREDENCIADO') {
    eventos = eventosDescredenciado;
  } else if (situacao === 'DESISTIU') {
    eventos = eventosDesistiu; // üî• NOVOS EVENTOS PARA DESISTIU
  }
  
  console.log("üìã Eventos dispon√≠veis:", eventos);
  
  // Adicionar op√ß√µes ao select
  eventos.forEach(evento => {
    const option = document.createElement('option');
    option.value = evento;
    option.textContent = evento;
    selectEvento.appendChild(option);
  });
  
  // ‚úÖ CORRE√á√ÉO: Atualizar tamb√©m o campo de search
  atualizarEventosSearch();
}

// üî• ADICIONE ESTA FUN√á√ÉO PARA ATUALIZAR O CAMPO DE SEARCH
function atualizarEventosSearch() {
  const situacao = document.getElementById('situacao').value;
  const inputSearch = document.getElementById('inputEventoSearch');
  
  // Limpar o campo de search quando mudar a situa√ß√£o
  inputSearch.value = '';
  
  console.log("üîÑ Campo de search atualizado para situa√ß√£o:", situacao);
}

// üîÑ FUN√á√ïES DE LOADING
function showLoading(message = "Salvando dados...", submessage = "Aguarde um momento") {
  const overlay = document.getElementById('loadingOverlay');
  const loadingText = overlay.querySelector('.loading-text');
  const loadingSubtext = overlay.querySelector('.loading-subtext');
  
  loadingText.textContent = message;
  loadingSubtext.textContent = submessage;
  overlay.style.display = 'flex';
}

function hideLoading() {
  const overlay = document.getElementById('loadingOverlay');
  overlay.style.display = 'none';
}

// üî• CORRE√á√ÉO: Verificar se o elemento existe antes de adicionar event listener
const modalDetalhes = document.getElementById('modalDetalhes');
if (modalDetalhes) {
  modalDetalhes.addEventListener('click', function(e) {
    if (e.target === this) {
      fecharModalDetalhes();
    }
  });
}

// Fechar modal com ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    fecharModalDetalhes();
  }
});

function fecharModalDetalhes() {
  const modal = document.getElementById('modalDetalhes');
  modal.style.display = 'none';
}

// üî• ADICIONAR PARA EVITAR ERROS COM DATAS
function formatarDataParaExibicao(data) {
  if (!data) return '';
  
  try {
    // Se j√° estiver no formato brasileiro, retorna como est√°
    if (typeof data === 'string' && data.includes('/')) {
      return data;
    }
    
    // Se for objeto Date ou string ISO, formata
    const dateObj = new Date(data);
    if (!isNaN(dateObj.getTime())) {
      return dateObj.toLocaleDateString('pt-BR');
    }
    
    return data;
  } catch (error) {
    return data; // Retorna o valor original em caso de erro
  }
}

function getSituacaoClass(situacao) {
  if (!situacao) return 'situacao-cadastrado';
  
  const situacaoUpper = situacao.toUpperCase().trim();
  
  if (situacaoUpper.includes('NOVO REGISTRO')) return 'situacao-novo-registro';
  else if (situacaoUpper.includes('CADASTRADO')) return 'situacao-cadastrado';
  else if (situacaoUpper.includes('EM ANDAMENTO')) return 'situacao-andamento';
  else if (situacaoUpper.includes('REJEITADO') || situacaoUpper.includes('REJEITADO')) return 'situacao-rejeitado';
  else if (situacaoUpper.includes('DESCREDENCIADO')) return 'situacao-descredenciado';
  else if (situacaoUpper.includes('DESISTIU')) return 'situacao-desistiu'; // NOVA SITUA√á√ÉO
  else return 'situacao-cadastrado';
}

// üî• ADICIONAR: Fun√ß√£o para configurar valida√ß√£o em tempo real
function configurarValidacaoEmTempoReal() {
  const campos = document.querySelectorAll('#razao_social, #cnpj_cadastro, #tipo');
  campos.forEach(campo => {
    campo.addEventListener('input', function() {
      this.style.borderColor = '';
    });
  });
}

// üî• ADICIONAR: Fun√ß√£o para remover autoriza√ß√£o (√∫til para testes)
function limparAutorizacao() {
  localStorage.removeItem('usuarioAutorizado');
  location.reload();
}

// üî•üî•üî• COLE ESTAS FUN√á√ïES NO FINAL DO JAVASCRIPT üî•üî•üî•

// üî• FUN√á√ÉO PARA AGRUPAR CADASTROS POR CNPJ
function agruparCadastrosPorCNPJ(cadastros) {
  const agrupados = {};
  
  cadastros.forEach(cadastro => {
    if (!agrupados[cadastro.cnpj]) {
      agrupados[cadastro.cnpj] = {
        razao_social: cadastro.razao_social,
        nome_fantasia: cadastro.nome_fantasia,
        cnpj: cadastro.cnpj,
        tipo: cadastro.tipo,
        mensalidade: cadastro.mensalidade,
        adesao: cadastro.adesao,
        situacao: cadastro.situacao,
        evento: cadastro.evento,
        fornecedores: []
      };
    }
    
    agrupados[cadastro.cnpj].fornecedores.push({
      nome: cadastro.fornecedor,
      tarifa: cadastro.tarifa,
      percentual_tarifa: cadastro.percentual_tarifa,
      evento: cadastro.evento,
      id: cadastro.id,
      situacao: cadastro.situacao
    });
  });
  
  return Object.values(agrupados);
}

// üî• FUN√á√ÉO PARA EXIBIR TABELA AGRUPADA
function exibirTabelaCadastrosAgrupada(cadastrosAgrupados, titulo) {
  const secao = document.getElementById('secaoCadastros');
  const tituloElement = document.getElementById('tituloCadastros');
  const tableContainer = document.getElementById('tableContainer');
  const tabelaBody = document.getElementById('tabelaCadastrosBody');
  const loading = document.getElementById('loadingCadastros');

  tituloElement.textContent = `${titulo} (${cadastrosAgrupados.length})`;
  tabelaBody.innerHTML = '';

  if (cadastrosAgrupados.length === 0) {
    tabelaBody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align: center; padding: 40px;">
          <i class="fas fa-search" style="font-size: 3rem; color: var(--gray); margin-bottom: 15px;"></i>
          <h3>Nenhum resultado encontrado</h3>
          <p>Tente alterar os filtros de pesquisa.</p>
        </td>
      </tr>
    `;
  } else {
    cadastrosAgrupados.forEach(cadastro => {
      const row = criarLinhaTabelaAgrupada(cadastro);
      tabelaBody.appendChild(row);
    });
  }

  loading.style.display = 'none';
  tableContainer.style.display = 'block';
  secao.style.display = 'block';
  atualizarContador();
  
  setTimeout(() => {
    secao.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 300);
}

// üî• FUN√á√ÉO PARA PADRONIZAR O TEXTO DA SITUA√á√ÉO
function padronizarSituacao(situacao) {
  if (!situacao) return 'NOVO REGISTRO';
  
  const situacaoUpper = situacao.toUpperCase().trim();
  
  if (situacaoUpper.includes('NOVO REGISTRO')) return 'NOVO REGISTRO';
  else if (situacaoUpper.includes('CADASTRADO')) return 'CADASTRADO';
  else if (situacaoUpper.includes('EM ANDAMENTO')) return 'EM ANDAMENTO';
  else if (situacaoUpper.includes('REJEITADO') || situacaoUpper.includes('REJEITADO')) return 'REJEITADO';
  else if (situacaoUpper.includes('DESCREDENCIADO')) return 'DESCREDENCIADO';
  else if (situacaoUpper.includes('DESISTIU')) return 'DESISTIU'; // NOVA SITUA√á√ÉO
  
  return situacaoUpper;
}

// üî• FUN√á√ÉO PARA CRIAR LINHA DA TABELA AGRUPADA
function criarLinhaTabelaAgrupada(cadastro) {
  const row = document.createElement('tr');
  row.style.cursor = 'pointer';
  
  // Classes de situa√ß√£o - USA A MESMA PADRONIZA√á√ÉO
const situacaoPadronizada = padronizarSituacao(cadastro.situacao);
let situacaoClass = 'situacao-cadastrado';
if (situacaoPadronizada === 'Novo registro') situacaoClass = 'situacao-novo-registro';
else if (situacaoPadronizada === 'Em andamento') situacaoClass = 'situacao-andamento';
else if (situacaoPadronizada === 'Rejeitado') situacaoClass = 'situacao-rejeitado';
else if (situacaoPadronizada === 'Descredenciado') situacaoClass = 'situacao-descredenciado';

    row.innerHTML = `
  <td style="vertical-align: top; padding: 15px 8px;">
    <div style="font-weight: 600; color: var(--primary); margin-bottom: 4px;">${cadastro.razao_social || 'N/A'}</div>
    <div style="font-size: 0.8rem; color: var(--gray); margin-bottom: 4px;">${cadastro.nome_fantasia || 'Sem nome fantasia'}</div>
    <div style="font-size: 0.7rem; color: var(--info);">
      <strong>Evento:</strong> ${cadastro.evento || 'N/A'}
    </div>
    <div style="font-size: 0.7rem; color: var(--warning);">
      <strong>Situa√ß√£o:</strong> <span class="status-badge ${getSituacaoClass(cadastro.situacao)}">${padronizarSituacao(cadastro.situacao) || 'N/A'}</span>
    </div>
  </td>
<td style="vertical-align: top; padding: 15px 8px;">
    <div style="font-family: monospace; font-size: 0.85rem; font-weight: 600; color: var(--dark);">
        ${cadastro.cnpj || 'N/A'}
    </div>
</td>
  <td style="vertical-align: top; padding: 15px 8px;">
    <div style="font-weight: 500; background: var(--primary); color: white; padding: 4px 8px; border-radius: 12px; text-align: center; margin-bottom: 4px;">
      ${cadastro.fornecedores.length} fornecedor(es)
    </div>
    <div style="font-size: 0.7rem; color: var(--gray);">
      ${cadastro.fornecedores.map(f => f.nome).join(', ')}
    </div>
  </td>
  <td style="vertical-align: middle; font-weight: 600; color: var(--success); padding: 15px 8px; text-align: center;">
  ${formatarMoedaParaInput(cadastro.mensalidade)}
</td>
<td style="vertical-align: middle; font-weight: 600; color: var(--info); padding: 15px 8px; text-align: center;">
  ${cadastro.adesao === 'Isento' || cadastro.adesao === 0 ? 'Isento' : formatarMoedaParaInput(cadastro.adesao)}
</td>
  <td class="acoes-cell" style="vertical-align: middle; padding: 0; height: 100%; text-align: center;">
  <button class="btn btn-info btn-sm btn-visualizar-compact" onclick="verDetalhesAgrupados('${cadastro.cnpj}')" title="Visualizar">
    <i class="fas fa-eye"></i> Visualizar
  </button>
</td>
`;

  return row;
}

// üî• FUN√á√ÉO PARA VER TODAS AS LOJAS DE UM CNPJ (VERS√ÉO QUE FUNCIONA)
function verDetalhesAgrupados(cnpj) {
  console.log("üîçüîçüîç DEBUG: Fun√ß√£o verDetalhesAgrupados CHAMADA");
  console.log("üîç CNPJ:", cnpj);
  console.log("üîç todosCadastros length:", todosCadastros ? todosCadastros.length : 'NULL');
  
  if (!todosCadastros || todosCadastros.length === 0) {
    console.log("‚ùå ERRO: todosCadastros est√° vazio ou n√£o definido");
    showMessage('error', '‚ùå Dados n√£o carregados. Clique em "Ver Todos os Cadastros" primeiro.');
    return;
  }
  
  // üî• CORRE√á√ÉO: Filtrar das lojas que J√Å TEMOS carregadas
  const lojasDoCNPJ = todosCadastros.filter(cadastro => {
    console.log("üîç Comparando:", cadastro.cnpj, "com", cnpj);
    return cadastro.cnpj === cnpj;
  });
  
  console.log("‚úÖ Lojas encontradas:", lojasDoCNPJ.length);
  console.log("‚úÖ Lojas:", lojasDoCNPJ);
  
  if (lojasDoCNPJ.length > 0) {
    console.log("üéØ Chamando exibirModalLojasAgrupadas");
    exibirModalLojasAgrupadas(cnpj, lojasDoCNPJ);
  } else {
    console.log("‚ùå Nenhuma loja encontrada para CNPJ:", cnpj);
    showMessage('error', '‚ùå Nenhuma loja encontrada para este CNPJ');
  }
}

// üî• FUN√á√ÉO PARA COR DA BORDA POR SITUA√á√ÉO (PADRONIZADA)
function getCorBordaSituacao(situacao) {
  // üî• CORRE√á√ÉO: Padronizar para min√∫sculo
  const situacaoLower = situacao ? situacao.toLowerCase() : '';
  
  if (situacaoLower.includes('novo registro')) return '#bfe1f6';
  else if (situacaoLower.includes('cadastrado')) return '#D1E7DD';
  else if (situacaoLower.includes('em andamento')) return '#FFF3CD';
  else if (situacaoLower.includes('rejeitado') || situacaoLower.includes('rejeitado')) return '#E2E3E5';
  else if (situacaoLower.includes('descredenciado')) return '#F8D7DA';
  else if (situacaoLower.includes('desistiu')) return '#e6cff2'; // NOVA SITUA√á√ÉO
  else return 'var(--border)';
}

// üî• FUN√á√ÉO PARA EXIBIR MODAL COM TODAS AS LOJAS
function exibirModalLojasAgrupadas(cnpj, lojas) {
  const modal = document.getElementById('modalDetalhes');
  const content = document.getElementById('modalDetalhesContent');
  
  let lojasHTML = '';
  
  if (lojas && lojas.length > 0) {
    lojasHTML = lojas.map(loja => `
      <div class="loja-item" style="border: 3px solid ${getCorBordaSituacao(loja.situacao)}; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
          <h4 style="margin: 0; color: var(--primary);">üè™ ${loja.fornecedor || 'Fornecedor'}</h4>
          <span class="status-badge ${getSituacaoClass(loja.situacao)}">${loja.situacao || 'N/A'}</span>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
          <div><strong>üìÖ Evento:</strong> ${loja.evento || 'N/A'}</div>
          <div><strong>üí∞ Tarifa:</strong> ${loja.tarifa || 'N/A'} ${formatarPercentualParaExibicao(loja.percentual_tarifa)}</div>
          <div><strong>üíµ Mensalidade:</strong> ${formatarMoedaParaInput(loja.mensalidade)}</div>
          <div><strong>ü§ù Ades√£o:</strong> ${loja.adesao === 'Isento' || loja.adesao === 0 ? 'Isento' : formatarMoedaParaInput(loja.adesao)}</div>
        </div>
<div style="background: #f8f9fa; padding: 8px 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid var(--warning);">
  <strong>‚è∞ Defasagem:</strong> <span style="color: ${calcularDefasagem(loja.ultimo_evento).includes('30') || calcularDefasagem(loja.ultimo_evento).includes('31') ? 'var(--danger)' : 'var(--dark)'}; font-weight: 600;">${calcularDefasagem(loja.ultimo_evento)}</span>
</div>
        
        <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn btn-warning btn-sm" onclick="editarCadastroModal('${loja.id}')">
            <i class="fas fa-edit"></i> Editar
          </button>
          <button class="btn btn-info btn-sm" onclick="verDetalhesCadastroModal('${loja.id}')">
            <i class="fas fa-eye"></i> Detalhes
        </div>
      </div>
    `).join('');
  } else {
    lojasHTML = `
      <div style="text-align: center; padding: 40px; color: var(--gray);">
        <i class="fas fa-store-slash" style="font-size: 3rem; margin-bottom: 15px;"></i>
        <h4>Nenhuma loja encontrada</h4>
        <p>N√£o h√° lojas cadastradas para este CNPJ.</p>
      </div>
    `;
  }

  content.innerHTML = `
    <div style="margin-bottom: 15px;">
      <div style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
        <strong>CNPJ:</strong> ${cnpj}
      </div>
    </div>
    
    <div style="max-height: 60vh; overflow-y: auto;">
      <h4 style="color: var(--primary); margin-bottom: 15px;">
        üìä ${lojas ? lojas.length : 0} loja(s) encontrada(s)
      </h4>
      ${lojasHTML}
    </div>
  `;
  
  modal.style.display = 'flex';
}

function editarCadastroModal(id) {
    console.log("‚úèÔ∏è EDITANDO CADASTRO MODAL - INICIANDO");
    console.log("üîç ID recebido:", id, "Waitlabel atual:", waitlabelAtual);
    
    showLoading("Carregando dados...", "Buscando informa√ß√µes da loja");
    
    // üî• USAR A NOVA FUN√á√ÉO COM WAITLABEL
    google.script.run
        .withSuccessHandler(function(dados) {
            console.log("‚úÖ DADOS RECEBIDOS DO GS:", dados);
            hideLoading();
            fecharModalDetalhes(); // Fecha o modal das lojas
            
            if (dados.encontrado) {
                preencherDadosCadastro(dados);
                document.getElementById('razao_social').scrollIntoView({ behavior: 'smooth' });
                showMessage('success', '‚úÖ Cadastro carregado para edi√ß√£o!');
                
                // üî•üî•üî• CONFIGURAR BOT√ïES "APLICAR A TODOS" - CORRE√á√ÉO COMPLETA
                configurarBotoesAplicarATodos(dados.cnpj);
                
                // üî•üî•üî• MOSTRAR O BOT√ÉO "APLICAR A TODOS"
                document.getElementById('btnAplicarATodos').style.display = 'block';
            } else {
                showMessage('error', '‚ùå ' + dados.mensagem);
            }
        })
        .withFailureHandler(function(error) {
            console.error("‚ùå ERRO AO CARREGAR CADASTRO:", error);
            hideLoading();
            showMessage('error', '‚ùå Erro ao carregar cadastro: ' + error.message);
        })
        .buscarCadastroPorIDComWaitlabel(id, waitlabelAtual);
}


// üî• FUN√á√ÉO PARA VER DETALHES DE UMA LOJA ESPEC√çFICA (do modal)
function verDetalhesCadastroModal(id) {
  console.log("üëÄ Visualizando detalhes ID:", id, "Waitlabel:", waitlabelAtual);
  showLoading("Carregando detalhes...", "Buscando informa√ß√µes completas");
  
  google.script.run
    .withSuccessHandler(function(dados) {
      hideLoading();
      // üî• ADICIONAR WAITLABEL AOS DADOS PARA EXIBI√á√ÉO
      dados.waitlabel = waitlabelAtual;
      exibirModalDetalhesCompleto(dados);
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showMessage('error', '‚ùå Erro ao carregar detalhes: ' + error.message);
    })
    .buscarCadastroPorIDComWaitlabel(id, waitlabelAtual); // üî• NOVA FUN√á√ÉO
}

function exibirModalDetalhesCompleto(dados) {
  const modal = document.getElementById('modalDetalhes');
  const content = document.getElementById('modalDetalhesContent');
  
  // üî• ADICIONAR INFORMA√á√ÉO DO WAITLABEL (NOVA LINHA)
  const waitlabelInfo = dados.waitlabel ? 
    `<div style="background: ${WAITLABELS_CONFIG.CORES[dados.waitlabel] || '#7E3E9A'}; color: white; padding: 8px 12px; border-radius: 6px; margin-bottom: 15px; text-align: center;">
      <strong>üìÅ Waitlabel:</strong> ${formatarNomeWaitlabel(dados.waitlabel)}
    </div>` : '';
  
  const mensalidadeFormatada = formatarMoedaParaInput(dados.mensalidade);
  const mensalidadeSimFormatada = formatarMoedaParaInput(dados.mensalidade_sim || 0); // üî• CORRE√á√ÉO 
  const adesaoFormatada = dados.adesao === 'Isento' || dados.adesao === 0 ? 'Isento' : formatarMoedaParaInput(dados.adesao);
  
  // üî• CORRE√á√ÉO: Usar o campo correto para calcular defasagem
  const defasagem = calcularDefasagem(dados.ultimo_evento || dados.data_status);
  
  console.log("üîç DEBUG DEFASAGEM - Modal Detalhes:");
  console.log("Data status:", dados.data_status);
  console.log("√öltimo evento:", dados.ultimo_evento);
  console.log("Defasagem calculada:", defasagem);

  content.innerHTML = `
    ${waitlabelInfo} <!-- üî• ADICIONAR AQUI - LINHA NOVA -->
    
    <div class="detalhes-grid">
        <!-- üî• SE√á√ÉO: INFORMA√á√ïES PRINCIPAIS -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0f8ff; border-left: 4px solid #7E3E9A;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #7E3E9A;">
                <i class="fas fa-info-circle"></i> üìã INFORMA√á√ïES PRINCIPAIS
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üè¢ Raz√£o Social</span>
            <div class="detalhe-valor" style="font-weight: bold; color: #7E3E9A;">${dados.razao_social || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üè∑Ô∏è Nome Fantasia</span>
            <div class="detalhe-valor">${dados.nome_fantasia || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üî¢ CNPJ</span>
            <div class="detalhe-valor" style="font-family: monospace;">${dados.cnpj || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üìä Tipo</span>
            <div class="detalhe-valor">${dados.tipo || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üöö Fornecedor</span>
            <div class="detalhe-valor">${dados.fornecedor || 'N/A'}</div>
        </div>

        <!-- üî• SE√á√ÉO: FINANCEIRO -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0fff0; border-left: 4px solid #28a745; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #28a745;">
                <i class="fas fa-chart-line"></i> üí∞ INFORMA√á√ïES FINANCEIRAS
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üíµ Mensalidade</span>
            <div class="detalhe-valor" style="color: var(--success); font-weight: 600;">${mensalidadeFormatada}</div>
        </div>

        <div class="detalhe-item">
            <span class="detalhe-label" style="color: var(--primary); font-weight: 700;">üíú Mensalidade SIM</span>
            <div class="detalhe-valor" style="color: var(--primary); font-weight: 600;">${mensalidadeSimFormatada}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">ü§ù Ades√£o</span>
            <div class="detalhe-valor" style="color: var(--info); font-weight: 600;">${adesaoFormatada}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üí∞ Tarifa</span>
            <div class="detalhe-valor">${dados.tarifa || 'N/A'} ${formatarPercentualParaExibicao(dados.percentual_tarifa)}</div>
        </div>

        <!-- üî• SE√á√ÉO: CONTRATOS E DATAS -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #fff8f0; border-left: 4px solid #ff6b35; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #ff6b35;">
                <i class="fas fa-file-contract"></i> üìÑ CONTRATOS E DATAS
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üìÑ Contrato Enviado</span>
            <div class="detalhe-valor">${dados.contrato_enviado || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">‚úçÔ∏è Contrato Assinado</span>
            <div class="detalhe-valor">${dados.contrato_assinado || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üöÄ Data Ativa√ß√£o</span>
            <div class="detalhe-valor">${formatarDataParaExibicao(dados.ativacao) || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üìÖ √öltimo Evento</span>
            <div class="detalhe-valor">${dados.ultimo_evento || 'N/A'}</div>
        </div>

        <!-- üî• SE√á√ÉO: STATUS E ACOMPANHAMENTO -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0f0f8; border-left: 4px solid #6f42c1; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #6f42c1;">
                <i class="fas fa-tasks"></i> üìä STATUS E ACOMPANHAMENTO
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üéØ Situa√ß√£o</span>
            <div class="detalhe-valor">
                <span class="status-badge ${getSituacaoClass(dados.situacao)}">${dados.situacao || 'N/A'}</span>
            </div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üìÖ Evento</span>
            <div class="detalhe-valor">${dados.evento || 'N/A'}</div>
        </div>

        <!-- üî• SE√á√ÉO: LINKS E OBSERVA√á√ïES -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0f0f0; border-left: 4px solid #6c757d; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #6c757d;">
                <i class="fas fa-sticky-note"></i> üîó LINKS E OBSERVA√á√ïES
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üîó Link</span>
            <div class="detalhe-valor">
                ${dados.link ? 
                    `<a href="${dados.link}" target="_blank" style="color: #007bff; text-decoration: none;">
                        <i class="fas fa-external-link-alt"></i> ${dados.link}
                    </a>` 
                    : 'N/A'
                }
            </div>
        </div>
        
        <div class="detalhe-item" style="grid-column: 1 / -1;">
            <span class="detalhe-label">üìù Observa√ß√µes</span>
            <div class="detalhe-valor" style="max-height: 100px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                ${dados.observacoes || 'Nenhuma observa√ß√£o registrada'}
            </div>
        </div>

        <!-- üî• SE√á√ÉO: DEFASAGEM - CORRE√á√ÉO DA CONDI√á√ÉO -->
        ${defasagem !== 'N/A' && defasagem !== '0 dias' && defasagem !== 'Data inv√°lida' && defasagem !== 'Erro no c√°lculo' ? `
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #fff5f5; border-left: 4px solid #dc3545; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #dc3545;">
                <i class="fas fa-clock"></i> ‚ö†Ô∏è INFORMA√á√ïES DE DEFASAGEM
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">‚è∞ Defasagem</span>
            <div class="detalhe-valor">
                <span style="display: inline-flex; align-items: center; gap: 5px; background: #dc3545; color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.9rem; font-weight: 600;">
                    <i class="fas fa-clock"></i>
                    ${defasagem}
                </span>
            </div>
        </div>
        ` : ''}
    </div>

<div class="modal-detalhes-actions">
    <button type="button" class="btn btn-warning" onclick="editarCadastroModal('${dados.id}')">
        <i class="fas fa-edit"></i> ‚úèÔ∏è Editar Cadastro
    </button>
    </div>
  `;
  
  modal.style.display = 'flex';
}

function configurarFiltroEvento(situacao) {
  const container = document.getElementById('filtroEventoContainer');
  container.style.display = 'block';
  
  // üî• CORRE√á√ÉO: Salvar a situa√ß√£o atual CORRETAMENTE
  container.setAttribute('data-situacao-atual', situacao);
  console.log("üéØ Situa√ß√£o do filtro definida para:", situacao);
}

function filtrarSugestoesEvento() {
  const input = document.getElementById('inputFiltroEvento');
  const suggestions = document.getElementById('suggestionsEvento');
  const container = document.getElementById('filtroEventoContainer');
  const termo = input.value.toLowerCase().trim();
  
  if (termo.length < 1) {
    suggestions.style.display = 'none';
    return;
  }
  
  // üî• CORRE√á√ÉO: Pegar apenas os eventos da situa√ß√£o atual
  const situacaoAtual = container.dataset.situacaoAtual || 'all';
  let eventosDaSituacao = [];
  
  switch(situacaoAtual) {
    case 'all':
      // Se √© "Todos", mostrar eventos de todas as situa√ß√µes
      eventosDaSituacao = [
        ...eventosEmAndamento,
        ...eventosRejeitado,
        ...eventosCadastrado,
        ...eventosDescredenciado,
        ...eventosDesistiu // üî• ADICIONAR EVENTOS DESISTIU
      ];
      break;
    case 'Novo registro':
    case 'Em andamento':
      eventosDaSituacao = eventosEmAndamento;
      break;
    case 'Rejeitado':
      eventosDaSituacao = eventosRejeitado;
      break;
    case 'Cadastrado':
      eventosDaSituacao = eventosCadastrado;
      break;
    case 'Descredenciado':
      eventosDaSituacao = eventosDescredenciado;
      break;
    case 'Desistiu':
      eventosDaSituacao = eventosDesistiu; // üî• NOVOS EVENTOS PARA DESISTIU
      break;
    default:
      eventosDaSituacao = [];
  }
  
  // Filtrar eventos que correspondem ao termo
  const eventosFiltrados = eventosDaSituacao.filter(evento => 
    evento.toLowerCase().includes(termo)
  );
  
  if (eventosFiltrados.length === 0) {
    suggestions.style.display = 'none';
    return;
  }
  
  // üî• CORRE√á√ÉO: Agrupar por situa√ß√£o (mesmo sendo uma s√≥, para manter a estrutura)
  let html = '';
  
  // Se √© "Todos", agrupar por situa√ß√£o original
  if (situacaoAtual === 'all') {
    const eventosAgrupados = {
      'Em andamento': eventosFiltrados.filter(evento => eventosEmAndamento.includes(evento)),
      'Rejeitado': eventosFiltrados.filter(evento => eventosRejeitado.includes(evento)),
      'Cadastrado': eventosFiltrados.filter(evento => eventosCadastrado.includes(evento)),
      'Descredenciado': eventosFiltrados.filter(evento => evento === 'Descredenciado')
    };
    
    Object.keys(eventosAgrupados).forEach(situacao => {
      if (eventosAgrupados[situacao].length > 0) {
        html += `<div class="suggestion-evento-section">${situacao}</div>`;
        eventosAgrupados[situacao].forEach(evento => {
          html += `
            <div class="suggestion-evento-item" onclick="selecionarEventoFiltro('${evento}')">
              ${evento}
            </div>
          `;
        });
      }
    });
  } else {
    // Se √© uma situa√ß√£o espec√≠fica, mostrar s√≥ os eventos dela
    html += `<div class="suggestion-evento-section">${situacaoAtual}</div>`;
    eventosFiltrados.forEach(evento => {
      html += `
        <div class="suggestion-evento-item" onclick="selecionarEventoFiltro('${evento}')">
          ${evento}
        </div>
      `;
    });
  }
  
  suggestions.innerHTML = html;
  suggestions.style.display = 'block';
}

function selecionarEventoFiltro(evento) {
  const input = document.getElementById('inputFiltroEvento');
  const suggestions = document.getElementById('suggestionsEvento');
  
  input.value = evento;
  suggestions.style.display = 'none';
  
  // Aplicar o filtro
  aplicarFiltroEvento(evento);
}

function aplicarFiltroEvento(evento) {
  // Adicionar √† lista de filtros ativos
  const tagsContainer = document.getElementById('tagsFiltrosAtivos');
  const filtroExistente = Array.from(tagsContainer.children).find(tag => 
    tag.textContent.includes(evento)
  );
  
  if (!filtroExistente) {
    const tag = document.createElement('div');
    tag.className = 'filtro-chip ativo';
    tag.innerHTML = `
      ${evento}
      <button class="remover" onclick="removerFiltroEvento('${evento}')">
        <i class="fas fa-times"></i>
      </button>
    `;
    tagsContainer.appendChild(tag);
    tagsContainer.style.display = 'flex';
  }

  // üî•üî•üî• NOVA LINHA - APLICAR TODOS OS FILTROS (OR)
  aplicarFiltrosAtivos();
}

function removerFiltroEvento(evento) {
  const tagsContainer = document.getElementById('tagsFiltrosAtivos');
  const tagParaRemover = Array.from(tagsContainer.children).find(tag => 
    tag.textContent.includes(evento)
  );
  
  if (tagParaRemover) {
    tagParaRemover.remove();
  }

  // üî•üî•üî• SEMPRE REAPLICAR OS FILTROS RESTANTES
  aplicarFiltrosAtivos();
}

// üî•üî•üî• FUN√á√ÉO PARA APLICAR FILTRO OR (MOSTRAR LOJAS COM PELO MENOS 1 DOS EVENTOS)
function aplicarFiltrosAtivos() {
  const tagsContainer = document.getElementById('tagsFiltrosAtivos');
  const eventosAtivos = Array.from(tagsContainer.children).map(tag => 
    tag.textContent.trim().replace('√ó', '').trim()
  );
  
  if (eventosAtivos.length > 0) {
    // üî• FILTRO OR: Mostrar cadastros que tenham QUALQUER um dos eventos selecionados
    cadastrosFiltrados = todosCadastros.filter(cadastro => 
      eventosAtivos.includes(cadastro.evento)
    );
    
    const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosFiltrados);
    exibirTabelaCadastrosAgrupada(cadastrosAgrupados, `Filtrado por: ${eventosAtivos.join(' OU ')}`);
    
    tagsContainer.style.display = 'flex';
  } else {
    // Se n√£o h√° filtros, mostrar todos
    tagsContainer.style.display = 'none';
    recarregarCadastros();
  }
}

function limparFiltroEvento() {
  const input = document.getElementById('inputFiltroEvento');
  const suggestions = document.getElementById('suggestionsEvento');
  
  
  input.value = '';
  suggestions.style.display = 'none';
  
  
  // Remover todos os filtros
  const tagsContainer = document.getElementById('tagsFiltrosAtivos');
  tagsContainer.innerHTML = '';
  tagsContainer.style.display = 'none';
  
  recarregarCadastros();
}

// üî• FUN√á√ÉO PARA CARREGAR EVENTOS NO FILTRO
function carregarEventosParaFiltro(situacao) {
  const filtroEvento = document.getElementById('filtroEvento');
  
  // Limpar op√ß√µes atuais (mantendo "Todos os eventos")
  const opcaoTodos = filtroEvento.querySelector('option[value=""]');
  filtroEvento.innerHTML = '';
  if (opcaoTodos) {
    filtroEvento.appendChild(opcaoTodos);
  }
  
  // Coletar eventos √∫nicos baseados na situa√ß√£o
  let eventosUnicos = [];
  
  if (situacao === 'all') {
    eventosUnicos = [...new Set(todosCadastros
      .filter(cad => cad.evento && cad.evento.trim() !== '')
      .map(cad => cad.evento)
    )].sort();
  } else {
    eventosUnicos = [...new Set(todosCadastros
      .filter(cad => cad.situacao === situacao && cad.evento && cad.evento.trim() !== '')
      .map(cad => cad.evento)
    )].sort();
  }
  
  // Adicionar eventos ao select
  eventosUnicos.forEach(evento => {
    const option = document.createElement('option');
    option.value = evento;
    option.textContent = evento;
    filtroEvento.appendChild(option);
  });
}

// üî• FUN√á√ÉO PARA FILTRAR PESQUISA
function filtrarPesquisa() {
  const termo = document.getElementById('pesquisaCadastros').value.toLowerCase().trim();
  console.log("üîç Pesquisando por:", termo);
  
  if (!termo) {
    // Se campo vazio, mostrar todos
    cadastrosFiltrados = [...todosCadastros];
  } else {
    // Filtrar por m√∫ltiplos campos
    cadastrosFiltrados = todosCadastros.filter(cadastro => 
      (cadastro.razao_social && cadastro.razao_social.toLowerCase().includes(termo)) ||
      (cadastro.nome_fantasia && cadastro.nome_fantasia.toLowerCase().includes(termo)) ||
      (cadastro.cnpj && cadastro.cnpj.includes(termo)) ||
      (cadastro.fornecedor && cadastro.fornecedor.toLowerCase().includes(termo)) ||
      (cadastro.evento && cadastro.evento.toLowerCase().includes(termo))
    );
  }
  
  const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosFiltrados);
  exibirTabelaCadastrosAgrupada(cadastrosAgrupados, `Resultados para: "${termo}"`);
}

// üî• FUN√á√ÉO PARA ATUALIZAR CONTADOR
function atualizarContador() {
  const contador = document.getElementById('contadorCadastros');
  const cadastrosVisiveis = document.querySelectorAll('#tabelaCadastrosBody tr').length;
  contador.textContent = `${cadastrosVisiveis} cadastro${cadastrosVisiveis !== 1 ? 's' : ''}`;
}

// üî• FUN√á√ïES ADICIONAIS PARA COMPLETAR
function ordenarCadastros() {
  const criterio = document.getElementById('ordenacaoCadastros').value;
  console.log("üîÄ Ordenando por:", criterio);
  
  if (cadastrosFiltrados.length === 0) return;
  
  const cadastrosOrdenados = [...cadastrosFiltrados].sort((a, b) => {
    const valorA = a[criterio] || '';
    const valorB = b[criterio] || '';
    
    if (typeof valorA === 'string' && typeof valorB === 'string') {
      return valorA.localeCompare(valorB);
    }
    return 0;
  });
  
  const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosOrdenados);
  exibirTabelaCadastrosAgrupada(cadastrosAgrupados, 'Cadastros Ordenados');
}

function recarregarCadastros() {
  console.log("üîÑ Recarregando cadastros...");
  mostrarTodosCadastros();
}

// üî• CORRE√á√ÉO DA FUN√á√ÉO - AGORA VAI FUNCIONAR!
function filtrarSugestoesEventoSearch() {
  const input = document.getElementById('inputEventoSearch');
  const suggestions = document.getElementById('suggestionsEventoSearch');
  const termo = input.value.toLowerCase().trim();
  
  console.log("üéØ FILTRAR SUGEST√ïES EVENTO SEARCH - Termo:", termo);
  
  // üî• OBTER EVENTOS BASEADO NA SITUA√á√ÉO ATUAL - CORRE√á√ÉO DEFINITIVA
  const situacaoAtual = document.getElementById('situacao').value;
  let eventosDaSituacao = [];
  
  console.log("üìã Situa√ß√£o atual do select:", situacaoAtual);
  
  // ‚úÖ CORRE√á√ÉO DEFINITIVA: Compara√ß√µes corretas e completas
  if (situacaoAtual === 'NOVO REGISTRO') {
    eventosDaSituacao = eventosNovoRegistro;
    console.log("üìù Carregando eventos NOVO REGISTRO:", eventosNovoRegistro);
  } else if (situacaoAtual === 'EM ANDAMENTO') {
    eventosDaSituacao = eventosEmAndamento;
    console.log("üìù Carregando eventos EM ANDAMENTO:", eventosEmAndamento);
  } else if (situacaoAtual === 'REJEITADO') {
    eventosDaSituacao = eventosRejeitado;
    console.log("üìù Carregando eventos REJEITADO:", eventosRejeitado);
  } else if (situacaoAtual === 'CADASTRADO') {
    eventosDaSituacao = eventosCadastrado;
    console.log("üìù Carregando eventos CADASTRADO:", eventosCadastrado);
  } else if (situacaoAtual === 'DESCREDENCIADO') {
    eventosDaSituacao = eventosDescredenciado;
    console.log("üìù Carregando eventos DESCREDENCIADO:", eventosDescredenciado);
  } else if (situacaoAtual === 'DESISTIU') {
    eventosDaSituacao = eventosDesistiu; // üî• NOVOS EVENTOS PARA DESISTIU
    console.log("üìù Carregando eventos DESISTIU:", eventosDesistiu);
  }
  
  console.log("üéØ Total de eventos carregados:", eventosDaSituacao.length);
  
  // Se n√£o digitou nada, mostrar TODOS os eventos da situa√ß√£o
  let eventosParaMostrar = eventosDaSituacao;
  
  // Se digitou algo, filtrar
  if (termo.length > 0) {
    eventosParaMostrar = eventosDaSituacao.filter(evento => 
      evento.toLowerCase().includes(termo)
    );
    console.log("üîç Eventos filtrados:", eventosParaMostrar.length);
  }
  
  if (eventosParaMostrar.length === 0) {
    suggestions.innerHTML = `
      <div class="suggestion-evento-item-search" style="color: var(--gray);">
        <i class="fas fa-search"></i>
        Nenhum evento encontrado
      </div>
    `;
  } else {
    let html = `<div class="suggestion-evento-section-search">
      <i class="fas fa-filter"></i> Eventos para: ${situacaoAtual} (${eventosParaMostrar.length})
    </div>`;
    
    eventosParaMostrar.forEach(evento => {
      html += `
        <div class="suggestion-evento-item-search" onclick="selecionarEventoSearch('${evento}')">
          <i class="fas fa-calendar-check"></i>
          ${evento}
        </div>
      `;
    });
    
    suggestions.innerHTML = html;
  }
  
  suggestions.style.display = 'block';
  console.log("‚úÖ Sugest√µes mostradas com sucesso!");
}

// üî• ADICIONE TAMB√âM ESTA FUN√á√ÉO PARA TESTE R√ÅPIDO
function testarEventos() {
  console.log("=== üß™ TESTE DE EVENTOS ===");
  console.log("NOVO REGISTRO:", eventosNovoRegistro);
  console.log("CADASTRADO:", eventosCadastrado);
  console.log("EM ANDAMENTO:", eventosEmAndamento);
  console.log("REJEITADO:", eventosRejeitado);
  console.log("DESCREDENCIADO:", eventosDescredenciado);
  
  // Testar a fun√ß√£o
  filtrarSugestoesEventoSearch();
}

// üî• CONFIGURA√á√ÉO PARA FECHAR SUGEST√ïES AO CLICAR FORA
document.addEventListener('click', function(e) {
  // Fechar sugest√µes do formul√°rio
  const suggestionsSearch = document.getElementById('suggestionsEventoSearch');
  const inputSearch = document.getElementById('inputEventoSearch');
  
  if (suggestionsSearch && suggestionsSearch.style.display === 'block') {
    if (!suggestionsSearch.contains(e.target) && e.target !== inputSearch) {
      suggestionsSearch.style.display = 'none';
      console.log("‚ùå Fechando sugest√µes - clique fora");
    }
  }
  
  // Fechar sugest√µes do filtro
  const suggestionsFiltro = document.getElementById('suggestionsEvento');
  const inputFiltro = document.getElementById('inputFiltroEvento');
  
  if (suggestionsFiltro && suggestionsFiltro.style.display === 'block') {
    if (!suggestionsFiltro.contains(e.target) && e.target !== inputFiltro) {
      suggestionsFiltro.style.display = 'none';
    }
  }
});

// üî• FECHAR SUGEST√ïES COM ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const suggestionsSearch = document.getElementById('suggestionsEventoSearch');
    const suggestionsFiltro = document.getElementById('suggestionsEvento');
    
    if (suggestionsSearch) {
      suggestionsSearch.style.display = 'none';
      console.log("‚ùå Fechando sugest√µes - ESC pressionado");
    }
    if (suggestionsFiltro) suggestionsFiltro.style.display = 'none';
  }
});

// üî• MOSTRAR SUGEST√ïES AO CLICAR NO CAMPO (PARA O FORMUL√ÅRIO)
document.getElementById('inputEventoSearch').addEventListener('click', function() {
  console.log("üéØ Clicou no campo de evento - mostrando sugest√µes");
  filtrarSugestoesEventoSearch();
});

// üî• TESTE SIMPLES PARA VERIFICAR SE OS EVENTOS EST√ÉO CARREGADOS
setTimeout(() => {
  console.log("=== üî• TESTE DE EVENTOS ===");
  console.log("Eventos Em Andamento:", eventosEmAndamento);
  console.log("Eventos Cadastrado:", eventosCadastrado);
  console.log("Eventos Rejeitado:", eventosRejeitado);
}, 2000);

// Fun√ß√£o para selecionar evento no search
function selecionarEventoSearch(evento) {
  const input = document.getElementById('inputEventoSearch');
  const suggestions = document.getElementById('suggestionsEventoSearch');
  const selectEvento = document.getElementById('evento');
  
  // Definir valores
  input.value = evento;
  selectEvento.value = evento;
  
  // Ocultar sugest√µes
  suggestions.style.display = 'none';
  
  console.log("‚úÖ Evento selecionado:", evento);
}

// üî• NOVA FUN√á√ÉO: Sincronizar campos de evento - ADICIONE ISSO NO FINAL
function sincronizarCamposEvento() {
  const inputSearch = document.getElementById('inputEventoSearch');
  const selectEvento = document.getElementById('evento');
  
  if (!inputSearch || !selectEvento) {
    console.log("‚ùå Campos de evento n√£o encontrados");
    return;
  }
  
  console.log("‚úÖ Sincronizando campos de evento...");
  
  // Quando o search muda, atualiza o select
  inputSearch.addEventListener('input', function() {
    const valor = this.value;
    console.log("üîÑ Input evento alterado:", valor);
    
    // Encontrar op√ß√£o correspondente no select
    const opcoes = Array.from(selectEvento.options);
    const opcaoCorrespondente = opcoes.find(opt => opt.text === valor);
    
    if (opcaoCorrespondente) {
      selectEvento.value = opcaoCorrespondente.value;
      console.log("‚úÖ Select atualizado para:", opcaoCorrespondente.value);
    } else {
      selectEvento.value = '';
      console.log("‚ö†Ô∏è Nenhuma op√ß√£o correspondente encontrada");
    }
  });
  
  // Quando o select muda, atualiza o search
  selectEvento.addEventListener('change', function() {
    const opcaoSelecionada = this.options[this.selectedIndex];
    if (opcaoSelecionada && opcaoSelecionada.value) {
      inputSearch.value = opcaoSelecionada.text;
      console.log("‚úÖ Input search atualizado para:", opcaoSelecionada.text);
    }
  });
}

// üî• TESTE FINAL - VERIFICAR SE TUDO EST√Å FUNCIONANDO
setTimeout(() => {
  console.log("=== üß™ TESTE FINAL DO SISTEMA ===");
  console.log("‚úÖ DOMContentLoaded executado");
  console.log("‚úÖ Event listener do inputEventoSearch:", document.getElementById('inputEventoSearch') !== null);
  console.log("‚úÖ Fun√ß√£o filtrarSugestoesEventoSearch:", typeof filtrarSugestoesEventoSearch);
  console.log("‚úÖ CSS carregado corretamente");
  
  // Teste manual: clique no campo para ver se as sugest√µes aparecem
  const inputEvento = document.getElementById('inputEventoSearch');
  if (inputEvento) {
    console.log("üéØ Clique no campo 'Digite para buscar evento...' para testar as sugest√µes!");
  }
}, 3000);

  </script>
</body>
</html>
