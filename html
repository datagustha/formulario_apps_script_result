<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gest√£o de Cadastros - RESULT</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    /* üî• ESTILOS DO SISTEMA - TAMANHO REDUZIDO */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    
    :root {
      --primary: #7E3E9A;
      --secondary: #A1CC4C;
      --accent: #FF6B35;
      --dark: #2D3047;
      --light: #FFFFFF;
      --success: #28A745;
      --warning: #FFC107;
      --danger: #DC3545;
      --info: #17A2B8;
      --gray: #6C757D;
      --border: #E0E0E0;
      --background: #F8F9FA;
    }
    
    body {
      background: var(--background);
      min-height: 100vh;
      padding: 15px;
      color: var(--dark);
      font-size: 14px; /* üî• TAMANHO REDUZIDO */
    }
    
    .container {
      max-width: 1800px;
      margin: 0 auto;
      background: var(--light);
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }
    
    .header {
      background: var(--primary);
      padding: 20px 30px; /* üî• TAMANHO REDUZIDO */
      color: white;
      text-align: center;
    }

    
    .logo-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }
    
    .logo {
      width: 80px; /* üî• TAMANHO REDUZIDO */
      height: 80px;
      background: white;
      padding: 10px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      object-fit: contain;
    }
    
    h1 {
      font-size: 2rem; /* üî• TAMANHO REDUZIDO */
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .subtitle {
      font-size: 1rem; /* üî• TAMANHO REDUZIDO */
      opacity: 0.9;
    }
    
    .content {
      padding: 25px; /* üî• TAMANHO REDUZIDO */
    }
    
 .card {
  background: var(--light);
  border-radius: 10px;
  padding: 20px; /* üî• TAMANHO REDUZIDO */
  margin-bottom: 20px;
  margin-top: 30px;
  box-shadow: 0 3px 12px rgba(0, 0, 0, 0.04);
  border: 1px solid var(--border);
}
    
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--primary);
    }
    
    .card-header i {
      color: var(--primary);
      font-size: 1.5rem; /* üî• TAMANHO REDUZIDO */
    }
    
    .card-title {
      font-size: 1.3rem; /* üî• TAMANHO REDUZIDO */
      font-weight: 600;
      color: var(--primary);
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--dark);
      font-size: 0.9rem; /* üî• TAMANHO REDUZIDO */
    }
    
    .form-control {
      width: 100%;
      padding: 10px 12px; /* üî• TAMANHO REDUZIDO */
      border: 2px solid var(--border);
      border-radius: 6px;
      font-size: 0.9rem; /* üî• TAMANHO REDUZIDO */
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px; /* üî• TAMANHO REDUZIDO */
      border: none;
      border-radius: 6px;
      font-size: 0.9rem; /* üî• TAMANHO REDUZIDO */
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #6a2e82;
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-warning {
      background: var(--warning);
      color: var(--dark);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-info {
      background: var(--info);
      color: white;
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-sm {
      padding: 6px 12px; /* üî• TAMANHO REDUZIDO */
      font-size: 0.8rem; /* üî• TAMANHO REDUZIDO */
    }

 /* üî• ESTILOS PARA BOT√ïES DE FILTRO ATIVOS */
.filtros-container .btn.active {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(126, 62, 154, 0.3);
  border: 2px solid var(--primary) !important;
}

/* Estilo espec√≠fico para o bot√£o "Todos" quando ativo */
.filtros-container .btn.active[onclick="filtrarTabela('all')"] {
  background: var(--primary) !important;
  color: white !important;
  border-color: var(--primary) !important;
}

/* Estilo para os outros bot√µes quando ativos */
.filtros-container .btn.active:not([onclick="filtrarTabela('all')"]) {
  border: 2px solid var(--primary) !important;
  box-shadow: 0 0 0 3px rgba(126, 62, 154, 0.2) !important;
}
    
    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .message {
      padding: 12px 16px; /* üî• TAMANHO REDUZIDO */
      border-radius: 6px;
      margin: 12px 0;
      display: none;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem; /* üî• TAMANHO REDUZIDO */
    }
    
    .success {
      background: #d4edda;
      color: var(--success);
      border: 1px solid #c3e6cb;
    }
    
    .error {
      background: #f8d7da;
      color: var(--danger);
      border: 1px solid #f5c6cb;
    }
    
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    /* üî• ESTILOS DE LOADING */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px;
      text-align: center;
    }
    
    .loading-spinner {
      width: 40px; /* üî• TAMANHO REDUZIDO */
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* üî•üî•üî• NOVOS ESTILOS DA TABELA - TAMANHO REDUZIDO */
    .table-container {
      margin-top: 15px;
      overflow: hidden;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .table-responsive {
      overflow-x: auto;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      font-size: 0.8rem; /* üî• TAMANHO REDUZIDO */
    }
    
    .data-table th {
      background: var(--primary);
      color: white;
      padding: 10px 6px; /* üî• TAMANHO REDUZIDO */
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      white-space: nowrap;
      font-size: 0.8rem; /* üî• TAMANHO REDUZIDO */
    }
    
    .data-table td {
      padding: 8px 6px; /* üî• TAMANHO REDUZIDO */
      border-bottom: 1px solid var(--border);
      word-wrap: break-word;
      vertical-align: top;
    }
    
    .data-table tbody tr {
      transition: all 0.3s ease;
    }
    
    .data-table tbody tr:hover {
      background: #f8f9fa;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    
    .data-table .btn-sm {
      padding: 5px 10px; /* üî• TAMANHO REDUZIDO */
      font-size: 0.75rem; /* üî• TAMANHO REDUZIDO */
      margin: 2px;
    }
    
    .status-badge {
      padding: 3px 6px; /* üî• TAMANHO REDUZIDO */
      border-radius: 10px;
      font-size: 0.7rem; /* üî• TAMANHO REDUZIDO */
      font-weight: 600;
      text-align: center;
      display: inline-block;
      min-width: 70px; /* üî• TAMANHO REDUZIDO */
    }
    
    .acoes-cell {
      display: flex;
      gap: 4px;
      justify-content: center;
      align-items: center;
    }
    
.action-buttons {
  display: flex;
  gap: 12px;
  margin: 30px 0 15px 0;
  flex-wrap: wrap;
}
    
    .cadastros-container {
      margin-top: 25px;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
      border: 2px solid var(--primary);
    }
    
    .cadastros-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .cadastro-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      border: 2px solid var(--border);
      transition: all 0.3s ease;
    }
    
    .cadastro-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .cadastro-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .cadastro-nome {
      font-size: 1.1rem; /* üî• TAMANHO REDUZIDO */
      font-weight: 700;
      color: var(--dark);
    }
    
    .cadastro-situacao {
      padding: 3px 10px; /* üî• TAMANHO REDUZIDO */
      border-radius: 15px;
      font-size: 0.75rem; /* üî• TAMANHO REDUZIDO */
      font-weight: 600;
    }
    
    .situacao-cadastrado {
      background: #D1E7DD;
      color: #0F5132;
    }

    .situacao-novo-registro {
      background-color: #bfe1f6 !important;
      color: #0c5aa3 !important;
      border: 1px solid #8bc9f0 !important;
    }
    
    .situacao-andamento {
      background: #FFF3CD;
      color: #856404;
    }
    
    .situacao-rejeitado {
      background: #E2E3E5;
      color: #383D41;
    }
    
    .situacao-descredenciado {
      background: #F8D7DA;
      color: #721C24;
    }

    .situacao-desistiu {
      background: #e6cff2 !important;
      color: #4a1e6b !important;
      border: 1px solid #d4b5e6 !important;
    }
    
    .cadastro-info {
      margin-bottom: 6px;
      font-size: 0.85rem; /* üî• TAMANHO REDUZIDO */
    }
    
    .cadastro-info strong {
      color: var(--primary);
    }
    
    .mensalidade-badge {
      background: var(--primary);
      color: white;
      padding: 3px 8px; /* üî• TAMANHO REDUZIDO */
      border-radius: 12px;
      font-size: 0.75rem; /* üî• TAMANHO REDUZIDO */
      font-weight: 600;
    }
    
    /* üî•üî•üî• NOVOS FILTROS COM ESTILO WHITELABEL - TAMANHO REDUZIDO */
    .filtros-container {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin: 15px 0;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .filtro-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px; /* üî• TAMANHO REDUZIDO */
      border: 2px solid var(--border);
      border-radius: 20px;
      font-size: 0.85rem; /* üî• TAMANHO REDUZIDO */
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
      color: var(--dark);
      position: relative;
    }

    .filtro-btn.active {
      transform: translateY(-2px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.15);
      border-width: 2px;
    }

    .filtro-btn::before {
      content: '';
      width: 10px; /* üî• TAMANHO REDUZIDO */
      height: 10px;
      border-radius: 50%;
      margin-right: 4px;
    }

    .filtro-btn[data-situacao="all"]::before { background: var(--primary); }
    .filtro-btn[data-situacao="NOVO REGISTRO"]::before { background: #bfe1f6; }
    .filtro-btn[data-situacao="CADASTRADO"]::before { background: var(--success); }
    .filtro-btn[data-situacao="EM ANDAMENTO"]::before { background: var(--warning); }
    .filtro-btn[data-situacao="REJEITADO"]::before { background: var(--gray); }
    .filtro-btn[data-situacao="DESCREDENCIADO"]::before { background: var(--danger); }
    .filtro-btn[data-situacao="DESISTIU"]::before { background: #e6cff2; }

    .filtro-btn.active[data-situacao="all"] { 
      background: var(--primary); 
      color: white; 
      border-color: var(--primary); 
    }
    .filtro-btn.active[data-situacao="NOVO REGISTRO"] { 
      background: #bfe1f6; 
      color: #0c5aa3; 
      border-color: #bfe1f6; 
    }
    .filtro-btn.active[data-situacao="CADASTRADO"] { 
      background: var(--success); 
      color: white; 
      border-color: var(--success); 
    }
    .filtro-btn.active[data-situacao="EM ANDAMENTO"] { 
      background: var(--warning); 
      color: var(--dark); 
      border-color: var(--warning); 
    }
    .filtro-btn.active[data-situacao="REJEITADO"] { 
      background: var(--gray); 
      color: white; 
      border-color: var(--gray); 
    }
    .filtro-btn.active[data-situacao="DESCREDENCIADO"] { 
      background: var(--danger); 
      color: white; 
      border-color: var(--danger); 
    }
    .filtro-btn.active[data-situacao="DESISTIU"] { 
      background: #e6cff2; 
      color: #4a1e6b; 
      border-color: #e6cff2; 
    }

    /* üî•üî•üî• FILTROS AVAN√áADOS - TAMANHO REDUZIDO */
    .filtros-avancados {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin: 15px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .filtro-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filtro-label {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.85rem; /* üî• TAMANHO REDUZIDO */
    }

    .form-select {
      width: 100%;
      padding: 8px 10px; /* üî• TAMANHO REDUZIDO */
      border: 2px solid var(--border);
      border-radius: 6px;
      font-size: 0.85rem; /* üî• TAMANHO REDUZIDO */
      background: white;
      cursor: pointer;
    }

    .contador-lojas {
      background: var(--primary);
      color: white;
      padding: 5px 10px; /* üî• TAMANHO REDUZIDO */
      border-radius: 15px;
      font-size: 0.85rem; /* üî• TAMANHO REDUZIDO */
      font-weight: 600;
    }

    /* üî•üî•üî• TAGS DE FILTROS ATIVOS - TAMANHO REDUZIDO */
    .filtros-ativos {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 8px 0;
    }

    .filtro-chip {
      background: var(--primary);
      color: white;
      padding: 4px 10px; /* üî• TAMANHO REDUZIDO */
      border-radius: 15px;
      font-size: 0.75rem; /* üî• TAMANHO REDUZIDO */
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .filtro-chip .remover {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 0;
      width: 14px; /* üî• TAMANHO REDUZIDO */
      height: 14px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px; /* üî• TAMANHO REDUZIDO */
    }

    /* üî•üî•üî• FILTRO DE EVENTOS E FORNECEDORES COM TAGS - TAMANHO REDUZIDO */
    .filtro-multiselect-container {
      position: relative;
    }

    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid var(--primary);
      border-top: none;
      border-radius: 0 0 6px 6px;
      z-index: 1000;
      max-height: 180px; /* üî• TAMANHO REDUZIDO */
      overflow-y: auto;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      display: none;
    }

    .suggestion-item {
      padding: 8px 12px; /* üî• TAMANHO REDUZIDO */
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: all 0.2s ease;
      font-size: 0.85rem; /* üî• TAMANHO REDUZIDO */
    }

    .suggestion-item:hover {
      background: var(--primary);
      color: white;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .tags-selecionadas {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .tag {
      background: var(--info);
      color: white;
      padding: 3px 8px; /* üî• TAMANHO REDUZIDO */
      border-radius: 12px;
      font-size: 0.75rem; /* üî• TAMANHO REDUZIDO */
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .tag.fornecedor {
      background: var(--secondary);
    }

    .tag .remover {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 0;
      width: 12px; /* üî• TAMANHO REDUZIDO */
      height: 12px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px; /* üî• TAMANHO REDUZIDO */
    }

    .tag .remover:hover {
      background: rgba(255,255,255,0.3);
    }

    /* üî•üî•üî• BOT√ÉO VISUALIZAR COMPACT - TAMANHO REDUZIDO */
    .btn-visualizar-compact {
      padding: 5px 8px !important; /* üî• TAMANHO REDUZIDO */
      font-size: 0.7rem !important; /* üî• TAMANHO REDUZIDO */
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
    }

    .defasagem-badge {
  padding: 6px 10px !important;
  border-radius: 8px !important;
  font-size: 0.75rem !important;
  font-weight: 700 !important;
  min-width: 70px;
  display: inline-block;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

    .defasagem-alta {
      background: #f8d7da;
      color: #721c24;
    }

    .defasagem-media {
      background: #fff3cd;
      color: #856404;
    }

    .defasagem-baixa {
      background: #d1e7dd;
      color: #0f5132;
    }

    /* üî• ESTILO PARA SEM DEFASAGEM */
.sem-defasagem {
  background: #e9ecef !important;
  color: #6c757d !important;
  border: 1px solid #dee2e6 !important;
}

.sem-defasagem-badge {
  padding: 6px 10px !important;
  border-radius: 8px !important;
  font-size: 0.75rem !important;
  font-weight: 600 !important;
  background: #e9ecef !important;
  color: #6c757d !important;
  border: 1px solid #dee2e6 !important;
  min-width: 70px;
  display: inline-block;
  text-align: center;
}

    .filtros-eventos {
      display: none;
      margin-top: 8px;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

/* üî• ESTILOS PARA FILTRO DE EVENTOS COM SEARCH */
.filtro-search-container {
  margin: 12px 0;
  padding: 12px;
  background: var(--light);
  border-radius: 8px;
  border: 1px solid var(--border);
}

.suggestions-evento {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid var(--primary);
  border-top: none;
  border-radius: 0 0 6px 6px;
  z-index: 1000;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
  max-height: 180px; /* üî• TAMANHO REDUZIDO */
  overflow-y: auto;
  margin-top: -2px;
}

.suggestion-evento-item {
  padding: 8px 12px; /* üî• TAMANHO REDUZIDO */
  cursor: pointer;
  border-bottom: 1px solid var(--border);
  transition: all 0.2s ease;
  font-size: 0.85rem; /* üî• TAMANHO REDUZIDO */
}

.suggestion-evento-item:hover {
  background: var(--primary);
  color: white;
}

.suggestion-evento-item:last-child {
  border-bottom: none;
}

.suggestion-evento-section {
  background: var(--primary);
  color: white;
  font-weight: 700;
  padding: 6px 12px; /* üî• TAMANHO REDUZIDO */
  font-size: 0.75rem; /* üî• TAMANHO REDUZIDO */
  border-bottom: 1px solid var(--border);
}

.filtro-chip {
  background: white;
  border: 2px solid var(--border);
  border-radius: 15px;
  padding: 4px 10px; /* üî• TAMANHO REDUZIDO */
  font-size: 11px; /* üî• TAMANHO REDUZIDO */
  display: flex;
  align-items: center;
  gap: 5px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
}

.filtro-chip.ativo {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.filtro-chip .remover {
  background: none;
  border: none;
  color: inherit;
  cursor: pointer;
  padding: 0;
  width: 14px; /* üî• TAMANHO REDUZIDO */
  height: 14px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
      font-size: 9px; /* üî• TAMANHO REDUZIDO */
}
    
    /* üî• ESTILOS PARA PESQUISA */
    .search-container {
      position: relative;
    }

    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--primary);
      border-top: none;
      border-radius: 0 0 8px 8px;
      z-index: 1000;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      margin-top: -2px;
      max-height: 250px; /* üî• TAMANHO REDUZIDO */
      overflow-y: auto;
    }

    .suggestion-item {
      padding: 10px 14px; /* üî• TAMANHO REDUZIDO */
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: all 0.2s ease;
      font-size: 0.9rem; /* üî• TAMANHO REDUZIDO */
      font-weight: 500;
    }

    .suggestion-item:hover {
      background: var(--primary);
      color: white;
      font-weight: 600;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-section {
      background: var(--primary);
      color: white;
      font-weight: 700;
      padding: 8px 14px; /* üî• TAMANHO REDUZIDO */
      font-size: 0.85rem; /* üî• TAMANHO REDUZIDO */
      border-bottom: 1px solid var(--border);
    }

    .contador-lojas {
      background: var(--primary);
      color: white;
      padding: 5px 10px; /* üî• TAMANHO REDUZIDO */
      border-radius: 15px;
      font-size: 0.85rem; /* üî• TAMANHO REDUZIDO */
      font-weight: 600;
    }

    /* üî• ESTILOS PARA CAMPOS OBRIGAT√ìRIOS */
    .form-label.obrigatorio::after {
      content: " *";
      color: var(--danger);
      font-weight: bold;
      margin-left: 2px;
    }

    .campo-obrigatorio {
      border-left: 3px solid var(--danger) !important;
      background-color: #fff5f5 !important;
    }

    .aviso-obrigatorio {
      color: var(--danger);
      font-size: 0.75rem; /* üî• TAMANHO REDUZIDO */
      font-weight: 600;
      margin-top: 4px;
      display: none;
    }

    /* üî•üî•üî• ADICIONE ESTE CSS AQUI - ESTILOS MELHORADOS PARA VALIDA√á√ÉO */
    .form-control.campo-obrigatorio,
    select.campo-obrigatorio {
      border: 2px solid var(--danger) !important;
      background-color: #fff5f5 !important;
      box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.1) !important;
      animation: pulse 0.5s ease-in-out;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

    /* Destaque para a se√ß√£o de fornecedores quando inv√°lida */
    .fornecedores-invalido {
      border: 2px solid var(--danger) !important;
      background: #fff5f5 !important;
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    /* üî• ESTILOS PARA BOT√ïES DE A√á√ÉO NA TABELA */
    .btn-editar {
      background: var(--primary);
      color: white;
      border: none;
      padding: 5px 10px; /* üî• TAMANHO REDUZIDO */
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.75rem; /* üî• TAMANHO REDUZIDO */
      transition: all 0.3s ease;
    }
    
    .btn-editar:hover {
      background: #6a2e82;
    }
    
    .btn-visualizar {
      background: var(--info);
      color: white;
      border: none;
      padding: 5px 8px; /* üî• TAMANHO REDUZIDO */
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.75rem; /* üî• TAMANHO REDUZIDO */
      transition: all 0.3s ease;
    }
    
    .btn-visualizar:hover {
      background: #138496;
    }

    /* üîÑ ESTILOS PARA O LOADING OVERLAY */
    #loadingOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .loading-content {
      background: white;
      padding: 30px; /* üî• TAMANHO REDUZIDO */
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);
      min-width: 250px; /* üî• TAMANHO REDUZIDO */
      border: 2px solid var(--primary);
    }

    .loading-spinner-large {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 50px; /* üî• TAMANHO REDUZIDO */
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    .loading-text {
      margin: 0;
      color: var(--dark);
      font-weight: bold;
      font-size: 16px; /* üî• TAMANHO REDUZIDO */
    }

    .loading-subtext {
      margin: 6px 0 0 0;
      color: var(--gray);
      font-size: 13px; /* üî• TAMANHO REDUZIDO */
    }

    /* üî•üî•üî• MODAL DE DETALHES - CORRIGIDO PARA FICAR IGUAL AO MODELO */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 25px; /* üî• TAMANHO REDUZIDO */
      max-width: 900px; /* üî• TAMANHO AUMENTADO - IGUAL AO MODELO */
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 15px 50px rgba(0,0,0,0.25);
      border: 3px solid var(--primary);
      position: relative;
    }

    .modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 0; /* üî• ALTERE PARA 0 */
  border-bottom: none; /* üî• REMOVA A BORDA */
}

    .modal-title {
      font-size: 1.4rem; /* üî• TAMANHO REDUZIDO */
      font-weight: 700;
      color: var(--primary);
      margin: 0;
    }

    .btn-close {
      background: none;
      border: none;
      font-size: 1.3rem; /* üî• TAMANHO REDUZIDO */
      cursor: pointer;
      color: var(--gray);
      padding: 4px;
      border-radius: 50%;
      width: 35px; /* üî• TAMANHO REDUZIDO */
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .btn-close:hover {
      background: var(--danger);
      color: white;
    }

    .detalhes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      margin-bottom: 15px;
    }

    .detalhe-item {
      margin-bottom: 10px;
    }

    .detalhe-label {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 4px;
      display: block;
      font-size: 0.9rem; /* üî• TAMANHO REDUZIDO */
    }

    .detalhe-valor {
  color: var(--dark);
  background: white; /* üî• FUNDO BRANCO */
  padding: 12px 15px;
  border-radius: 10px;
  border-left: 4px solid var(--primary);
  font-size: 1rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  border: 1px solid var(--border); /* üî• ADICIONE BORDA SUAVE */
}

    
/* üî•üî•üî• CORRE√á√ÉO DEFINITIVA - LARGURAS E ALINHAMENTO */
.data-table {
  table-layout: fixed;
  width: 100%;
}

/* üî• LARGURAS DAS COLUNAS - OTIMIZADAS E CENTRALIZADAS */
.data-table th:nth-child(1),
.data-table td:nth-child(1) {
  width: 18%; /* Raz√£o Social */
}

.data-table th:nth-child(2),
.data-table td:nth-child(2) {
  width: 12%; /* CNPJ */
}

.data-table th:nth-child(3),
.data-table td:nth-child(3) {
  width: 12%; /* Fornecedor */
}

.data-table th:nth-child(4),
.data-table td:nth-child(4) {
  width: 10%; /* Situa√ß√£o */
}

.data-table th:nth-child(5),
.data-table td:nth-child(5) {
  width: 14%; /* √öltimo Evento */
}

.data-table th:nth-child(6),
.data-table td:nth-child(6) {
  width: 8%; /* Defasagem */
}

.data-table th:nth-child(7),
.data-table td:nth-child(7) {
  width: 10%; /* Mensalidade */
}

.data-table th:nth-child(8),
.data-table td:nth-child(8) {
  width: 8%; /* Ades√£o */
}

.data-table th:nth-child(9),
.data-table td:nth-child(9) {
  width: 8%; /* A√ß√µes */
}

/* üî• CABE√áALHOS CENTRALIZADOS E COM NEGRITO */
.data-table th {
  background: var(--primary);
  color: white;
  padding: 12px 6px !important;
  text-align: center !important;
  font-weight: 700 !important;
  position: sticky;
  top: 0;
  white-space: nowrap;
  font-size: 0.85rem !important;
  letter-spacing: 0.5px;
  border-bottom: 2px solid rgba(255,255,255,0.2);
}

/* üî• EXCE√á√ÉO: Raz√£o Social alinhada √† esquerda */
.data-table th:nth-child(1) {
  text-align: left !important;
  padding-left: 12px !important;
}

/* üî• EXCE√á√ÉO: √öltimo Evento alinhado √† esquerda */
.data-table th:nth-child(5) {
  text-align: left !important;
  padding-left: 12px !important;
}

/* üî• ALINHAMENTO DAS C√âLULAS - CONSISTENTE */
.data-table td:nth-child(1) {
  text-align: left !important;
  vertical-align: top !important;
}

.data-table td:nth-child(2) {
  text-align: center !important;
  vertical-align: middle !important;
}

.data-table td:nth-child(3) {
  text-align: center !important;
  vertical-align: middle !important;
}

.data-table td:nth-child(4) {
  text-align: center !important;
  vertical-align: middle !important;
}

.data-table td:nth-child(5) {
  text-align: left !important;
  vertical-align: middle !important;
}

.data-table td:nth-child(6) {
  text-align: center !important;
  vertical-align: middle !important;
}

.data-table td:nth-child(7) {
  text-align: center !important;
  vertical-align: middle !important;
  font-weight: 600;
  color: var(--success) !important;
}

.data-table td:nth-child(8) {
  text-align: center !important;
  vertical-align: middle !important;
  font-weight: 600;
  color: var(--info) !important;
}

.data-table td:nth-child(9) {
  text-align: center !important;
  vertical-align: middle !important;
}

/* üî• MELHORAR VISUALIZA√á√ÉO DOS VALORES */
.data-table td:nth-child(7),
.data-table td:nth-child(8) {
  font-weight: 600;
  font-size: 0.75rem;
}

.data-table td:nth-child(7) {
  color: var(--success) !important; /* Verde para mensalidade */
}

.data-table td:nth-child(8) {
  color: var(--info) !important; /* Azul para ades√£o */
}

/* üî• CORRE√á√ÉO ESPEC√çFICA PARA O BOT√ÉO VISUALIZAR */
.btn-visualizar-compact {
  padding: 6px 10px !important; /* üî• TAMANHO REDUZIDO */
  font-size: 0.75rem !important; /* üî• TAMANHO REDUZIDO */
  min-width: 90px; /* üî• TAMANHO REDUZIDO */
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
}

/* üî• GARANTIR QUE TODAS AS C√âLULAS TENHAM MESMA ALTURA */
.data-table tbody tr {
}



/* üî• LARGURAS DAS COLUNAS */
.data-table th:nth-child(6),
.data-table td:nth-child(6) {
  width: 17%; /* A√ß√µes */
}





/* üî• ESTILOS MELHORADOS PARA O CAMPO DE EVENTO SEARCH - TAMANHO REDUZIDO */
#inputEventoSearch {
  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%237E3E9A" width="16" height="16"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>');
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 16px;
  padding-right: 35px;
  cursor: pointer;
  
  /* üî• TAMANHO REDUZIDO */
  font-size: 14px;
  padding: 12px 15px;
  height: auto;
  min-height: 45px;
}

/* üî• CORRE√á√ÉO DEFINITIVA - REMOVER SCROLL HORIZONTAL */
.suggestions-evento-search {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 2px solid var(--primary);
  border-top: none;
  border-radius: 0 0 8px 8px;
  z-index: 1000;
  max-height: 250px; /* üî• TAMANHO REDUZIDO */
  overflow-y: auto;
  overflow-x: hidden !important;
  box-shadow: 0 6px 20px rgba(0,0,0,0.12);
  
  white-space: normal !important;
  word-wrap: break-word !important;
  width: 100% !important;
}

/* üî• GARANTIR QUE OS ITENS QUEBREM LINHA SE PRECISAR */
.suggestion-evento-item-search {
  padding: 10px 14px; /* üî• TAMANHO REDUZIDO */
  cursor: pointer;
  border-bottom: 1px solid var(--border);
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  
  white-space: normal !important;
  word-wrap: break-word !important;
  overflow-wrap: break-word !important;
  line-height: 1.3;
}

.suggestion-evento-item-search:hover {
  background: var(--primary);
  color: white;
  transform: translateX(5px);
}

.suggestion-evento-item-search:last-child {
  border-bottom: none;
}

/* üî• SE√á√ïES TAMB√âM */
.suggestion-evento-section-search {
  background: var(--primary);
  color: white;
  font-weight: 700;
  padding: 8px 14px; /* üî• TAMANHO REDUZIDO */
  font-size: 0.85rem; /* üî• TAMANHO REDUZIDO */
  border-bottom: 1px solid rgba(255,255,255,0.2);
  position: sticky;
  top: 0;
  display: flex;
  align-items: center;
  gap: 6px;
  
  white-space: normal !important;
  word-wrap: break-word !important;
  line-height: 1.3;
}

/* üî• CORRE√á√ÉO ADICIONAL PARA O CONTAINER DO INPUT */
#eventoFormGroup {
  position: relative;
  width: 100%;
}

#eventoFormGroup .suggestions-evento {
  width: 100% !important;
  left: 0 !important;
  right: 0 !important;
}

/* üî• CORRE√á√ÉO DO LABEL DA OBSERVA√á√ÉO */
.form-group:has(#observacoes) .form-label {
  margin-left: 80px !important; /* üî• TAMANHO REDUZIDO */
  width: 85% !important;
}

/* üî• OBSERVA√á√ÉO MAIS PARA DIREITA */
#observacoes {
  margin-left: 40px !important; /* üî• TAMANHO REDUZIDO */
  width: 90% !important;
  min-height: 80px; /* üî• TAMANHO REDUZIDO */
}

/* üî• BOT√ïES MAIS PARA DIREITA */
.btn-group {
  display: flex;
  gap: 12px;
  margin-top: 20px;
  justify-content: flex-end !important;
  margin-left: auto;
  width: fit-content;
}

/* üî• OU SE PREFERIR ALINHAMENTO MAIS √Ä DIREITA */
.form-group:last-of-type {
  display: flex;
  justify-content: flex-end;
}

.form-group:last-of-type textarea {
  width: 95%;
  margin-left: auto;
}

  /* üî•üî•üî• CORRE√á√ÉO DEFINITIVA - ALINHAMENTO VERTICAL DA COLUNA A√á√ïES */
.data-table tbody tr {
    display: table-row;
    height: auto;
}

.data-table td {
    vertical-align: middle !important;
    padding: 12px 6px !important; /* üî• TAMANHO REDUZIDO */
    height: 100% !important;
    border-bottom: 1px solid var(--border);
}

/* üî•üî•üî• CORRE√á√ÉO URGENTE - BOT√ÉO NO MEIO DA C√âLULA */
.data-table td:nth-child(9) {
    height: 100% !important;
    min-height: 100% !important;
    vertical-align: middle !important;
    padding: 0 !important;
    display: table-cell !important;
}

.acoes-cell {
    height: 100% !important;
    min-height: 100% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 0 !important;
    margin: 0 !important;
}

/* üî• GARANTIR QUE O BOT√ÉO OCUPE TODA A ALTURA */
.btn-visualizar-compact {
    height: 100% !important;
    min-height: 35px !important; /* üî• TAMANHO REDUZIDO */
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 6px 10px !important; /* üî• TAMANHO REDUZIDO */
    margin: 0 !important;
    width: 100%;
    border-radius: 5px !important;
}

/* üî• CORRE√á√ÉO DA PRIMEIRA COLUNA (mant√©m alinhamento ao topo) */
.data-table td:nth-child(1) {
    vertical-align: top !important;
}

/* üî• CORRE√á√ÉO DAS OUTRAS COLUNAS (alinhamento no meio) */
.data-table td:nth-child(2),
.data-table td:nth-child(3),
.data-table td:nth-child(4),
.data-table td:nth-child(5),
.data-table td:nth-child(6),
.data-table td:nth-child(7),
.data-table td:nth-child(8),
.data-table td:nth-child(9) {
    vertical-align: middle !important;
}

/* üî•üî•üî• ESTILOS PARA WAITLABELS - TAMANHO REDUZIDO */
.waitlabel-selector {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  padding: 15px;
  border-radius: 10px;
  border: 2px solid var(--border);
  margin-bottom: 20px;
}

.waitlabel-title {
  font-size: 1.1rem; /* üî• TAMANHO REDUZIDO */
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.waitlabel-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.waitlabel-btn {
  padding: 10px 16px; /* üî• TAMANHO REDUZIDO */
  border: 2px solid var(--border);
  border-radius: 6px;
  background: white;
  color: var(--dark);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 6px;
  min-width: 120px; /* üî• TAMANHO REDUZIDO */
  justify-content: center;
  font-size: 0.9rem; /* üî• TAMANHO REDUZIDO */
}

.waitlabel-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 3px 8px rgba(0,0,0,0.08);
}

.waitlabel-btn.active {
  transform: translateY(-2px);
  box-shadow: 0 3px 10px rgba(0,0,0,0.15);
  border-width: 2px;
}

.waitlabel-indicator {
  display: inline-block;
  width: 10px; /* üî• TAMANHO REDUZIDO */
  height: 10px;
  border-radius: 50%;
  margin-right: 4px;
}



.btn-aplicar-todos:hover {
  background: linear-gradient(135deg, #E55A2B 0%, #E57C2B 100%) !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 3px 10px rgba(255, 107, 53, 0.25) !important;
}

/* üî• ESTILOS PARA CHECKBOXES APLICAR A TODOS */
.checkbox-aplicar-todos {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 6px;
  padding: 6px 10px; /* üî• TAMANHO REDUZIDO */
  background: #fff8f0;
  border-radius: 5px;
  border-left: 2px solid #FF6B35;
}

.checkbox-aplicar-todos input[type="checkbox"] {
  width: 16px; /* üî• TAMANHO REDUZIDO */
  height: 16px;
  accent-color: #FF6B35;
}

.checkbox-aplicar-todos label {
  font-size: 0.8rem; /* üî• TAMANHO REDUZIDO */
  color: #FF6B35;
  font-weight: 600;
  cursor: pointer;
}

/* üî• MODO APLICAR A TODOS ATIVO */
.modo-aplicar-todos .form-group {
  border: 2px solid #fff8f0;
  border-radius: 6px;
  padding: 12px;
  background: #fffdfa;
}

.modo-aplicar-todos .card-header {
  background: linear-gradient(135deg, #fff8f0 0%, #fff0e0 100%);
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 15px;
}

/* üî•üî•üî• NOVOS ESTILOS PARA MODAL MELHORADO */
.modal-content {
  background: white;
  border-radius: 15px;
  padding: 30px;
  max-width: 950px;
  width: 95%;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  border: 4px solid var(--primary);
  position: relative;
  backdrop-filter: blur(10px);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  padding-bottom: 15px;
  border-bottom: 3px solid var(--primary);
}

.modal-title {
  font-size: 1.6rem;
  font-weight: 700;
  color: var(--primary);
  margin: 0;
}

.btn-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--gray);
  padding: 5px;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.btn-close:hover {
  background: var(--danger);
  color: white;
}

.detalhes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 25px;
}

.detalhe-item {
  margin-bottom: 15px;
}

.detalhe-label {
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 8px;
  display: block;
  font-size: 1rem;
  border-bottom: 2px solid var(--border);
  padding-bottom: 4px;
}

.detalhe-valor {
  color: var(--dark);
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  padding: 12px 15px;
  border-radius: 10px;
  border-left: 4px solid var(--primary);
  font-size: 1rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* üî• ESTILOS PARA LOJAS AGRUPADAS NO MODAL */
.loja-item {
  border: 3px solid;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 15px;
  background: white;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.loja-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: currentColor;
  opacity: 0.3;
}

.loja-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* üî• BOT√ÉO EDITAR NO MODAL */
.btn-editar-modal {
  background: linear-gradient(135deg, var(--warning) 0%, #ffb347 100%);
  color: var(--dark);
  border: none;
  padding: 12px 25px;
  border-radius: 8px;
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.btn-editar-modal:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
  background: linear-gradient(135deg, #ffc107 0%, #ffb347 100%);
}
  
    @media (max-width: 768px) {
      .content {
        padding: 15px;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .btn-group {
        flex-direction: column;
      }

        h1 {
        font-size: 1.8rem; /* üî• TAMANHO REDUZIDO */
      }
      
      .logo {
        width: 60px; /* üî• TAMANHO REDUZIDO */
        height: 60px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .cadastros-grid {
        grid-template-columns: 1fr;
      }
      
      .card-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .filtros-container {
        margin-top: 12px;
      }
      
      .data-table {
        font-size: 0.75rem; /* üî• TAMANHO REDUZIDO */
      }
      
      .acoes-cell {
        flex-direction: column;
      }
      
      .waitlabel-buttons {
        flex-direction: column;
      }
      
      .waitlabel-btn {
        min-width: 100%;
      }

      /* üî• MODAL RESPONSIVO */
      .modal-content {
        padding: 20px;
        margin: 10px;
        max-width: 95%;
      }
      
      .modal-title {
        font-size: 1.2rem;
      }

      .detalhes-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      /* üî• GARANTIR QUE O CONTAINER DA DEFASAGEM FIQUE CENTRALIZADO */
.defasagem-container {
  display: flex !important;
  justify-content: center !important;
  align-items: center !important;
  height: 100% !important;
}

  }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo-container">
        <img src="https://i.ibb.co/B2r5xtbS/sim-cred-5.png" class="logo" alt="SIM CRED">
        <div class="header-content">
          <h1>Sistema de Cadastros de Lojas</h1>
          <div class="subtitle">Situa√ß√£o e Acompanhamento de Lojas</div>
          <div class="version">
            <i class="fas fa-rocket"></i>
            Vers√£o 2.0
          </div>
        </div>
      </div>
    </div>
    
    <div class="content">
      <!-- üî•üî•üî• SE√á√ÉO WAITLABELS - ADICIONADA AQUI -->
      <div class="waitlabel-selector">
        <div class="waitlabel-title">
          <i class="fas fa-layer-group"></i>
          Selecione o White Label:
        </div>
        <div class="waitlabel-buttons" id="waitlabelButtons">
          <!-- Os bot√µes ser√£o preenchidos via JavaScript -->
        </div>
      </div>

      <!-- BOT√ïES DE A√á√ÉO SIMPLIFICADOS -->
      <div class="action-buttons">
        <button type="button" class="btn btn-primary" onclick="mostrarTodosCadastros()">
          <i class="fas fa-store"></i>
          Ver Todos os Cadastros
        </button>
        <button type="button" class="btn btn-info" onclick="limparBusca()">
          <i class="fas fa-broom"></i>
          Limpar Busca
        </button>
      </div>

      <!-- CARD DADOS DO CADASTRO -->
      <div class="card" id="cardCadastro">
        <div class="card-header">
          <i class="fas fa-info-circle"></i>
          <h2 class="card-title">Dados do Cadastro</h2>
          <!-- üî• LOCAL PARA T√çTULO DO MODO APLICAR A TODOS -->
          <div id="tituloAplicarTodos" style="display: none;"></div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-building"></i>
              Raz√£o Social
            </label>
            <input type="text" id="razao_social" class="form-control">
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-signature"></i>
              Nome Fantasia
            </label>
            <input type="text" id="nome_fantasia" class="form-control">
          </div>
          
          <!-- üî• CAMPO CNPJ ADICIONADO AQUI -->
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-id-card"></i>
              CNPJ
            </label>
            <input type="text" id="cnpj_cadastro" class="form-control" 
                   placeholder="Digite o CNPJ para cadastro..."
                   oninput="formatarCNPJ(this)">
          </div>
          
          
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-file-contract"></i>
              Contrato Enviado
            </label>
            <select id="contrato_enviado" class="form-control">
              <option value="">-- Selecione --</option>
              <option value="SIM">SIM</option>
              <option value="NAO">NAO</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-file-signature"></i>
              Contrato Assinado
            </label>
            <select id="contrato_assinado" class="form-control">
              <option value="">-- Selecione --</option>
              <option value="SIM">SIM</option>
              <option value="NAO">NAO</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-play-circle"></i>
              Ativa√ß√£o
            </label>
            <input type="date" id="ativacao" class="form-control">
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-link"></i>
              Link
            </label>
            <input type="text" id="link" class="form-control" placeholder="https://...">
          </div>
          
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-money-bill-wave"></i>
              Mensalidade
            </label>
            <input type="text" id="mensalidade" class="form-control" placeholder="R$ 0,00" oninput="formatarMoeda(this)">
          </div>

          <!-- üî• ADICIONE ESTE CAMPO AQUI - DEPOIS DO CAMPO MENSALIDADE -->
           <!-- ‚úÖ CORRETO - DEIXE ASSIM SIMPLES -->
            <div class="form-group">
  <label class="form-label" style="color: var(--primary); font-weight: 700;">
    <i class="fas fa-money-bill-wave" style="color: var(--primary);"></i>
    Mensalidade SIM
  </label>
  <input type="text" id="mensalidade_sim" name="mensalidade_sim" class="form-control" placeholder="R$ 0,00" oninput="formatarMoeda(this)">
</div>

          <!-- üî• CAMPO ADES√ÉO -->
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-handshake"></i>
              Ades√£o
            </label>
            <input type="text" id="adesao" class="form-control" placeholder="R$ 0,00" oninput="formatarMoeda(this)" value="R$ 0,00">
            <small style="color: var(--gray); font-size: 0.75rem;">
              <i class="fas fa-info-circle"></i> Valor "0,00" ser√° salvo como "Isento"
            </small>
          </div>
          
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-flag"></i>
              Situa√ß√£o
            </label>
            <select id="situacao" class="form-control">
              <option value="NOVO REGISTRO">NOVO REGISTRO</option>
              <option value="CADASTRADO">CADASTRADO</option>
              <option value="EM ANDAMENTO">EM ANDAMENTO</option>
              <option value="REJEITADO">REJEITADO</option>
              <option value="DESCREDENCIADO">DESCREDENCIADO</option>
              <option value="DESISTIU">DESISTIU</option>
            </select>
          </div>

          <!-- üî• FORNECEDORES COM TARIFAS INDIVIDUAIS -->
          <div class="form-group" style="grid-column: 1 / -1;">
            <label class="form-label">
              <i class="fas fa-truck"></i>
              Fornecedor(es) - <span style="color: var(--primary); font-weight: 600;">Selecione e configure cada um</span>
            </label>
            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 15px; border-radius: 10px; border: 2px dashed var(--primary);">
              
              <!-- FORNECEDOR Agil -->
              <div class="fornecedor-item" style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                  <input type="checkbox" name="fornecedor" value="Agil" style="width: 18px; height: 18px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'agil')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1rem;">AGIL</span>
                </div>
                <div id="config-agil" style="display: none; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 6px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 12px;">
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <input type="radio" name="tarifa_agil" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <input type="radio" name="tarifa_agil" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 6px; display: block;">Valor da Tarifa</label>
                    <input type="text" 
                      name="percentual_agil" 
                      style="width: 100%; padding: 6px 10px; border: 2px solid var(--border); border-radius: 5px;"
                      placeholder="Digite o % (ex: 3,2%)"
                      oninput="formatarPercentual(this)">
                  </div>
                </div>
              </div>

              <!-- FORNECEDOR BC -->
              <div class="fornecedor-item" style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                  <input type="checkbox" name="fornecedor" value="BC" style="width: 18px; height: 18px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'bc')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1rem;">BC</span>
                </div>
                <div id="config-bc" style="display: none; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 6px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 12px;">
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <input type="radio" name="tarifa_bc" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <input type="radio" name="tarifa_bc" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 6px; display: block;">Valor da Tarifa</label>
                    <input type="text" 
                      name="percentual_bc" 
                      style="width: 100%; padding: 6px 10px; border: 2px solid var(--border); border-radius: 5px;"
                      placeholder="Digite o % (ex: 3,2%)"
                      oninput="formatarPercentual(this)">
                  </div>
                </div>
              </div>

              <!-- FORNECEDOR PARCELEX -->
              <div class="fornecedor-item" style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                  <input type="checkbox" name="fornecedor" value="Parcelex" style="width: 18px; height: 18px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'parcelex')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1rem;">PARCELEX</span>
                </div>
                <div id="config-parcelex" style="display: none; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 6px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 12px;">
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <input type="radio" name="tarifa_parcelex" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <input type="radio" name="tarifa_parcelex" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 6px; display: block;">Valor da Tarifa</label>
                    <input type="text" 
                      name="percentual_parcelex" 
                      style="width: 100%; padding: 6px 10px; border: 2px solid var(--border); border-radius: 5px;"
                      placeholder="Digite o % (ex: 3,2%)"
                      oninput="formatarPercentual(this)">
                  </div>
                </div>
              </div>

              <!-- FORNECEDOR AGORACRED -->
              <div class="fornecedor-item" style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                  <input type="checkbox" name="fornecedor" value="Agoracred" style="width: 18px; height: 18px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'agoracred')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1rem;">AGORACRED</span>
                </div>
                <div id="config-agoracred" style="display: none; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 6px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 12px;">
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <input type="radio" name="tarifa_agoracred" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <input type="radio" name="tarifa_agoracred" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 6px; display: block;">Valor da Tarifa</label>
                    <input type="text" 
                      name="percentual_agoracred" 
                      style="width: 100%; padding: 6px 10px; border: 2px solid var(--border); border-radius: 5px;"
                      placeholder="Digite o % (ex: 3,2%)"
                      oninput="formatarPercentual(this)">
                  </div>
                </div>
              </div>

              <!-- FORNECEDOR AFINZ -->
              <div class="fornecedor-item" style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                  <input type="checkbox" name="fornecedor" value="Afinz" style="width: 18px; height: 18px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'afinz')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1rem;">AFINZ</span>
                </div>
                <div id="config-afinz" style="display: none; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 6px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 12px;">
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <input type="radio" name="tarifa_afinz" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <input type="radio" name="tarifa_afinz" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 6px; display: block;">Valor da Tarifa</label>
                    <input type="text" 
                      name="percentual_afinz" 
                      style="width: 100%; padding: 6px 10px; border: 2px solid var(--border); border-radius: 5px;"
                      placeholder="Digite o % (ex: 3,2%)"
                      oninput="formatarPercentual(this)">
                  </div>
                </div>
              </div>

            </div>
          </div>

                    <!-- üî• MANTENHA EXATAMENTE ASSIM - S√ì ADICIONE UM ID NO FORM-GROUP -->
          <div class="form-group" id="eventoFormGroup">
            <label class="form-label">
              <i class="fas fa-calendar-check"></i>
              Evento
            </label>
            
            <!-- üî• MANTENHA O SELECT ORIGINAL, MAS VAMOS ESCONDER ELE -->
            <select id="evento" class="form-control" style="display: none;">
              <option value="">-- Selecione um evento --</option>
            </select>
            
            <!-- üî• TAMANHO REDUZIDO NO INPUT -->
            <div style="position: relative; width: 100%;">
              <input type="text" 
                     id="inputEventoSearch" 
                     class="form-control" 
                     placeholder="Digite para buscar evento..."
                     oninput="filtrarSugestoesEventoSearch()"
                     style="padding-right: 35px; width: 100%; min-width: 350px;">
              
              <div class="suggestions-evento" id="suggestionsEventoSearch" style="display: none;">
              </div>
            </div>

            <!-- ‚úÖ ‚úÖ ‚úÖ CORRE√á√ÉO DO CHECKBOX - MUDAR data-campo para "inputEventoSearch" -->
            <div class="checkbox-aplicar-todos">
              <input type="checkbox" id="check_eventos" data-campo="inputEventoSearch" onchange="toggleCampoParaTodos('inputEventoSearch')">
              <label for="check_eventos">
                  <i class="fas fa-copy"></i> Aplicar Evento a todos
              </label>
            </div>
          </div> <!-- ‚Üê ESTE </div> FECHA TUDO -->

          

 
<!-- OBSERVA√á√ÉO ALINHADA √Ä DIREITA -->
<div class="form-group" style="display: flex; justify-content: flex-end;">
  <div style="width: 95%;">
    <label class="form-label">
      <i class="fas fa-sticky-note"></i>
      Observa√ß√£o
    </label>
    <textarea id="observacoes" class="form-control" rows="3" style="width: 100%;"></textarea>
    <!-- üî• REMOVIDO O CHECKBOX DA OBSERVA√á√ÉO -->
  </div>
</div>

          <!-- BOT√ïES ALINHADOS √Ä DIREITA -->
          <div class="btn-group" style="justify-content: flex-end; margin-left: auto; width: fit-content;">
            <button type="button" class="btn btn-success" onclick="cadastrar()" id="btnCadastrar">
              <i class="fas fa-plus-circle"></i>
              Cadastrar
            </button>
            <button type="button" class="btn btn-warning" onclick="atualizar()" id="btnAtualizar" style="display: none;">
              <i class="fas fa-save"></i>
              Atualizar
            </button>

            <!-- üî• BOT√ÉO APLICAR A TODOS (APARECE QUANDO CONFIGURADO) -->
            <button type="button" class="btn btn-aplicar-todos" id="btnAplicarATodos" onclick="aplicarAlteracoesATodos()" style="display: none;">
              <i class="fas fa-copy"></i>
              Aplicar a Todos
            </button>
          </div>
        </div>
      </div>

      <!-- üî•üî•üî• SE√á√ÉO: TODOS OS CADASTROS - ATUALIZADA SEGUINDO O MODELO -->
      <div class="cadastros-container" id="secaoCadastros" style="display: none;">
        <div class="card-header">
          <i class="fas fa-store"></i>
          <h2 class="card-title" id="tituloCadastros">Todos os Cadastros</h2>
          <span class="contador-lojas" id="contadorCadastros">0 cadastros</span>
        </div>

        <!-- BARRA DE PESQUISA PRINCIPAL -->
        <div class="search-container">
          <input type="text" id="pesquisaCadastros" class="form-control" 
                 placeholder="üîç Pesquisar por nome, CNPJ, fornecedor, evento..."
                 oninput="filtrarPesquisa()">
        </div>

        <!-- üî•üî•üî• FILTROS R√ÅPIDOS POR SITUA√á√ÉO - NOVO ESTILO SEGUINDO O MODELO -->
        <div class="filtros-container" id="filtrosContainer" style="display: none;">
          <button type="button" class="filtro-btn active" data-situacao="all" onclick="aplicarFiltroSituacao('all')">
            Todos
          </button>
          <button type="button" class="filtro-btn" data-situacao="NOVO REGISTRO" onclick="aplicarFiltroSituacao('NOVO REGISTRO')">
            Novos
          </button>
          <button type="button" class="filtro-btn" data-situacao="CADASTRADO" onclick="aplicarFiltroSituacao('CADASTRADO')">
            Cadastrados
          </button>
          <button type="button" class="filtro-btn" data-situacao="EM ANDAMENTO" onclick="aplicarFiltroSituacao('EM ANDAMENTO')">
            Em Andamento
          </button>
          <button type="button" class="filtro-btn" data-situacao="REJEITADO" onclick="aplicarFiltroSituacao('REJEITADO')">
            Rejeitado
          </button>
          <button type="button" class="filtro-btn" data-situacao="DESCREDENCIADO" onclick="aplicarFiltroSituacao('DESCREDENCIADO')">
            Descredenciados
          </button>
          <button type="button" class="filtro-btn" data-situacao="DESISTIU" onclick="aplicarFiltroSituacao('DESISTIU')">
            Desistiu
          </button>
          
          <!-- BOT√ÉO ATUALIZAR -->
          <button type="button" class="btn btn-info btn-sm" onclick="recarregarCadastros()" style="margin-left: auto;">
            <i class="fas fa-sync-alt"></i> Atualizar
          </button>
        </div>

        <!-- üî•üî•üî• FILTROS AVAN√áADOS - SEGUINDO O MODELO -->
        <div class="filtros-avancados" id="filtrosAvancadosContainer" style="display: none;">
          <!-- FILTRO DE EVENTOS COM TAGS -->
          <div class="filtro-group">
            <label class="filtro-label">üìÖ Filtrar por Evento:</label>
            <div class="filtro-multiselect-container">
              <input type="text" id="filtroEvento" class="form-control" 
                     placeholder="Digite para buscar eventos..." 
                     oninput="filtrarSugestoesEvento()"
                     onfocus="mostrarSugestoesEvento()">
              <div class="suggestions" id="suggestionsEvento"></div>
              <div class="tags-selecionadas" id="eventosSelecionados"></div>
            </div>
          </div>
          
          <!-- FILTRO DE FORNECEDORES COM TAGS -->
          <div class="filtro-group">
            <label class="filtro-label">üöö Filtrar por Fornecedor:</label>
            <div class="filtro-multiselect-container">
              <input type="text" id="filtroFornecedor" class="form-control" 
                     placeholder="Digite para buscar fornecedores..." 
                     oninput="filtrarSugestoesFornecedor()"
                     onfocus="mostrarSugestoesFornecedor()">
              <div class="suggestions" id="suggestionsFornecedor"></div>
              <div class="tags-selecionadas" id="fornecedoresSelecionados"></div>
            </div>
          </div>
          
          <div class="filtro-group">
            <label class="filtro-label">üìä Ordenar por:</label>
            <select id="ordenacaoCadastros" class="form-select" onchange="ordenarCadastros()">
  <option value="razao_social">Raz√£o Social (A-Z)</option>
  <option value="razao_social_desc">Raz√£o Social (Z-A)</option>
  <option value="nome_fantasia">Nome Fantasia (A-Z)</option>
  <option value="nome_fantasia_desc">Nome Fantasia (Z-A)</option>
  <option value="situacao">Situa√ß√£o</option>
  <option value="fornecedor">Fornecedor</option>
  
  <!-- üî• NOVAS OP√á√ïES DE ORDENA√á√ÉO POR VALORES -->
  <option value="mensalidade">Mensalidade (Maior)</option>
  <option value="mensalidade_asc">Mensalidade (Menor)</option>
  <option value="adesao">Ades√£o (Maior)</option>
  <option value="adesao_asc">Ades√£o (Menor)</option>
  
  <option value="defasagem">Defasagem (Maior)</option>
  <option value="defasagem_asc">Defasagem (Menor)</option>
</select>
          </div>

          <div class="filtro-group">
            <label class="filtro-label">üßπ Limpar Filtros:</label>
            <button type="button" class="btn btn-outline btn-sm" onclick="limparTodosFiltros()" style="margin-top: 6px;">
              <i class="fas fa-broom"></i> Limpar Tudo
            </button>
          </div>
        </div>

        <!-- TAGS DE FILTROS ATIVOS -->
        <div class="filtros-ativos" id="filtrosAtivosContainer" style="display: none;"></div>

        <!-- LOADING -->
        <div class="loading-container" id="loadingCadastros" style="display: none;">
          <div class="loading-spinner"></div>
          <p>Carregando cadastros...</p>
        </div>
        
        <!-- üî•üî•üî• TABELA MAIOR COM MAIS INFORMA√á√ïES - SEGUINDO O MODELO -->
        <div class="table-container" id="tableContainer" style="display: none;">
          <div class="table-responsive">
            <table class="data-table" id="tabelaCadastros">
              <thead>
                <tr>
                  <th width="18%">Raz√£o Social</th>
                  <th width="12%">CNPJ</th>
                  <th width="12%">Fornecedor</th>
                  <th width="10%">Situa√ß√£o</th>
                  <th width="14%">√öltimo Evento</th>
                  <th width="8%">Defasagem</th>
                  <th width="10%">Mensalidade</th>
                  <th width="8%">Ades√£o</th>
                  <th width="8%">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tabelaCadastrosBody">
                <!-- Dados ser√£o preenchidos via JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- MENSAGENS DO SISTEMA -->
      <div id="messageSuccess" class="message success" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <span></span>
      </div>
      
      <div id="messageError" class="message error" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span></span>
      </div>

      <div id="messageInfo" class="message info" style="display: none;">
        <i class="fas fa-info-circle"></i>
        <span></span>
      </div>
    </div>
  </div>

  <!-- üîÑ OVERLAY DE CARREGAMENTO -->
  <div id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner-large"></div>
      <p class="loading-text">Salvando dados...</p>
      <p class="loading-subtext">Aguarde um momento</p>
    </div>
  </div>

  <!-- üî•üî•üî• MODAL DE DETALHES - CORRIGIDO PARA FICAR IGUAL AO MODELO -->
  <div id="modalDetalhes" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">üìã Detalhes do Cadastro</h3>
        <button class="btn-close" onclick="fecharModalDetalhes()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div id="modalDetalhesContent">
        <!-- Conte√∫do ser√° preenchido via JavaScript -->
      </div>

      <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
        <!-- üî•üî•üî• BOT√ÉO EDITAR ADICIONADO DENTRO DO MODAL -->
        <button class="btn-editar-modal" onclick="editarCadastroDoModal()" style="margin-right: 10px;">
          <i class="fas fa-edit"></i> Editar Cadastro
        </button>
        <button class="btn btn-primary" onclick="fecharModalDetalhes()">
          <i class="fas fa-check"></i> Fechar
        </button>
      </div>
    </div>
  </div>

  <!-- üî• MODAL 1: VISUALIZAR TODOS OS FORNECEDORES - NOVO MODAL -->
  <div id="modalFornecedores" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">üè™ Todos os Fornecedores</h3>
        <button class="btn-close" onclick="fecharModalFornecedores()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div id="modalFornecedoresContent">
        <!-- Conte√∫do ser√° preenchido via JavaScript -->
      </div>

      <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
        <button class="btn btn-primary" onclick="fecharModalFornecedores()">
          <i class="fas fa-check"></i> Fechar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Senha - VERS√ÉO CORRIGIDA -->
  <div id="modalSenha" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">üîí Acesso Restrito</h3>
        <button class="btn-close" onclick="fecharModalSenha()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div style="padding: 15px;">
        <p>Para editar este campo √© necess√°rio informar a senha:</p>
        <input type="password" id="inputSenha" class="form-control" placeholder="Digite a senha" style="margin: 12px 0;">
        <div class="btn-group">
          <button class="btn btn-primary" onclick="validarSenha()">
            <i class="fas fa-check"></i> Validar
          </button>
          <button class="btn btn-outline" onclick="fecharModalSenha()">
            <i class="fas fa-times"></i> Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
// üî• VARI√ÅVEIS GLOBAIS

// üî• FUN√á√ÉO DE DELAY PARA EVITAR ERRO 429 (ADICIONAR ESTA FUN√á√ÉO)
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// üî• VARI√ÅVEIS PARA "APLICAR A TODOS"
let camposParaAplicarATodos = {};
let cnpjAtualParaAplicar = null;
let cadastroAtualId = null;
let todosCadastros = [];
let cadastrosFiltrados = [];
let campoEditavel = null;
const SENHA_PERMITIDA = '519901';
let waitlabelAtual = 'Sim_Facilita'; // üî• VARI√ÅVEL PARA WAITLABEL ATUAL

// üî•üî•üî• NOVAS VARI√ÅVEIS PARA FILTROS - SEGUINDO O MODELO
let filtrosAtivos = {};
let situacaoAtiva = 'all';
let eventosSelecionados = [];
let fornecedoresSelecionados = [];

// üî• VARI√ÅVEL PARA ARMAZENAR O ID DO CADASTRO ATUAL NO MODAL
let cadastroAtualModalId = null;

// üî• CONFIGURA√á√ÉO DOS WAITLABELS
const WAITLABELS_CONFIG = {
  WAITLABELS: ['Sim_Facilita', 'Result', 'Set_9', 'Doktorbank', 'Dr_Parcela'],
  CORES: {
    'Sim_Facilita': '#7E3E9A',
    'Result': '#2EBE76', 
    'Set_9': '#0682c5',
    'Doktorbank': '#E61B72',
    'Dr_Parcela': '#696969'
  }
};

// üî• VARI√ÅVEIS DOS EVENTOS PARA FILTRO - CONVERTIDAS PARA MAI√öSCULAS
const eventosNovoRegistro = [
  "NOVO CADASTRO", "PRIMEIRO CONTATO", "CLIENTE INTERESSADO", "SOLICITOU MAIS INFORMACOES",
  "AGENDAMENTO DE DEMONSTRACAO", "PROPOSTA ENVIADA", "AGUARDANDO RETORNO"
].sort();

const eventosCadastrado = [
  "LOJA CADASTRADA", "DOCUMENTACAO RECEBIDA", "CONTRATO ENVIADO", "AGUARDANDO ASSINATURA",
  "CADASTRO APROVADO", "AGUARDANDO ATIVACAO"
].sort();

const eventosEmAndamento = [
  "AGUARDANDO ACEITE DA LOJA", "AGUARDANDO ACEITE DO FORNECEDOR", "AGUARDANDO DOCUMENTOS",
  "AGUARDANDO RETORNO", "AGENDAMENTO DE DEMONSTRACAO", "CLIENTE INTERESSADO", 
  "CLIENTE NAO INTERESSADO", "CONDICAO ESPECIAL", "CONTRATO ASSINADO", "DESISTIU",
  "DOCUMENTACAO INCOMPLETA", "EM IMPLANTACAO", "EM TREINAMENTO", "ENVIO DE BOLETO",
  "ENVIO DE WHATSAPP", "FOLLOW-UP NECESSARIO", "FORNECEDOR ALTERADO", "LIGACAO REALIZADA",
  "NEGOCIACAO EM ANDAMENTO", "PAGAMENTO EFETUADO", "PAGAMENTO PENDENTE", "PROPOSTA ENVIADA",
  "QUANTIDADE DE LOJAS ALTERADA", "RECADO REGISTRADO", "REUNIAO AGENDADA", "SEM RETORNO",
  "SOLICITOU MAIS INFORMACOES", "TELEFONE ALTERADO"
].sort();

const eventosRejeitado = [
  "REJEITADO", "BLOQUEADO", "DESISTIU", "CLIENTE NAO INTERESSADO", "SEM RETORNO",
  "NEGOCIACAO PARADA", "PROCESSO ESTAGNADO"
].sort();

const eventosDescredenciado = [
  "DESCREDENCIADO", "CONTRATO CANCELADO", "LOJA DESATIVADA", "FORNECEDOR REMOVIDO",
  "PROCESSO ENCERRADO", "CADASTRO EXPIRADO"
].sort();

// üî• NOVOS EVENTOS PARA SITUA√á√ÉO "DESISTIU"
const eventosDesistiu = [
  "DESISTIU", "CLIENTE DESISTIU", "DESIST√äNCIA DO CLIENTE", "DESIST√äNCIA VOLUNT√ÅRIA",
  "DESISTIU DO PROCESSO", "DESISTIU DA NEGOCIA√á√ÉO", "DESISTIU DO CADASTRO",
  "N√ÉO QUIS CONTINUAR", "DESINTERESSE DO CLIENTE", "ABANDONOU O PROCESSO"
].sort();

// üî•üî•üî• EVENTOS DISPON√çVEIS PARA FILTRO - SEGUINDO O MODELO
const eventosDisponiveis = [
  ...eventosNovoRegistro,
  ...eventosCadastrado,
  ...eventosEmAndamento,
  ...eventosRejeitado,
  ...eventosDescredenciado,
  ...eventosDesistiu
].sort();

// üî•üî•üî• FORNECEDORES DISPON√çVEIS PARA FILTRO - SEGUINDO O MODELO
const fornecedoresDisponiveis = [
  "AGIL", "BC", "PARCELEX", "AGORACRED", "AFINZ"
].sort();

// ‚úÖ VERIFICAR SE USU√ÅRIO J√Å EST√Å AUTORIZADO AO CARREGAR A P√ÅGINA
document.addEventListener('DOMContentLoaded', function() {
  console.log('Sistema de Gest√£o de Cadastros - RESULT inicializado');
  
  // üî• INICIALIZAR WAITLABELS
  inicializarWaitlabels();
  
  // Inicializar valores padr√£o
  document.getElementById('mensalidade').value = 'R$ 0,00';
  document.getElementById('situacao').value = 'CADASTRADO';
  
  // Configura√ß√µes iniciais
  configurarValidacaoEmTempoReal();
  document.getElementById('situacao').addEventListener('change', atualizarEventos);
  atualizarEventos();
  
  // üî• CORRE√á√ÉO: Configurar prote√ß√£o AP√ìS o DOM estar carregado
  setTimeout(() => {
    configurarCamposProtegidos();
  }, 500);
  
  // Configurar eventos do modal de senha
  configurarModalSenha();
  
  // üî•üî•üî• NOVA LINHA: Sincronizar campos de evento
  sincronizarCamposEvento();
  
  // üî•üî•üî• CONFIGURAR EVENTOS DOS FILTROS - SEGUINDO O MODELO
  configurarEventosFiltro();
  
  // üî•üî•üî• CORRE√á√ÉO: Configurar evento do campo de evento
  const inputEvento = document.getElementById('inputEventoSearch');
  if (inputEvento) {
    inputEvento.addEventListener('focus', function() {
      console.log("üéØ Campo de evento recebeu foco - mostrando sugest√µes");
      filtrarSugestoesEventoSearch();
    });
  }
});

// üî•üî•üî• CONFIGURAR EVENTOS DOS FILTROS - SEGUINDO O MODELO
function configurarEventosFiltro() {
  const inputEvento = document.getElementById('filtroEvento');
  const inputFornecedor = document.getElementById('filtroFornecedor');
  
  // Fechar sugest√µes ao clicar fora
  document.addEventListener('click', function(e) {
    const suggestionsEvento = document.getElementById('suggestionsEvento');
    const suggestionsFornecedor = document.getElementById('suggestionsFornecedor');
    
    if (suggestionsEvento && !inputEvento.contains(e.target) && !suggestionsEvento.contains(e.target)) {
      suggestionsEvento.style.display = 'none';
    }
    
    if (suggestionsFornecedor && !inputFornecedor.contains(e.target) && !suggestionsFornecedor.contains(e.target)) {
      suggestionsFornecedor.style.display = 'none';
    }
  });
  
  // Fechar sugest√µes com ESC
  inputEvento.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.getElementById('suggestionsEvento').style.display = 'none';
    }
    if (e.key === 'Enter') {
      e.preventDefault();
      const texto = inputEvento.value.trim();
      if (texto && !eventosSelecionados.includes(texto.toUpperCase())) {
        adicionarEvento(texto.toUpperCase());
      }
      inputEvento.value = '';
      document.getElementById('suggestionsEvento').style.display = 'none';
    }
  });
  
  inputFornecedor.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.getElementById('suggestionsFornecedor').style.display = 'none';
    }
    if (e.key === 'Enter') {
      e.preventDefault();
      const texto = inputFornecedor.value.trim();
      if (texto && !fornecedoresSelecionados.includes(texto.toUpperCase())) {
        adicionarFornecedor(texto.toUpperCase());
      }
      inputFornecedor.value = '';
      document.getElementById('suggestionsFornecedor').style.display = 'none';
    }
  });
}

// üî•üî•üî• FUN√á√ïES DO FILTRO DE EVENTOS - SEGUINDO O MODELO
function mostrarSugestoesEvento() {
  const input = document.getElementById('filtroEvento');
  if (input.value.trim().length > 0) {
    filtrarSugestoesEvento();
  }
}

function filtrarSugestoesEvento() {
  const input = document.getElementById('filtroEvento');
  const suggestions = document.getElementById('suggestionsEvento');
  const termo = input.value.toLowerCase().trim();
  
  if (termo.length < 1) {
    suggestions.style.display = 'none';
    return;
  }
  
  // üî• CORRE√á√ÉO: Usar Set para remover duplicatas
  const eventosUnicos = [...new Set(eventosDisponiveis)];
  const eventosFiltrados = eventosUnicos.filter(evento => 
    evento.toLowerCase().includes(termo) && !eventosSelecionados.includes(evento)
  );
  
  if (eventosFiltrados.length === 0) {
    suggestions.innerHTML = `
      <div class="suggestion-item" style="color: var(--gray);">
        <i class="fas fa-search"></i> Nenhum evento encontrado
      </div>
    `;
  } else {
    let html = eventosFiltrados.map(evento => `
      <div class="suggestion-item" onclick="adicionarEvento('${evento.replace(/'/g, "\\'")}')">
        <i class="fas fa-calendar-check"></i> ${evento}
      </div>
    `).join('');
    
    suggestions.innerHTML = html;
  }
  
  suggestions.style.display = 'block';
}

function adicionarEvento(evento) {
  if (!eventosSelecionados.includes(evento)) {
    eventosSelecionados.push(evento);
    atualizarEventosSelecionados();
    aplicarFiltroEventos();
  }
  
  document.getElementById('filtroEvento').value = '';
  document.getElementById('suggestionsEvento').style.display = 'none';
}

function removerEvento(evento) {
  eventosSelecionados = eventosSelecionados.filter(e => e !== evento);
  atualizarEventosSelecionados();
  aplicarFiltroEventos();
}

function atualizarEventosSelecionados() {
  const container = document.getElementById('eventosSelecionados');
  
  if (eventosSelecionados.length === 0) {
    container.innerHTML = '';
    container.style.display = 'none';
    return;
  }
  
  container.style.display = 'flex';
  container.innerHTML = eventosSelecionados.map(evento => `
    <div class="tag">
      <i class="fas fa-calendar"></i> ${evento}
      <button class="remover" onclick="removerEvento('${evento}')">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `).join('');
}

function aplicarFiltroEventos() {
  if (eventosSelecionados.length > 0) {
    filtrosAtivos.eventos = eventosSelecionados;
  } else {
    delete filtrosAtivos.eventos;
  }
  aplicarTodosFiltros();
}

// üî•üî•üî• FUN√á√ïES DO FILTRO DE FORNECEDORES - SEGUINDO O MODELO
function mostrarSugestoesFornecedor() {
  const input = document.getElementById('filtroFornecedor');
  if (input.value.trim().length > 0) {
    filtrarSugestoesFornecedor();
  }
}

function filtrarSugestoesFornecedor() {
  const input = document.getElementById('filtroFornecedor');
  const suggestions = document.getElementById('suggestionsFornecedor');
  const termo = input.value.toLowerCase().trim();
  
  if (termo.length < 1) {
    suggestions.style.display = 'none';
    return;
  }
  
  const fornecedoresFiltrados = fornecedoresDisponiveis.filter(fornecedor => 
    fornecedor.toLowerCase().includes(termo) && !fornecedoresSelecionados.includes(fornecedor)
  );
  
  if (fornecedoresFiltrados.length === 0) {
    suggestions.innerHTML = `
      <div class="suggestion-item" style="color: var(--gray);">
        <i class="fas fa-search"></i> Nenhum fornecedor encontrado
      </div>
    `;
  } else {
    let html = fornecedoresFiltrados.map(fornecedor => `
      <div class="suggestion-item" onclick="adicionarFornecedor('${fornecedor}')">
        <i class="fas fa-truck"></i> ${fornecedor}
      </div>
    `).join('');
    
    suggestions.innerHTML = html;
  }
  
  suggestions.style.display = 'block';
}

function adicionarFornecedor(fornecedor) {
  if (!fornecedoresSelecionados.includes(fornecedor)) {
    fornecedoresSelecionados.push(fornecedor);
    atualizarFornecedoresSelecionados();
    aplicarFiltroFornecedores();
  }
  
  document.getElementById('filtroFornecedor').value = '';
  document.getElementById('suggestionsFornecedor').style.display = 'none';
}

function removerFornecedor(fornecedor) {
  fornecedoresSelecionados = fornecedoresSelecionados.filter(f => f !== fornecedor);
  atualizarFornecedoresSelecionados();
  aplicarFiltroFornecedores();
}

function atualizarFornecedoresSelecionados() {
  const container = document.getElementById('fornecedoresSelecionados');
  
  if (fornecedoresSelecionados.length === 0) {
    container.innerHTML = '';
    container.style.display = 'none';
    return;
  }
  
  container.style.display = 'flex';
  container.innerHTML = fornecedoresSelecionados.map(fornecedor => `
    <div class="tag fornecedor">
      <i class="fas fa-truck"></i> ${fornecedor}
      <button class="remover" onclick="removerFornecedor('${fornecedor}')">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `).join('');
}

function aplicarFiltroFornecedores() {
  if (fornecedoresSelecionados.length > 0) {
    filtrosAtivos.fornecedores = fornecedoresSelecionados;
  } else {
    delete filtrosAtivos.fornecedores;
  }
  aplicarTodosFiltros();
}

// üî•üî•üî• APLICAR TODOS OS FILTROS - SEGUINDO O MODELO
function aplicarTodosFiltros() {
  let resultado = [...todosCadastros];
  
  if (filtrosAtivos.situacao) {
    resultado = resultado.filter(cadastro => 
      cadastro.situacao === filtrosAtivos.situacao
    );
  }
  
  if (filtrosAtivos.eventos && filtrosAtivos.eventos.length > 0) {
    resultado = resultado.filter(cadastro => 
      filtrosAtivos.eventos.some(evento => 
        cadastro.evento && cadastro.evento.toUpperCase().includes(evento)
      )
    );
  }
  
  if (filtrosAtivos.fornecedores && filtrosAtivos.fornecedores.length > 0) {
    resultado = resultado.filter(cadastro => 
      filtrosAtivos.fornecedores.includes(cadastro.fornecedor)
    );
  }
  
  if (filtrosAtivos.pesquisa) {
    resultado = resultado.filter(cadastro => 
      (cadastro.razao_social && cadastro.razao_social.toLowerCase().includes(filtrosAtivos.pesquisa)) ||
      (cadastro.nome_fantasia && cadastro.nome_fantasia.toLowerCase().includes(filtrosAtivos.pesquisa)) ||
      (cadastro.cnpj && cadastro.cnpj.includes(filtrosAtivos.pesquisa)) ||
      (cadastro.fornecedor && cadastro.fornecedor.toLowerCase().includes(filtrosAtivos.pesquisa)) ||
      (cadastro.evento && cadastro.evento.toLowerCase().includes(filtrosAtivos.pesquisa))
    );
  }
  
  cadastrosFiltrados = resultado;
  exibirTabelaCadastrosAgrupada(agruparCadastrosPorCNPJ(cadastrosFiltrados), 'Cadastros Filtrados');
}

// üî•üî•üî• APLICAR FILTRO SITUA√á√ÉO - SEGUINDO O MODELO
function aplicarFiltroSituacao(situacao) {
  document.querySelectorAll('.filtro-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  if (situacao !== situacaoAtiva) {
    const btnAtivo = document.querySelector(`.filtro-btn[data-situacao="${situacao}"]`);
    if (btnAtivo) {
      btnAtivo.classList.add('active');
    }
    situacaoAtiva = situacao;
  } else {
    situacaoAtiva = 'all';
    const btnTodos = document.querySelector('.filtro-btn[data-situacao="all"]');
    if (btnTodos) {
      btnTodos.classList.add('active');
    }
  }

  if (situacaoAtiva === 'all') {
    delete filtrosAtivos.situacao;
  } else {
    filtrosAtivos.situacao = situacaoAtiva;
  }
  aplicarTodosFiltros();
}

// üî•üî•üî• LIMPAR TODOS OS FILTROS - SEGUINDO O MODELO
function limparTodosFiltros() {
  filtrosAtivos = {};
  situacaoAtiva = 'all';
  eventosSelecionados = [];
  fornecedoresSelecionados = [];
  document.getElementById('pesquisaCadastros').value = '';
  
  // üî• CORRE√á√ÉO: DEFINIR ORDENA√á√ÉO POR RAZ√ÉO SOCIAL (A-Z) POR PADR√ÉO
  document.getElementById('ordenacaoCadastros').value = 'razao_social';
  
  document.getElementById('filtroEvento').value = '';
  document.getElementById('filtroFornecedor').value = '';
  
  document.querySelectorAll('.filtro-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector('.filtro-btn[data-situacao="all"]').classList.add('active');
  
  atualizarEventosSelecionados();
  atualizarFornecedoresSelecionados();
  
  // üî• CORRE√á√ÉO: APLICAR ORDENA√á√ÉO AP√ìS LIMPAR FILTROS
  aplicarTodosFiltros();
  
  // üî• CORRE√á√ÉO ADICIONAL: FOR√áAR ORDENA√á√ÉO ALFAB√âTICA
  setTimeout(() => {
    ordenarCadastros();
  }, 100);
}

// üî• CORRE√á√ÉO DA FUN√á√ÉO FORMATAR CNPJ
function formatarCNPJ(input) {
    let value = input.value.replace(/\D/g, '');
    
    if (value.length <= 14) {
        // Aplicar m√°scara: 00.000.000/0000-00
        if (value.length > 12) {
            value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2})/, '$1.$2.$3/$4-$5');
        } else if (value.length > 8) {
            value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{0,4})/, '$1.$2.$3/$4');
        } else if (value.length > 5) {
            value = value.replace(/^(\d{2})(\d{3})(\d{0,3})/, '$1.$2.$3');
        } else if (value.length > 2) {
            value = value.replace(/^(\d{2})(\d{0,3})/, '$1.$2');
        }
    }
    
    input.value = value;
}

// üî• ADICIONAR EVENT LISTENER PARA O CAMPO CNPJ
document.addEventListener('DOMContentLoaded', function() {
  // ... c√≥digo existente ...
  
  // üî• CORRE√á√ÉO: Configurar m√°scara do CNPJ
  const cnpjInput = document.getElementById('cnpj_cadastro');
  if (cnpjInput) {
    cnpjInput.addEventListener('input', function() {
      formatarCNPJ(this);
    });
    
    // Permitir colar CNPJ formatado
    cnpjInput.addEventListener('paste', function(e) {
      setTimeout(() => {
        formatarCNPJ(this);
      }, 100);
    });
  }
});

// üî•üî•üî• FUN√á√ÉO PARA VER TODOS OS FORNECEDORES - SEGUINDO O MODELO
function verTodosFornecedores(cnpj) {
  const lojasDoCNPJ = todosCadastros.filter(cadastro => cadastro.cnpj === cnpj);
  exibirModalFornecedores(cnpj, lojasDoCNPJ);
}

function exibirModalFornecedores(cnpj, lojas) {
  const modal = document.getElementById('modalFornecedores');
  const content = document.getElementById('modalFornecedoresContent');
  
  let lojasHTML = '';
  
  if (lojas && lojas.length > 0) {
    lojasHTML = lojas.map(loja => {
      // üî•üî•üî• CORRE√á√ÉO: APLICAR CORRE√á√ÉO DE 5 HORAS NO √öLTIMO EVENTO
      const ultimoEventoCorrigido = loja.ultimo_evento ? 
          corrigirHoraFrontend(loja.ultimo_evento) : 'N/A';
      
      return `
      <div class="loja-item" style="border-color: ${getCorBordaSituacao(loja.situacao)};">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
          <h4 style="margin: 0; color: var(--primary);">üè™ ${loja.fornecedor || 'Fornecedor'}</h4>
          <span class="status-badge ${getSituacaoClass(loja.situacao)}">${loja.situacao || 'N/A'}</span>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
          <div><strong>üìÖ Evento:</strong> ${loja.evento || 'N/A'}</div>
          <div><strong>üí∞ Tarifa:</strong> ${loja.tarifa || 'N/A'} ${formatarPercentualCorrigido(loja.percentual_tarifa)}</div>
          <div><strong>üíµ Mensalidade:</strong> ${formatarMoedaParaInput(loja.mensalidade)}</div>
          <div><strong>ü§ù Ades√£o:</strong> ${loja.adesao === 'Isento' || loja.adesao === 0 ? 'Isento' : formatarMoedaParaInput(loja.adesao)}</div>
        </div>
        
        <div style="background: #f8f9fa; padding: 6px 10px; border-radius: 5px; margin-bottom: 8px; border-left: 2px solid var(--warning);">
          <strong>‚è∞ √öltimo Evento:</strong> 
          <span style="color: var(--dark); font-weight: 600;">
            ${ultimoEventoCorrigido}
          </span>
        </div>
        
        ${loja.situacao && loja.situacao.toUpperCase() === 'EM ANDAMENTO' ? `
        <div style="background: #fff3cd; padding: 6px 10px; border-radius: 5px; margin-bottom: 8px; border-left: 2px solid var(--warning);">
          <strong>‚è∞ Defasagem:</strong> 
          <span style="color: ${calcularDefasagem(loja.ultimo_evento).includes('30') || calcularDefasagem(loja.ultimo_evento).includes('31') ? 'var(--danger)' : 'var(--dark)'}; font-weight: 600;">
            ${calcularDefasagem(loja.ultimo_evento)}
          </span>
        </div>
        ` : `
        <div style="background: #e9ecef; padding: 6px 10px; border-radius: 5px; margin-bottom: 8px; border-left: 2px solid #6c757d;">
          <strong>‚è∞ Defasagem:</strong> 
          <span style="color: #6c757d; font-weight: 600;">
            Sem defasagem
          </span>
        </div>
        `}
        
        <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
          <!-- üî•üî•üî• BOT√ÉO EDITAR ADICIONADO AQUI -->
          <button class="btn btn-warning btn-sm" onclick="editarCadastroModal('${loja.id}'); fecharModalFornecedores();">
            <i class="fas fa-edit"></i> Editar
          </button>
          <button class="btn btn-info btn-sm" onclick="verDetalhesCadastroModal('${loja.id}'); fecharModalFornecedores();">
            <i class="fas fa-eye"></i> Detalhes
          </button>
        </div>
      </div>
    `}).join('');
  } else {
    lojasHTML = `
      <div style="text-align: center; padding: 30px; color: var(--gray);">
        <i class="fas fa-store-slash" style="font-size: 2.5rem; margin-bottom: 12px;"></i>
        <h4>Nenhuma loja encontrada</h4>
        <p>N√£o h√° lojas cadastradas para este CNPJ.</p>
      </div>
    `;
  }

  content.innerHTML = `
    <div style="margin-bottom: 12px;">
      <div style="font-family: monospace; background: #f8f9fa; padding: 8px; border-radius: 5px; text-align: center;">
        <strong>CNPJ:</strong> ${cnpj}
      </div>
    </div>
    
    <div style="max-height: 60vh; overflow-y: auto;">
      <h4 style="color: var(--primary); margin-bottom: 12px;">
        üìä ${lojas ? lojas.length : 0} loja(s) encontrada(s)
      </h4>
      ${lojasHTML}
    </div>
  `;
  
  modal.style.display = 'flex';
}

// üî•üî•üî• FUN√á√ÉO PARA FECHAR MODAL DE FORNECEDORES
function fecharModalFornecedores() {
  const modal = document.getElementById('modalFornecedores');
  modal.style.display = 'none';
}

// üî•üî•üî• FUN√á√ÉO PARA CALCULAR DIAS DE DEFASAGEM - CORRIGIDA
function calcularDiasDefasagem(dataUltimoEvento) {
  const defasagem = calcularDefasagem(dataUltimoEvento);
  console.log("üî¢ Calculando dias de defasagem:", dataUltimoEvento, "‚Üí", defasagem);
  
  if (defasagem === 'N/A' || defasagem === 'Erro' || defasagem === 'Futuro' || defasagem === 'Data inv√°lida' || defasagem === 'Erro no c√°lculo') {
    return 9999; // Coloca no final
  }
  if (defasagem === 'Hoje') return 0;
  if (defasagem === '1 dia') return 1;
  
  // Extrair n√∫mero de dias de strings como "5 dias"
  const match = defasagem.match(/(\d+)\s*dias?/);
  if (match && match[1]) {
    return parseInt(match[1]);
  }
  
  const dias = parseInt(defasagem);
  if (isNaN(dias)) return 9999;
  
  return dias;
}

// üî•üî•üî• FUN√á√ÉO PARA OBTER CLASSE DE DEFASAGEM - SEGUINDO O MODELO
function getDefasagemClass(defasagem) {
  if (defasagem === 'N/A' || defasagem === 'Erro') return 'defasagem-media';
  if (defasagem === 'Hoje') return 'defasagem-baixa';
  if (defasagem === '1 dia') return 'defasagem-baixa';
  
  const dias = parseInt(defasagem);
  if (isNaN(dias)) return 'defasagem-media';
  
  if (dias <= 3) return 'defasagem-baixa';
  if (dias <= 7) return 'defasagem-media';
  return 'defasagem-alta';
}

// üî•üî•üî• FUN√á√ÉO PARA OBTER COR DA BORDA POR SITUA√á√ÉO - SEGUINDO O MODELO
function getCorBordaSituacao(situacao) {
  const situacaoLower = situacao ? situacao.toLowerCase() : '';
  
  if (situacaoLower.includes('novo registro')) return '#bfe1f6';
  else if (situacaoLower.includes('cadastrado')) return '#D1E7DD';
  else if (situacaoLower.includes('em andamento')) return '#FFF3CD';
  else if (situacaoLower.includes('rejeitado') || situacaoLower.includes('rejeitado')) return '#E2E3E5';
  else if (situacaoLower.includes('descredenciado')) return '#F8D7DA';
  else if (situacaoLower.includes('desistiu')) return '#e6cff2';
  else return 'var(--border)';
}

// üî•üî•üî• FUN√á√ÉO PARA FORMATAR PERCENTUAL CORRIGIDO - SEGUINDO O MODELO
function formatarPercentualCorrigido(percentual) {
    if (!percentual && percentual !== 0) return 'N/A';
    
    try {
        const numero = typeof percentual === 'string' ? parseFloat(percentual) : percentual;
        
        if (isNaN(numero)) return String(percentual);
        
        const porcentagem = numero * 100;
        return porcentagem.toFixed(2).replace('.', ',') + '%';
        
    } catch (error) {
        return String(percentual);
    }
}

// üî•üî•üî• FUN√á√ÉO PARA VER DETALHES DE CADASTRO - SEGUINDO O MODELO
function verDetalhesCadastroModal(id) {
  console.log("üëÄ Visualizando detalhes ID:", id, "Waitlabel:", waitlabelAtual);
  showLoading("Carregando detalhes...", "Buscando informa√ß√µes completas");
  
  // üî• ARMAZENAR O ID DO CADASTRO ATUAL PARA USAR NO BOT√ÉO EDITAR
  cadastroAtualModalId = id;
  
  google.script.run
    .withSuccessHandler(function(dados) {
      hideLoading();
      console.log("‚úÖ‚úÖ‚úÖ DADOS RECEBIDOS DO GOOGLE APPS SCRIPT:");
      console.log("√öltimo evento recebido:", dados.ultimo_evento);
      console.log("Evento recebido:", dados.evento);
      console.log("Dados completos:", dados);
      
      // üî• ADICIONAR WAITLABEL AOS DADOS PARA EXIBI√á√ÉO
      dados.waitlabel = waitlabelAtual;
      exibirModalDetalhesCompleto(dados);
    })
    .withFailureHandler(function(error) {
      hideLoading();
      console.error("‚ùå ERRO AO BUSCAR DADOS:", error);
      showMessage('error', '‚ùå Erro ao carregar detalhes: ' + error.message);
    })
    .buscarCadastroPorIDComWaitlabel(id, waitlabelAtual);
}

// üî•üî•üî• FUN√á√ÉO PARA EXIBIR TABELA AGRUPADA - ATUALIZADA SEGUINDO O MODELO
function exibirTabelaCadastrosAgrupada(cadastrosAgrupados, titulo) {
  const secao = document.getElementById('secaoCadastros');
  const tituloElement = document.getElementById('tituloCadastros');
  const tableContainer = document.getElementById('tableContainer');
  const tabelaBody = document.getElementById('tabelaCadastrosBody');
  const loading = document.getElementById('loadingCadastros');
  const filtrosAvancados = document.getElementById('filtrosAvancadosContainer');

  tituloElement.textContent = `${titulo} (${cadastrosAgrupados.length})`;
  tabelaBody.innerHTML = '';

  if (cadastrosAgrupados.length === 0) {
    tabelaBody.innerHTML = `
      <tr>
        <td colspan="9" style="text-align: center; padding: 30px;">
          <i class="fas fa-search" style="font-size: 2.5rem; color: var(--gray); margin-bottom: 12px;"></i>
          <h3>Nenhum resultado encontrado</h3>
          <p>Tente alterar os filtros de pesquisa.</p>
        </td>
      </tr>
    `;
  } else {
    cadastrosAgrupados.forEach(cadastro => {
      const row = criarLinhaTabelaAgrupada(cadastro);
      tabelaBody.appendChild(row);
    });
  }

  loading.style.display = 'none';
  tableContainer.style.display = 'block';
  filtrosAvancados.style.display = 'grid';
  secao.style.display = 'block';
  atualizarContador();
  
  // üî•üî•üî• CORRE√á√ÉO: SCROLL SUAVE PARA A SE√á√ÉO DE CADASTROS
  setTimeout(() => {
    secao.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 300);
}

// üî• CORRE√á√ÉO DEFINITIVA - UTC para GMT-3 (5 horas de diferen√ßa)
function corrigirHoraFrontend(dataHoraString) {
    if (!dataHoraString || !dataHoraString.includes('/') || !dataHoraString.includes(':')) {
        return dataHoraString;
    }
    
    console.log("üïí Data recebida do backend (UTC):", dataHoraString);
    
    try {
        const [dataPart, horaPart] = dataHoraString.split(' ');
        const [dia, mes, ano] = dataPart.split('/');
        const [hora, minuto, segundo] = horaPart.split(':');
        
        // üî• CORRE√á√ÉO: UTC para GMT-3 = SUBTRAIR 3 HORAS
        // Mas parece que precisamos subtrair 5 horas
        const dataUTC = new Date(Date.UTC(
            parseInt(ano),
            parseInt(mes) - 1,
            parseInt(dia),
            parseInt(hora),
            parseInt(minuto), 
            parseInt(segundo)
        ));
        
        // üî• MUDAN√áA: Subtrair 5 horas em vez de 3
        const dataGMT3 = new Date(dataUTC.getTime() - (5 * 60 * 60 * 1000));
        
        // Formatar de volta para string
        const diaCorrigido = String(dataGMT3.getUTCDate()).padStart(2, '0');
        const mesCorrigido = String(dataGMT3.getUTCMonth() + 1).padStart(2, '0');
        const anoCorrigido = dataGMT3.getUTCFullYear();
        const horaCorrigida = String(dataGMT3.getUTCHours()).padStart(2, '0');
        const minutoCorrigido = String(dataGMT3.getUTCMinutes()).padStart(2, '0');
        const segundoCorrigido = String(dataGMT3.getUTCSeconds()).padStart(2, '0');
        
        const resultado = `${diaCorrigido}/${mesCorrigido}/${anoCorrigido} ${horaCorrigida}:${minutoCorrigido}:${segundoCorrigido}`;
        
        console.log("‚úÖ Data corrigida (GMT-3):", resultado);
        return resultado;
        
    } catch (error) {
        console.error("‚ùå Erro ao corrigir data:", error);
        return dataHoraString;
    }
}

console.log("üî• Corre√ß√£o aplicada: UTC ‚Üí GMT-3 (5 horas)");


function criarLinhaTabelaAgrupada(grupo) {
  const row = document.createElement('tr');
  
  const situacoes = grupo.lojas.map(l => l.situacao);
  const situacaoPrincipal = situacoes.includes('DESCREDENCIADO') ? 'DESCREDENCIADO' :
                           situacoes.includes('REJEITADO') ? 'REJEITADO' :
                           situacoes.includes('EM ANDAMENTO') ? 'EM ANDAMENTO' :
                           situacoes.includes('NOVO REGISTRO') ? 'NOVO REGISTRO' :
                           situacoes.includes('DESISTIU') ? 'DESISTIU' :
                           'CADASTRADO';

  // üî•üî•üî• CORRE√á√ÉO: ENCONTRAR O FORNECEDOR MAIS ATRASADO
  const fornecedorMaisAntigo = encontrarFornecedorMaisAntigo(grupo.lojas);
  
  console.log("üîç FORNECEDOR MAIS ANTIGO ENCONTRADO:", fornecedorMaisAntigo);

  // üî•üî•üî• CORRE√á√ÉO DEFINITIVA: APLICAR CORRE√á√ÉO DE 5 HORAS
  const dataHoraMaisAntiga = fornecedorMaisAntigo.data || 'N/A';
  
  // üî• APLICAR CORRE√á√ÉO DE 5 HORAS
  const dataHoraCorrigida = dataHoraMaisAntiga !== 'N/A' ? 
      corrigirHoraFrontend(dataHoraMaisAntiga) : 'N/A';

  const eventoMaisAntigo = fornecedorMaisAntigo.evento || 'N/A';
  const nomeFornecedorAntigo = fornecedorMaisAntigo.fornecedor || 'N/A';

  // üî•üî•üî• AGORA MOSTRA DATA E HORA CORRIGIDA
  let ultimoEventoInfo = '';
  if (dataHoraCorrigida !== 'N/A') {
    // Se j√° est√° no formato brasileiro com hora (DD/MM/YYYY HH:mm:ss)
    if (dataHoraCorrigida.includes('/') && dataHoraCorrigida.includes(':')) {
      const [dataPart, horaPart] = dataHoraCorrigida.split(' ');
      ultimoEventoInfo = `
        <div style="font-size: 0.75rem;">
          <div style="font-weight: 500; margin-bottom: 2px;">${eventoMaisAntigo}</div>
          <div style="color: var(--gray); font-size: 0.65rem;">
            ${dataPart} ${horaPart}
          </div>
          <div style="color: var(--danger); font-size: 0.6rem; margin-top: 2px;">
            ‚ö†Ô∏è ${nomeFornecedorAntigo}
          </div>
        </div>
      `;
    } else {
      // Tentar formatar outros formatos de data
      ultimoEventoInfo = `
        <div style="font-size: 0.75rem;">
          <div style="font-weight: 500; margin-bottom: 2px;">${eventoMaisAntigo}</div>
          <div style="color: var(--gray); font-size: 0.65rem;">${dataHoraCorrigida}</div>
          <div style="color: var(--danger); font-size: 0.6rem; margin-top: 2px;">
            ‚ö†Ô∏è ${nomeFornecedorAntigo}
          </div>
        </div>
      `;
    }
  } else {
    ultimoEventoInfo = `
      <div style="font-size: 0.75rem;">
        <div style="font-weight: 500; margin-bottom: 2px;">${eventoMaisAntigo}</div>
        <div style="color: var(--gray); font-size: 0.65rem;">N/A</div>
        <div style="color: var(--danger); font-size: 0.6rem; margin-top: 2px;">
          ‚ö†Ô∏è ${nomeFornecedorAntigo}
        </div>
      </div>
    `;
  }

  // üî• CORRE√á√ÉO: S√ì MOSTRAR DEFASAGEM SE HOUVER LOJA EM ANDAMENTO
  const temLojaEmAndamento = grupo.lojas.some(loja => 
    loja.situacao && loja.situacao.toUpperCase() === 'EM ANDAMENTO'
  );

  let defasagemHTML = '';
  if (temLojaEmAndamento) {
    const defasagemInfo = calcularDefasagemPorCNPJ(grupo.lojas);
    const defasagemTexto = defasagemInfo.dias === 0 ? 'Hoje' : 
                          defasagemInfo.dias === 1 ? '1 dia' : 
                          defasagemInfo.dias > 1 && defasagemInfo.dias < 9999 ? `${defasagemInfo.dias} dias` : 'N/A';
    const defasagemClass = getDefasagemClass(defasagemTexto);
    
    defasagemHTML = `
      <td style="text-align: center;">
        <div class="defasagem-container">
          <span class="defasagem-badge ${defasagemClass}" title="Fornecedor mais antigo: ${defasagemInfo.fornecedor}">
            ${defasagemTexto}
          </span>
        </div>
      </td>
    `;
  } else {
    defasagemHTML = `
      <td style="text-align: center;">
        <div class="defasagem-container">
          <span class="sem-defasagem-badge" title="Nenhuma loja em andamento">
            Sem defasagem
          </span>
        </div>
      </td>
    `;
  }

  row.innerHTML = `
    <td>
      <div style="font-weight: 600; color: var(--primary); margin-bottom: 2px;">${grupo.razao_social || 'N/A'}</div>
      <div style="font-size: 0.7rem; color: var(--gray);">${grupo.nome_fantasia || 'Sem nome fantasia'}</div>
      <div style="font-size: 0.65rem; color: var(--info); margin-top: 2px;">
        <strong>${grupo.lojas.length}</strong> fornecedor(es)
      </div>
    </td>
    <td>
      <div style="font-family: monospace; font-size: 0.75rem; font-weight: 600; color: var(--dark);">
        ${grupo.cnpj || 'N/A'}
      </div>
    </td>
    <td>
      <div style="font-weight: 500; color: var(--dark);">
        ${grupo.lojas.map(l => l.fornecedor).join(', ')}
      </div>
    </td>
    <td>
      <span class="status-badge ${getSituacaoClass(situacaoPrincipal)}">${situacaoPrincipal}</span>
    </td>
    <td>
      ${ultimoEventoInfo}
    </td>
    ${defasagemHTML}
    <td style="font-weight: 600; color: var(--success); text-align: center;">
      ${formatarMoedaParaInput(grupo.lojas[0]?.mensalidade)}
    </td>
    <td style="font-weight: 600; color: var(--info); text-align: center;">
      ${grupo.lojas[0]?.adesao === 'Isento' || grupo.lojas[0]?.adesao === 0 ? 'Isento' : formatarMoedaParaInput(grupo.lojas[0]?.adesao)}
    </td>
    <td style="text-align: center;">
      <button class="btn btn-info btn-sm btn-visualizar-compact" onclick="verTodosFornecedores('${grupo.cnpj}')" title="Visualizar Todos">
        <i class="fas fa-eye"></i> Ver Todos
      </button>
    </td>
  `;

  return row;
}


// üî•üî•üî• FUN√á√ÉO AUXILIAR PARA ENCONTRAR FORNECEDOR MAIS ATRASADO
function encontrarFornecedorMaisAntigo(lojasDoCNPJ) {
  if (!lojasDoCNPJ || lojasDoCNPJ.length === 0) {
    return { fornecedor: 'N/A', data: 'N/A', evento: 'N/A', dias: 9999 };
  }
  
  console.log("üîç Buscando fornecedor mais antigo entre", lojasDoCNPJ.length, "lojas");
  
  // Filtrar apenas lojas com data v√°lida
  const lojasComData = lojasDoCNPJ.filter(loja => {
    if (!loja.ultimo_evento || loja.ultimo_evento === 'N/A') return false;
    
    try {
      const data = new Date(loja.ultimo_evento.split('/').reverse().join('-'));
      return !isNaN(data.getTime());
    } catch (error) {
      return false;
    }
  });
  
  if (lojasComData.length === 0) {
    console.log("‚ùå Nenhuma loja com data v√°lida encontrada");
    return { fornecedor: 'N/A', data: 'N/A', evento: 'N/A', dias: 9999 };
  }
  
  // Encontrar a loja com evento mais antigo
  const lojaMaisAntiga = lojasComData.reduce((maisAntiga, atual) => {
    try {
      const dataMaisAntiga = new Date(maisAntiga.ultimo_evento.split('/').reverse().join('-'));
      const dataAtual = new Date(atual.ultimo_evento.split('/').reverse().join('-'));
      
      console.log(`üìä Comparando: ${atual.fornecedor} (${dataAtual}) vs ${maisAntiga.fornecedor} (${dataMaisAntiga})`);
      
      return dataAtual < dataMaisAntiga ? atual : maisAntiga;
    } catch (error) {
      console.log("‚ùå Erro ao comparar datas:", error);
      return maisAntiga;
    }
  });
  
  const diasDefasagem = calcularDiasDefasagem(lojaMaisAntiga.ultimo_evento);
  
  console.log("‚úÖ Fornecedor mais antigo encontrado:", {
    fornecedor: lojaMaisAntiga.fornecedor,
    data: lojaMaisAntiga.ultimo_evento,
    evento: lojaMaisAntiga.evento,
    dias: diasDefasagem
  });
  
  return {
    fornecedor: lojaMaisAntiga.fornecedor,
    data: lojaMaisAntiga.ultimo_evento,
    evento: lojaMaisAntiga.evento,
    dias: diasDefasagem
  };
}


// üî• NOVA FUN√á√ÉO: Calcular defasagem correta por CNPJ (usando o mais antigo)
function calcularDefasagemPorCNPJ(lojasDoCNPJ) {
  if (!lojasDoCNPJ || lojasDoCNPJ.length === 0) {
    return { dias: 9999, fornecedor: 'N/A', data: 'N/A', evento: 'N/A' };
  }
  
  console.log("üîç Calculando defasagem para CNPJ com", lojasDoCNPJ.length, "lojas");
  
  // Filtrar apenas lojas com data v√°lida
  const lojasComData = lojasDoCNPJ.filter(loja => {
    if (!loja.ultimo_evento || loja.ultimo_evento === 'N/A') return false;
    
    try {
      const data = new Date(loja.ultimo_evento.split('/').reverse().join('-'));
      return !isNaN(data.getTime());
    } catch (error) {
      return false;
    }
  });
  
  if (lojasComData.length === 0) {
    console.log("‚ùå Nenhuma loja com data v√°lida encontrada");
    return { dias: 9999, fornecedor: 'N/A', data: 'N/A', evento: 'N/A' };
  }
  
  // Encontrar a loja com evento mais antigo
  const lojaMaisAntiga = lojasComData.reduce((maisAntiga, atual) => {
    try {
      const dataMaisAntiga = new Date(maisAntiga.ultimo_evento.split('/').reverse().join('-'));
      const dataAtual = new Date(atual.ultimo_evento.split('/').reverse().join('-'));
      
      console.log(`üìä Comparando: ${atual.fornecedor} (${dataAtual}) vs ${maisAntiga.fornecedor} (${dataMaisAntiga})`);
      
      return dataAtual < dataMaisAntiga ? atual : maisAntiga;
    } catch (error) {
      console.log("‚ùå Erro ao comparar datas:", error);
      return maisAntiga;
    }
  });
  
  const diasDefasagem = calcularDiasDefasagem(lojaMaisAntiga.ultimo_evento);
  
  console.log("‚úÖ Fornecedor mais antigo encontrado:", {
    fornecedor: lojaMaisAntiga.fornecedor,
    data: lojaMaisAntiga.ultimo_evento,
    dias: diasDefasagem
  });
  
  return {
    dias: diasDefasagem,
    fornecedor: lojaMaisAntiga.fornecedor,
    data: lojaMaisAntiga.ultimo_evento,
    evento: lojaMaisAntiga.evento
  };
}

// üî•üî•üî• FUN√á√ÉO PARA FILTRAR PESQUISA - ATUALIZADA SEGUINDO O MODELO
function filtrarPesquisa() {
  const termo = document.getElementById('pesquisaCadastros').value.toLowerCase().trim();
  if (termo) {
    filtrosAtivos.pesquisa = termo;
  } else {
    delete filtrosAtivos.pesquisa;
  }
  aplicarTodosFiltros();
}


// üî•üî•üî• FUN√á√ÉO PARA ORDENAR CADASTROS - CORRIGIDA
function ordenarCadastros() {
  const criterio = document.getElementById('ordenacaoCadastros').value;
  
  console.log("üéØ [DEBUG] Ordenando por:", criterio);
  
  // Ordenar os cadastros agrupados, n√£o os individuais
  const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosFiltrados);
  
  cadastrosAgrupados.sort((a, b) => {
    switch(criterio) {
      case 'razao_social':
        return (a.razao_social || '').localeCompare(b.razao_social || '');
      case 'razao_social_desc':
        return (b.razao_social || '').localeCompare(a.razao_social || '');
      case 'nome_fantasia':
        return (a.nome_fantasia || '').localeCompare(b.nome_fantasia || '');
      case 'nome_fantasia_desc':
        return (b.nome_fantasia || '').localeCompare(a.nome_fantasia || '');
      case 'situacao':
        const situacaoA = a.lojas[0]?.situacao || '';
        const situacaoB = b.lojas[0]?.situacao || '';
        return situacaoA.localeCompare(situacaoB);
      case 'fornecedor':
        const fornecedorA = a.lojas[0]?.fornecedor || '';
        const fornecedorB = b.lojas[0]?.fornecedor || '';
        return fornecedorA.localeCompare(fornecedorB);
      case 'defasagem':
        const defasagemA = calcularDefasagemParaOrdenacao(a.lojas);
        const defasagemB = calcularDefasagemParaOrdenacao(b.lojas);
        return defasagemB - defasagemA;
      case 'defasagem_asc':
        const defasagemAAsc = calcularDefasagemParaOrdenacao(a.lojas);
        const defasagemBAsc = calcularDefasagemParaOrdenacao(b.lojas);
        return defasagemAAsc - defasagemBAsc;
      case 'mensalidade':
        const mensalidadeA = parseFloat(a.lojas[0]?.mensalidade || 0);
        const mensalidadeB = parseFloat(b.lojas[0]?.mensalidade || 0);
        return mensalidadeB - mensalidadeA;
      case 'mensalidade_asc':
        const mensalidadeAAsc = parseFloat(a.lojas[0]?.mensalidade || 0);
        const mensalidadeBAsc = parseFloat(b.lojas[0]?.mensalidade || 0);
        return mensalidadeAAsc - mensalidadeBAsc;
      case 'adesao':
        const adesaoA = a.lojas[0]?.adesao === 'Isento' || a.lojas[0]?.adesao === 0 ? 0 : parseFloat(a.lojas[0]?.adesao || 0);
        const adesaoB = b.lojas[0]?.adesao === 'Isento' || b.lojas[0]?.adesao === 0 ? 0 : parseFloat(b.lojas[0]?.adesao || 0);
        return adesaoB - adesaoA;
      case 'adesao_asc':
        const adesaoAAsc = a.lojas[0]?.adesao === 'Isento' || a.lojas[0]?.adesao === 0 ? 0 : parseFloat(a.lojas[0]?.adesao || 0);
        const adesaoBAsc = b.lojas[0]?.adesao === 'Isento' || b.lojas[0]?.adesao === 0 ? 0 : parseFloat(b.lojas[0]?.adesao || 0);
        return adesaoAAsc - adesaoBAsc;
      default:
        return 0;
    }
  });
  
  exibirTabelaCadastrosAgrupada(cadastrosAgrupados, 'Cadastros Ordenados');
}

// üî• NOVA FUN√á√ÉO: Calcular defasagem para ordena√ß√£o (considera status)
function calcularDefasagemParaOrdenacao(lojasDoCNPJ) {
  if (!lojasDoCNPJ || lojasDoCNPJ.length === 0) {
    return 0; // Se n√£o tem lojas, defasagem = 0
  }
  
  // üî• VERIFICAR SE TEM ALGUMA LOJA EM ANDAMENTO
  const temLojaEmAndamento = lojasDoCNPJ.some(loja => 
    loja.situacao && loja.situacao.toUpperCase() === 'EM ANDAMENTO'
  );
  
  // üî• SE N√ÉO TEM LOJA EM ANDAMENTO, DEFASAGEM = 0
  if (!temLojaEmAndamento) {
    return 0;
  }
  
  // üî• SE TEM LOJA EM ANDAMENTO, CALCULAR A DEFASAGEM REAL
  const defasagemInfo = calcularDefasagemPorCNPJ(lojasDoCNPJ);
  
  console.log("üéØ Defasagem para ordena√ß√£o:", {
    cnpj: lojasDoCNPJ[0]?.cnpj,
    temLojaEmAndamento: temLojaEmAndamento,
    defasagemDias: defasagemInfo.dias
  });
  
  return defasagemInfo.dias < 9999 ? defasagemInfo.dias : 0;
}

// üî•üî•üî• FUN√á√ÉO PARA RECARREGAR CADASTROS - ATUALIZADA SEGUINDO O MODELO
function recarregarCadastros() {
  console.log("üéØ [DEBUG] Bot√£o 'Atualizar' na tabela clicado");
  console.log("üîÑ Recarregando lista de cadastros...");
  console.log("üîÑ Recarregando cadastros...");// üî• ADICIONE ESTAS 2 LINHAS AQUI:
  showLoading("Atualizando dados...", "Sincronizando informa√ß√µes mais recentes");
  
  mostrarTodosCadastros();
}

// üî•üî•üî• ATUALIZAR CONTADOR - SEGUINDO O MODELO
function atualizarContador() {
  const contador = document.getElementById('contadorCadastros');
  const cadastrosVisiveis = cadastrosFiltrados.length;
  const totalCadastros = todosCadastros.length;
  
  if (cadastrosVisiveis === totalCadastros) {
    contador.textContent = `${totalCadastros} cadastro${totalCadastros !== 1 ? 's' : ''}`;
  } else {
    contador.textContent = `${cadastrosVisiveis} de ${totalCadastros} cadastros`;
  }
}

// üî•üî•üî• SHOW LOADING - SEGUINDO O MODELO
function showLoading() {
  document.getElementById('loadingCadastros').style.display = 'flex';
  document.getElementById('tableContainer').style.display = 'none';
}

// üî•üî•üî• HIDE LOADING - SEGUINDO O MODELO
function hideLoading() {
  document.getElementById('loadingCadastros').style.display = 'none';
}

// üî•üî•üî• FECHAR MODAIS COM ESC E CLIQUE FORA - SEGUINDO O MODELO
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    fecharModalDetalhes();
    fecharModalFornecedores();
  }
});

document.getElementById('modalDetalhes').addEventListener('click', function(e) {
  if (e.target === this) {
    fecharModalDetalhes();
  }
});

document.getElementById('modalFornecedores').addEventListener('click', function(e) {
  if (e.target === this) {
    fecharModalFornecedores();
  }
});

// üî•üî•üî• FUN√á√ÉO PARA EDITAR CADASTRO DIRETAMENTE DO MODAL
function editarCadastroDoModal() {
  if (!cadastroAtualModalId) {
    showMessage('error', '‚ùå Nenhum cadastro selecionado para edi√ß√£o!');
    return;
  }
  
  console.log("‚úèÔ∏è Editando cadastro do modal - ID:", cadastroAtualModalId);
  
  fecharModalDetalhes();
  
  // Chamar a fun√ß√£o existente de edi√ß√£o
  editarCadastroModal(cadastroAtualModalId);
}

function exibirModalDetalhesCompleto(dados) {
  const modal = document.getElementById('modalDetalhes');
  const content = document.getElementById('modalDetalhesContent');
  
  // üî• ADICIONAR INFORMA√á√ÉO DO WAITLABEL
  const waitlabelInfo = dados.waitlabel ? 
    `<div style="background: ${WAITLABELS_CONFIG.CORES[dados.waitlabel] || '#7E3E9A'}; color: white; padding: 8px 12px; border-radius: 6px; margin-bottom: 15px; text-align: center;">
      <strong>üìÅ Waitlabel:</strong> ${formatarNomeWaitlabel(dados.waitlabel)}
    </div>` : '';
  
  const mensalidadeFormatada = formatarMoedaParaInput(dados.mensalidade);
  const mensalidadeSimFormatada = formatarMoedaParaInput(dados.mensalidade_sim || 0);
  const adesaoFormatada = dados.adesao === 'Isento' || dados.adesao === 0 ? 'Isento' : formatarMoedaParaInput(dados.adesao);
  
  // üî•üî•üî• CORRE√á√ÉO: APLICAR CORRE√á√ÉO DE 5 HORAS NO √öLTIMO EVENTO
  const ultimoEventoCorrigido = dados.ultimo_evento ? 
      corrigirHoraFrontend(dados.ultimo_evento) : 'N/A';

  // üî•üî•üî• CORRE√á√ÉO: USAR A FUN√á√ÉO calcularDefasagem NORMAL
  const defasagem = calcularDefasagem(ultimoEventoCorrigido);
  
  console.log("üîç DEBUG DEFASAGEM - Modal Detalhes:");
  console.log("√öltimo evento original:", dados.ultimo_evento);
  console.log("√öltimo evento corrigido:", ultimoEventoCorrigido);
  console.log("Defasagem calculada:", defasagem);

  // üî• CORRE√á√ÉO: S√ì MOSTRAR DEFASAGEM SE FOR EM ANDAMENTO
  const mostrarDefasagem = dados.situacao && dados.situacao.toUpperCase() === 'EM ANDAMENTO';

  // üî• SE√á√ÉO DE DEFASAGEM (S√ì SE FOR EM ANDAMENTO)
  const secaoDefasagem = mostrarDefasagem && defasagem !== 'N/A' && defasagem !== '0 dias' && defasagem !== 'Data inv√°lida' && defasagem !== 'Erro no c√°lculo' ? `
    <div class="detalhe-item" style="grid-column: 1 / -1; background: #fff5f5; border-left: 4px solid #dc3545; margin-top: 10px;">
        <span class="detalhe-label" style="font-size: 1.1em; color: #dc3545;">
            <i class="fas fa-clock"></i> ‚ö†Ô∏è INFORMA√á√ïES DE DEFASAGEM
        </span>
    </div>
    
    <div class="detalhe-item">
        <span class="detalhe-label">‚è∞ Defasagem</span>
        <div class="detalhe-valor">
            <span style="display: inline-flex; align-items: center; gap: 5px; background: #dc3545; color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.9rem; font-weight: 600;">
                <i class="fas fa-clock"></i>
                ${defasagem}
            </span>
        </div>
    </div>
  ` : mostrarDefasagem ? '' : `
    <div class="detalhe-item" style="grid-column: 1 / -1; background: #e9ecef; border-left: 4px solid #6c757d; margin-top: 10px;">
        <span class="detalhe-label" style="font-size: 1.1em; color: #6c757d;">
            <i class="fas fa-clock"></i> INFORMA√á√ïES DE DEFASAGEM
        </span>
    </div>
    
    <div class="detalhe-item">
        <span class="detalhe-label">‚è∞ Defasagem</span>
        <div class="detalhe-valor">
            <span style="display: inline-flex; align-items: center; gap: 5px; background: #e9ecef; color: #6c757d; padding: 4px 10px; border-radius: 15px; font-size: 0.9rem; font-weight: 600;">
                <i class="fas fa-clock"></i>
                Sem defasagem
            </span>
        </div>
    </div>
  `;

  content.innerHTML = `
    ${waitlabelInfo}
    
    <div class="detalhes-grid">
        <!-- üî• SE√á√ÉO: INFORMA√á√ïES PRINCIPAIS -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0f8ff; border-left: 4px solid #7E3E9A;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #7E3E9A;">
                <i class="fas fa-info-circle"></i> üìã INFORMA√á√ïES PRINCIPAIS
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üè¢ Raz√£o Social</span>
            <div class="detalhe-valor" style="font-weight: bold; color: #7E3E9A;">${dados.razao_social || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üè∑Ô∏è Nome Fantasia</span>
            <div class="detalhe-valor">${dados.nome_fantasia || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üî¢ CNPJ</span>
            <div class="detalhe-valor" style="font-family: monospace;">${dados.cnpj || 'N/A'}</div>
        </div>
        
        
        <div class="detalhe-item">
            <span class="detalhe-label">üöö Fornecedor</span>
            <div class="detalhe-valor">${dados.fornecedor || 'N/A'}</div>
        </div>

        <!-- üî• SE√á√ÉO: FINANCEIRO -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0fff0; border-left: 4px solid #28a745; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #28a745;">
                <i class="fas fa-chart-line"></i> üí∞ INFORMA√á√ïES FINANCEIRAS
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üíµ Mensalidade</span>
            <div class="detalhe-valor" style="color: var(--success); font-weight: 600;">${mensalidadeFormatada}</div>
        </div>

        <div class="detalhe-item">
            <span class="detalhe-label" style="color: var(--primary); font-weight: 700;">üíú Mensalidade SIM</span>
            <div class="detalhe-valor" style="color: var(--primary); font-weight: 600;">${mensalidadeSimFormatada}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">ü§ù Ades√£o</span>
            <div class="detalhe-valor" style="color: var(--info); font-weight: 600;">${adesaoFormatada}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üí∞ Tarifa</span>
            <div class="detalhe-valor">${dados.tarifa || 'N/A'} ${formatarPercentualParaExibicao(dados.percentual_tarifa)}</div>
        </div>

        <!-- üî• SE√á√ÉO: CONTRATOS E DATAS -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #fff8f0; border-left: 4px solid #ff6b35; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #ff6b35;">
                <i class="fas fa-file-contract"></i> üìÑ CONTRATOS E DATAS
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üìÑ Contrato Enviado</span>
            <div class="detalhe-valor">${dados.contrato_enviado || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">‚úçÔ∏è Contrato Assinado</span>
            <div class="detalhe-valor">${dados.contrato_assinado || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üöÄ Data Ativa√ß√£o</span>
            <div class="detalhe-valor">${formatarDataParaExibicao(dados.ativacao) || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üìÖ √öltimo Evento</span>
            <div class="detalhe-valor">${ultimoEventoCorrigido}</div>
        </div>

        <!-- üî• SE√á√ÉO: STATUS E ACOMPANHAMENTO -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0f0f8; border-left: 4px solid #6f42c1; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #6f42c1;">
                <i class="fas fa-tasks"></i> üìä STATUS E ACOMPANHAMENTO
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üéØ Situa√ß√£o</span>
            <div class="detalhe-valor">
                <span class="status-badge ${getSituacaoClass(dados.situacao)}">${dados.situacao || 'N/A'}</span>
            </div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üìÖ Evento</span>
            <div class="detalhe-valor">${dados.evento || 'N/A'}</div>
        </div>

        <!-- üî• SE√á√ÉO: LINKS E OBSERVA√á√ïES -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0f0f0; border-left: 4px solid #6c757d; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #6c757d;">
                <i class="fas fa-sticky-note"></i> üîó LINKS E OBSERVA√á√ïES
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üîó Link</span>
            <div class="detalhe-valor">
                ${dados.link ? 
                    `<a href="${dados.link}" target="_blank" style="color: #007bff; text-decoration: none;">
                        <i class="fas fa-external-link-alt"></i> ${dados.link}
                    </a>` 
                    : 'N/A'
                }
            </div>
        </div>
        
        <div class="detalhe-item" style="grid-column: 1 / -1;">
            <span class="detalhe-label">üìù Observa√ß√µes</span>
            <div class="detalhe-valor" style="max-height: 100px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                ${dados.observacoes || 'Nenhuma observa√ß√£o registrada'}
            </div>
        </div>

        <!-- üî• SE√á√ÉO: DEFASAGEM - AGORA CORRETA -->
        ${secaoDefasagem}
    </div>

    <div class="modal-detalhes-actions">
        <button type="button" class="btn btn-warning" onclick="editarCadastroModal('${dados.id}')">
            <i class="fas fa-edit"></i> ‚úèÔ∏è Editar Cadastro
        </button>
    </div>
  `;
  
  modal.style.display = 'flex';
}

// üî• FUN√á√ÉO PARA FORMATAR DATA E HORA CORRETAMENTE
// üî• FUN√á√ÉO PARA FORMATAR DATA E HORA CORRETAMENTE
function formatarDataHoraParaExibicao(dataString) {
    if (!dataString) return 'N/A';
    
    try {
        // Se j√° est√° no formato brasileiro, retornar como est√°
        if (dataString.includes('/') && dataString.includes(':')) {
            return dataString;
        }
        
        // Converter para formato brasileiro
        const data = new Date(dataString);
        if (isNaN(data.getTime())) return dataString;
        
        const dia = String(data.getDate()).padStart(2, '0');
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        const ano = data.getFullYear();
        const hora = String(data.getHours()).padStart(2, '0');
        const minuto = String(data.getMinutes()).padStart(2, '0');
        const segundo = String(data.getSeconds()).padStart(2, '0');
        
        return `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo}`;
        
    } catch (error) {
        return dataString;
    }
}

// üî• CORRE√á√ÉO TEMPOR√ÅRIA - SOBRESCREVER A FUN√á√ÉO ORIGINAL
function calcularDefasagem(dataUltimoEvento) {
    console.log("üéØ CALCULAR DEFASAGEM COM CORRE√á√ÉO APLICADA");
    
    // üî• PRIMEIRO aplicar a corre√ß√£o de UTC para GMT-3
    const dataCorrigida = corrigirHoraFrontend(dataUltimoEvento);
    console.log("üìÖ Data ap√≥s corre√ß√£o:", dataCorrigida);
    
    // üî• AGORA calcular com a data corrigida
    if (!dataCorrigida || dataCorrigida === 'N/A' || dataCorrigida === '' || dataCorrigida === 'Data inv√°lida') {
        console.log("‚ùå Sem data v√°lida para calcular defasagem");
        return 'N/A';
    }
    
    try {
        let dataEvento;
        
        if (dataCorrigida.includes('/') && dataCorrigida.includes(':')) {
            const [dataPart, horaPart] = dataCorrigida.split(' ');
            const [dia, mes, ano] = dataPart.split('/');
            const [hora, minuto, segundo] = horaPart.split(':');
            
            dataEvento = new Date(
                parseInt(ano), 
                parseInt(mes) - 1,
                parseInt(dia),
                parseInt(hora), 
                parseInt(minuto), 
                parseInt(segundo)
            );
            
            console.log("‚úÖ Data evento (j√° corrigida):", dataEvento.toString());
            
        } else {
            dataEvento = new Date(dataCorrigida);
        }
        
        if (isNaN(dataEvento.getTime())) {
            return 'Data inv√°lida';
        }
        
        const hoje = new Date();
        const hojeZerado = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate(), 0, 0, 0);
        const dataEventoZerada = new Date(dataEvento.getFullYear(), dataEvento.getMonth(), dataEvento.getDate(), 0, 0, 0);
        
        console.log("üìä COMPARA√á√ÉO COM DATA CORRIGIDA:");
        console.log("Data evento (zerada):", dataEventoZerada.toLocaleDateString('pt-BR'));
        console.log("Data hoje (zerada):", hojeZerado.toLocaleDateString('pt-BR'));
        
        const diffTempo = hojeZerado.getTime() - dataEventoZerada.getTime();
        const diffDias = Math.floor(diffTempo / (1000 * 3600 * 24));
        
        console.log("‚úÖ Diferen√ßa em dias:", diffDias);
        
        if (diffDias === 0) return 'Hoje';
        if (diffDias === 1) return '1 dia';
        if (diffDias > 1) return `${diffDias} dias`;
        if (diffDias < 0) return 'Futuro';
        
        return 'N/A';
        
    } catch (error) {
        return 'Erro no c√°lculo';
    }
}

console.log("üî• Fun√ß√£o calcularDefasagem SOBRESCRITA com corre√ß√£o!");

function testarDefasagemFrontend() {
    const dataTeste = "14/11/2025 15:46:23";
    console.log("üß™ TESTE DEFASAGEM FRONTEND:");
    console.log("Data de entrada:", dataTeste);
    console.log("Resultado:", calcularDefasagem(dataTeste));
    
    // Verificar se a data est√° correta
    const [dataPart, horaPart] = dataTeste.split(' ');
    const [dia, mes, ano] = dataPart.split('/');
    const [hora, minuto, segundo] = horaPart.split(':');
    
    const dataObj = new Date(ano, mes-1, dia, hora, minuto, segundo);
    console.log("Data objeto:", dataObj);
    console.log("Hora no objeto:", dataObj.getHours() + ":" + dataObj.getMinutes());
}


// üî• MANTENDO TODAS AS FUN√á√ïES ORIGINAIS EXISTENTES
// üî• FUN√á√ïES PARA WAITLABELS
function inicializarWaitlabels() {
  console.log("üéØ Inicializando waitlabels...");
  
  // Buscar waitlabel atual do servidor
  google.script.run
    .withSuccessHandler(function(waitlabel) {
      waitlabelAtual = waitlabel;
      console.log("‚úÖ Waitlabel atual:", waitlabelAtual);
      criarBotoesWaitlabels();
      atualizarInterfaceWaitlabel();
    })
    .withFailureHandler(function(error) {
      console.error("‚ùå Erro ao buscar waitlabel:", error);
      criarBotoesWaitlabels(); // Criar mesmo com erro
    })
    .getWaitlabelAtual();
}

function criarBotoesWaitlabels() {
  const container = document.getElementById('waitlabelButtons');
  let html = '';
  
  WAITLABELS_CONFIG.WAITLABELS.forEach(waitlabel => {
    const cor = WAITLABELS_CONFIG.CORES[waitlabel];
    const isActive = waitlabel === waitlabelAtual;
    const classeAtiva = isActive ? 'active' : '';
    
    html += `
      <button class="waitlabel-btn ${classeAtiva}" 
              onclick="selecionarWaitlabel('${waitlabel}')"
              style="border-color: ${cor}; ${isActive ? `background: ${cor}; color: white;` : `color: ${cor};`}">
        <span class="waitlabel-indicator" style="background: ${cor};"></span>
        ${formatarNomeWaitlabel(waitlabel)}
      </button>
    `;
  });
  
  container.innerHTML = html;
}

function formatarNomeWaitlabel(nome) {
  const formatacoes = {
    'Sim_Facilita': 'Sim Facilita',
    'Set_9': 'Set 9',
    'Doktorbank': 'DoktorBank',
    'Dr_Parcela': 'Dr Parcela',
    'Result': 'Result'
  };
  return formatacoes[nome] || nome;
}

function selecionarWaitlabel(waitlabel) {
  console.log("üéØ Selecionando waitlabel:", waitlabel);
  
  waitlabelAtual = waitlabel;
  criarBotoesWaitlabels();
  atualizarInterfaceWaitlabel();
  
  google.script.run
    .withSuccessHandler(function(res) {
      console.log("‚úÖ Waitlabel salvo:", res);
      showMessage('success', `‚úÖ Waitlabel alterado para: ${formatarNomeWaitlabel(waitlabel)}`);
    })
    .withFailureHandler(function(error) {
      console.error("‚ùå Erro ao salvar waitlabel:", error);
      showMessage('error', '‚ùå Erro ao alterar waitlabel');
    })
    .setWaitlabelAtual(waitlabel);
}

function atualizarInterfaceWaitlabel() {
  const header = document.querySelector('.header');
  const cor = WAITLABELS_CONFIG.CORES[waitlabelAtual] || '#7E3E9A';
  header.style.background = cor;
  
  const titulo = document.getElementById('tituloCadastros');
  if (titulo) {
    titulo.textContent = `Cadastros - ${formatarNomeWaitlabel(waitlabelAtual)}`;
  }
  
  console.log("üé® Interface atualizada para waitlabel:", waitlabelAtual);
}

// üî• FUN√á√ïES PARA "APLICAR A TODOS"
function toggleCampoParaTodos(campoId) {
    console.log("üéØ Toggle campo para aplicar a todos:", campoId);
    
    const campoParaAplicar = campoId === 'inputEventoSearch' ? 'evento' : campoId;
    
    camposParaAplicarATodos[campoParaAplicar] = !camposParaAplicarATodos[campoParaAplicar];
    
    const checkbox = document.querySelector(`[data-campo="${campoId}"]`);
    if (checkbox) {
        checkbox.checked = camposParaAplicarATodos[campoParaAplicar];
    }
    
    console.log("üìã Campos selecionados para aplicar:", camposParaAplicarATodos);
}

// üî• FUN√á√ÉO MELHORADA PARA APLICAR A TODOS (SUBSTITUIR COMPLETAMENTE)
async function aplicarAlteracoesATodos() {
  console.log("üéØ [DEBUG] Bot√£o 'Aplicar a Todos' clicado");
  console.log("üìã Campos selecionados:", camposParaAplicarATodos);
  console.log("üéØ Aplicando altera√ß√µes a todos do mesmo CNPJ...");
  
  const btnAplicar = document.getElementById('btnAplicarATodos');
  if (btnAplicar && btnAplicar.disabled) {
    console.log("‚è≥ Bot√£o j√° est√° processando, aguarde...");
    return;
  }
  
  // Desabilitar bot√£o durante o processamento
  if (btnAplicar) {
    btnAplicar.disabled = true;
    btnAplicar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aplicando...';
  }
  
  const camposSelecionados = Object.keys(camposParaAplicarATodos).filter(campo => camposParaAplicarATodos[campo]);
  
  if (camposSelecionados.length === 0) {
    showMessage('error', '‚ùå Selecione pelo menos um campo para aplicar a todos!');
    if (btnAplicar) {
      btnAplicar.disabled = false;
      btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
    }
    return;
  }
  
  const dadosAtuais = coletarDadosFormulario();
  if (!dadosAtuais) {
    showMessage('error', '‚ùå Erro ao coletar dados do formul√°rio');
    if (btnAplicar) {
      btnAplicar.disabled = false;
      btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
    }
    return;
  }
  
  const cnpjCorreto = document.getElementById('cnpj_cadastro')?.value || dadosAtuais.cnpj;
  
  if (!cnpjCorreto) {
    showMessage('error', '‚ùå CNPJ n√£o identificado!');
    if (btnAplicar) {
      btnAplicar.disabled = false;
      btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
    }
    return;
  }
  
  // üî• AGORA USANDO A NOVA FUN√á√ÉO COM DELAY
  mostrarPopupAplicarTodosMelhorado(cnpjCorreto, camposSelecionados, dadosAtuais);
}

function mostrarPopupAplicarTodos(cnpj, camposSelecionados, dados) {
    const formatarValorParaPopup = (campo, valor) => {
        if (campo === 'ativacao' && valor && valor !== 'N√£o preenchido') {
            if (valor.includes('-')) {
                const partes = valor.split('-');
                if (partes.length === 3) {
                    return `${partes[2]}/${partes[1]}/${partes[0]}`;
                }
            }
            return valor;
        }
        
        if ((campo === 'mensalidade' || campo === 'adesao') && valor && valor !== 'N√£o preenchido') {
            if (typeof valor === 'number' || !isNaN(parseFloat(valor))) {
                const numero = parseFloat(valor);
                return numero.toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                });
            } else if (typeof valor === 'string') {
                const numeroMatch = valor.match(/[\d,\.]+/);
                if (numeroMatch) {
                    const numero = parseFloat(numeroMatch[0].replace(/\./g, '').replace(',', '.'));
                    if (!isNaN(numero)) {
                        return numero.toLocaleString('pt-BR', {
                            style: 'currency',
                            currency: 'BRL'
                        });
                    }
                }
            }
        }
        
        if (campo === 'evento' && valor && valor !== 'N√£o preenchido') {
            return valor.charAt(0).toUpperCase() + valor.slice(1).toLowerCase();
        }
        
        return valor;
    };

    const modalHTML = `
        <div id="modalAplicarTodos" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:9999; font-family: 'Segoe UI', Arial, sans-serif;">
            <div style="background:linear-gradient(135deg, #ffffff 0%, #f8f6ff 100%); padding:20px; border-radius:12px; width:400px; box-shadow:0 8px 25px rgba(0,0,0,0.25); border:2px solid #8B5FBF; position:relative;">
                <div style="background:linear-gradient(135deg, #8B5FBF 0%, #6A4C9C 100%); color:white; padding:12px; margin:-20px -20px 15px -20px; border-radius:10px 10px 0 0; text-align:center;">
                    <h3 style="margin:0; font-size:18px; font-weight:600;">üéØ Aplicar Altera√ß√µes em Lote</h3>
                </div>
                
                <div style="margin-bottom:15px;">
                    <div style="display:flex; align-items:center; margin-bottom:8px;">
                        <span style="background:#8B5FBF; color:white; padding:4px 8px; border-radius:15px; font-size:11px; font-weight:bold;">üìã CNPJ</span>
                        <span style="margin-left:8px; font-weight:600; color:#333;">${cnpj}</span>
                    </div>
                    
                    <div style="display:flex; align-items:center; margin-bottom:12px;">
                        <span style="background:#8B5FBF; color:white; padding:4px 8px; border-radius:15px; font-size:11px; font-weight:bold;">üè¢ Registros</span>
                        <span style="margin-left:8px; color:#666;">Todos com este CNPJ</span>
                    </div>
                </div>
                
                <div style="background:#f0ebfa; padding:12px; border-radius:8px; margin-bottom:15px; border-left:3px solid #8B5FBF;">
                    <div style="display:flex; align-items:center; margin-bottom:8px;">
                        <span style="color:#8B5FBF; font-weight:bold; font-size:14px;">üìù Campos Selecionados</span>
                    </div>
                    <div style="max-height:120px; overflow-y:auto;">
                      ${camposSelecionados.map(campo => {
                          const nomeCampo = formatarNomeCampoPopup(campo);
                          let valorCampo = dados[campo] || document.getElementById(campo)?.value || 'N√£o preenchido';
                          valorCampo = formatarValorParaPopup(campo, valorCampo);
                          return `
                              <div style="display:flex; justify-content:space-between; align-items:center; padding:6px 4px; border-bottom:1px solid #e0e0e0;">
                                  <span style="color:#555; font-weight:500;">${nomeCampo}</span>
                                  <span style="background:#8B5FBF; color:white; padding:3px 6px; border-radius:10px; font-size:11px; font-weight:bold;">${valorCampo}</span>
                              </div>
                          `;
                      }).join('')}
                    </div>
                </div>
                
                <div style="background:#fff3cd; border:2px solid #ffc107; padding:10px; border-radius:6px; margin-bottom:15px; display:flex; align-items:center;">
                    <span style="color:#856404; font-size:20px; margin-right:8px;">‚ö†Ô∏è</span>
                    <span style="color:#856404; font-size:12px; font-weight:500;">Esta a√ß√£o atualizar√° TODOS os registros e n√£o pode ser desfeita</span>
                </div>
                
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button onclick="fecharPopupAplicarTodos(false)" style="padding:10px 16px; border:2px solid #6c757d; background:white; color:#6c757d; border-radius:6px; cursor:pointer; font-weight:600; transition:all 0.3s; display:flex; align-items:center; gap:4px;">
                        <span>‚úñ</span> Cancelar
                    </button>
                    <button onclick="fecharPopupAplicarTodos(true)" style="padding:10px 20px; background:linear-gradient(135deg, #28a745 0%, #20c997 100%); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition:all 0.3s; display:flex; align-items:center; gap:4px; box-shadow:0 3px 10px rgba(40, 167, 69, 0.25);">
                        <span>‚úÖ</span> Aplicar a Todos
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

const formatarNomeCampoPopup = (campo) => {
    const nomes = {
        'razao_social': 'Raz√£o Social',
        'nome_fantasia': 'Nome Fantasia', 
        'cnpj_cadastro': 'CNPJ',
        'contrato_enviado': 'Contrato Enviado',
        'contrato_assinado': 'Contrato Assinado',
        'ativacao': 'Ativa√ß√£o',
        'link': 'Link',
        'mensalidade': 'Mensalidade',
        'adesao': 'Ades√£o',
        'situacao': 'Situa√ß√£o',
        'evento': 'Evento',
        'observacoes': 'Observa√ß√µes',
        'inputEventoSearch': 'Evento'
    };
    
    return nomes[campo] || campo;
};

// üî• POPUP MELHORADO COM INFORMA√á√ïES DE SEGURAN√áA (FUN√á√ÉO NOVA)
function mostrarPopupAplicarTodosMelhorado(cnpj, camposSelecionados, dados) {
    const formatarValorParaPopup = (campo, valor) => {
        if (campo === 'ativacao' && valor && valor !== 'N√£o preenchido') {
            if (valor.includes('-')) {
                const partes = valor.split('-');
                if (partes.length === 3) {
                    return `${partes[2]}/${partes[1]}/${partes[0]}`;
                }
            }
            return valor;
        }
        
        if ((campo === 'mensalidade' || campo === 'adesao') && valor && valor !== 'N√£o preenchido') {
            if (typeof valor === 'number' || !isNaN(parseFloat(valor))) {
                const numero = parseFloat(valor);
                return numero.toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                });
            } else if (typeof valor === 'string') {
                const numeroMatch = valor.match(/[\d,\.]+/);
                if (numeroMatch) {
                    const numero = parseFloat(numeroMatch[0].replace(/\./g, '').replace(',', '.'));
                    if (!isNaN(numero)) {
                        return numero.toLocaleString('pt-BR', {
                            style: 'currency',
                            currency: 'BRL'
                        });
                    }
                }
            }
        }
        
        if (campo === 'evento' && valor && valor !== 'N√£o preenchido') {
            return valor.charAt(0).toUpperCase() + valor.slice(1).toLowerCase();
        }
        
        return valor;
    };

    const modalHTML = `
        <div id="modalAplicarTodos" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:9999; font-family: 'Segoe UI', Arial, sans-serif;">
            <div style="background:linear-gradient(135deg, #ffffff 0%, #f8f6ff 100%); padding:25px; border-radius:12px; width:450px; box-shadow:0 8px 25px rgba(0,0,0,0.25); border:2px solid #8B5FBF; position:relative;">
                <div style="background:linear-gradient(135deg, #8B5FBF 0%, #6A4C9C 100%); color:white; padding:15px; margin:-25px -25px 20px -25px; border-radius:10px 10px 0 0; text-align:center;">
                    <h3 style="margin:0; font-size:18px; font-weight:600;">üéØ Aplicar Altera√ß√µes em Lote</h3>
                </div>
                
                <div style="margin-bottom:15px;">
                    <div style="display:flex; align-items:center; margin-bottom:8px;">
                        <span style="background:#8B5FBF; color:white; padding:4px 8px; border-radius:15px; font-size:11px; font-weight:bold;">üìã CNPJ</span>
                        <span style="margin-left:8px; font-weight:600; color:#333; font-family: monospace;">${cnpj}</span>
                    </div>
                    
                    <div style="display:flex; align-items:center; margin-bottom:12px;">
                        <span style="background:#8B5FBF; color:white; padding:4px 8px; border-radius:15px; font-size:11px; font-weight:bold;">üè¢ Registros</span>
                        <span style="margin-left:8px; color:#666;">Todos com este CNPJ</span>
                    </div>
                </div>
                
                <div style="background:#f0ebfa; padding:15px; border-radius:8px; margin-bottom:15px; border-left:3px solid #8B5FBF;">
                    <div style="display:flex; align-items:center; margin-bottom:10px;">
                        <span style="color:#8B5FBF; font-weight:bold; font-size:14px;">üìù Campos Selecionados (${camposSelecionados.length})</span>
                    </div>
                    <div style="max-height:120px; overflow-y:auto;">
                      ${camposSelecionados.map(campo => {
                          const nomeCampo = formatarNomeCampoPopup(campo);
                          let valorCampo = dados[campo] || document.getElementById(campo)?.value || 'N√£o preenchido';
                          valorCampo = formatarValorParaPopup(campo, valorCampo);
                          return `
                              <div style="display:flex; justify-content:space-between; align-items:center; padding:6px 4px; border-bottom:1px solid #e0e0e0;">
                                  <span style="color:#555; font-weight:500;">${nomeCampo}</span>
                                  <span style="background:#8B5FBF; color:white; padding:3px 8px; border-radius:10px; font-size:11px; font-weight:bold; max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${valorCampo}</span>
                              </div>
                          `;
                      }).join('')}
                    </div>
                </div>
                
                <!-- üî• NOVA SE√á√ÉO: INFORMA√á√ïES DE SEGURAN√áA -->
                <div style="background:#e8f4fd; border:2px solid #2196F3; padding:12px; border-radius:6px; margin-bottom:15px;">
                    <div style="display:flex; align-items:flex-start; gap:10px;">
                        <span style="color:#2196F3; font-size:18px;">‚è∞</span>
                        <div>
                            <div style="color:#0c5460; font-weight:600; font-size:13px;">Processamento Seguro</div>
                            <div style="color:#0c5460; font-size:11px; margin-top:4px;">
                                ‚Ä¢ Delay entre requisi√ß√µes: 1 segundo<br>
                                ‚Ä¢ Processamento sequencial<br>
                                ‚Ä¢ Preven√ß√£o de erro 429
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="background:#fff3cd; border:2px solid #ffc107; padding:12px; border-radius:6px; margin-bottom:20px; display:flex; align-items:flex-start; gap:10px;">
                    <span style="color:#856404; font-size:18px; margin-top:2px;">‚ö†Ô∏è</span>
                    <div>
                        <div style="color:#856404; font-weight:600; font-size:13px;">Aten√ß√£o</div>
                        <div style="color:#856404; font-size:11px; margin-top:4px;">
                            Esta a√ß√£o atualizar√° TODOS os registros com este CNPJ e n√£o pode ser desfeita.
                        </div>
                    </div>
                </div>
                
                <div style="display:flex; gap:12px; justify-content:flex-end;">
                    <button onclick="fecharPopupAplicarTodos(false)" style="padding:10px 20px; border:2px solid #6c757d; background:white; color:#6c757d; border-radius:6px; cursor:pointer; font-weight:600; transition:all 0.3s; display:flex; align-items:center; gap:6px; min-width:100px; justify-content:center;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button onclick="processarAplicarATodosComDelay()" style="padding:10px 20px; background:linear-gradient(135deg, #28a745 0%, #20c997 100%); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition:all 0.3s; display:flex; align-items:center; gap:6px; min-width:120px; justify-content:center; box-shadow:0 3px 10px rgba(40, 167, 69, 0.25);">
                        <i class="fas fa-play"></i> Iniciar
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // üî• ARMAZENAR DADOS PARA USO POSTERIOR
    window.dadosAplicarTodos = {
        cnpj: cnpj,
        campos: camposSelecionados,
        dados: dados
    };
}

// üî• FUN√á√ÉO PRINCIPAL MELHORADA COM DELAY (FUN√á√ÉO NOVA)
async function processarAplicarATodosComDelay() {
    const modal = document.getElementById('modalAplicarTodos');
    if (modal) modal.remove();
    
    const { cnpj, campos, dados } = window.dadosAplicarTodos;
    const btnAplicar = document.getElementById('btnAplicarATodos');
    
    console.log("üöÄ INICIANDO PROCESSAMENTO COM DELAY...");
    showLoading(`Aplicando ${campos.length} campo(s) a todos os registros...`, "Processamento seguro com delay entre requisi√ß√µes");
    
    try {
        // üî• CHAMADA √öNICA PARA O GOOGLE APPS SCRIPT
        console.log("üì§ Enviando requisi√ß√£o √∫nica para o Google Apps Script...");
        
        google.script.run
            .withSuccessHandler(function(res) {
                console.log("‚úÖ RESPOSTA DO GS:", res);
                hideLoading();
                
                if (btnAplicar) {
                    btnAplicar.disabled = false;
                    btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
                }
                
                if (res && res.success) {
                    showMessage('success', `‚úÖ ${res.registrosAtualizados} registro(s) atualizado(s) com sucesso!`);
                    limparSelecaoAplicarATodos();
                    
                    // Recarregar a lista se estiver vis√≠vel
                    if (document.getElementById('secaoCadastros').style.display === 'block') {
                        setTimeout(() => {
                            mostrarTodosCadastros();
                        }, 1000);
                    }
                } else {
                    showMessage('error', '‚ùå ' + (res ? res.message : 'Erro ao aplicar altera√ß√µes'));
                }
            })
            .withFailureHandler(function(error) {
                console.error("‚ùå ERRO DO GS:", error);
                hideLoading();
                
                if (btnAplicar) {
                    btnAplicar.disabled = false;
                    btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
                }
                
                // üî• TRATAMENTO ESPEC√çFICO PARA ERRO 429
                if (error.message && error.message.includes('429')) {
                    showMessage('error', '‚ùå Muitas requisi√ß√µes simult√¢neas. Aguarde alguns segundos e tente novamente.');
                } else {
                    showMessage('error', '‚ùå Erro: ' + error.message);
                }
            })
            .aplicarAlteracoesATodos(cnpj, dados, campos);
            
    } catch (error) {
        console.error("‚ùå ERRO NO PROCESSAMENTO:", error);
        hideLoading();
        
        if (btnAplicar) {
            btnAplicar.disabled = false;
            btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
        }
        
        showMessage('error', '‚ùå Erro cr√≠tico: ' + error.message);
    }
}

function fecharPopupAplicarTodos(confirmado) {
    const modal = document.getElementById('modalAplicarTodos');
    if (modal) modal.remove();
    
    if (confirmado) {
        const btnAplicar = document.getElementById('btnAplicarATodos');
        const camposSelecionados = Object.keys(camposParaAplicarATodos).filter(campo => camposParaAplicarATodos[campo]);
        const dadosAtuais = coletarDadosFormulario();
        const cnpjCorreto = document.getElementById('cnpj_cadastro')?.value || dadosAtuais.cnpj;
        
        console.log("üöÄ CHAMANDO GOOGLE APPS SCRIPT...");
        showLoading(`Aplicando altera√ß√µes para ${camposSelecionados.length} campo(s)...`, "Atualizando todos os registros do mesmo CNPJ");
        
        google.script.run
            .withSuccessHandler(function(res) {
                console.log("‚úÖ RESPOSTA DO GS:", res);
                hideLoading();
                
                if (btnAplicar) {
                    btnAplicar.disabled = false;
                    btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
                }
                
                if (res && res.success) {
                    showMessage('success', `‚úÖ ${res.registrosAtualizados} registro(s) atualizado(s) com sucesso!`);
                    limparSelecaoAplicarATodos();
                    if (document.getElementById('secaoCadastros').style.display === 'block') {
                        mostrarTodosCadastros();
                    }
                } else {
                    showMessage('error', '‚ùå ' + (res ? res.message : 'Erro ao aplicar altera√ß√µes'));
                }
            })
            .withFailureHandler(function(error) {
                console.error("‚ùå ERRO DO GS:", error);
                hideLoading();
                
                if (btnAplicar) {
                    btnAplicar.disabled = false;
                    btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
                }
                
                showMessage('error', '‚ùå Erro: ' + error.message);
            })
            .aplicarAlteracoesATodos(cnpjCorreto, dadosAtuais, camposSelecionados);
    } else {
        const btnAplicar = document.getElementById('btnAplicarATodos');
        if (btnAplicar) {
            btnAplicar.disabled = false;
            btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
        }
    }
}

function limparSelecaoAplicarATodos() {
    camposParaAplicarATodos = {};
    cnpjAtualParaAplicar = null;
    
    document.querySelectorAll('[data-campo]').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    const btnAplicar = document.getElementById('btnAplicarATodos');
    if (btnAplicar) {
        btnAplicar.style.display = 'none';
    }
    
    document.querySelectorAll('.checkbox-aplicar-todos').forEach(checkbox => {
        checkbox.remove();
    });
    
    const titulo = document.getElementById('tituloAplicarTodos');
    if (titulo) {
        titulo.style.display = 'none';
        titulo.innerHTML = '';
    }
    
    document.getElementById('cardCadastro').classList.remove('modo-aplicar-todos');
}

function configurarAplicarATodos(cnpj, id) {
    console.log("üéØ CONFIGURANDO APLICAR A TODOS - CNPJ:", cnpj, "ID:", id);
    
    fecharModalDetalhes();
    
    editarCadastroModal(id);
    
    setTimeout(() => {
        cnpjAtualParaAplicar = cnpj;
        cadastroAtualId = id;
        
        mostrarInterfaceAplicarATodos();
        
        showMessage('info', 'üéØ Modo "Aplicar a Todos" ativado! Selecione os campos que deseja aplicar.');
    }, 1000);
}

function mostrarInterfaceAplicarATodos() {
    adicionarCheckboxesAosCampos();
    
    mostrarBotaoAplicarATodos();
    
    const titulo = document.getElementById('tituloAplicarTodos');
    if (titulo) {
        titulo.style.display = 'block';
        titulo.innerHTML = `
            <div style="background: linear-gradient(135deg, #FF6B35 0%, #FF8E35 100%); color: white; padding: 8px 12px; border-radius: 6px; margin-top: 8px; text-align: center;">
                <i class="fas fa-copy"></i> <strong>MODO APLICAR A TODOS</strong> - CNPJ: ${cnpjAtualParaAplicar}
                <br><small>Selecione os campos que deseja aplicar a todos os registros deste CNPJ</small>
            </div>
        `;
    }
    
    document.getElementById('cardCadastro').classList.add('modo-aplicar-todos');
}

function adicionarCheckboxesAosCampos() {
  const camposAplicaveis = [
    'razao_social', 'nome_fantasia','contrato_enviado', 
    'contrato_assinado', 'ativacao', 'link', 'mensalidade', 
    'mensalidade_sim', 'adesao', 'situacao', 'inputEventoSearch'
  ];
    
    camposAplicaveis.forEach(campoId => {
        const campoElement = document.getElementById(campoId);
        if (campoElement) {
            const formGroup = campoElement.closest('.form-group');
            if (formGroup && !formGroup.querySelector('.checkbox-aplicar-todos')) {
                const checkboxHtml = `
                    <div class="checkbox-aplicar-todos">
                        <input type="checkbox" id="check_${campoId}" data-campo="${campoId}" 
                               onchange="toggleCampoParaTodos('${campoId}')">
                        <label for="check_${campoId}">
                            <i class="fas fa-copy"></i> Aplicar este campo a todos
                        </label>
                    </div>
                `;
                formGroup.insertAdjacentHTML('beforeend', checkboxHtml);
            }
        }
    });
}

function mostrarBotaoAplicarATodos() {
    const btnAplicar = document.getElementById('btnAplicarATodos');
    if (btnAplicar) {
        btnAplicar.style.display = 'block';
    }
}

// üî• MANTENDO TODAS AS OUTRAS FUN√á√ïES ORIGINAIS
// (As fun√ß√µes originais de cadastro, atualiza√ß√£o, valida√ß√£o, etc. permanecem intactas)

function cadastrar() {
  console.log("üéØ [DEBUG] Bot√£o 'Cadastrar' clicado");
  console.log("üìù Iniciando processo de cadastro...");
  console.log("üéØ CADASTRAR: Iniciando cadastro no waitlabel:", waitlabelAtual);
  
  const camposInvalidos = validarCamposObrigatorios();
  if (camposInvalidos.length > 0) {
    showMessage('error', `‚ùå Preencha os campos obrigat√≥rios: ${camposInvalidos.join(', ')}`);
    return;
  }

  const fornecedoresSelecionados = document.querySelectorAll('input[name="fornecedor"]:checked');
  if (fornecedoresSelecionados.length === 0) {
    showMessage('error', '‚ùå Selecione pelo menos um fornecedor!');
    return;
  }

  const dadosBase = coletarDadosFormulario();
  if (!dadosBase) {
    showMessage('error', '‚ùå Erro ao coletar dados do formul√°rio');
    return;
  }

  console.log("üî¢ Fornecedores selecionados:", dadosBase.fornecedores.length);
  console.log("üìã Lista de fornecedores:", dadosBase.fornecedores);

  dadosBase.evento = "Novo cadastro";
  dadosBase.acao = 'cadastrar';

  showLoading(`Cadastrando loja ${dadosBase.razao_social}...`, `Processando ${dadosBase.fornecedores.length} fornecedor(es)`);

  const btnCadastrar = document.getElementById('btnCadastrar');
  btnCadastrar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cadastrando...';
  btnCadastrar.disabled = true;

  google.script.run
    .withSuccessHandler(function(res) {
      // üî• ADICIONE ESTE CONSOLE AQUI:
      console.log("‚úÖ [SUCESSO] Cadastro realizado com sucesso:", res);
      
      console.log("‚úÖ Resposta do cadastro MULTIPLO:", res);
      hideLoading();
      
      btnCadastrar.innerHTML = '<i class="fas fa-plus-circle"></i> Cadastrar';
      btnCadastrar.disabled = false;
      
      if (res.success) {
        showMessage('success', `‚úÖ ${res.message} - ${res.registrosCriados} registro(s) criado(s)`);
        limparFormulario();
      } else {
        showMessage('error', '‚ùå ' + res.message);
      }
    })
    .withFailureHandler(function(error) {
      // üî• ADICIONE ESTE CONSOLE AQUI:
      console.error("‚ùå [ERRO] Falha no cadastro:", error);
      
      console.error("‚ùå Erro no cadastro:", error);
      hideLoading();
      
      btnCadastrar.innerHTML = '<i class="fas fa-plus-circle"></i> Cadastrar';
      btnCadastrar.disabled = false;
      showMessage('error', '‚ùå Erro: ' + error.message);
    })
    .processarCadastroComWaitlabel(dadosBase, waitlabelAtual);
}

function atualizar() {
  console.log("üéØ [DEBUG] Bot√£o 'Atualizar' clicado");
  console.log("‚úèÔ∏è Iniciando atualiza√ß√£o do ID:", cadastroAtualId);
  console.log("üéØ ATUALIZAR: Iniciando atualiza√ß√£o no waitlabel:", waitlabelAtual);
  
  console.log("üîç DEBUG 1: cadastroAtualId =", cadastroAtualId);
  
  if (!cadastroAtualId) {
    showMessage('error', '‚ùå Nenhum cadastro selecionado para atualizar!');
    return;
  }

  const camposInvalidos = validarCamposObrigatorios();
  console.log("üîç DEBUG 2: Campos inv√°lidos:", camposInvalidos);
  
  if (camposInvalidos.length > 0) {
    showMessage('error', `‚ùå Preencha os campos obrigat√≥rios: ${camposInvalidos.join(', ')}`);
    return;
  }

  const fornecedoresSelecionados = document.querySelectorAll('input[name="fornecedor"]:checked');
  console.log("üîç DEBUG 3: Fornecedores selecionados:", fornecedoresSelecionados.length);
  
  if (fornecedoresSelecionados.length === 0) {
    showMessage('error', '‚ùå Selecione pelo menos um fornecedor!');
    return;
  }

  console.log("üîç DEBUG 4: Chamando coletarDadosFormulario()...");
  const dados = coletarDadosFormulario();
  console.log("üîç DEBUG 5: Dados coletados:", dados);
  
  if (!dados) {
    showMessage('error', '‚ùå Erro ao coletar dados do formul√°rio');
    return;
  }
  
  dados.acao = 'atualizar';
  dados.id = cadastroAtualId;
  
  console.log("üì§ Dados para atualiza√ß√£o:", dados);

    // üî• SUBSTITUA A LINHA ANTIGA POR ESTA:
  showLoading(`Atualizando loja ${dados.razao_social}...`, `Processando altera√ß√µes nos dados`);

  const btnAtualizar = document.getElementById('btnAtualizar');
  const btnOriginalHTML = btnAtualizar.innerHTML;
  btnAtualizar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
  btnAtualizar.disabled = true;

  console.log("üîç DEBUG 6: Chamando Google Apps Script...");

  google.script.run
    .withSuccessHandler(function(res) {
      console.log("‚úÖ [SUCESSO] Atualiza√ß√£o realizada com sucesso:", res);
      
      console.log("‚úÖ DEBUG 7: Resposta da atualiza√ß√£o:", res);
      hideLoading();
      
      btnAtualizar.innerHTML = btnOriginalHTML;
      btnAtualizar.disabled = false;
      
      if (res && res.success) {
        showMessage('success', '‚úÖ ' + res.message);
        
        if (document.getElementById('secaoCadastros').style.display === 'block') {
          mostrarTodosCadastros();
        }
        
        limparFormulario();
      } else {
        showMessage('error', '‚ùå ' + (res ? res.message : 'Resposta inv√°lida do servidor'));
      }
    })
    .withFailureHandler(function(error) {
      console.error("‚ùå [ERRO] Falha na atualiza√ß√£o:", error);
      
      console.error("‚ùå DEBUG 8: Erro na atualiza√ß√£o:", error);
      hideLoading();
      
      btnAtualizar.innerHTML = btnOriginalHTML;
      btnAtualizar.disabled = false;
      showMessage('error', '‚ùå Erro ao atualizar: ' + error.message);
    })
    .processarCadastroComWaitlabel(dados, waitlabelAtual);
}

function mostrarTodosCadastros() {
  console.log("üéØ [DEBUG] Bot√£o 'Ver Todos os Cadastros' clicado");
  console.log("üîÑ Carregando dados do waitlabel:", waitlabelAtual);

  // üî• ADICIONE ESTAS 2 LINHAS AQUI:
  showLoading(`Carregando dados da loja ${formatarNomeWaitlabel(waitlabelAtual)}...`, "Buscando todos os cadastros");
  
  const loading = document.getElementById('loadingCadastros');
  
  showLoading(`Carregando cadastros do ${formatarNomeWaitlabel(waitlabelAtual)}...`, "Buscando todos os registros");
  
  
  const tableContainer = document.getElementById('tableContainer');
  const filtrosContainer = document.getElementById('filtrosContainer');
  const secao = document.getElementById('secaoCadastros');

  loading.style.display = 'flex';
  tableContainer.style.display = 'none';
  filtrosContainer.style.display = 'none';
  secao.style.display = 'block';

  limparTodosFiltros();

  google.script.run
    .withSuccessHandler(function(cadastros) {
      console.log("‚úÖ [SUCESSO] Cadastros carregados:", cadastros?.length || 0, "registros");
      
      hideLoading();
      
      console.log("‚úÖ Cadastros recebidos:", cadastros);
      
      if (cadastros && cadastros.length > 0) {
        todosCadastros = cadastros;
        cadastrosFiltrados = [...cadastros];
        
        // üî• DEFINIR ORDENA√á√ÉO POR RAZ√ÉO SOCIAL POR PADR√ÉO
        document.getElementById('ordenacaoCadastros').value = 'razao_social';
        
        // üî• CHAMAR A FUN√á√ÉO DE ORDENA√á√ÉO PARA APLICAR O PADR√ÉO
        ordenarCadastros();
        
        document.getElementById('filtrosContainer').style.display = 'flex';
        
        showMessage('success', `‚úÖ ${cadastros.length} cadastros carregados do ${formatarNomeWaitlabel(waitlabelAtual)}!`);
      } else {
        loading.style.display = 'none';
        tableContainer.style.display = 'block';
        document.getElementById('tabelaCadastrosBody').innerHTML = `
          <tr>
            <td colspan="9" style="text-align: center; padding: 30px;">
              <i class="fas fa-inbox" style="font-size: 2.5rem; color: var(--gray); margin-bottom: 12px;"></i>
              <h3>Nenhum cadastro encontrado</h3>
              <p>N√£o h√° cadastros no waitlabel ${formatarNomeWaitlabel(waitlabelAtual)}.</p>
            </td>
          </tr>
        `;
        showMessage('info', `üìù Nenhum cadastro encontrado no ${formatarNomeWaitlabel(waitlabelAtual)}.`);
      }
    })
    .withFailureHandler(function(error) {
      console.error("‚ùå [ERRO] Falha ao carregar cadastros:", error);
      
      hideLoading();
      
      console.error("‚ùå Erro ao carregar cadastros:", error);
      loading.style.display = 'none';
      showMessage('error', '‚ùå Erro ao carregar cadastros: ' + error.message);
    })
    .buscarTodosCadastrosComWaitlabel(waitlabelAtual);
}

function formatarMoeda(input) {
  let value = input.value.replace(/\D/g, '');
  value = (value / 100).toFixed(2);
  value = value.replace('.', ',');
  value = value.replace(/(\d)(?=(\d{3})+\,)/g, "$1.");
  input.value = 'R$ ' + value;
}

function formatarMoedaParaInput(valor) {
  if (!valor) return 'R$ 0,00';
  const numero = typeof valor === 'number' ? valor : parseFloat(valor);
  return 'R$ ' + numero.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
}

function showMessage(type, text) {
  const successEl = document.getElementById('messageSuccess');
  const errorEl = document.getElementById('messageError');
  const infoEl = document.getElementById('messageInfo');

  successEl.style.display = 'none';
  errorEl.style.display = 'none';
  infoEl.style.display = 'none';

  if (type === 'success') {
    successEl.querySelector('span').textContent = text;
    successEl.style.display = 'flex';
  } else if (type === 'error') {
    errorEl.querySelector('span').textContent = text;
    errorEl.style.display = 'flex';
  } else if (type === 'info') {
    infoEl.querySelector('span').textContent = text;
    infoEl.style.display = 'flex';
  }

  setTimeout(() => {
    successEl.style.display = 'none';
    errorEl.style.display = 'none';
    infoEl.style.display = 'none';
  }, 5000);
}

function padronizarNomeFornecedor(nome) {
  if (!nome) return '';
  
  const fornecedoresPadronizados = {
    'agil': 'AGIL',
    'bc': 'BC', 
    'parcelex': 'PARCELEX',
    'agoracred': 'AGORACRED',
    'afinz': 'AFINZ'
  };
  
  const nomeLower = nome.toLowerCase();
  return fornecedoresPadronizados[nomeLower] || nome.toUpperCase();
}

function coletarDadosFormulario() {
  console.log("üîç COLETANDO DADOS - INICIANDO");
  
  try {
    const razaoSocial = document.getElementById('razao_social').value.trim();
    const cnpj = document.getElementById('cnpj_cadastro').value.trim();
    
    if (!razaoSocial || !cnpj) {
      showMessage('error', '‚ùå Raz√£o Social e CNPJ s√£o obrigat√≥rios!');
      return null;
    }

    const cnpjInput = document.getElementById('cnpj_cadastro');
    const cnpjFormatado = cnpjInput.value;

    let adesaoValue = document.getElementById('adesao').value;
    console.log("üí∞ Ades√£o original:", adesaoValue);

    if (adesaoValue === 'R$ 0,00' || adesaoValue === '0,00' || adesaoValue === '0' || adesaoValue === 'R$ 0') {
      adesaoValue = 0;
      console.log("‚úÖ Ades√£o definida como isenta (0)");
    } else {
      adesaoValue = converterMoedaParaNumero(adesaoValue);
      console.log("‚úÖ Ades√£o convertida para n√∫mero:", adesaoValue);
    }
    console.log("üéØüéØüéØ ADES√ÉO FINAL PARA ENVIO:", adesaoValue, "Tipo:", typeof adesaoValue);

    const eventoValue = document.getElementById('inputEventoSearch').value || 
                       document.getElementById('evento').value || '';
    console.log("‚úÖ Evento coletado:", eventoValue);

    const checkboxesFornecedores = document.querySelectorAll('input[name="fornecedor"]:checked');
    const fornecedoresComConfiguracoes = [];

    if (checkboxesFornecedores.length === 0) {
      showMessage('error', '‚ùå Selecione pelo menos um fornecedor!');
      return null;
    }

    checkboxesFornecedores.forEach(checkbox => {
      const fornecedorNome = checkbox.value;
      const fornecedorPadronizado = padronizarNomeFornecedor(fornecedorNome);
      const fornecedorId = fornecedorNome.toLowerCase();
      
      const configDiv = document.getElementById(`config-${fornecedorId}`);
      if (!configDiv || configDiv.style.display !== 'grid') {
        console.warn(`‚ùå Fornecedor ${fornecedorNome} n√£o tem configura√ß√£o ativa!`);
        return;
      }
      
      const tarifaRadio = document.querySelector(`input[name="tarifa_${fornecedorId}"]:checked`);
      const percentualInput = document.querySelector(`input[name="percentual_${fornecedorId}"]`);
      
      let tarifaSelecionada = tarifaRadio ? tarifaRadio.value : 'MDR';
      let percentualSelecionado = percentualInput ? percentualInput.value : '0%';

      console.log("üî• VALOR DO INPUT:", percentualSelecionado);
      
      if (!tarifaRadio) {
        const radioMDR = document.querySelector(`input[name="tarifa_${fornecedorId}"][value="MDR"]`);
        if (radioMDR) {
          radioMDR.checked = true;
          console.log(`‚úÖ MDR selecionado automaticamente para ${fornecedorNome}`);
        }
      }
      
      let percentualNumerico = converterPercentualParaNumero(percentualSelecionado);

      fornecedoresComConfiguracoes.push({
          nome: fornecedorPadronizado,
          tarifa: tarifaSelecionada,
          percentual_tarifa: percentualNumerico,
          percentual_exibicao: percentualSelecionado
      });
    });

    const dados = {
      razao_social: razaoSocial,
      nome_fantasia: document.getElementById('nome_fantasia').value,
      cnpj: cnpjFormatado,
      adesao: adesaoValue,
      fornecedores: fornecedoresComConfiguracoes,
      fornecedor: fornecedoresComConfiguracoes.length > 0 ? fornecedoresComConfiguracoes[0].nome : '',
      tarifa: fornecedoresComConfiguracoes.length > 0 ? fornecedoresComConfiguracoes[0].tarifa : '',
      percentual_tarifa: fornecedoresComConfiguracoes.length > 0 ? fornecedoresComConfiguracoes[0].percentual_tarifa : '0%',
      observacoes: document.getElementById('observacoes').value,
      contrato_enviado: document.getElementById('contrato_enviado').value,
      contrato_assinado: document.getElementById('contrato_assinado').value,
      ativacao: document.getElementById('ativacao').value,
      link: document.getElementById('link').value,
      mensalidade: converterMoedaParaNumero(document.getElementById('mensalidade').value),
      mensalidade_sim: converterMoedaParaNumero(document.getElementById('mensalidade_sim').value),
      situacao: document.getElementById('situacao').value,
      evento: eventoValue
    };

    console.log("üì¶ DADOS FINAIS PARA ENVIO:", dados);
    return dados;

  } catch (error) {
    console.error("‚ùå ERRO CR√çTICO ao coletar dados:", error);
    showMessage('error', '‚ùå Erro interno ao processar formul√°rio');
    return null;
  }
}

function formatarPercentualParaExibicao(percentual) {
    if (!percentual && percentual !== 0) return '';
    
    console.log("üé® Formatando para exibi√ß√£o:", percentual, "Tipo:", typeof percentual);
    
    try {
        if (typeof percentual === 'string') {
            if (percentual.match(/^\d*\.?\d+$/)) {
                console.log("‚úÖ String num√©rica detectada, convertendo:", percentual);
                const numero = parseFloat(percentual);
                if (!isNaN(numero)) {
                    const valorFormatado = numero * 100;
                    const valorString = valorFormatado.toFixed(2);
                    const valorFinal = valorString.replace('.', ',') + '%';
                    console.log("‚úÖ String convertida:", percentual + " ‚Üí " + valorFinal);
                    return valorFinal;
                }
            }
            if (percentual.includes('%')) {
                console.log("‚úÖ Valor com % - retornando como est√°:", percentual);
                return percentual;
            }
            console.log("‚úÖ String sem % - adicionando %:", percentual + '%');
            return percentual + '%';
        }
        
        if (typeof percentual === 'number') {
            let valorFormatado = percentual * 100;
            const valorString = valorFormatado.toFixed(2);
            const valorFinal = valorString.replace('.', ',') + '%';
            console.log("‚úÖ N√∫mero convertido:", percentual + " ‚Üí " + valorFinal);
            return valorFinal;
        }
        
        return String(percentual);
        
    } catch (error) {
        console.error("‚ùå Erro ao formatar percentual:", error);
        return String(percentual || '');
    }
}

function converterPercentualParaNumero(valorInput) {
    if (!valorInput) return 0;
    console.log("üî¢ Convertendo para n√∫mero:", valorInput);
    
    try {
        let valor = valorInput.toString();
        valor = valor.replace('%', '').replace(/\s/g, '').trim();
        valor = valor.replace(',', '.');
        
        const numero = parseFloat(valor);
        
        if (isNaN(numero)) {
            console.log("‚ùå N√£o √© um n√∫mero v√°lido:", valorInput);
            return 0;
        }
        
        if (valorInput.toString().includes('%')) {
            const resultado = numero / 100;
            console.log("‚úÖ Convertido % para decimal:", valorInput, "‚Üí", resultado);
            return resultado;
        }
        
        console.log("‚úÖ J√° est√° em decimal:", valorInput, "‚Üí", numero);
        return numero;
        
    } catch (error) {
        console.error("‚ùå Erro ao converter percentual:", error);
        return 0;
    }
}

function validarPercentuais() {
    const inputsPercentual = document.querySelectorAll('input[name^="percentual_"]');
    let todosValidos = true;
    
    inputsPercentual.forEach(input => {
        if (input.closest('.fornecedor-item').style.display === 'grid') {
            const valor = input.value.trim();
            if (valor && !valor.match(/^\d+[,]?\d*%$/)) {
                input.style.borderColor = 'var(--danger)';
                todosValidos = false;
                console.log("‚ùå Percentual inv√°lido:", valor);
            } else {
                input.style.borderColor = '';
            }
        }
    });
    
    return todosValidos;
}

function toggleFornecedorConfig(checkbox, fornecedorId) {
  const configDiv = document.getElementById(`config-${fornecedorId}`);
  
  if (checkbox.checked) {
    configDiv.style.display = 'grid';
  } else {
    configDiv.style.display = 'none';
    const radios = configDiv.querySelectorAll('input[type="radio"]');
    radios.forEach(radio => radio.checked = false);
    const select = configDiv.querySelector('select');
    if (select) select.value = '0%';
  }
  
  atualizarTarifaPrincipal();
}

function atualizarTarifaPrincipal() {
  const checkboxesFornecedores = document.querySelectorAll('input[name="fornecedor"]:checked');
  if (checkboxesFornecedores.length > 0) {
    const primeiroFornecedor = checkboxesFornecedores[0].value.toLowerCase();
  }
}

function converterMoedaParaNumero(valorMoeda) {
  if (!valorMoeda) return 0;
  
  try {
    console.log("üî¢ CONVERTENDO MOEDA - Valor original:", valorMoeda, "Tipo:", typeof valorMoeda);
    
    if (typeof valorMoeda === 'number') {
      console.log("‚úÖ J√° √© n√∫mero, retornando:", valorMoeda);
      return valorMoeda;
    }
    
    if (typeof valorMoeda === 'string') {
      let valorLimpo = valorMoeda
        .replace('R$', '')
        .replace(/\./g, '')
        .replace(',', '.')
        .trim();
      
      console.log("üîß Valor limpo:", valorLimpo);
      
      const numero = parseFloat(valorLimpo);
      
      if (isNaN(numero)) {
        console.log("‚ùå N√£o √© um n√∫mero v√°lido:", valorLimpo);
        return 0;
      }
      
      console.log("‚úÖ N√∫mero convertido (SEM multiplica√ß√£o):", numero);
      return numero;
    }
    
    return parseFloat(valorMoeda) || 0;
    
  } catch (error) {
    console.error("‚ùå ERRO CR√çTICO ao converter moeda:", valorMoeda, error);
    return 0;
  }
}

function preencherDadosCadastro(dados) {
  console.log("üéØ PREENCHER DADOS CADASTRO: Iniciando CORRETAMENTE");
  console.log("üì¶ Dados recebidos:", dados);

  if (!dados.encontrado) {
    showMessage('error', '‚ùå ' + dados.mensagem);
    return;
  }

  try {
    preencherCampoSeExistir('razao_social', dados.razao_social);
    preencherCampoSeExistir('nome_fantasia', dados.nome_fantasia);
    preencherCampoSeExistir('cnpj_cadastro', dados.cnpj);
    preencherCampoSeExistir('observacoes', dados.observacoes);
    preencherCampoSeExistir('contrato_enviado', dados.contrato_enviado);
    preencherCampoSeExistir('contrato_assinado', dados.contrato_assinado);
    preencherCampoSeExistir('ativacao', dados.ativacao);
    preencherCampoSeExistir('link', dados.link);
    preencherCampoSeExistir('situacao', dados.situacao || 'NOVO REGISTRO');
    
    preencherCampoSeExistir('mensalidade', formatarMoedaParaInput(dados.mensalidade));
    preencherCampoSeExistir('mensalidade_sim', formatarMoedaParaInput(dados.mensalidade_sim));
    preencherCampoSeExistir('adesao', dados.adesao === 'Isento' || dados.adesao === 0 ? 'R$ 0,00' : formatarMoedaParaInput(dados.adesao));
    
    console.log("üéØ PREENCHENDO EVENTOS CORRETAMENTE:");
    console.log("Evento (deve ser TEXTO):", dados.evento);
    console.log("√öltimo Evento (deve ser DATA):", dados.ultimo_evento);
    
    preencherCampoSeExistir('inputEventoSearch', dados.evento);
    preencherCampoSeExistir('inputUltimoEvento', dados.ultimo_evento);
    
    preencherFornecedorComTarifas(dados);

    cadastroAtualId = dados.id;
    
    const btnCadastrar = document.getElementById('btnCadastrar');
    const btnAtualizar = document.getElementById('btnAtualizar');
    
    if (btnCadastrar) btnCadastrar.style.display = 'none';
    if (btnAtualizar) btnAtualizar.style.display = 'block';

    setTimeout(() => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 100);
    
    console.log("‚úÖ‚úÖ‚úÖ Formul√°rio preenchido COM SUCESSO!");
    showMessage('success', '‚úÖ Cadastro carregado para edi√ß√£o!');
    
  } catch (error) {
    console.error("‚ùå Erro ao preencher formul√°rio:", error);
    showMessage('error', '‚ùå Erro ao carregar cadastro: ' + error.message);
  }
}

function preencherCampoSeExistir(campoId, valor) {
  const campo = document.getElementById(campoId);
  if (campo) {
    campo.value = valor || '';
    console.log(`‚úÖ Campo ${campoId} preenchido:`, valor);
  } else {
    console.log(`‚ö†Ô∏è Campo ${campoId} n√£o encontrado no HTML`);
  }
}

function validarCamposObrigatorios() {
  console.log("üîç Validando campos obrigat√≥rios...");
  
  document.querySelectorAll('.campo-obrigatorio').forEach(campo => {
    campo.classList.remove('campo-obrigatorio');
  });

  let camposInvalidos = [];

  const isAtualizacao = cadastroAtualId !== null;
  
  console.log("üîç Modo:", isAtualizacao ? "ATUALIZA√á√ÉO" : "CADASTRO");

  const camposSempreObrigatorios = [
    { 
      id: 'razao_social', 
      nome: 'Raz√£o Social', 
      elemento: document.getElementById('razao_social'),
      tipo: 'text'
    },
    { 
      id: 'cnpj_cadastro', 
      nome: 'CNPJ', 
      elemento: document.getElementById('cnpj_cadastro'),
      tipo: 'text'
    },
    { 
      id: 'mensalidade', 
      nome: 'Mensalidade', 
      elemento: document.getElementById('mensalidade'),
      tipo: 'moeda'
    },
    { 
      id: 'situacao', 
      nome: 'Situa√ß√£o', 
      elemento: document.getElementById('situacao'),
      tipo: 'select'
    }
  ];

  const camposApenasCadastro = [
    { 
      id: 'contrato_enviado', 
      nome: 'Contrato Enviado', 
      elemento: document.getElementById('contrato_enviado'),
      tipo: 'select'
    },
    { 
      id: 'contrato_assinado', 
      nome: 'Contrato Assinado', 
      elemento: document.getElementById('contrato_assinado'),
      tipo: 'select'
    }
  ];

  let camposParaValidar = [...camposSempreObrigatorios];
  
  if (!isAtualizacao) {
    camposParaValidar = [...camposParaValidar, ...camposApenasCadastro];
  }

  for (const campo of camposParaValidar) {
    let valor = campo.elemento.value;
    let estaVazio = false;

    switch(campo.tipo) {
      case 'select':
        estaVazio = !valor || valor === '' || valor === '-- Selecione --';
        break;
      case 'moeda':
          estaVazio = !valor || valor.toString().trim() === '';
        break;
      default:
        estaVazio = !valor || valor.toString().trim() === '';
    }

    if (estaVazio) {
      campo.elemento.classList.add('campo-obrigatorio');
      camposInvalidos.push(campo.nome);
      
      if (camposInvalidos.length === 1) {
        campo.elemento.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  }

  console.log(`üìä Valida√ß√£o: ${camposInvalidos.length} campos inv√°lidos`);
  console.log(`üîç Campos inv√°lidos:`, camposInvalidos);
  return camposInvalidos;
}

function preencherFornecedorComTarifas(dados) {
  console.log("üîß PREENCHER FORNECEDOR - INICIANDO");
  console.log("üì¶ Dados recebidos:", dados);
  
  const checkboxes = document.querySelectorAll('input[name="fornecedor"]');
  checkboxes.forEach(cb => {
    cb.checked = false;
    const fornecedorId = cb.value.toLowerCase();
    const configDiv = document.getElementById(`config-${fornecedorId}`);
    if (configDiv) {
      configDiv.style.display = 'none';
      const radios = configDiv.querySelectorAll('input[type="radio"]');
      radios.forEach(radio => radio.checked = false);
      
      const percentualInput = configDiv.querySelector(`input[name^="percentual_"]`);
      if (percentualInput) {
        percentualInput.value = '';
      }
    }
  });
  
  if (!dados.fornecedor) {
    console.log("‚ÑπÔ∏è Nenhum fornecedor para preencher");
    return;
  }
  
  const fornecedorBuscado = dados.fornecedor.toUpperCase().trim();
  console.log("üéØ Buscando fornecedor:", fornecedorBuscado);
  
  let checkboxEncontrado = null;
  
  checkboxes.forEach(cb => {
    const checkboxValor = cb.value.toUpperCase().trim();
    console.log(`üîç Comparando: "${checkboxValor}" com "${fornecedorBuscado}"`);
    
    if (checkboxValor === fornecedorBuscado) {
      checkboxEncontrado = cb;
    }
  });
  
  if (checkboxEncontrado) {
    console.log("‚úÖ Fornecedor encontrado:", checkboxEncontrado.value);
    checkboxEncontrado.checked = true;
    
    const fornecedorId = checkboxEncontrado.value.toLowerCase();
    const configDiv = document.getElementById(`config-${fornecedorId}`);
    
    if (configDiv) {
      configDiv.style.display = 'grid';
      
      if (dados.tarifa) {
        const tarifaBuscada = dados.tarifa.toUpperCase().trim();
        console.log("üí∞ Buscando tarifa:", tarifaBuscada);
        
        const radioTarifa = configDiv.querySelector(`input[name="tarifa_${fornecedorId}"][value="${tarifaBuscada}"]`);
        if (radioTarifa) {
          radioTarifa.checked = true;
          console.log("‚úÖ Tarifa selecionada:", tarifaBuscada);
        } else {
          console.log("‚ö†Ô∏è Tarifa n√£o encontrada, usando MDR como padr√£o");
          const radioMDR = configDiv.querySelector(`input[name="tarifa_${fornecedorId}"][value="MDR"]`);
          if (radioMDR) {
            radioMDR.checked = true;
          }
        }
      }
      
      if (dados.percentual_tarifa !== undefined && dados.percentual_tarifa !== null) {
        const percentualInput = configDiv.querySelector(`input[name="percentual_${fornecedorId}"]`);

        if (percentualInput) {
          console.log("üî¥üî¥üî¥ DEBUG CR√çTICO - percentual_tarifa:");
          console.log("Valor BRUTO que chegou:", dados.percentual_tarifa);
          console.log("Tipo do valor:", typeof dados.percentual_tarifa);
          console.log("Valor exato (toString):", dados.percentual_tarifa.toString());
          
          let percentualFormatado = formatarPercentualParaExibicao(dados.percentual_tarifa);
          console.log("Ap√≥s formata√ß√£o:", percentualFormatado);
          
          percentualInput.value = percentualFormatado;
          console.log("‚úÖ Valor colocado no input:", percentualInput.value);
        } else {
          console.log("‚ùå Input de percentual n√£o encontrado para:", fornecedorId);
        }
      }
    }
  } else {
    console.log("‚ùå Fornecedor N√ÉO encontrado:", fornecedorBuscado);
    console.log("üîç Checkboxes dispon√≠veis:", Array.from(checkboxes).map(cb => cb.value));
  }
}

function limparFormulario() {
  console.log("üßπ LIMPANDO FORMUL√ÅRIO COMPLETAMENTE");
  
  document.getElementById('razao_social').value = '';
  document.getElementById('nome_fantasia').value = '';
  document.getElementById('cnpj_cadastro').value = '';
  
  const checkboxes = document.querySelectorAll('input[name="fornecedor"]');
  checkboxes.forEach(cb => {
    cb.checked = false;
    const fornecedorId = cb.value.toLowerCase();
    const configDiv = document.getElementById(`config-${fornecedorId}`);
    if (configDiv) {
      configDiv.style.display = 'none';
      
      const radios = configDiv.querySelectorAll('input[type="radio"]');
      radios.forEach(radio => radio.checked = false);
      
      const percentualInputs = configDiv.querySelectorAll('input[name^="percentual_"]');
      percentualInputs.forEach(input => input.value = '');
    }
  });
  
  document.getElementById('observacoes').value = '';
  document.getElementById('contrato_enviado').value = '';
  document.getElementById('contrato_assinado').value = '';
  document.getElementById('ativacao').value = '';
  document.getElementById('link').value = '';
  document.getElementById('mensalidade').value = 'R$ 0,00';
  document.getElementById('mensalidade_sim').value = 'R$ 0,00';
  
  document.getElementById('situacao').value = 'NOVO REGISTRO';
  document.getElementById('adesao').value = 'R$ 0,00';
  
  document.getElementById('inputEventoSearch').value = '';
  document.getElementById('evento').value = '';
  document.getElementById('suggestionsEventoSearch').style.display = 'none';
  
  atualizarEventos();
  
  document.getElementById('btnCadastrar').style.display = 'block';
  document.getElementById('btnAtualizar').style.display = 'none';
  cadastroAtualId = null;
  
  console.log("üîì LIBERANDO CAMPOS DE FORNECEDOR PARA NOVO CADASTRO");
  const checkboxesFornecedores = document.querySelectorAll('input[name="fornecedor"]');
  const configsFornecedores = document.querySelectorAll('[id^="config-"]');

  checkboxesFornecedores.forEach(checkbox => {
      checkbox.disabled = false;
      checkbox.style.cursor = 'pointer';
      checkbox.style.opacity = '1';
  });

  configsFornecedores.forEach(config => {
      const inputs = config.querySelectorAll('input, select');
      inputs.forEach(input => {
          input.disabled = false;
          input.style.cursor = 'pointer';
          input.style.opacity = '1';
      });
  });
  
  document.querySelectorAll('.campo-obrigatorio').forEach(campo => {
    campo.classList.remove('campo-obrigatorio');
    campo.style.borderColor = '';
    campo.style.backgroundColor = '';
  });
  
  limparSelecaoAplicarATodos();
  
  document.getElementById('btnAplicarATodos').style.display = 'none';
  
  console.log("‚úÖ Formul√°rio limpo completamente!");
}

function configurarBotoesAplicarATodos(cnpj) {
    console.log("üéØ Configurando bot√µes aplicar a todos para CNPJ:", cnpj);
    cnpjAtualParaAplicar = cnpj;
    
    limparSelecaoAplicarATodos();
    
    adicionarCheckboxesAosCampos();
    
    mostrarBotaoAplicarATodos();
}

function agruparCadastrosPorCNPJ(cadastros) {
  const agrupados = {};
  
  cadastros.forEach(cadastro => {
    if (!agrupados[cadastro.cnpj]) {
      agrupados[cadastro.cnpj] = {
        razao_social: cadastro.razao_social,
        nome_fantasia: cadastro.nome_fantasia,
        cnpj: cadastro.cnpj,
        lojas: []
      };
    }
    
    agrupados[cadastro.cnpj].lojas.push(cadastro);
  });
  
  return Object.values(agrupados);
}

function getSituacaoClass(situacao) {
  if (!situacao) return 'situacao-cadastrado';
  
  const situacaoUpper = situacao.toUpperCase().trim();
  
  if (situacaoUpper.includes('NOVO REGISTRO')) return 'situacao-novo-registro';
  else if (situacaoUpper.includes('CADASTRADO')) return 'situacao-cadastrado';
  else if (situacaoUpper.includes('EM ANDAMENTO')) return 'situacao-andamento';
  else if (situacaoUpper.includes('REJEITADO') || situacaoUpper.includes('REJEITADO')) return 'situacao-rejeitado';
  else if (situacaoUpper.includes('DESCREDENCIADO')) return 'situacao-descredenciado';
  else if (situacaoUpper.includes('DESISTIU')) return 'situacao-desistiu';
  else return 'situacao-cadastrado';
}

function editarCadastroModal(id) {
    console.log("üéØ [DEBUG] Editando cadastro modal - ID:", id);
    console.log("‚úèÔ∏è EDITANDO CADASTRO MODAL - INICIANDO");
    console.log("üîç ID recebido:", id, "Waitlabel atual:", waitlabelAtual);
    
    showLoading("Carregando dados...", "Buscando informa√ß√µes da loja");
    
    google.script.run
        .withSuccessHandler(function(dados) {
            console.log("‚úÖ [SUCESSO] Dados do cadastro carregados:", dados);
            
            console.log("‚úÖ DADOS RECEBIDOS DO GS:", dados);
            hideLoading();
            fecharModalDetalhes();
            
            if (dados.encontrado) {
                preencherDadosCadastro(dados);
                document.getElementById('razao_social').scrollIntoView({ behavior: 'smooth' });
                showMessage('success', '‚úÖ Cadastro carregado para edi√ß√£o!');
                
                configurarBotoesAplicarATodos(dados.cnpj);
                
                document.getElementById('btnAplicarATodos').style.display = 'block';
            } else {
                showMessage('error', '‚ùå ' + dados.mensagem);
            }
        })
        .withFailureHandler(function(error) {
            console.error("‚ùå [ERRO] Falha ao carregar cadastro:", error);
            
            console.error("‚ùå ERRO AO CARREGAR CADASTRO:", error);
            hideLoading();
            showMessage('error', '‚ùå Erro ao carregar cadastro: ' + error.message);
        })
        .buscarCadastroPorIDComWaitlabel(id, waitlabelAtual);
}

function atualizarEventos() {
  const situacao = document.getElementById('situacao').value;
  const selectEvento = document.getElementById('evento');
  
  console.log("üéØ Atualizando eventos para situa√ß√£o:", situacao);
  
  selectEvento.innerHTML = '<option value="">-- Selecione um evento --</option>';
  
  let eventos = [];
  
  // üî• CORRE√á√ÉO: Remover duplicatas tamb√©m no select
  if (situacao === 'NOVO REGISTRO' || situacao === 'EM ANDAMENTO') {
    eventos = [...new Set(eventosEmAndamento)]; // Remove duplicatas
  } else if (situacao === 'REJEITADO') {
    eventos = [...new Set(eventosRejeitado)];
  } else if (situacao === 'CADASTRADO') {
    eventos = [...new Set(eventosCadastrado)];
  } else if (situacao === 'DESCREDENCIADO') {
    eventos = [...new Set(eventosDescredenciado)];
  } else if (situacao === 'DESISTIU') {
    eventos = [...new Set(eventosDesistiu)];
  }
  
  console.log("üìã Eventos dispon√≠veis (√∫nicos):", eventos.length);
  
  // üî• CORRE√á√ÉO: Ordenar alfabeticamente
  eventos.sort().forEach(evento => {
    const option = document.createElement('option');
    option.value = evento;
    option.textContent = evento;
    selectEvento.appendChild(option);
  });
  
  atualizarEventosSearch();
}

function verificarDuplicatasEventos() {
  console.log("=== üîç VERIFICANDO DUPLICATAS NOS EVENTOS ===");
  
  const todosEventos = [
    ...eventosNovoRegistro,
    ...eventosCadastrado, 
    ...eventosEmAndamento,
    ...eventosRejeitado,
    ...eventosDescredenciado,
    ...eventosDesistiu
  ];
  
  const eventosUnicos = [...new Set(todosEventos)];
  const eventosDuplicados = todosEventos.filter((item, index) => todosEventos.indexOf(item) !== index);
  
  console.log(`üìä Total de eventos: ${todosEventos.length}`);
  console.log(`üìä Eventos √∫nicos: ${eventosUnicos.length}`);
  console.log(`üìä Eventos duplicados: ${eventosDuplicados.length}`);
  
  if (eventosDuplicados.length > 0) {
    console.log("‚ùå Eventos duplicados encontrados:", [...new Set(eventosDuplicados)]);
  } else {
    console.log("‚úÖ Nenhum evento duplicado encontrado!");
  }
  
  return eventosDuplicados.length === 0;
}

// Execute esta fun√ß√£o para verificar
setTimeout(verificarDuplicatasEventos, 2000);

function limparDuplicatasEventos() {
  console.log("üßπ LIMPANDO DUPLICATAS DOS EVENTOS...");
  
  // Remove duplicatas de cada array
  eventosNovoRegistro = [...new Set(eventosNovoRegistro)];
  eventosCadastrado = [...new Set(eventosCadastrado)];
  eventosEmAndamento = [...new Set(eventosEmAndamento)];
  eventosRejeitado = [...new Set(eventosRejeitado)];
  eventosDescredenciado = [...new Set(eventosDescredenciado)];
  eventosDesistiu = [...new Set(eventosDesistiu)];
  
  console.log("‚úÖ Duplicatas removidas!");
  verificarDuplicatasEventos();
}

// Execute esta fun√ß√£o uma vez para limpar
setTimeout(limparDuplicatasEventos, 3000);

function atualizarEventosSearch() {
  const situacao = document.getElementById('situacao').value;
  const inputSearch = document.getElementById('inputEventoSearch');
  
  inputSearch.value = '';
  
  console.log("üîÑ Campo de search atualizado para situa√ß√£o:", situacao);
}

function filtrarSugestoesEventoSearch() {
  const input = document.getElementById('inputEventoSearch');
  const suggestions = document.getElementById('suggestionsEventoSearch');
  const termo = input.value.toLowerCase().trim();
  
  console.log("üéØ FILTRAR SUGEST√ïES EVENTO SEARCH - Termo:", termo);
  
  const situacaoAtual = document.getElementById('situacao').value;
  let eventosDaSituacao = [];
  
  console.log("üìã Situa√ß√£o atual do select:", situacaoAtual);
  
  // üî• CORRE√á√ÉO: Garantir que cada situa√ß√£o use apenas seus pr√≥prios eventos SEM DUPLICATAS
  if (situacaoAtual === 'NOVO REGISTRO') {
    eventosDaSituacao = [...new Set(eventosNovoRegistro)]; // Remove duplicatas
  } else if (situacaoAtual === 'EM ANDAMENTO') {
    eventosDaSituacao = [...new Set(eventosEmAndamento)];
  } else if (situacaoAtual === 'REJEITADO') {
    eventosDaSituacao = [...new Set(eventosRejeitado)];
  } else if (situacaoAtual === 'CADASTRADO') {
    eventosDaSituacao = [...new Set(eventosCadastrado)];
  } else if (situacaoAtual === 'DESCREDENCIADO') {
    eventosDaSituacao = [...new Set(eventosDescredenciado)];
  } else if (situacaoAtual === 'DESISTIU') {
    eventosDaSituacao = [...new Set(eventosDesistiu)];
  }
  
  console.log("üéØ Total de eventos √∫nicos carregados:", eventosDaSituacao.length);
  
  let eventosParaMostrar = eventosDaSituacao;
  
  if (termo.length > 0) {
    eventosParaMostrar = eventosDaSituacao.filter(evento => 
      evento.toLowerCase().includes(termo)
    );
    console.log("üîç Eventos filtrados:", eventosParaMostrar.length);
  }
  
  if (eventosParaMostrar.length === 0) {
    suggestions.innerHTML = `
      <div class="suggestion-evento-item-search" style="color: var(--gray);">
        <i class="fas fa-search"></i>
        Nenhum evento encontrado
      </div>
    `;
  } else {
    let html = `<div class="suggestion-evento-section-search">
      <i class="fas fa-filter"></i> Eventos para: ${situacaoAtual} (${eventosParaMostrar.length})
    </div>`;
    
    // üî• CORRE√á√ÉO: Garantir ordena√ß√£o alfab√©tica
    eventosParaMostrar.sort().forEach(evento => {
      html += `
        <div class="suggestion-evento-item-search" onclick="selecionarEventoSearch('${evento.replace(/'/g, "\\'")}')">
          <i class="fas fa-calendar-check"></i>
          ${evento}
        </div>
      `;
    });
    
    suggestions.innerHTML = html;
  }
  
  suggestions.style.display = 'block';
  console.log("‚úÖ Sugest√µes mostradas com sucesso!");
}

function selecionarEventoSearch(evento) {
  const input = document.getElementById('inputEventoSearch');
  const suggestions = document.getElementById('suggestionsEventoSearch');
  const selectEvento = document.getElementById('evento');
  
  input.value = evento;
  selectEvento.value = evento;
  
  suggestions.style.display = 'none';
  
  console.log("‚úÖ Evento selecionado:", evento);
}

function formatarPercentual(input) {
    console.log("üéØ Digitando percentual:", input.value);
    
    const cursorPos = input.selectionStart;
    let valor = input.value;
    
    valor = valor.replace(/[^\d,%]/g, '');
    
    if (valor && !valor.includes('%')) {
        valor = valor + '%';
    }
    
    input.value = valor;
    
    setTimeout(() => {
        let novaPos = Math.min(cursorPos, input.value.length);
        input.setSelectionRange(novaPos, novaPos);
    }, 0);
    
    console.log("‚úÖ Percentual formatado:", input.value);
}

function sincronizarCamposEvento() {
  const inputSearch = document.getElementById('inputEventoSearch');
  const selectEvento = document.getElementById('evento');
  
  if (!inputSearch || !selectEvento) {
    console.log("‚ùå Campos de evento n√£o encontrados");
    return;
  }
  
  console.log("‚úÖ Sincronizando campos de evento...");
  
  inputSearch.addEventListener('input', function() {
    const valor = this.value;
    console.log("üîÑ Input evento alterado:", valor);
    
    const opcoes = Array.from(selectEvento.options);
    const opcaoCorrespondente = opcoes.find(opt => opt.text === valor);
    
    if (opcaoCorrespondente) {
      selectEvento.value = opcaoCorrespondente.value;
      console.log("‚úÖ Select atualizado para:", opcaoCorrespondente.value);
    } else {
      selectEvento.value = '';
      console.log("‚ö†Ô∏è Nenhuma op√ß√£o correspondente encontrada");
    }
  });
  
  selectEvento.addEventListener('change', function() {
    const opcaoSelecionada = this.options[this.selectedIndex];
    if (opcaoSelecionada && opcaoSelecionada.value) {
      inputSearch.value = opcaoSelecionada.text;
      console.log("‚úÖ Input search atualizado para:", opcaoSelecionada.text);
    }
  });
}

function formatarDataParaExibicao(data) {
  if (!data) return '';
  
  try {
    if (typeof data === 'string' && data.includes('/')) {
      return data;
    }
    
    const dateObj = new Date(data);
    if (!isNaN(dateObj.getTime())) {
      return dateObj.toLocaleDateString('pt-BR');
    }
    
    return data;
  } catch (error) {
    return data;
  }
}

function limparBusca() {
  console.log("üéØ [DEBUG] Bot√£o 'Limpar Busca' clicado");
  
  limparFormulario();
  
  document.getElementById('secaoCadastros').style.display = 'none';
  showMessage('info', 'Formul√°rio limpo e busca cancelada!');
}

// üî• MANTENDO AS FUN√á√ïES DE PROTE√á√ÉO DE CAMPOS
function configurarValidacaoEmTempoReal() {
  const campos = document.querySelectorAll('#razao_social, #cnpj_cadastro, #tipo');
  campos.forEach(campo => {
    campo.addEventListener('input', function() {
      this.style.borderColor = '';
    });
  });
}

function configurarModalSenha() {
  const inputSenha = document.getElementById('inputSenha');
  if (inputSenha) {
    inputSenha.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        validarSenha();
      }
    });
  }
  
  const modalSenha = document.getElementById('modalSenha');
  if (modalSenha) {
    modalSenha.addEventListener('click', function(e) {
      if (e.target === this) {
        fecharModalSenha();
      }
    });
  }
  
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('modalSenha').style.display === 'flex') {
      fecharModalSenha();
    }
  });
}

function solicitarSenha(campo) {
  campoEditavel = campo;
  
  document.getElementById('modalSenha').style.display = 'flex';
  
  const inputSenha = document.getElementById('inputSenha');
  if (inputSenha) {
    inputSenha.value = '';
    inputSenha.focus();
  }
}

function validarSenha() {
  const inputSenha = document.getElementById('inputSenha');
  if (!inputSenha) {
    console.log("‚ùå inputSenha n√£o encontrado");
    return;
  }
  
  const senha = inputSenha.value;
  console.log("üîê Validando senha:", senha);
  
  if (senha === SENHA_PERMITIDA) {
    console.log("‚úÖ SENHA CORRETA - Configurando autoriza√ß√£o di√°ria");
    
    const agora = new Date();
    const expiracao = new Date(agora.getTime() + (24 * 60 * 60 * 1000));
    
    localStorage.setItem('usuarioAutorizado', 'true');
    localStorage.setItem('autorizacaoExpiracao', expiracao.getTime().toString());
    localStorage.setItem('ultimaAutorizacao', agora.getTime().toString());
    
    console.log("üíæ Autoriza√ß√£o salva at√©:", expiracao.toLocaleString('pt-BR'));
    
    fecharModalSenha();
    
    liberarTodosCamposProtegidos();
    
    showMessage('success', '‚úÖ Todos os campos liberados por 24 horas!');
    
  } else {
    console.log("‚ùå SENHA INCORRETA");
    showMessage('error', '‚ùå Senha incorreta!');
    inputSenha.value = '';
    inputSenha.focus();
  }
}

function coletarDadosFormularioTemporario() {
  const dados = {
    razao_social: document.getElementById('razao_social').value,
    nome_fantasia: document.getElementById('nome_fantasia').value,
    cnpj_cadastro: document.getElementById('cnpj_cadastro').value,
    observacoes: document.getElementById('observacoes').value,
    contrato_enviado: document.getElementById('contrato_enviado').value,
    contrato_assinado: document.getElementById('contrato_assinado').value,
    ativacao: document.getElementById('ativacao').value,
    link: document.getElementById('link').value,
    mensalidade: document.getElementById('mensalidade').value,
    situacao: document.getElementById('situacao').value,
    adesao: document.getElementById('adesao').value,
    evento: document.getElementById('inputEventoSearch').value
  };
  
  const fornecedoresSelecionados = [];
  const checkboxes = document.querySelectorAll('input[name="fornecedor"]:checked');
  checkboxes.forEach(checkbox => {
    const fornecedorNome = checkbox.value;
    const fornecedorId = fornecedorNome.toLowerCase();
    const configDiv = document.getElementById(`config-${fornecedorId}`);
    
    if (configDiv && configDiv.style.display === 'grid') {
      const tarifaRadio = document.querySelector(`input[name="tarifa_${fornecedorId}"]:checked`);
      const percentualSelect = document.querySelector(`select[name="percentual_${fornecedorId}"]`);
      
      fornecedoresSelecionados.push({
        nome: fornecedorNome,
        tarifa: tarifaRadio ? tarifaRadio.value : '',
        percentual: percentualSelect ? percentualSelect.value : ''
      });
    }
  });

  dados.fornecedores = fornecedoresSelecionados;
  return dados;
}

function restaurarDadosFormulario(dados) {
  if (!dados) return;
  
  console.log("üîÑ Restaurando dados do formul√°rio:", dados);
  
  document.getElementById('razao_social').value = dados.razao_social || '';
  document.getElementById('nome_fantasia').value = dados.nome_fantasia || '';
  document.getElementById('cnpj_cadastro').value = dados.cnpj_cadastro || '';
  document.getElementById('observacoes').value = dados.observacoes || '';
  document.getElementById('contrato_enviado').value = dados.contrato_enviado || '';
  document.getElementById('contrato_assinado').value = dados.contrato_assinado || '';
  document.getElementById('ativacao').value = dados.ativacao || '';
  document.getElementById('link').value = dados.link || '';
  document.getElementById('mensalidade').value = dados.mensalidade || 'R$ 0,00';
  document.getElementById('situacao').value = dados.situacao || 'NOVO REGISTRO';
  document.getElementById('adesao').value = dados.adesao || 'R$ 0,00';
  document.getElementById('inputEventoSearch').value = dados.evento || '';
  
  if (dados.fornecedores && dados.fornecedores.length > 0) {
    dados.fornecedores.forEach(fornecedor => {
      const checkbox = document.querySelector(`input[name="fornecedor"][value="${fornecedor.nome}"]`);
      if (checkbox) {
        checkbox.checked = true;
        const fornecedorId = fornecedor.nome.toLowerCase();
        const configDiv = document.getElementById(`config-${fornecedorId}`);
        
        if (configDiv) {
          configDiv.style.display = 'grid';
          
          if (fornecedor.tarifa) {
            const tarifaRadio = document.querySelector(`input[name="tarifa_${fornecedorId}"][value="${fornecedor.tarifa}"]`);
            if (tarifaRadio) {
              tarifaRadio.checked = true;
            }
          }
          
          if (fornecedor.percentual) {
            const percentualSelect = document.querySelector(`select[name="percentual_${fornecedorId}"]`);
            if (percentualSelect) {
              percentualSelect.value = fornecedor.percentual;
            }
          }
        }
      }
    });
  }
  
  console.log("‚úÖ Dados restaurados com sucesso!");
}

function fecharModalSenha() {
  document.getElementById('modalSenha').style.display = 'none';
  campoEditavel = null;
}

function liberarTodosCamposProtegidos() {
  console.log("üîì LIBERANDO TODOS OS CAMPOS...");
  
  const dadosAtuais = coletarDadosFormularioTemporario();
  
  const camposProtegidos = [
    'razao_social', 'nome_fantasia', 'cnpj_cadastro', 
    'mensalidade', 'adesao', 'situacao', 'data_status',
    'contrato_enviado', 'contrato_assinado', 'ativacao', 'link'
  ];
  
  camposProtegidos.forEach(id => {
    const campo = document.getElementById(id);
    if (campo) {
      console.log(`üîì Liberando: ${id}`);
      
      const novoCampo = campo.cloneNode(true);
      novoCampo.removeAttribute('readonly');
      novoCampo.disabled = false;
      novoCampo.style.backgroundColor = '';
      novoCampo.style.cursor = 'text';
      novoCampo.style.opacity = '1';
      
      novoCampo.onfocus = null;
      novoCampo.onclick = null;
      
      campo.parentNode.replaceChild(novoCampo, campo);
      
      console.log(`‚úÖ ${id} liberado completamente`);
    }
  });
  
  console.log("üîì Liberando campos dos fornecedores...");
  const camposFornecedor = document.querySelectorAll(`
    input[name="fornecedor"], 
    input[name^="tarifa_"], 
    select[name^="percentual_"]
  `);
  
  camposFornecedor.forEach(campo => {
    const novoCampo = campo.cloneNode(true);
    novoCampo.disabled = false;
    novoCampo.style.cursor = '';
    novoCampo.style.opacity = '1';
    novoCampo.style.backgroundColor = '';
    
    novoCampo.onclick = null;
    novoCampo.onfocus = null;
    novoCampo.onmousedown = null;
    
    campo.parentNode.replaceChild(novoCampo, campo);
  });
  
  setTimeout(() => {
    restaurarDadosFormulario(dadosAtuais);
  }, 100);
  
  console.log("üéØ TODOS OS CAMPOS FORAM LIBERADOS COM SUCESSO!");
}

function configurarCamposProtegidos() {
  console.log("üéØ CONFIGURAR CAMPOS PROTEGIDOS - VERIFICANDO AUTORIZA√á√ÉO DI√ÅRIA");
  
  const autorizado = localStorage.getItem('usuarioAutorizado');
  const expiracao = localStorage.getItem('autorizacaoExpiracao');
  const agora = new Date().getTime();
  
  let usuarioEstaAutorizado = false;
  
  if (autorizado === 'true' && expiracao) {
    const tempoExpiracao = parseInt(expiracao);
    
    if (agora < tempoExpiracao) {
      console.log("‚úÖ Autoriza√ß√£o v√°lida at√©:", new Date(tempoExpiracao).toLocaleString('pt-BR'));
      usuarioEstaAutorizado = true;
      
      setTimeout(() => {
        liberarTodosCamposProtegidos();
        console.log("üîì Campos liberados automaticamente (autoriza√ß√£o di√°ria ativa)");
      }, 100);
      
    } else {
      console.log("‚ùå Autoriza√ß√£o expirada - limpando dados");
      localStorage.removeItem('usuarioAutorizado');
      localStorage.removeItem('autorizacaoExpiracao');
      localStorage.removeItem('ultimaAutorizacao');
    }
  }
  
  if (!usuarioEstaAutorizado) {
    console.log("üîí PROTEC√á√ÉO ATIVA: Usu√°rio n√£o autorizado hoje");
    
    const dadosAtuais = coletarDadosFormularioTemporario();
    
    const camposProtegidos = [
      'razao_social', 'nome_fantasia', 'cnpj_cadastro', 
      'mensalidade', 'adesao', 'situacao', 'data_status',
      'contrato_enviado', 'contrato_assinado', 'ativacao', 'link'
    ];
    
    console.log("üîí Protegendo campos principais...");
    
    camposProtegidos.forEach(id => {
      const campo = document.getElementById(id);
      if (campo) {
        console.log(`üîí Protegendo: ${id}`);
        campo.setAttribute('readonly', 'true');
        campo.disabled = false;
        campo.style.backgroundColor = '#f8f9fa';
        campo.style.cursor = 'not-allowed';
        campo.style.opacity = '1';
        
        const novoCampo = campo.cloneNode(true);
        campo.parentNode.replaceChild(novoCampo, campo);
        
        document.getElementById(id).addEventListener('focus', function(e) {
          e.preventDefault();
          console.log(`üîì Campo ${id} solicitando senha`);
          solicitarSenha(this);
        });
      }
    });
    
    console.log("üîí Protegendo APENAS checkboxes dos fornecedores...");
    const checkboxesFornecedor = document.querySelectorAll('input[name="fornecedor"]');
    const radiosTarifa = document.querySelectorAll('input[name^="tarifa_"]');
    const selectsPercentual = document.querySelectorAll('select[name^="percentual_"]');

    checkboxesFornecedor.forEach(checkbox => {
      checkbox.disabled = true;
      checkbox.style.cursor = 'not-allowed';
      checkbox.style.opacity = '0.6';
    });

    radiosTarifa.forEach(radio => {
      radio.disabled = false;
      radio.style.cursor = 'pointer';
      radio.style.opacity = '1';
    });

    selectsPercentual.forEach(select => {
      select.disabled = false;
      select.style.cursor = 'pointer';
      select.style.opacity = '1';
    });
    
    setTimeout(() => {
      if (dadosAtuais && (dadosAtuais.razao_social || dadosAtuais.cnpj_cadastro)) {
        console.log("üîÑ Restaurando dados ap√≥s prote√ß√£o:", dadosAtuais);
        restaurarDadosFormulario(dadosAtuais);
      } else {
        console.log("‚ÑπÔ∏è Nenhum dado para restaurar - formul√°rio vazio");
      }
    }, 300);
  }
  
  console.log("‚úÖ Liberando campos permitidos...");
  const camposLiberados = ['evento', 'observacoes', 'inputEventoSearch'];
  camposLiberados.forEach(id => {
    const campo = document.getElementById(id);
    if (campo) {
      campo.removeAttribute('readonly');
      campo.disabled = false;
      campo.style.backgroundColor = '';
      campo.style.cursor = 'text';
      campo.style.opacity = '1';
    }
  });
  
  console.log("üéØ CONFIGURA√á√ÉO DE PROTEC√á√ÉO FINALIZADA");
}

function fecharModalDetalhes() {
  const modal = document.getElementById('modalDetalhes');
  modal.style.display = 'none';
}

// üî• MANTENDO AS FUN√á√ïES DE DEBUG E TESTE
function verificarStatusAutorizacao() {
  const autorizado = localStorage.getItem('usuarioAutorizado');
  const expiracao = localStorage.getItem('autorizacaoExpiracao');
  const ultimaAuth = localStorage.getItem('ultimaAutorizacao');
  
  const agora = new Date();
  
  console.log("=== üîê STATUS DA AUTORIZA√á√ÉO ===");
  console.log("Autorizado:", autorizado);
  
  if (expiracao) {
    const dataExpiracao = new Date(parseInt(expiracao));
    console.log("Expira em:", dataExpiracao.toLocaleString('pt-BR'));
    console.log("Tempo restante:", Math.round((dataExpiracao - agora) / (1000 * 60 * 60)) + " horas");
  }
  
  if (ultimaAuth) {
    const dataUltimaAuth = new Date(parseInt(ultimaAuth));
    console.log("√öltima autoriza√ß√£o:", dataUltimaAuth.toLocaleString('pt-BR'));
  }
  
  if (autorizado === 'true' && expiracao && agora.getTime() < parseInt(expiracao)) {
    console.log("‚úÖ AUTORIZA√á√ÉO ATIVA - Campos liberados");
    return true;
  } else {
    console.log("‚ùå AUTORIZA√á√ÉO INATIVA - Campos protegidos");
    return false;
  }
}

function adicionarBotaoStatus() {
  const btnStatus = document.createElement('button');
  btnStatus.innerHTML = 'üîê Status Autoriza√ß√£o';
  btnStatus.style.position = 'fixed';
  btnStatus.style.top = '10px';
  btnStatus.style.right = '10px';
  btnStatus.style.zIndex = '9999';
  btnStatus.style.background = '#FF6B35';
  btnStatus.style.color = 'white';
  btnStatus.style.border = 'none';
  btnStatus.style.padding = '8px';
  btnStatus.style.borderRadius = '4px';
  btnStatus.style.cursor = 'pointer';
  
  btnStatus.onclick = function() {
    verificarStatusAutorizacao();
    alert('Verifique o console (F12) para ver o status da autoriza√ß√£o!');
  };
  
  document.body.appendChild(btnStatus);
}

setTimeout(adicionarBotaoStatus, 2000);

function testarEnvioFormulario() {
  console.log("üß™ TESTANDO ENVIO DO FORMUL√ÅRIO...");
  
  const dados = coletarDadosFormulario();
  
  console.log("üì§ Dados coletados para envio:", dados);
  console.log("üî¢ Fornecedores coletados:", dados.fornecedores);
  
  if (!dados.fornecedores || dados.fornecedores.length === 0) {
    alert("‚ùå Nenhum fornecedor selecionado! Selecione pelo menos um.");
    return;
  }
  
  google.script.run
    .withSuccessHandler(function(res) {
      console.log("‚úÖ RESPOSTA DO DEBUG:", res);
      alert(`DEBUG CONCLU√çDO:\n\n‚Ä¢ Fornecedores enviados: ${res.quantidadeFornecedores}\n‚Ä¢ Estrutura: ${JSON.stringify(res.estruturaFornecedores, null, 2)}\n\nVerifique o console do GS para detalhes completos.`);
    })
    .withFailureHandler(function(error) {
      console.error("‚ùå ERRO NO DEBUG:", error);
      alert("Erro no debug: " + error.message);
    })
    .debugFormulario(dados);
}

function testarConversaoPercentual() {
    console.log("=== üß™ TESTE AUTOM√ÅTICO DEFINITIVO ===");
    
    const teste1 = "3,5%";
    const decimal1 = converterPercentualParaNumero(teste1);
    const formatado1 = formatarPercentualParaExibicao(decimal1);
    console.log(`‚úÖ ${teste1} ‚Üí ${decimal1} ‚Üí ${formatado1}`);
    
    const teste2 = "0,4%";
    const decimal2 = converterPercentualParaNumero(teste2);
    const formatado2 = formatarPercentualParaExibicao(decimal2);
    console.log(`‚úÖ ${teste2} ‚Üí ${decimal2} ‚Üí ${formatado2}`);
    
    const teste3 = 0.035;
    const formatado3 = formatarPercentualParaExibicao(teste3);
    console.log(`‚úÖ ${teste3} ‚Üí ${formatado3}`);
    
    const teste4 = 0.004;
    const formatado4 = formatarPercentualParaExibicao(teste4);
    console.log(`‚úÖ ${teste4} ‚Üí ${formatado4}`);
}

setTimeout(testarConversaoPercentual, 1000);

function testarEventos() {
  console.log("=== üß™ TESTE DE EVENTOS ===");
  console.log("NOVO REGISTRO:", eventosNovoRegistro);
  console.log("CADASTRADO:", eventosCadastrado);
  console.log("EM ANDAMENTO:", eventosEmAndamento);
  console.log("REJEITADO:", eventosRejeitado);
  console.log("DESCREDENCIADO:", eventosDescredenciado);
  
  filtrarSugestoesEventoSearch();
}

setTimeout(() => {
  console.log("=== üß™ TESTE FINAL DO SISTEMA ===");
  console.log("‚úÖ DOMContentLoaded executado");
  console.log("‚úÖ Event listener do inputEventoSearch:", document.getElementById('inputEventoSearch') !== null);
  console.log("‚úÖ Fun√ß√£o filtrarSugestoesEventoSearch:", typeof filtrarSugestoesEventoSearch);
  console.log("‚úÖ CSS carregado corretamente");
  
  const inputEvento = document.getElementById('inputEventoSearch');
  if (inputEvento) {
    console.log("üéØ Clique no campo 'Digite para buscar evento...' para testar as sugest√µes!");
  }
}, 3000);

// üî• CONFIGURA√á√ÉO PARA FECHAR SUGEST√ïES AO CLICAR FORA
document.addEventListener('click', function(e) {
  const suggestionsSearch = document.getElementById('suggestionsEventoSearch');
  const inputSearch = document.getElementById('inputEventoSearch');
  
  if (suggestionsSearch && suggestionsSearch.style.display === 'block') {
    if (!suggestionsSearch.contains(e.target) && e.target !== inputSearch) {
      suggestionsSearch.style.display = 'none';
      console.log("‚ùå Fechando sugest√µes - clique fora");
    }
  }
  
  const suggestionsFiltro = document.getElementById('suggestionsEvento');
  const inputFiltro = document.getElementById('inputFiltroEvento');
  
  if (suggestionsFiltro && suggestionsFiltro.style.display === 'block') {
    if (!suggestionsFiltro.contains(e.target) && e.target !== inputFiltro) {
      suggestionsFiltro.style.display = 'none';
    }
  }
});

// üî• FECHAR SUGEST√ïES COM ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const suggestionsSearch = document.getElementById('suggestionsEventoSearch');
    const suggestionsFiltro = document.getElementById('suggestionsEvento');
    
    if (suggestionsSearch) {
      suggestionsSearch.style.display = 'none';
      console.log("‚ùå Fechando sugest√µes - ESC pressionado");
    }
    if (suggestionsFiltro) suggestionsFiltro.style.display = 'none';
  }
});

// üî• MOSTRAR SUGEST√ïES AO CLICAR NO CAMPO
document.getElementById('inputEventoSearch').addEventListener('click', function() {
  console.log("üéØ Clicou no campo de evento - mostrando sugest√µes");
  filtrarSugestoesEventoSearch();
});

// üî• TESTE SIMPLES PARA VERIFICAR SE OS EVENTOS EST√ÉO CARREGADOS
setTimeout(() => {
  console.log("=== üî• TESTE DE EVENTOS ===");
  console.log("Eventos Em Andamento:", eventosEmAndamento);
  console.log("Eventos Cadastrado:", eventosCadastrado);
  console.log("Eventos Rejeitado:", eventosRejeitado);
}, 2000);

  </script>
</body>
</html>
