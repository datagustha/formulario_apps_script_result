<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gestão de Cadastros - RESULT</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    /* 🔥 ESTILOS DO SISTEMA */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    
    :root {
      --primary: #7E3E9A;
      --secondary: #A1CC4C;
      --accent: #FF6B35;
      --dark: #2D3047;
      --light: #FFFFFF;
      --success: #28A745;
      --warning: #FFC107;
      --danger: #DC3545;
      --info: #17A2B8;
      --gray: #6C757D;
      --border: #E0E0E0;
      --background: #F8F9FA;
    }
    
    body {
      background: var(--background);
      min-height: 100vh;
      padding: 20px;
      color: var(--dark);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--light);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .header {
      background: var(--primary);
      padding: 30px 40px;
      color: white;
      text-align: center;
    }

    
    .logo-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
    }
    
    .logo {
      width: 120px;
      height: 120px;
      background: white;
      padding: 15px;
      border-radius: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      object-fit: contain;
    }
    
    h1 {
      font-size: 2.8rem;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .subtitle {
      font-size: 1.3rem;
      opacity: 0.9;
    }
    
    .content {
      padding: 40px;
    }
    
 .card {
  background: var(--light);
  border-radius: 12px;
  padding: 30px;
  margin-bottom: 25px;
  margin-top: 40px; /* 🔥 ADICIONE ESTA LINHA - ESPAÇO ACIMA */
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
  border: 1px solid var(--border);
}
    
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 3px solid var(--primary);
    }
    
    .card-header i {
      color: var(--primary);
      font-size: 1.8rem;
    }
    
    .card-title {
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--primary);
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #6a2e82;
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-warning {
      background: var(--warning);
      color: var(--dark);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-info {
      background: var(--info);
      color: white;
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-sm {
      padding: 8px 16px;
      font-size: 0.9rem;
    }

 /* 🔥 ESTILOS PARA BOTÕES DE FILTRO ATIVOS */
.filtros-container .btn.active {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(126, 62, 154, 0.3);
  border: 2px solid var(--primary) !important;
}

/* Estilo específico para o botão "Todos" quando ativo */
.filtros-container .btn.active[onclick="filtrarTabela('all')"] {
  background: var(--primary) !important;
  color: white !important;
  border-color: var(--primary) !important;
}

/* Estilo para os outros botões quando ativos */
.filtros-container .btn.active:not([onclick="filtrarTabela('all')"]) {
  border: 2px solid var(--primary) !important;
  box-shadow: 0 0 0 3px rgba(126, 62, 154, 0.2) !important;
}
    
    .btn-group {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }
    
    .message {
      padding: 15px 20px;
      border-radius: 8px;
      margin: 15px 0;
      display: none;
      align-items: center;
      gap: 10px;
    }
    
    .success {
      background: #d4edda;
      color: var(--success);
      border: 1px solid #c3e6cb;
    }
    
    .error {
      background: #f8d7da;
      color: var(--danger);
      border: 1px solid #f5c6cb;
    }
    
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    /* 🔥 ESTILOS DE LOADING */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* 🔥 ESTILOS DA TABELA */
    .table-container {
      margin-top: 20px;
      overflow: hidden;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .table-responsive {
      overflow-x: auto;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      table-layout: fixed;
    }
    
    .data-table th {
      background: var(--primary);
      color: white;
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 0.9rem;
      position: sticky;
      top: 0;
    }
    
    .data-table td {
      padding: 12px 8px;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
      word-wrap: break-word;
    }
    
    .data-table tbody tr {
      transition: all 0.3s ease;
      display: table-row;
    }
    
    .data-table tbody tr:hover {
      background: #f8f9fa;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .data-table .btn-sm {
      padding: 6px 12px;
      font-size: 0.8rem;
      margin: 2px;
    }
    
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-align: center;
      display: inline-block;
      min-width: 80px;
    }
    
    .acoes-cell {
      display: flex;
      gap: 5px;
      justify-content: center;
      align-items: center;
    }
    
.action-buttons {
  display: flex;
  gap: 15px;
  margin: 40px 0 20px 0; /* 🔥 ADICIONA ESPAÇO ACIMA E ABAIXO */
  flex-wrap: wrap;
  /* REMOVE: padding, background, border, border-radius */
}
    
    .cadastros-container {
      margin-top: 30px;
      padding: 25px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border: 2px solid var(--primary);
    }
    
    .cadastros-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .cadastro-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      border: 2px solid var(--border);
      transition: all 0.3s ease;
    }
    
    .cadastro-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .cadastro-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }
    
    .cadastro-nome {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--dark);
    }
    
    .cadastro-situacao {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .situacao-cadastrado {
      background: #D1E7DD;
      color: #0F5132;
    }

    .situacao-novo-registro {
      background-color: #bfe1f6 !important;
      color: #0c5aa3 !important;
      border: 1px solid #8bc9f0 !important;
    }
    
    .situacao-andamento {
      background: #FFF3CD;
      color: #856404;
    }
    
    .situacao-rejeitado {
      background: #E2E3E5;
      color: #383D41;
    }
    
    .situacao-descredenciado {
      background: #F8D7DA;
      color: #721C24;
    }

    .situacao-desistiu {
      background: #e6cff2 !important;
      color: #4a1e6b !important;
      border: 1px solid #d4b5e6 !important;
    }
    
    .cadastro-info {
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    
    .cadastro-info strong {
      color: var(--primary);
    }
    
    .mensalidade-badge {
      background: var(--primary);
      color: white;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .filtros-container {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 10px; /* 🔥 ADICIONE ESTA LINHA */
    }

    .filtros-eventos {
      display: none;
      margin-top: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

/* 🔥 ESTILOS PARA FILTRO DE EVENTOS COM SEARCH */
.filtro-search-container {
  margin: 15px 0;
  padding: 15px;
  background: var(--light);
  border-radius: 10px;
  border: 1px solid var(--border);
}

.suggestions-evento {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid var(--primary);
  border-top: none;
  border-radius: 0 0 8px 8px;
  z-index: 1000;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  max-height: 200px;
  overflow-y: auto;
  margin-top: -2px;
}

.suggestion-evento-item {
  padding: 10px 15px;
  cursor: pointer;
  border-bottom: 1px solid var(--border);
  transition: all 0.2s ease;
  font-size: 0.9rem;
}

.suggestion-evento-item:hover {
  background: var(--primary);
  color: white;
}

.suggestion-evento-item:last-child {
  border-bottom: none;
}

.suggestion-evento-section {
  background: var(--primary);
  color: white;
  font-weight: 700;
  padding: 8px 15px;
  font-size: 0.8rem;
  border-bottom: 1px solid var(--border);
}

.filtro-chip {
  background: white;
  border: 2px solid var(--border);
  border-radius: 20px;
  padding: 6px 12px;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
}

.filtro-chip.ativo {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.filtro-chip .remover {
  background: none;
  border: none;
  color: inherit;
  cursor: pointer;
  padding: 0;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
}

.filtro-chip .remover:hover {
  background: rgba(255,255,255,0.3);
}
    
    /* 🔥 ESTILOS PARA PESQUISA */
    .search-container {
      position: relative;
    }

    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--primary);
      border-top: none;
      border-radius: 0 0 10px 10px;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      margin-top: -2px;
      max-height: 300px;
      overflow-y: auto;
    }

    .suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: all 0.2s ease;
      font-size: 1rem;
      font-weight: 500;
    }

    .suggestion-item:hover {
      background: var(--primary);
      color: white;
      font-weight: 600;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-section {
      background: var(--primary);
      color: white;
      font-weight: 700;
      padding: 10px 16px;
      font-size: 0.9rem;
      border-bottom: 1px solid var(--border);
    }

    .contador-lojas {
      background: var(--primary);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    /* 🔥 ESTILOS PARA CAMPOS OBRIGATÓRIOS */
    .form-label.obrigatorio::after {
      content: " *";
      color: var(--danger);
      font-weight: bold;
      margin-left: 2px;
    }

    .campo-obrigatorio {
      border-left: 4px solid var(--danger) !important;
      background-color: #fff5f5 !important;
    }

    .aviso-obrigatorio {
      color: var(--danger);
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 5px;
      display: none;
    }

    /* 🔥🔥🔥 ADICIONE ESTE CSS AQUI - ESTILOS MELHORADOS PARA VALIDAÇÃO */
    .form-control.campo-obrigatorio,
    select.campo-obrigatorio {
      border: 2px solid var(--danger) !important;
      background-color: #fff5f5 !important;
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1) !important;
      animation: pulse 0.5s ease-in-out;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

    /* Destaque para a seção de fornecedores quando inválida */
    .fornecedores-invalido {
      border: 2px solid var(--danger) !important;
      background: #fff5f5 !important;
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    /* 🔥 ESTILOS PARA BOTÕES DE AÇÃO NA TABELA */
    .btn-editar {
      background: var(--primary);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }
    
    .btn-editar:hover {
      background: #6a2e82;
    }
    
    .btn-visualizar {
      background: var(--info);
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }
    
    .btn-visualizar:hover {
      background: #138496;
    }

    /* 🔄 ESTILOS PARA O LOADING OVERLAY */
    #loadingOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .loading-content {
      background: white;
      padding: 40px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      min-width: 300px;
      border: 3px solid var(--primary);
    }

    .loading-spinner-large {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    .loading-text {
      margin: 0;
      color: var(--dark);
      font-weight: bold;
      font-size: 18px;
    }

    .loading-subtext {
      margin: 8px 0 0 0;
      color: var(--gray);
      font-size: 14px;
    }

    /* 🔥 ESTILOS PARA O MODAL DE DETALHES */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      border: 3px solid var(--primary);
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--primary);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
    }

    .btn-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray);
      padding: 5px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .btn-close:hover {
      background: var(--danger);
      color: white;
    }

    .detalhes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .detalhe-item {
      margin-bottom: 12px;
    }

    .detalhe-label {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 5px;
      display: block;
    }

    .detalhe-valor {
      color: var(--dark);
      background: #f8f9fa;
      padding: 8px 12px;
      border-radius: 8px;
      border-left: 3px solid var(--primary);
    }

    
/* 🔥🔥🔥 CORREÇÃO DEFINITIVA - LARGURAS E ALINHAMENTO */
.data-table {
  table-layout: fixed;
  width: 100%;
}

/* 🔥 LARGURAS DAS COLUNAS */
.data-table th:nth-child(1),
.data-table td:nth-child(1) {
  width: 25%; /* Razão Social */
}

.data-table th:nth-child(2),
.data-table td:nth-child(2) {
  width: 14%; /* CNPJ */
}

.data-table th:nth-child(3),
.data-table td:nth-child(3) {
  width: 20%; /* Fornecedor */
}

.data-table th:nth-child(4),
.data-table td:nth-child(4) {
  width: 12%; /* Mensalidade */
}

.data-table th:nth-child(5),
.data-table td:nth-child(5) {
  width: 12%; /* Adesão */
}

.data-table th:nth-child(6),
.data-table td:nth-child(6) {
  width: 17%; /* Ações */
}



/* 🔥 CORREÇÃO ESPECÍFICA PARA O BOTÃO VISUALIZAR */
.btn-visualizar-compact {
  padding: 8px 12px !important;
  font-size: 0.8rem !important;
  min-width: 100px;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
}

/* 🔥 GARANTIR QUE TODAS AS CÉLULAS TENHAM MESMA ALTURA */
.data-table tbody tr {
}


/* 🔥 EXCEÇÃO: Primeira coluna alinhada à esquerda */
.data-table td:nth-child(1) {
  text-align: left;
  vertical-align: top !important;
}

/* 🔥 LARGURAS DAS COLUNAS */
.data-table th:nth-child(6),
.data-table td:nth-child(6) {
  width: 17%; /* Ações */
}




/* 🔥 ESTILOS MELHORADOS PARA O CAMPO DE EVENTO SEARCH - CAIXA MAIOR */
#inputEventoSearch {
  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%237E3E9A" width="18" height="18"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>');
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 18px;
  padding-right: 40px;
  cursor: pointer;
  
  /* 🔥 AUMENTAR TAMANHO DA FONTE E ALTURA */
  font-size: 16px;
  padding: 15px 20px;
  height: auto;
  min-height: 50px;
}

/* 🔥 CORREÇÃO DEFINITIVA - REMOVER SCROLL HORIZONTAL */
.suggestions-evento-search {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 2px solid var(--primary);
  border-top: none;
  border-radius: 0 0 10px 10px;
  z-index: 1000;
  max-height: 300px;
  overflow-y: auto;
  overflow-x: hidden !important; /* 🔥 FORÇA REMOVER SCROLL HORIZONTAL */
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  
  /* 🔥 GARANTIR QUE OS TEXTOS NÃO CAUSEM SCROLL */
  white-space: normal !important; /* 🔥 PERMITE QUEBRA DE LINHA */
  word-wrap: break-word !important; /* 🔥 QUEBRA PALAVRAS LONGAS */
  width: 100% !important; /* 🔥 GARANTIR LARGURA CORRETA */
}

/* 🔥 GARANTIR QUE OS ITENS QUEBREM LINHA SE PRECISAR */
.suggestion-evento-item-search {
  padding: 12px 16px;
  cursor: pointer;
  border-bottom: 1px solid var(--border);
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 10px;
  
  /* 🔥 PERMITIR QUEBRA DE TEXTO */
  white-space: normal !important;
  word-wrap: break-word !important;
  overflow-wrap: break-word !important;
  line-height: 1.4; /* 🔥 MELHOR ESPAÇAMENTO */
}

.suggestion-evento-item-search:hover {
  background: var(--primary);
  color: white;
  transform: translateX(5px);
}

.suggestion-evento-item-search:last-child {
  border-bottom: none;
}

/* 🔥 SEÇÕES TAMBÉM */
.suggestion-evento-section-search {
  background: var(--primary);
  color: white;
  font-weight: 700;
  padding: 10px 16px;
  font-size: 0.9rem;
  border-bottom: 1px solid rgba(255,255,255,0.2);
  position: sticky;
  top: 0;
  display: flex;
  align-items: center;
  gap: 8px;
  
  white-space: normal !important;
  word-wrap: break-word !important;
  line-height: 1.4; /* 🔥 MELHOR ESPAÇAMENTO */
}

/* 🔥 CORREÇÃO ADICIONAL PARA O CONTAINER DO INPUT */
#eventoFormGroup {
  position: relative;
  width: 100%;
}

#eventoFormGroup .suggestions-evento {
  width: 100% !important;
  left: 0 !important;
  right: 0 !important;
}

/* 🔥 CORREÇÃO DO LABEL DA OBSERVAÇÃO */
.form-group:has(#observacoes) .form-label {
  margin-left: 100px !important;
  width: 85% !important;
}

/* 🔥 OBSERVAÇÃO MAIS PARA DIREITA */
#observacoes {
  margin-left: 50px !important;
  width: 90% !important;
  min-height: 100px;
}

/* 🔥 BOTÕES MAIS PARA DIREITA */
.btn-group {
  display: flex;
  gap: 15px;
  margin-top: 25px;
  justify-content: flex-end !important; /* 🔥 ALINHA À DIREITA */
  margin-left: auto; /* 🔥 EMPURRA PARA DIREITA */
  width: fit-content; /* 🔥 SÓ OCUPA O ESPAÇO NECESSÁRIO */
}

/* 🔥 OU SE PREFERIR ALINHAMENTO MAIS À DIREITA */
.form-group:last-of-type {
  display: flex;
  justify-content: flex-end;
}

.form-group:last-of-type textarea {
  width: 95%;
  margin-left: auto;
}

  /* 🔥🔥🔥 CORREÇÃO DEFINITIVA - ALINHAMENTO VERTICAL DA COLUNA AÇÕES */
.data-table tbody tr {
    display: table-row;
    height: auto;
}

.data-table td {
    vertical-align: middle !important;
    padding: 15px 8px !important;
    height: 100% !important;
    border-bottom: 1px solid var(--border);
}

/* 🔥🔥🔥 CORREÇÃO URGENTE - BOTÃO NO MEIO DA CÉLULA */
.data-table td:nth-child(6) {
    height: 100% !important;
    min-height: 100% !important;
    vertical-align: middle !important;
    padding: 0 !important;
    display: table-cell !important;
}

.acoes-cell {
    height: 100% !important;
    min-height: 100% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 0 !important;
    margin: 0 !important;
}

/* 🔥 GARANTIR QUE O BOTÃO OCUPE TODA A ALTURA */
.btn-visualizar-compact {
    height: 100% !important;
    min-height: 40px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 8px 12px !important;
    margin: 0 !important;
    width: 100%;
    border-radius: 6px !important;
}

/* 🔥 CORREÇÃO DA PRIMEIRA COLUNA (mantém alinhamento ao topo) */
.data-table td:nth-child(1) {
    vertical-align: top !important;
}

/* 🔥 CORREÇÃO DAS OUTRAS COLUNAS (alinhamento no meio) */
.data-table td:nth-child(2),
.data-table td:nth-child(3),
.data-table td:nth-child(4),
.data-table td:nth-child(5),
.data-table td:nth-child(6) {
    vertical-align: middle !important;
}

/* 🔥🔥🔥 ESTILOS PARA WAITLABELS */
.waitlabel-selector {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  padding: 20px;
  border-radius: 12px;
  border: 2px solid var(--border);
  margin-bottom: 25px;
}

.waitlabel-title {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.waitlabel-buttons {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.waitlabel-btn {
  padding: 12px 20px;
  border: 2px solid var(--border);
  border-radius: 8px;
  background: white;
  color: var(--dark);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 140px;
  justify-content: center;
}

.waitlabel-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.waitlabel-btn.active {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  border-width: 3px;
}

.waitlabel-indicator {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin-right: 5px;
}



.btn-aplicar-todos:hover {
  background: linear-gradient(135deg, #E55A2B 0%, #E57C2B 100%) !important;
  transform: translateY(-2px) !important;
  box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3) !important;
}

/* 🔥 ESTILOS PARA CHECKBOXES APLICAR A TODOS */
.checkbox-aplicar-todos {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 8px;
  padding: 8px 12px;
  background: #fff8f0;
  border-radius: 6px;
  border-left: 3px solid #FF6B35;
}

.checkbox-aplicar-todos input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: #FF6B35;
}

.checkbox-aplicar-todos label {
  font-size: 0.85rem;
  color: #FF6B35;
  font-weight: 600;
  cursor: pointer;
}

/* 🔥 MODO APLICAR A TODOS ATIVO */
.modo-aplicar-todos .form-group {
  border: 2px solid #fff8f0;
  border-radius: 8px;
  padding: 15px;
  background: #fffdfa;
}

.modo-aplicar-todos .card-header {
  background: linear-gradient(135deg, #fff8f0 0%, #fff0e0 100%);
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 20px;
}
  
    @media (max-width: 768px) {
      .content {
        padding: 20px;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .btn-group {
        flex-direction: column;
      }

        h1 {
        font-size: 2.2rem;
      }
      
      .logo {
        width: 80px;
        height: 80px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .cadastros-grid {
        grid-template-columns: 1fr;
      }
      
      .card-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .filtros-container {
        margin-top: 15px;
      }
      
      .data-table {
        font-size: 0.8rem;
      }
      
      .acoes-cell {
        flex-direction: column;
      }
      
      .waitlabel-buttons {
        flex-direction: column;
      }
      
      .waitlabel-btn {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo-container">
        <img src="https://i.ibb.co/B2r5xtbS/sim-cred-5.png" class="logo" alt="SIM CRED">
        <div class="header-content">
          <h1>Sistema de Cadastros de Lojas</h1>
          <div class="subtitle">Situação e Acompanhamento de Lojas</div>
          <div class="version">
            <i class="fas fa-rocket"></i>
            Versão 2.0
          </div>
        </div>
      </div>
    </div>
    
    <div class="content">
      <!-- 🔥🔥🔥 SEÇÃO WAITLABELS - ADICIONADA AQUI -->
      <div class="waitlabel-selector">
        <div class="waitlabel-title">
          <i class="fas fa-layer-group"></i>
          Selecione o White Label:
        </div>
        <div class="waitlabel-buttons" id="waitlabelButtons">
          <!-- Os botões serão preenchidos via JavaScript -->
        </div>
      </div>

      <!-- BOTÕES DE AÇÃO SIMPLIFICADOS -->
      <div class="action-buttons">
        <button type="button" class="btn btn-primary" onclick="mostrarTodosCadastros()">
          <i class="fas fa-store"></i>
          Ver Todos os Cadastros
        </button>
        <button type="button" class="btn btn-info" onclick="limparBusca()">
          <i class="fas fa-broom"></i>
          Limpar Busca
        </button>
      </div>

      <!-- CARD DADOS DO CADASTRO -->
      <div class="card" id="cardCadastro">
        <div class="card-header">
          <i class="fas fa-info-circle"></i>
          <h2 class="card-title">Dados do Cadastro</h2>
          <!-- 🔥 LOCAL PARA TÍTULO DO MODO APLICAR A TODOS -->
          <div id="tituloAplicarTodos" style="display: none;"></div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-building"></i>
              Razão Social
            </label>
            <input type="text" id="razao_social" class="form-control">
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-signature"></i>
              Nome Fantasia
            </label>
            <input type="text" id="nome_fantasia" class="form-control">
          </div>
          
          <!-- 🔥 CAMPO CNPJ ADICIONADO AQUI -->
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-id-card"></i>
              CNPJ
            </label>
            <input type="text" id="cnpj_cadastro" class="form-control" 
                   placeholder="Digite o CNPJ para cadastro..."
                   oninput="formatarCNPJ(this)">
          </div>
          
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-tag"></i>
              Tipo
            </label>
            <select id="tipo" class="form-control">
              <option value="">-- Selecione --</option>
              <option value="GERAL">GERAL</option>
              <option value="SORRIA SIM">SORRIA SIM</option>
              <option value="SORRIFACIL">SORRIFACIL</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-file-contract"></i>
              Contrato Enviado
            </label>
            <select id="contrato_enviado" class="form-control">
              <option value="">-- Selecione --</option>
              <option value="SIM">SIM</option>
              <option value="NAO">NAO</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-file-signature"></i>
              Contrato Assinado
            </label>
            <select id="contrato_assinado" class="form-control">
              <option value="">-- Selecione --</option>
              <option value="SIM">SIM</option>
              <option value="NAO">NAO</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-play-circle"></i>
              Ativação
            </label>
            <input type="date" id="ativacao" class="form-control">
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-link"></i>
              Link
            </label>
            <input type="text" id="link" class="form-control" placeholder="https://...">
          </div>
          
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-money-bill-wave"></i>
              Mensalidade
            </label>
            <input type="text" id="mensalidade" class="form-control" placeholder="R$ 0,00" oninput="formatarMoeda(this)">
          </div>

          <!-- 🔥 CAMPO ADESÃO -->
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-handshake"></i>
              Adesão
            </label>
            <input type="text" id="adesao" class="form-control" placeholder="R$ 0,00" oninput="formatarMoeda(this)" value="R$ 0,00">
            <small style="color: var(--gray); font-size: 0.8rem;">
              <i class="fas fa-info-circle"></i> Valor "0,00" será salvo como "Isento"
            </small>
          </div>
          
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-flag"></i>
              Situação
            </label>
            <select id="situacao" class="form-control">
              <option value="NOVO REGISTRO">NOVO REGISTRO</option>
              <option value="CADASTRADO">CADASTRADO</option>
              <option value="EM ANDAMENTO">EM ANDAMENTO</option>
              <option value="REJEITADO">REJEITADO</option>
              <option value="DESCREDENCIADO">DESCREDENCIADO</option>
              <option value="DESISTIU">DESISTIU</option>
            </select>
          </div>

          <!-- 🔥 FORNECEDORES COM TARIFAS INDIVIDUAIS -->
          <div class="form-group" style="grid-column: 1 / -1;">
            <label class="form-label">
              <i class="fas fa-truck"></i>
              Fornecedor(es) - <span style="color: var(--primary); font-weight: 600;">Selecione e configure cada um</span>
            </label>
            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 12px; border: 2px dashed var(--primary);">
              
              <!-- FORNECEDOR Agil -->
              <div class="fornecedor-item" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                  <input type="checkbox" name="fornecedor" value="Agil" style="width: 20px; height: 20px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'agil')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1.1rem;">AGIL</span>
                </div>
                <div id="config-agil" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 15px;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_agil" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_agil" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Valor da Tarifa</label>
                    <select name="percentual_agil" style="width: 100%; padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px;">
                      <option value="0%">0%</option>
                      <option value="1%">1%</option>
                      <option value="2%">2%</option>
                      <option value="3%">3%</option>
                      <option value="4%">4%</option>
                      <option value="5%">5%</option>
                      <option value="6%">6%</option>
                      <option value="7%">7%</option>
                      <option value="8%">8%</option>
                      <option value="9%">9%</option>
                      <option value="10%">10%</option>
                      <option value="11%">11%</option>
                      <option value="12%">12%</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- FORNECEDOR BC -->
              <div class="fornecedor-item" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                  <input type="checkbox" name="fornecedor" value="BC" style="width: 20px; height: 20px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'bc')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1.1rem;">BC</span>
                </div>
                <div id="config-bc" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 15px;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_bc" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_bc" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Valor da Tarifa</label>
                    <select name="percentual_bc" style="width: 100%; padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px;">
                      <option value="0%">0%</option>
                      <option value="1%">1%</option>
                      <option value="2%">2%</option>
                      <option value="3%">3%</option>
                      <option value="4%">4%</option>
                      <option value="5%">5%</option>
                      <option value="6%">6%</option>
                      <option value="7%">7%</option>
                      <option value="8%">8%</option>
                      <option value="9%">9%</option>
                      <option value="10%">10%</option>
                      <option value="11%">11%</option>
                      <option value="12%">12%</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- FORNECEDOR PARCELEX -->
              <div class="fornecedor-item" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                  <input type="checkbox" name="fornecedor" value="Parcelex" style="width: 20px; height: 20px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'parcelex')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1.1rem;">PARCELEX</span>
                </div>
                <div id="config-parcelex" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 15px;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_parcelex" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_parcelex" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Valor da Tarifa</label>
                    <select name="percentual_parcelex" style="width: 100%; padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px;">
                      <option value="0%">0%</option>
                      <option value="1%">1%</option>
                      <option value="2%">2%</option>
                      <option value="3%">3%</option>
                      <option value="4%">4%</option>
                      <option value="5%">5%</option>
                      <option value="6%">6%</option>
                      <option value="7%">7%</option>
                      <option value="8%">8%</option>
                      <option value="9%">9%</option>
                      <option value="10%">10%</option>
                      <option value="11%">11%</option>
                      <option value="12%">12%</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- FORNECEDOR AGORACRED -->
              <div class="fornecedor-item" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                  <input type="checkbox" name="fornecedor" value="Agoracred" style="width: 20px; height: 20px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'agoracred')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1.1rem;">AGORACRED</span>
                </div>
                <div id="config-agoracred" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 15px;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_agoracred" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_agoracred" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Valor da Tarifa</label>
                    <select name="percentual_agoracred" style="width: 100%; padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px;">
                      <option value="0%">0%</option>
                      <option value="1%">1%</option>
                      <option value="2%">2%</option>
                      <option value="3%">3%</option>
                      <option value="4%">4%</option>
                      <option value="5%">5%</option>
                      <option value="6%">6%</option>
                      <option value="7%">7%</option>
                      <option value="8%">8%</option>
                      <option value="9%">9%</option>
                      <option value="10%">10%</option>
                      <option value="11%">11%</option>
                      <option value="12%">12%</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- FORNECEDOR AFINZ -->
              <div class="fornecedor-item" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                  <input type="checkbox" name="fornecedor" value="Afinz" style="width: 20px; height: 20px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'afinz')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1.1rem;">AFINZ</span>
                </div>
                <div id="config-afinz" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 15px;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_afinz" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_afinz" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Valor da Tarifa</label>
                    <select name="percentual_afinz" style="width: 100%; padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px;">
                      <option value="0%">0%</option>
                      <option value="1%">1%</option>
                      <option value="2%">2%</option>
                      <option value="3%">3%</option>
                      <option value="4%">4%</option>
                      <option value="5%">5%</option>
                      <option value="6%">6%</option>
                      <option value="7%">7%</option>
                      <option value="8%">8%</option>
                      <option value="9%">9%</option>
                      <option value="10%">10%</option>
                      <option value="11%">11%</option>
                      <option value="12%">12%</option>
                    </select>
                  </div>
                </div>
              </div>

            </div>
          </div>

                    <!-- 🔥 MANTENHA EXATAMENTE ASSIM - SÓ ADICIONE UM ID NO FORM-GROUP -->
          <div class="form-group" id="eventoFormGroup">
            <label class="form-label">
              <i class="fas fa-calendar-check"></i>
              Evento
            </label>
            
            <!-- 🔥 MANTENHA O SELECT ORIGINAL, MAS VAMOS ESCONDER ELE -->
            <select id="evento" class="form-control" style="display: none;">
              <option value="">-- Selecione um evento --</option>
            </select>
            
            <!-- 🔥 AUMENTAR LARGURA DIRETAMENTE NO INPUT -->
            <div style="position: relative; width: 100%;">
              <input type="text" 
                     id="inputEventoSearch" 
                     class="form-control" 
                     placeholder="Digite para buscar evento..."
                     oninput="filtrarSugestoesEventoSearch()"
                     style="padding-right: 40px; width: 100%; min-width: 400px;">
              
              <div class="suggestions-evento" id="suggestionsEventoSearch" style="display: none;">
              </div>
            </div>

            <!-- ✅ ✅ ✅ CORREÇÃO DO CHECKBOX - MUDAR data-campo para "inputEventoSearch" -->
            <div class="checkbox-aplicar-todos">
              <input type="checkbox" id="check_eventos" data-campo="inputEventoSearch" onchange="toggleCampoParaTodos('inputEventoSearch')">
              <label for="check_eventos">
                  <i class="fas fa-copy"></i> Aplicar Evento a todos
              </label>
            </div>
          </div> <!-- ← ESTE </div> FECHA TUDO -->

          

 
<!-- OBSERVAÇÃO ALINHADA À DIREITA -->
<div class="form-group" style="display: flex; justify-content: flex-end;">
  <div style="width: 95%;">
    <label class="form-label">
      <i class="fas fa-sticky-note"></i>
      Observação
    </label>
    <textarea id="observacoes" class="form-control" rows="3" style="width: 100%;"></textarea>
    <!-- 🔥 REMOVIDO O CHECKBOX DA OBSERVAÇÃO -->
  </div>
</div>

          <!-- BOTÕES ALINHADOS À DIREITA -->
          <div class="btn-group" style="justify-content: flex-end; margin-left: auto; width: fit-content;">
            <button type="button" class="btn btn-success" onclick="cadastrar()" id="btnCadastrar">
              <i class="fas fa-plus-circle"></i>
              Cadastrar
            </button>
            <button type="button" class="btn btn-warning" onclick="atualizar()" id="btnAtualizar" style="display: none;">
              <i class="fas fa-save"></i>
              Atualizar
            </button>

            <!-- 🔥 BOTÃO APLICAR A TODOS (APARECE QUANDO CONFIGURADO) -->
            <button type="button" class="btn btn-aplicar-todos" id="btnAplicarATodos" onclick="aplicarAlteracoesATodos()" style="display: none;">
              <i class="fas fa-copy"></i>
              Aplicar a Todos
            </button>
          </div>
        </div>
      </div>

      <!-- SEÇÃO: TODOS OS CADASTROS -->
      <div class="cadastros-container" id="secaoCadastros" style="display: none;">
        <div class="card-header">
          <i class="fas fa-store"></i>
          <h2 class="card-title" id="tituloCadastros">Todos os Cadastros</h2>
        </div>

        <!-- NOVA SEÇÃO: FILTRO POR SITUAÇÃO -->
        <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--primary);">
          <div style="font-weight: 600; color: var(--primary); margin-bottom: 10px;">
            <i class="fas fa-filter"></i> Filtrar por Situação:
          </div>
          <div class="filtros-container" id="filtrosContainer" style="display: none;">
            <button type="button" class="btn btn-outline btn-sm" onclick="filtrarTabela('all')">
              Todos
            </button>
            <button type="button" class="btn btn-sm" onclick="filtrarTabela('NOVO REGISTRO')" style="background-color: #bfe1f6; color: #2D3047; border: 1px solid #a1c9e4;">
              Novos
            </button>
            <button type="button" class="btn btn-success btn-sm" onclick="filtrarTabela('CADASTRADO')">
              Cadastrados
            </button>
            <button type="button" class="btn btn-warning btn-sm" onclick="filtrarTabela('EM ANDAMENTO')">
              Em Andamento
            </button>
            <!-- 🔥 CORREÇÃO: REJEITADO AGORA É CINZA -->
            <button type="button" class="btn btn-secondary btn-sm" onclick="filtrarTabela('REJEITADO')">
              Rejeitado
            </button>
            <!-- 🔥 CORREÇÃO: DESCREDENCIADO AGORA É VERMELHO -->
            <button type="button" class="btn btn-danger btn-sm" onclick="filtrarTabela('DESCREDENCIADO')">
              Descredenciados
            </button>
            <!-- NOVO BOTÃO DESISTIU -->
            <button type="button" class="btn btn-sm" onclick="filtrarTabela('DESISTIU')" style="background-color: #e6cff2; color: #4a1e6b; border: 1px solid #d4b5e6;">
              Desistiu
            </button>
          </div>

          <!-- BARRA DE PESQUISA MELHORADA -->
          <div class="form-group" style="margin-bottom: 20px;">
            <div class="search-container">
              <input type="text" id="pesquisaCadastros" class="form-control" 
                     placeholder="Pesquisar por nome, CNPJ ou fornecedor..."
                     oninput="filtrarPesquisa()">
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
              <span class="contador-lojas" id="contadorCadastros">0 cadastros</span>
              
              <div style="display: flex; gap: 10px; align-items: center;">
                <select id="ordenacaoCadastros" onchange="ordenarCadastros()" style="padding: 8px 12px; border: 2px solid var(--border); border-radius: 8px;">
                  <option value="razao_social">Ordenar por Razão Social</option>
                  <option value="nome_fantasia">Ordenar por Nome Fantasia</option>
                  <option value="fornecedor">Ordenar por Fornecedor</option>
                  <option value="situacao">Ordenar por Situação</option>
                  <option value="defasagem">Ordenar por Defasagem</option>
                </select>
                
                <button type="button" class="btn btn-info btn-sm" onclick="recarregarCadastros()">
                  <i class="fas fa-sync-alt"></i> Atualizar
                </button>
              </div>
            </div>
          </div>

          <!-- 🔥 FILTRO DE EVENTOS COM SEARCH -->
          <div class="filtro-search-container" id="filtroEventoContainer" style="display: none; position: relative;">
            <div style="position: relative; width: 300px;">
              <input type="text" 
                     id="inputFiltroEvento" 
                     class="form-control" 
                     placeholder="Digite o evento para filtrar..."
                     oninput="filtrarSugestoesEvento()">
            </div>
            
            <div class="suggestions-evento" id="suggestionsEvento" style="display: none;">
              <!-- Sugestões aparecerão aqui -->
            </div>
            
            <!-- TAGS DE FILTROS ATIVOS -->
            <div id="tagsFiltrosAtivos" style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;"></div>
          </div>

          <!-- LOADING -->
          <div class="loading-container" id="loadingCadastros" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Carregando cadastros...</p>
          </div>
          
          <!-- TABELA MELHORADA -->
          <div class="table-container" id="tableContainer" style="display: none;">
            <div class="table-responsive">
              <table class="data-table" id="tabelaCadastros">
                <thead>
                  <tr>
                    <th>Razão Social</th>
                    <th>CNPJ</th>
                    <th>Fornecedor</th>
                    <th>Mensalidade</th>
                    <th>Adesão</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="tabelaCadastrosBody">
                  <!-- Dados serão preenchidos via JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- MENSAGENS DO SISTEMA -->
      <div id="messageSuccess" class="message success" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <span></span>
      </div>
      
      <div id="messageError" class="message error" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span></span>
      </div>

      <div id="messageInfo" class="message info" style="display: none;">
        <i class="fas fa-info-circle"></i>
        <span></span>
      </div>
    </div>
  </div>

  <!-- 🔄 OVERLAY DE CARREGAMENTO -->
  <div id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner-large"></div>
      <p class="loading-text">Salvando dados...</p>
      <p class="loading-subtext">Aguarde um momento</p>
    </div>
  </div>

  <!-- 🔥 MODAL DE DETALHES - ESTRUTURA CORRIGIDA -->
  <div id="modalDetalhes" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">📋 Detalhes do Cadastro</h3>
        <button class="btn-close" onclick="fecharModalDetalhes()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div id="modalDetalhesContent">
        <!-- Conteúdo será preenchido via JavaScript -->
      </div>

      <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border);">
        <button class="btn btn-primary" onclick="fecharModalDetalhes()">
          <i class="fas fa-check"></i> Fechar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Senha - VERSÃO CORRIGIDA -->
  <div id="modalSenha" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">🔒 Acesso Restrito</h3>
        <button class="btn-close" onclick="fecharModalSenha()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div style="padding: 20px;">
        <p>Para editar este campo é necessário informar a senha:</p>
        <input type="password" id="inputSenha" class="form-control" placeholder="Digite a senha" style="margin: 15px 0;">
        <div class="btn-group">
          <button class="btn btn-primary" onclick="validarSenha()">
            <i class="fas fa-check"></i> Validar
          </button>
          <button class="btn btn-outline" onclick="fecharModalSenha()">
            <i class="fas fa-times"></i> Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
// 🔥 VARIÁVEIS GLOBAIS

// 🔥 VARIÁVEIS PARA "APLICAR A TODOS"
let camposParaAplicarATodos = {};
let cnpjAtualParaAplicar = null;
let cadastroAtualId = null;
let todosCadastros = [];
let cadastrosFiltrados = [];
let campoEditavel = null;
const SENHA_PERMITIDA = '519901';
let waitlabelAtual = 'Sim_Facilita'; // 🔥 VARIÁVEL PARA WAITLABEL ATUAL

// 🔥 CONFIGURAÇÃO DOS WAITLABELS
const WAITLABELS_CONFIG = {
  WAITLABELS: ['Sim_Facilita', 'Result', 'Set_9', 'Doktorbank', 'Dr_Parcela'],
  CORES: {
    'Sim_Facilita': '#7E3E9A',
    'Result': '#2EBE76', 
    'Set_9': '#0682c5',
    'Doktorbank': '#E61B72',
    'Dr_Parcela': '#696969'
  }
};

// 🔥 VARIÁVEIS DOS EVENTOS PARA FILTRO - CONVERTIDAS PARA MAIÚSCULAS
const eventosNovoRegistro = [
  "NOVO CADASTRO", "PRIMEIRO CONTATO", "CLIENTE INTERESSADO", "SOLICITOU MAIS INFORMACOES",
  "AGENDAMENTO DE DEMONSTRACAO", "PROPOSTA ENVIADA", "AGUARDANDO RETORNO"
].sort();

const eventosCadastrado = [
  "LOJA CADASTRADA", "DOCUMENTACAO RECEBIDA", "CONTRATO ENVIADO", "AGUARDANDO ASSINATURA",
  "CADASTRO APROVADO", "AGUARDANDO ATIVACAO"
].sort();

const eventosEmAndamento = [
  "AGUARDANDO ACEITE DA LOJA", "AGUARDANDO ACEITE DO FORNECEDOR", "AGUARDANDO DOCUMENTOS",
  "AGUARDANDO RETORNO", "AGENDAMENTO DE DEMONSTRACAO", "CLIENTE INTERESSADO", 
  "CLIENTE NAO INTERESSADO", "CONDICAO ESPECIAL", "CONTRATO ASSINADO", "DESISTIU",
  "DOCUMENTACAO INCOMPLETA", "EM IMPLANTACAO", "EM TREINAMENTO", "ENVIO DE BOLETO",
  "ENVIO DE WHATSAPP", "FOLLOW-UP NECESSARIO", "FORNECEDOR ALTERADO", "LIGACAO REALIZADA",
  "NEGOCIACAO EM ANDAMENTO", "PAGAMENTO EFETUADO", "PAGAMENTO PENDENTE", "PROPOSTA ENVIADA",
  "QUANTIDADE DE LOJAS ALTERADA", "RECADO REGISTRADO", "REUNIAO AGENDADA", "SEM RETORNO",
  "SOLICITOU MAIS INFORMACOES", "TELEFONE ALTERADO"
].sort();

const eventosRejeitado = [
  "REJEITADO", "BLOQUEADO", "DESISTIU", "CLIENTE NAO INTERESSADO", "SEM RETORNO",
  "NEGOCIACAO PARADA", "PROCESSO ESTAGNADO"
].sort();

const eventosDescredenciado = [
  "DESCREDENCIADO", "CONTRATO CANCELADO", "LOJA DESATIVADA", "FORNECEDOR REMOVIDO",
  "PROCESSO ENCERRADO", "CADASTRO EXPIRADO"
].sort();

// 🔥 NOVOS EVENTOS PARA SITUAÇÃO "DESISTIU"
const eventosDesistiu = [
  "DESISTIU", "CLIENTE DESISTIU", "DESISTÊNCIA DO CLIENTE", "DESISTÊNCIA VOLUNTÁRIA",
  "DESISTIU DO PROCESSO", "DESISTIU DA NEGOCIAÇÃO", "DESISTIU DO CADASTRO",
  "NÃO QUIS CONTINUAR", "DESINTERESSE DO CLIENTE", "ABANDONOU O PROCESSO"
].sort();

// ✅ VERIFICAR SE USUÁRIO JÁ ESTÁ AUTORIZADO AO CARREGAR A PÁGINA
document.addEventListener('DOMContentLoaded', function() {
  console.log('Sistema de Gestão de Cadastros - RESULT inicializado');
  
  // 🔥 INICIALIZAR WAITLABELS
  inicializarWaitlabels();
  
  // Inicializar valores padrão
  document.getElementById('mensalidade').value = 'R$ 0,00';
  document.getElementById('situacao').value = 'Cadastrado';
  
  // Configurações iniciais
  configurarValidacaoEmTempoReal();
  document.getElementById('situacao').addEventListener('change', atualizarEventos);
  atualizarEventos();
  
  // 🔥 CORREÇÃO: Configurar proteção APÓS o DOM estar carregado
  setTimeout(() => {
    configurarCamposProtegidos();
  }, 500);
  
  // Configurar eventos do modal de senha
  configurarModalSenha();
  
  // 🔥🔥🔥 NOVA LINHA: Sincronizar campos de evento
  sincronizarCamposEvento();
  
  // 🔥🔥🔥 CORREÇÃO: Configurar evento do campo de evento
  const inputEvento = document.getElementById('inputEventoSearch');
  if (inputEvento) {
    inputEvento.addEventListener('focus', function() {
      console.log("🎯 Campo de evento recebeu foco - mostrando sugestões");
      filtrarSugestoesEventoSearch();
    });
  }
});

// 🔥🔥🔥 FUNÇÕES PARA WAITLABELS
function inicializarWaitlabels() {
  console.log("🎯 Inicializando waitlabels...");
  
  // Buscar waitlabel atual do servidor
  google.script.run
    .withSuccessHandler(function(waitlabel) {
      waitlabelAtual = waitlabel;
      console.log("✅ Waitlabel atual:", waitlabelAtual);
      criarBotoesWaitlabels();
      atualizarInterfaceWaitlabel();
    })
    .withFailureHandler(function(error) {
      console.error("❌ Erro ao buscar waitlabel:", error);
      criarBotoesWaitlabels(); // Criar mesmo com erro
    })
    .getWaitlabelAtual();
}

// 🔥 FUNÇÕES PARA "APLICAR A TODOS"
function toggleCampoParaTodos(campoId) {
    console.log("🎯 Toggle campo para aplicar a todos:", campoId);
    
    // ✅ CORREÇÃO: Se for o campo de evento search, usar 'evento' como ID
    const campoParaAplicar = campoId === 'inputEventoSearch' ? 'evento' : campoId;
    
    // Alternar estado do campo
    camposParaAplicarATodos[campoParaAplicar] = !camposParaAplicarATodos[campoParaAplicar];
    
    // Atualizar visual do checkbox
    const checkbox = document.querySelector(`[data-campo="${campoId}"]`);
    if (checkbox) {
        checkbox.checked = camposParaAplicarATodos[campoParaAplicar];
    }
    
    console.log("📋 Campos selecionados para aplicar:", camposParaAplicarATodos);
}

function aplicarAlteracoesATodos() {
    console.log("🎯 Aplicando alterações a todos do mesmo CNPJ...");
    
    const btnAplicar = document.getElementById('btnAplicarATodos');
    if (btnAplicar && btnAplicar.disabled) {
        console.log("⏳ Botão já está processando, aguarde...");
        return;
    }
    
    if (btnAplicar) {
        btnAplicar.disabled = true;
        btnAplicar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aplicando...';
    }
    
    const camposSelecionados = Object.keys(camposParaAplicarATodos).filter(campo => camposParaAplicarATodos[campo]);
    
    if (camposSelecionados.length === 0) {
        showMessage('error', '❌ Selecione pelo menos um campo para aplicar a todos!');
        if (btnAplicar) {
            btnAplicar.disabled = false;
            btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
        }
        return;
    }
    
    const dadosAtuais = coletarDadosFormulario();
    if (!dadosAtuais) {
        showMessage('error', '❌ Erro ao coletar dados do formulário');
        if (btnAplicar) {
            btnAplicar.disabled = false;
            btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
        }
        return;
    }
    
    const cnpjCorreto = document.getElementById('cnpj_cadastro')?.value || dadosAtuais.cnpj;
    
    if (!cnpjCorreto) {
        showMessage('error', '❌ CNPJ não identificado!');
        if (btnAplicar) {
            btnAplicar.disabled = false;
            btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
        }
        return;
    }
    
    // MOSTRAR POPUP BONITO EM VEZ DO CONFIRM
    mostrarPopupAplicarTodos(cnpjCorreto, camposSelecionados, dadosAtuais);
}
    
// Função para popup MAIS BONITO com tema roxo
// Função para popup MAIS BONITO com tema roxo
function mostrarPopupAplicarTodos(cnpj, camposSelecionados, dados) {
    // ✅ CORREÇÃO: Formatar os valores ANTES de mostrar no popup
    const formatarValorParaPopup = (campo, valor) => {
        // Formatar data
        if (campo === 'ativacao' && valor && valor !== 'Não preenchido') {
            if (valor.includes('-')) {
                const partes = valor.split('-');
                if (partes.length === 3) {
                    return `${partes[2]}/${partes[1]}/${partes[0]}`;
                }
            }
            return valor;
        }
        
        // Formatar moeda
        if ((campo === 'mensalidade' || campo === 'adesao') && valor && valor !== 'Não preenchido') {
            if (typeof valor === 'number' || !isNaN(parseFloat(valor))) {
                const numero = parseFloat(valor);
                return numero.toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                });
            } else if (typeof valor === 'string') {
                // Tentar extrair número da string
                const numeroMatch = valor.match(/[\d,\.]+/);
                if (numeroMatch) {
                    const numero = parseFloat(numeroMatch[0].replace(/\./g, '').replace(',', '.'));
                    if (!isNaN(numero)) {
                        return numero.toLocaleString('pt-BR', {
                            style: 'currency',
                            currency: 'BRL'
                        });
                    }
                }
            }
        }
        
        // Capitalizar evento
        if (campo === 'evento' && valor && valor !== 'Não preenchido') {
            return valor.charAt(0).toUpperCase() + valor.slice(1).toLowerCase();
        }
        
        return valor;
    };

    // Criar modal customizado ESTILOSO
    const modalHTML = `
        <div id="modalAplicarTodos" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:9999; font-family: 'Segoe UI', Arial, sans-serif;">
            <div style="background:linear-gradient(135deg, #ffffff 0%, #f8f6ff 100%); padding:25px; border-radius:15px; width:450px; box-shadow:0 10px 30px rgba(0,0,0,0.3); border:3px solid #8B5FBF; position:relative;">
                <!-- Header com gradiente roxo -->
                <div style="background:linear-gradient(135deg, #8B5FBF 0%, #6A4C9C 100%); color:white; padding:15px; margin:-25px -25px 20px -25px; border-radius:12px 12px 0 0; text-align:center;">
                    <h3 style="margin:0; font-size:20px; font-weight:600;">🎯 Aplicar Alterações em Lote</h3>
                </div>
                
                <!-- Informações -->
                <div style="margin-bottom:20px;">
                    <div style="display:flex; align-items:center; margin-bottom:10px;">
                        <span style="background:#8B5FBF; color:white; padding:5px 10px; border-radius:20px; font-size:12px; font-weight:bold;">📋 CNPJ</span>
                        <span style="margin-left:10px; font-weight:600; color:#333;">${cnpj}</span>
                    </div>
                    
                    <div style="display:flex; align-items:center; margin-bottom:15px;">
                        <span style="background:#8B5FBF; color:white; padding:5px 10px; border-radius:20px; font-size:12px; font-weight:bold;">🏢 Registros</span>
                        <span style="margin-left:10px; color:#666;">Todos com este CNPJ</span>
                    </div>
                </div>
                
                <!-- Campos que serão alterados -->
                <div style="background:#f0ebfa; padding:15px; border-radius:10px; margin-bottom:20px; border-left:4px solid #8B5FBF;">
                    <div style="display:flex; align-items:center; margin-bottom:10px;">
                        <span style="color:#8B5FBF; font-weight:bold; font-size:16px;">📝 Campos Selecionados</span>
                    </div>
                    <div style="max-height:150px; overflow-y:auto;">
                      ${camposSelecionados.map(campo => {
                          const nomeCampo = formatarNomeCampoPopup(campo); // ✅ USA A NOVA FUNÇÃO
                          let valorCampo = dados[campo] || document.getElementById(campo)?.value || 'Não preenchido';

                          // ✅ APLICAR FORMATAÇÃO DIRETAMENTE AQUI
                          valorCampo = formatarValorParaPopup(campo, valorCampo);

                          return `
                              <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 5px; border-bottom:1px solid #e0e0e0;">
                                  <span style="color:#555; font-weight:500;">${nomeCampo}</span>
                                  <span style="background:#8B5FBF; color:white; padding:4px 8px; border-radius:12px; font-size:12px; font-weight:bold;">${valorCampo}</span>
                              </div>
                          `;
                      }).join('')}
                    </div>
                </div>
                
                <!-- Aviso -->
                <div style="background:#fff3cd; border:2px solid #ffc107; padding:12px; border-radius:8px; margin-bottom:20px; display:flex; align-items:center;">
                    <span style="color:#856404; font-size:24px; margin-right:10px;">⚠️</span>
                    <span style="color:#856404; font-size:13px; font-weight:500;">Esta ação atualizará TODOS os registros e não pode ser desfeita</span>
                </div>
                
                <!-- Botões -->
                <div style="display:flex; gap:12px; justify-content:flex-end;">
                    <button onclick="fecharPopupAplicarTodos(false)" style="padding:12px 20px; border:2px solid #6c757d; background:white; color:#6c757d; border-radius:8px; cursor:pointer; font-weight:600; transition:all 0.3s; display:flex; align-items:center; gap:5px;">
                        <span>✖</span> Cancelar
                    </button>
                    <button onclick="fecharPopupAplicarTodos(true)" style="padding:12px 25px; background:linear-gradient(135deg, #28a745 0%, #20c997 100%); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; transition:all 0.3s; display:flex; align-items:center; gap:5px; box-shadow:0 4px 15px rgba(40, 167, 69, 0.3);">
                        <span>✅</span> Aplicar a Todos
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Funções auxiliares
// ✅ CORREÇÃO: Função para padronizar nomes dos campos
const formatarNomeCampoPopup = (campo) => {
    const nomes = {
        'razao_social': 'Razão Social',
        'nome_fantasia': 'Nome Fantasia', 
        'cnpj_cadastro': 'CNPJ',
        'tipo': 'Tipo',
        'contrato_enviado': 'Contrato Enviado',
        'contrato_assinado': 'Contrato Assinado',
        'ativacao': 'Ativação',
        'link': 'Link',
        'mensalidade': 'Mensalidade',
        'adesao': 'Adesão',
        'situacao': 'Situação',
        'evento': 'Evento',
        'observacoes': 'Observações',
        'inputEventoSearch': 'Evento'
    };
    
    return nomes[campo] || campo;
};

function obterValorCampo(campo, dados) {
    let valor = dados[campo] || document.getElementById(campo)?.value || 'Não preenchido';
    
    // ✅ CORREÇÃO 1: Formatar data para BR
    if (campo === 'ativacao' && valor && valor !== 'Não preenchido') {
        // Formato: 2025-10-02 → 02/10/2025
        if (valor.includes('-')) {
            const partes = valor.split('-');
            if (partes.length === 3) {
                valor = `${partes[2]}/${partes[1]}/${partes[0]}`;
            }
        }
    }
    
    // ✅ CORREÇÃO 2: Formatar moeda para Mensalidade e Adesão
    if ((campo === 'mensalidade' || campo === 'adesao') && valor && valor !== 'Não preenchido') {
        if (typeof valor === 'number' || !isNaN(parseFloat(valor))) {
            // Se for número, formatar como moeda
            const numero = parseFloat(valor);
            valor = numero.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        } else if (typeof valor === 'string' && !valor.includes('R$')) {
            // Se for string sem formatação, tentar converter
            const numero = parseFloat(valor.replace(/[^\d,]/g, '').replace(',', '.'));
            if (!isNaN(numero)) {
                valor = numero.toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                });
            }
        }
    }
    
    // ✅ CORREÇÃO 3: Capitalizar primeira letra do Evento
    if (campo === 'evento' && valor && valor !== 'Não preenchido') {
        valor = valor.charAt(0).toUpperCase() + valor.slice(1).toLowerCase();
    }
    
    return valor;
}

function fecharPopupAplicarTodos(confirmado) {
    const modal = document.getElementById('modalAplicarTodos');
    if (modal) modal.remove();
    
    if (confirmado) {
        // Continuar com o processo original de aplicar a todos
        const btnAplicar = document.getElementById('btnAplicarATodos');
        const camposSelecionados = Object.keys(camposParaAplicarATodos).filter(campo => camposParaAplicarATodos[campo]);
        const dadosAtuais = coletarDadosFormulario();
        const cnpjCorreto = document.getElementById('cnpj_cadastro')?.value || dadosAtuais.cnpj;
        
        console.log("🚀 CHAMANDO GOOGLE APPS SCRIPT...");
        showLoading(`Aplicando alterações para ${camposSelecionados.length} campo(s)...`, "Atualizando todos os registros do mesmo CNPJ");
        
        google.script.run
            .withSuccessHandler(function(res) {
                console.log("✅ RESPOSTA DO GS:", res);
                hideLoading();
                
                if (btnAplicar) {
                    btnAplicar.disabled = false;
                    btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
                }
                
                if (res && res.success) {
                    showMessage('success', `✅ ${res.registrosAtualizados} registro(s) atualizado(s) com sucesso!`);
                    limparSelecaoAplicarATodos();
                    if (document.getElementById('secaoCadastros').style.display === 'block') {
                        mostrarTodosCadastros();
                    }
                } else {
                    showMessage('error', '❌ ' + (res ? res.message : 'Erro ao aplicar alterações'));
                }
            })
            .withFailureHandler(function(error) {
                console.error("❌ ERRO DO GS:", error);
                hideLoading();
                
                if (btnAplicar) {
                    btnAplicar.disabled = false;
                    btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
                }
                
                showMessage('error', '❌ Erro: ' + error.message);
            })
            .aplicarAlteracoesATodos(cnpjCorreto, dadosAtuais, camposSelecionados);
    } else {
        // Usuário cancelou - reativar botão
        const btnAplicar = document.getElementById('btnAplicarATodos');
        if (btnAplicar) {
            btnAplicar.disabled = false;
            btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
        }
    }
}

function limparSelecaoAplicarATodos() {
    camposParaAplicarATodos = {};
    cnpjAtualParaAplicar = null;
    
    // Limpar checkboxes visuais
    document.querySelectorAll('[data-campo]').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Remover botão "Aplicar a Todos"
    const btnAplicar = document.getElementById('btnAplicarATodos');
    if (btnAplicar) {
        btnAplicar.style.display = 'none';
    }
    
    // Remover checkboxes dos campos
    document.querySelectorAll('.checkbox-aplicar-todos').forEach(checkbox => {
        checkbox.remove();
    });
    
    // Remover título
    const titulo = document.getElementById('tituloAplicarTodos');
    if (titulo) {
        titulo.style.display = 'none';
        titulo.innerHTML = '';
    }
    
    // Remover classe do card
    document.getElementById('cardCadastro').classList.remove('modo-aplicar-todos');
}

// 🔥 FUNÇÃO PARA CONFIGURAR "APLICAR A TODOS"
function configurarAplicarATodos(cnpj, id) {
    console.log("🎯 CONFIGURANDO APLICAR A TODOS - CNPJ:", cnpj, "ID:", id);
    
    // Fechar modal atual
    fecharModalDetalhes();
    
    // Carregar o cadastro para edição
    editarCadastroModal(id);
    
    // Configurar para aplicar a todos do mesmo CNPJ
    setTimeout(() => {
        cnpjAtualParaAplicar = cnpj;
        cadastroAtualId = id;
        
        // Mostrar interface de "Aplicar a Todos"
        mostrarInterfaceAplicarATodos();
        
        showMessage('info', '🎯 Modo "Aplicar a Todos" ativado! Selecione os campos que deseja aplicar.');
    }, 1000);
}

// 🔥 FUNÇÃO PARA MOSTRAR INTERFACE "APLICAR A TODOS"
function mostrarInterfaceAplicarATodos() {
    // Adicionar checkboxes em todos os campos
    adicionarCheckboxesAosCampos();
    
    // Mostrar botão principal
    mostrarBotaoAplicarATodos();
    
    // Adicionar título especial
    const titulo = document.getElementById('tituloAplicarTodos');
    if (titulo) {
        titulo.style.display = 'block';
        titulo.innerHTML = `
            <div style="background: linear-gradient(135deg, #FF6B35 0%, #FF8E35 100%); color: white; padding: 10px 15px; border-radius: 8px; margin-top: 10px; text-align: center;">
                <i class="fas fa-copy"></i> <strong>MODO APLICAR A TODOS</strong> - CNPJ: ${cnpjAtualParaAplicar}
                <br><small>Selecione os campos que deseja aplicar a todos os registros deste CNPJ</small>
            </div>
        `;
    }
    
    // Adicionar classe especial ao card
    document.getElementById('cardCadastro').classList.add('modo-aplicar-todos');
}

// 🔥 FUNÇÃO PARA ADICIONAR CHECKBOXES AOS CAMPOS
function adicionarCheckboxesAosCampos() {
    const camposAplicaveis = [
        'razao_social', 'nome_fantasia', 'tipo', 'contrato_enviado', 
        'contrato_assinado', 'ativacao', 'link', 'mensalidade', 
        'adesao', 'situacao', 'inputEventoSearch'
    ];
    
    camposAplicaveis.forEach(campoId => {
        const campoElement = document.getElementById(campoId);
        if (campoElement) {
            const formGroup = campoElement.closest('.form-group');
            if (formGroup && !formGroup.querySelector('.checkbox-aplicar-todos')) {
                const checkboxHtml = `
                    <div class="checkbox-aplicar-todos">
                        <input type="checkbox" id="check_${campoId}" data-campo="${campoId}" 
                               onchange="toggleCampoParaTodos('${campoId}')">
                        <label for="check_${campoId}">
                            <i class="fas fa-copy"></i> Aplicar este campo a todos
                        </label>
                    </div>
                `;
                formGroup.insertAdjacentHTML('beforeend', checkboxHtml);
            }
        }
    });
}

// 🔥 DEBUG COMPLETO DO BOTÃO - COLE ISSO NO SEU CÓDIGO
function debugBotaoAplicarTodos() {
    console.log("=== 🐛 DEBUG INICIADO ===");
    
    // 1. Verificar se o botão existe
    const btn = document.getElementById('btnAplicarATodos');
    console.log("1. Botão encontrado?", !!btn);
    
    if (!btn) {
        console.log("❌ ERRO: Botão não existe no DOM!");
        console.log("🔍 Procurando por qualquer botão...");
        const todosBotoes = document.querySelectorAll('button');
        console.log("Total de botões na página:", todosBotoes.length);
        todosBotoes.forEach((botao, index) => {
            console.log(`Botão ${index}:`, botao.textContent, botao.id);
        });
        return;
    }
    
    // 2. Verificar estilo e visibilidade
    console.log("2. Display:", btn.style.display);
    console.log("3. Visibilidade:", btn.style.visibility);
    console.log("4. Opacidade:", btn.style.opacity);
    console.log("5. Desabilitado:", btn.disabled);
    console.log("6. Posição:", btn.getBoundingClientRect());
    
    // 3. Verificar eventos
    console.log("7. Tem onclick?", !!btn.onclick);
    console.log("8. Tem event listeners?", btn.hasAttribute('onclick'));
    
    // 4. Forçar visibilidade para teste
    btn.style.display = 'block';
    btn.style.background = '#ff0000';
    btn.style.color = 'white';
    btn.style.border = '3px solid yellow';
    btn.style.fontSize = '16px';
    btn.style.fontWeight = 'bold';
    btn.style.zIndex = '99999';
    
    // 5. Adicionar evento de clique DIRETO
    btn.onclick = function(e) {
        console.log("🎯🎯🎯 CLIQUE CAPTURADO DIRETAMENTE!");
        e.preventDefault();
        e.stopPropagation();
        alert("BOTÃO CLICADO - FUNCIONA!");
        return false;
    };
    
    console.log("✅ Botão configurado para teste - deve estar VERMELHO!");
}

// 🔥 FUNÇÃO PARA MOSTRAR BOTÃO PRINCIPAL "APLICAR A TODOS"
function mostrarBotaoAplicarATodos() {
    const btnAplicar = document.getElementById('btnAplicarATodos');
    if (btnAplicar) {
        btnAplicar.style.display = 'block';
    }
}

function criarBotoesWaitlabels() {
  const container = document.getElementById('waitlabelButtons');
  let html = '';
  
  WAITLABELS_CONFIG.WAITLABELS.forEach(waitlabel => {
    const cor = WAITLABELS_CONFIG.CORES[waitlabel];
    const isActive = waitlabel === waitlabelAtual;
    const classeAtiva = isActive ? 'active' : '';
    
    // 🔥 CORREÇÃO: Aplicar cor dinamicamente via style
    html += `
      <button class="waitlabel-btn ${classeAtiva}" 
              onclick="selecionarWaitlabel('${waitlabel}')"
              style="border-color: ${cor}; ${isActive ? `background: ${cor}; color: white;` : `color: ${cor};`}">
        <span class="waitlabel-indicator" style="background: ${cor};"></span>
        ${formatarNomeWaitlabel(waitlabel)}
      </button>
    `;
  });
  
  container.innerHTML = html;
}

function formatarNomeWaitlabel(nome) {
  const formatacoes = {
    'Sim_Facilita': 'Sim Facilita',
    'Set_9': 'Set 9',
    'Doktorbank': 'DoktorBank',
    'Dr_Parcela': 'Dr Parcela',
    'Result': 'Result'
  };
  return formatacoes[nome] || nome;
}

function selecionarWaitlabel(waitlabel) {
  console.log("🎯 Selecionando waitlabel:", waitlabel);
  
  // Atualizar visualmente
  waitlabelAtual = waitlabel;
  criarBotoesWaitlabels();
  atualizarInterfaceWaitlabel();
  
  // Salvar no servidor
  google.script.run
    .withSuccessHandler(function(res) {
      console.log("✅ Waitlabel salvo:", res);
      showMessage('success', `✅ Waitlabel alterado para: ${formatarNomeWaitlabel(waitlabel)}`);
    })
    .withFailureHandler(function(error) {
      console.error("❌ Erro ao salvar waitlabel:", error);
      showMessage('error', '❌ Erro ao alterar waitlabel');
    })
    .setWaitlabelAtual(waitlabel);
}

function atualizarInterfaceWaitlabel() {
  // Atualizar cor do header baseado no waitlabel
  const header = document.querySelector('.header');
  const cor = WAITLABELS_CONFIG.CORES[waitlabelAtual] || '#7E3E9A';
  header.style.background = cor;
  
  // Atualizar título da seção de cadastros
  const titulo = document.getElementById('tituloCadastros');
  if (titulo) {
    titulo.textContent = `Cadastros - ${formatarNomeWaitlabel(waitlabelAtual)}`;
  }
  
  console.log("🎨 Interface atualizada para waitlabel:", waitlabelAtual);
}

// 🔥 MODIFICAR FUNÇÕES EXISTENTES PARA USAR WAITLABEL
function cadastrar() {
  console.log("🎯 CADASTRAR: Iniciando cadastro no waitlabel:", waitlabelAtual);
  
  // ✅ VALIDAÇÃO DE CAMPOS OBRIGATÓRIOS
  const camposInvalidos = validarCamposObrigatorios();
  if (camposInvalidos.length > 0) {
    showMessage('error', `❌ Preencha os campos obrigatórios: ${camposInvalidos.join(', ')}`);
    return;
  }

  // ✅ VALIDAÇÃO DE FORNECEDORES
  const fornecedoresSelecionados = document.querySelectorAll('input[name="fornecedor"]:checked');
  if (fornecedoresSelecionados.length === 0) {
    showMessage('error', '❌ Selecione pelo menos um fornecedor!');
    return;
  }

  // Coletar dados BASE (comuns a todos os fornecedores)
  const dadosBase = coletarDadosFormulario();
  if (!dadosBase) {
    showMessage('error', '❌ Erro ao coletar dados do formulário');
    return;
  }

  console.log("🔢 Fornecedores selecionados:", dadosBase.fornecedores.length);
  console.log("📋 Lista de fornecedores:", dadosBase.fornecedores);

  // ✅ CORREÇÃO CRÍTICA: Para CADASTRO, evento é FIXO "Novo cadastro"
  dadosBase.evento = "Novo cadastro";
  dadosBase.acao = 'cadastrar';

  // Mostrar loading
  showLoading(`Cadastrando ${dadosBase.fornecedores.length} fornecedor(es) no ${formatarNomeWaitlabel(waitlabelAtual)}...`, `Loja: ${dadosBase.razao_social}`);

  const btnCadastrar = document.getElementById('btnCadastrar');
  btnCadastrar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cadastrando...';
  btnCadastrar.disabled = true;

  // ✅ ENVIAR para Google Apps Script - USANDO WAITLABEL
  google.script.run
    .withSuccessHandler(function(res) {
      console.log("✅ Resposta do cadastro MULTIPLO:", res);
      hideLoading();
      
      btnCadastrar.innerHTML = '<i class="fas fa-plus-circle"></i> Cadastrar';
      btnCadastrar.disabled = false;
      
      if (res.success) {
        showMessage('success', `✅ ${res.message} - ${res.registrosCriados} registro(s) criado(s)`);
        limparFormulario();
      } else {
        showMessage('error', '❌ ' + res.message);
      }
    })
    .withFailureHandler(function(error) {
      console.error("❌ Erro no cadastro:", error);
      hideLoading();
      
      btnCadastrar.innerHTML = '<i class="fas fa-plus-circle"></i> Cadastrar';
      btnCadastrar.disabled = false;
      showMessage('error', '❌ Erro: ' + error.message);
    })
    .processarCadastroComWaitlabel(dadosBase, waitlabelAtual);
}

function atualizar() {
  console.log("🎯 ATUALIZAR: Iniciando atualização no waitlabel:", waitlabelAtual);
  
  // ✅ DEBUG 1: Verificar se tem ID
  console.log("🔍 DEBUG 1: cadastroAtualId =", cadastroAtualId);
  
  if (!cadastroAtualId) {
    showMessage('error', '❌ Nenhum cadastro selecionado para atualizar!');
    return;
  }

  // ✅ VALIDAÇÃO DE CAMPOS OBRIGATÓRIOS
  const camposInvalidos = validarCamposObrigatorios();
  console.log("🔍 DEBUG 2: Campos inválidos:", camposInvalidos);
  
  if (camposInvalidos.length > 0) {
    showMessage('error', `❌ Preencha os campos obrigatórios: ${camposInvalidos.join(', ')}`);
    return;
  }

  // ✅ VALIDAÇÃO DE FORNECEDORES
  const fornecedoresSelecionados = document.querySelectorAll('input[name="fornecedor"]:checked');
  console.log("🔍 DEBUG 3: Fornecedores selecionados:", fornecedoresSelecionados.length);
  
  if (fornecedoresSelecionados.length === 0) {
    showMessage('error', '❌ Selecione pelo menos um fornecedor!');
    return;
  }

  // Coletar dados
  console.log("🔍 DEBUG 4: Chamando coletarDadosFormulario()...");
  const dados = coletarDadosFormulario();
  console.log("🔍 DEBUG 5: Dados coletados:", dados);
  
  if (!dados) {
    showMessage('error', '❌ Erro ao coletar dados do formulário');
    return;
  }
  
  dados.acao = 'atualizar';
  dados.id = cadastroAtualId;
  
  console.log("📤 Dados para atualização:", dados);

  // Mostrar loading
  showLoading(`Atualizando ${dados.fornecedores.length} fornecedor(es) no ${formatarNomeWaitlabel(waitlabelAtual)}...`, `Loja: ${dados.razao_social}`);

  const btnAtualizar = document.getElementById('btnAtualizar');
  const btnOriginalHTML = btnAtualizar.innerHTML;
  btnAtualizar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
  btnAtualizar.disabled = true;

  console.log("🔍 DEBUG 6: Chamando Google Apps Script...");

  // ✅ CORREÇÃO CRÍTICA: Usar processarCadastroComWaitlabel
  google.script.run
    .withSuccessHandler(function(res) {
      console.log("✅ DEBUG 7: Resposta da atualização:", res);
      hideLoading();
      
      btnAtualizar.innerHTML = btnOriginalHTML;
      btnAtualizar.disabled = false;
      
      if (res && res.success) {
        showMessage('success', '✅ ' + res.message);
        
        // Atualizar a lista de cadastros se estiver visível
        if (document.getElementById('secaoCadastros').style.display === 'block') {
          mostrarTodosCadastros();
        }
        
        // Voltar para modo cadastro
        limparFormulario();
      } else {
        showMessage('error', '❌ ' + (res ? res.message : 'Resposta inválida do servidor'));
      }
    })
    .withFailureHandler(function(error) {
      console.error("❌ DEBUG 8: Erro na atualização:", error);
      hideLoading();
      
      btnAtualizar.innerHTML = btnOriginalHTML;
      btnAtualizar.disabled = false;
      showMessage('error', '❌ Erro ao atualizar: ' + error.message);
    })
    .processarCadastroComWaitlabel(dados, waitlabelAtual);
}

function mostrarTodosCadastros() {
  console.log("🎯 Iniciando carregamento de cadastros do waitlabel:", waitlabelAtual);
  
  // 🔄 MOSTRAR LOADING
  showLoading(`Carregando cadastros do ${formatarNomeWaitlabel(waitlabelAtual)}...`, "Buscando todos os registros");
  
  // Mostrar loading da tabela também
  const loading = document.getElementById('loadingCadastros');
  const tableContainer = document.getElementById('tableContainer');
  const filtrosContainer = document.getElementById('filtrosContainer');
  const secao = document.getElementById('secaoCadastros');

  loading.style.display = 'flex';
  tableContainer.style.display = 'none';
  filtrosContainer.style.display = 'none';
  secao.style.display = 'block';

  // ✅ USAR FUNÇÃO COM WAITLABEL
  google.script.run
    .withSuccessHandler(function(cadastros) {
      // 🔄 ESCONDER LOADING
      hideLoading();
      
      console.log("✅ Cadastros recebidos:", cadastros);
      
      if (cadastros && cadastros.length > 0) {
        // ✅ ORDENAR POR NOME AUTOMATICAMENTE
        const cadastrosOrdenados = cadastros.sort((a, b) => {
          const nomeA = (a.razao_social || '').toLowerCase();
          const nomeB = (b.razao_social || '').toLowerCase();
          return nomeA.localeCompare(nomeB);
        });
        
        todosCadastros = cadastrosOrdenados;
        cadastrosFiltrados = [...cadastrosOrdenados];
        
        // ✅ CORREÇÃO: Usar a função agrupada
        const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosOrdenados);
        exibirTabelaCadastrosAgrupada(cadastrosAgrupados, `Cadastros - ${formatarNomeWaitlabel(waitlabelAtual)}`);
        
        document.getElementById('filtrosContainer').style.display = 'flex';
        configurarFiltroEvento('all'); // ✅ MOSTRAR FILTRO DE EVENTOS
        
        showMessage('success', `✅ ${cadastros.length} cadastros carregados do ${formatarNomeWaitlabel(waitlabelAtual)}!`);
      } else {
        loading.style.display = 'none';
        tableContainer.style.display = 'block';
        document.getElementById('tabelaCadastrosBody').innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 40px;">
              <i class="fas fa-inbox" style="font-size: 3rem; color: var(--gray); margin-bottom: 15px;"></i>
              <h3>Nenhum cadastro encontrado</h3>
              <p>Não há cadastros no waitlabel ${formatarNomeWaitlabel(waitlabelAtual)}.</p>
            </td>
          </tr>
        `;
        showMessage('info', `📝 Nenhum cadastro encontrado no ${formatarNomeWaitlabel(waitlabelAtual)}.`);
      }
    })
    .withFailureHandler(function(error) {
      // 🔄 ESCONDER LOADING EM CASO DE ERRO
      hideLoading();
      
      console.error("❌ Erro ao carregar cadastros:", error);
      loading.style.display = 'none';
      showMessage('error', '❌ Erro ao carregar cadastros: ' + error.message);
    })
    .buscarTodosCadastrosComWaitlabel(waitlabelAtual);
}

// 🔥 ADICIONAR: Função para buscar cadastro por CNPJ considerando waitlabel
function buscarPorCNPJComWaitlabel() {
  const cnpjBusca = document.getElementById('cnpj').value.replace(/\D/g, '');
  
  if (!cnpjBusca) {
    showMessage('error', 'Digite um CNPJ para buscar');
    return;
  }

  showMessage('info', `🔍 Buscando cadastro no ${formatarNomeWaitlabel(waitlabelAtual)}...`);

  google.script.run
    .withSuccessHandler(function(dados) {
      preencherDadosCadastro(dados);
    })
    .withFailureHandler(function(error) {
      showMessage('error', 'Erro: ' + error.message);
    })
    .buscarTodosCadastrosPorCNPJComWaitlabel(cnpjBusca, waitlabelAtual);
}

// 🔥 CORREÇÃO EXTRA - REMOVER SCROLL HORIZONTAL DINAMICAMENTE
function corrigirScrollHorizontal() {
  const suggestions = document.getElementById('suggestionsEventoSearch');
  if (suggestions) {
    suggestions.style.overflowX = 'hidden';
    suggestions.style.width = '100%';
    
    // Forçar remoção de scroll horizontal em todos os elementos filhos
    const allElements = suggestions.getElementsByTagName('*');
    for (let element of allElements) {
      element.style.overflowX = 'hidden';
      element.style.maxWidth = '100%';
    }
  }
}

// Executar quando as sugestões forem mostradas
document.addEventListener('click', function(e) {
  if (e.target.id === 'inputEventoSearch' || 
      (e.target.closest && e.target.closest('#suggestionsEventoSearch'))) {
    setTimeout(corrigirScrollHorizontal, 10);
  }
});

// Também executar quando as sugestões forem atualizadas
const originalFiltrarSugestoesEventoSearch = filtrarSugestoesEventoSearch;
filtrarSugestoesEventoSearch = function() {
  originalFiltrarSugestoesEventoSearch();
  setTimeout(corrigirScrollHorizontal, 10);
};

// 🔥 CÓDIGO TEMPORÁRIO PARA DEBUG - TESTAR SE A FUNÇÃO É CHAMADA
function testarAtualizacaoEventos() {
  console.log("🧪 TESTE: Chamando atualizarEventos() manualmente...");
  atualizarEventos();
}

// Testa após 2 segundos (para você ver no console)
setTimeout(testarAtualizacaoEventos, 2000);

// 🔥 FUNÇÕES DO MODAL DE SENHA - CORRIGIDAS
function configurarModalSenha() {
  // Configurar evento de Enter no input de senha
  const inputSenha = document.getElementById('inputSenha');
  if (inputSenha) {
    inputSenha.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        validarSenha();
      }
    });
  }
  
  // Fechar modal ao clicar fora
  const modalSenha = document.getElementById('modalSenha');
  if (modalSenha) {
    modalSenha.addEventListener('click', function(e) {
      if (e.target === this) {
        fecharModalSenha();
      }
    });
  }
  
  // Fechar modal com ESC
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('modalSenha').style.display === 'flex') {
      fecharModalSenha();
    }
  });
}

function solicitarSenha(campo) {
  campoEditavel = campo;
  
  // Mostrar modal
  document.getElementById('modalSenha').style.display = 'flex';
  
  // Limpar e focar no input
  const inputSenha = document.getElementById('inputSenha');
  if (inputSenha) {
    inputSenha.value = '';
    inputSenha.focus();
  }
}

function validarSenha() {
  const inputSenha = document.getElementById('inputSenha');
  if (!inputSenha) {
    console.log("❌ inputSenha não encontrado");
    return;
  }
  
  const senha = inputSenha.value;
  console.log("🔐 Validando senha:", senha);
  
  if (senha === SENHA_PERMITIDA) {
    console.log("✅ SENHA CORRETA - Iniciando liberação de campos");
    
    // 🔥 CORREÇÃO: SALVAR OS DADOS ATUAIS ANTES DE FECHAR O MODAL
    const dadosAtuais = coletarDadosFormularioTemporario();
    
    fecharModalSenha();
    
    // Atualizar localStorage
    localStorage.setItem('usuarioAutorizado', 'true');
    console.log("💾 localStorage atualizado");
    
    // Liberar TODOS os campos protegidos
    liberarTodosCamposProtegidos();
    
    // 🔥 CORREÇÃO: RESTAURAR OS DADOS APÓS LIBERAR OS CAMPOS
    setTimeout(() => {
      restaurarDadosFormulario(dadosAtuais);
    }, 100);
    
    showMessage('success', '✅ Todos os campos foram liberados para edição!');
    
  } else {
    console.log("❌ SENHA INCORRETA");
    showMessage('error', '❌ Senha incorreta!');
    inputSenha.value = '';
    inputSenha.focus();
  }
}

function coletarDadosFormularioTemporario() {
  const dados = {
    razao_social: document.getElementById('razao_social').value,
    nome_fantasia: document.getElementById('nome_fantasia').value,
    cnpj_cadastro: document.getElementById('cnpj_cadastro').value,
    tipo: document.getElementById('tipo').value,
    observacoes: document.getElementById('observacoes').value,
    contrato_enviado: document.getElementById('contrato_enviado').value,
    contrato_assinado: document.getElementById('contrato_assinado').value,
    ativacao: document.getElementById('ativacao').value,
    link: document.getElementById('link').value,
    mensalidade: document.getElementById('mensalidade').value,
    situacao: document.getElementById('situacao').value,
    adesao: document.getElementById('adesao').value,
    evento: document.getElementById('inputEventoSearch').value
  };
  
  // Coletar fornecedores selecionados
  const fornecedoresSelecionados = [];
  const checkboxes = document.querySelectorAll('input[name="fornecedor"]:checked');
  checkboxes.forEach(checkbox => {
    const fornecedorNome = checkbox.value;
    const fornecedorId = fornecedorNome.toLowerCase();
    const configDiv = document.getElementById(`config-${fornecedorId}`);
    
    if (configDiv && configDiv.style.display === 'grid') {
      const tarifaRadio = document.querySelector(`input[name="tarifa_${fornecedorId}"]:checked`);
      const percentualSelect = document.querySelector(`select[name="percentual_${fornecedorId}"]`);
      
      fornecedoresSelecionados.push({
        nome: fornecedorNome,
        tarifa: tarifaRadio ? tarifaRadio.value : '',
        percentual: percentualSelect ? percentualSelect.value : ''
      });
    }
  });
  
  dados.fornecedores = fornecedoresSelecionados;
  return dados;
}

// 🔥 ADICIONAR: Função para restaurar dados após liberar campos
function restaurarDadosFormulario(dados) {
  if (!dados) return;
  
  console.log("🔄 Restaurando dados do formulário:", dados);
  
  // Restaurar campos básicos
  document.getElementById('razao_social').value = dados.razao_social || '';
  document.getElementById('nome_fantasia').value = dados.nome_fantasia || '';
  document.getElementById('cnpj_cadastro').value = dados.cnpj_cadastro || '';
  document.getElementById('tipo').value = dados.tipo || '';
  document.getElementById('observacoes').value = dados.observacoes || '';
  document.getElementById('contrato_enviado').value = dados.contrato_enviado || '';
  document.getElementById('contrato_assinado').value = dados.contrato_assinado || '';
  document.getElementById('ativacao').value = dados.ativacao || '';
  document.getElementById('link').value = dados.link || '';
  document.getElementById('mensalidade').value = dados.mensalidade || 'R$ 0,00';
  document.getElementById('situacao').value = dados.situacao || 'Novo registro';
  document.getElementById('adesao').value = dados.adesao || 'R$ 0,00';
  document.getElementById('inputEventoSearch').value = dados.evento || '';
  
  // Restaurar fornecedores
  if (dados.fornecedores && dados.fornecedores.length > 0) {
    dados.fornecedores.forEach(fornecedor => {
      const checkbox = document.querySelector(`input[name="fornecedor"][value="${fornecedor.nome}"]`);
      if (checkbox) {
        checkbox.checked = true;
        const fornecedorId = fornecedor.nome.toLowerCase();
        const configDiv = document.getElementById(`config-${fornecedorId}`);
        
        if (configDiv) {
          configDiv.style.display = 'grid';
          
          // Restaurar tarifa
          if (fornecedor.tarifa) {
            const tarifaRadio = document.querySelector(`input[name="tarifa_${fornecedorId}"][value="${fornecedor.tarifa}"]`);
            if (tarifaRadio) {
              tarifaRadio.checked = true;
            }
          }
          
          // Restaurar percentual
          if (fornecedor.percentual) {
            const percentualSelect = document.querySelector(`select[name="percentual_${fornecedorId}"]`);
            if (percentualSelect) {
              percentualSelect.value = fornecedor.percentual;
            }
          }
        }
      }
    });
  }
  
  console.log("✅ Dados restaurados com sucesso!");
}

function fecharModalSenha() {
  document.getElementById('modalSenha').style.display = 'none';
  campoEditavel = null;
}

// 🔥 FUNÇÃO PARA LIBERAR TODOS OS CAMPOS PROTEGIDOS - CORRIGIDA
function liberarTodosCamposProtegidos() {
  console.log("🔓 LIBERANDO TODOS OS CAMPOS...");
  
  // 🔥 CORREÇÃO: SALVAR OS DADOS ANTES DE LIBERAR
  const dadosAtuais = coletarDadosFormularioTemporario();
  
  // Liberar campos principais
  const camposProtegidos = [
    'razao_social', 'nome_fantasia', 'cnpj_cadastro', 'tipo', 
    'mensalidade', 'adesao', 'situacao', 'data_status',
    'contrato_enviado', 'contrato_assinado', 'ativacao', 'link'
  ];
  
  camposProtegidos.forEach(id => {
    const campo = document.getElementById(id);
    if (campo) {
      console.log(`🔓 Liberando: ${id}`);
      
      const novoCampo = campo.cloneNode(true);
      novoCampo.removeAttribute('readonly');
      novoCampo.disabled = false;
      novoCampo.style.backgroundColor = '';
      novoCampo.style.cursor = 'text';
      novoCampo.style.opacity = '1';
      
      novoCampo.onfocus = null;
      novoCampo.onclick = null;
      
      campo.parentNode.replaceChild(novoCampo, campo);
      
      console.log(`✅ ${id} liberado completamente`);
    }
  });
  
  // Liberar campos dos fornecedores
  console.log("🔓 Liberando campos dos fornecedores...");
  const camposFornecedor = document.querySelectorAll(`
    input[name="fornecedor"], 
    input[name^="tarifa_"], 
    select[name^="percentual_"]
  `);
  
  camposFornecedor.forEach(campo => {
    const novoCampo = campo.cloneNode(true);
    novoCampo.disabled = false;
    novoCampo.style.cursor = '';
    novoCampo.style.opacity = '1';
    novoCampo.style.backgroundColor = '';
    
    novoCampo.onclick = null;
    novoCampo.onfocus = null;
    novoCampo.onmousedown = null;
    
    campo.parentNode.replaceChild(novoCampo, campo);
  });
  
  // 🔥 CORREÇÃO: RESTAURAR OS DADOS APÓS LIBERAR
  setTimeout(() => {
    restaurarDadosFormulario(dadosAtuais);
  }, 100);
  
  console.log("🎯 TODOS OS CAMPOS FORAM LIBERADOS COM SUCESSO!");
}

// 🔥 FUNÇÃO PRINCIPAL PARA CONFIGURAR PROTEÇÃO
function configurarCamposProtegidos() {
  console.log("🎯 CONFIGURAR CAMPOS PROTEGIDOS - INICIANDO PROTECÇÃO FORÇADA");
  
  // 🔥 CORREÇÃO: SALVAR OS DADOS EXISTENTES ANTES DE PROTEGER
  const dadosAtuais = coletarDadosFormularioTemporario();
  
  // 🔥 FORÇAR: Ignorar localStorage e SEMPRE proteger inicialmente
  console.log("🔒 PROTECÇÃO FORÇADA: Ignorando localStorage");
  
  const camposProtegidos = [
    'razao_social', 'nome_fantasia', 'cnpj_cadastro', 'tipo', 
    'mensalidade', 'adesao', 'situacao', 'data_status',
    'contrato_enviado', 'contrato_assinado', 'ativacao', 'link'
  ];
  
  console.log("🔒 Protegendo campos principais...");
  
  // Proteger campos principais - FORÇADO
  camposProtegidos.forEach(id => {
    const campo = document.getElementById(id);
    if (campo) {
      console.log(`🔒 Protegendo: ${id}`);
      campo.setAttribute('readonly', 'true');
      campo.disabled = false; // Garantir que não está disabled
      campo.style.backgroundColor = '#f8f9fa';
      campo.style.cursor = 'not-allowed';
      campo.style.opacity = '1';
      
      // Remover qualquer event listener anterior
      const novoCampo = campo.cloneNode(true);
      campo.parentNode.replaceChild(novoCampo, campo);
      
      // Adicionar novo event listener
      document.getElementById(id).addEventListener('focus', function(e) {
        e.preventDefault();
        console.log(`🔓 Campo ${id} solicitando senha`);
        solicitarSenha(this);
      });
    }
  });
  
  // Proteger campos dos fornecedores - FORÇADO
  console.log("🔒 Protegendo campos dos fornecedores...");
  const camposFornecedor = document.querySelectorAll(`
    input[name="fornecedor"], 
    input[name^="tarifa_"], 
    select[name^="percentual_"]
  `);
  
  camposFornecedor.forEach(campo => {
    campo.disabled = true;
    campo.style.cursor = 'not-allowed';
    campo.style.opacity = '0.6';
    
    // Clonar e substituir para limpar event listeners
    const novoCampo = campo.cloneNode(true);
    campo.parentNode.replaceChild(novoCampo, campo);
    
    // Re-aplicar event listeners
    if (campo.type === 'checkbox' || campo.type === 'radio') {
      novoCampo.addEventListener('click', function(e) {
        e.preventDefault();
        solicitarSenha(this);
      });
    } else {
      novoCampo.addEventListener('focus', function(e) {
        e.preventDefault();
        solicitarSenha(this);
      });
    }
  });
  
  // Campos liberados (não proteger)
  console.log("✅ Liberando campos permitidos...");
  const camposLiberados = ['evento', 'observacoes', 'inputEventoSearch'];
  camposLiberados.forEach(id => {
    const campo = document.getElementById(id);
    if (campo) {
      campo.removeAttribute('readonly');
      campo.disabled = false;
      campo.style.backgroundColor = '';
      campo.style.cursor = 'text';
      campo.style.opacity = '1';
    }
  });
  
  // 🔥 CORREÇÃO CRÍTICA: RESTAURAR OS DADOS APÓS CONFIGURAR A PROTEÇÃO
  setTimeout(() => {
    if (dadosAtuais && (dadosAtuais.razao_social || dadosAtuais.cnpj_cadastro)) {
      console.log("🔄 Restaurando dados após proteção:", dadosAtuais);
      restaurarDadosFormulario(dadosAtuais);
    } else {
      console.log("ℹ️ Nenhum dado para restaurar - formulário vazio");
    }
  }, 300);
  
  console.log("🎯 PROTECÇÃO FORÇADA FINALIZADA - Campos devem estar BLOQUEADOS mas dados preservados");
}

// 🔥 FUNÇÃO TEMPORÁRIA PARA TESTAR ENVIO DO FORMULÁRIO
function testarEnvioFormulario() {
  console.log("🧪 TESTANDO ENVIO DO FORMULÁRIO...");
  
  // Coletar dados do formulário normalmente (a mesma função que o cadastrar usa)
  const dados = coletarDadosFormulario();
  
  console.log("📤 Dados coletados para envio:", dados);
  console.log("🔢 Fornecedores coletados:", dados.fornecedores);
  
  if (!dados.fornecedores || dados.fornecedores.length === 0) {
    alert("❌ Nenhum fornecedor selecionado! Selecione pelo menos um.");
    return;
  }
  
  // Enviar para debug no GS
  google.script.run
    .withSuccessHandler(function(res) {
      console.log("✅ RESPOSTA DO DEBUG:", res);
      alert(`DEBUG CONCLUÍDO:\n\n• Fornecedores enviados: ${res.quantidadeFornecedores}\n• Estrutura: ${JSON.stringify(res.estruturaFornecedores, null, 2)}\n\nVerifique o console do GS para detalhes completos.`);
    })
    .withFailureHandler(function(error) {
      console.error("❌ ERRO NO DEBUG:", error);
      alert("Erro no debug: " + error.message);
    })
    .debugFormulario(dados);
}

function formatarCNPJ(input) {
  // Salva a posição do cursor
  const cursorPos = input.selectionStart;
  
  let value = input.value.replace(/\D/g, '');
  
  // Aplica a formatação
  if (value.length > 12) {
    value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
  } else if (value.length > 8) {
    value = value.replace(/^(\d{2})(\d{3})(\d{3})/, '$1.$2.$3/');
  } else if (value.length > 5) {
    value = value.replace(/^(\d{2})(\d{3})/, '$1.$2.');
  } else if (value.length > 2) {
    value = value.replace(/^(\d{2})/, '$1.');
  }
  
  input.value = value;
  
  // Restaura a posição do cursor
  input.setSelectionRange(cursorPos, cursorPos);
}


// 🔥 FUNÇÃO SIMPLES: Para usar ENQUANTO não corrige o Google Sheets
function formatarCNPJParaExibicao(cnpj) {
    if (!cnpj || cnpj === 'N/A' || cnpj === '') return 'N/A';
    
    // 🔥 MOSTRA EXATAMENTE O QUE VEIO - o problema é na origem
    return cnpj.toString();
}

function formatarMoeda(input) {
  let value = input.value.replace(/\D/g, '');
  value = (value / 100).toFixed(2);
  value = value.replace('.', ',');
  value = value.replace(/(\d)(?=(\d{3})+\,)/g, "$1.");
  input.value = 'R$ ' + value;
}

function formatarMoedaParaInput(valor) {
  if (!valor) return 'R$ 0,00';
  const numero = typeof valor === 'number' ? valor : parseFloat(valor);
  return 'R$ ' + numero.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
}

function showMessage(type, text) {
  const successEl = document.getElementById('messageSuccess');
  const errorEl = document.getElementById('messageError');
  const infoEl = document.getElementById('messageInfo');

  successEl.style.display = 'none';
  errorEl.style.display = 'none';
  infoEl.style.display = 'none';

  if (type === 'success') {
    successEl.querySelector('span').textContent = text;
    successEl.style.display = 'flex';
  } else if (type === 'error') {
    errorEl.querySelector('span').textContent = text;
    errorEl.style.display = 'flex';
  } else if (type === 'info') {
    infoEl.querySelector('span').textContent = text;
    infoEl.style.display = 'flex';
  }

  setTimeout(() => {
    successEl.style.display = 'none';
    errorEl.style.display = 'none';
    infoEl.style.display = 'none';
  }, 5000);
}

// 🔥 FUNÇOES AUXILIAR

// 🔥 ADICIONE ESTA FUNÇÃO AUXILIAR PARA PADRONIZAR FORNECEDORES
function padronizarNomeFornecedor(nome) {
  if (!nome) return '';
  
  // Lista de fornecedores conhecidos em MAIÚSCULAS
  const fornecedoresPadronizados = {
    'agil': 'AGIL',
    'bc': 'BC', 
    'parcelex': 'PARCELEX',
    'agoracred': 'AGORACRED',
    'afinz': 'AFINZ'
  };
  
  const nomeLower = nome.toLowerCase();
  return fornecedoresPadronizados[nomeLower] || nome.toUpperCase();
}



function coletarDadosFormulario() {
  console.log("🔍 COLETANDO DADOS - INICIANDO");
  
  try {
    // ✅ VALIDAÇÃO BÁSICA DOS CAMPOS PRINCIPAIS
    const razaoSocial = document.getElementById('razao_social').value.trim();
    const cnpj = document.getElementById('cnpj_cadastro').value.trim();
    
    if (!razaoSocial || !cnpj) {
      showMessage('error', '❌ Razão Social e CNPJ são obrigatórios!');
      return null;
    }

    // ✅ GARANTIR QUE O CNPJ MANTENHA A MÁSCARA
    const cnpjInput = document.getElementById('cnpj_cadastro');
    const cnpjFormatado = cnpjInput.value;

    // ✅ Processar adesão - CORREÇÃO APLICADA
      let adesaoValue = document.getElementById('adesao').value;
      console.log("💰 Adesão original:", adesaoValue);

      if (adesaoValue === 'R$ 0,00' || adesaoValue === '0,00' || adesaoValue === '0' || adesaoValue === 'R$ 0') {
        adesaoValue = 0;
        console.log("✅ Adesão definida como isenta (0)");
      } else {
        // ✅ CORREÇÃO: Usar a função normal (já corrigida)
        adesaoValue = converterMoedaParaNumero(adesaoValue);
        console.log("✅ Adesão convertida para número:", adesaoValue);
      }
      console.log("🎯🎯🎯 ADESÃO FINAL PARA ENVIO:", adesaoValue, "Tipo:", typeof adesaoValue);

    // ✅ CORREÇÃO CRÍTICA: Coletar evento do campo CORRETO
    const eventoValue = document.getElementById('inputEventoSearch').value || 
                       document.getElementById('evento').value || '';
    console.log("✅ Evento coletado:", eventoValue);

    // ✅ CORREÇÃO CRÍTICA: Coletar TODOS os fornecedores COM VALIDAÇÃO
    const checkboxesFornecedores = document.querySelectorAll('input[name="fornecedor"]:checked');
    const fornecedoresComConfiguracoes = [];

    if (checkboxesFornecedores.length === 0) {
      showMessage('error', '❌ Selecione pelo menos um fornecedor!');
      return null;
    }

    checkboxesFornecedores.forEach(checkbox => {
      const fornecedorNome = checkbox.value;
      // 🔥 CORREÇÃO: Padronizar para MAIÚSCULAS
      const fornecedorPadronizado = padronizarNomeFornecedor(fornecedorNome);
      const fornecedorId = fornecedorNome.toLowerCase();
      
      // Verificar se tem configuração ativa
      const configDiv = document.getElementById(`config-${fornecedorId}`);
      if (!configDiv || configDiv.style.display !== 'grid') {
        console.warn(`❌ Fornecedor ${fornecedorNome} não tem configuração ativa!`);
        return;
      }
      
      // Coletar configurações de tarifa
      const tarifaRadio = document.querySelector(`input[name="tarifa_${fornecedorId}"]:checked`);
      const percentualSelect = document.querySelector(`select[name="percentual_${fornecedorId}"]`);
      
      // 🔥 CORREÇÃO: Se não tem tarifa selecionada, seleciona MDR automaticamente
      let tarifaSelecionada = tarifaRadio ? tarifaRadio.value : 'MDR';
      let percentualSelecionado = percentualSelect ? percentualSelect.value : '0%';
      
      // Se não tinha tarifa selecionada, seleciona MDR agora
      if (!tarifaRadio) {
        const radioMDR = document.querySelector(`input[name="tarifa_${fornecedorId}"][value="MDR"]`);
        if (radioMDR) {
          radioMDR.checked = true;
          console.log(`✅ MDR selecionado automaticamente para ${fornecedorNome}`);
        }
      }
      
      // Adiciona aos dados
      fornecedoresComConfiguracoes.push({
        nome: fornecedorPadronizado,
        tarifa: tarifaSelecionada,
        percentual_tarifa: percentualSelecionado
      });
    });

    // ✅ MONTAR OBJETO DE DADOS CORRETAMENTE
    const dados = {
      razao_social: razaoSocial,
      nome_fantasia: document.getElementById('nome_fantasia').value,
      cnpj: cnpjFormatado,
      tipo: document.getElementById('tipo').value,
      adesao: adesaoValue,
      fornecedores: fornecedoresComConfiguracoes,
      fornecedor: fornecedoresComConfiguracoes.length > 0 ? fornecedoresComConfiguracoes[0].nome : '',
      tarifa: fornecedoresComConfiguracoes.length > 0 ? fornecedoresComConfiguracoes[0].tarifa : '',
      percentual_tarifa: fornecedoresComConfiguracoes.length > 0 ? fornecedoresComConfiguracoes[0].percentual_tarifa : '0%',
      observacoes: document.getElementById('observacoes').value,
      contrato_enviado: document.getElementById('contrato_enviado').value,
      contrato_assinado: document.getElementById('contrato_assinado').value,
      ativacao: document.getElementById('ativacao').value,
      link: document.getElementById('link').value,
      mensalidade: converterMoedaParaNumero(document.getElementById('mensalidade').value),
      situacao: document.getElementById('situacao').value,
      evento: eventoValue // ✅ AGORA CORRETO - PEGA DO CAMPO CERTO
    };

    console.log("📦 DADOS FINAIS PARA ENVIO:", dados);
    return dados;

  } catch (error) {
    console.error("❌ ERRO CRÍTICO ao coletar dados:", error);
    showMessage('error', '❌ Erro interno ao processar formulário');
    return null;
  }
}

// 🔥 CORREÇÃO DEFINITIVA - FUNÇÃO CALCULAR DEFASAGEM MELHORADA
function calcularDefasagem(dataUltimoEvento) {
    console.log("🔄 CALCULANDO DEFASAGEM - Data recebida:", dataUltimoEvento);
    
    if (!dataUltimoEvento || dataUltimoEvento === 'N/A' || dataUltimoEvento === '' || dataUltimoEvento === 'Data inválida') {
        console.log("❌ Sem data válida para calcular defasagem");
        return 'N/A';
    }
    
    try {
        // 🔥 CORREÇÃO: Tentar diferentes formatos de data de forma mais robusta
        let dataEvento;
        
        // Formato brasileiro (dd/mm/aaaa)
        if (typeof dataUltimoEvento === 'string' && dataUltimoEvento.includes('/')) {
            const partesData = dataUltimoEvento.split('/');
            if (partesData.length === 3) {
                const dia = parseInt(partesData[0], 10);
                const mes = parseInt(partesData[1], 10) - 1; // Mês é 0-indexed
                const ano = parseInt(partesData[2], 10);
                dataEvento = new Date(ano, mes, dia);
            }
        } 
        // Formato ISO (aaaa-mm-dd)
        else if (typeof dataUltimoEvento === 'string' && dataUltimoEvento.includes('-')) {
            dataEvento = new Date(dataUltimoEvento);
        }
        // Se já é um objeto Date
        else if (dataUltimoEvento instanceof Date) {
            dataEvento = dataUltimoEvento;
        }
        // Tentar parse direto como último recurso
        else {
            dataEvento = new Date(dataUltimoEvento);
        }
        
        // Verificar se a data é válida
        if (!dataEvento || isNaN(dataEvento.getTime())) {
            console.log("❌ Data inválida após parsing:", dataUltimoEvento);
            return 'Data inválida';
        }
        
        const hoje = new Date();
        
        // 🔥 CORREÇÃO: Zerar horas para comparar apenas datas
        hoje.setHours(0, 0, 0, 0);
        dataEvento.setHours(0, 0, 0, 0);
        
        // Calcular diferença em dias
        const diffTempo = hoje.getTime() - dataEvento.getTime();
        const diffDias = Math.floor(diffTempo / (1000 * 3600 * 24));
        
        console.log("📊 Resultado cálculo:");
        console.log("Data evento:", dataEvento);
        console.log("Data hoje:", hoje);
        console.log("Diferença em dias:", diffDias);
        
        if (diffDias === 0) return 'Hoje';
        if (diffDias === 1) return '1 dia';
        if (diffDias > 1) return `${diffDias} dias`;
        if (diffDias < 0) return 'Data futura';
        
        return 'N/A';
        
    } catch (error) {
        console.error("❌ Erro ao calcular defasagem:", error);
        console.error("Data que causou erro:", dataUltimoEvento);
        return 'Erro no cálculo';
    }
}

// 🔥 FUNÇÃO: Formatar percentual para exibição (0.03 → 3%) - VERSÃO CORRIGIDA
function formatarPercentualParaExibicao(percentual) {
  if (!percentual && percentual !== 0) return '';
  
  console.log("🔍 Percentual recebido:", percentual, "Tipo:", typeof percentual);
  
  try {
    // Se já está em formato de string com %, retorna como está
    if (typeof percentual === 'string' && percentual.includes('%')) {
      return percentual;
    }
    
    // Converter para número
    let numero;
    if (typeof percentual === 'string') {
      // Remove possíveis caracteres não numéricos, mantendo ponto decimal
      const valorLimpo = percentual.replace(/[^\d.,]/g, '').replace(',', '.');
      numero = parseFloat(valorLimpo);
    } else {
      numero = parseFloat(percentual);
    }
    
    // Se não é um número válido, retorna original
    if (isNaN(numero)) {
      return percentual;
    }
    
    // 🔥 CORREÇÃO DEFINITIVA: Se o número é menor que 1, converte para porcentagem
    if (numero < 1) {
      return Math.round(numero * 100) + '%';
    } else {
      // Se o número é 1 ou maior, assume que já é porcentagem
      return Math.round(numero) + '%';
    }
    
  } catch (error) {
    console.error("❌ Erro ao formatar percentual:", error);
    return percentual;
  }
}

function toggleFornecedorConfig(checkbox, fornecedorId) {
  const configDiv = document.getElementById(`config-${fornecedorId}`);
  
  if (checkbox.checked) {
    configDiv.style.display = 'grid';
  } else {
    configDiv.style.display = 'none';
    // Limpar seleções quando desmarcar
    const radios = configDiv.querySelectorAll('input[type="radio"]');
    radios.forEach(radio => radio.checked = false);
    const select = configDiv.querySelector('select');
    if (select) select.value = '0%';
  }
  
  // 🔥 NOVO: Atualizar tarifa principal quando mudar seleção
  atualizarTarifaPrincipal();
}

// 🔥 ADICIONAR: Função para atualizar tarifa principal
function atualizarTarifaPrincipal() {
  const checkboxesFornecedores = document.querySelectorAll('input[name="fornecedor"]:checked');
  if (checkboxesFornecedores.length > 0) {
    const primeiroFornecedor = checkboxesFornecedores[0].value.toLowerCase();
    // As tarifas serão coletadas na função coletarDadosFormulario
  }
}


function converterMoedaParaNumero(valorMoeda) {
  if (!valorMoeda) return 0;
  
  try {
    console.log("🔢 CONVERTENDO MOEDA - Valor original:", valorMoeda, "Tipo:", typeof valorMoeda);
    
    // Se já é número, retorna como está
    if (typeof valorMoeda === 'number') {
      console.log("✅ Já é número, retornando:", valorMoeda);
      return valorMoeda;
    }
    
    if (typeof valorMoeda === 'string') {
      // ✅ CORREÇÃO DEFINITIVA: REMOVER a multiplicação por 100
      let valorLimpo = valorMoeda
        .replace('R$', '')
        .replace(/\./g, '')
        .replace(',', '.')
        .trim();
      
      console.log("🔧 Valor limpo:", valorLimpo);
      
      const numero = parseFloat(valorLimpo);
      
      if (isNaN(numero)) {
        console.log("❌ Não é um número válido:", valorLimpo);
        return 0;
      }
      
      // ✅✅✅ CORREÇÃO: REMOVER COMPLETAMENTE a multiplicação por 100
      console.log("✅ Número convertido (SEM multiplicação):", numero);
      return numero;
    }
    
    return parseFloat(valorMoeda) || 0;
    
  } catch (error) {
    console.error("❌ ERRO CRÍTICO ao converter moeda:", valorMoeda, error);
    return 0;
  }
}

// 🔥 FUNÇÃO DE DEBUG DETALHADA - Contrato Enviado
function debugContratoEnviado(dados) {
  console.log("🔍🔍🔍 DEBUG CONTRATO ENVIADO:");
  console.log("📦 Todos os dados recebidos:", dados);
  console.log("❓ Tem contrato_enviado?", 'contrato_enviado' in dados);
  console.log("📋 Valor de contrato_enviado:", dados.contrato_enviado);
  console.log("📋 Tipo de contrato_enviado:", typeof dados.contrato_enviado);
  console.log("📋 Valor bruto:", dados.contrato_enviado);
  console.log("📋 Convertido para string:", String(dados.contrato_enviado));
  console.log("📋 Em maiúsculas:", String(dados.contrato_enviado).toUpperCase());
  
  // Verificar todos os campos disponíveis
  console.log("🔑 Todas as chaves disponíveis:", Object.keys(dados));
}

// 🔥 FUNÇÃO COM DEBUG: Preencher dados do cadastro
function preencherDadosCadastro(dados) {
  console.log("🎯 PREENCHER DADOS CADASTRO: Iniciando");
  console.log("📦 Dados recebidos:", dados);

  // DEBUG ESPECÍFICO
  console.log("🔍 DEBUG FORNECEDOR:");
  console.log("Fornecedor:", dados.fornecedor);
  console.log("Tarifa:", dados.tarifa);
  console.log("Percentual Tarifa:", dados.percentual_tarifa);
  console.log("Ativação:", dados.ativacao);
  
  if (!dados.encontrado) {
    showMessage('error', '❌ ' + dados.mensagem);
    return;
  }

  // Preencher campos básicos
  document.getElementById('razao_social').value = dados.razao_social || '';
  document.getElementById('nome_fantasia').value = dados.nome_fantasia || '';
  document.getElementById('cnpj_cadastro').value = dados.cnpj || '';
  document.getElementById('tipo').value = dados.tipo || '';
  document.getElementById('observacoes').value = dados.observacoes || '';
  
  // 🔥🔥🔥 CORREÇÃO DEFINITIVA: Usar o nome exato do campo do Google Sheets
  let contratoEnviadoValue = '';
  if (dados.Contrato_Enviado !== undefined && dados.Contrato_Enviado !== null) {
    contratoEnviadoValue = String(dados.Contrato_Enviado).toUpperCase().trim();
    console.log("✅ Contrato_Enviado encontrado:", contratoEnviadoValue);
  } else {
    console.log("⚠️ Contrato_Enviado não encontrado nos dados");
    contratoEnviadoValue = 'SIM'; // Valor padrão
  }
  
  let contratoAssinadoValue = '';
  if (dados.Contrato_Assinado !== undefined && dados.Contrato_Assinado !== null) {
    contratoAssinadoValue = String(dados.Contrato_Assinado).toUpperCase().trim();
    console.log("✅ Contrato_Assinado encontrado:", contratoAssinadoValue);
  } else {
    contratoAssinadoValue = 'NAO'; // Valor padrão
  }
  
  // Preencher os campos
  document.getElementById('contrato_enviado').value = contratoEnviadoValue;
  document.getElementById('contrato_assinado').value = contratoAssinadoValue;
  
  // Outros campos
  document.getElementById('ativacao').value = dados.ativacao || '';
  document.getElementById('link').value = dados.link || '';
  document.getElementById('mensalidade').value = formatarMoedaParaInput(dados.mensalidade);
  document.getElementById('situacao').value = dados.situacao || 'Novo registro';
  document.getElementById('adesao').value = dados.adesao === 'Isento' || dados.adesao === 0 ? 'R$ 0,00' : formatarMoedaParaInput(dados.adesao);
  
  // ✅✅✅ CORREÇÃO CRÍTICA: Preencher evento nos DOIS campos
  if (dados.evento) {
    document.getElementById('inputEventoSearch').value = dados.evento;
    document.getElementById('evento').value = dados.evento;
    console.log("✅ Evento preenchido nos dois campos:", dados.evento);
  } else {
    // Limpar se não tiver evento
    document.getElementById('inputEventoSearch').value = '';
    document.getElementById('evento').value = '';
  }
  
  // Preencher fornecedor
  preencherFornecedorComTarifas(dados);

  // 🔥 PONTO 3: BLOQUEAR CAMPO FORNECEDOR QUANDO EDITANDO
  console.log("🔒 BLOQUEANDO CAMPOS DE FORNECEDOR PARA EDIÇÃO");
  const checkboxesFornecedores = document.querySelectorAll('input[name="fornecedor"]');
  const configsFornecedores = document.querySelectorAll('[id^="config-"]');

  checkboxesFornecedores.forEach(checkbox => {
      checkbox.disabled = true;
      checkbox.style.cursor = 'not-allowed';
      checkbox.style.opacity = '0.7';
  });

  configsFornecedores.forEach(config => {
      const inputs = config.querySelectorAll('input, select');
      inputs.forEach(input => {
          input.disabled = true;
          input.style.cursor = 'not-allowed';
          input.style.opacity = '0.7';
      });
  });
  
  // Atualizar eventos
  atualizarEventos();
  
  // Configurar modo de atualização
  cadastroAtualId = dados.id;
  document.getElementById('btnCadastrar').style.display = 'none';
  document.getElementById('btnAtualizar').style.display = 'block';
  
  console.log("✅ Formulário preenchido com sucesso!");
  
  // Scroll para o formulário
  document.querySelector('.card').scrollIntoView({ behavior: 'smooth', block: 'start' });
  
  showMessage('success', '✅ Cadastro carregado para edição!');
}

// 🔥🔥🔥 CORREÇÃO DA VALIDAÇÃO DE CAMPOS OBRIGATÓRIOS
function validarCamposObrigatorios() {
  console.log("🔍 Validando campos obrigatórios...");
  
  // Remover destaque anterior
  document.querySelectorAll('.campo-obrigatorio').forEach(campo => {
    campo.classList.remove('campo-obrigatorio');
  });

  let camposInvalidos = [];

  // ✅ CORREÇÃO DEFINITIVA: Na ATUALIZAÇÃO, só validar campos CRÍTICOS
  const isAtualizacao = cadastroAtualId !== null;
  
  console.log("🔍 Modo:", isAtualizacao ? "ATUALIZAÇÃO" : "CADASTRO");

  // ✅ CAMPOS SEMPRE OBRIGATÓRIOS (em ambos os modos)
  const camposSempreObrigatorios = [
    { 
      id: 'razao_social', 
      nome: 'Razão Social', 
      elemento: document.getElementById('razao_social'),
      tipo: 'text'
    },
    { 
      id: 'cnpj_cadastro', 
      nome: 'CNPJ', 
      elemento: document.getElementById('cnpj_cadastro'),
      tipo: 'text'
    },
    { 
      id: 'tipo', 
      nome: 'Tipo', 
      elemento: document.getElementById('tipo'),
      tipo: 'select'
    },
    { 
      id: 'mensalidade', 
      nome: 'Mensalidade', 
      elemento: document.getElementById('mensalidade'),
      tipo: 'moeda'
    },
    { 
      id: 'situacao', 
      nome: 'Situação', 
      elemento: document.getElementById('situacao'),
      tipo: 'select'
    }
  ];

  // ✅ CAMPOS OBRIGATÓRIOS APENAS NO CADASTRO (NÃO na atualização)
  const camposApenasCadastro = [
    { 
      id: 'contrato_enviado', 
      nome: 'Contrato Enviado', 
      elemento: document.getElementById('contrato_enviado'),
      tipo: 'select'
    },
    { 
      id: 'contrato_assinado', 
      nome: 'Contrato Assinado', 
      elemento: document.getElementById('contrato_assinado'),
      tipo: 'select'
    }
  ];

  // Juntar os campos a validar
  let camposParaValidar = [...camposSempreObrigatorios];
  
  // ✅ CORREÇÃO: Só adicionar campos de contrato se for NOVO CADASTRO
  if (!isAtualizacao) {
    camposParaValidar = [...camposParaValidar, ...camposApenasCadastro];
  }

  // Validar cada campo
  for (const campo of camposParaValidar) {
    let valor = campo.elemento.value;
    let estaVazio = false;

    switch(campo.tipo) {
      case 'select':
        estaVazio = !valor || valor === '' || valor === '-- Selecione --';
        break;
      case 'moeda':
          estaVazio = !valor || valor.toString().trim() === '';
        break;
      default:
        estaVazio = !valor || valor.toString().trim() === '';
    }

    if (estaVazio) {
      campo.elemento.classList.add('campo-obrigatorio');
      camposInvalidos.push(campo.nome);
      
      // Scroll para o primeiro campo inválido
      if (camposInvalidos.length === 1) {
        campo.elemento.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  }

  console.log(`📊 Validação: ${camposInvalidos.length} campos inválidos`);
  console.log(`🔍 Campos inválidos:`, camposInvalidos);
  return camposInvalidos;
}

function mostrarPopupResultado(mensagemPrincipal, detalhes) {
  // Usar o modal de detalhes TEMPORARIAMENTE
  const modal = document.getElementById('modalDetalhes');
  const content = document.getElementById('modalDetalhesContent');
  
  let detalhesHTML = '';
  if (detalhes && Array.isArray(detalhes)) {
    detalhesHTML = `
      <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <h4 style="color: var(--primary); margin-bottom: 10px;">📋 Detalhes do Cadastro:</h4>
        <div style="max-height: 200px; overflow-y: auto;">
          ${detalhes.map(detalhe => `
            <div style="padding: 5px 0; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; gap: 8px;">
              ${detalhe.includes('✅') ? 
                '<span style="color: var(--success);">✅</span>' : 
                '<span style="color: var(--danger);">❌</span>'
              }
              <span>${detalhe.replace('✅', '').replace('❌', '')}</span>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  content.innerHTML = `
    <div style="text-align: center; padding: 20px;">
      <div style="font-size: 4rem; color: var(--success); margin-bottom: 15px;">✅</div>
      <h3 style="color: var(--success); margin-bottom: 15px;">Cadastro Realizado!</h3>
      <p style="font-size: 1.1rem; margin-bottom: 20px; line-height: 1.4;">${mensagemPrincipal}</p>
      ${detalhesHTML}
      <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border);">
        <button class="btn btn-success" onclick="fecharModalDetalhes()">
          <i class="fas fa-check"></i> Continuar
        </button>
      </div>
    </div>
  `;
  
  modal.style.display = 'flex';
}


function limparFormulario() {
  document.getElementById('razao_social').value = '';
  document.getElementById('nome_fantasia').value = '';
  document.getElementById('cnpj_cadastro').value = '';
  document.getElementById('tipo').value = '';
  
  // 🔥 CORREÇÃO: Limpar checkboxes E configurações de fornecedor
  const checkboxes = document.querySelectorAll('input[name="fornecedor"]');
  checkboxes.forEach(cb => {
    cb.checked = false;
    const fornecedorId = cb.getAttribute('onchange').split("'")[1];
    const configDiv = document.getElementById(`config-${fornecedorId}`);
    if (configDiv) {
      configDiv.style.display = 'none';
      // Limpar seleções dentro da configuração
      const radios = configDiv.querySelectorAll('input[type="radio"]');
      radios.forEach(radio => radio.checked = false);
      const select = configDiv.querySelector('select');
      if (select) select.value = '0%';
    }
  });
  
  document.getElementById('observacoes').value = '';
  document.getElementById('contrato_enviado').value = '';
  document.getElementById('contrato_assinado').value = '';
  document.getElementById('ativacao').value = '';
  document.getElementById('link').value = '';
  document.getElementById('mensalidade').value = 'R$ 0,00';
  
  // 🔥 CORREÇÃO: Resetar situação para "Novo registro" e adesão para "R$ 0,00"
  document.getElementById('situacao').value = 'Novo registro';
  document.getElementById('adesao').value = 'R$ 0,00';
  
  // 🔥🔥🔥 ADICIONE ESTAS 3 LINHAS AQUI - LIMPAR EVENTO SEARCH
  document.getElementById('inputEventoSearch').value = '';
  document.getElementById('evento').value = '';
  document.getElementById('suggestionsEventoSearch').style.display = 'none';
  
  // 🔥 CORREÇÃO: Atualizar eventos baseado na nova situação
  atualizarEventos();
  
  document.getElementById('btnCadastrar').style.display = 'block';
  document.getElementById('btnAtualizar').style.display = 'none';
  cadastroAtualId = null;
  
  // 🔥 CORREÇÃO: LIBERAR CAMPOS DE FORNECEDOR QUANDO VOLTAR AO MODO CADASTRO
  console.log("🔓 LIBERANDO CAMPOS DE FORNECEDOR PARA NOVO CADASTRO");
  const checkboxesFornecedores = document.querySelectorAll('input[name="fornecedor"]');
  const configsFornecedores = document.querySelectorAll('[id^="config-"]');

  checkboxesFornecedores.forEach(checkbox => {
      checkbox.disabled = false;
      checkbox.style.cursor = 'pointer';
      checkbox.style.opacity = '1';
  });

  configsFornecedores.forEach(config => {
      const inputs = config.querySelectorAll('input, select');
      inputs.forEach(input => {
          input.disabled = false;
          input.style.cursor = 'pointer';
          input.style.opacity = '1';
      });
  });
  
  // 🔥 CORREÇÃO: Remover destaque de campos obrigatórios
  document.querySelectorAll('.campo-obrigatorio').forEach(campo => {
    campo.classList.remove('campo-obrigatorio');
    campo.style.borderColor = '';
    campo.style.backgroundColor = '';
  });
  
  // 🔥🔥🔥 NOVA LINHA: Limpar seleção "Aplicar a Todos"
  limparSelecaoAplicarATodos();
  
  // 🔥🔥🔥 ESCONDER BOTÃO "APLICAR A TODOS" AO LIMPAR
  document.getElementById('btnAplicarATodos').style.display = 'none';
}

// 🔥 CONFIGURAR BOTÕES "APLICAR A TODOS" NO FORMULÁRIO
function configurarBotoesAplicarATodos(cnpj) {
    console.log("🎯 Configurando botões aplicar a todos para CNPJ:", cnpj);
    cnpjAtualParaAplicar = cnpj;
    
    // Limpar seleção anterior
    limparSelecaoAplicarATodos();
    
    // 🔥 ADICIONAR CHECKBOXES AOS CAMPOS
    adicionarCheckboxesAosCampos();
    
    // 🔥 MOSTRAR BOTÃO "APLICAR A TODOS"
    mostrarBotaoAplicarATodos();
}

function filtrarTabela(situacao) {
  // Remover classe active de todos os botões
  document.querySelectorAll('.filtros-container .btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Adicionar classe active ao botão clicado
  const botaoClicado = event.target;
  botaoClicado.classList.add('active');

  configurarFiltroEvento(situacao);
  
  let cadastrosFiltradosTemp = todosCadastros;
  let titulo = `Cadastros - ${formatarNomeWaitlabel(waitlabelAtual)}`;

  if (situacao !== 'all') {
    // ✅ CORREÇÃO: Filtrar pela situação correta
    cadastrosFiltradosTemp = todosCadastros.filter(cad => cad.situacao === situacao);
    titulo = `Cadastros - ${formatarNomeWaitlabel(waitlabelAtual)} - ${situacao}`;
  }

  // ✅ CORREÇÃO: SEMPRE AGRUPAR OS CADASTROS POR CNPJ
  cadastrosFiltrados = cadastrosFiltradosTemp;
  
  // ✅ CORREÇÃO: Usar a função de exibição agrupada
  const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosFiltradosTemp);
  exibirTabelaCadastrosAgrupada(cadastrosAgrupados, titulo);
}

function limparDados() {
  limparFormulario();
  showMessage('info', 'Formulário limpo! Pronto para novo cadastro.');
}

function buscarPorCNPJ() {
  // 🔥 CORREÇÃO: Pegar CNPJ do campo de busca e remover formatação
  const cnpjBusca = document.getElementById('cnpj').value.replace(/\D/g, '');
  
  if (!cnpjBusca) {
    showMessage('error', 'Digite um CNPJ para buscar');
    return;
  }

  showMessage('info', `🔍 Buscando cadastro no ${formatarNomeWaitlabel(waitlabelAtual)}...`);

  google.script.run
    .withSuccessHandler(function(dados) {
      preencherDadosCadastro(dados);
    })
    .withFailureHandler(function(error) {
      showMessage('error', 'Erro: ' + error.message);
    })
    .buscarCadastroPorCNPJ(cnpjBusca); // ✅ Envia apenas números
}

function preencherFornecedorComTarifas(dados) {
  console.log("🔧 PREENCHER FORNECEDOR - INICIANDO");
  console.log("📦 Dados recebidos:", dados);
  
  // Limpar seleções anteriores
  const checkboxes = document.querySelectorAll('input[name="fornecedor"]');
  checkboxes.forEach(cb => {
    cb.checked = false;
    const fornecedorId = cb.value.toLowerCase();
    const configDiv = document.getElementById(`config-${fornecedorId}`);
    if (configDiv) {
      configDiv.style.display = 'none';
      const radios = configDiv.querySelectorAll('input[type="radio"]');
      radios.forEach(radio => radio.checked = false);
      const select = configDiv.querySelector('select');
      if (select) select.value = '0%';
    }
  });
  
  if (!dados.fornecedor) {
    console.log("ℹ️ Nenhum fornecedor para preencher");
    return;
  }
  
  // 🔥 CORREÇÃO CRÍTICA: Buscar fornecedor de forma mais flexível
  const fornecedorBuscado = dados.fornecedor.toUpperCase().trim();
  console.log("🎯 Buscando fornecedor:", fornecedorBuscado);
  
  let checkboxEncontrado = null;
  
  // Buscar em TODOS os checkboxes
  checkboxes.forEach(cb => {
    const checkboxValor = cb.value.toUpperCase().trim();
    console.log(`🔍 Comparando: "${checkboxValor}" com "${fornecedorBuscado}"`);
    
    if (checkboxValor === fornecedorBuscado) {
      checkboxEncontrado = cb;
    }
  });
  
  if (checkboxEncontrado) {
    console.log("✅ Fornecedor encontrado:", checkboxEncontrado.value);
    checkboxEncontrado.checked = true;
    
    // Ativar configurações
    const fornecedorId = checkboxEncontrado.value.toLowerCase();
    const configDiv = document.getElementById(`config-${fornecedorId}`);
    
    if (configDiv) {
      configDiv.style.display = 'grid';
      
      // 🔥 CORREÇÃO: Preencher tarifa
      if (dados.tarifa) {
        const tarifaBuscada = dados.tarifa.toUpperCase().trim();
        console.log("💰 Buscando tarifa:", tarifaBuscada);
        
        const radioTarifa = configDiv.querySelector(`input[name="tarifa_${fornecedorId}"][value="${tarifaBuscada}"]`);
        if (radioTarifa) {
          radioTarifa.checked = true;
          console.log("✅ Tarifa selecionada:", tarifaBuscada);
        } else {
          console.log("⚠️ Tarifa não encontrada, usando MDR como padrão");
          const radioMDR = configDiv.querySelector(`input[name="tarifa_${fornecedorId}"][value="MDR"]`);
          if (radioMDR) {
            radioMDR.checked = true;
          }
        }
      }
      
      // 🔥 CORREÇÃO: Preencher percentual tarifa
      if (dados.percentual_tarifa !== undefined && dados.percentual_tarifa !== null) {
        const selectPercentual = configDiv.querySelector(`select[name="percentual_${fornecedorId}"]`);
        if (selectPercentual) {
          let percentualParaSelect = dados.percentual_tarifa;
          
          console.log("📊 Percentual original:", percentualParaSelect, "Tipo:", typeof percentualParaSelect);
          
          // Converter para formato do select (ex: 0.03 → 3%)
          if (typeof percentualParaSelect === 'number') {
            if (percentualParaSelect < 1) {
              percentualParaSelect = Math.round(percentualParaSelect * 100) + '%';
            } else {
              percentualParaSelect = Math.round(percentualParaSelect) + '%';
            }
          } else if (typeof percentualParaSelect === 'string') {
            // Se é string sem %, adicionar %
            if (percentualParaSelect && !percentualParaSelect.includes('%')) {
              percentualParaSelect = percentualParaSelect + '%';
            }
          }
          
          console.log("✅ Percentual para select:", percentualParaSelect);
          selectPercentual.value = percentualParaSelect;
          
          // Se não encontrou, tentar opção mais próxima
          if (!selectPercentual.value) {
            const valorNumerico = parseFloat(percentualParaSelect.replace('%', '').replace(',', '.'));
            if (!isNaN(valorNumerico)) {
              const opcoes = Array.from(selectPercentual.options);
              const opcaoCorrespondente = opcoes.find(opt => {
                const optValor = parseFloat(opt.value.replace('%', ''));
                return !isNaN(optValor) && optValor === valorNumerico;
              });
              if (opcaoCorrespondente) {
                selectPercentual.value = opcaoCorrespondente.value;
                console.log("✅ Usando opção correspondente:", opcaoCorrespondente.value);
              }
            }
          }
        }
      }
    }
  } else {
    console.log("❌ Fornecedor NÃO encontrado:", fornecedorBuscado);
    console.log("🔍 Checkboxes disponíveis:", Array.from(checkboxes).map(cb => cb.value));
  }
}

// 🔥 ADICIONE ESTA FUNÇÃO DE DEBUG PARA VERIFICAR OS DADOS
function debugDadosTarifa(dados) {
  console.log("🔍🔍🔍 DEBUG DADOS TARIFA:");
  console.log("📦 Todos os dados:", dados);
  console.log("💰 Fornecedor:", dados.fornecedor);
  console.log("💵 Tarifa:", dados.tarifa, "Tipo:", typeof dados.tarifa);
  console.log("📊 Percentual Tarifa:", dados.percentual_tarifa, "Tipo:", typeof dados.percentual_tarifa);
  console.log("🔍 Chaves disponíveis:", Object.keys(dados));
  
  // Verificar se há outras variações do nome do campo
  const chavesPercentual = Object.keys(dados).filter(key => 
    key.toLowerCase().includes('percent') || 
    key.toLowerCase().includes('tarifa')
  );
  console.log("🎯 Chaves relacionadas a tarifa/percentual:", chavesPercentual);
}

function limparBusca() {
  limparFormulario();
  
  // 🔥 CORREÇÃO: Esconder a tabela também
  document.getElementById('secaoCadastros').style.display = 'none';
  showMessage('info', 'Formulário limpo e busca cancelada!');
}

// 🔥 CORREÇÃO DA FUNÇÃO atualizarEventos()
function atualizarEventos() {
  const situacao = document.getElementById('situacao').value;
  const selectEvento = document.getElementById('evento');
  
  console.log("🎯 Atualizando eventos para situação:", situacao);
  
  // Limpar opções atuais
  selectEvento.innerHTML = '<option value="">-- Selecione um evento --</option>';
  
  let eventos = [];
  
  // ✅ CORREÇÃO: Usar comparações consistentes
  if (situacao === 'NOVO REGISTRO' || situacao === 'EM ANDAMENTO') {
    eventos = eventosEmAndamento;
  } else if (situacao === 'REJEITADO') {
    eventos = eventosRejeitado;
  } else if (situacao === 'CADASTRADO') {
    eventos = eventosCadastrado;
  } else if (situacao === 'DESCREDENCIADO') {
    eventos = eventosDescredenciado;
  } else if (situacao === 'DESISTIU') {
    eventos = eventosDesistiu; // 🔥 NOVOS EVENTOS PARA DESISTIU
  }
  
  console.log("📋 Eventos disponíveis:", eventos);
  
  // Adicionar opções ao select
  eventos.forEach(evento => {
    const option = document.createElement('option');
    option.value = evento;
    option.textContent = evento;
    selectEvento.appendChild(option);
  });
  
  // ✅ CORREÇÃO: Atualizar também o campo de search
  atualizarEventosSearch();
}

// 🔥 ADICIONE ESTA FUNÇÃO PARA ATUALIZAR O CAMPO DE SEARCH
function atualizarEventosSearch() {
  const situacao = document.getElementById('situacao').value;
  const inputSearch = document.getElementById('inputEventoSearch');
  
  // Limpar o campo de search quando mudar a situação
  inputSearch.value = '';
  
  console.log("🔄 Campo de search atualizado para situação:", situacao);
}

// 🔄 FUNÇÕES DE LOADING
function showLoading(message = "Salvando dados...", submessage = "Aguarde um momento") {
  const overlay = document.getElementById('loadingOverlay');
  const loadingText = overlay.querySelector('.loading-text');
  const loadingSubtext = overlay.querySelector('.loading-subtext');
  
  loadingText.textContent = message;
  loadingSubtext.textContent = submessage;
  overlay.style.display = 'flex';
}

function hideLoading() {
  const overlay = document.getElementById('loadingOverlay');
  overlay.style.display = 'none';
}

// 🔥 CORREÇÃO: Verificar se o elemento existe antes de adicionar event listener
const modalDetalhes = document.getElementById('modalDetalhes');
if (modalDetalhes) {
  modalDetalhes.addEventListener('click', function(e) {
    if (e.target === this) {
      fecharModalDetalhes();
    }
  });
}

// Fechar modal com ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    fecharModalDetalhes();
  }
});

function fecharModalDetalhes() {
  const modal = document.getElementById('modalDetalhes');
  modal.style.display = 'none';
}

// 🔥 ADICIONAR PARA EVITAR ERROS COM DATAS
function formatarDataParaExibicao(data) {
  if (!data) return '';
  
  try {
    // Se já estiver no formato brasileiro, retorna como está
    if (typeof data === 'string' && data.includes('/')) {
      return data;
    }
    
    // Se for objeto Date ou string ISO, formata
    const dateObj = new Date(data);
    if (!isNaN(dateObj.getTime())) {
      return dateObj.toLocaleDateString('pt-BR');
    }
    
    return data;
  } catch (error) {
    return data; // Retorna o valor original em caso de erro
  }
}

function getSituacaoClass(situacao) {
  if (!situacao) return 'situacao-cadastrado';
  
  const situacaoUpper = situacao.toUpperCase().trim();
  
  if (situacaoUpper.includes('NOVO REGISTRO')) return 'situacao-novo-registro';
  else if (situacaoUpper.includes('CADASTRADO')) return 'situacao-cadastrado';
  else if (situacaoUpper.includes('EM ANDAMENTO')) return 'situacao-andamento';
  else if (situacaoUpper.includes('REJEITADO') || situacaoUpper.includes('REJEITADO')) return 'situacao-rejeitado';
  else if (situacaoUpper.includes('DESCREDENCIADO')) return 'situacao-descredenciado';
  else if (situacaoUpper.includes('DESISTIU')) return 'situacao-desistiu'; // NOVA SITUAÇÃO
  else return 'situacao-cadastrado';
}

// 🔥 ADICIONAR: Função para configurar validação em tempo real
function configurarValidacaoEmTempoReal() {
  const campos = document.querySelectorAll('#razao_social, #cnpj_cadastro, #tipo');
  campos.forEach(campo => {
    campo.addEventListener('input', function() {
      this.style.borderColor = '';
    });
  });
}

// 🔥 ADICIONAR: Função para remover autorização (útil para testes)
function limparAutorizacao() {
  localStorage.removeItem('usuarioAutorizado');
  location.reload();
}

// 🔥🔥🔥 COLE ESTAS FUNÇÕES NO FINAL DO JAVASCRIPT 🔥🔥🔥

// 🔥 FUNÇÃO PARA AGRUPAR CADASTROS POR CNPJ
function agruparCadastrosPorCNPJ(cadastros) {
  const agrupados = {};
  
  cadastros.forEach(cadastro => {
    if (!agrupados[cadastro.cnpj]) {
      agrupados[cadastro.cnpj] = {
        razao_social: cadastro.razao_social,
        nome_fantasia: cadastro.nome_fantasia,
        cnpj: cadastro.cnpj,
        tipo: cadastro.tipo,
        mensalidade: cadastro.mensalidade,
        adesao: cadastro.adesao,
        situacao: cadastro.situacao,
        evento: cadastro.evento,
        fornecedores: []
      };
    }
    
    agrupados[cadastro.cnpj].fornecedores.push({
      nome: cadastro.fornecedor,
      tarifa: cadastro.tarifa,
      percentual_tarifa: cadastro.percentual_tarifa,
      evento: cadastro.evento,
      id: cadastro.id,
      situacao: cadastro.situacao
    });
  });
  
  return Object.values(agrupados);
}

// 🔥 FUNÇÃO PARA EXIBIR TABELA AGRUPADA
function exibirTabelaCadastrosAgrupada(cadastrosAgrupados, titulo) {
  const secao = document.getElementById('secaoCadastros');
  const tituloElement = document.getElementById('tituloCadastros');
  const tableContainer = document.getElementById('tableContainer');
  const tabelaBody = document.getElementById('tabelaCadastrosBody');
  const loading = document.getElementById('loadingCadastros');

  tituloElement.textContent = `${titulo} (${cadastrosAgrupados.length})`;
  tabelaBody.innerHTML = '';

  if (cadastrosAgrupados.length === 0) {
    tabelaBody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align: center; padding: 40px;">
          <i class="fas fa-search" style="font-size: 3rem; color: var(--gray); margin-bottom: 15px;"></i>
          <h3>Nenhum resultado encontrado</h3>
          <p>Tente alterar os filtros de pesquisa.</p>
        </td>
      </tr>
    `;
  } else {
    cadastrosAgrupados.forEach(cadastro => {
      const row = criarLinhaTabelaAgrupada(cadastro);
      tabelaBody.appendChild(row);
    });
  }

  loading.style.display = 'none';
  tableContainer.style.display = 'block';
  secao.style.display = 'block';
  atualizarContador();
  
  setTimeout(() => {
    secao.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 300);
}

// 🔥 FUNÇÃO PARA PADRONIZAR O TEXTO DA SITUAÇÃO
function padronizarSituacao(situacao) {
  if (!situacao) return 'NOVO REGISTRO';
  
  const situacaoUpper = situacao.toUpperCase().trim();
  
  if (situacaoUpper.includes('NOVO REGISTRO')) return 'NOVO REGISTRO';
  else if (situacaoUpper.includes('CADASTRADO')) return 'CADASTRADO';
  else if (situacaoUpper.includes('EM ANDAMENTO')) return 'EM ANDAMENTO';
  else if (situacaoUpper.includes('REJEITADO') || situacaoUpper.includes('REJEITADO')) return 'REJEITADO';
  else if (situacaoUpper.includes('DESCREDENCIADO')) return 'DESCREDENCIADO';
  else if (situacaoUpper.includes('DESISTIU')) return 'DESISTIU'; // NOVA SITUAÇÃO
  
  return situacaoUpper;
}

// 🔥 FUNÇÃO PARA CRIAR LINHA DA TABELA AGRUPADA
function criarLinhaTabelaAgrupada(cadastro) {
  const row = document.createElement('tr');
  row.style.cursor = 'pointer';
  
  // Classes de situação - USA A MESMA PADRONIZAÇÃO
const situacaoPadronizada = padronizarSituacao(cadastro.situacao);
let situacaoClass = 'situacao-cadastrado';
if (situacaoPadronizada === 'Novo registro') situacaoClass = 'situacao-novo-registro';
else if (situacaoPadronizada === 'Em andamento') situacaoClass = 'situacao-andamento';
else if (situacaoPadronizada === 'Rejeitado') situacaoClass = 'situacao-rejeitado';
else if (situacaoPadronizada === 'Descredenciado') situacaoClass = 'situacao-descredenciado';

    row.innerHTML = `
  <td style="vertical-align: top; padding: 15px 8px;">
    <div style="font-weight: 600; color: var(--primary); margin-bottom: 4px;">${cadastro.razao_social || 'N/A'}</div>
    <div style="font-size: 0.8rem; color: var(--gray); margin-bottom: 4px;">${cadastro.nome_fantasia || 'Sem nome fantasia'}</div>
    <div style="font-size: 0.7rem; color: var(--info);">
      <strong>Evento:</strong> ${cadastro.evento || 'N/A'}
    </div>
    <div style="font-size: 0.7rem; color: var(--warning);">
      <strong>Situação:</strong> <span class="status-badge ${getSituacaoClass(cadastro.situacao)}">${padronizarSituacao(cadastro.situacao) || 'N/A'}</span>
    </div>
  </td>
<td style="vertical-align: top; padding: 15px 8px;">
    <div style="font-family: monospace; font-size: 0.85rem; font-weight: 600; color: var(--dark);">
        ${cadastro.cnpj || 'N/A'}
    </div>
</td>
  <td style="vertical-align: top; padding: 15px 8px;">
    <div style="font-weight: 500; background: var(--primary); color: white; padding: 4px 8px; border-radius: 12px; text-align: center; margin-bottom: 4px;">
      ${cadastro.fornecedores.length} fornecedor(es)
    </div>
    <div style="font-size: 0.7rem; color: var(--gray);">
      ${cadastro.fornecedores.map(f => f.nome).join(', ')}
    </div>
  </td>
  <td style="vertical-align: middle; font-weight: 600; color: var(--success); padding: 15px 8px; text-align: center;">
  ${formatarMoedaParaInput(cadastro.mensalidade)}
</td>
<td style="vertical-align: middle; font-weight: 600; color: var(--info); padding: 15px 8px; text-align: center;">
  ${cadastro.adesao === 'Isento' || cadastro.adesao === 0 ? 'Isento' : formatarMoedaParaInput(cadastro.adesao)}
</td>
  <td class="acoes-cell" style="vertical-align: middle; padding: 0; height: 100%; text-align: center;">
  <button class="btn btn-info btn-sm btn-visualizar-compact" onclick="verDetalhesAgrupados('${cadastro.cnpj}')" title="Visualizar">
    <i class="fas fa-eye"></i> Visualizar
  </button>
</td>
`;

  return row;
}

// 🔥 FUNÇÃO PARA VER TODAS AS LOJAS DE UM CNPJ (VERSÃO QUE FUNCIONA)
function verDetalhesAgrupados(cnpj) {
  console.log("🔍🔍🔍 DEBUG: Função verDetalhesAgrupados CHAMADA");
  console.log("🔍 CNPJ:", cnpj);
  console.log("🔍 todosCadastros length:", todosCadastros ? todosCadastros.length : 'NULL');
  
  if (!todosCadastros || todosCadastros.length === 0) {
    console.log("❌ ERRO: todosCadastros está vazio ou não definido");
    showMessage('error', '❌ Dados não carregados. Clique em "Ver Todos os Cadastros" primeiro.');
    return;
  }
  
  // 🔥 CORREÇÃO: Filtrar das lojas que JÁ TEMOS carregadas
  const lojasDoCNPJ = todosCadastros.filter(cadastro => {
    console.log("🔍 Comparando:", cadastro.cnpj, "com", cnpj);
    return cadastro.cnpj === cnpj;
  });
  
  console.log("✅ Lojas encontradas:", lojasDoCNPJ.length);
  console.log("✅ Lojas:", lojasDoCNPJ);
  
  if (lojasDoCNPJ.length > 0) {
    console.log("🎯 Chamando exibirModalLojasAgrupadas");
    exibirModalLojasAgrupadas(cnpj, lojasDoCNPJ);
  } else {
    console.log("❌ Nenhuma loja encontrada para CNPJ:", cnpj);
    showMessage('error', '❌ Nenhuma loja encontrada para este CNPJ');
  }
}

// 🔥 FUNÇÃO PARA COR DA BORDA POR SITUAÇÃO (PADRONIZADA)
function getCorBordaSituacao(situacao) {
  // 🔥 CORREÇÃO: Padronizar para minúsculo
  const situacaoLower = situacao ? situacao.toLowerCase() : '';
  
  if (situacaoLower.includes('novo registro')) return '#bfe1f6';
  else if (situacaoLower.includes('cadastrado')) return '#D1E7DD';
  else if (situacaoLower.includes('em andamento')) return '#FFF3CD';
  else if (situacaoLower.includes('rejeitado') || situacaoLower.includes('rejeitado')) return '#E2E3E5';
  else if (situacaoLower.includes('descredenciado')) return '#F8D7DA';
  else if (situacaoLower.includes('desistiu')) return '#e6cff2'; // NOVA SITUAÇÃO
  else return 'var(--border)';
}

// 🔥 FUNÇÃO PARA EXIBIR MODAL COM TODAS AS LOJAS
function exibirModalLojasAgrupadas(cnpj, lojas) {
  const modal = document.getElementById('modalDetalhes');
  const content = document.getElementById('modalDetalhesContent');
  
  let lojasHTML = '';
  
  if (lojas && lojas.length > 0) {
    lojasHTML = lojas.map(loja => `
      <div class="loja-item" style="border: 3px solid ${getCorBordaSituacao(loja.situacao)}; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
          <h4 style="margin: 0; color: var(--primary);">🏪 ${loja.fornecedor || 'Fornecedor'}</h4>
          <span class="status-badge ${getSituacaoClass(loja.situacao)}">${loja.situacao || 'N/A'}</span>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
          <div><strong>📅 Evento:</strong> ${loja.evento || 'N/A'}</div>
          <div><strong>💰 Tarifa:</strong> ${loja.tarifa || 'N/A'} ${formatarPercentualParaExibicao(loja.percentual_tarifa)}</div>
          <div><strong>💵 Mensalidade:</strong> ${formatarMoedaParaInput(loja.mensalidade)}</div>
          <div><strong>🤝 Adesão:</strong> ${loja.adesao === 'Isento' || loja.adesao === 0 ? 'Isento' : formatarMoedaParaInput(loja.adesao)}</div>
        </div>
<div style="background: #f8f9fa; padding: 8px 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid var(--warning);">
  <strong>⏰ Defasagem:</strong> <span style="color: ${calcularDefasagem(loja.ultimo_evento).includes('30') || calcularDefasagem(loja.ultimo_evento).includes('31') ? 'var(--danger)' : 'var(--dark)'}; font-weight: 600;">${calcularDefasagem(loja.ultimo_evento)}</span>
</div>
        
        <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn btn-warning btn-sm" onclick="editarCadastroModal('${loja.id}')">
            <i class="fas fa-edit"></i> Editar
          </button>
          <button class="btn btn-info btn-sm" onclick="verDetalhesCadastroModal('${loja.id}')">
            <i class="fas fa-eye"></i> Detalhes
        </div>
      </div>
    `).join('');
  } else {
    lojasHTML = `
      <div style="text-align: center; padding: 40px; color: var(--gray);">
        <i class="fas fa-store-slash" style="font-size: 3rem; margin-bottom: 15px;"></i>
        <h4>Nenhuma loja encontrada</h4>
        <p>Não há lojas cadastradas para este CNPJ.</p>
      </div>
    `;
  }

  content.innerHTML = `
    <div style="margin-bottom: 15px;">
      <div style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
        <strong>CNPJ:</strong> ${cnpj}
      </div>
    </div>
    
    <div style="max-height: 60vh; overflow-y: auto;">
      <h4 style="color: var(--primary); margin-bottom: 15px;">
        📊 ${lojas ? lojas.length : 0} loja(s) encontrada(s)
      </h4>
      ${lojasHTML}
    </div>
  `;
  
  modal.style.display = 'flex';
}

function editarCadastroModal(id) {
    console.log("✏️ EDITANDO CADASTRO MODAL - INICIANDO");
    console.log("🔍 ID recebido:", id, "Waitlabel atual:", waitlabelAtual);
    
    showLoading("Carregando dados...", "Buscando informações da loja");
    
    // 🔥 USAR A NOVA FUNÇÃO COM WAITLABEL
    google.script.run
        .withSuccessHandler(function(dados) {
            console.log("✅ DADOS RECEBIDOS DO GS:", dados);
            hideLoading();
            fecharModalDetalhes(); // Fecha o modal das lojas
            
            if (dados.encontrado) {
                preencherDadosCadastro(dados);
                document.getElementById('razao_social').scrollIntoView({ behavior: 'smooth' });
                showMessage('success', '✅ Cadastro carregado para edição!');
                
                // 🔥🔥🔥 CONFIGURAR BOTÕES "APLICAR A TODOS" - CORREÇÃO COMPLETA
                configurarBotoesAplicarATodos(dados.cnpj);
                
                // 🔥🔥🔥 MOSTRAR O BOTÃO "APLICAR A TODOS"
                document.getElementById('btnAplicarATodos').style.display = 'block';
            } else {
                showMessage('error', '❌ ' + dados.mensagem);
            }
        })
        .withFailureHandler(function(error) {
            console.error("❌ ERRO AO CARREGAR CADASTRO:", error);
            hideLoading();
            showMessage('error', '❌ Erro ao carregar cadastro: ' + error.message);
        })
        .buscarCadastroPorIDComWaitlabel(id, waitlabelAtual);
}


// 🔥 FUNÇÃO PARA VER DETALHES DE UMA LOJA ESPECÍFICA (do modal)
function verDetalhesCadastroModal(id) {
  console.log("👀 Visualizando detalhes ID:", id, "Waitlabel:", waitlabelAtual);
  showLoading("Carregando detalhes...", "Buscando informações completas");
  
  google.script.run
    .withSuccessHandler(function(dados) {
      hideLoading();
      // 🔥 ADICIONAR WAITLABEL AOS DADOS PARA EXIBIÇÃO
      dados.waitlabel = waitlabelAtual;
      exibirModalDetalhesCompleto(dados);
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showMessage('error', '❌ Erro ao carregar detalhes: ' + error.message);
    })
    .buscarCadastroPorIDComWaitlabel(id, waitlabelAtual); // 🔥 NOVA FUNÇÃO
}

function exibirModalDetalhesCompleto(dados) {
  const modal = document.getElementById('modalDetalhes');
  const content = document.getElementById('modalDetalhesContent');
  
  // 🔥 ADICIONAR INFORMAÇÃO DO WAITLABEL (NOVA LINHA)
  const waitlabelInfo = dados.waitlabel ? 
    `<div style="background: ${WAITLABELS_CONFIG.CORES[dados.waitlabel] || '#7E3E9A'}; color: white; padding: 8px 12px; border-radius: 6px; margin-bottom: 15px; text-align: center;">
      <strong>📁 Waitlabel:</strong> ${formatarNomeWaitlabel(dados.waitlabel)}
    </div>` : '';
  
  const mensalidadeFormatada = formatarMoedaParaInput(dados.mensalidade);
  const adesaoFormatada = dados.adesao === 'Isento' || dados.adesao === 0 ? 'Isento' : formatarMoedaParaInput(dados.adesao);
  
  // 🔥 CORREÇÃO: Usar o campo correto para calcular defasagem
  const defasagem = calcularDefasagem(dados.ultimo_evento || dados.data_status);
  
  console.log("🔍 DEBUG DEFASAGEM - Modal Detalhes:");
  console.log("Data status:", dados.data_status);
  console.log("Último evento:", dados.ultimo_evento);
  console.log("Defasagem calculada:", defasagem);

  content.innerHTML = `
    ${waitlabelInfo} <!-- 🔥 ADICIONAR AQUI - LINHA NOVA -->
    
    <div class="detalhes-grid">
        <!-- 🔥 SEÇÃO: INFORMAÇÕES PRINCIPAIS -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0f8ff; border-left: 4px solid #7E3E9A;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #7E3E9A;">
                <i class="fas fa-info-circle"></i> 📋 INFORMAÇÕES PRINCIPAIS
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">🏢 Razão Social</span>
            <div class="detalhe-valor" style="font-weight: bold; color: #7E3E9A;">${dados.razao_social || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">🏷️ Nome Fantasia</span>
            <div class="detalhe-valor">${dados.nome_fantasia || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">🔢 CNPJ</span>
            <div class="detalhe-valor" style="font-family: monospace;">${dados.cnpj || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">📊 Tipo</span>
            <div class="detalhe-valor">${dados.tipo || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">🚚 Fornecedor</span>
            <div class="detalhe-valor">${dados.fornecedor || 'N/A'}</div>
        </div>

        <!-- 🔥 SEÇÃO: FINANCEIRO -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0fff0; border-left: 4px solid #28a745; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #28a745;">
                <i class="fas fa-chart-line"></i> 💰 INFORMAÇÕES FINANCEIRAS
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">💵 Mensalidade</span>
            <div class="detalhe-valor" style="color: var(--success); font-weight: 600;">${mensalidadeFormatada}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">🤝 Adesão</span>
            <div class="detalhe-valor" style="color: var(--info); font-weight: 600;">${adesaoFormatada}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">💰 Tarifa</span>
            <div class="detalhe-valor">${dados.tarifa || 'N/A'} ${formatarPercentualParaExibicao(dados.percentual_tarifa)}</div>
        </div>

        <!-- 🔥 SEÇÃO: CONTRATOS E DATAS -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #fff8f0; border-left: 4px solid #ff6b35; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #ff6b35;">
                <i class="fas fa-file-contract"></i> 📄 CONTRATOS E DATAS
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">📄 Contrato Enviado</span>
            <div class="detalhe-valor">${dados.contrato_enviado || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">✍️ Contrato Assinado</span>
            <div class="detalhe-valor">${dados.contrato_assinado || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">🚀 Data Ativação</span>
            <div class="detalhe-valor">${formatarDataParaExibicao(dados.ativacao) || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">📅 Último Evento</span>
            <div class="detalhe-valor">${dados.ultimo_evento || 'N/A'}</div>
        </div>

        <!-- 🔥 SEÇÃO: STATUS E ACOMPANHAMENTO -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0f0f8; border-left: 4px solid #6f42c1; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #6f42c1;">
                <i class="fas fa-tasks"></i> 📊 STATUS E ACOMPANHAMENTO
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">🎯 Situação</span>
            <div class="detalhe-valor">
                <span class="status-badge ${getSituacaoClass(dados.situacao)}">${dados.situacao || 'N/A'}</span>
            </div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">📅 Evento</span>
            <div class="detalhe-valor">${dados.evento || 'N/A'}</div>
        </div>

        <!-- 🔥 SEÇÃO: LINKS E OBSERVAÇÕES -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0f0f0; border-left: 4px solid #6c757d; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #6c757d;">
                <i class="fas fa-sticky-note"></i> 🔗 LINKS E OBSERVAÇÕES
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">🔗 Link</span>
            <div class="detalhe-valor">
                ${dados.link ? 
                    `<a href="${dados.link}" target="_blank" style="color: #007bff; text-decoration: none;">
                        <i class="fas fa-external-link-alt"></i> ${dados.link}
                    </a>` 
                    : 'N/A'
                }
            </div>
        </div>
        
        <div class="detalhe-item" style="grid-column: 1 / -1;">
            <span class="detalhe-label">📝 Observações</span>
            <div class="detalhe-valor" style="max-height: 100px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                ${dados.observacoes || 'Nenhuma observação registrada'}
            </div>
        </div>

        <!-- 🔥 SEÇÃO: DEFASAGEM - CORREÇÃO DA CONDIÇÃO -->
        ${defasagem !== 'N/A' && defasagem !== '0 dias' && defasagem !== 'Data inválida' && defasagem !== 'Erro no cálculo' ? `
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #fff5f5; border-left: 4px solid #dc3545; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #dc3545;">
                <i class="fas fa-clock"></i> ⚠️ INFORMAÇÕES DE DEFASAGEM
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">⏰ Defasagem</span>
            <div class="detalhe-valor">
                <span style="display: inline-flex; align-items: center; gap: 5px; background: #dc3545; color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.9rem; font-weight: 600;">
                    <i class="fas fa-clock"></i>
                    ${defasagem}
                </span>
            </div>
        </div>
        ` : ''}
    </div>

<div class="modal-detalhes-actions">
    <button type="button" class="btn btn-warning" onclick="editarCadastroModal('${dados.id}')">
        <i class="fas fa-edit"></i> ✏️ Editar Cadastro
    </button>
    </div>
  `;
  
  modal.style.display = 'flex';
}

function configurarFiltroEvento(situacao) {
  const container = document.getElementById('filtroEventoContainer');
  container.style.display = 'block';
  
  // 🔥 CORREÇÃO: Salvar a situação atual CORRETAMENTE
  container.setAttribute('data-situacao-atual', situacao);
  console.log("🎯 Situação do filtro definida para:", situacao);
}

function filtrarSugestoesEvento() {
  const input = document.getElementById('inputFiltroEvento');
  const suggestions = document.getElementById('suggestionsEvento');
  const container = document.getElementById('filtroEventoContainer');
  const termo = input.value.toLowerCase().trim();
  
  if (termo.length < 1) {
    suggestions.style.display = 'none';
    return;
  }
  
  // 🔥 CORREÇÃO: Pegar apenas os eventos da situação atual
  const situacaoAtual = container.dataset.situacaoAtual || 'all';
  let eventosDaSituacao = [];
  
  switch(situacaoAtual) {
    case 'all':
      // Se é "Todos", mostrar eventos de todas as situações
      eventosDaSituacao = [
        ...eventosEmAndamento,
        ...eventosRejeitado,
        ...eventosCadastrado,
        ...eventosDescredenciado,
        ...eventosDesistiu // 🔥 ADICIONAR EVENTOS DESISTIU
      ];
      break;
    case 'Novo registro':
    case 'Em andamento':
      eventosDaSituacao = eventosEmAndamento;
      break;
    case 'Rejeitado':
      eventosDaSituacao = eventosRejeitado;
      break;
    case 'Cadastrado':
      eventosDaSituacao = eventosCadastrado;
      break;
    case 'Descredenciado':
      eventosDaSituacao = eventosDescredenciado;
      break;
    case 'Desistiu':
      eventosDaSituacao = eventosDesistiu; // 🔥 NOVOS EVENTOS PARA DESISTIU
      break;
    default:
      eventosDaSituacao = [];
  }
  
  // Filtrar eventos que correspondem ao termo
  const eventosFiltrados = eventosDaSituacao.filter(evento => 
    evento.toLowerCase().includes(termo)
  );
  
  if (eventosFiltrados.length === 0) {
    suggestions.style.display = 'none';
    return;
  }
  
  // 🔥 CORREÇÃO: Agrupar por situação (mesmo sendo uma só, para manter a estrutura)
  let html = '';
  
  // Se é "Todos", agrupar por situação original
  if (situacaoAtual === 'all') {
    const eventosAgrupados = {
      'Em andamento': eventosFiltrados.filter(evento => eventosEmAndamento.includes(evento)),
      'Rejeitado': eventosFiltrados.filter(evento => eventosRejeitado.includes(evento)),
      'Cadastrado': eventosFiltrados.filter(evento => eventosCadastrado.includes(evento)),
      'Descredenciado': eventosFiltrados.filter(evento => evento === 'Descredenciado')
    };
    
    Object.keys(eventosAgrupados).forEach(situacao => {
      if (eventosAgrupados[situacao].length > 0) {
        html += `<div class="suggestion-evento-section">${situacao}</div>`;
        eventosAgrupados[situacao].forEach(evento => {
          html += `
            <div class="suggestion-evento-item" onclick="selecionarEventoFiltro('${evento}')">
              ${evento}
            </div>
          `;
        });
      }
    });
  } else {
    // Se é uma situação específica, mostrar só os eventos dela
    html += `<div class="suggestion-evento-section">${situacaoAtual}</div>`;
    eventosFiltrados.forEach(evento => {
      html += `
        <div class="suggestion-evento-item" onclick="selecionarEventoFiltro('${evento}')">
          ${evento}
        </div>
      `;
    });
  }
  
  suggestions.innerHTML = html;
  suggestions.style.display = 'block';
}

function selecionarEventoFiltro(evento) {
  const input = document.getElementById('inputFiltroEvento');
  const suggestions = document.getElementById('suggestionsEvento');
  
  input.value = evento;
  suggestions.style.display = 'none';
  
  // Aplicar o filtro
  aplicarFiltroEvento(evento);
}

function aplicarFiltroEvento(evento) {
  // Adicionar à lista de filtros ativos
  const tagsContainer = document.getElementById('tagsFiltrosAtivos');
  const filtroExistente = Array.from(tagsContainer.children).find(tag => 
    tag.textContent.includes(evento)
  );
  
  if (!filtroExistente) {
    const tag = document.createElement('div');
    tag.className = 'filtro-chip ativo';
    tag.innerHTML = `
      ${evento}
      <button class="remover" onclick="removerFiltroEvento('${evento}')">
        <i class="fas fa-times"></i>
      </button>
    `;
    tagsContainer.appendChild(tag);
    tagsContainer.style.display = 'flex';
  }

  // 🔥🔥🔥 NOVA LINHA - APLICAR TODOS OS FILTROS (OR)
  aplicarFiltrosAtivos();
}

function removerFiltroEvento(evento) {
  const tagsContainer = document.getElementById('tagsFiltrosAtivos');
  const tagParaRemover = Array.from(tagsContainer.children).find(tag => 
    tag.textContent.includes(evento)
  );
  
  if (tagParaRemover) {
    tagParaRemover.remove();
  }

  // 🔥🔥🔥 SEMPRE REAPLICAR OS FILTROS RESTANTES
  aplicarFiltrosAtivos();
}

// 🔥🔥🔥 FUNÇÃO PARA APLICAR FILTRO OR (MOSTRAR LOJAS COM PELO MENOS 1 DOS EVENTOS)
function aplicarFiltrosAtivos() {
  const tagsContainer = document.getElementById('tagsFiltrosAtivos');
  const eventosAtivos = Array.from(tagsContainer.children).map(tag => 
    tag.textContent.trim().replace('×', '').trim()
  );
  
  if (eventosAtivos.length > 0) {
    // 🔥 FILTRO OR: Mostrar cadastros que tenham QUALQUER um dos eventos selecionados
    cadastrosFiltrados = todosCadastros.filter(cadastro => 
      eventosAtivos.includes(cadastro.evento)
    );
    
    const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosFiltrados);
    exibirTabelaCadastrosAgrupada(cadastrosAgrupados, `Filtrado por: ${eventosAtivos.join(' OU ')}`);
    
    tagsContainer.style.display = 'flex';
  } else {
    // Se não há filtros, mostrar todos
    tagsContainer.style.display = 'none';
    recarregarCadastros();
  }
}

function limparFiltroEvento() {
  const input = document.getElementById('inputFiltroEvento');
  const suggestions = document.getElementById('suggestionsEvento');
  
  
  input.value = '';
  suggestions.style.display = 'none';
  
  
  // Remover todos os filtros
  const tagsContainer = document.getElementById('tagsFiltrosAtivos');
  tagsContainer.innerHTML = '';
  tagsContainer.style.display = 'none';
  
  recarregarCadastros();
}

// 🔥 FUNÇÃO PARA CARREGAR EVENTOS NO FILTRO
function carregarEventosParaFiltro(situacao) {
  const filtroEvento = document.getElementById('filtroEvento');
  
  // Limpar opções atuais (mantendo "Todos os eventos")
  const opcaoTodos = filtroEvento.querySelector('option[value=""]');
  filtroEvento.innerHTML = '';
  if (opcaoTodos) {
    filtroEvento.appendChild(opcaoTodos);
  }
  
  // Coletar eventos únicos baseados na situação
  let eventosUnicos = [];
  
  if (situacao === 'all') {
    eventosUnicos = [...new Set(todosCadastros
      .filter(cad => cad.evento && cad.evento.trim() !== '')
      .map(cad => cad.evento)
    )].sort();
  } else {
    eventosUnicos = [...new Set(todosCadastros
      .filter(cad => cad.situacao === situacao && cad.evento && cad.evento.trim() !== '')
      .map(cad => cad.evento)
    )].sort();
  }
  
  // Adicionar eventos ao select
  eventosUnicos.forEach(evento => {
    const option = document.createElement('option');
    option.value = evento;
    option.textContent = evento;
    filtroEvento.appendChild(option);
  });
}

// 🔥 FUNÇÃO PARA FILTRAR PESQUISA
function filtrarPesquisa() {
  const termo = document.getElementById('pesquisaCadastros').value.toLowerCase().trim();
  console.log("🔍 Pesquisando por:", termo);
  
  if (!termo) {
    // Se campo vazio, mostrar todos
    cadastrosFiltrados = [...todosCadastros];
  } else {
    // Filtrar por múltiplos campos
    cadastrosFiltrados = todosCadastros.filter(cadastro => 
      (cadastro.razao_social && cadastro.razao_social.toLowerCase().includes(termo)) ||
      (cadastro.nome_fantasia && cadastro.nome_fantasia.toLowerCase().includes(termo)) ||
      (cadastro.cnpj && cadastro.cnpj.includes(termo)) ||
      (cadastro.fornecedor && cadastro.fornecedor.toLowerCase().includes(termo)) ||
      (cadastro.evento && cadastro.evento.toLowerCase().includes(termo))
    );
  }
  
  const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosFiltrados);
  exibirTabelaCadastrosAgrupada(cadastrosAgrupados, `Resultados para: "${termo}"`);
}

// 🔥 FUNÇÃO PARA ATUALIZAR CONTADOR
function atualizarContador() {
  const contador = document.getElementById('contadorCadastros');
  const cadastrosVisiveis = document.querySelectorAll('#tabelaCadastrosBody tr').length;
  contador.textContent = `${cadastrosVisiveis} cadastro${cadastrosVisiveis !== 1 ? 's' : ''}`;
}

// 🔥 FUNÇÕES ADICIONAIS PARA COMPLETAR
function ordenarCadastros() {
  const criterio = document.getElementById('ordenacaoCadastros').value;
  console.log("🔀 Ordenando por:", criterio);
  
  if (cadastrosFiltrados.length === 0) return;
  
  const cadastrosOrdenados = [...cadastrosFiltrados].sort((a, b) => {
    const valorA = a[criterio] || '';
    const valorB = b[criterio] || '';
    
    if (typeof valorA === 'string' && typeof valorB === 'string') {
      return valorA.localeCompare(valorB);
    }
    return 0;
  });
  
  const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosOrdenados);
  exibirTabelaCadastrosAgrupada(cadastrosAgrupados, 'Cadastros Ordenados');
}

function recarregarCadastros() {
  console.log("🔄 Recarregando cadastros...");
  mostrarTodosCadastros();
}

// 🔥 CORREÇÃO DA FUNÇÃO - AGORA VAI FUNCIONAR!
function filtrarSugestoesEventoSearch() {
  const input = document.getElementById('inputEventoSearch');
  const suggestions = document.getElementById('suggestionsEventoSearch');
  const termo = input.value.toLowerCase().trim();
  
  console.log("🎯 FILTRAR SUGESTÕES EVENTO SEARCH - Termo:", termo);
  
  // 🔥 OBTER EVENTOS BASEADO NA SITUAÇÃO ATUAL - CORREÇÃO DEFINITIVA
  const situacaoAtual = document.getElementById('situacao').value;
  let eventosDaSituacao = [];
  
  console.log("📋 Situação atual do select:", situacaoAtual);
  
  // ✅ CORREÇÃO DEFINITIVA: Comparações corretas e completas
  if (situacaoAtual === 'NOVO REGISTRO') {
    eventosDaSituacao = eventosNovoRegistro;
    console.log("📝 Carregando eventos NOVO REGISTRO:", eventosNovoRegistro);
  } else if (situacaoAtual === 'EM ANDAMENTO') {
    eventosDaSituacao = eventosEmAndamento;
    console.log("📝 Carregando eventos EM ANDAMENTO:", eventosEmAndamento);
  } else if (situacaoAtual === 'REJEITADO') {
    eventosDaSituacao = eventosRejeitado;
    console.log("📝 Carregando eventos REJEITADO:", eventosRejeitado);
  } else if (situacaoAtual === 'CADASTRADO') {
    eventosDaSituacao = eventosCadastrado;
    console.log("📝 Carregando eventos CADASTRADO:", eventosCadastrado);
  } else if (situacaoAtual === 'DESCREDENCIADO') {
    eventosDaSituacao = eventosDescredenciado;
    console.log("📝 Carregando eventos DESCREDENCIADO:", eventosDescredenciado);
  } else if (situacaoAtual === 'DESISTIU') {
    eventosDaSituacao = eventosDesistiu; // 🔥 NOVOS EVENTOS PARA DESISTIU
    console.log("📝 Carregando eventos DESISTIU:", eventosDesistiu);
  }
  
  console.log("🎯 Total de eventos carregados:", eventosDaSituacao.length);
  
  // Se não digitou nada, mostrar TODOS os eventos da situação
  let eventosParaMostrar = eventosDaSituacao;
  
  // Se digitou algo, filtrar
  if (termo.length > 0) {
    eventosParaMostrar = eventosDaSituacao.filter(evento => 
      evento.toLowerCase().includes(termo)
    );
    console.log("🔍 Eventos filtrados:", eventosParaMostrar.length);
  }
  
  if (eventosParaMostrar.length === 0) {
    suggestions.innerHTML = `
      <div class="suggestion-evento-item-search" style="color: var(--gray);">
        <i class="fas fa-search"></i>
        Nenhum evento encontrado
      </div>
    `;
  } else {
    let html = `<div class="suggestion-evento-section-search">
      <i class="fas fa-filter"></i> Eventos para: ${situacaoAtual} (${eventosParaMostrar.length})
    </div>`;
    
    eventosParaMostrar.forEach(evento => {
      html += `
        <div class="suggestion-evento-item-search" onclick="selecionarEventoSearch('${evento}')">
          <i class="fas fa-calendar-check"></i>
          ${evento}
        </div>
      `;
    });
    
    suggestions.innerHTML = html;
  }
  
  suggestions.style.display = 'block';
  console.log("✅ Sugestões mostradas com sucesso!");
}

// 🔥 ADICIONE TAMBÉM ESTA FUNÇÃO PARA TESTE RÁPIDO
function testarEventos() {
  console.log("=== 🧪 TESTE DE EVENTOS ===");
  console.log("NOVO REGISTRO:", eventosNovoRegistro);
  console.log("CADASTRADO:", eventosCadastrado);
  console.log("EM ANDAMENTO:", eventosEmAndamento);
  console.log("REJEITADO:", eventosRejeitado);
  console.log("DESCREDENCIADO:", eventosDescredenciado);
  
  // Testar a função
  filtrarSugestoesEventoSearch();
}

// 🔥 CONFIGURAÇÃO PARA FECHAR SUGESTÕES AO CLICAR FORA
document.addEventListener('click', function(e) {
  // Fechar sugestões do formulário
  const suggestionsSearch = document.getElementById('suggestionsEventoSearch');
  const inputSearch = document.getElementById('inputEventoSearch');
  
  if (suggestionsSearch && suggestionsSearch.style.display === 'block') {
    if (!suggestionsSearch.contains(e.target) && e.target !== inputSearch) {
      suggestionsSearch.style.display = 'none';
      console.log("❌ Fechando sugestões - clique fora");
    }
  }
  
  // Fechar sugestões do filtro
  const suggestionsFiltro = document.getElementById('suggestionsEvento');
  const inputFiltro = document.getElementById('inputFiltroEvento');
  
  if (suggestionsFiltro && suggestionsFiltro.style.display === 'block') {
    if (!suggestionsFiltro.contains(e.target) && e.target !== inputFiltro) {
      suggestionsFiltro.style.display = 'none';
    }
  }
});

// 🔥 FECHAR SUGESTÕES COM ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const suggestionsSearch = document.getElementById('suggestionsEventoSearch');
    const suggestionsFiltro = document.getElementById('suggestionsEvento');
    
    if (suggestionsSearch) {
      suggestionsSearch.style.display = 'none';
      console.log("❌ Fechando sugestões - ESC pressionado");
    }
    if (suggestionsFiltro) suggestionsFiltro.style.display = 'none';
  }
});

// 🔥 MOSTRAR SUGESTÕES AO CLICAR NO CAMPO (PARA O FORMULÁRIO)
document.getElementById('inputEventoSearch').addEventListener('click', function() {
  console.log("🎯 Clicou no campo de evento - mostrando sugestões");
  filtrarSugestoesEventoSearch();
});

// 🔥 TESTE SIMPLES PARA VERIFICAR SE OS EVENTOS ESTÃO CARREGADOS
setTimeout(() => {
  console.log("=== 🔥 TESTE DE EVENTOS ===");
  console.log("Eventos Em Andamento:", eventosEmAndamento);
  console.log("Eventos Cadastrado:", eventosCadastrado);
  console.log("Eventos Rejeitado:", eventosRejeitado);
}, 2000);

// Função para selecionar evento no search
function selecionarEventoSearch(evento) {
  const input = document.getElementById('inputEventoSearch');
  const suggestions = document.getElementById('suggestionsEventoSearch');
  const selectEvento = document.getElementById('evento');
  
  // Definir valores
  input.value = evento;
  selectEvento.value = evento;
  
  // Ocultar sugestões
  suggestions.style.display = 'none';
  
  console.log("✅ Evento selecionado:", evento);
}

// 🔥 NOVA FUNÇÃO: Sincronizar campos de evento - ADICIONE ISSO NO FINAL
function sincronizarCamposEvento() {
  const inputSearch = document.getElementById('inputEventoSearch');
  const selectEvento = document.getElementById('evento');
  
  if (!inputSearch || !selectEvento) {
    console.log("❌ Campos de evento não encontrados");
    return;
  }
  
  console.log("✅ Sincronizando campos de evento...");
  
  // Quando o search muda, atualiza o select
  inputSearch.addEventListener('input', function() {
    const valor = this.value;
    console.log("🔄 Input evento alterado:", valor);
    
    // Encontrar opção correspondente no select
    const opcoes = Array.from(selectEvento.options);
    const opcaoCorrespondente = opcoes.find(opt => opt.text === valor);
    
    if (opcaoCorrespondente) {
      selectEvento.value = opcaoCorrespondente.value;
      console.log("✅ Select atualizado para:", opcaoCorrespondente.value);
    } else {
      selectEvento.value = '';
      console.log("⚠️ Nenhuma opção correspondente encontrada");
    }
  });
  
  // Quando o select muda, atualiza o search
  selectEvento.addEventListener('change', function() {
    const opcaoSelecionada = this.options[this.selectedIndex];
    if (opcaoSelecionada && opcaoSelecionada.value) {
      inputSearch.value = opcaoSelecionada.text;
      console.log("✅ Input search atualizado para:", opcaoSelecionada.text);
    }
  });
}

// 🔥 TESTE FINAL - VERIFICAR SE TUDO ESTÁ FUNCIONANDO
setTimeout(() => {
  console.log("=== 🧪 TESTE FINAL DO SISTEMA ===");
  console.log("✅ DOMContentLoaded executado");
  console.log("✅ Event listener do inputEventoSearch:", document.getElementById('inputEventoSearch') !== null);
  console.log("✅ Função filtrarSugestoesEventoSearch:", typeof filtrarSugestoesEventoSearch);
  console.log("✅ CSS carregado corretamente");
  
  // Teste manual: clique no campo para ver se as sugestões aparecem
  const inputEvento = document.getElementById('inputEventoSearch');
  if (inputEvento) {
    console.log("🎯 Clique no campo 'Digite para buscar evento...' para testar as sugestões!");
  }
}, 3000);

  </script>
</body>
</html>
