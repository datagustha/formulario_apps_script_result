<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gest√£o de Cadastros - RESULT</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    /* üî• ESTILOS DO SISTEMA */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    
    :root {
      --primary: #7E3E9A;
      --secondary: #A1CC4C;
      --accent: #FF6B35;
      --dark: #2D3047;
      --light: #FFFFFF;
      --success: #28A745;
      --warning: #FFC107;
      --danger: #DC3545;
      --info: #17A2B8;
      --gray: #6C757D;
      --border: #E0E0E0;
      --background: #F8F9FA;
    }
    
    body {
      background: var(--background);
      min-height: 100vh;
      padding: 20px;
      color: var(--dark);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--light);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .header {
      background: var(--primary);
      padding: 30px 40px;
      color: white;
      text-align: center;
    }
    
    .logo-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    
    .logo {
      width: 120px;
      height: 120px;
      background: white;
      padding: 15px;
      border-radius: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    h1 {
      font-size: 2.8rem;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .subtitle {
      font-size: 1.3rem;
      opacity: 0.9;
    }
    
    .content {
      padding: 40px;
    }
    
 .card {
  background: var(--light);
  border-radius: 12px;
  padding: 30px;
  margin-bottom: 25px;
  margin-top: 40px; /* üî• ADICIONE ESTA LINHA - ESPA√áO ACIMA */
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
  border: 1px solid var(--border);
}
    
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 3px solid var(--primary);
    }
    
    .card-header i {
      color: var(--primary);
      font-size: 1.8rem;
    }
    
    .card-title {
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--primary);
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #6a2e82;
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-warning {
      background: var(--warning);
      color: var(--dark);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-info {
      background: var(--info);
      color: white;
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-sm {
      padding: 8px 16px;
      font-size: 0.9rem;
    }
    
    .btn-group {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }
    
    .message {
      padding: 15px 20px;
      border-radius: 8px;
      margin: 15px 0;
      display: none;
      align-items: center;
      gap: 10px;
    }
    
    .success {
      background: #d4edda;
      color: var(--success);
      border: 1px solid #c3e6cb;
    }
    
    .error {
      background: #f8d7da;
      color: var(--danger);
      border: 1px solid #f5c6cb;
    }
    
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    /* üî• ESTILOS DE LOADING */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* üî• ESTILOS DA TABELA */
    .table-container {
      margin-top: 20px;
      overflow: hidden;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .table-responsive {
      overflow-x: auto;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      table-layout: fixed;
    }
    
    .data-table th {
      background: var(--primary);
      color: white;
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 0.9rem;
      position: sticky;
      top: 0;
    }
    
    .data-table td {
      padding: 12px 8px;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
      word-wrap: break-word;
    }
    
    .data-table tbody tr {
      transition: all 0.3s ease;
      display: table-row;
    }
    
    .data-table tbody tr:hover {
      background: #f8f9fa;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .data-table .btn-sm {
      padding: 6px 12px;
      font-size: 0.8rem;
      margin: 2px;
    }
    
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-align: center;
      display: inline-block;
      min-width: 80px;
    }
    
    .acoes-cell {
      display: flex;
      gap: 5px;
      justify-content: center;
      align-items: center;
    }
    
.action-buttons {
  display: flex;
  gap: 15px;
  margin: 40px 0 20px 0; /* üî• ADICIONA ESPA√áO ACIMA E ABAIXO */
  flex-wrap: wrap;
  /* REMOVE: padding, background, border, border-radius */
}
    
    .cadastros-container {
      margin-top: 30px;
      padding: 25px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border: 2px solid var(--primary);
    }
    
    .cadastros-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .cadastro-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      border: 2px solid var(--border);
      transition: all 0.3s ease;
    }
    
    .cadastro-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .cadastro-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }
    
    .cadastro-nome {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--dark);
    }
    
    .cadastro-situacao {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .situacao-cadastrado {
      background: #D1E7DD;
      color: #0F5132;
    }

    .situacao-novo-registro {
      background-color: #bfe1f6 !important;
      color: #0c5aa3 !important;
      border: 1px solid #8bc9f0 !important;
    }
    
    .situacao-andamento {
      background: #FFF3CD;
      color: #856404;
    }
    
    .situacao-nao-concluido {
      background: #E2E3E5;
      color: #383D41;
    }
    
    .situacao-descredenciado {
      background: #F8D7DA;
      color: #721C24;
    }
    
    .cadastro-info {
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    
    .cadastro-info strong {
      color: var(--primary);
    }
    
    .mensalidade-badge {
      background: var(--primary);
      color: white;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .filtros-container {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .filtros-eventos {
      display: none;
      margin-top: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

/* üî• ESTILOS PARA FILTRO DE EVENTOS COM SEARCH */
.filtro-search-container {
  margin: 15px 0;
  padding: 15px;
  background: var(--light);
  border-radius: 10px;
  border: 1px solid var(--border);
}

.suggestions-evento {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid var(--primary);
  border-top: none;
  border-radius: 0 0 8px 8px;
  z-index: 1000;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  max-height: 200px;
  overflow-y: auto;
  margin-top: -2px;
}

.suggestion-evento-item {
  padding: 10px 15px;
  cursor: pointer;
  border-bottom: 1px solid var(--border);
  transition: all 0.2s ease;
  font-size: 0.9rem;
}

.suggestion-evento-item:hover {
  background: var(--primary);
  color: white;
}

.suggestion-evento-item:last-child {
  border-bottom: none;
}

.suggestion-evento-section {
  background: var(--primary);
  color: white;
  font-weight: 700;
  padding: 8px 15px;
  font-size: 0.8rem;
  border-bottom: 1px solid var(--border);
}

.filtro-chip {
  background: white;
  border: 2px solid var(--border);
  border-radius: 20px;
  padding: 6px 12px;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
}

.filtro-chip.ativo {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.filtro-chip .remover {
  background: none;
  border: none;
  color: inherit;
  cursor: pointer;
  padding: 0;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
}

.filtro-chip .remover:hover {
  background: rgba(255,255,255,0.3);
}
    
    /* üî• ESTILOS PARA PESQUISA */
    .search-container {
      position: relative;
    }

    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--primary);
      border-top: none;
      border-radius: 0 0 10px 10px;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      margin-top: -2px;
      max-height: 300px;
      overflow-y: auto;
    }

    .suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: all 0.2s ease;
      font-size: 1rem;
      font-weight: 500;
    }

    .suggestion-item:hover {
      background: var(--primary);
      color: white;
      font-weight: 600;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-section {
      background: var(--primary);
      color: white;
      font-weight: 700;
      padding: 10px 16px;
      font-size: 0.9rem;
      border-bottom: 1px solid var(--border);
    }

    .contador-lojas {
      background: var(--primary);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    /* üî• ESTILOS PARA CAMPOS OBRIGAT√ìRIOS */
    .form-label.obrigatorio::after {
      content: " *";
      color: var(--danger);
      font-weight: bold;
      margin-left: 2px;
    }

    .campo-obrigatorio {
      border-left: 4px solid var(--danger) !important;
      background-color: #fff5f5 !important;
    }

    .aviso-obrigatorio {
      color: var(--danger);
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 5px;
      display: none;
    }

    /* üî•üî•üî• ADICIONE ESTE CSS AQUI - ESTILOS MELHORADOS PARA VALIDA√á√ÉO */
    .form-control.campo-obrigatorio,
    select.campo-obrigatorio {
      border: 2px solid var(--danger) !important;
      background-color: #fff5f5 !important;
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1) !important;
      animation: pulse 0.5s ease-in-out;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

    /* Destaque para a se√ß√£o de fornecedores quando inv√°lida */
    .fornecedores-invalido {
      border: 2px solid var(--danger) !important;
      background: #fff5f5 !important;
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    /* üî• ESTILOS PARA BOT√ïES DE A√á√ÉO NA TABELA */
    .btn-editar {
      background: var(--primary);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }
    
    .btn-editar:hover {
      background: #6a2e82;
    }
    
    .btn-visualizar {
      background: var(--info);
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }
    
    .btn-visualizar:hover {
      background: #138496;
    }

    /* üîÑ ESTILOS PARA O LOADING OVERLAY */
    #loadingOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .loading-content {
      background: white;
      padding: 40px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      min-width: 300px;
      border: 3px solid var(--primary);
    }

    .loading-spinner-large {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    .loading-text {
      margin: 0;
      color: var(--dark);
      font-weight: bold;
      font-size: 18px;
    }

    .loading-subtext {
      margin: 8px 0 0 0;
      color: var(--gray);
      font-size: 14px;
    }

    /* üî• ESTILOS PARA O MODAL DE DETALHES */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      border: 3px solid var(--primary);
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--primary);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
    }

    .btn-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray);
      padding: 5px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .btn-close:hover {
      background: var(--danger);
      color: white;
    }

    .detalhes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .detalhe-item {
      margin-bottom: 12px;
    }

    .detalhe-label {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 5px;
      display: block;
    }

    .detalhe-valor {
      color: var(--dark);
      background: #f8f9fa;
      padding: 8px 12px;
      border-radius: 8px;
      border-left: 3px solid var(--primary);
    }

    
/* üî•üî•üî• CORRE√á√ÉO DEFINITIVA - LARGURAS E ALINHAMENTO */
.data-table {
  table-layout: fixed;
  width: 100%;
}

/* üî• LARGURAS DAS COLUNAS */
.data-table th:nth-child(1),
.data-table td:nth-child(1) {
  width: 25%; /* Raz√£o Social */
}

.data-table th:nth-child(2),
.data-table td:nth-child(2) {
  width: 14%; /* CNPJ */
}

.data-table th:nth-child(3),
.data-table td:nth-child(3) {
  width: 20%; /* Fornecedor */
}

.data-table th:nth-child(4),
.data-table td:nth-child(4) {
  width: 12%; /* Mensalidade */
}

.data-table th:nth-child(5),
.data-table td:nth-child(5) {
  width: 12%; /* Ades√£o */
}

.data-table th:nth-child(6),
.data-table td:nth-child(6) {
  width: 17%; /* A√ß√µes */
}



/* üî• CORRE√á√ÉO ESPEC√çFICA PARA O BOT√ÉO VISUALIZAR */
.btn-visualizar-compact {
  padding: 8px 12px !important;
  font-size: 0.8rem !important;
  min-width: 100px;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
}

/* üî• GARANTIR QUE TODAS AS C√âLULAS TENHAM MESMA ALTURA */
.data-table tbody tr {
}


/* üî• EXCE√á√ÉO: Primeira coluna alinhada √† esquerda */
.data-table td:nth-child(1) {
  text-align: left;
  vertical-align: top !important;
}

/* üî• LARGURAS DAS COLUNAS */
.data-table th:nth-child(6),
.data-table td:nth-child(6) {
  width: 17%; /* A√ß√µes */
}




/* üî• ESTILOS PARA O SEARCH DE EVENTOS NO FORMUL√ÅRIO */
.suggestions-evento-search {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid var(--primary);
  border-top: none;
  border-radius: 0 0 8px 8px;
  z-index: 1000;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  max-height: 300px;
  overflow-y: auto;
  margin-top: -2px;
}

.suggestion-evento-item-search {
  padding: 10px 15px;
  cursor: pointer;
  border-bottom: 1px solid var(--border);
  transition: all 0.2s ease;
  font-size: 0.9rem;
}

.suggestion-evento-item-search:hover {
  background: var(--primary);
  color: white;
}

.suggestion-evento-item-search:last-child {
  border-bottom: none;
}

.suggestion-evento-section-search {
  background: var(--primary);
  color: white;
  font-weight: 700;
  padding: 8px 15px;
  font-size: 0.8rem;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
}


  /* üî•üî•üî• CORRE√á√ÉO DEFINITIVA - ALINHAMENTO VERTICAL DA COLUNA A√á√ïES */
.data-table tbody tr {
    display: table-row;
    height: auto;
}

.data-table td {
    vertical-align: middle !important;
    padding: 15px 8px !important;
    height: 100% !important;
    border-bottom: 1px solid var(--border);
}

/* üî•üî•üî• CORRE√á√ÉO URGENTE - BOT√ÉO NO MEIO DA C√âLULA */
.data-table td:nth-child(6) {
    height: 100% !important;
    min-height: 100% !important;
    vertical-align: middle !important;
    padding: 0 !important;
    display: table-cell !important;
}

.acoes-cell {
    height: 100% !important;
    min-height: 100% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 0 !important;
    margin: 0 !important;
}

/* üî• GARANTIR QUE O BOT√ÉO OCUPE TODA A ALTURA */
.btn-visualizar-compact {
    height: 100% !important;
    min-height: 40px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 8px 12px !important;
    margin: 0 !important;
    width: 100%;
    border-radius: 6px !important;
}

/* üî• CORRE√á√ÉO DA PRIMEIRA COLUNA (mant√©m alinhamento ao topo) */
.data-table td:nth-child(1) {
    vertical-align: top !important;
}

/* üî• CORRE√á√ÉO DAS OUTRAS COLUNAS (alinhamento no meio) */
.data-table td:nth-child(2),
.data-table td:nth-child(3),
.data-table td:nth-child(4),
.data-table td:nth-child(5),
.data-table td:nth-child(6) {
    vertical-align: middle !important;
}
  

    @media (max-width: 768px) {
      .content {
        padding: 20px;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .cadastros-grid {
        grid-template-columns: 1fr;
      }
      
      .card-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .filtros-container {
        margin-top: 15px;
      }
      
      .data-table {
        font-size: 0.8rem;
      }
      
      .acoes-cell {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo-container">
        <div class="logo">üè¢</div>
        <div>
          <h1>RESULT</h1>
          <div class="subtitle">Sistema de Gest√£o de Cadastros</div>
        </div>
      </div>
    </div>
    
        <!-- BOT√ïES DE A√á√ÉO SIMPLIFICADOS -->
      <div class="action-buttons">
        <button type="button" class="btn btn-primary" onclick="mostrarTodosCadastros()">
          <i class="fas fa-store"></i>
          Ver Todos os Cadastros
        </button>
        <button type="button" class="btn btn-info" onclick="limparBusca()">
          <i class="fas fa-broom"></i>
          Limpar Busca
        </button>
      </div>

      
      
      <!-- CARD DADOS DO CADASTRO -->
      <div class="card">
        <div class="card-header">
          <i class="fas fa-info-circle"></i>
          <h2 class="card-title">Dados do Cadastro</h2>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-building"></i>
              Raz√£o Social
            </label>
            <input type="text" id="razao_social" class="form-control">
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-signature"></i>
              Nome Fantasia
            </label>
            <input type="text" id="nome_fantasia" class="form-control">
          </div>
          
          <!-- üî• CAMPO CNPJ ADICIONADO AQUI -->
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-id-card"></i>
              CNPJ
            </label>
            <input type="text" id="cnpj_cadastro" class="form-control" 
                   placeholder="Digite o CNPJ para cadastro..."
                   oninput="formatarCNPJ(this)">
          </div>
          
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-tag"></i>
              Tipo
            </label>
            <select id="tipo" class="form-control">
              <option value="">-- Selecione --</option>
              <option value="GERAL">GERAL</option>
              <option value="SORRIA SIM">SORRIA SIM</option>
              <option value="SORRIF√ÅCIL">SORRIF√ÅCIL</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-calendar"></i>
              Data Status
            </label>
            <input type="date" id="data_status" class="form-control">
          </div>
          
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-file-contract"></i>
              Contrato Enviado
            </label>
            <select id="contrato_enviado" class="form-control">
              <option value="">-- Selecione --</option>
              <option value="Sim">Sim</option>
              <option value="N√£o">N√£o</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-file-signature"></i>
              Contrato Assinado
            </label>
            <select id="contrato_assinado" class="form-control">
              <option value="">-- Selecione --</option>
              <option value="Sim">Sim</option>
              <option value="N√£o">N√£o</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-play-circle"></i>
              Ativa√ß√£o
            </label>
            <input type="date" id="ativacao" class="form-control">
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-link"></i>
              Link
            </label>
            <input type="text" id="link" class="form-control" placeholder="https://...">
          </div>
          
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-money-bill-wave"></i>
              Mensalidade
            </label>
            <input type="text" id="mensalidade" class="form-control" placeholder="R$ 0,00" oninput="formatarMoeda(this)">
          </div>

          <!-- üî• CAMPO ADES√ÉO -->
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-handshake"></i>
              Ades√£o
            </label>
            <input type="text" id="adesao" class="form-control" placeholder="R$ 0,00" oninput="formatarMoeda(this)" value="R$ 0,00">
            <small style="color: var(--gray); font-size: 0.8rem;">
              <i class="fas fa-info-circle"></i> Valor "0,00" ser√° salvo como "Isento"
            </small>
          </div>
          
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-flag"></i>
              Situa√ß√£o
            </label>
            <select id="situacao" class="form-control">
              <option value="Novo registro">Novo registro</option>
              <option value="Cadastrado">Cadastrado</option>
              <option value="Em andamento">Em andamento</option>
              <option value="N√£o conclu√≠do">N√£o conclu√≠do</option>
              <option value="Descredenciado">Descredenciado</option>
            </select>
          </div>

          <!-- üî• FORNECEDORES COM TARIFAS INDIVIDUAIS -->
          <div class="form-group" style="grid-column: 1 / -1;">
            <label class="form-label">
              <i class="fas fa-truck"></i>
              Fornecedor(es) - <span style="color: var(--primary); font-weight: 600;">Selecione e configure cada um</span>
            </label>
            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 12px; border: 2px dashed var(--primary);">
              
              <!-- FORNECEDOR Agil -->
              <div class="fornecedor-item" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                  <input type="checkbox" name="fornecedor" value="Agil" style="width: 20px; height: 20px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'agil')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1.1rem;">Agil</span>
                </div>
                <div id="config-agil" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 15px;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_agil" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_agil" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Valor da Tarifa</label>
                    <select name="percentual_agil" style="width: 100%; padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px;">
                      <option value="0%">0%</option>
                      <option value="1%">1%</option>
                      <option value="2%">2%</option>
                      <option value="3%">3%</option>
                      <option value="4%">4%</option>
                      <option value="5%">5%</option>
                      <option value="6%">6%</option>
                      <option value="7%">7%</option>
                      <option value="8%">8%</option>
                      <option value="9%">9%</option>
                      <option value="10%">10%</option>
                      <option value="11%">11%</option>
                      <option value="12%">12%</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- FORNECEDOR BC -->
              <div class="fornecedor-item" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                  <input type="checkbox" name="fornecedor" value="BC" style="width: 20px; height: 20px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'bc')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1.1rem;">BC</span>
                </div>
                <div id="config-bc" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 15px;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_bc" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_bc" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Valor da Tarifa</label>
                    <select name="percentual_bc" style="width: 100%; padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px;">
                      <option value="0%">0%</option>
                      <option value="1%">1%</option>
                      <option value="2%">2%</option>
                      <option value="3%">3%</option>
                      <option value="4%">4%</option>
                      <option value="5%">5%</option>
                      <option value="6%">6%</option>
                      <option value="7%">7%</option>
                      <option value="8%">8%</option>
                      <option value="9%">9%</option>
                      <option value="10%">10%</option>
                      <option value="11%">11%</option>
                      <option value="12%">12%</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- FORNECEDOR PARCELEX -->
              <div class="fornecedor-item" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                  <input type="checkbox" name="fornecedor" value="Parcelex" style="width: 20px; height: 20px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'parcelex')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1.1rem;">Parcelex</span>
                </div>
                <div id="config-parcelex" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 15px;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_parcelex" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_parcelex" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Valor da Tarifa</label>
                    <select name="percentual_parcelex" style="width: 100%; padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px;">
                      <option value="0%">0%</option>
                      <option value="1%">1%</option>
                      <option value="2%">2%</option>
                      <option value="3%">3%</option>
                      <option value="4%">4%</option>
                      <option value="5%">5%</option>
                      <option value="6%">6%</option>
                      <option value="7%">7%</option>
                      <option value="8%">8%</option>
                      <option value="9%">9%</option>
                      <option value="10%">10%</option>
                      <option value="11%">11%</option>
                      <option value="12%">12%</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- FORNECEDOR AGORACRED -->
              <div class="fornecedor-item" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                  <input type="checkbox" name="fornecedor" value="Agoracred" style="width: 20px; height: 20px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'agoracred')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1.1rem;">Agoracred</span>
                </div>
                <div id="config-agoracred" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 15px;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_agoracred" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_agoracred" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Valor da Tarifa</label>
                    <select name="percentual_agoracred" style="width: 100%; padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px;">
                      <option value="0%">0%</option>
                      <option value="1%">1%</option>
                      <option value="2%">2%</option>
                      <option value="3%">3%</option>
                      <option value="4%">4%</option>
                      <option value="5%">5%</option>
                      <option value="6%">6%</option>
                      <option value="7%">7%</option>
                      <option value="8%">8%</option>
                      <option value="9%">9%</option>
                      <option value="10%">10%</option>
                      <option value="11%">11%</option>
                      <option value="12%">12%</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- FORNECEDOR AFINZ -->
              <div class="fornecedor-item" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                  <input type="checkbox" name="fornecedor" value="Afinz" style="width: 20px; height: 20px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'afinz')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1.1rem;">Afinz</span>
                </div>
                <div id="config-afinz" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Tipo de Tarifa</label>
                    <div style="display: flex; gap: 15px;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_afinz" value="MDR" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">MDR</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="tarifa_afinz" value="TIS" style="accent-color: var(--primary);">
                        <label style="font-weight: 600;">TIS</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Valor da Tarifa</label>
                    <select name="percentual_afinz" style="width: 100%; padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px;">
                      <option value="0%">0%</option>
                      <option value="1%">1%</option>
                      <option value="2%">2%</option>
                      <option value="3%">3%</option>
                      <option value="4%">4%</option>
                      <option value="5%">5%</option>
                      <option value="6%">6%</option>
                      <option value="7%">7%</option>
                      <option value="8%">8%</option>
                      <option value="9%">9%</option>
                      <option value="10%">10%</option>
                      <option value="11%">11%</option>
                      <option value="12%">12%</option>
                    </select>
                  </div>
                </div>
              </div>

            </div>
          </div>

      <!-- üî• MANTENHA EXATAMENTE ASSIM - S√ì ADICIONE UM ID NO FORM-GROUP -->
<div class="form-group" id="eventoFormGroup">
  <label class="form-label">
    <i class="fas fa-calendar-check"></i>
    Evento
  </label>
  
  <!-- üî• MANTENHA O SELECT ORIGINAL, MAS VAMOS ESCONDER ELE -->
  <select id="evento" class="form-control" style="display: none;">
    <option value="">-- Selecione um evento --</option>
  </select>
  
  <!-- üî• ADICIONE ESTE INPUT DE SEARCH NO MESMO LUGAR -->
  <div style="position: relative;">
    <input type="text" 
           id="inputEventoSearch" 
           class="form-control" 
           placeholder="Digite para buscar evento..."
           oninput="filtrarSugestoesEventoSearch()"
           style="padding-right: 40px;">
    
    <!-- Sugest√µes aparecer√£o aqui -->
    <div class="suggestions-evento" id="suggestionsEventoSearch" style="display: none;">
      <!-- Sugest√µes separadas por situa√ß√£o -->
    </div>
  </div>
</div>

        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-sticky-note"></i>
            Observa√ß√£o
          </label>
          <textarea id="observacoes" class="form-control" rows="3"></textarea>
        </div>
        
        <div class="btn-group">
          <button type="button" class="btn btn-success" onclick="cadastrar()" id="btnCadastrar">
            <i class="fas fa-plus-circle"></i>
            Cadastrar
          </button>
          <button type="button" class="btn btn-warning" onclick="atualizar()" id="btnAtualizar" style="display: none;">
            <i class="fas fa-save"></i>
            Atualizar
          </button>
        </div>
      </div>

    <!-- SE√á√ÉO: TODOS OS CADASTROS -->
<div class="cadastros-container" id="secaoCadastros" style="display: none;">
  <div class="card-header">
    <i class="fas fa-store"></i>
    <h2 class="card-title" id="tituloCadastros">Todos os Cadastros</h2>
    <div class="filtros-container" id="filtrosContainer" style="display: none;">
      <button type="button" class="btn btn-outline btn-sm" onclick="filtrarTabela('all')">
        Todos
      </button>
      <button type="button" class="btn btn-sm" onclick="filtrarTabela('Novo registro')" style="background-color: #bfe1f6; color: #2D3047; border: 1px solid #a1c9e4;">
        Novos
      </button>
      <button type="button" class="btn btn-success btn-sm" onclick="filtrarTabela('Cadastrado')">
        Cadastrados
      </button>
      <button type="button" class="btn btn-warning btn-sm" onclick="filtrarTabela('Em andamento')">
        Em Andamento
      </button>
      <button type="button" class="btn btn-danger btn-sm" onclick="filtrarTabela('N√£o conclu√≠do')">
        N√£o Conclu√≠dos
      </button>
      <button type="button" class="btn btn-secondary btn-sm" onclick="filtrarTabela('Descredenciado')">
        Descredenciados
      </button>
    </div>
  </div>

  <!-- BARRA DE PESQUISA MELHORADA -->
  <div class="form-group" style="margin-bottom: 20px;">
    <div class="search-container">
      <input type="text" id="pesquisaCadastros" class="form-control" 
             placeholder="Pesquisar por nome, CNPJ ou fornecedor..."
             oninput="filtrarPesquisa()">
    </div>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
      <span class="contador-lojas" id="contadorCadastros">0 cadastros</span>
      
      <div style="display: flex; gap: 10px; align-items: center;">
        <select id="ordenacaoCadastros" onchange="ordenarCadastros()" style="padding: 8px 12px; border: 2px solid var(--border); border-radius: 8px;">
          <option value="razao_social">Ordenar por Raz√£o Social</option>
          <option value="nome_fantasia">Ordenar por Nome Fantasia</option>
          <option value="fornecedor">Ordenar por Fornecedor</option>
          <option value="situacao">Ordenar por Situa√ß√£o</option>
        </select>
        
        <button type="button" class="btn btn-info btn-sm" onclick="recarregarCadastros()">
          <i class="fas fa-sync-alt"></i> Atualizar
        </button>
      </div>
    </div>
  </div>

 <!-- üî• FILTRO DE EVENTOS COM SEARCH -->
<div class="filtro-search-container" id="filtroEventoContainer" style="display: none; position: relative;">
  <div style="position: relative; width: 300px;">
    <input type="text" 
           id="inputFiltroEvento" 
           class="form-control" 
           placeholder="Digite o evento para filtrar..."
           oninput="filtrarSugestoesEvento()"
           style="padding-right: 40px;">
    <button type="button" 
            class="btn btn-sm" 
            onclick="limparFiltroEvento()"
            style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: var(--danger); color: white; border: none; border-radius: 4px; padding: 4px 8px; display: none;"
            id="btnLimparFiltro">
      <i class="fas fa-times"></i>
    </button>
  </div>
  
  <div class="suggestions-evento" id="suggestionsEvento" style="display: none;">
    <!-- Sugest√µes aparecer√£o aqui -->
  </div>
  
  <!-- TAGS DE FILTROS ATIVOS -->
  <div id="tagsFiltrosAtivos" style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;"></div>
</div>

  <!-- LOADING -->
  <div class="loading-container" id="loadingCadastros" style="display: none;">
    <div class="loading-spinner"></div>
    <p>Carregando cadastros...</p>
  </div>
  
  <!-- TABELA MELHORADA -->
  <div class="table-container" id="tableContainer" style="display: none;">
    <div class="table-responsive">
      <table class="data-table" id="tabelaCadastros">
        <thead>
          <tr>
            <th>Raz√£o Social</th>
            <th>CNPJ</th>
            <th>Fornecedor</th>
            <th>Mensalidade</th>
            <th>Ades√£o</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabelaCadastrosBody">
          <!-- Dados ser√£o preenchidos via JavaScript -->
        </tbody>
      </table>
    </div>
  </div>
</div>
      
      <!-- MENSAGENS DO SISTEMA -->
      <div id="messageSuccess" class="message success" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <span></span>
      </div>
      
      <div id="messageError" class="message error" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span></span>
      </div>

      <div id="messageInfo" class="message info" style="display: none;">
        <i class="fas fa-info-circle"></i>
        <span></span>
      </div>
    </div>
  </div>

  <!-- üîÑ OVERLAY DE CARREGAMENTO -->
  <div id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner-large"></div>
      <p class="loading-text">Salvando dados...</p>
      <p class="loading-subtext">Aguarde um momento</p>
    </div>
  </div>

  <!-- üî• MODAL DE DETALHES -->
  <div id="modalDetalhes" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">üìã Detalhes Completo do Cadastro</h3>
        <button class="btn-close" onclick="fecharModalDetalhes()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div id="modalDetalhesContent">
        <!-- Conte√∫do ser√° preenchido via JavaScript -->
      </div>
      
      <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border);">
        <button class="btn btn-primary" onclick="fecharModalDetalhes()">
          <i class="fas fa-check"></i> Fechar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Senha - VERS√ÉO CORRIGIDA -->
  <div id="modalSenha" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">üîí Acesso Restrito</h3>
        <button class="btn-close" onclick="fecharModalSenha()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div style="padding: 20px;">
        <p>Para editar este campo √© necess√°rio informar a senha:</p>
        <input type="password" id="inputSenha" class="form-control" placeholder="Digite a senha" style="margin: 15px 0;">
        <div class="btn-group">
          <button class="btn btn-primary" onclick="validarSenha()">
            <i class="fas fa-check"></i> Validar
          </button>
          <button class="btn btn-outline" onclick="fecharModalSenha()">
            <i class="fas fa-times"></i> Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // üî• VARI√ÅVEIS GLOBAIS
    let cadastroAtualId = null;
    let todosCadastros = [];
    let cadastrosFiltrados = [];
    let campoEditavel = null;
    const SENHA_PERMITIDA = '519901';

    // üî• VARI√ÅVEIS DOS EVENTOS PARA FILTRO
const eventosEmAndamento = [
  "Aguardando Aceite da Loja", "Aguardando Aceite do Fornecedor", "Aguardando Documentos",
  "Aguardando retorno", "Agendamento de demonstra√ß√£o", "Cliente interessado", 
  "Cliente n√£o interessado", "Condi√ß√£o Especial", "Contrato assinado", "Desistiu",
  "Documenta√ß√£o Incompleta", "Em Implanta√ß√£o", "Em Treinamento", "Envio de boleto",
  "Envio de WhatsApp", "Follow-up necess√°rio", "Fornecedor alterado", "Liga√ß√£o realizada",
  "Negocia√ß√£o em andamento", "Pagamento Efetuado", "Pagamento Pendente", "Proposta enviada",
  "Quantidade de lojas alterada", "Recado Registrado", "Reuni√£o agendada", "Sem Retorno",
  "Solicitou mais informa√ß√µes", "Telefone alterado"
].sort();

const eventosNaoConcluido = ["Cancelado", "Bloqueado", "Desistiu"].sort();
const eventosCadastrado = ["Loja cadastrada"];

    // ‚úÖ VERIFICAR SE USU√ÅRIO J√Å EST√Å AUTORIZADO AO CARREGAR A P√ÅGINA
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Sistema de Gest√£o de Cadastros - RESULT inicializado');
      
      // Inicializar valores padr√£o
      document.getElementById('mensalidade').value = 'R$ 0,00';
      document.getElementById('situacao').value = 'Cadastrado';
      
      // Configura√ß√µes iniciais
      configurarValidacaoEmTempoReal();
      document.getElementById('situacao').addEventListener('change', atualizarEventos);
      atualizarEventos();
      
      // üî• CORRE√á√ÉO: Configurar prote√ß√£o AP√ìS o DOM estar carregado
      setTimeout(() => {
        configurarCamposProtegidos();
      }, 500);
      
      // Configurar eventos do modal de senha
      configurarModalSenha();
    });

    // üî• C√ìDIGO TEMPOR√ÅRIO PARA DEBUG - TESTAR SE A FUN√á√ÉO √â CHAMADA
function testarAtualizacaoEventos() {
  console.log("üß™ TESTE: Chamando atualizarEventos() manualmente...");
  atualizarEventos();
}

// Testa ap√≥s 2 segundos (para voc√™ ver no console)
setTimeout(testarAtualizacaoEventos, 2000);

    // üî• FUN√á√ïES DO MODAL DE SENHA - CORRIGIDAS
    function configurarModalSenha() {
      // Configurar evento de Enter no input de senha
      const inputSenha = document.getElementById('inputSenha');
      if (inputSenha) {
        inputSenha.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            validarSenha();
          }
        });
      }
      
      // Fechar modal ao clicar fora
      const modalSenha = document.getElementById('modalSenha');
      if (modalSenha) {
        modalSenha.addEventListener('click', function(e) {
          if (e.target === this) {
            fecharModalSenha();
          }
        });
      }
      
      // Fechar modal com ESC
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('modalSenha').style.display === 'flex') {
          fecharModalSenha();
        }
      });
    }

    function solicitarSenha(campo) {
      campoEditavel = campo;
      
      // Mostrar modal
      document.getElementById('modalSenha').style.display = 'flex';
      
      // Limpar e focar no input
      const inputSenha = document.getElementById('inputSenha');
      if (inputSenha) {
        inputSenha.value = '';
        inputSenha.focus();
      }
    }

    function validarSenha() {
      const inputSenha = document.getElementById('inputSenha');
      if (!inputSenha) {
        console.log("‚ùå inputSenha n√£o encontrado");
        return;
      }
      
      const senha = inputSenha.value;
      console.log("üîê Validando senha:", senha);
      console.log("üîê Compara√ß√£o com '519901':", senha === '519901');
      
      if (senha === SENHA_PERMITIDA) {
        console.log("‚úÖ SENHA CORRETA - Iniciando libera√ß√£o de campos");
        fecharModalSenha();
        
        // Atualizar localStorage
        localStorage.setItem('usuarioAutorizado', 'true');
        console.log("üíæ localStorage atualizado");
        
        // Liberar TODOS os campos protegidos
        liberarTodosCamposProtegidos();
        
        showMessage('success', '‚úÖ Todos os campos foram liberados para edi√ß√£o!');
        
      } else {
        console.log("‚ùå SENHA INCORRETA");
        showMessage('error', '‚ùå Senha incorreta!');
        inputSenha.value = '';
        inputSenha.focus();
      }
    }

    function fecharModalSenha() {
      document.getElementById('modalSenha').style.display = 'none';
      campoEditavel = null;
    }

    // üî• FUN√á√ÉO PARA LIBERAR TODOS OS CAMPOS PROTEGIDOS - CORRIGIDA
    function liberarTodosCamposProtegidos() {
      console.log("üîì LIBERANDO TODOS OS CAMPOS...");
      
      // Liberar campos principais
      const camposProtegidos = [
        'razao_social', 'nome_fantasia', 'cnpj_cadastro', 'tipo', 
        'mensalidade', 'adesao', 'situacao', 'data_status',
        'contrato_enviado', 'contrato_assinado', 'ativacao', 'link'
      ];
      
      camposProtegidos.forEach(id => {
        const campo = document.getElementById(id);
        if (campo) {
          console.log(`üîì Liberando: ${id}`);
          
          // üî• CORRE√á√ÉO: Remover completamente o elemento e criar um novo
          const novoCampo = campo.cloneNode(true);
          novoCampo.removeAttribute('readonly');
          novoCampo.disabled = false;
          novoCampo.style.backgroundColor = '';
          novoCampo.style.cursor = 'text';
          novoCampo.style.opacity = '1';
          
          // üî• CORRE√á√ÉO CR√çTICA: Remover event listeners de prote√ß√£o
          novoCampo.onfocus = null;
          novoCampo.onclick = null;
          
          // Substituir o campo antigo pelo novo
          campo.parentNode.replaceChild(novoCampo, campo);
          
          console.log(`‚úÖ ${id} liberado completamente`);
        }
      });
      
      // Liberar campos dos fornecedores - CORRE√á√ÉO COMPLETA
      console.log("üîì Liberando campos dos fornecedores...");
      const camposFornecedor = document.querySelectorAll(`
        input[name="fornecedor"], 
        input[name^="tarifa_"], 
        select[name^="percentual_"]
      `);
      
      camposFornecedor.forEach(campo => {
        // Clonar e substituir completamente
        const novoCampo = campo.cloneNode(true);
        novoCampo.disabled = false;
        novoCampo.style.cursor = '';
        novoCampo.style.opacity = '1';
        novoCampo.style.backgroundColor = '';
        
        // üî• REMOVER todos os event listeners
        novoCampo.onclick = null;
        novoCampo.onfocus = null;
        novoCampo.onmousedown = null;
        
        campo.parentNode.replaceChild(novoCampo, campo);
      });
      
      console.log("üéØ TODOS OS CAMPOS FORAM LIBERADOS COM SUCESSO!");
    }

    // üî• FUN√á√ÉO PRINCIPAL PARA CONFIGURAR PROTE√á√ÉO
    function configurarCamposProtegidos() {
      console.log("üéØ CONFIGURAR CAMPOS PROTEGIDOS - INICIANDO PROTEC√á√ÉO FOR√áADA");
      
      // üî• FOR√áAR: Ignorar localStorage e SEMPRE proteger inicialmente
      console.log("üîí PROTEC√á√ÉO FOR√áADA: Ignorando localStorage");
      
      const camposProtegidos = [
        'razao_social', 'nome_fantasia', 'cnpj_cadastro', 'tipo', 
        'mensalidade', 'adesao', 'situacao', 'data_status',
        'contrato_enviado', 'contrato_assinado', 'ativacao', 'link'
      ];
      
      console.log("üîí Protegendo campos principais...");
      
      // Proteger campos principais - FOR√áADO
      camposProtegidos.forEach(id => {
        const campo = document.getElementById(id);
        if (campo) {
          console.log(`üîí Protegendo: ${id}`);
          campo.setAttribute('readonly', 'true');
          campo.disabled = false; // Garantir que n√£o est√° disabled
          campo.style.backgroundColor = '#f8f9fa';
          campo.style.cursor = 'not-allowed';
          campo.style.opacity = '1';
          
          // Remover qualquer event listener anterior
          const novoCampo = campo.cloneNode(true);
          campo.parentNode.replaceChild(novoCampo, campo);
          
          // Adicionar novo event listener
          document.getElementById(id).addEventListener('focus', function(e) {
            e.preventDefault();
            console.log(`üîì Campo ${id} solicitando senha`);
            solicitarSenha(this);
          });
        }
      });
      
      // Proteger campos dos fornecedores - FOR√áADO
      console.log("üîí Protegendo campos dos fornecedores...");
      const camposFornecedor = document.querySelectorAll(`
        input[name="fornecedor"], 
        input[name^="tarifa_"], 
        select[name^="percentual_"]
      `);
      
      camposFornecedor.forEach(campo => {
        campo.disabled = true;
        campo.style.cursor = 'not-allowed';
        campo.style.opacity = '0.6';
        
        // Clonar e substituir para limpar event listeners
        const novoCampo = campo.cloneNode(true);
        campo.parentNode.replaceChild(novoCampo, campo);
        
        // Re-aplicar event listeners
        if (campo.type === 'checkbox' || campo.type === 'radio') {
          novoCampo.addEventListener('click', function(e) {
            e.preventDefault();
            solicitarSenha(this);
          });
        } else {
          novoCampo.addEventListener('focus', function(e) {
            e.preventDefault();
            solicitarSenha(this);
          });
        }
      });
      
      // Campos liberados (n√£o proteger)
      console.log("‚úÖ Liberando campos permitidos...");
      const camposLiberados = ['evento', 'observacoes'];
      camposLiberados.forEach(id => {
        const campo = document.getElementById(id);
        if (campo) {
          campo.removeAttribute('readonly');
          campo.disabled = false;
          campo.style.backgroundColor = '';
          campo.style.cursor = 'text';
          campo.style.opacity = '1';
        }
      });
      
      console.log("üéØ PROTEC√á√ÉO FOR√áADA FINALIZADA - Campos devem estar BLOQUEADOS");
    }

    // üî• FUN√á√ÉO TEMPOR√ÅRIA PARA TESTAR ENVIO DO FORMUL√ÅRIO
    function testarEnvioFormulario() {
      console.log("üß™ TESTANDO ENVIO DO FORMUL√ÅRIO...");
      
      // Coletar dados do formul√°rio normalmente (a mesma fun√ß√£o que o cadastrar usa)
      const dados = coletarDadosFormulario();
      
      console.log("üì§ Dados coletados para envio:", dados);
      console.log("üî¢ Fornecedores coletados:", dados.fornecedores);
      
      if (!dados.fornecedores || dados.fornecedores.length === 0) {
        alert("‚ùå Nenhum fornecedor selecionado! Selecione pelo menos um.");
        return;
      }
      
      // Enviar para debug no GS
      google.script.run
        .withSuccessHandler(function(res) {
          console.log("‚úÖ RESPOSTA DO DEBUG:", res);
          alert(`DEBUG CONCLU√çDO:\n\n‚Ä¢ Fornecedores enviados: ${res.quantidadeFornecedores}\n‚Ä¢ Estrutura: ${JSON.stringify(res.estruturaFornecedores, null, 2)}\n\nVerifique o console do GS para detalhes completos.`);
        })
        .withFailureHandler(function(error) {
          console.error("‚ùå ERRO NO DEBUG:", error);
          alert("Erro no debug: " + error.message);
        })
        .debugFormulario(dados);
    }

    function formatarCNPJ(input) {
      // Salva a posi√ß√£o do cursor
      const cursorPos = input.selectionStart;
      
      let value = input.value.replace(/\D/g, '');
      
      // Aplica a formata√ß√£o
      if (value.length > 12) {
        value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
      } else if (value.length > 8) {
        value = value.replace(/^(\d{2})(\d{3})(\d{3})/, '$1.$2.$3/');
      } else if (value.length > 5) {
        value = value.replace(/^(\d{2})(\d{3})/, '$1.$2.');
      } else if (value.length > 2) {
        value = value.replace(/^(\d{2})/, '$1.');
      }
      
      input.value = value;
      
      // Restaura a posi√ß√£o do cursor
      input.setSelectionRange(cursorPos, cursorPos);
    }

    function formatarMoeda(input) {
      let value = input.value.replace(/\D/g, '');
      value = (value / 100).toFixed(2);
      value = value.replace('.', ',');
      value = value.replace(/(\d)(?=(\d{3})+\,)/g, "$1.");
      input.value = 'R$ ' + value;
    }

    function formatarMoedaParaInput(valor) {
      if (!valor) return 'R$ 0,00';
      const numero = typeof valor === 'number' ? valor : parseFloat(valor);
      return 'R$ ' + numero.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
    }

    function showMessage(type, text) {
      const successEl = document.getElementById('messageSuccess');
      const errorEl = document.getElementById('messageError');
      const infoEl = document.getElementById('messageInfo');

      successEl.style.display = 'none';
      errorEl.style.display = 'none';
      infoEl.style.display = 'none';

      if (type === 'success') {
        successEl.querySelector('span').textContent = text;
        successEl.style.display = 'flex';
      } else if (type === 'error') {
        errorEl.querySelector('span').textContent = text;
        errorEl.style.display = 'flex';
      } else if (type === 'info') {
        infoEl.querySelector('span').textContent = text;
        infoEl.style.display = 'flex';
      }

      setTimeout(() => {
        successEl.style.display = 'none';
        errorEl.style.display = 'none';
        infoEl.style.display = 'none';
      }, 5000);
    }

    function toggleFornecedorConfig(checkbox, fornecedorId) {
      const configDiv = document.getElementById(`config-${fornecedorId}`);
      
      if (checkbox.checked) {
        configDiv.style.display = 'grid';
      } else {
        configDiv.style.display = 'none';
        // Limpar sele√ß√µes quando desmarcar
        const radios = configDiv.querySelectorAll('input[type="radio"]');
        radios.forEach(radio => radio.checked = false);
        const select = configDiv.querySelector('select');
        if (select) select.value = '0%';
      }
      
      // üî• NOVO: Atualizar tarifa principal quando mudar sele√ß√£o
      atualizarTarifaPrincipal();
    }

    // üî• ADICIONAR: Fun√ß√£o para atualizar tarifa principal
    function atualizarTarifaPrincipal() {
      const checkboxesFornecedores = document.querySelectorAll('input[name="fornecedor"]:checked');
      if (checkboxesFornecedores.length > 0) {
        const primeiroFornecedor = checkboxesFornecedores[0].value.toLowerCase();
        // As tarifas ser√£o coletadas na fun√ß√£o coletarDadosFormulario
      }
    }

    function converterMoedaParaNumero(valorMoeda) {
      if (!valorMoeda) return 0;
      try {
        if (typeof valorMoeda === 'number') return valorMoeda;
        if (typeof valorMoeda === 'string') {
          const valorLimpo = valorMoeda
            .replace('R$', '')
            .replace(/\./g, '')
            .replace(',', '.')
            .trim();
          const numero = parseFloat(valorLimpo);
          return isNaN(numero) ? 0 : numero;
        }
        return parseFloat(valorMoeda) || 0;
      } catch (error) {
        console.error("‚ùå Erro ao converter moeda:", valorMoeda, error);
        return 0;
      }
    }

// üî•üî•üî• CORRE√á√ÉO CR√çTICA - FUN√á√ÉO COLETAR DADOS COMPLETA E CORRIGIDA
function coletarDadosFormulario() {
  console.log("üîç COLETANDO DADOS - INICIANDO");
  
  try {
    // ‚úÖ VALIDA√á√ÉO B√ÅSICA DOS CAMPOS PRINCIPAIS
    const razaoSocial = document.getElementById('razao_social').value.trim();
    const cnpj = document.getElementById('cnpj_cadastro').value.trim();
    
    if (!razaoSocial || !cnpj) {
      showMessage('error', '‚ùå Raz√£o Social e CNPJ s√£o obrigat√≥rios!');
      return null;
    }

    // ‚úÖ GARANTIR QUE O CNPJ MANTENHA A M√ÅSCARA
    const cnpjInput = document.getElementById('cnpj_cadastro');
    const cnpjFormatado = cnpjInput.value;

    // ‚úÖ Processar ades√£o
    let adesaoValue = document.getElementById('adesao').value;
    if (adesaoValue === 'R$ 0,00' || adesaoValue === '0,00' || adesaoValue === '0') {
      adesaoValue = 0;
    } else {
      adesaoValue = converterMoedaParaNumero(adesaoValue);
    }

    // ‚úÖ CORRE√á√ÉO CR√çTICA: Coletar TODOS os fornecedores COM VALIDA√á√ÉO
    const checkboxesFornecedores = document.querySelectorAll('input[name="fornecedor"]:checked');
    const fornecedoresComConfiguracoes = [];

    if (checkboxesFornecedores.length === 0) {
      showMessage('error', '‚ùå Selecione pelo menos um fornecedor!');
      return null;
    }

    checkboxesFornecedores.forEach(checkbox => {
      const fornecedorNome = checkbox.value;
      const fornecedorId = fornecedorNome.toLowerCase();
      
      // Verificar se tem configura√ß√£o ativa
      const configDiv = document.getElementById(`config-${fornecedorId}`);
      if (!configDiv || configDiv.style.display !== 'grid') {
        console.warn(`‚ùå Fornecedor ${fornecedorNome} n√£o tem configura√ß√£o ativa!`);
        return;
      }
      
      // Coletar configura√ß√µes de tarifa
      const tarifaRadio = document.querySelector(`input[name="tarifa_${fornecedorId}"]:checked`);
      const percentualSelect = document.querySelector(`select[name="percentual_${fornecedorId}"]`);
      
      // üî• CORRE√á√ÉO: Se n√£o tem tarifa selecionada, seleciona MDR automaticamente
      let tarifaSelecionada = tarifaRadio ? tarifaRadio.value : 'MDR';
      let percentualSelecionado = percentualSelect ? percentualSelect.value : '0%';
      
      // Se n√£o tinha tarifa selecionada, seleciona MDR agora
      if (!tarifaRadio) {
        const radioMDR = document.querySelector(`input[name="tarifa_${fornecedorId}"][value="MDR"]`);
        if (radioMDR) {
          radioMDR.checked = true;
          console.log(`‚úÖ MDR selecionado automaticamente para ${fornecedorNome}`);
        }
      }
      
      // Adiciona aos dados
      fornecedoresComConfiguracoes.push({
        nome: fornecedorNome,
        tarifa: tarifaSelecionada,
        percentual_tarifa: percentualSelecionado
      });
    });

    // ‚úÖ MONTAR OBJETO DE DADOS CORRETAMENTE
    const dados = {
      razao_social: razaoSocial,
      nome_fantasia: document.getElementById('nome_fantasia').value,
      cnpj: cnpjFormatado,
      tipo: document.getElementById('tipo').value,
      adesao: adesaoValue,
      fornecedores: fornecedoresComConfiguracoes,
      fornecedor: fornecedoresComConfiguracoes.length > 0 ? fornecedoresComConfiguracoes[0].nome : '',
      tarifa: fornecedoresComConfiguracoes.length > 0 ? fornecedoresComConfiguracoes[0].tarifa : '',
      percentual_tarifa: fornecedoresComConfiguracoes.length > 0 ? fornecedoresComConfiguracoes[0].percentual_tarifa : '0%',
      data_status: document.getElementById('data_status').value,
      observacoes: document.getElementById('observacoes').value,
      contrato_enviado: document.getElementById('contrato_enviado').value,
      contrato_assinado: document.getElementById('contrato_assinado').value,
      ativacao: document.getElementById('ativacao').value,
      link: document.getElementById('link').value,
      mensalidade: converterMoedaParaNumero(document.getElementById('mensalidade').value),
      situacao: document.getElementById('situacao').value,
      evento: document.getElementById('inputEventoSearch').value || document.getElementById('evento').value
    };

    console.log("üì¶ DADOS FINAIS PARA ENVIO:", dados);
    return dados;

  } catch (error) {
    console.error("‚ùå ERRO CR√çTICO ao coletar dados:", error);
    showMessage('error', '‚ùå Erro interno ao processar formul√°rio');
    return null;
  }
}

// üî•üî•üî• CORRE√á√ÉO DA VALIDA√á√ÉO DE CAMPOS OBRIGAT√ìRIOS
function validarCamposObrigatorios() {
  console.log("üîç Validando campos obrigat√≥rios...");
  
  // Remover destaque anterior
  document.querySelectorAll('.campo-obrigatorio').forEach(campo => {
    campo.classList.remove('campo-obrigatorio');
  });

  let camposInvalidos = [];

  // ‚úÖ CORRE√á√ÉO DEFINITIVA: Na ATUALIZA√á√ÉO, s√≥ validar campos CR√çTICOS
  const isAtualizacao = cadastroAtualId !== null;
  
  console.log("üîç Modo:", isAtualizacao ? "ATUALIZA√á√ÉO" : "CADASTRO");

  // ‚úÖ CAMPOS SEMPRE OBRIGAT√ìRIOS (em ambos os modos)
  const camposSempreObrigatorios = [
    { 
      id: 'razao_social', 
      nome: 'Raz√£o Social', 
      elemento: document.getElementById('razao_social'),
      tipo: 'text'
    },
    { 
      id: 'cnpj_cadastro', 
      nome: 'CNPJ', 
      elemento: document.getElementById('cnpj_cadastro'),
      tipo: 'text'
    },
    { 
      id: 'tipo', 
      nome: 'Tipo', 
      elemento: document.getElementById('tipo'),
      tipo: 'select'
    },
    { 
      id: 'mensalidade', 
      nome: 'Mensalidade', 
      elemento: document.getElementById('mensalidade'),
      tipo: 'moeda'
    },
    { 
      id: 'situacao', 
      nome: 'Situa√ß√£o', 
      elemento: document.getElementById('situacao'),
      tipo: 'select'
    }
  ];

  // ‚úÖ CAMPOS OBRIGAT√ìRIOS APENAS NO CADASTRO (N√ÉO na atualiza√ß√£o)
  const camposApenasCadastro = [
    { 
      id: 'contrato_enviado', 
      nome: 'Contrato Enviado', 
      elemento: document.getElementById('contrato_enviado'),
      tipo: 'select'
    },
    { 
      id: 'contrato_assinado', 
      nome: 'Contrato Assinado', 
      elemento: document.getElementById('contrato_assinado'),
      tipo: 'select'
    }
  ];

  // Juntar os campos a validar
  let camposParaValidar = [...camposSempreObrigatorios];
  
  // ‚úÖ CORRE√á√ÉO: S√≥ adicionar campos de contrato se for NOVO CADASTRO
  if (!isAtualizacao) {
    camposParaValidar = [...camposParaValidar, ...camposApenasCadastro];
  }

  // Validar cada campo
  for (const campo of camposParaValidar) {
    let valor = campo.elemento.value;
    let estaVazio = false;

    switch(campo.tipo) {
      case 'select':
        estaVazio = !valor || valor === '' || valor === '-- Selecione --';
        break;
      case 'moeda':
        estaVazio = !valor || valor === 'R$ 0,00' || valor === '0,00';
        break;
      default:
        estaVazio = !valor || valor.toString().trim() === '';
    }

    if (estaVazio) {
      campo.elemento.classList.add('campo-obrigatorio');
      camposInvalidos.push(campo.nome);
      
      // Scroll para o primeiro campo inv√°lido
      if (camposInvalidos.length === 1) {
        campo.elemento.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  }

  console.log(`üìä Valida√ß√£o: ${camposInvalidos.length} campos inv√°lidos`);
  console.log(`üîç Campos inv√°lidos:`, camposInvalidos);
  return camposInvalidos;
}

// üî•üî•üî• CORRE√á√ÉO DA FUN√á√ÉO ATUALIZAR - AGORA FUNCIONA!
function atualizar() {
  console.log("üéØ ATUALIZAR: Iniciando atualiza√ß√£o...");
  
  // ‚úÖ DEBUG 1: Verificar se tem ID
  console.log("üîç DEBUG 1: cadastroAtualId =", cadastroAtualId);
  
  if (!cadastroAtualId) {
    showMessage('error', '‚ùå Nenhum cadastro selecionado para atualizar!');
    return;
  }

  // ‚úÖ VALIDA√á√ÉO DE CAMPOS OBRIGAT√ìRIOS
  const camposInvalidos = validarCamposObrigatorios();
  console.log("üîç DEBUG 2: Campos inv√°lidos:", camposInvalidos);
  
  if (camposInvalidos.length > 0) {
    showMessage('error', `‚ùå Preencha os campos obrigat√≥rios: ${camposInvalidos.join(', ')}`);
    return;
  }

  // ‚úÖ VALIDA√á√ÉO DE FORNECEDORES
  const fornecedoresSelecionados = document.querySelectorAll('input[name="fornecedor"]:checked');
  console.log("üîç DEBUG 3: Fornecedores selecionados:", fornecedoresSelecionados.length);
  
  if (fornecedoresSelecionados.length === 0) {
    showMessage('error', '‚ùå Selecione pelo menos um fornecedor!');
    return;
  }

  // Coletar dados
  console.log("üîç DEBUG 4: Chamando coletarDadosFormulario()...");
  const dados = coletarDadosFormulario();
  console.log("üîç DEBUG 5: Dados coletados:", dados);
  
  if (!dados) {
    showMessage('error', '‚ùå Erro ao coletar dados do formul√°rio');
    return;
  }
  
  dados.acao = 'atualizar';
  dados.id = cadastroAtualId;
  
  console.log("üì§ Dados para atualiza√ß√£o:", dados);

  // Mostrar loading
  showLoading(`Atualizando ${dados.fornecedores.length} fornecedor(es)...`, `Loja: ${dados.razao_social}`);

  const btnAtualizar = document.getElementById('btnAtualizar');
  const btnOriginalHTML = btnAtualizar.innerHTML;
  btnAtualizar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
  btnAtualizar.disabled = true;

  console.log("üîç DEBUG 6: Chamando Google Apps Script...");

  // ‚úÖ CORRE√á√ÉO CR√çTICA: Usar processarCadastro que j√° funciona
  google.script.run
    .withSuccessHandler(function(res) {
      console.log("‚úÖ DEBUG 7: Resposta da atualiza√ß√£o:", res);
      hideLoading();
      
      btnAtualizar.innerHTML = btnOriginalHTML;
      btnAtualizar.disabled = false;
      
      if (res && res.success) {
        showMessage('success', '‚úÖ ' + res.message);
        
        // Atualizar a lista de cadastros se estiver vis√≠vel
        if (document.getElementById('secaoCadastros').style.display === 'block') {
          mostrarTodosCadastros();
        }
        
        // Voltar para modo cadastro
        limparFormulario();
      } else {
        showMessage('error', '‚ùå ' + (res ? res.message : 'Resposta inv√°lida do servidor'));
      }
    })
    .withFailureHandler(function(error) {
      console.error("‚ùå DEBUG 8: Erro na atualiza√ß√£o:", error);
      hideLoading();
      
      btnAtualizar.innerHTML = btnOriginalHTML;
      btnAtualizar.disabled = false;
      showMessage('error', '‚ùå Erro ao atualizar: ' + error.message);
    })
    .processarCadastro(dados); // ‚úÖ USAR processarCadastro QUE J√Å FUNCIONA
}

// üî•üî•üî• CORRE√á√ÉO DA FUN√á√ÉO CADASTRAR - MULTIPLOS FORNECEDORES FUNCIONANDO!
function cadastrar() {
  console.log("üéØ CADASTRAR: Iniciando cadastro MULTIPLOS FORNECEDORES");
  
  // ‚úÖ VALIDA√á√ÉO DE CAMPOS OBRIGAT√ìRIOS
  const camposInvalidos = validarCamposObrigatorios();
  if (camposInvalidos.length > 0) {
    showMessage('error', `‚ùå Preencha os campos obrigat√≥rios: ${camposInvalidos.join(', ')}`);
    return;
  }

  // ‚úÖ VALIDA√á√ÉO DE FORNECEDORES
  const fornecedoresSelecionados = document.querySelectorAll('input[name="fornecedor"]:checked');
  if (fornecedoresSelecionados.length === 0) {
    showMessage('error', '‚ùå Selecione pelo menos um fornecedor!');
    return;
  }

  // Coletar dados BASE (comuns a todos os fornecedores)
  const dadosBase = coletarDadosFormulario();
  if (!dadosBase) {
    showMessage('error', '‚ùå Erro ao coletar dados do formul√°rio');
    return;
  }

  console.log("üî¢ Fornecedores selecionados:", dadosBase.fornecedores.length);
  console.log("üìã Lista de fornecedores:", dadosBase.fornecedores);

  // ‚úÖ CORRE√á√ÉO CR√çTICA: Para CADASTRO, evento √© FIXO "Novo cadastro"
  dadosBase.evento = "Novo cadastro";
  dadosBase.acao = 'cadastrar';

  // Mostrar loading
  showLoading(`Cadastrando ${dadosBase.fornecedores.length} fornecedor(es)...`, `Loja: ${dadosBase.razao_social}`);

  const btnCadastrar = document.getElementById('btnCadastrar');
  btnCadastrar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cadastrando...';
  btnCadastrar.disabled = true;

  // ‚úÖ ENVIAR para Google Apps Script - CADA FORNECEDOR VIRA UM REGISTRO
  google.script.run
    .withSuccessHandler(function(res) {
      console.log("‚úÖ Resposta do cadastro MULTIPLO:", res);
      hideLoading();
      
      btnCadastrar.innerHTML = '<i class="fas fa-plus-circle"></i> Cadastrar';
      btnCadastrar.disabled = false;
      
      if (res.success) {
        showMessage('success', `‚úÖ ${res.message} - ${res.registrosCriados} registro(s) criado(s)`);
        limparFormulario();
      } else {
        showMessage('error', '‚ùå ' + res.message);
      }
    })
    .withFailureHandler(function(error) {
      console.error("‚ùå Erro no cadastro:", error);
      hideLoading();
      
      btnCadastrar.innerHTML = '<i class="fas fa-plus-circle"></i> Cadastrar';
      btnCadastrar.disabled = false;
      showMessage('error', '‚ùå Erro: ' + error.message);
    })
    .salvarCadastro(dadosBase);
}

    function mostrarPopupResultado(mensagemPrincipal, detalhes) {
      // Usar o modal de detalhes TEMPORARIAMENTE
      const modal = document.getElementById('modalDetalhes');
      const content = document.getElementById('modalDetalhesContent');
      
      let detalhesHTML = '';
      if (detalhes && Array.isArray(detalhes)) {
        detalhesHTML = `
          <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="color: var(--primary); margin-bottom: 10px;">üìã Detalhes do Cadastro:</h4>
            <div style="max-height: 200px; overflow-y: auto;">
              ${detalhes.map(detalhe => `
                <div style="padding: 5px 0; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; gap: 8px;">
                  ${detalhe.includes('‚úÖ') ? 
                    '<span style="color: var(--success);">‚úÖ</span>' : 
                    '<span style="color: var(--danger);">‚ùå</span>'
                  }
                  <span>${detalhe.replace('‚úÖ', '').replace('‚ùå', '')}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      content.innerHTML = `
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 4rem; color: var(--success); margin-bottom: 15px;">‚úÖ</div>
          <h3 style="color: var(--success); margin-bottom: 15px;">Cadastro Realizado!</h3>
          <p style="font-size: 1.1rem; margin-bottom: 20px; line-height: 1.4;">${mensagemPrincipal}</p>
          ${detalhesHTML}
          <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border);">
            <button class="btn btn-success" onclick="fecharModalDetalhes()">
              <i class="fas fa-check"></i> Continuar
            </button>
          </div>
        </div>
      `;
      
      modal.style.display = 'flex';
    }

function limparFormulario() {
  document.getElementById('razao_social').value = '';
  document.getElementById('nome_fantasia').value = '';
  document.getElementById('cnpj_cadastro').value = '';
  document.getElementById('tipo').value = '';
  
  // üî• CORRE√á√ÉO: Limpar checkboxes E configura√ß√µes de fornecedor
  const checkboxes = document.querySelectorAll('input[name="fornecedor"]');
  checkboxes.forEach(cb => {
    cb.checked = false;
    const fornecedorId = cb.getAttribute('onchange').split("'")[1];
    const configDiv = document.getElementById(`config-${fornecedorId}`);
    if (configDiv) {
      configDiv.style.display = 'none';
      // Limpar sele√ß√µes dentro da configura√ß√£o
      const radios = configDiv.querySelectorAll('input[type="radio"]');
      radios.forEach(radio => radio.checked = false);
      const select = configDiv.querySelector('select');
      if (select) select.value = '0%';
    }
  });
  
  document.getElementById('data_status').value = '';
  document.getElementById('observacoes').value = '';
  document.getElementById('contrato_enviado').value = '';
  document.getElementById('contrato_assinado').value = '';
  document.getElementById('ativacao').value = '';
  document.getElementById('link').value = '';
  document.getElementById('mensalidade').value = 'R$ 0,00';
  
  // üî• CORRE√á√ÉO: Resetar situa√ß√£o para "Novo registro" e ades√£o para "R$ 0,00"
  document.getElementById('situacao').value = 'Novo registro';
  document.getElementById('adesao').value = 'R$ 0,00';
  
  // üî•üî•üî• ADICIONE ESTAS 3 LINHAS AQUI - LIMPAR EVENTO SEARCH
  document.getElementById('inputEventoSearch').value = '';
  document.getElementById('evento').value = '';
  document.getElementById('suggestionsEventoSearch').style.display = 'none';
  
  // üî• CORRE√á√ÉO: Atualizar eventos baseado na nova situa√ß√£o
  atualizarEventos();
  
  document.getElementById('btnCadastrar').style.display = 'block';
  document.getElementById('btnAtualizar').style.display = 'none';
  cadastroAtualId = null;
  
  // üî• CORRE√á√ÉO: Remover destaque de campos obrigat√≥rios
  document.querySelectorAll('.campo-obrigatorio').forEach(campo => {
    campo.classList.remove('campo-obrigatorio');
    campo.style.borderColor = '';
    campo.style.backgroundColor = '';
  });
}

    
function filtrarTabela(situacao) {
  // Remover classe active de todos os bot√µes
  document.querySelectorAll('.filtros-container .btn').forEach(btn => {
    btn.classList.remove('active');
    btn.style.backgroundColor = '';
    btn.style.color = '';
  });
  
  // Adicionar classe active ao bot√£o clicado
  const botaoClicado = event.target;
  botaoClicado.classList.add('active');
  
  // Destacar visualmente o bot√£o ativo
  if (situacao === 'all') {
    botaoClicado.style.backgroundColor = 'var(--primary)';
    botaoClicado.style.color = 'white';
  }

  configurarFiltroEvento(situacao);
  
  let cadastrosFiltradosTemp = todosCadastros;
  let titulo = 'Todos os Cadastros';

  if (situacao !== 'all') {
    // ‚úÖ CORRE√á√ÉO: Filtrar pela situa√ß√£o correta
    cadastrosFiltradosTemp = todosCadastros.filter(cad => cad.situacao === situacao);
    titulo = `Cadastros - ${situacao}`;
  }

  // ‚úÖ CORRE√á√ÉO: SEMPRE AGRUPAR OS CADASTROS POR CNPJ
  cadastrosFiltrados = cadastrosFiltradosTemp;
  
  // ‚úÖ CORRE√á√ÉO: Usar a fun√ß√£o de exibi√ß√£o agrupada
  const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosFiltradosTemp);
  exibirTabelaCadastrosAgrupada(cadastrosAgrupados, titulo);
}

    function mostrarTodosCadastros() {
  console.log("üéØ Iniciando carregamento de cadastros...");
  
  // üîÑ MOSTRAR LOADING
  showLoading("Carregando cadastros...", "Buscando todos os registros");
  
  // Mostrar loading da tabela tamb√©m
  const loading = document.getElementById('loadingCadastros');
  const tableContainer = document.getElementById('tableContainer');
  const filtrosContainer = document.getElementById('filtrosContainer');
  const secao = document.getElementById('secaoCadastros');

  loading.style.display = 'flex';
  tableContainer.style.display = 'none';
  filtrosContainer.style.display = 'none';
  secao.style.display = 'block';

  google.script.run
    .withSuccessHandler(function(cadastros) {
      // üîÑ ESCONDER LOADING
      hideLoading();
      
      console.log("‚úÖ Cadastros recebidos:", cadastros);
      
      if (cadastros && cadastros.length > 0) {
        // ‚úÖ ORDENAR POR NOME AUTOMATICAMENTE
        const cadastrosOrdenados = cadastros.sort((a, b) => {
          const nomeA = (a.razao_social || '').toLowerCase();
          const nomeB = (b.razao_social || '').toLowerCase();
          return nomeA.localeCompare(nomeB);
        });
        
        todosCadastros = cadastrosOrdenados;
        cadastrosFiltrados = [...cadastrosOrdenados];
        
        // ‚úÖ CORRE√á√ÉO: Usar a fun√ß√£o agrupada
        const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosOrdenados);
        exibirTabelaCadastrosAgrupada(cadastrosAgrupados, 'Todos os Cadastros');
        
        document.getElementById('filtrosContainer').style.display = 'flex';
        configurarFiltroEvento('all'); // ‚úÖ MOSTRAR FILTRO DE EVENTOS
        
        showMessage('success', `‚úÖ ${cadastros.length} cadastros carregados com sucesso!`);
      } else {
        loading.style.display = 'none';
        tableContainer.style.display = 'block';
        document.getElementById('tabelaCadastrosBody').innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 40px;">
              <i class="fas fa-inbox" style="font-size: 3rem; color: var(--gray); margin-bottom: 15px;"></i>
              <h3>Nenhum cadastro encontrado</h3>
              <p>N√£o h√° cadastros na base de dados.</p>
            </td>
          </tr>
        `;
        showMessage('info', 'üìù Nenhum cadastro encontrado na base de dados.');
      }
    })
    .withFailureHandler(function(error) {
      // üîÑ ESCONDER LOADING EM CASO DE ERRO
      hideLoading();
      
      console.error("‚ùå Erro ao carregar cadastros:", error);
      loading.style.display = 'none';
      showMessage('error', '‚ùå Erro ao carregar cadastros: ' + error.message);
    })
    .buscarTodosCadastros();
}

    function limparDados() {
      limparFormulario();
      showMessage('info', 'Formul√°rio limpo! Pronto para novo cadastro.');
    }

    function buscarPorCNPJ() {
      // üî• CORRE√á√ÉO: Pegar CNPJ do campo de busca e remover formata√ß√£o
      const cnpjBusca = document.getElementById('cnpj').value.replace(/\D/g, '');
      
      if (!cnpjBusca) {
        showMessage('error', 'Digite um CNPJ para buscar');
        return;
      }

      showMessage('info', 'üîç Buscando cadastro...');

      google.script.run
        .withSuccessHandler(function(dados) {
          preencherDadosCadastro(dados);
        })
        .withFailureHandler(function(error) {
          showMessage('error', 'Erro: ' + error.message);
        })
        .buscarCadastroPorCNPJ(cnpjBusca); // ‚úÖ Envia apenas n√∫meros
    }

    function preencherFornecedorComTarifas(dados) {
  console.log("üîß Preenchendo fornecedor com tarifas:", dados);
  
  // Limpar sele√ß√µes anteriores
  const checkboxes = document.querySelectorAll('input[name="fornecedor"]');
  checkboxes.forEach(cb => {
    cb.checked = false;
    const fornecedorId = cb.value.toLowerCase();
    const configDiv = document.getElementById(`config-${fornecedorId}`);
    if (configDiv) {
      configDiv.style.display = 'none';
      const radios = configDiv.querySelectorAll('input[type="radio"]');
      radios.forEach(radio => radio.checked = false);
      const select = configDiv.querySelector('select');
      if (select) select.value = '0%';
    }
  });
  
  if (!dados.fornecedor) {
    console.log("‚ÑπÔ∏è Nenhum fornecedor para preencher");
    return;
  }
  
  // Encontrar o checkbox do fornecedor
  const checkbox = document.querySelector(`input[name="fornecedor"][value="${dados.fornecedor}"]`);
  if (checkbox) {
    checkbox.checked = true;
    
    // Ativar configura√ß√µes do fornecedor
    const fornecedorId = dados.fornecedor.toLowerCase();
    const configDiv = document.getElementById(`config-${fornecedorId}`);
    
    if (configDiv) {
      configDiv.style.display = 'grid';
      
      // üî• CORRE√á√ÉO CR√çTICA: Preencher tipo de tarifa (MDR/TIS)
      if (dados.tarifa) {
        const radioTarifa = configDiv.querySelector(`input[name="tarifa_${fornecedorId}"][value="${dados.tarifa}"]`);
        if (radioTarifa) {
          radioTarifa.checked = true;
          console.log("‚úÖ Tipo de tarifa selecionado:", dados.tarifa);
        } else {
          console.log("‚ö†Ô∏è Tarifa n√£o encontrada:", dados.tarifa, "para", fornecedorId);
          // üî• CORRE√á√ÉO: Selecionar MDR como padr√£o se n√£o encontrar
          const radioPadrao = configDiv.querySelector(`input[name="tarifa_${fornecedorId}"][value="MDR"]`);
          if (radioPadrao) {
            radioPadrao.checked = true;
            console.log("‚úÖ MDR selecionado como padr√£o");
          }
        }
      } else {
        console.log("‚ö†Ô∏è Nenhuma tarifa nos dados para", fornecedorId);
        // üî• CORRE√á√ÉO: Selecionar MDR como padr√£o se n√£o houver tarifa
        const radioPadrao = configDiv.querySelector(`input[name="tarifa_${fornecedorId}"][value="MDR"]`);
        if (radioPadrao) {
          radioPadrao.checked = true;
          console.log("‚úÖ MDR selecionado como padr√£o (sem tarifa nos dados)");
        }
      }
      
      // Preencher percentual da tarifa
      if (dados.percentual_tarifa !== undefined && dados.percentual_tarifa !== null) {
        const selectPercentual = configDiv.querySelector(`select[name="percentual_${fornecedorId}"]`);
        if (selectPercentual) {
          let percentualValue = dados.percentual_tarifa;
          
          // Converter para formato correto
          if (typeof percentualValue === 'number') {
            percentualValue = Math.round(percentualValue * 100) + '%';
          } else if (typeof percentualValue === 'string' && !percentualValue.includes('%')) {
            if (percentualValue.includes('.')) {
              const numero = parseFloat(percentualValue);
              if (!isNaN(numero)) {
                percentualValue = Math.round(numero * 100) + '%';
              } else {
                percentualValue = percentualValue + '%';
              }
            } else {
              percentualValue = percentualValue + '%';
            }
          }
          
          selectPercentual.value = percentualValue;
          console.log("‚úÖ Percentual definido:", percentualValue);
        }
      } else {
        console.log("‚ö†Ô∏è Nenhum percentual nos dados para", fornecedorId);
        // üî• CORRE√á√ÉO: Definir 0% como padr√£o
        const selectPercentual = configDiv.querySelector(`select[name="percentual_${fornecedorId}"]`);
        if (selectPercentual) {
          selectPercentual.value = '0%';
          console.log("‚úÖ 0% definido como padr√£o (sem percentual nos dados)");
        }
      }
    }
  } else {
    console.log("‚ùå Fornecedor n√£o encontrado no HTML:", dados.fornecedor);
  }
}

    function preencherDadosCadastro(dados) {
      if (!dados.encontrado) {
        showMessage('info', dados.mensagem);
        limparFormulario();
        document.getElementById('btnCadastrar').style.display = 'block';
        document.getElementById('btnAtualizar').style.display = 'none';
        cadastroAtualId = null;
        return;
      }

      cadastroAtualId = dados.id;
      document.getElementById('razao_social').value = dados.razao_social;
      document.getElementById('nome_fantasia').value = dados.nome_fantasia;
      document.getElementById('cnpj_cadastro').value = dados.cnpj;
      document.getElementById('tipo').value = dados.tipo;
      
      // üî• CORRE√á√ÉO: Preencher ades√£o corretamente
      if (dados.adesao === 'Isento' || dados.adesao === 0 || dados.adesao === '0') {
        document.getElementById('adesao').value = 'R$ 0,00';
      } else {
        document.getElementById('adesao').value = formatarMoedaParaInput(dados.adesao);
      }
      
      // üî• CORRE√á√ÉO: Preencher fornecedor com tarifas
      preencherFornecedorComTarifas(dados);
      
      document.getElementById('data_status').value = dados.data_status;
      document.getElementById('observacoes').value = dados.observacoes;
      document.getElementById('contrato_enviado').value = dados.contrato_enviado;
      document.getElementById('contrato_assinado').value = dados.contrato_assinado;
      document.getElementById('ativacao').value = dados.ativacao;
      document.getElementById('link').value = dados.link;
      document.getElementById('mensalidade').value = formatarMoedaParaInput(dados.mensalidade);
      document.getElementById('situacao').value = dados.situacao;

      // üî• CORRE√á√ÉO: Preencher evento
      if (dados.evento) {
        atualizarEventos();
        document.getElementById('evento').value = dados.evento;
      }

      document.getElementById('btnCadastrar').style.display = 'none';
      document.getElementById('btnAtualizar').style.display = 'block';

      showMessage('success', 'Cadastro encontrado! Modo de edi√ß√£o ativado.');
    }

 function limparBusca() {
  limparFormulario();
  
  // üî• CORRE√á√ÉO: Esconder a tabela tamb√©m
  document.getElementById('secaoCadastros').style.display = 'none';
  showMessage('info', 'Formul√°rio limpo e busca cancelada!');
}

  // üî• FUN√á√ÉO PARA ATUALIZAR EVENTOS COM BASE NA SITUA√á√ÉO - VERS√ÉO CORRIGIDA
function atualizarEventos() {
  const situacao = document.getElementById('situacao').value;
  const selectEvento = document.getElementById('evento');
  
  console.log("üéØ Atualizando eventos para situa√ß√£o:", situacao);
  
  // Limpar op√ß√µes atuais
  selectEvento.innerHTML = '<option value="">-- Selecione um evento --</option>';
  
  let eventos = [];
  
  // ‚úÖ CORRE√á√ÉO: Usar as vari√°veis globais que J√Å EXISTEM
  // N√ÉO criar novas vari√°veis dentro da fun√ß√£o!
  switch(situacao) {
    case 'Em andamento':
      eventos = eventosEmAndamento; // ‚úÖ J√° existe globalmente
      break;
    case 'N√£o conclu√≠do':
      eventos = eventosNaoConcluido; // ‚úÖ J√° existe globalmente
      break;
    case 'Cadastrado':
      eventos = eventosCadastrado; // ‚úÖ J√° existe globalmente
      break;
    case 'Novo registro':
      // ‚úÖ CORRE√á√ÉO: "Novo registro" mostra eventos de "Em andamento"
      eventos = eventosEmAndamento; // ‚úÖ J√° existe globalmente
      break;
    case 'Descredenciado':
      eventos = ['Descredenciado'];
      break;
    default:
      eventos = [];
  }
  
  console.log("üìã Eventos dispon√≠veis:", eventos);
  
  // Adicionar op√ß√µes ao select
  eventos.forEach(evento => {
    const option = document.createElement('option');
    option.value = evento;
    option.textContent = evento;
    selectEvento.appendChild(option);
  });
  
  console.log("‚úÖ Eventos atualizados para situa√ß√£o:", situacao);
}

    // üîÑ FUN√á√ïES DE LOADING
    function showLoading(message = "Salvando dados...", submessage = "Aguarde um momento") {
      const overlay = document.getElementById('loadingOverlay');
      const loadingText = overlay.querySelector('.loading-text');
      const loadingSubtext = overlay.querySelector('.loading-subtext');
      
      loadingText.textContent = message;
      loadingSubtext.textContent = submessage;
      overlay.style.display = 'flex';
    }

    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      overlay.style.display = 'none';
    }

    // üî• CORRE√á√ÉO: Verificar se o elemento existe antes de adicionar event listener
    const modalDetalhes = document.getElementById('modalDetalhes');
    if (modalDetalhes) {
      modalDetalhes.addEventListener('click', function(e) {
        if (e.target === this) {
          fecharModalDetalhes();
        }
      });
    }

    // Fechar modal com ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        fecharModalDetalhes();
      }
    });

    function fecharModalDetalhes() {
      const modal = document.getElementById('modalDetalhes');
      modal.style.display = 'none';
    }

    // üî• ADICIONAR PARA EVITAR ERROS COM DATAS
    function formatarDataParaExibicao(data) {
      if (!data) return '';
      
      try {
        // Se j√° estiver no formato brasileiro, retorna como est√°
        if (typeof data === 'string' && data.includes('/')) {
          return data;
        }
        
        // Se for objeto Date ou string ISO, formata
        const dateObj = new Date(data);
        if (!isNaN(dateObj.getTime())) {
          return dateObj.toLocaleDateString('pt-BR');
        }
        
        return data;
      } catch (error) {
        return data; // Retorna o valor original em caso de erro
      }
    }

function getSituacaoClass(situacao) {
  if (!situacao) return 'situacao-cadastrado';
  
  // üî• CORRE√á√ÉO DEFINITIVA: Captura TODAS as varia√ß√µes de "Novo Registro"
  const situacaoLower = situacao.toLowerCase().trim();
  const situacaoSemAcentos = situacaoLower.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  
  // Verifica TODAS as poss√≠veis varia√ß√µes de "Novo Registro"
  if (situacaoLower.includes('novo registro') || 
      situacaoLower === 'novo registro' ||
      situacaoLower === 'novo registr' ||
      situacaoSemAcentos.includes('novo registro') ||
      situacao.includes('Novo Registro') ||
      situacao.includes('Novo registro')) {
    return 'situacao-novo-registro';
  }
  else if (situacaoLower.includes('cadastrado')) return 'situacao-cadastrado';
  else if (situacaoLower.includes('em andamento')) return 'situacao-andamento';
  else if (situacaoLower.includes('n√£o conclu√≠do') || situacaoLower.includes('nao concluido')) return 'situacao-nao-concluido';
  else if (situacaoLower.includes('descredenciado')) return 'situacao-descredenciado';
  else return 'situacao-cadastrado';
}


    // üî• ADICIONAR: Fun√ß√£o para configurar valida√ß√£o em tempo real
    function configurarValidacaoEmTempoReal() {
      const campos = document.querySelectorAll('#razao_social, #cnpj_cadastro, #tipo');
      campos.forEach(campo => {
        campo.addEventListener('input', function() {
          this.style.borderColor = '';
        });
      });
    }

    // üî• ADICIONAR: Fun√ß√£o para remover autoriza√ß√£o (√∫til para testes)
    function limparAutorizacao() {
      localStorage.removeItem('usuarioAutorizado');
      location.reload();
    }

// üî•üî•üî• COLE ESTAS FUN√á√ïES NO FINAL DO JAVASCRIPT üî•üî•üî•

// üî• FUN√á√ÉO PARA AGRUPAR CADASTROS POR CNPJ
function agruparCadastrosPorCNPJ(cadastros) {
  const agrupados = {};
  
  cadastros.forEach(cadastro => {
    if (!agrupados[cadastro.cnpj]) {
      agrupados[cadastro.cnpj] = {
        razao_social: cadastro.razao_social,
        nome_fantasia: cadastro.nome_fantasia,
        cnpj: cadastro.cnpj,
        tipo: cadastro.tipo,
        mensalidade: cadastro.mensalidade,
        adesao: cadastro.adesao,
        situacao: cadastro.situacao,
        evento: cadastro.evento,
        fornecedores: []
      };
    }
    
    agrupados[cadastro.cnpj].fornecedores.push({
      nome: cadastro.fornecedor,
      tarifa: cadastro.tarifa,
      percentual_tarifa: cadastro.percentual_tarifa,
      evento: cadastro.evento,
      id: cadastro.id,
      situacao: cadastro.situacao
    });
  });
  
  return Object.values(agrupados);
}

// üî• FUN√á√ÉO PARA EXIBIR TABELA AGRUPADA
function exibirTabelaCadastrosAgrupada(cadastrosAgrupados, titulo) {
  const secao = document.getElementById('secaoCadastros');
  const tituloElement = document.getElementById('tituloCadastros');
  const tableContainer = document.getElementById('tableContainer');
  const tabelaBody = document.getElementById('tabelaCadastrosBody');
  const loading = document.getElementById('loadingCadastros');

  tituloElement.textContent = `${titulo} (${cadastrosAgrupados.length})`;
  tabelaBody.innerHTML = '';

  if (cadastrosAgrupados.length === 0) {
    tabelaBody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align: center; padding: 40px;">
          <i class="fas fa-search" style="font-size: 3rem; color: var(--gray); margin-bottom: 15px;"></i>
          <h3>Nenhum resultado encontrado</h3>
          <p>Tente alterar os filtros de pesquisa.</p>
        </td>
      </tr>
    `;
  } else {
    cadastrosAgrupados.forEach(cadastro => {
      const row = criarLinhaTabelaAgrupada(cadastro);
      tabelaBody.appendChild(row);
    });
  }

  loading.style.display = 'none';
  tableContainer.style.display = 'block';
  secao.style.display = 'block';
  atualizarContador();
  
  setTimeout(() => {
    secao.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 300);
}

// üî• FUN√á√ÉO PARA PADRONIZAR O TEXTO DA SITUA√á√ÉO
function padronizarSituacao(situacao) {
  if (!situacao) return 'Novo registro';
  
  const situacaoLower = situacao.toLowerCase().trim();
  const situacaoSemAcentos = situacaoLower.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  
  // Padroniza para "Novo registro" (min√∫sculo)
  if (situacaoLower.includes('novo registro') || 
      situacaoLower === 'novo registr' ||
      situacaoSemAcentos.includes('novo registro') ||
      situacao.includes('Novo Registro') ||
      situacao.includes('Novo registro')) {
    return 'Novo registro';
  }
  else if (situacaoLower.includes('cadastrado')) return 'Cadastrado';
  else if (situacaoLower.includes('em andamento')) return 'Em andamento';
  else if (situacaoLower.includes('n√£o conclu√≠do') || situacaoLower.includes('nao concluido')) return 'N√£o conclu√≠do';
  else if (situacaoLower.includes('descredenciado')) return 'Descredenciado';
  
  return situacao; // Mant√©m original se n√£o identificar
}

// üî• FUN√á√ÉO PARA CRIAR LINHA DA TABELA AGRUPADA
function criarLinhaTabelaAgrupada(cadastro) {
  const row = document.createElement('tr');
  row.style.cursor = 'pointer';
  
  // Classes de situa√ß√£o - USA A MESMA PADRONIZA√á√ÉO
const situacaoPadronizada = padronizarSituacao(cadastro.situacao);
let situacaoClass = 'situacao-cadastrado';
if (situacaoPadronizada === 'Novo registro') situacaoClass = 'situacao-novo-registro';
else if (situacaoPadronizada === 'Em andamento') situacaoClass = 'situacao-andamento';
else if (situacaoPadronizada === 'N√£o conclu√≠do') situacaoClass = 'situacao-nao-concluido';
else if (situacaoPadronizada === 'Descredenciado') situacaoClass = 'situacao-descredenciado';

    row.innerHTML = `
  <td style="vertical-align: top; padding: 15px 8px;">
    <div style="font-weight: 600; color: var(--primary); margin-bottom: 4px;">${cadastro.razao_social || 'N/A'}</div>
    <div style="font-size: 0.8rem; color: var(--gray); margin-bottom: 4px;">${cadastro.nome_fantasia || 'Sem nome fantasia'}</div>
    <div style="font-size: 0.7rem; color: var(--info);">
      <strong>Evento:</strong> ${cadastro.evento || 'N/A'}
    </div>
    <div style="font-size: 0.7rem; color: var(--warning);">
      <strong>Situa√ß√£o:</strong> <span class="status-badge ${getSituacaoClass(cadastro.situacao)}">${padronizarSituacao(cadastro.situacao) || 'N/A'}</span>
    </div>
  </td>
  <td style="vertical-align: top; padding: 15px 8px;">
    <div style="font-family: monospace; font-size: 0.85rem;">${cadastro.cnpj || 'N/A'}</div>
  </td>
  <td style="vertical-align: top; padding: 15px 8px;">
    <div style="font-weight: 500; background: var(--primary); color: white; padding: 4px 8px; border-radius: 12px; text-align: center; margin-bottom: 4px;">
      ${cadastro.fornecedores.length} fornecedor(es)
    </div>
    <div style="font-size: 0.7rem; color: var(--gray);">
      ${cadastro.fornecedores.map(f => f.nome).join(', ')}
    </div>
  </td>
  <td style="vertical-align: middle; font-weight: 600; color: var(--success); padding: 15px 8px; text-align: center;">
  ${formatarMoedaParaInput(cadastro.mensalidade)}
</td>
<td style="vertical-align: middle; font-weight: 600; color: var(--info); padding: 15px 8px; text-align: center;">
  ${cadastro.adesao === 'Isento' || cadastro.adesao === 0 ? 'Isento' : formatarMoedaParaInput(cadastro.adesao)}
</td>
  <td class="acoes-cell" style="vertical-align: middle; padding: 0; height: 100%; text-align: center;">
  <button class="btn btn-info btn-sm btn-visualizar-compact" onclick="verDetalhesAgrupados('${cadastro.cnpj}')" title="Visualizar">
    <i class="fas fa-eye"></i> Visualizar
  </button>
</td>
`;

  return row;
}

// üî• FUN√á√ÉO PARA VER TODAS AS LOJAS DE UM CNPJ (VERS√ÉO QUE FUNCIONA)
function verDetalhesAgrupados(cnpj) {
  console.log("üîçüîçüîç DEBUG: Fun√ß√£o verDetalhesAgrupados CHAMADA");
  console.log("üîç CNPJ:", cnpj);
  console.log("üîç todosCadastros length:", todosCadastros ? todosCadastros.length : 'NULL');
  
  if (!todosCadastros || todosCadastros.length === 0) {
    console.log("‚ùå ERRO: todosCadastros est√° vazio ou n√£o definido");
    showMessage('error', '‚ùå Dados n√£o carregados. Clique em "Ver Todos os Cadastros" primeiro.');
    return;
  }
  
  // üî• CORRE√á√ÉO: Filtrar das lojas que J√Å TEMOS carregadas
  const lojasDoCNPJ = todosCadastros.filter(cadastro => {
    console.log("üîç Comparando:", cadastro.cnpj, "com", cnpj);
    return cadastro.cnpj === cnpj;
  });
  
  console.log("‚úÖ Lojas encontradas:", lojasDoCNPJ.length);
  console.log("‚úÖ Lojas:", lojasDoCNPJ);
  
  if (lojasDoCNPJ.length > 0) {
    console.log("üéØ Chamando exibirModalLojasAgrupadas");
    exibirModalLojasAgrupadas(cnpj, lojasDoCNPJ);
  } else {
    console.log("‚ùå Nenhuma loja encontrada para CNPJ:", cnpj);
    showMessage('error', '‚ùå Nenhuma loja encontrada para este CNPJ');
  }
}

// üî• FUN√á√ÉO PARA COR DA BORDA POR SITUA√á√ÉO (PADRONIZADA)
function getCorBordaSituacao(situacao) {
  // üî• CORRE√á√ÉO: Padronizar para min√∫sculo
  const situacaoLower = situacao ? situacao.toLowerCase() : '';
  
  if (situacaoLower.includes('novo registro')) return '#bfe1f6';
  else if (situacaoLower.includes('cadastrado')) return '#D1E7DD';
  else if (situacaoLower.includes('em andamento')) return '#FFF3CD';
  else if (situacaoLower.includes('n√£o conclu√≠do') || situacaoLower.includes('nao concluido')) return '#E2E3E5';
  else if (situacaoLower.includes('descredenciado')) return '#F8D7DA';
  else return 'var(--border)';
}

// üî• FUN√á√ÉO PARA EXIBIR MODAL COM TODAS AS LOJAS
function exibirModalLojasAgrupadas(cnpj, lojas) {
  const modal = document.getElementById('modalDetalhes');
  const content = document.getElementById('modalDetalhesContent');
  
  let lojasHTML = '';
  
  if (lojas && lojas.length > 0) {
    lojasHTML = lojas.map(loja => `
      <div class="loja-item" style="border: 3px solid ${getCorBordaSituacao(loja.situacao)}; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
          <h4 style="margin: 0; color: var(--primary);">üè™ ${loja.fornecedor || 'Fornecedor'}</h4>
          <span class="status-badge ${getSituacaoClass(loja.situacao)}">${loja.situacao || 'N/A'}</span>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
          <div><strong>üìÖ Evento:</strong> ${loja.evento || 'N/A'}</div>
          <div><strong>üí∞ Tarifa:</strong> ${loja.tarifa || 'N/A'} ${loja.percentual_tarifa || ''}</div>
          <div><strong>üíµ Mensalidade:</strong> ${formatarMoedaParaInput(loja.mensalidade)}</div>
          <div><strong>ü§ù Ades√£o:</strong> ${loja.adesao === 'Isento' || loja.adesao === 0 ? 'Isento' : formatarMoedaParaInput(loja.adesao)}</div>
        </div>
        
        <div style="margin-top: 10px; display: flex; gap: 10px;">
          <button class="btn btn-warning btn-sm" onclick="editarCadastroModal('${loja.id}')">
            <i class="fas fa-edit"></i> Editar
          </button>
          <button class="btn btn-info btn-sm" onclick="verDetalhesCadastroModal('${loja.id}')">
            <i class="fas fa-eye"></i> Detalhes
          </button>
        </div>
      </div>
    `).join('');
  } else {
    lojasHTML = `
      <div style="text-align: center; padding: 40px; color: var(--gray);">
        <i class="fas fa-store-slash" style="font-size: 3rem; margin-bottom: 15px;"></i>
        <h4>Nenhuma loja encontrada</h4>
        <p>N√£o h√° lojas cadastradas para este CNPJ.</p>
      </div>
    `;
  }

  content.innerHTML = `
    <div style="margin-bottom: 15px;">
      <div style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
        <strong>CNPJ:</strong> ${cnpj}
      </div>
    </div>
    
    <div style="max-height: 60vh; overflow-y: auto;">
      <h4 style="color: var(--primary); margin-bottom: 15px;">
        üìä ${lojas ? lojas.length : 0} loja(s) encontrada(s)
      </h4>
      ${lojasHTML}
    </div>
  `;
  
  modal.style.display = 'flex';
}

// üî• FUN√á√ÉO PARA EDITAR UMA LOJA ESPEC√çFICA (do modal)
function editarCadastroModal(id) {
  console.log("‚úèÔ∏è Editando cadastro ID:", id);
  showLoading("Carregando dados...", "Buscando informa√ß√µes da loja");
  
  google.script.run
    .withSuccessHandler(function(dados) {
      hideLoading();
      fecharModalDetalhes(); // Fecha o modal das lojas
      preencherDadosCadastro(dados); // Preenche o formul√°rio principal
      
      // Scroll para o formul√°rio
      document.getElementById('razao_social').scrollIntoView({ behavior: 'smooth' });
      showMessage('success', '‚úÖ Cadastro carregado para edi√ß√£o!');
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showMessage('error', '‚ùå Erro ao carregar cadastro: ' + error.message);
    })
    .buscarCadastroPorID(id);
}

// üî• FUN√á√ÉO PARA VER DETALHES DE UMA LOJA ESPEC√çFICA (do modal)
function verDetalhesCadastroModal(id) {
  console.log("üëÄ Visualizando detalhes ID:", id);
  showLoading("Carregando detalhes...", "Buscando informa√ß√µes completas");
  
  google.script.run
    .withSuccessHandler(function(dados) {
      hideLoading();
      exibirModalDetalhesCompleto(dados); // Mostra modal com todos os detalhes
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showMessage('error', '‚ùå Erro ao carregar detalhes: ' + error.message);
    })
    .buscarCadastroPorID(id);
}

// üî• FUN√á√ÉO PARA EXIBIR MODAL COM DETALHES COMPLETOS
function exibirModalDetalhesCompleto(dados) {
  const modal = document.getElementById('modalDetalhes');
  const content = document.getElementById('modalDetalhesContent');
  
  const mensalidadeFormatada = formatarMoedaParaInput(dados.mensalidade);
  const adesaoFormatada = dados.adesao === 'Isento' || dados.adesao === 0 ? 'Isento' : formatarMoedaParaInput(dados.adesao);

  content.innerHTML = `
    <div class="modal-header">
      <h3 class="modal-title">üìã Detalhes Completo da Loja</h3>
      <button class="btn-close" onclick="fecharModalDetalhes()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="detalhes-grid">
      <div class="detalhe-item">
        <span class="detalhe-label">üè¢ Raz√£o Social</span>
        <div class="detalhe-valor">${dados.razao_social || 'N/A'}</div>
      </div>
      
      <div class="detalhe-item">
        <span class="detalhe-label">üè∑Ô∏è Nome Fantasia</span>
        <div class="detalhe-valor">${dados.nome_fantasia || 'N/A'}</div>
      </div>
      
      <div class="detalhe-item">
        <span class="detalhe-label">üî¢ CNPJ</span>
        <div class="detalhe-valor" style="font-family: monospace;">${dados.cnpj || 'N/A'}</div>
      </div>
      
      <div class="detalhe-item">
        <span class="detalhe-label">üìä Tipo</span>
        <div class="detalhe-valor">${dados.tipo || 'N/A'}</div>
      </div>
      
      <div class="detalhe-item">
        <span class="detalhe-label">üöö Fornecedor</span>
        <div class="detalhe-valor">${dados.fornecedor || 'N/A'}</div>
      </div>
      
      <div class="detalhe-item">
        <span class="detalhe-label">üí∞ Tarifa</span>
        <div class="detalhe-valor">${dados.tarifa || 'N/A'} ${dados.percentual_tarifa || ''}</div>
      </div>
      
      <div class="detalhe-item">
        <span class="detalhe-label">üìÖ Evento</span>
        <div class="detalhe-valor">${dados.evento || 'N/A'}</div>
      </div>

      <div class="detalhe-item">
        <span class="detalhe-label">üìÑ Contrato Enviado</span>
        <div class="detalhe-valor">${dados.contrato_enviado || 'N/A'}</div>
      </div>
      
      <div class="detalhe-item">
        <span class="detalhe-label">‚úçÔ∏è Contrato Assinado</span>
        <div class="detalhe-valor">${dados.contrato_assinado || 'N/A'}</div>
      </div>
      
      <div class="detalhe-item">
        <span class="detalhe-label">üìÖ Data Status</span>
        <div class="detalhe-valor">${formatarDataParaExibicao(dados.data_status) || 'N/A'}</div>
      </div>
      
      <div class="detalhe-item">
        <span class="detalhe-label">üöÄ Ativa√ß√£o</span>
        <div class="detalhe-valor">${formatarDataParaExibicao(dados.ativacao) || 'N/A'}</div>
      </div>
      
      <div class="detalhe-item">
        <span class="detalhe-label">üîó Link</span>
        <div class="detalhe-valor">
          ${dados.link ? `<a href="${dados.link}" target="_blank" style="color: var(--primary);">${dados.link}</a>` : 'N/A'}
        </div>
      </div>
      
      <div class="detalhe-item">
        <span class="detalhe-label">üíµ Mensalidade</span>
        <div class="detalhe-valor" style="color: var(--success); font-weight: 600;">${mensalidadeFormatada}</div>
      </div>
      
      <div class="detalhe-item">
        <span class="detalhe-label">ü§ù Ades√£o</span>
        <div class="detalhe-valor" style="color: var(--info); font-weight: 600;">${adesaoFormatada}</div>
      </div>
      
      <div class="detalhe-item">
        <span class="detalhe-label">üéØ Situa√ß√£o</span>
        <div class="detalhe-valor">
          <span class="status-badge ${getSituacaoClass(dados.situacao)}">${dados.situacao || 'N/A'}</span>
        </div>
      </div>
      
      <div class="detalhe-item" style="grid-column: 1 / -1;">
        <span class="detalhe-label">üìù Observa√ß√µes</span>
        <div class="detalhe-valor">${dados.observacoes || 'Nenhuma observa√ß√£o'}</div>
      </div>
    </div>

    <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border);">
      <button class="btn btn-warning" onclick="editarCadastroModal('${dados.id}')">
        <i class="fas fa-edit"></i> Editar Esta Loja
      </button>
      <button class="btn btn-primary" onclick="fecharModalDetalhes()" style="margin-left: 10px;">
        <i class="fas fa-check"></i> Fechar
      </button>
    </div>
  `;
  
  modal.style.display = 'flex';
}

function configurarFiltroEvento(situacao) {
  const container = document.getElementById('filtroEventoContainer');
  container.style.display = 'block';
  
  // üî• CORRE√á√ÉO: Salvar a situa√ß√£o atual CORRETAMENTE
  container.setAttribute('data-situacao-atual', situacao);
  console.log("üéØ Situa√ß√£o do filtro definida para:", situacao);
}

function filtrarSugestoesEvento() {
  const input = document.getElementById('inputFiltroEvento');
  const suggestions = document.getElementById('suggestionsEvento');
  const container = document.getElementById('filtroEventoContainer');
  const termo = input.value.toLowerCase().trim();
  
  // Mostrar/ocultar bot√£o limpar
  const btnLimpar = document.getElementById('btnLimparFiltro');
  btnLimpar.style.display = termo ? 'block' : 'none';
  
  if (termo.length < 1) {
    suggestions.style.display = 'none';
    return;
  }
  
  // üî• CORRE√á√ÉO: Pegar apenas os eventos da situa√ß√£o atual
  const situacaoAtual = container.dataset.situacaoAtual || 'all';
  let eventosDaSituacao = [];
  
  switch(situacaoAtual) {
    case 'all':
      // Se √© "Todos", mostrar eventos de todas as situa√ß√µes
      eventosDaSituacao = [
        ...eventosEmAndamento,
        ...eventosNaoConcluido,
        ...eventosCadastrado,
        'Descredenciado'
      ];
      break;
    case 'Novo registro':
    case 'Em andamento':
      eventosDaSituacao = eventosEmAndamento;
      break;
    case 'N√£o conclu√≠do':
      eventosDaSituacao = eventosNaoConcluido;
      break;
    case 'Cadastrado':
      eventosDaSituacao = eventosCadastrado;
      break;
    case 'Descredenciado':
      eventosDaSituacao = ['Descredenciado'];
      break;
    default:
      eventosDaSituacao = [];
  }
  
  // Filtrar eventos que correspondem ao termo
  const eventosFiltrados = eventosDaSituacao.filter(evento => 
    evento.toLowerCase().includes(termo)
  );
  
  if (eventosFiltrados.length === 0) {
    suggestions.style.display = 'none';
    return;
  }
  
  // üî• CORRE√á√ÉO: Agrupar por situa√ß√£o (mesmo sendo uma s√≥, para manter a estrutura)
  let html = '';
  
  // Se √© "Todos", agrupar por situa√ß√£o original
  if (situacaoAtual === 'all') {
    const eventosAgrupados = {
      'Em andamento': eventosFiltrados.filter(evento => eventosEmAndamento.includes(evento)),
      'N√£o conclu√≠do': eventosFiltrados.filter(evento => eventosNaoConcluido.includes(evento)),
      'Cadastrado': eventosFiltrados.filter(evento => eventosCadastrado.includes(evento)),
      'Descredenciado': eventosFiltrados.filter(evento => evento === 'Descredenciado')
    };
    
    Object.keys(eventosAgrupados).forEach(situacao => {
      if (eventosAgrupados[situacao].length > 0) {
        html += `<div class="suggestion-evento-section">${situacao}</div>`;
        eventosAgrupados[situacao].forEach(evento => {
          html += `
            <div class="suggestion-evento-item" onclick="selecionarEventoFiltro('${evento}')">
              ${evento}
            </div>
          `;
        });
      }
    });
  } else {
    // Se √© uma situa√ß√£o espec√≠fica, mostrar s√≥ os eventos dela
    html += `<div class="suggestion-evento-section">${situacaoAtual}</div>`;
    eventosFiltrados.forEach(evento => {
      html += `
        <div class="suggestion-evento-item" onclick="selecionarEventoFiltro('${evento}')">
          ${evento}
        </div>
      `;
    });
  }
  
  suggestions.innerHTML = html;
  suggestions.style.display = 'block';
}

function selecionarEventoFiltro(evento) {
  const input = document.getElementById('inputFiltroEvento');
  const suggestions = document.getElementById('suggestionsEvento');
  
  input.value = evento;
  suggestions.style.display = 'none';
  
  // Aplicar o filtro
  aplicarFiltroEvento(evento);
}

function aplicarFiltroEvento(evento) {
  // Adicionar √† lista de filtros ativos
  const tagsContainer = document.getElementById('tagsFiltrosAtivos');
  const filtroExistente = Array.from(tagsContainer.children).find(tag => 
    tag.textContent.includes(evento)
  );
  
  if (!filtroExistente) {
    const tag = document.createElement('div');
    tag.className = 'filtro-chip ativo';
    tag.innerHTML = `
      ${evento}
      <button class="remover" onclick="removerFiltroEvento('${evento}')">
        <i class="fas fa-times"></i>
      </button>
    `;
    tagsContainer.appendChild(tag);
    tagsContainer.style.display = 'flex';
  }

  // üî•üî•üî• NOVA LINHA - APLICAR TODOS OS FILTROS (OR)
  aplicarFiltrosAtivos();
}

function removerFiltroEvento(evento) {
  const tagsContainer = document.getElementById('tagsFiltrosAtivos');
  const tagParaRemover = Array.from(tagsContainer.children).find(tag => 
    tag.textContent.includes(evento)
  );
  
  if (tagParaRemover) {
    tagParaRemover.remove();
  }

  // üî•üî•üî• SEMPRE REAPLICAR OS FILTROS RESTANTES
  aplicarFiltrosAtivos();
}

// üî•üî•üî• FUN√á√ÉO PARA APLICAR FILTRO OR (MOSTRAR LOJAS COM PELO MENOS 1 DOS EVENTOS)
function aplicarFiltrosAtivos() {
  const tagsContainer = document.getElementById('tagsFiltrosAtivos');
  const eventosAtivos = Array.from(tagsContainer.children).map(tag => 
    tag.textContent.trim().replace('√ó', '').trim()
  );
  
  if (eventosAtivos.length > 0) {
    // üî• FILTRO OR: Mostrar cadastros que tenham QUALQUER um dos eventos selecionados
    cadastrosFiltrados = todosCadastros.filter(cadastro => 
      eventosAtivos.includes(cadastro.evento)
    );
    
    const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosFiltrados);
    exibirTabelaCadastrosAgrupada(cadastrosAgrupados, `Filtrado por: ${eventosAtivos.join(' OU ')}`);
    
    tagsContainer.style.display = 'flex';
  } else {
    // Se n√£o h√° filtros, mostrar todos
    tagsContainer.style.display = 'none';
    recarregarCadastros();
  }
}


function limparFiltroEvento() {
  const input = document.getElementById('inputFiltroEvento');
  const suggestions = document.getElementById('suggestionsEvento');
  const btnLimpar = document.getElementById('btnLimparFiltro');
  
  input.value = '';
  suggestions.style.display = 'none';
  btnLimpar.style.display = 'none';
  
  // Remover todos os filtros
  const tagsContainer = document.getElementById('tagsFiltrosAtivos');
  tagsContainer.innerHTML = '';
  tagsContainer.style.display = 'none';
  
  recarregarCadastros();
}


// üî• FUN√á√ÉO PARA CARREGAR EVENTOS NO FILTRO
function carregarEventosParaFiltro(situacao) {
  const filtroEvento = document.getElementById('filtroEvento');
  
  // Limpar op√ß√µes atuais (mantendo "Todos os eventos")
  const opcaoTodos = filtroEvento.querySelector('option[value=""]');
  filtroEvento.innerHTML = '';
  if (opcaoTodos) {
    filtroEvento.appendChild(opcaoTodos);
  }
  
  // Coletar eventos √∫nicos baseados na situa√ß√£o
  let eventosUnicos = [];
  
  if (situacao === 'all') {
    eventosUnicos = [...new Set(todosCadastros
      .filter(cad => cad.evento && cad.evento.trim() !== '')
      .map(cad => cad.evento)
    )].sort();
  } else {
    eventosUnicos = [...new Set(todosCadastros
      .filter(cad => cad.situacao === situacao && cad.evento && cad.evento.trim() !== '')
      .map(cad => cad.evento)
    )].sort();
  }
  
  // Adicionar eventos ao select
  eventosUnicos.forEach(evento => {
    const option = document.createElement('option');
    option.value = evento;
    option.textContent = evento;
    filtroEvento.appendChild(option);
  });
}

// üî• FUN√á√ÉO PARA FILTRAR PESQUISA
function filtrarPesquisa() {
  const termo = document.getElementById('pesquisaCadastros').value.toLowerCase().trim();
  console.log("üîç Pesquisando por:", termo);
  
  if (!termo) {
    // Se campo vazio, mostrar todos
    cadastrosFiltrados = [...todosCadastros];
  } else {
    // Filtrar por m√∫ltiplos campos
    cadastrosFiltrados = todosCadastros.filter(cadastro => 
      (cadastro.razao_social && cadastro.razao_social.toLowerCase().includes(termo)) ||
      (cadastro.nome_fantasia && cadastro.nome_fantasia.toLowerCase().includes(termo)) ||
      (cadastro.cnpj && cadastro.cnpj.includes(termo)) ||
      (cadastro.fornecedor && cadastro.fornecedor.toLowerCase().includes(termo)) ||
      (cadastro.evento && cadastro.evento.toLowerCase().includes(termo))
    );
  }
  
  const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosFiltrados);
  exibirTabelaCadastrosAgrupada(cadastrosAgrupados, `Resultados para: "${termo}"`);
}

// üî• FUN√á√ÉO PARA ATUALIZAR CONTADOR
function atualizarContador() {
  const contador = document.getElementById('contadorCadastros');
  const cadastrosVisiveis = document.querySelectorAll('#tabelaCadastrosBody tr').length;
  contador.textContent = `${cadastrosVisiveis} cadastro${cadastrosVisiveis !== 1 ? 's' : ''}`;
}

// üî• FUN√á√ïES ADICIONAIS PARA COMPLETAR
function ordenarCadastros() {
  const criterio = document.getElementById('ordenacaoCadastros').value;
  console.log("üîÄ Ordenando por:", criterio);
  
  if (cadastrosFiltrados.length === 0) return;
  
  const cadastrosOrdenados = [...cadastrosFiltrados].sort((a, b) => {
    const valorA = a[criterio] || '';
    const valorB = b[criterio] || '';
    
    if (typeof valorA === 'string' && typeof valorB === 'string') {
      return valorA.localeCompare(valorB);
    }
    return 0;
  });
  
  const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosOrdenados);
  exibirTabelaCadastrosAgrupada(cadastrosAgrupados, 'Cadastros Ordenados');
}

function recarregarCadastros() {
  console.log("üîÑ Recarregando cadastros...");
  mostrarTodosCadastros();
}

function filtrarSugestoesEventoSearch() {
  const input = document.getElementById('inputEventoSearch');
  const suggestions = document.getElementById('suggestionsEventoSearch');
  const termo = input.value.toLowerCase().trim();
  
  if (termo.length < 1) {
    suggestions.style.display = 'none';
    return;
  }
  
  // üî• OBTER EVENTOS BASEADO NA SITUA√á√ÉO ATUAL DO FORMUL√ÅRIO
  const situacaoAtual = document.getElementById('situacao').value;
  let eventosDaSituacao = [];
  
  switch(situacaoAtual) {
    case 'Novo registro':
    case 'Em andamento':
      eventosDaSituacao = eventosEmAndamento;
      break;
    case 'N√£o conclu√≠do':
      eventosDaSituacao = eventosNaoConcluido;
      break;
    case 'Cadastrado':
      eventosDaSituacao = eventosCadastrado;
      break;
    case 'Descredenciado':
      eventosDaSituacao = ['Descredenciado'];
      break;
    default:
      eventosDaSituacao = [];
  }
  
  // Filtrar eventos que correspondem ao termo
  const eventosFiltrados = eventosDaSituacao.filter(evento => 
    evento.toLowerCase().includes(termo)
  );
  
  if (eventosFiltrados.length === 0) {
    suggestions.innerHTML = `
      <div class="suggestion-evento-item-search" style="color: var(--gray); font-style: italic;">
        <i class="fas fa-search" style="margin-right: 8px;"></i>
        Nenhum evento encontrado para "${termo}"
      </div>
    `;
    suggestions.style.display = 'block';
    return;
  }
  
  // Montar HTML das sugest√µes
  let html = '';
  
  // Agrupar por situa√ß√£o
  html += `<div class="suggestion-evento-section-search">${situacaoAtual}</div>`;
  
  eventosFiltrados.forEach(evento => {
    html += `
      <div class="suggestion-evento-item-search" onclick="selecionarEventoSearch('${evento}')">
        <i class="fas fa-calendar-alt" style="margin-right: 8px;"></i>
        ${evento}
      </div>
    `;
  });
  
  suggestions.innerHTML = html;
  suggestions.style.display = 'block';
}

// Fun√ß√£o para selecionar evento no search
function selecionarEventoSearch(evento) {
  const input = document.getElementById('inputEventoSearch');
  const suggestions = document.getElementById('suggestionsEventoSearch');
  const selectEvento = document.getElementById('evento');
  
  // Definir valores
  input.value = evento;
  selectEvento.value = evento;
  
  // Ocultar sugest√µes
  suggestions.style.display = 'none';
  
  console.log("‚úÖ Evento selecionado:", evento);
}

// üî• ADICIONAR: Event listener para fechar sugest√µes ao clicar fora
document.addEventListener('click', function(e) {
  const suggestions = document.getElementById('suggestionsEventoSearch');
  const input = document.getElementById('inputEventoSearch');
  
  if (suggestions && suggestions.style.display === 'block') {
    if (!suggestions.contains(e.target) && e.target !== input) {
      suggestions.style.display = 'none';
    }
  }
});

  </script>
</body>
</html>
