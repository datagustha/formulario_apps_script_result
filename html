<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gestão de Cadastros - RESULT</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    
    :root {
      --primary: #7E3E9A;
      --secondary: #A1CC4C;
      --accent: #FF6B35;
      --dark: #2D3047;
      --light: #FFFFFF;
      --success: #28A745;
      --warning: #FFC107;
      --danger: #DC3545;
      --info: #17A2B8;
      --gray: #6C757D;
      --border: #E0E0E0;
      --background: #F8F9FA;
    }
    
    body {
      background: var(--background);
      min-height: 100vh;
      padding: 15px;
      color: var(--dark);
      font-size: 14px;
    }
    
    .container {
      max-width: 1800px;
      margin: 0 auto;
      background: var(--light);
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }
    
    .header {
      background: var(--primary);
      padding: 20px 30px;
      color: white;
      text-align: center;
    }

    .logo-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }
    
    .logo {
      width: 80px;
      height: 80px;
      background: white;
      padding: 10px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      object-fit: contain;
    }
    
    h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .subtitle {
      font-size: 1rem;
      opacity: 0.9;
    }
    
    .content {
      padding: 25px;
    }
    
    .card {
      background: var(--light);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      margin-top: 30px;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.04);
      border: 1px solid var(--border);
    }
    
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--primary);
    }
    
    .card-header i {
      color: var(--primary);
      font-size: 1.5rem;
    }
    
    .card-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--primary);
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--dark);
      font-size: 0.9rem;
    }
    
    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #6a2e82;
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-warning {
      background: var(--warning);
      color: var(--dark);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-info {
      background: var(--info);
      color: white;
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.8rem;
    }

    .filtros-container .btn.active {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(126, 62, 154, 0.3);
      border: 2px solid var(--primary) !important;
    }

    .filtros-container .btn.active[onclick="filtrarTabela('all')"] {
      background: var(--primary) !important;
      color: white !important;
      border-color: var(--primary) !important;
    }

    .filtros-container .btn.active:not([onclick="filtrarTabela('all')"]) {
      border: 2px solid var(--primary) !important;
      box-shadow: 0 0 0 3px rgba(126, 62, 154, 0.2) !important;
    }
    
    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .message {
      padding: 12px 16px;
      border-radius: 6px;
      margin: 12px 0;
      display: none;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }
    
    .success {
      background: #d4edda;
      color: var(--success);
      border: 1px solid #c3e6cb;
    }
    
    .error {
      background: #f8d7da;
      color: var(--danger);
      border: 1px solid #f5c6cb;
    }
    
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px;
      text-align: center;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .table-container {
      margin-top: 15px;
      overflow: hidden;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .table-responsive {
      overflow-x: auto;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      font-size: 0.8rem;
      table-layout: fixed;
    }
    
    .data-table th {
      background: var(--primary);
      color: white;
      padding: 12px 6px !important;
      text-align: center !important;
      font-weight: 700 !important;
      position: sticky;
      top: 0;
      white-space: nowrap;
      font-size: 0.85rem !important;
      letter-spacing: 0.5px;
      border-bottom: 2px solid rgba(255,255,255,0.2);
    }

    /* Ajuste das colunas da tabela - ATUALIZADO PARA NOVAS COLUNAS */
    .data-table th:nth-child(1) {
      width: 14%;
      text-align: left !important;
      padding-left: 12px !important;
    }

    /* Substitua ou ajuste as regras CSS para as colunas (aproximadamente linha 153) */
    .data-table th:nth-child(1) { width: 18%; text-align: left !important; padding-left: 12px !important; }
    .data-table th:nth-child(2) { width: 12%; }
    .data-table th:nth-child(3) { width: 10%; }
    .data-table th:nth-child(4) { width: 10%; }
    .data-table th:nth-child(5) { width: 15%; text-align: left !important; padding-left: 12px !important; }
    .data-table th:nth-child(6) { width: 8%; }
    .data-table th:nth-child(7) { width: 9%; }
    .data-table th:nth-child(8) { width: 9%; }
    .data-table th:nth-child(9) { width: 9%; }
    .data-table th:nth-child(10) { width: 10%; } /* Ações */
    
    .data-table td {
      padding: 12px 6px !important;
      border-bottom: 1px solid var(--border);
      word-wrap: break-word;
      vertical-align: middle !important;
      height: 100% !important;
    }

    .data-table td:nth-child(1) {
      text-align: left !important;
      vertical-align: top !important;
    }

    .data-table td:nth-child(2),
    .data-table td:nth-child(3),
    .data-table td:nth-child(4),
    .data-table td:nth-child(6),
    .data-table td:nth-child(7),
    .data-table td:nth-child(8),
    .data-table td:nth-child(9),
    .data-table td:nth-child(10),
    .data-table td:nth-child(11),
    .data-table td:nth-child(12) {
      text-align: center !important;
      vertical-align: middle !important;
    }

    .data-table td:nth-child(5) {
      text-align: left !important;
      vertical-align: middle !important;
    }

    .data-table td:nth-child(7) {
      font-weight: 600;
      color: var(--success) !important;
    }

    .data-table td:nth-child(8) {
      font-weight: 600;
      color: var(--primary) !important;
    }

    .data-table td:nth-child(10) {
      font-weight: 600;
      color: #FF6B35 !important;
    }

    .data-table td:nth-child(11) {
      font-weight: 600;
      color: #17A2B8 !important;
    }

    .data-table td:nth-child(12) {
      font-weight: 600;
      color: #A1CC4C !important;
    }
    
    .data-table tbody tr {
      transition: all 0.3s ease;
      display: table-row;
      height: auto;
    }
    
    .data-table tbody tr:hover {
      background: #f8f9fa;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    
    .data-table .btn-sm {
      padding: 5px 10px;
      font-size: 0.75rem;
      margin: 2px;
    }
    
    .status-badge {
  padding: 6px 12px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 700;
  text-align: center;
  display: inline-block;
  min-width: 80px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
    
    .acoes-cell {
      display: flex;
      gap: 4px;
      justify-content: center;
      align-items: center;
      height: 100% !important;
      min-height: 100% !important;
      padding: 0 !important;
      margin: 0 !important;
    }
    
    .action-buttons {
      display: flex;
      gap: 12px;
      margin: 30px 0 15px 0;
      flex-wrap: wrap;
    }
    
    .cadastros-container {
      margin-top: 25px;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
      border: 2px solid var(--primary);
    }
    
    .cadastros-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .cadastro-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      border: 2px solid var(--border);
      transition: all 0.3s ease;
    }
    
    .cadastro-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .cadastro-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .cadastro-nome {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--dark);
    }
    
    .cadastro-situacao {
      padding: 3px 10px;
      border-radius: 15px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .situacao-novo-registro {
  background: #bfe1f6 !important;
  color: #0c5aa3 !important;
}

.situacao-cadastrado {
  background: #D1E7DD !important;
  color: #0F5132 !important;
}

.situacao-andamento {
  background: #FFF3CD !important;
  color: #856404 !important;
}

.situacao-rejeitado {
  background: #E2E3E5 !important;
  color: #383D41 !important;
}

.situacao-descredenciado {
  background: #F8D7DA !important;
  color: #721C24 !important;
}

.situacao-desistiu {
  background: #e6cff2 !important;
  color: #4a1e6b !important;
}
    
    .cadastro-info {
      margin-bottom: 6px;
      font-size: 0.85rem;
    }
    
    .cadastro-info strong {
      color: var(--primary);
    }
    
    .mensalidade-badge {
      background: var(--primary);
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .filtros-container {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin: 15px 0;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .filtro-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border: 2px solid var(--border);
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
      color: var(--dark);
      position: relative;
    }

    .filtro-btn.active {
      transform: translateY(-2px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.15);
      border-width: 2px;
    }

    .filtro-btn::before {
      content: '';
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 4px;
    }

    .filtro-btn[data-situacao="all"]::before { background: var(--primary); }
    .filtro-btn[data-situacao="NOVO REGISTRO"]::before { background: #bfe1f6; }
    .filtro-btn[data-situacao="CADASTRADO"]::before { background: var(--success); }
    .filtro-btn[data-situacao="EM ANDAMENTO"]::before { background: var(--warning); }
    .filtro-btn[data-situacao="REJEITADO"]::before { background: var(--gray); }
    .filtro-btn[data-situacao="DESCREDENCIADO"]::before { background: var(--danger); }
    .filtro-btn[data-situacao="DESISTIU"]::before { background: #e6cff2; }

    .filtro-btn.active[data-situacao="all"] { 
      background: var(--primary); 
      color: white; 
      border-color: var(--primary); 
    }
    .filtro-btn.active[data-situacao="NOVO REGISTRO"] { 
      background: #bfe1f6; 
      color: #0c5aa3; 
      border-color: #bfe1f6; 
    }
    .filtro-btn.active[data-situacao="CADASTRADO"] { 
      background: var(--success); 
      color: white; 
      border-color: var(--success); 
    }
    .filtro-btn.active[data-situacao="EM ANDAMENTO"] { 
      background: var(--warning); 
      color: var(--dark); 
      border-color: var(--warning); 
    }
    .filtro-btn.active[data-situacao="REJEITADO"] { 
      background: var(--gray); 
      color: white; 
      border-color: var(--gray); 
    }
    .filtro-btn.active[data-situacao="DESCREDENCIADO"] { 
      background: var(--danger); 
      color: white; 
      border-color: var(--danger); 
    }
    .filtro-btn.active[data-situacao="DESISTIU"] { 
      background: #e6cff2; 
      color: #4a1e6b; 
      border-color: #e6cff2; 
    }

    .filtros-avancados {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin: 15px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .filtro-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filtro-label {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.85rem;
    }

    .form-select {
      width: 100%;
      padding: 8px 10px;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-size: 0.85rem;
      background: white;
      cursor: pointer;
    }

    .contador-lojas {
      background: var(--primary);
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .filtros-ativos {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 8px 0;
    }

    .filtro-chip {
      background: var(--primary);
      color: white;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .filtro-chip .remover {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 0;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
    }

    .filtro-multiselect-container {
      position: relative;
      z-index: 100;
    }

    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid var(--primary);
      border-top: none;
      border-radius: 0 0 6px 6px;
      z-index: 1001;
      max-height: 180px;
      overflow-y: auto;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      display: none;
      margin-top: -2px;
    }

    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: all 0.2s ease;
      font-size: 0.85rem;
    }

    .suggestion-item:hover {
      background: var(--primary);
      color: white;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .tags-selecionadas {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .tag {
      background: var(--info);
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .tag.fornecedor {
      background: var(--secondary);
    }

    .tag .remover {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 0;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
    }

    .tag .remover:hover {
      background: rgba(255,255,255,0.3);
    }

    .btn-visualizar-compact {
      padding: 6px 10px !important;
      font-size: 0.75rem !important;
      min-width: 90px;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      height: 100% !important;
      min-height: 35px !important;
      width: 100%;
      border-radius: 5px !important;
      margin: 0 !important;
    }

    .defasagem-badge {
      padding: 6px 10px !important;
      border-radius: 8px !important;
      font-size: 0.75rem !important;
      font-weight: 700 !important;
      min-width: 70px;
      display: inline-block;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .defasagem-alta {
      background: #f8d7da;
      color: #721c24;
    }

    .defasagem-media {
      background: #fff3cd;
      color: #856404;
    }

    .defasagem-baixa {
      background: #d1e7dd;
      color: #0f5132;
    }

    .sem-defasagem {
      background: #e9ecef !important;
      color: #6c757d !important;
      border: 1px solid #dee2e6 !important;
    }

    .sem-defasagem-badge {
      padding: 6px 10px !important;
      border-radius: 8px !important;
      font-size: 0.75rem !important;
      font-weight: 600 !important;
      background: #e9ecef !important;
      color: #6c757d !important;
      border: 1px solid #dee2e6 !important;
      min-width: 70px;
      display: inline-block;
      text-align: center;
    }

    .search-container {
      position: relative;
    }


    .form-label.obrigatorio::after {
      content: " *";
      color: var(--danger);
      font-weight: bold;
      margin-left: 2px;
    }

    .campo-obrigatorio {
      border-left: 3px solid var(--danger) !important;
      background-color: #fff5f5 !important;
    }

    .form-control.campo-obrigatorio,
    select.campo-obrigatorio {
      border: 2px solid var(--danger) !important;
      background-color: #fff5f5 !important;
      box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.1) !important;
      animation: pulse 0.5s ease-in-out;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

    .fornecedores-invalido {
      border: 2px solid var(--danger) !important;
      background: #fff5f5 !important;
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .btn-editar {
      background: var(--primary);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.75rem;
      transition: all 0.3s ease;
    }
    
    .btn-editar:hover {
      background: #6a2e82;
    }
    
    .btn-visualizar {
      background: var(--info);
      color: white;
      border: none;
      padding: 5px 8px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.75rem;
      transition: all 0.3s ease;
    }
    
    .btn-visualizar:hover {
      background: #138496;
    }

    #loadingOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .loading-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);
      min-width: 250px;
      border: 2px solid var(--primary);
    }

    .loading-spinner-large {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    .loading-text {
      margin: 0;
      color: var(--dark);
      font-weight: bold;
      font-size: 16px;
    }

    .loading-subtext {
      margin: 6px 0 0 0;
      color: var(--gray);
      font-size: 13px;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 25px;
      max-width: 900px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 15px 50px rgba(0,0,0,0.25);
      border: 3px solid var(--primary);
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 0;
      border-bottom: none;
    }

    .modal-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
    }

    .btn-close {
      background: none;
      border: none;
      font-size: 1.3rem;
      cursor: pointer;
      color: var(--gray);
      padding: 4px;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .btn-close:hover {
      background: var(--danger);
      color: white;
    }

    .detalhes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      margin-bottom: 15px;
    }

    .detalhe-item {
      margin-bottom: 10px;
    }

    .detalhe-label {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 4px;
      display: block;
      font-size: 0.9rem;
    }

    .detalhe-valor {
      color: var(--dark);
      background: white;
      padding: 12px 15px;
      border-radius: 10px;
      border-left: 4px solid var(--primary);
      font-size: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
    }

    #inputEtapaSearch {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%237E3E9A" width="16" height="16"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 16px;
      padding-right: 35px;
      cursor: pointer;
      font-size: 14px;
      padding: 12px 15px;
      height: auto;
      min-height: 45px;
      position: relative;
      z-index: 101;
    }

    #etapaFormGroup {
      position: relative;
      z-index: 100;
    }

    .suggestions-etapa-search {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid var(--primary);
      border-top: none;
      border-radius: 0 0 8px 8px;
      z-index: 1002;
      max-height: 250px;
      overflow-y: auto;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      display: none;
      margin-top: -2px;
    }

    .suggestion-etapa-item-search {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      color: var(--dark);
    }

    .suggestion-etapa-item-search:hover {
      background: var(--primary);
      color: white;
      transform: translateX(5px);
    }

    .suggestion-etapa-item-search:last-child {
      border-bottom: none;
    }


    .etapa-pendente-fornecedor {
      background: linear-gradient(135deg, #FF6B35 0%, #FF8E35 100%) !important;
      color: white !important;
      border: 2px solid #FF6B35 !important;
    }

    .etapa-pendente-sim {
      background: linear-gradient(135deg, #7E3E9A 0%, #9A5FB8 100%) !important;
      color: white !important;
      border: 2px solid #7E3E9A !important;
    }

    .etapa-pendente-retorno {
      background: linear-gradient(135deg, #0682c5 0%, #2AA0E6 100%) !important;
      color: white !important;
      border: 2px solid #0682c5 !important;
    }

    .suggestion-etapa-item-search[data-etapa="PENDENTE FORNECEDOR(ES)"] i {
      color: #FF6B35 !important;
    }

    .suggestion-etapa-item-search[data-etapa="PENDENTE SIM"] i {
      color: #7E3E9A !important;
    }

    .suggestion-etapa-item-search[data-etapa="PENDENTE RETORNO EXTERNO"] i {
      color: #0682c5 !important;
    }

    .form-group:has(#observacoes) .form-label {
      margin-left: 80px !important;
      width: 85% !important;
    }

    #observacoes {
      margin-left: 40px !important;
      width: 90% !important;
      min-height: 80px;
    }

    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      justify-content: flex-end !important;
      margin-left: auto;
      width: fit-content;
    }

    .waitlabel-selector {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 15px;
      border-radius: 10px;
      border: 2px solid var(--border);
      margin-bottom: 20px;
    }

    .waitlabel-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .waitlabel-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .waitlabel-btn {
      padding: 10px 16px;
      border: 2px solid var(--border);
      border-radius: 6px;
      background: white;
      color: var(--dark);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 120px;
      justify-content: center;
      font-size: 0.9rem;
    }

    .waitlabel-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    }

    .waitlabel-btn.active {
      transform: translateY(-2px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.15);
      border-width: 2px;
    }

    .waitlabel-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 4px;
    }

    .btn-aplicar-todos:hover {
      background: linear-gradient(135deg, #E55A2B 0%, #E57C2B 100%) !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 3px 10px rgba(255, 107, 53, 0.25) !important;
    }

    .checkbox-aplicar-todos {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 6px;
      padding: 6px 10px;
      background: #fff8f0;
      border-radius: 5px;
      border-left: 2px solid #FF6B35;
    }

    .checkbox-aplicar-todos input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #FF6B35;
    }

    .checkbox-aplicar-todos label {
      font-size: 0.8rem;
      color: #FF6B35;
      font-weight: 600;
      cursor: pointer;
    }

    .modo-aplicar-todos .form-group {
      border: 2px solid #fff8f0;
      border-radius: 6px;
      padding: 12px;
      background: #fffdfa;
    }

    .modo-aplicar-todos .card-header {
      background: linear-gradient(135deg, #fff8f0 0%, #fff0e0 100%);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 15px;
    }

    .shake {
      animation: shake 0.5s ease-in-out;
    }

    .btn-aplicar-todos.erro {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
      color: white !important;
      border: 2px solid #dc3545 !important;
      box-shadow: 0 0 15px rgba(220, 53, 69, 0.5) !important;
      animation: pulse 1s infinite !important;
    }

    .checkbox-aplicar-todos.erro {
      background: #fff5f5 !important;
      border-left: 3px solid var(--danger) !important;
      animation: pulse 1s infinite !important;
    }

    .checkbox-aplicar-todos.erro label {
      color: var(--danger) !important;
      font-weight: bold !important;
    }

    .suggestions-etapa-search .selecionado {
        background: var(--success) !important;
        color: white !important;
    }

    .suggestions-etapa-search .selecionado i {
        color: white !important;
    }

    #filtroEtapa:focus,
    #filtroFornecedor:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(126, 62, 154, 0.1);
        outline: none;
        z-index: 100;
        position: relative;
    }

    .defasagem-container {
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
      height: 100% !important;
    }

    .modal-fornecedor-card .status-badge {
  padding: 8px 14px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 700;
  min-width: 85px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  text-align: center;
}
    .modal-fornecedor-card .situacao-novo-registro {
      background: #bfe1f6 !important;
      color: #0c5aa3 !important;
      border-color: #bfe1f6 !important;
    }

    .modal-fornecedor-card .situacao-cadastrado {
      background: #28a745 !important;
      color: white !important;
      border-color: #28a745 !important;
    }

    .modal-fornecedor-card .situacao-andamento {
      background: #ffc107 !important;
      color: #000000 !important;
      border-color: #ffc107 !important;
    }

    .modal-fornecedor-card .situacao-rejeitado {
      background: #6c757d !important;
      color: white !important;
      border-color: #6c757d !important;
    }

    .modal-fornecedor-card .situacao-descredenciado {
      background: #dc3545 !important;
      color: white !important;
      border-color: #dc3545 !important;
    }

    .modal-fornecedor-card .situacao-desistiu {
      background: #e6cff2 !important;
      color: #4a1e6b !important;
      border-color: #e6cff2 !important;
    }

    @media (max-width: 768px) {
      .content {
        padding: 15px;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .btn-group {
        flex-direction: column;
      }

      h1 {
        font-size: 1.8rem;
      }
      
      .logo {
        width: 60px;
        height: 60px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .cadastros-grid {
        grid-template-columns: 1fr;
      }
      
      .card-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .filtros-container {
        margin-top: 12px;
      }
      
      .data-table {
        font-size: 0.75rem;
      }
      
      .acoes-cell {
        flex-direction: column;
      }
      
      .waitlabel-buttons {
        flex-direction: column;
      }
      
      .waitlabel-btn {
        min-width: 100%;
      }

      .modal-content {
        padding: 20px;
        margin: 10px;
        max-width: 95%;
      }
      
      .modal-title {
        font-size: 1.2rem;
      }

      .detalhes-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
    }

/* Header Profissional do CNPJ */
.modal-cnpj-header-profissional {
  background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
  color: white;
  padding: 25px 30px;
  border-radius: 12px;
  margin-bottom: 25px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.cnpj-header-content {
  display: flex;
  align-items: center;
  gap: 20px;
}

.cnpj-icon {
  background: rgba(255,255,255,0.1);
  padding: 15px;
  border-radius: 50%;
  font-size: 1.5rem;
}

.cnpj-info {
  flex: 1;
}

.cnpj-title {
  font-size: 0.9rem;
  font-weight: 600;
  opacity: 0.9;
  margin: 0 0 5px 0;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.cnpj-number {
  font-family: 'Courier New', monospace;
  font-size: 1.4rem;
  font-weight: 700;
  margin: 0 0 5px 0;
  letter-spacing: 1px;
}

.cnpj-subtitle {
  font-size: 0.85rem;
  opacity: 0.8;
  margin: 0;
}

.cnpj-badge {
  background: linear-gradient(135deg, #7E3E9A 0%, #9A5FB8 100%);
  padding: 15px 20px;
  border-radius: 12px;
  text-align: center;
  min-width: 90px;
  border: 2px solid rgba(255,255,255,0.3);
  box-shadow: 0 4px 15px rgba(126, 62, 154, 0.4);
  position: relative;
  overflow: hidden;
}

.cnpj-badge::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 50%);
}

.lojas-count {
  display: block;
  font-size: 1.8rem;
  font-weight: 700;
  position: relative;
  z-index: 2;
}

.cnpj-badge small {
  font-size: 0.75rem;
  opacity: 0.9;
  position: relative;
  z-index: 2;
}

/* Resumo Executivo */
.modal-resumo-executivo {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 25px;
  border-left: 4px solid var(--primary);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.resumo-item {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  color: var(--dark);
  font-size: 1.1rem;
}

.resumo-item i {
  color: var(--primary);
  font-size: 1.3rem;
}

.resumo-stats {
  display: flex;
  gap: 25px;
}

.stat-item {
  text-align: center;
}

.stat-number {
  display: block;
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--primary);
}

.stat-label {
  font-size: 0.8rem;
  color: var(--gray);
  font-weight: 600;
}

/* Header da Lista */
.fornecedores-list-header {
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid var(--border);
}

.fornecedores-list-header h4 {
  color: var(--dark);
  margin: 0 0 5px 0;
  font-size: 1.3rem;
}

.fornecedores-list-header .subtitle {
  color: var(--gray);
  font-size: 0.9rem;
}

.fornecedor-badge {
  background: var(--primary);
  color: white;
  padding: 8px 12px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 0.9rem;
}

.fornecedor-indice {
  display: block;
  text-align: center;
}

.fornecedor-subinfo {
  margin-top: 5px;
}

.info-tag {
  background: rgba(0,0,0,0.05);
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 0.75rem;
  color: var(--gray);
}

.etapa-destaque {
  font-weight: 700;
  color: var(--primary) !important;
}

.percentual-destaque {
  background: var(--secondary);
  color: white;
  padding: 2px 6px;
  border-radius: 8px;
  font-size: 0.8rem;
  margin-left: 5px;
}

.valor-destaque {
  font-weight: 700;
  color: var(--success) !important;
}

/* NOVOS POPUPS DE CARREGAMENTO */
.popup-carregamento {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  flex-direction: column;
}

.popup-conteudo {
  background: white;
  padding: 30px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 8px 25px rgba(0,0,0,0.25);
  min-width: 300px;
  border: 2px solid var(--primary);
}

.popup-spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid var(--primary);
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 0 auto 15px;
}

.popup-texto {
  margin: 0;
  color: var(--dark);
  font-weight: bold;
  font-size: 16px;
}

.popup-subtexto {
  margin: 6px 0 0 0;
  color: var(--gray);
  font-size: 13px;
}

/* NOVO: QUADRADO DE INFORMAÇÕES FINANCEIRAS DO CNPJ */
.cnpj-financeiro-card {
  background: linear-gradient(135deg, #f0fff0 0%, #e0ffe0 100%);
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 25px;
  border-left: 4px solid var(--primary);
  border: 2px solid var(--primary);
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 4px 15px rgba(126, 62, 154, 0.2);
}

.financeiro-title {
  font-size: 1rem;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.financeiro-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  width: 100%;
}

.financeiro-item {
  text-align: center;
  padding: 15px;
  background: white;
  border-radius: 8px;
  border: 1px solid var(--border);
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.financeiro-valor {
  display: block;
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 5px;
}

.financeiro-valor.mensalidade {
  color: var(--success);
}

.financeiro-valor.mensalidade-sim {
  color: var(--primary);
}

.financeiro-valor.adesao {
  color: var(--info);
}

.financeiro-label {
  font-size: 0.85rem;
  color: var(--gray);
  font-weight: 600;
}

/* NOVOS ESTILOS PARA CONFIGURAÇÃO DE FORNECEDOR */
.fornecedor-config-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 12px;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 6px;
  margin-top: 8px;
}

.config-column {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.config-label {
  font-weight: 600;
  font-size: 0.85rem;
  color: var(--dark);
  margin-bottom: 4px;
}

.config-input-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.percent-input {
  padding: 6px 10px;
  border: 2px solid var(--border);
  border-radius: 5px;
  font-size: 0.85rem;
  text-align: center;
}

.percent-input::placeholder {
  color: var(--gray);
  font-size: 0.8rem;
}

.config-radio-group {
  display: flex;
  gap: 8px;
  align-items: center;
}

.config-radio-label {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 0.8rem;
  cursor: pointer;
}

.config-radio-label input[type="radio"] {
  accent-color: var(--primary);
}

.percent-value-display {
  font-weight: 600;
  padding: 4px 8px;
  border-radius: 4px;
  text-align: center;
  font-size: 0.85rem;
  background: white;
  border: 1px solid var(--border);
  min-height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.percent-value-display.mdr {
  color: #FF6B35;
  border-left: 3px solid #FF6B35;
}

.percent-value-display.tis {
  color: #17A2B8;
  border-left: 3px solid #17A2B8;
}

.percent-value-display.rebate {
  color: #A1CC4C;
  border-left: 3px solid #A1CC4C;
}

</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo-container">
        <img src="https://i.ibb.co/B2r5xtbS/sim-cred-5.png" class="logo" alt="SIM CRED">
        <div class="header-content">
          <h1>Sistema de Cadastros de Lojas</h1>
          <div class="subtitle">Situação e Acompanhamento de Lojas</div>
          <div class="version">
            <i class="fas fa-rocket"></i>
            Versão 2.0
          </div>
        </div>
      </div>
    </div>
    
    <div class="content">
      <div class="waitlabel-selector">
        <div class="waitlabel-title">
          <i class="fas fa-layer-group"></i>
          Selecione o White Label:
        </div>
        <div class="waitlabel-buttons" id="waitlabelButtons">
        </div>
      </div>

      <div class="action-buttons">
        <button type="button" class="btn btn-primary" onclick="mostrarTodosCadastros()">
          <i class="fas fa-store"></i>
          Ver Todos os Cadastros
        </button>
        <button type="button" class="btn btn-info" onclick="limparBusca()">
          <i class="fas fa-broom"></i>
          Limpar Busca
        </button>
      </div>

      <div class="card" id="cardCadastro">
        <div class="card-header">
          <i class="fas fa-info-circle"></i>
          <h2 class="card-title">Dados do Cadastro</h2>
          <div id="tituloAplicarTodos" style="display: none;"></div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-building"></i>
              Razão Social
            </label>
            <input type="text" id="razao_social" class="form-control">
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-signature"></i>
              Nome Fantasia
            </label>
            <input type="text" id="nome_fantasia" class="form-control">
          </div>
          
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-id-card"></i>
              CNPJ
            </label>
            <input type="text" id="cnpj_cadastro" class="form-control" 
                   placeholder="Digite o CNPJ para cadastro..."
                   oninput="formatarCNPJ(this)">
          </div>
          
          
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-file-contract"></i>
              Contrato Enviado
            </label>
            <select id="contrato_enviado" class="form-control">
              <option value="">-- Selecione --</option>
              <option value="SIM">SIM</option>
              <option value="NAO">NAO</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-file-signature"></i>
              Contrato Assinado
            </label>
            <select id="contrato_assinado" class="form-control">
              <option value="">-- Selecione --</option>
              <option value="SIM">SIM</option>
              <option value="NAO">NAO</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-play-circle"></i>
              Ativação
            </label>
            <input type="date" id="ativacao" class="form-control">
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-link"></i>
              Link
            </label>
            <input type="text" id="link" class="form-control" placeholder="https://...">
          </div>
          
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-money-bill-wave"></i>
              Mensalidade
            </label>
            <input type="text" id="mensalidade" class="form-control" placeholder="R$ 0,00" oninput="formatarMoeda(this)">
          </div>

          <div class="form-group">
            <label class="form-label" style="color: var(--primary); font-weight: 700;">
              <i class="fas fa-money-bill-wave" style="color: var(--primary);"></i>
              Mensalidade SIM
            </label>
            <input type="text" id="mensalidade_sim" name="mensalidade_sim" class="form-control" placeholder="R$ 0,00" oninput="formatarMoeda(this)">
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-handshake"></i>
              Adesão
            </label>
            <input type="text" id="adesao" class="form-control" placeholder="R$ 0,00" oninput="formatarMoeda(this)" value="R$ 0,00">
            <small style="color: var(--gray); font-size: 0.75rem;">
              <i class="fas fa-info-circle"></i> Valor "0,00" será salvo como "Isento"
            </small>
          </div>
          
          <div class="form-group">
            <label class="form-label obrigatorio">
              <i class="fas fa-flag"></i>
              Situação
            </label>
            <select id="situacao" class="form-control">
              <option value="NOVO REGISTRO">NOVO REGISTRO</option>
              <option value="CADASTRADO">CADASTRADO</option>
              <option value="EM ANDAMENTO">EM ANDAMENTO</option>
              <option value="REJEITADO">REJEITADO</option>
              <option value="DESCREDENCIADO">DESCREDENCIADO</option>
              <option value="DESISTIU">DESISTIU</option>
            </select>
          </div>

          <div class="form-group" style="grid-column: 1 / -1;">
            <label class="form-label">
              <i class="fas fa-truck"></i>
              Fornecedor(es) - <span style="color: var(--primary); font-weight: 600;">Selecione e configure cada um</span>
            </label>
            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 15px; border-radius: 10px; border: 2px dashed var(--primary);">
              
              <div class="fornecedor-item" style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                  <input type="checkbox" name="fornecedor" value="Agil" style="width: 18px; height: 18px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'agil')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1rem;">AGIL</span>
                </div>
                <div id="config-agil" style="display: none;" class="fornecedor-config-grid">
                  <div class="config-column">
                    <div class="config-label">MDR %</div>
                    <div class="config-input-group">
                      <input type="text" 
                        name="mdr_agil" 
                        class="percent-input"
                        placeholder="Ex: 0,00%"
                        oninput="formatarPercentual(this, 'mdr_agil_display')">
                    </div>
                    <div id="mdr_agil_display" class="percent-value-display mdr"></div>
                  </div>
                  <div class="config-column">
                    <div class="config-label">TIS %</div>
                    <div class="config-input-group">
                      <input type="text" 
                        name="tis_agil" 
                        class="percent-input"
                        placeholder="Ex: 0,00%"
                        oninput="formatarPercentual(this, 'tis_agil_display')">
                    </div>
                    <div id="tis_agil_display" class="percent-value-display tis"></div>
                  </div>
                  <div class="config-column">
                    <div class="config-label">Rebate %</div>
                    <div class="config-input-group">
                      <input type="text" 
                        name="rebate_agil" 
                        class="percent-input"
                        placeholder="Ex: 0,00%"
                        oninput="formatarPercentual(this, 'rebate_agil_display')">
                    </div>
                    <div id="rebate_agil_display" class="percent-value-display rebate"></div>
                  </div>
                </div>
              </div>

              <div class="fornecedor-item" style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                  <input type="checkbox" name="fornecedor" value="BC" style="width: 18px; height: 18px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'bc')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1rem;">BC</span>
                </div>
                <div id="config-bc" style="display: none;" class="fornecedor-config-grid">
                  <div class="config-column">
                    <div class="config-label">MDR %</div>
                    <div class="config-input-group">
                      <input type="text" 
                        name="mdr_bc" 
                        class="percent-input"
                        placeholder="Ex: 0,00%"
                        oninput="formatarPercentual(this, 'mdr_bc_display')">
                    </div>
                    <div id="mdr_bc_display" class="percent-value-display mdr"></div>
                  </div>
                  <div class="config-column">
                    <div class="config-label">TIS %</div>
                    <div class="config-input-group">
                      <input type="text" 
                        name="tis_bc" 
                        class="percent-input"
                        placeholder="Ex: 0,00%"
                        oninput="formatarPercentual(this, 'tis_bc_display')">
                    </div>
                    <div id="tis_bc_display" class="percent-value-display tis"></div>
                  </div>
                  <div class="config-column">
                    <div class="config-label">Rebate %</div>
                    <div class="config-input-group">
                      <input type="text" 
                        name="rebate_bc" 
                        class="percent-input"
                        placeholder="Ex: 0,00%"
                        oninput="formatarPercentual(this, 'rebate_bc_display')">
                    </div>
                    <div id="rebate_bc_display" class="percent-value-display rebate"></div>
                  </div>
                </div>
              </div>

              <div class="fornecedor-item" style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                  <input type="checkbox" name="fornecedor" value="Parcelex" style="width: 18px; height: 18px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'parcelex')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1rem;">PARCELEX</span>
                </div>
                <div id="config-parcelex" style="display: none;" class="fornecedor-config-grid">
                  <div class="config-column">
                    <div class="config-label">MDR %</div>
                    <div class="config-input-group">
                      <input type="text" 
                        name="mdr_parcelex" 
                        class="percent-input"
                        placeholder="Ex: 0,00%"
                        oninput="formatarPercentual(this, 'mdr_parcelex_display')">
                    </div>
                    <div id="mdr_parcelex_display" class="percent-value-display mdr"></div>
                  </div>
                  <div class="config-column">
                    <div class="config-label">TIS %</div>
                    <div class="config-input-group">
                      <input type="text" 
                        name="tis_parcelex" 
                        class="percent-input"
                        placeholder="Ex: 0,00%"
                        oninput="formatarPercentual(this, 'tis_parcelex_display')">
                    </div>
                    <div id="tis_parcelex_display" class="percent-value-display tis"></div>
                  </div>
                  <div class="config-column">
                    <div class="config-label">Rebate %</div>
                    <div class="config-input-group">
                      <input type="text" 
                        name="rebate_parcelex" 
                        class="percent-input"
                        placeholder="Ex: 0,00%"
                        oninput="formatarPercentual(this, 'rebate_parcelex_display')">
                    </div>
                    <div id="rebate_parcelex_display" class="percent-value-display rebate"></div>
                  </div>
                </div>
              </div>

              <div class="fornecedor-item" style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                  <input type="checkbox" name="fornecedor" value="Agoracred" style="width: 18px; height: 18px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'agoracred')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1rem;">AGORACRED</span>
                </div>
                <div id="config-agoracred" style="display: none;" class="fornecedor-config-grid">
                  <div class="config-column">
                    <div class="config-label">MDR %</div>
                    <div class="config-input-group">
                      <input type="text" 
                        name="mdr_agoracred" 
                        class="percent-input"
                        placeholder="Ex: 0,00%"
                        oninput="formatarPercentual(this, 'mdr_agoracred_display')">
                    </div>
                    <div id="mdr_agoracred_display" class="percent-value-display mdr"></div>
                  </div>
                  <div class="config-column">
                    <div class="config-label">TIS %</div>
                    <div class="config-input-group">
                      <input type="text" 
                        name="tis_agoracred" 
                        class="percent-input"
                        placeholder="Ex: 0,00%"
                        oninput="formatarPercentual(this, 'tis_agoracred_display')">
                    </div>
                    <div id="tis_agoracred_display" class="percent-value-display tis"></div>
                  </div>
                  <div class="config-column">
                    <div class="config-label">Rebate %</div>
                    <div class="config-input-group">
                      <input type="text" 
                        name="rebate_agoracred" 
                        class="percent-input"
                        placeholder="Ex: 0,00%"
                        oninput="formatarPercentual(this, 'rebate_agoracred_display')">
                    </div>
                    <div id="rebate_agoracred_display" class="percent-value-display rebate"></div>
                  </div>
                </div>
              </div>

              <div class="fornecedor-item" style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                  <input type="checkbox" name="fornecedor" value="Afinz" style="width: 18px; height: 18px; accent-color: var(--primary);" onchange="toggleFornecedorConfig(this, 'afinz')">
                  <span style="font-weight: 600; color: var(--dark); font-size: 1rem;">AFINZ</span>
                </div>
                <div id="config-afinz" style="display: none;" class="fornecedor-config-grid">
                  <div class="config-column">
                    <div class="config-label">MDR %</div>
                    <div class="config-input-group">
                      <input type="text" 
                        name="mdr_afinz" 
                        class="percent-input"
                        placeholder="Ex: 0,00%"
                        oninput="formatarPercentual(this, 'mdr_afinz_display')">
                    </div>
                    <div id="mdr_afinz_display" class="percent-value-display mdr"></div>
                  </div>
                  <div class="config-column">
                    <div class="config-label">TIS %</div>
                    <div class="config-input-group">
                      <input type="text" 
                        name="tis_afinz" 
                        class="percent-input"
                        placeholder="Ex: 0,00%"
                        oninput="formatarPercentual(this, 'tis_afinz_display')">
                    </div>
                    <div id="tis_afinz_display" class="percent-value-display tis"></div>
                  </div>
                  <div class="config-column">
                    <div class="config-label">Rebate %</div>
                    <div class="config-input-group">
                      <input type="text" 
                        name="rebate_afinz" 
                        class="percent-input"
                        placeholder="Ex: 0,00%"
                        oninput="formatarPercentual(this, 'rebate_afinz_display')">
                    </div>
                    <div id="rebate_afinz_display" class="percent-value-display rebate"></div>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <div class="form-group" id="etapaFormGroup">
            <label class="form-label">
              <i class="fas fa-calendar-check"></i>
              Etapa
            </label>
            
            <select id="etapa" class="form-control" style="display: none;">
              <option value="">-- Selecione uma etapa --</option>
            </select>
            
            <div style="position: relative; width: 100%;">
              <input type="text" 
                     id="inputEtapaSearch" 
                     class="form-control" 
                     placeholder="Digite para buscar etapa..."
                     oninput="filtrarSugestoesEtapaSearch()"
                     style="padding-right: 35px; width: 100%; min-width: 350px;">
              
              <div class="suggestions-etapa" id="suggestionsEtapaSearch" style="display: none;">
              </div>
            </div>

            <div class="checkbox-aplicar-todos">
              <input type="checkbox" id="check_etapas" data-campo="inputEtapaSearch" onchange="toggleCampoParaTodos('inputEtapaSearch')">
              <label for="check_etapas">
                  <i class="fas fa-copy"></i> Aplicar Etapa a todos
              </label>
            </div>
          </div>

          <div class="form-group" style="display: flex; justify-content: flex-end;">
            <div style="width: 95%;">
              <label class="form-label">
                <i class="fas fa-sticky-note"></i>
                Observação
              </label>
              <textarea id="observacoes" class="form-control" rows="3" style="width: 100%;"></textarea>
            </div>
          </div>

          <div class="btn-group" style="justify-content: flex-end; margin-left: auto; width: fit-content;">
            <button type="button" class="btn btn-success" onclick="cadastrar()" id="btnCadastrar">
              <i class="fas fa-plus-circle"></i>
              Cadastrar
            </button>
            <button type="button" class="btn btn-warning" onclick="atualizar()" id="btnAtualizar" style="display: none;">
              <i class="fas fa-save"></i>
              Atualizar
            </button>

            <button type="button" class="btn btn-aplicar-todos" id="btnAplicarATodos" onclick="aplicarAlteracoesATodos()" style="display: none;">
              <i class="fas fa-copy"></i>
              Aplicar a Todos
            </button>
          </div>
        </div>
      </div>

      <div class="cadastros-container" id="secaoCadastros" style="display: none;">
        <div class="card-header">
          <i class="fas fa-store"></i>
          <h2 class="card-title" id="tituloCadastros">Todos os Cadastros</h2>
          <span class="contador-lojas" id="contadorCadastros">0 cadastros</span>
        </div>

        <div class="search-container">
          <input type="text" id="pesquisaCadastros" class="form-control" 
                 placeholder="🔍 Pesquisar por nome, CNPJ, fornecedor, etapa..."
                 oninput="filtrarPesquisa()">
        </div>

        <div class="filtros-container" id="filtrosContainer" style="display: none;">
          <button type="button" class="filtro-btn active" data-situacao="all" onclick="aplicarFiltroSituacao('all')">
            Todos
          </button>
          <button type="button" class="filtro-btn" data-situacao="NOVO REGISTRO" onclick="aplicarFiltroSituacao('NOVO REGISTRO')">
            Novo Registro
          </button>
          <button type="button" class="filtro-btn" data-situacao="CADASTRADO" onclick="aplicarFiltroSituacao('CADASTRADO')">
            Cadastrado
          </button>
          <button type="button" class="filtro-btn" data-situacao="EM ANDAMENTO" onclick="aplicarFiltroSituacao('EM ANDAMENTO')">
            Em Andamento
          </button>
          <button type="button" class="filtro-btn" data-situacao="REJEITADO" onclick="aplicarFiltroSituacao('REJEITADO')">
            Rejeitado
          </button>
          <button type="button" class="filtro-btn" data-situacao="DESCREDENCIADO" onclick="aplicarFiltroSituacao('DESCREDENCIADO')">
            Descredenciado
          </button>
          <button type="button" class="filtro-btn" data-situacao="DESISTIU" onclick="aplicarFiltroSituacao('DESISTIU')">
            Desistiu
          </button>
          
          <button type="button" class="btn btn-info btn-sm" onclick="recarregarCadastros()" style="margin-left: auto;">
            <i class="fas fa-sync-alt"></i> Atualizar
          </button>
        </div>

        <div class="filtros-avancados" id="filtrosAvancadosContainer" style="display: none;">
          <div class="filtro-group">
            <label class="filtro-label">📅 Filtrar por Etapa:</label>
            <div class="filtro-multiselect-container">
              <input type="text" id="filtroEtapa" class="form-control" 
                     placeholder="Digite para buscar etapas..." 
                     oninput="filtrarSugestoesEtapa()"
                     onfocus="mostrarSugestoesEtapa()">
              <div class="suggestions" id="suggestionsEtapa"></div>
              <div class="tags-selecionadas" id="etapasSelecionados"></div>
            </div>
          </div>
          
          <div class="filtro-group">
            <label class="filtro-label">🚚 Filtrar por Fornecedor:</label>
            <div class="filtro-multiselect-container">
              <input type="text" id="filtroFornecedor" class="form-control" 
                     placeholder="Digite para buscar fornecedores..." 
                     oninput="filtrarSugestoesFornecedor()"
                     onfocus="mostrarSugestoesFornecedor()">
              <div class="suggestions" id="suggestionsFornecedor"></div>
              <div class="tags-selecionadas" id="fornecedoresSelecionados"></div>
            </div>
          </div>
          
          <div class="filtro-group">
            <label class="filtro-label">📊 Ordenar por:</label>
            <select id="ordenacaoCadastros" class="form-select" onchange="ordenarCadastros()">
            <option value="razao_social" selected>Razão Social (A-Z)</option>
            <option value="razao_social_desc">Razão Social (Z-A)</option>
            <option value="nome_fantasia">Nome Fantasia (A-Z)</option>
            <option value="nome_fantasia_desc">Nome Fantasia (Z-A)</option>
            <option value="situacao">Situação</option>
            <option value="fornecedor">Fornecedor</option>
            <option value="mensalidade">Mensalidade (Maior)</option>
            <option value="mensalidade_asc">Mensalidade (Menor)</option>
            <option value="mensalidade_sim">Mensalidade SIM (Maior)</option>
            <option value="mensalidade_sim_asc">Mensalidade SIM (Menor)</option>
            <option value="adesao">Adesão (Maior)</option>
            <option value="adesao_asc">Adesão (Menor)</option>
            <option value="defasagem">Defasagem (Maior)</option>
            <option value="defasagem_asc">Defasagem (Menor)</option>
          </select>
          </div>

          <div class="filtro-group">
            <label class="filtro-label">🧹 Limpar Filtros:</label>
            <button type="button" class="btn btn-outline btn-sm" onclick="limparTodosFiltros()" style="margin-top: 6px;">
              <i class="fas fa-broom"></i> Limpar Tudo
            </button>
          </div>
        </div>

        <div class="filtros-ativos" id="filtrosAtivosContainer" style="display: none;"></div>

        <div class="loading-container" id="loadingCadastros" style="display: none;">
          <div class="loading-spinner"></div>
          <p>Carregando cadastros...</p>
        </div>
        
        <div class="table-container" id="tableContainer" style="display: none;">
          <div class="table-responsive">
            <table class="data-table" id="tabelaCadastros">
              <thead>
  <tr>
    <th>Razão Social</th>
    <th>CNPJ</th>
    <th>Fornecedor</th>
    <th>Situação</th>
    <th>Última Etapa</th>
    <th>Defasagem</th>
    <th>Mensalidade</th>
    <th>Mensalidade SIM</th>
    <th>Adesão</th>
    <th>Ações</th>
  </tr>
</thead>
              <tbody id="tabelaCadastrosBody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div id="messageSuccess" class="message success" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <span></span>
      </div>
      
      <div id="messageError" class="message error" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span></span>
      </div>

      <div id="messageInfo" class="message info" style="display: none;">
        <i class="fas fa-info-circle"></i>
        <span></span>
      </div>
    </div>
  </div>

  <!-- MODAIS E POPUPS -->
  <div id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner-large"></div>
      <p class="loading-text">Salvando dados...</p>
      <p class="loading-subtext">Aguarde um momento</p>
    </div>
  </div>

  <div id="modalDetalhes" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">📋 Detalhes do Cadastro</h3>
        <button class="btn-close" onclick="fecharModalDetalhes()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div id="modalDetalhesContent">
      </div>

      <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
        <button class="btn btn-primary" onclick="fecharModalDetalhes()">
          <i class="fas fa-check"></i> Fechar
        </button>
      </div>
    </div>
  </div>

  <div id="modalFornecedores" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">🏪 Todos os Fornecedores</h3>
        <button class="btn-close" onclick="fecharModalFornecedores()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div id="modalFornecedoresContent">
      </div>

      <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
        <button class="btn btn-primary" onclick="fecharModalFornecedores()">
          <i class="fas fa-check"></i> Fechar
        </button>
      </div>
    </div>
  </div>

  <div id="modalSenha" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">🔒 Acesso Restrito</h3>
        <button class="btn-close" onclick="fecharModalSenha()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div style="padding: 15px;">
        <p>Para editar este campo é necessário informar a senha:</p>
        <input type="password" id="inputSenha" class="form-control" placeholder="Digite a senha" style="margin: 12px 0;">
        <div class="btn-group">
          <button class="btn btn-primary" onclick="validarSenha()">
            <i class="fas fa-check"></i> Validar
          </button>
          <button class="btn btn-outline" onclick="fecharModalSenha()">
            <i class="fas fa-times"></i> Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- POPUP Carregando Lojas -->
  <div id="popupCarregandoLojas" class="popup-carregamento">
    <div class="popup-conteudo">
      <div class="popup-spinner"></div>
      <p class="popup-texto">Carregando Lojas</p>
      <p class="popup-subtexto">Buscando informações no sistema...</p>
    </div>
  </div>

  <!-- POPUP Carregando Modal -->
  <div id="popupCarregandoModal" class="popup-carregamento">
    <div class="popup-conteudo">
      <div class="popup-spinner"></div>
      <p class="popup-texto">Abrindo Detalhes</p>
      <p class="popup-subtexto">Carregando informações completas...</p>
    </div>
  </div>

  <!-- POPUP Atualizando -->
  <div id="popupAtualizando" class="popup-carregamento">
    <div class="popup-conteudo">
      <div class="popup-spinner"></div>
      <p class="popup-texto">Atualizando Dados</p>
      <p class="popup-subtexto">Salvando alterações...</p>
    </div>
  </div>

  <script>
// VARIÁVEIS GLOBAIS
let camposParaAplicarATodos = {};
let cnpjAtualParaAplicar = null;
let cadastroAtualId = null;
let todosCadastros = [];
let cadastrosFiltrados = [];
let campoEditavel = null;
const SENHA_PERMITIDA = '519901';
let waitlabelAtual = 'Sim_Facilita';

let filtrosAtivos = {};
let situacaoAtiva = 'all';
let etapasSelecionados = [];
let fornecedoresSelecionados = [];

let cadastroAtualModalId = null;

const WAITLABELS_CONFIG = {
  WAITLABELS: ['Sim_Facilita', 'Result', 'Set_9', 'Doktorbank', 'Dr_Parcela'],
  CORES: {
    'Sim_Facilita': '#7E3E9A',
    'Result': '#2EBE76', 
    'Set_9': '#0682c5',
    'Doktorbank': '#E61B72',
    'Dr_Parcela': '#696969'
  }
};

const etapasPendenteFornecedor = [
  "PENDENTE FORNECEDOR(ES)"
];

const etapasPendenteSIM = [
  "PENDENTE SIM"
];

const etapasPendenteRetornoExterno = [
  "PENDENTE RETORNO EXTERNO"
];

const etapasDisponiveis = [
  ...etapasPendenteFornecedor,
  ...etapasPendenteSIM,
  ...etapasPendenteRetornoExterno
];

const fornecedoresDisponiveis = [
  "AGIL", "BC", "PARCELEX", "AGORACRED", "AFINZ"
].sort();

// FUNÇÕES PRINCIPAIS
document.addEventListener('DOMContentLoaded', function() {
  console.log('Sistema de Gestão de Cadastros - RESULT inicializado');
  
  inicializarWaitlabels();
  
  document.getElementById('mensalidade').value = 'R$ 0,00';
  document.getElementById('situacao').value = 'CADASTRADO';
  
  configurarValidacaoEmTempoReal();
  document.getElementById('situacao').addEventListener('change', atualizarEtapas);
  atualizarEtapas();
  
  setTimeout(() => {
    configurarCamposProtegidos();
  }, 500);
  
  configurarModalSenha();
  
  const inputEtapa = document.getElementById('inputEtapaSearch');
  if (inputEtapa) {
    inputEtapa.addEventListener('focus', function() {
      filtrarSugestoesEtapaSearch();
    });
    
    inputEtapa.addEventListener('input', function() {
      filtrarSugestoesEtapaSearch();
    });
  }
  
  configurarEventosFiltro();
  
  const cnpjInput = document.getElementById('cnpj_cadastro');
  if (cnpjInput) {
    cnpjInput.addEventListener('input', function() {
      formatarCNPJ(this);
    });
    
    cnpjInput.addEventListener('paste', function(e) {
      setTimeout(() => {
        formatarCNPJ(this);
      }, 100);
    });
  }

  const selectSituacao = document.getElementById('situacao');
  
  if (selectSituacao) {
    selectSituacao.addEventListener('change', function() {
      const situacaoSelecionada = this.value;
      const isAtualizacao = cadastroAtualId !== null;
      const isAplicarATodos = Object.keys(camposParaAplicarATodos).some(campo => camposParaAplicarATodos[campo]);
      
      if (isAtualizacao || isAplicarATodos) {
        const situacaoUpper = situacaoSelecionada ? situacaoSelecionada.toUpperCase().trim() : '';
        
        if (situacaoUpper !== 'NOVO REGISTRO' && situacaoUpper !== 'EM ANDAMENTO') {
          document.getElementById('inputEtapaSearch').value = situacaoSelecionada;
          document.getElementById('etapa').value = situacaoSelecionada;
          
          const checkboxEtapa = document.querySelector('[data-campo="inputEtapaSearch"]');
          if (checkboxEtapa && !checkboxEtapa.checked) {
            checkboxEtapa.checked = true;
            camposParaAplicarATodos['inputEtapaSearch'] = true;
          }
          
          document.getElementById('suggestionsEtapaSearch').style.display = 'none';
        } else {
          document.getElementById('inputEtapaSearch').value = '';
          document.getElementById('etapa').value = '';
          
          const checkboxEtapa = document.querySelector('[data-campo="inputEtapaSearch"]');
          if (checkboxEtapa && checkboxEtapa.checked) {
            checkboxEtapa.checked = false;
            camposParaAplicarATodos['inputEtapaSearch'] = false;
          }
        }
      }
    });
  }

  document.addEventListener('click', function(e) {
    const suggestionsSearch = document.getElementById('suggestionsEtapaSearch');
    const inputSearch = document.getElementById('inputEtapaSearch');
    
    if (suggestionsSearch && suggestionsSearch.style.display === 'block') {
      if (!inputSearch.contains(e.target) && !suggestionsSearch.contains(e.target)) {
        suggestionsSearch.style.display = 'none';
      }
    }
  });

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const suggestionsSearch = document.getElementById('suggestionsEtapaSearch');
      if (suggestionsSearch) {
        suggestionsSearch.style.display = 'none';
      }
    }
  });
});

function configurarEventosFiltro() {
  const inputEtapa = document.getElementById('filtroEtapa');
  const inputFornecedor = document.getElementById('filtroFornecedor');
  
  inputEtapa.addEventListener('focus', function() {
    setTimeout(() => {
      mostrarSugestoesEtapaFiltro();
    }, 100);
  });
  
  inputFornecedor.addEventListener('focus', function() {
    setTimeout(() => {
      mostrarSugestoesFornecedorFiltro();
    }, 100);
  });
  
  document.addEventListener('click', function(e) {
    const suggestionsEtapa = document.getElementById('suggestionsEtapa');
    const suggestionsFornecedor = document.getElementById('suggestionsFornecedor');
    
    if (suggestionsEtapa && suggestionsEtapa.style.display === 'block') {
      const isClickInInput = inputEtapa.contains(e.target);
      const isClickInSuggestions = suggestionsEtapa.contains(e.target);
      
      if (!isClickInInput && !isClickInSuggestions) {
        suggestionsEtapa.style.display = 'none';
      }
    }
    
    if (suggestionsFornecedor && suggestionsFornecedor.style.display === 'block') {
      const isClickInInput = inputFornecedor.contains(e.target);
      const isClickInSuggestions = suggestionsFornecedor.contains(e.target);
      
      if (!isClickInInput && !isClickInSuggestions) {
        suggestionsFornecedor.style.display = 'none';
      }
    }
  });
  
  inputEtapa.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.getElementById('suggestionsEtapa').style.display = 'none';
    }
    if (e.key === 'Enter') {
      e.preventDefault();
      const texto = inputEtapa.value.trim();
      if (texto && !etapasSelecionados.includes(texto.toUpperCase())) {
        adicionarEtapa(texto.toUpperCase());
      }
      inputEtapa.value = '';
      document.getElementById('suggestionsEtapa').style.display = 'none';
    }
  });
  
  inputFornecedor.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.getElementById('suggestionsFornecedor').style.display = 'none';
    }
    if (e.key === 'Enter') {
      e.preventDefault();
      const texto = inputFornecedor.value.trim();
      if (texto && !fornecedoresSelecionados.includes(texto.toUpperCase())) {
        adicionarFornecedor(texto.toUpperCase());
      }
      inputFornecedor.value = '';
      document.getElementById('suggestionsFornecedor').style.display = 'none';
    }
  });
}

function mostrarSugestoesEtapaFiltro() {
    const input = document.getElementById('filtroEtapa');
    const suggestions = document.getElementById('suggestionsEtapa');
    
    const todasEtapas = [
        ...etapasPendenteFornecedor,
        ...etapasPendenteSIM,
        ...etapasPendenteRetornoExterno
    ];
    
    let html = '';
    
    todasEtapas.forEach(etapa => {
        const jaSelecionado = etapasSelecionados.includes(etapa);
        
        let icone = "fas fa-calendar-check";
        let cor = "#7E3E9A";
        
        if (etapasPendenteFornecedor.includes(etapa)) {
          icone = "fas fa-truck";
          cor = "#FF6B35";
        } else if (etapasPendenteSIM.includes(etapa)) {
          icone = "fas fa-building";
          cor = "#7E3E9A";
        } else if (etapasPendenteRetornoExterno.includes(etapa)) {
          icone = "fas fa-undo-alt";
          cor = "#0682c5";
        }
        
        html += `
            <div class="suggestion-item ${jaSelecionado ? 'selecionado' : ''}" 
                 onclick="selecionarEtapaFiltro('${etapa.replace(/'/g, "\\'")}')"
                 data-etapa="${etapa}">
                <i class="${icone}" style="color: ${cor}"></i>
                <span>${etapa}</span>
                ${jaSelecionado ? '<i class="fas fa-check" style="margin-left: auto; color: var(--success);"></i>' : ''}
            </div>
        `;
    });
    
    suggestions.innerHTML = html;
    suggestions.style.display = 'block';
}

function selecionarEtapaFiltro(etapa) {
    if (!etapasSelecionados.includes(etapa)) {
        etapasSelecionados.push(etapa);
        atualizarEtapasSelecionados();
        aplicarFiltroEtapas();
    }
    
    document.getElementById('suggestionsEtapa').style.display = 'none';
    document.getElementById('filtroEtapa').value = '';
}

function mostrarSugestoesFornecedorFiltro() {
    const input = document.getElementById('filtroFornecedor');
    const suggestions = document.getElementById('suggestionsFornecedor');
    
    let html = '';
    
    fornecedoresDisponiveis.forEach(fornecedor => {
        const jaSelecionado = fornecedoresSelecionados.includes(fornecedor);
        
        html += `
            <div class="suggestion-item ${jaSelecionado ? 'selecionado' : ''}" 
                 onclick="selecionarFornecedorFiltro('${fornecedor}')"
                 data-fornecedor="${fornecedor}">
                <i class="fas fa-truck" style="color: var(--secondary)"></i>
                <span>${fornecedor}</span>
                ${jaSelecionado ? '<i class="fas fa-check" style="margin-left: auto; color: var(--success);"></i>' : ''}
            </div>
        `;
    });
    
    suggestions.innerHTML = html;
    suggestions.style.display = 'block';
}

function selecionarFornecedorFiltro(fornecedor) {
    if (!fornecedoresSelecionados.includes(fornecedor)) {
        fornecedoresSelecionados.push(fornecedor);
        atualizarFornecedoresSelecionados();
        aplicarFiltroFornecedores();
    }
    
    document.getElementById('suggestionsFornecedor').style.display = 'none';
    document.getElementById('filtroFornecedor').value = '';
}

function filtrarSugestoesEtapa() {
  const input = document.getElementById('filtroEtapa');
  const suggestions = document.getElementById('suggestionsEtapa');
  const termo = input.value.toLowerCase().trim();
  
  if (termo.length < 1) {
    suggestions.style.display = 'none';
    return;
  }
  
  const etapasUnicos = [...new Set(etapasDisponiveis)];
  const etapasFiltrados = etapasUnicos.filter(etapa => 
    etapa.toLowerCase().includes(termo) && !etapasSelecionados.includes(etapa)
  );
  
  if (etapasFiltrados.length === 0) {
    suggestions.innerHTML = `
      <div class="suggestion-item" style="color: var(--gray);">
        <i class="fas fa-search"></i> Nenhuma etapa encontrada
      </div>
    `;
  } else {
    let html = etapasFiltrados.map(etapa => `
      <div class="suggestion-item" onclick="adicionarEtapa('${etapa.replace(/'/g, "\\'")}')">
        <i class="fas fa-calendar-check"></i> ${etapa}
      </div>
    `).join('');
    
    suggestions.innerHTML = html;
  }
  
  suggestions.style.display = 'block';
}

function adicionarEtapa(etapa) {
  if (!etapasSelecionados.includes(etapa)) {
    etapasSelecionados.push(etapa);
    atualizarEtapasSelecionados();
    aplicarFiltroEtapas();
  }
  
  document.getElementById('filtroEtapa').value = '';
  document.getElementById('suggestionsEtapa').style.display = 'none';
}

function removerEtapa(etapa) {
  etapasSelecionados = etapasSelecionados.filter(e => e !== etapa);
  atualizarEtapasSelecionados();
  aplicarFiltroEtapas();
}

function atualizarEtapasSelecionados() {
  const container = document.getElementById('etapasSelecionados');
  
  if (etapasSelecionados.length === 0) {
    container.innerHTML = '';
    container.style.display = 'none';
    return;
  }
  
  container.style.display = 'flex';
  container.innerHTML = etapasSelecionados.map(etapa => `
    <div class="tag">
      <i class="fas fa-calendar"></i> ${etapa}
      <button class="remover" onclick="removerEtapa('${etapa}')">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `).join('');
}

function aplicarFiltroEtapas() {
  if (etapasSelecionados.length > 0) {
    filtrosAtivos.etapas = etapasSelecionados;
  } else {
    delete filtrosAtivos.etapas;
  }
  aplicarTodosFiltros();
}

function mostrarSugestoesFornecedor() {
  const input = document.getElementById('filtroFornecedor');
  if (input.value.trim().length > 0) {
    filtrarSugestoesFornecedor();
  }
}

function filtrarSugestoesFornecedor() {
  const input = document.getElementById('filtroFornecedor');
  const suggestions = document.getElementById('suggestionsFornecedor');
  const termo = input.value.toLowerCase().trim();
  
  if (termo.length < 1) {
    suggestions.style.display = 'none';
    return;
  }
  
  const fornecedoresFiltrados = fornecedoresDisponiveis.filter(fornecedor => 
    fornecedor.toLowerCase().includes(termo) && !fornecedoresSelecionados.includes(fornecedor)
  );
  
  if (fornecedoresFiltrados.length === 0) {
    suggestions.innerHTML = `
      <div class="suggestion-item" style="color: var(--gray);">
        <i class="fas fa-search"></i> Nenhum fornecedor encontrado
      </div>
    `;
  } else {
    let html = fornecedoresFiltrados.map(fornecedor => `
      <div class="suggestion-item" onclick="adicionarFornecedor('${fornecedor}')">
        <i class="fas fa-truck"></i> ${fornecedor}
      </div>
    `).join('');
    
    suggestions.innerHTML = html;
  }
  
  suggestions.style.display = 'block';
}

function adicionarFornecedor(fornecedor) {
  if (!fornecedoresSelecionados.includes(fornecedor)) {
    fornecedoresSelecionados.push(fornecedor);
    atualizarFornecedoresSelecionados();
    aplicarFiltroFornecedores();
  }
  
  document.getElementById('filtroFornecedor').value = '';
  document.getElementById('suggestionsFornecedor').style.display = 'none';
}

function removerFornecedor(fornecedor) {
  fornecedoresSelecionados = fornecedoresSelecionados.filter(f => f !== fornecedor);
  atualizarFornecedoresSelecionados();
  aplicarFiltroFornecedores();
}

function atualizarFornecedoresSelecionados() {
  const container = document.getElementById('fornecedoresSelecionados');
  
  if (fornecedoresSelecionados.length === 0) {
    container.innerHTML = '';
    container.style.display = 'none';
    return;
  }
  
  container.style.display = 'flex';
  container.innerHTML = fornecedoresSelecionados.map(fornecedor => `
    <div class="tag fornecedor">
      <i class="fas fa-truck"></i> ${fornecedor}
      <button class="remover" onclick="removerFornecedor('${fornecedor}')">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `).join('');
}

function aplicarFiltroFornecedores() {
  if (fornecedoresSelecionados.length > 0) {
    filtrosAtivos.fornecedores = fornecedoresSelecionados;
  } else {
    delete filtrosAtivos.fornecedores;
  }
  aplicarTodosFiltros();
}

function aplicarTodosFiltros() {
  let resultado = [...todosCadastros];
  
  if (filtrosAtivos.situacao) {
    resultado = resultado.filter(cadastro => 
      cadastro.situacao === filtrosAtivos.situacao
    );
  }
  
  if (filtrosAtivos.etapas && filtrosAtivos.etapas.length > 0) {
    resultado = resultado.filter(cadastro => 
      filtrosAtivos.etapas.some(etapa => 
        cadastro.etapa && cadastro.etapa.toUpperCase().includes(etapa)
      )
    );
  }
  
  if (filtrosAtivos.fornecedores && filtrosAtivos.fornecedores.length > 0) {
    resultado = resultado.filter(cadastro => 
      filtrosAtivos.fornecedores.includes(cadastro.fornecedor)
    );
  }
  
  if (filtrosAtivos.pesquisa) {
    resultado = resultado.filter(cadastro => 
      (cadastro.razao_social && cadastro.razao_social.toLowerCase().includes(filtrosAtivos.pesquisa)) ||
      (cadastro.nome_fantasia && cadastro.nome_fantasia.toLowerCase().includes(filtrosAtivos.pesquisa)) ||
      (cadastro.cnpj && cadastro.cnpj.includes(filtrosAtivos.pesquisa)) ||
      (cadastro.fornecedor && cadastro.fornecedor.toLowerCase().includes(filtrosAtivos.pesquisa)) ||
      (cadastro.etapa && cadastro.etapa.toLowerCase().includes(filtrosAtivos.pesquisa))
    );
  }
  
  cadastrosFiltrados = resultado;
  
  const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosFiltrados);
  
  cadastrosAgrupados.sort((a, b) => {
    const razaoA = a.razao_social || '';
    const razaoB = b.razao_social || '';
    return razaoA.localeCompare(razaoB, 'pt-BR', { sensitivity: 'base' });
  });
  
  exibirTabelaCadastrosAgrupada(cadastrosAgrupados, 'Cadastros Filtrados');
}

function aplicarFiltroSituacao(situacao) {
  document.querySelectorAll('.filtro-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  if (situacao !== situacaoAtiva) {
    const btnAtivo = document.querySelector(`.filtro-btn[data-situacao="${situacao}"]`);
    if (btnAtivo) {
      btnAtivo.classList.add('active');
    }
    situacaoAtiva = situacao;
  } else {
    situacaoAtiva = 'all';
    const btnTodos = document.querySelector('.filtro-btn[data-situacao="all"]');
    if (btnTodos) {
      btnTodos.classList.add('active');
    }
  }

  if (situacaoAtiva === 'all') {
    delete filtrosAtivos.situacao;
  } else {
    filtrosAtivos.situacao = situacaoAtiva;
  }
  
  document.getElementById('ordenacaoCadastros').value = 'razao_social';
  aplicarTodosFiltros();
}

function limparTodosFiltros() {
  filtrosAtivos = {};
  situacaoAtiva = 'all';
  etapasSelecionados = [];
  fornecedoresSelecionados = [];
  document.getElementById('pesquisaCadastros').value = '';
  
  document.getElementById('ordenacaoCadastros').value = 'razao_social';
  
  document.getElementById('filtroEtapa').value = '';
  document.getElementById('filtroFornecedor').value = '';
  
  document.querySelectorAll('.filtro-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector('.filtro-btn[data-situacao="all"]').classList.add('active');
  
  atualizarEtapasSelecionados();
  atualizarFornecedoresSelecionados();
  
  aplicarTodosFiltros();
}

function formatarCNPJ(input) {
    let value = input.value.replace(/\D/g, '');
    
    if (value.length <= 14) {
        if (value.length > 12) {
            value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2})/, '$1.$2.$3/$4-$5');
        } else if (value.length > 8) {
            value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{0,4})/, '$1.$2.$3/$4');
        } else if (value.length > 5) {
            value = value.replace(/^(\d{2})(\d{3})(\d{0,3})/, '$1.$2.$3');
        } else if (value.length > 2) {
            value = value.replace(/^(\d{2})(\d{0,3})/, '$1.$2');
        }
    }
    
    input.value = value;
}

function verTodosFornecedores(cnpj) {
  mostrarPopupCarregandoModal();
  
  const lojasDoCNPJ = todosCadastros.filter(cadastro => cadastro.cnpj === cnpj);
  
  setTimeout(() => {
    esconderPopupCarregandoModal();
    exibirModalFornecedores(cnpj, lojasDoCNPJ);
  }, 500);
}
function exibirModalFornecedores(cnpj, lojas) {
    const modal = document.getElementById('modalFornecedores');
    const content = document.getElementById('modalFornecedoresContent');
    
    let lojasHTML = '';
    
    let mensalidadeCNPJ = 'R$ 0,00';
    let mensalidadeSimCNPJ = 'R$ 0,00';
    let adesaoCNPJ = 'Isento';
    
    if (lojas && lojas.length > 0) {
        for (const loja of lojas) {
            if (mensalidadeCNPJ === 'R$ 0,00' && loja.mensalidade && loja.mensalidade !== 'R$ 0,00' && loja.mensalidade !== 0) {
                mensalidadeCNPJ = formatarMoedaParaInput(loja.mensalidade);
            }
            
            if (mensalidadeSimCNPJ === 'R$ 0,00' && loja.mensalidade_sim && loja.mensalidade_sim !== 'R$ 0,00' && loja.mensalidade_sim !== 0) {
                mensalidadeSimCNPJ = formatarMoedaParaInput(loja.mensalidade_sim);
            }
            
            if (adesaoCNPJ === 'Isento' && loja.adesao && loja.adesao !== 'Isento' && loja.adesao !== 0) {
                adesaoCNPJ = formatarMoedaParaInput(loja.adesao);
            }
            
            if (mensalidadeCNPJ !== 'R$ 0,00' && mensalidadeSimCNPJ !== 'R$ 0,00' && adesaoCNPJ !== 'Isento') {
                break;
            }
        }
        
        lojasHTML = lojas.map((loja, index) => {
            const ultimaEtapaCorrigida = loja.ultima_etapa ? 
                corrigirHoraFrontend(loja.ultima_etapa) : 'N/A';
            
            const situacaoClass = getSituacaoClass(loja.situacao);
            const corBorda = getCorBordaSituacao(loja.situacao);
            
            return `
            <div class="modal-fornecedor-card" style="border-left: 4px solid ${corBorda}; margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <div class="modal-fornecedor-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                <div class="fornecedor-badge" style="background: var(--primary); color: white; padding: 8px 12px; border-radius: 6px; font-weight: 700;">
                  <span class="fornecedor-indice" style="display: block; text-align: center;">#${index + 1}</span>
                </div>
                <div class="fornecedor-title" style="display: flex; align-items: center; gap: 10px; flex: 1; margin-left: 15px;">
                  <i class="fas fa-store" style="color: var(--primary);"></i>
                  <div>
                    <h4 class="modal-fornecedor-nome" style="margin: 0; color: var(--dark); font-size: 1.1rem;">${loja.fornecedor || 'Fornecedor'}</h4>
                    <div class="fornecedor-subinfo">
                      <span class="info-tag" style="background: rgba(0,0,0,0.05); padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; color: var(--gray);">
                        <i class="fas fa-info-circle"></i>
                        ${loja.situacao || 'N/A'}
                      </span>
                    </div>
                  </div>
                </div>
                <span class="status-badge ${situacaoClass}" 
          style="background: ${corBorda}; color: white;">
      ${loja.situacao || 'N/A'}
    </span>
              </div>
              
              <div class="modal-fornecedor-info-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 15px;">
                <div class="modal-info-item" style="display: flex; flex-direction: column; gap: 5px; padding: 10px; background: white; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="info-icon" style="font-size: 1.2rem; color: var(--primary);">📅</div>
                    <span class="modal-info-label" style="font-size: 0.8rem; color: var(--gray);">Data Ativação</span>
                  </div>
                  <span class="modal-info-value" style="font-weight: 600; color: var(--success); font-size: 0.9rem;">${formatarDataParaExibicao(loja.ativacao) || 'N/A'}</span>
                </div>
                
                <div class="modal-info-item" style="display: flex; flex-direction: column; gap: 5px; padding: 10px; background: white; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="info-icon" style="font-size: 1.2rem; color: var(--primary);">📄</div>
                    <span class="modal-info-label" style="font-size: 0.8rem; color: var(--gray);">Contrato Enviado</span>
                  </div>
                  <span class="modal-info-value" style="font-weight: 600; color: var(--dark); font-size: 0.9rem;">${loja.contrato_enviado || 'N/A'}</span>
                </div>
                
                <div class="modal-info-item" style="display: flex; flex-direction: column; gap: 5px; padding: 10px; background: white; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="info-icon" style="font-size: 1.2rem; color: var(--primary);">✍️</div>
                    <span class="modal-info-label" style="font-size: 0.8rem; color: var(--gray);">Contrato Assinado</span>
                  </div>
                  <span class="modal-info-value" style="font-weight: 600; color: var(--dark); font-size: 0.9rem;">${loja.contrato_assinado || 'N/A'}</span>
                </div>
                
                <div class="modal-info-item" style="display: flex; flex-direction: column; gap: 5px; padding: 10px; background: white; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="info-icon" style="font-size: 1.2rem; color: var(--primary);">🔗</div>
                    <span class="modal-info-label" style="font-size: 0.8rem; color: var(--gray);">Link</span>
                  </div>
                  <span class="modal-info-value" style="font-weight: 600; color: var(--primary); font-size: 0.9rem; word-break: break-all;">
                    ${loja.link ? `<a href="${loja.link}" target="_blank" style="color: var(--primary); text-decoration: none;">Ver Link</a>` : 'N/A'}
                  </span>
                </div>
              </div>
              
              <div class="modal-fornecedor-info-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">
                <div class="modal-info-item" style="display: flex; flex-direction: column; gap: 5px; padding: 10px; background: white; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="info-icon" style="font-size: 1.2rem; color: #FF6B35;">💰</div>
                    <span class="modal-info-label" style="font-size: 0.8rem; color: var(--gray);">MDR</span>
                  </div>
                  <span class="modal-info-value" style="font-weight: 600; color: #FF6B35; font-size: 0.9rem;">
                    ${formatarPercentualCorrigido(loja.mdr)} 
                  </span>
                </div>
                
                <div class="modal-info-item" style="display: flex; flex-direction: column; gap: 5px; padding: 10px; background: white; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="info-icon" style="font-size: 1.2rem; color: #17A2B8;">💳</div>
                    <span class="modal-info-label" style="font-size: 0.8rem; color: var(--gray);">TIS</span>
                  </div>
                  <span class="modal-info-value" style="font-weight: 600; color: #17A2B8; font-size: 0.9rem;">
                    ${formatarPercentualCorrigido(loja.tis)} 
                  </span>
                </div>
                
                <div class="modal-info-item" style="display: flex; flex-direction: column; gap: 5px; padding: 10px; background: white; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="info-icon" style="font-size: 1.2rem; color: #A1CC4C;">🔄</div>
                    <span class="modal-info-label" style="font-size: 0.8rem; color: var(--gray);">Rebate</span>
                  </div>
                  <span class="modal-info-value" style="font-weight: 600; color: #A1CC4C; font-size: 0.9rem;">
                    ${formatarPercentualCorrigido(loja.rebate)} 
                  </span>
                </div>
              </div>
              
              <div class="timeline-section" style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                <div class="timeline-item" style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                  <div class="timeline-icon" style="font-size: 1.1rem;">⏰</div>
                  <div class="timeline-content">
                    <span class="timeline-label" style="display: block; font-size: 0.8rem; color: var(--gray); margin-bottom: 2px;">Última Atualização</span>
                    <span class="timeline-value" style="font-weight: 600; color: var(--dark);">${ultimaEtapaCorrigida}</span>
                  </div>
                </div>
                
                <div class="timeline-item" style="display: flex; align-items: center; gap: 10px;">
                  <div class="timeline-icon" style="font-size: 1.1rem;">📊</div>
                  <div class="timeline-content">
                    <span class="timeline-label" style="display: block; font-size: 0.8rem; color: var(--gray); margin-bottom: 2px;">Tempo de Processo</span>
                    <span class="timeline-value ${loja.situacao && loja.situacao.toUpperCase() === 'EM ANDAMENTO' ? 
                      (calcularDefasagem(loja.ultima_etapa).includes('30') || calcularDefasagem(loja.ultima_etapa).includes('31') ? 
                      'defasagem-alerta' : 'defasagem-normal') : 'defasagem-inativa'}" 
                      style="font-weight: 600; ${loja.situacao && loja.situacao.toUpperCase() === 'EM ANDAMENTO' ? 
                      (calcularDefasagem(loja.ultima_etapa).includes('30') || calcularDefasagem(loja.ultima_etapa).includes('31') ? 
                      'color: var(--danger);' : 'color: var(--warning);') : 'color: var(--gray);'}">
                      ${loja.situacao && loja.situacao.toUpperCase() === 'EM ANDAMENTO' ? 
                        calcularDefasagem(loja.ultima_etapa) : 'Sem acompanhamento'}
                    </span>
                  </div>
                </div>
              </div>

              ${loja.observacoes ? `
              <div class="observacoes-section" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                <div class="observacao-item" style="display: flex; align-items: flex-start; gap: 10px;">
                  <div class="observacao-icon" style="font-size: 1.1rem; color: #856404;">📝</div>
                  <div class="observacao-content" style="flex: 1;">
                    <span class="observacao-label" style="display: block; font-size: 0.8rem; color: #856404; font-weight: 600; margin-bottom: 4px;">Observações</span>
                    <span class="observacao-value" style="font-size: 0.85rem; color: #856404; line-height: 1.4;">
                      ${loja.observacoes}
                    </span>
                  </div>
                </div>
              </div>
              ` : ''}
              
              <div class="modal-actions" style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn btn-warning btn-sm btn-action" 
                        onclick="verDetalhesCadastroModal('${loja.id}'); fecharModalFornecedores();"
                        title="Ver detalhes deste fornecedor"
                        style="padding: 6px 12px; border: none; border-radius: 4px; background: var(--warning); color: var(--dark); cursor: pointer; font-size: 0.8rem;">
                  <i class="fas fa-eye"></i> Detalhes
                </button>
                
                <button class="btn btn-sm btn-action" 
                        onclick="editarCadastroModal('${loja.id}'); fecharModalFornecedores();"
                        title="Editar este cadastro"
                        style="padding: 6px 12px; border: none; border-radius: 4px; background: linear-gradient(135deg, #7E3E9A 0%, #9A5fb8 100%); color: white; cursor: pointer; font-size: 0.8rem;">
                  <i class="fas fa-edit"></i> Editar
                </button>
              </div>
            </div>
          `;
        }).join('');
    } else {
        lojasHTML = `
        <div class="empty-state" style="text-align: center; padding: 40px;">
          <i class="fas fa-store-slash" style="font-size: 4rem; color: #6c757d; margin-bottom: 20px;"></i>
          <h4 style="color: #6c757d; margin-bottom: 10px;">Nenhuma loja encontrada</h4>
          <p style="color: #8a8a8a;">Não há lojas cadastradas para este CNPJ.</p>
        </div>
      `;
    }

    const formatarCNPJParaModal = (cnpj) => {
      if (!cnpj) return 'N/A';
      const cnpjLimpo = cnpj.replace(/\D/g, '');
      if (cnpjLimpo.length === 14) {
        return cnpjLimpo.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
      }
      return cnpj;
    };

    const cnpjFormatado = formatarCNPJParaModal(cnpj);
    const primeiraLoja = lojas && lojas.length > 0 ? lojas[0] : null;
    const razaoSocial = primeiraLoja ? primeiraLoja.razao_social : 'N/A';

    content.innerHTML = `
      <div class="modal-cnpj-header-profissional">
        <div class="cnpj-header-content">
          <div class="cnpj-icon">
            <i class="fas fa-building"></i>
          </div>
          <div class="cnpj-info">
            <h3 class="cnpj-title">CNPJ</h3>
            <div class="cnpj-number">${cnpjFormatado}</div>
            <div class="cnpj-subtitle">${razaoSocial}</div>
          </div>
          <div class="cnpj-badge">
            <span class="lojas-count">${lojas ? lojas.length : 0}</span>
            <small>Fornecedores</small>
          </div>
        </div>
      </div>
      
      <div class="cnpj-financeiro-card">
        <div style="flex: 1;">
          <div class="financeiro-title">
            <i class="fas fa-chart-line"></i> INFORMAÇÕES FINANCEIRAS DO CNPJ
          </div>
          <div class="financeiro-grid">
            <div class="financeiro-item">
              <span class="financeiro-valor mensalidade">${mensalidadeCNPJ}</span>
              <span class="financeiro-label">Mensalidade</span>
            </div>
            <div class="financeiro-item">
              <span class="financeiro-valor mensalidade-sim">${mensalidadeSimCNPJ}</span>
              <span class="financeiro-label">Mensalidade SIM</span>
            </div>
            <div class="financeiro-item">
              <span class="financeiro-valor adesao">${adesaoCNPJ}</span>
              <span class="financeiro-label">Adesão</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-content-scroll">
        <div class="fornecedores-list-header">
          <h4><i class="fas fa-list-ul"></i> Fornecedores Vinculados</h4>
          <span class="subtitle">Lista completa de integrações</span>
        </div>
        ${lojasHTML}
      </div>
    `;
    
    modal.style.display = 'flex';
}

function fecharModalFornecedores() {
  const modal = document.getElementById('modalFornecedores');
  modal.style.display = 'none';
}

function calcularDiasDefasagem(dataUltimaEtapa) {
  const defasagem = calcularDefasagem(dataUltimaEtapa);
  
  if (defasagem === 'N/A' || defasagem === 'Erro' || defasagem === 'Futuro' || defasagem === 'Data inválida' || defasagem === 'Erro no cálculo') {
    return 9999;
  }
  if (defasagem === 'Hoje') return 0;
  if (defasagem === '1 dia') return 1;
  
  const match = defasagem.match(/(\d+)\s*dias?/);
  if (match && match[1]) {
    return parseInt(match[1]);
  }
  
  const dias = parseInt(defasagem);
  if (isNaN(dias)) return 9999;
  
  return dias;
}

function getDefasagemClass(defasagem) {
  if (defasagem === 'N/A' || defasagem === 'Erro') return 'defasagem-media';
  if (defasagem === 'Hoje') return 'defasagem-baixa';
  if (defasagem === '1 dia') return 'defasagem-baixa';
  
  const dias = parseInt(defasagem);
  if (isNaN(dias)) return 'defasagem-media';
  
  if (dias <= 3) return 'defasagem-baixa';
  if (dias <= 7) return 'defasagem-media';
  return 'defasagem-alta';
}

function getCorBordaSituacao(situacao) {
  const situacaoLower = situacao ? situacao.toLowerCase() : '';
  
  if (situacaoLower.includes('novo registro')) return '#bfe1f6';
  else if (situacaoLower.includes('cadastrado')) return '#D1E7DD';
  else if (situacaoLower.includes('em andamento')) return '#FFF3CD';
  else if (situacaoLower.includes('rejeitado') || situacaoLower.includes('rejeitado')) return '#E2E3E5';
  else if (situacaoLower.includes('descredenciado')) return '#F8D7DA';
  else if (situacaoLower.includes('desistiu')) return '#e6cff2';
  else return 'var(--border)';
}

function formatarDataAtivacao(data) {
    if (!data || data === 'N/A' || data === 'undefined') {
        return 'N/A';
    }
    
    try {
        // Se já está no formato DD/MM/YYYY
        if (typeof data === 'string' && data.includes('/') && data.length === 10) {
            const partes = data.split('/');
            if (partes.length === 3 && partes[0].length === 2 && partes[1].length === 2 && partes[2].length === 4) {
                return data;
            }
        }
        
        // Se for string com formato ISO (YYYY-MM-DD)
        if (typeof data === 'string' && data.includes('-')) {
            const partes = data.split('T')[0].split('-');
            if (partes.length === 3) {
                const [ano, mes, dia] = partes;
                return `${dia.padStart(2, '0')}/${mes.padStart(2, '0')}/${ano}`;
            }
        }
        
        // Se for uma string complexa com GMT
        if (typeof data === 'string' && (data.includes('GMT') || data.includes('('))) {
            // Extrair apenas a parte da data
            const match = data.match(/(\w{3} \w{3} \d{2} \d{4})/);
            if (match) {
                const dateObj = new Date(match[0]);
                if (!isNaN(dateObj.getTime())) {
                    const dia = String(dateObj.getDate()).padStart(2, '0');
                    const mes = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const ano = dateObj.getFullYear();
                    return `${dia}/${mes}/${ano}`;
                }
            }
        }
        
        // Tentar criar objeto Date
        const dateObj = new Date(data);
        if (!isNaN(dateObj.getTime())) {
            const dia = String(dateObj.getDate()).padStart(2, '0');
            const mes = String(dateObj.getMonth() + 1).padStart(2, '0');
            const ano = dateObj.getFullYear();
            return `${dia}/${mes}/${ano}`;
        }
        
        return 'N/A';
    } catch (error) {
        console.error('Erro ao formatar data de ativação:', error, 'Data:', data);
        return 'N/A';
    }
}

function formatarPercentualCorrigido(percentual) {
    if (!percentual && percentual !== 0) {
        console.log("📭 Percentual vazio:", percentual);
        return 'N/A';
    }
    
    console.log("📊 formatarPercentualCorrigido recebeu:", percentual, "tipo:", typeof percentual);
    
    try {
        // Se já for string formatada com %, retornar como está
        if (typeof percentual === 'string' && percentual.includes('%')) {
            console.log("✅ Já formatado com %:", percentual);
            return percentual;
        }
        
        // Converter para número
        let numero;
        if (typeof percentual === 'string') {
            // Remove % e converte vírgula para ponto
            const strLimpa = percentual.replace('%', '').replace(',', '.').trim();
            numero = parseFloat(strLimpa);
        } else {
            numero = parseFloat(percentual);
        }
        
        if (isNaN(numero)) {
            console.log("⚠️ Não é número válido:", percentual);
            return String(percentual);
        }
        
        console.log("🔢 Número convertido:", numero);
        
        // ⚠️ AQUI ESTÁ A CORREÇÃO: MULTIPLICAR POR 100!
        // 0.08 → "8,00%" ✓
        // 0.0553 → "5,53%" ✓
        // 0.688 → "68,80%" ✓
        // 4.20 → "420,00%" (se vier como 4.20, significa 420%)
        
        const valorMultiplicado = numero * 100;
        const resultado = valorMultiplicado.toFixed(2).replace('.', ',') + '%';
        
        console.log("✅ Resultado final:", percentual, "→", numero, "→", resultado);
        return resultado;
        
    } catch (error) {
        console.error("❌ Erro em formatarPercentualCorrigido:", error);
        return String(percentual);
    }
}

function verDetalhesCadastroModal(id) {
  console.log("👀 Visualizando detalhes ID:", id);
  
  mostrarPopupCarregandoModal();
  
  cadastroAtualModalId = id;
  
  google.script.run
    .withSuccessHandler(function(dados) {
      console.log("✅ Dados recebidos para detalhes:", dados);
      exibirModalDetalhesCompleto(dados);
      esconderPopupCarregandoModal();
    })
    .withFailureHandler(function(error) {
      esconderPopupCarregandoModal();
      showMessage('error', '❌ Erro ao carregar detalhes: ' + error.message);
    })
    .buscarCadastroPorIDComWaitlabel(id, waitlabelAtual);
}

function exibirTabelaCadastrosAgrupada(cadastrosAgrupados, titulo) {
  const secao = document.getElementById('secaoCadastros');
  const tituloElement = document.getElementById('tituloCadastros');
  const tableContainer = document.getElementById('tableContainer');
  const tabelaBody = document.getElementById('tabelaCadastrosBody');
  const loading = document.getElementById('loadingCadastros');
  const filtrosAvancados = document.getElementById('filtrosAvancadosContainer');

  tituloElement.textContent = `${titulo} (${cadastrosAgrupados.length})`;
  tabelaBody.innerHTML = '';

  if (cadastrosAgrupados.length === 0) {
  tabelaBody.innerHTML = `
    <tr>
      <td colspan="10" style="text-align: center; padding: 30px;">
        <i class="fas fa-search" style="font-size: 2.5rem; color: var(--gray); margin-bottom: 12px;"></i>
        <h3>Nenhum resultado encontrado</h3>
        <p>Tente alterar os filtros de pesquisa.</p>
      </td>
    </tr>
    `;
  } else {
    cadastrosAgrupados.forEach(cadastro => {
      const row = criarLinhaTabelaAgrupada(cadastro);
      tabelaBody.appendChild(row);
    });
  }

  loading.style.display = 'none';
  tableContainer.style.display = 'block';
  filtrosAvancados.style.display = 'grid';
  secao.style.display = 'block';
  atualizarContador();
  
  setTimeout(() => {
    secao.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 300);
}

function corrigirHoraFrontend(dataHoraString) {
    if (!dataHoraString || dataHoraString === 'N/A') {
        return dataHoraString;
    }
    
    try {
        if (dataHoraString.includes('/') && dataHoraString.includes(':')) {
            return dataHoraString;
        }
        
        if (dataHoraString.includes('GMT')) {
            const data = new Date(dataHoraString);
            if (isNaN(data.getTime())) return dataHoraString;
            
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            const hora = String(data.getHours()).padStart(2, '0');
            const minuto = String(data.getMinutes()).padStart(2, '0');
            const segundo = String(data.getSeconds()).padStart(2, '0');
            
            return `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo}`;
        }
        
        const data = new Date(dataHoraString);
        if (!isNaN(data.getTime())) {
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            const hora = String(data.getHours()).padStart(2, '0');
            const minuto = String(data.getMinutes()).padStart(2, '0');
            const segundo = String(data.getSeconds()).padStart(2, '0');
            
            return `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo}`;
        }
        
        return dataHoraString;
        
    } catch (error) {
        console.error("❌ Erro em corrigirHoraFrontend:", error);
        return dataHoraString;
    }
}

function criarLinhaTabelaAgrupada(grupo) {
  const row = document.createElement('tr');
  
  const situacoes = grupo.lojas.map(l => l.situacao);
  
  let situacaoPrincipal = 'CADASTRADO';
  
  if (situacoes.includes('EM ANDAMENTO')) {
    situacaoPrincipal = 'EM ANDAMENTO';
  } else if (situacoes.includes('NOVO REGISTRO')) {
    situacaoPrincipal = 'NOVO REGISTRO';
  } else if (situacoes.includes('DESCREDENCIADO')) {
    situacaoPrincipal = 'DESCREDENCIADO';
  } else if (situacoes.includes('REJEITADO')) {
    situacaoPrincipal = 'REJEITADO';
  } else if (situacoes.includes('DESISTIU')) {
    situacaoPrincipal = 'DESISTIU';
  }
  
  const fornecedorMaisAntigo = encontrarFornecedorMaisAntigo(grupo.lojas);
  
  let dataHoraMaisAntiga = 'N/A';
  let dataHoraCorrigida = 'N/A';

  if (fornecedorMaisAntigo.data && fornecedorMaisAntigo.data !== 'N/A') {
    dataHoraMaisAntiga = fornecedorMaisAntigo.data;
    
    if (typeof dataHoraMaisAntiga === 'string' && dataHoraMaisAntiga.includes('/') && dataHoraMaisAntiga.includes(':')) {
      dataHoraCorrigida = corrigirHoraFrontend(dataHoraMaisAntiga);
    } else {
      dataHoraCorrigida = dataHoraMaisAntiga.toString();
    }
  }

  const etapaMaisAntiga = fornecedorMaisAntigo.etapa || 'N/A';
  const nomeFornecedorAntigo = fornecedorMaisAntigo.fornecedor || 'N/A';

  const mostrarHoraFornecedor = situacaoPrincipal === 'EM ANDAMENTO' || situacaoPrincipal === 'NOVO REGISTRO';

  let ultimaEtapaInfo = '';
  
  if (dataHoraCorrigida !== 'N/A' && etapaMaisAntiga !== 'N/A') {
    if (dataHoraCorrigida.includes('/') && dataHoraCorrigida.includes(':')) {
      const [dataPart, horaPart] = dataHoraCorrigida.split(' ');
      
      if (mostrarHoraFornecedor) {
        ultimaEtapaInfo = `
          <div style="font-size: 0.75rem;">
            <div style="font-weight: 500; margin-bottom: 2px;">${etapaMaisAntiga}</div>
            <div style="color: var(--gray); font-size: 0.65rem;">
              ${dataPart} ${horaPart || ''}
            </div>
            <div style="color: var(--danger); font-size: 0.6rem; margin-top: 2px;">
              ⚠️ ${nomeFornecedorAntigo}
            </div>
          </div>
        `;
      } else {
        ultimaEtapaInfo = `
          <div style="font-size: 0.75rem;">
            <div style="font-weight: 500; margin-bottom: 2px;">${etapaMaisAntiga}</div>
            <div style="color: var(--gray); font-size: 0.65rem;">
              Finalizado
            </div>
          </div>
        `;
      }
    } else {
      if (mostrarHoraFornecedor) {
        ultimaEtapaInfo = `
          <div style="font-size: 0.75rem;">
            <div style="font-weight: 500; margin-bottom: 2px;">${etapaMaisAntiga}</div>
            <div style="color: var(--gray); font-size: 0.65rem;">${dataHoraCorrigida}</div>
            <div style="color: var(--danger); font-size: 0.6rem; margin-top: 2px;">
              ⚠️ ${nomeFornecedorAntigo}
            </div>
          </div>
        `;
      } else {
        ultimaEtapaInfo = `
          <div style="font-size: 0.75rem;">
            <div style="font-weight: 500; margin-bottom: 2px;">${etapaMaisAntiga}</div>
            <div style="color: var(--gray); font-size: 0.65rem;">Etapa registrada</div>
          </div>
        `;
      }
    }
  } else {
    if (mostrarHoraFornecedor) {
      ultimaEtapaInfo = `
        <div style="font-size: 0.75rem;">
          <div style="font-weight: 500; margin-bottom: 2px;">${etapaMaisAntiga}</div>
          <div style="color: var(--gray); font-size: 0.65rem;">N/A</div>
          <div style="color: var(--danger); font-size: 0.6rem; margin-top: 2px;">
            ⚠️ ${nomeFornecedorAntigo}
          </div>
        </div>
      `;
    } else {
      ultimaEtapaInfo = `
        <div style="font-size: 0.75rem;">
          <div style="font-weight: 500; margin-bottom: 2px;">${etapaMaisAntiga}</div>
          <div style="color: var(--gray); font-size: 0.65rem;">Sem informações</div>
        </div>
      `;
    }
  }

  const temLojaEmAndamento = grupo.lojas.some(loja => 
    loja.situacao && loja.situacao.toUpperCase() === 'EM ANDAMENTO'
  );

  let defasagemHTML = '';
  if (temLojaEmAndamento) {
    const defasagemInfo = calcularDefasagemPorCNPJ(grupo.lojas);
    const defasagemTexto = defasagemInfo.dias === 0 ? 'Hoje' : 
                          defasagemInfo.dias === 1 ? '1 dia' : 
                          defasagemInfo.dias > 1 && defasagemInfo.dias < 9999 ? `${defasagemInfo.dias} dias` : 'N/A';
    const defasagemClass = getDefasagemClass(defasagemTexto);
    
    defasagemHTML = `
      <td style="text-align: center;">
        <div class="defasagem-container">
          <span class="defasagem-badge ${defasagemClass}" title="Fornecedor mais antigo: ${defasagemInfo.fornecedor}">
            ${defasagemTexto}
          </span>
        </div>
      </td>
    `;
  } else {
    defasagemHTML = `
      <td style="text-align: center;">
        <div class="defasagem-container">
          <span class="sem-defasagem-badge" title="Nenhuma loja em andamento">
            Sem defasagem
          </span>
        </div>
      </td>
    `;
  }

  let mensalidadeCNPJ = 'R$ 0,00';
  let mensalidadeSimCNPJ = 'R$ 0,00';
  let adesaoCNPJ = 'Isento';
  
  for (const loja of grupo.lojas) {
    if (mensalidadeCNPJ === 'R$ 0,00' && loja.mensalidade && loja.mensalidade !== 'R$ 0,00' && loja.mensalidade !== 0) {
      mensalidadeCNPJ = formatarMoedaParaInput(loja.mensalidade);
    }
    
    if (mensalidadeSimCNPJ === 'R$ 0,00' && loja.mensalidade_sim && loja.mensalidade_sim !== 'R$ 0,00' && loja.mensalidade_sim !== 0) {
      mensalidadeSimCNPJ = formatarMoedaParaInput(loja.mensalidade_sim);
    }
    
    if (adesaoCNPJ === 'Isento' && loja.adesao && loja.adesao !== 'Isento' && loja.adesao !== 0) {
      adesaoCNPJ = formatarMoedaParaInput(loja.adesao);
    }
    
    if (mensalidadeCNPJ !== 'R$ 0,00' && mensalidadeSimCNPJ !== 'R$ 0,00' && adesaoCNPJ !== 'Isento') {
      break;
    }
  }

  // Calcular totais de MDR, TIS e Rebate para o CNPJ
  let totalMDR = 'N/A';
  let totalTIS = 'N/A';
  let totalRebate = 'N/A';
  
  const lojasComDados = grupo.lojas.filter(loja => loja.mdr || loja.tis || loja.rebate);
  if (lojasComDados.length > 0) {
    // Pegar os valores da primeira loja que tenha dados
    const primeiraLojaComDados = lojasComDados[0];
    totalMDR = formatarPercentualCorrigido(primeiraLojaComDados.mdr);
    totalTIS = formatarPercentualCorrigido(primeiraLojaComDados.tis);
    totalRebate = formatarPercentualCorrigido(primeiraLojaComDados.rebate);
  }

  // Na função criarLinhaTabelaAgrupada, substitua o row.innerHTML atual por:
row.innerHTML = `
  <td>
    <div style="font-weight: 600; color: var(--primary); margin-bottom: 2px;">${grupo.razao_social || 'N/A'}</div>
    <div style="font-size: 0.7rem; color: var(--gray);">${grupo.nome_fantasia || 'Sem nome fantasia'}</div>
    <div style="font-size: 0.65rem; color: var(--info); margin-top: 2px;">
      <strong>${grupo.lojas.length}</strong> fornecedor(es)
    </div>
  </td>
  <td>
    <div style="font-family: monospace; font-size: 0.75rem; font-weight: 600; color: var(--dark);">
      ${grupo.cnpj || 'N/A'}
    </div>
  </td>
  <td>
    <div style="font-weight: 500; color: var(--dark);">
      ${grupo.lojas.map(l => l.fornecedor).join(', ')}
    </div>
  </td>
  <td>
    <span class="status-badge ${getSituacaoClass(situacaoPrincipal)}">${situacaoPrincipal}</span>
  </td>
  <td>
    ${ultimaEtapaInfo}
  </td>
  ${defasagemHTML}
  <td style="font-weight: 600; color: var(--success); text-align: center;">
    ${mensalidadeCNPJ}
  </td>
  <td style="font-weight: 600; color: var(--primary); text-align: center;">
    ${mensalidadeSimCNPJ}
  </td>
  <td style="font-weight: 600; color: var(--info); text-align: center;">
    ${adesaoCNPJ}
  </td>
  <td style="text-align: center;">
    <button class="btn btn-info btn-sm btn-visualizar-compact" onclick="verTodosFornecedores('${grupo.cnpj}')" title="Visualizar Todos">
      <i class="fas fa-eye"></i> Ver Todos
    </button>
  </td>
`;

  return row;
}

function encontrarFornecedorMaisAntigo(lojasDoCNPJ) {
  if (!lojasDoCNPJ || lojasDoCNPJ.length === 0) {
    return { fornecedor: 'N/A', data: 'N/A', etapa: 'N/A', dias: 9999 };
  }
  
  const situacoesPrioritarias = ['EM ANDAMENTO', 'NOVO REGISTRO'];
  
  for (const situacao of situacoesPrioritarias) {
    const lojasPrioritarias = lojasDoCNPJ.filter(loja => 
      loja.situacao && loja.situacao.toUpperCase() === situacao
    );
    
    if (lojasPrioritarias.length > 0) {
      const lojasComData = lojasPrioritarias.filter(loja => {
        if (!loja.ultima_etapa || loja.ultima_etapa === 'N/A') return false;
        try {
          const data = new Date(loja.ultima_etapa.split('/').reverse().join('-'));
          return !isNaN(data.getTime());
        } catch (error) {
          return false;
        }
      });
      
      if (lojasComData.length > 0) {
        const lojaMaisAntiga = lojasComData.reduce((maisAntiga, atual) => {
          try {
            const dataMaisAntiga = new Date(maisAntiga.ultima_etapa.split('/').reverse().join('-'));
            const dataAtual = new Date(atual.ultima_etapa.split('/').reverse().join('-'));
            return dataAtual < dataMaisAntiga ? atual : maisAntiga;
          } catch (error) {
            return maisAntiga;
          }
        });
        
        const diasDefasagem = calcularDiasDefasagem(lojaMaisAntiga.ultima_etapa);
        return {
          fornecedor: lojaMaisAntiga.fornecedor,
          data: lojaMaisAntiga.ultima_etapa,
          etapa: lojaMaisAntiga.etapa,
          dias: diasDefasagem,
          situacao: lojaMaisAntiga.situacao
        };
      } else if (lojasPrioritarias.length > 0) {
        return {
          fornecedor: lojasPrioritarias[0].fornecedor,
          data: 'N/A',
          etapa: lojasPrioritarias[0].etapa || 'N/A',
          dias: 9999,
          situacao: lojasPrioritarias[0].situacao
        };
      }
    }
  }
  
  const lojasComData = lojasDoCNPJ.filter(loja => {
    if (!loja.ultima_etapa || loja.ultima_etapa === 'N/A') return false;
    try {
      const data = new Date(loja.ultima_etapa.split('/').reverse().join('-'));
      return !isNaN(data.getTime());
    } catch (error) {
      return false;
    }
  });
  
  if (lojasComData.length > 0) {
    const lojaMaisAntiga = lojasComData.reduce((maisAntiga, atual) => {
      try {
        const dataMaisAntiga = new Date(maisAntiga.ultima_etapa.split('/').reverse().join('-'));
        const dataAtual = new Date(atual.ultima_etapa.split('/').reverse().join('-'));
        return dataAtual < dataMaisAntiga ? atual : maisAntiga;
      } catch (error) {
        return maisAntiga;
      }
    });
    
    const diasDefasagem = calcularDiasDefasagem(lojaMaisAntiga.ultima_etapa);
    return {
      fornecedor: lojaMaisAntiga.fornecedor,
      data: lojaMaisAntiga.ultima_etapa,
      etapa: lojaMaisAntiga.etapa,
      dias: diasDefasagem,
      situacao: lojaMaisAntiga.situacao
    };
  }
  
  const lojaComEtapa = lojasDoCNPJ.find(loja => loja.etapa && loja.etapa !== 'N/A');
  if (lojaComEtapa) {
    return {
      fornecedor: lojaComEtapa.fornecedor,
      data: 'N/A',
      etapa: lojaComEtapa.etapa,
      dias: 9999,
      situacao: lojaComEtapa.situacao
    };
  }
  
  return {
    fornecedor: lojasDoCNPJ[0].fornecedor,
    data: 'N/A',
    etapa: lojasDoCNPJ[0].etapa || 'N/A',
    dias: 9999,
    situacao: lojasDoCNPJ[0].situacao
  };
}

function calcularDefasagemPorCNPJ(lojasDoCNPJ) {
  if (!lojasDoCNPJ || lojasDoCNPJ.length === 0) {
    return { dias: 9999, fornecedor: 'N/A', data: 'N/A', etapa: 'N/A' };
  }
  
  const fornecedorMaisAntigo = encontrarFornecedorMaisAntigo(lojasDoCNPJ);
  
  return {
    dias: fornecedorMaisAntigo.dias,
    fornecedor: fornecedorMaisAntigo.fornecedor,
    data: fornecedorMaisAntigo.data,
    etapa: fornecedorMaisAntigo.etapa
  };
}

function filtrarPesquisa() {
  const termo = document.getElementById('pesquisaCadastros').value.toLowerCase().trim();
  if (termo) {
    filtrosAtivos.pesquisa = termo;
  } else {
    delete filtrosAtivos.pesquisa;
  }
  
  document.getElementById('ordenacaoCadastros').value = 'razao_social';
  aplicarTodosFiltros();
}

function ordenarCadastros() {
  const criterio = document.getElementById('ordenacaoCadastros').value;
  
  console.log("🎯 Ordenando por:", criterio);
  
  const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosFiltrados);
  
  cadastrosAgrupados.sort((a, b) => {
    switch(criterio) {
      case 'razao_social':
        return (a.razao_social || '').localeCompare(b.razao_social || '');
      case 'razao_social_desc':
        return (b.razao_social || '').localeCompare(a.razao_social || '');
      case 'nome_fantasia':
        return (a.nome_fantasia || '').localeCompare(b.nome_fantasia || '');
      case 'nome_fantasia_desc':
        return (b.nome_fantasia || '').localeCompare(a.nome_fantasia || '');
      case 'situacao':
        const situacaoA = a.lojas[0]?.situacao || '';
        const situacaoB = b.lojas[0]?.situacao || '';
        return situacaoA.localeCompare(situacaoB);
      case 'fornecedor':
        const fornecedorA = a.lojas[0]?.fornecedor || '';
        const fornecedorB = b.lojas[0]?.fornecedor || '';
        return fornecedorA.localeCompare(fornecedorB);
      case 'defasagem':
        const defasagemA = calcularDefasagemParaOrdenacao(a.lojas);
        const defasagemB = calcularDefasagemParaOrdenacao(b.lojas);
        return defasagemB - defasagemA;
      case 'defasagem_asc':
        const defasagemAAsc = calcularDefasagemParaOrdenacao(a.lojas);
        const defasagemBAsc = calcularDefasagemParaOrdenacao(b.lojas);
        return defasagemAAsc - defasagemBAsc;
      case 'mensalidade':
        const mensalidadeA = parseFloat(a.lojas[0]?.mensalidade || 0);
        const mensalidadeB = parseFloat(b.lojas[0]?.mensalidade || 0);
        return mensalidadeB - mensalidadeA;
      case 'mensalidade_asc':
        const mensalidadeAAsc = parseFloat(a.lojas[0]?.mensalidade || 0);
        const mensalidadeBAsc = parseFloat(b.lojas[0]?.mensalidade || 0);
        return mensalidadeAAsc - mensalidadeBAsc;
      case 'mensalidade_sim':
        const mensalidadeSimA = parseFloat(getMensalidadeSimParaOrdenacao(a.lojas));
        const mensalidadeSimB = parseFloat(getMensalidadeSimParaOrdenacao(b.lojas));
        return mensalidadeSimB - mensalidadeSimA;
      case 'mensalidade_sim_asc':
        const mensalidadeSimAAsc = parseFloat(getMensalidadeSimParaOrdenacao(a.lojas));
        const mensalidadeSimBAsc = parseFloat(getMensalidadeSimParaOrdenacao(b.lojas));
        return mensalidadeSimAAsc - mensalidadeSimBAsc;
      case 'adesao':
        const adesaoA = a.lojas[0]?.adesao === 'Isento' || a.lojas[0]?.adesao === 0 ? 0 : parseFloat(a.lojas[0]?.adesao || 0);
        const adesaoB = b.lojas[0]?.adesao === 'Isento' || b.lojas[0]?.adesao === 0 ? 0 : parseFloat(b.lojas[0]?.adesao || 0);
        return adesaoB - adesaoA;
      case 'adesao_asc':
        const adesaoAAsc = a.lojas[0]?.adesao === 'Isento' || a.lojas[0]?.adesao === 0 ? 0 : parseFloat(a.lojas[0]?.adesao || 0);
        const adesaoBAsc = b.lojas[0]?.adesao === 'Isento' || b.lojas[0]?.adesao === 0 ? 0 : parseFloat(b.lojas[0]?.adesao || 0);
        return adesaoAAsc - adesaoBAsc;
      default:
        return 0;
    }
  });
  
  exibirTabelaCadastrosAgrupada(cadastrosAgrupados, 'Cadastros Ordenados');
}

function getMensalidadeSimParaOrdenacao(lojas) {
  for (const loja of lojas) {
    if (loja.mensalidade_sim && loja.mensalidade_sim !== 'R$ 0,00' && loja.mensalidade_sim !== 0) {
      if (typeof loja.mensalidade_sim === 'string') {
        return loja.mensalidade_sim.replace('R$', '').replace('.', '').replace(',', '.').trim();
      }
      return loja.mensalidade_sim;
    }
  }
  return 0;
}

function calcularDefasagemParaOrdenacao(lojasDoCNPJ) {
  if (!lojasDoCNPJ || lojasDoCNPJ.length === 0) {
    return 0;
  }
  
  const temLojaEmAndamento = lojasDoCNPJ.some(loja => 
    loja.situacao && loja.situacao.toUpperCase() === 'EM ANDAMENTO'
  );
  
  if (!temLojaEmAndamento) {
    return 0;
  }
  
  const defasagemInfo = calcularDefasagemPorCNPJ(lojasDoCNPJ);
  
  return defasagemInfo.dias < 9999 ? defasagemInfo.dias : 0;
}

function recarregarCadastros() {
  const filtrosSalvos = {
    situacaoAtiva: situacaoAtiva,
    filtrosAtivos: {...filtrosAtivos},
    etapasSelecionados: [...etapasSelecionados],
    fornecedoresSelecionados: [...fornecedoresSelecionados],
    pesquisa: document.getElementById('pesquisaCadastros').value,
    ordenacao: document.getElementById('ordenacaoCadastros').value
  };

  mostrarPopupCarregandoLojas();

  const loading = document.getElementById('loadingCadastros');
  const tableContainer = document.getElementById('tableContainer');

  loading.style.display = 'flex';
  tableContainer.style.display = 'none';

  google.script.run
    .withSuccessHandler(function(cadastros) {
      esconderPopupCarregandoLojas();
      
      if (cadastros && cadastros.length > 0) {
        todosCadastros = cadastros;
        cadastrosFiltrados = [...cadastros];
        
        document.getElementById('ordenacaoCadastros').value = 'razao_social';
        ordenarCadastros();
        
        restaurarFiltros(filtrosSalvos);
        
        showMessage('success', `✅ ${cadastros.length} cadastros atualizados do ${formatarNomeWaitlabel(waitlabelAtual)}!`);
      } else {
        esconderPopupCarregandoLojas();
        loading.style.display = 'none';
        tableContainer.style.display = 'block';
        document.getElementById('tabelaCadastrosBody').innerHTML = `
          <tr>
            <td colspan="13" style="text-align: center; padding: 30px;">
              <i class="fas fa-inbox" style="font-size: 2.5rem; color: var(--gray); margin-bottom: 12px;"></i>
              <h3>Nenhum cadastro encontrado</h3>
              <p>Não há cadastros no waitlabel ${formatarNomeWaitlabel(waitlabelAtual)}.</p>
            </td>
          </tr>
        `;
        showMessage('info', `📝 Nenhum cadastro encontrado no ${formatarNomeWaitlabel(waitlabelAtual)}.`);
      }
    })
    .withFailureHandler(function(error) {
      esconderPopupCarregandoLojas();
      
      loading.style.display = 'none';
      tableContainer.style.display = 'block';
      showMessage('error', '❌ Erro ao carregar cadastros: ' + error.message);
    })
    .buscarTodosCadastrosComWaitlabel(waitlabelAtual);
}

function exibirTabelaCadastros() {
  const tabelaBody = document.getElementById('tabelaCadastrosBody');
  const loading = document.getElementById('loadingCadastros');
  const tableContainer = document.getElementById('tableContainer');

  tabelaBody.innerHTML = '';

  if (cadastrosFiltrados.length === 0) {
    tabelaBody.innerHTML = `
      <tr>
        <td colspan="13" style="text-align: center; padding: 40px;">
          <i class="fas fa-search" style="font-size: 3rem; color: var(--gray); margin-bottom: 15px;"></i>
          <h3>Nenhum resultado encontrado</h3>
          <p>Tente alterar os filtros de pesquisa.</p>
        </td>
      </tr>
    `;
  } else {
    const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosFiltrados);
    
    atualizarContadorCNPJs(cadastrosAgrupados.length);
    
    cadastrosAgrupados.forEach(grupo => {
      const row = criarLinhaTabelaAgrupada(grupo);
      tabelaBody.appendChild(row);
    });
  }

  loading.style.display = 'none';
  tableContainer.style.display = 'block';
}

function atualizarContadorCNPJs(cnpjCount) {
  const contador = document.getElementById('contadorCadastros');
  const totalCadastros = todosCadastros.length;
  
  const cnpjUnicosTotal = [...new Set(todosCadastros.map(c => c.cnpj))].length;
  
  if (cnpjCount === cnpjUnicosTotal) {
    contador.textContent = `${cnpjUnicosTotal} CNPJ${cnpjUnicosTotal !== 1 ? 's' : ''}`;
  } else {
    contador.textContent = `${cnpjCount} de ${cnpjUnicosTotal} CNPJ${cnpjUnicosTotal !== 1 ? 's' : ''}`;
  }
}

function atualizarContador() {
  const contador = document.getElementById('contadorCadastros');
  const totalCadastros = todosCadastros.length;
  
  // CONTAR CNPJs ÚNICOS, não fornecedores
  const cnpjsUnicos = [...new Set(todosCadastros.map(c => c.cnpj))].length;
  
  if (cadastrosFiltrados.length === totalCadastros) {
    contador.textContent = `${cnpjsUnicos} CNPJ${cnpjsUnicos !== 1 ? 's' : ''}`;
  } else {
    // Contar CNPJs únicos nos filtrados
    const cnpjsFiltradosUnicos = [...new Set(cadastrosFiltrados.map(c => c.cnpj))].length;
    contador.textContent = `${cnpjsFiltradosUnicos} de ${cnpjsUnicos} CNPJ${cnpjsUnicos !== 1 ? 's' : ''}`;
  }
}

function showLoading() {
  document.getElementById('loadingCadastros').style.display = 'flex';
  document.getElementById('tableContainer').style.display = 'none';
}

function hideLoading() {
  document.getElementById('loadingCadastros').style.display = 'none';
}

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    fecharModalDetalhes();
    fecharModalFornecedores();
  }
});

document.getElementById('modalDetalhes').addEventListener('click', function(e) {
  if (e.target === this) {
    fecharModalDetalhes();
  }
});

document.getElementById('modalFornecedores').addEventListener('click', function(e) {
  if (e.target === this) {
    fecharModalFornecedores();
  }
});

function editarCadastroDoModal() {
  if (!cadastroAtualModalId) {
    showMessage('error', '❌ Nenhum cadastro selecionado para edição!');
    return;
  }
  
  fecharModalDetalhes();
  
  // Chama a função de edição existente
  editarCadastroModal(cadastroAtualModalId);
}

function exibirModalDetalhesCompleto(dados) {
    const modal = document.getElementById('modalDetalhes');
    const content = document.getElementById('modalDetalhesContent');
    
    const mensalidadeFormatada = formatarMoedaParaInput(dados.mensalidade);
    const mensalidadeSimFormatada = formatarMoedaParaInput(dados.mensalidade_sim || 0);
    const adesaoFormatada = dados.adesao === 'Isento' || dados.adesao === 0 ? 'Isento' : formatarMoedaParaInput(dados.adesao);
    
    // CORRIGIR DATAS PARA EXIBIÇÃO
    const ultimaEtapaCorrigida = dados.ultima_etapa ? corrigirHoraFrontend(dados.ultima_etapa) : 'N/A';

    // CORREÇÃO: SÓ MOSTRAR DEFASAGEM SE FOR EM ANDAMENTO
    const mostrarDefasagem = dados.situacao && dados.situacao.toUpperCase() === 'EM ANDAMENTO';
    const defasagem = calcularDefasagem(ultimaEtapaCorrigida);

    // SEÇÃO DE DEFASAGEM (SÓ SE FOR EM ANDAMENTO)
    const secaoDefasagem = mostrarDefasagem && defasagem !== 'N/A' && defasagem !== '0 dias' && defasagem !== 'Data inválida' && defasagem !== 'Erro no cálculo' ? `
    <div class="detalhe-item" style="grid-column: 1 / -1; background: #fff5f5; border-left: 4px solid #dc3545; margin-top: 10px;">
        <span class="detalhe-label" style="font-size: 1.1em; color: #dc3545;">
            <i class="fas fa-clock"></i> ⚠️ INFORMAÇÕES DE DEFASAGEM
        </span>
    </div>
    
    <div class="detalhe-item">
        <span class="detalhe-label">⏰ Defasagem</span>
        <div class="detalhe-valor">
            <span style="display: inline-flex; align-items: center; gap: 5px; background: #dc3545; color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.9rem; font-weight: 600;">
                <i class="fas fa-clock"></i>
                ${defasagem}
            </span>
        </div>
    </div>
    ` : mostrarDefasagem ? '' : `
    <div class="detalhe-item" style="grid-column: 1 / -1; background: #e9ecef; border-left: 4px solid #6c757d; margin-top: 10px;">
        <span class="detalhe-label" style="font-size: 1.1em; color: #6c757d;">
            <i class="fas fa-clock"></i> INFORMAÇÕES DE DEFASAGEM
        </span>
    </div>
    
    <div class="detalhe-item">
        <span class="detalhe-label">⏰ Defasagem</span>
        <div class="detalhe-valor">
            <span style="display: inline-flex; align-items: center; gap: 5px; background: #e9ecef; color: #6c757d; padding: 4px 10px; border-radius: 15px; font-size: 0.9rem; font-weight: 600;">
                <i class="fas fa-clock"></i>
                Sem defasagem
            </span>
        </div>
    </div>
    `;

    content.innerHTML = `
    <div class="detalhes-grid">
        <!-- SEÇÃO: INFORMAÇÕES PRINCIPAIS -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0f8ff; border-left: 4px solid #2EBE76;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #2EBE76;">
                <i class="fas fa-info-circle"></i> 📋 INFORMAÇÕES PRINCIPAIS
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">🏢 Razão Social</span>
            <div class="detalhe-valor" style="font-weight: bold; color: #2EBE76;">${dados.razao_social || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">🏷️ Nome Fantasia</span>
            <div class="detalhe-valor">${dados.nome_fantasia || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">🔢 CNPJ</span>
            <div class="detalhe-valor" style="font-family: monospace;">${dados.cnpj || 'N/A'}</div>
        </div>

        <!-- SEÇÃO: FINANCEIRO -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0fff0; border-left: 4px solid #28a745; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #28a745;">
                <i class="fas fa-chart-line"></i> 💰 INFORMAÇÕES FINANCEIRAS DO CNPJ
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">💵 Mensalidade</span>
            <div class="detalhe-valor" style="color: var(--success); font-weight: 600;">${mensalidadeFormatada}</div>
        </div>

        <div class="detalhe-item">
            <span class="detalhe-label" style="color: var(--sim); font-weight: 700;">
                <i class="fas fa-heart" style="color: var(--sim);"></i> Mensalidade SIM
            </span>
            <div class="detalhe-valor" style="color: var(--sim); font-weight: 600;">${mensalidadeSimFormatada}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">🤝 Adesão</span>
            <div class="detalhe-valor" style="color: var(--info); font-weight: 600;">${adesaoFormatada}</div>
        </div>

        <!-- SEÇÃO: MDR, TIS e REBATE -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: linear-gradient(135deg, #f8f9fa 0%, #f0f8ff 100%); border-left: 4px solid #FF6B35; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #FF6B35;">
                <i class="fas fa-percentage"></i> 📊 MDR, TIS E REBATE
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label" style="color: #FF6B35; font-weight: 700;">
                <i class="fas fa-money-bill-wave"></i> MDR
            </span>
            <div class="detalhe-valor" style="color: #FF6B35; font-weight: 600;">${formatarPercentualCorrigido(dados.mdr) || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label" style="color: #17A2B8; font-weight: 700;">
                <i class="fas fa-credit-card"></i> TIS
            </span>
            <div class="detalhe-valor" style="color: #17A2B8; font-weight: 600;">${formatarPercentualCorrigido(dados.tis) || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label" style="color: #A1CC4C; font-weight: 700;">
                <i class="fas fa-sync-alt"></i> Rebate
            </span>
            <div class="detalhe-valor" style="color: #A1CC4C; font-weight: 600;">${formatarPercentualCorrigido(dados.rebate) || 'N/A'}</div>
        </div>

        <!-- SEÇÃO: CONTRATOS E DATAS -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #fff8f0; border-left: 4px solid #ff6b35; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #ff6b35;">
                <i class="fas fa-file-contract"></i> 📄 CONTRATOS E DATAS
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">📄 Contrato Enviado</span>
            <div class="detalhe-valor">${dados.contrato_enviado || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">✍️ Contrato Assinado</span>
            <div class="detalhe-valor">${dados.contrato_assinado || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
           <span class="detalhe-label">🚀 Data Ativação</span>
           <div class="detalhe-valor">${formatarDataAtivacao(dados.ativacao)}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">📅 Última Etapa</span>
            <div class="detalhe-valor">${ultimaEtapaCorrigida}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">🚚 Fornecedor</span>
            <div class="detalhe-valor">${dados.fornecedor || 'N/A'}</div>
        </div>

        <!-- SEÇÃO: STATUS E ACOMPANHAMENTO -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0f0f8; border-left: 4px solid #6f42c1; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #6f42c1;">
                <i class="fas fa-tasks"></i> 📊 STATUS E ACOMPANHAMENTO
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">🎯 Situação</span>
            <div class="detalhe-valor">
                <span class="status-badge ${getSituacaoClass(dados.situacao)}">${dados.situacao || 'N/A'}</span>
            </div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">📅 Etapa (data/hora)</span>
            <div class="detalhe-valor">${dados.etapa || 'N/A'} ${ultimaEtapaCorrigida !== 'N/A' ? `- ${ultimaEtapaCorrigida}` : ''}</div>
        </div>

        <!-- SEÇÃO: LINKS E OBSERVAÇÕES -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #fff5f5; border-left: 4px solid #e83e8c; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #e83e8c;">
                <i class="fas fa-sticky-note"></i> 🔗 LINKS E OBSERVAÇÕES
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">🔗 Link</span>
            <div class="detalhe-valor">
                ${dados.link ? 
                    `<a href="${dados.link}" target="_blank" style="color: #007bff; text-decoration: none;">
                        <i class="fas fa-external-link-alt"></i> ${dados.link}
                    </a>` 
                    : 'N/A'
                }
            </div>
        </div>
        
        <div class="detalhe-item" style="grid-column: 1 / -1;">
            <span class="detalhe-label">📝 Observações</span>
            <div class="detalhe-valor" style="max-height: 100px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                ${dados.observacoes || 'Nenhuma observação registrada'}
            </div>
        </div>

        <!-- SEÇÃO: DEFASAGEM - AGORA CORRETA -->
        ${secaoDefasagem}
    </div>
    
    <div class="modal-detalhes-actions" style="display: flex; gap: 10px; justify-content: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
        <button class="btn btn-primary" onclick="editarCadastroDoModal()" style="background: linear-gradient(135deg, #7E3E9A 0%, #9A5FB8 100%); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-edit"></i> ✏️ Editar Cadastro
        </button>
        <button class="btn btn-primary" onclick="fecharModalDetalhes()" style="background: linear-gradient(135deg, #2EBE76 0%, #3CD88C 100%); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-check"></i> Fechar
        </button>
    </div>
    `;
    
    modal.style.display = 'flex';
}

function formatarDataHoraParaExibicao(dataString) {
    if (!dataString) return 'N/A';
    
    try {
        if (dataString.includes('/') && dataString.includes(':')) {
            return dataString;
        }
        
        const data = new Date(dataString);
        if (isNaN(data.getTime())) return dataString;
        
        const dia = String(data.getDate()).padStart(2, '0');
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        const ano = data.getFullYear();
        const hora = String(data.getHours()).padStart(2, '0');
        const minuto = String(data.getMinutes()).padStart(2, '0');
        const segundo = String(data.getSeconds()).padStart(2, '0');
        
        return `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo}`;
        
    } catch (error) {
        return dataString;
    }
}

function calcularDefasagem(dataUltimaEtapa) {
    if (!dataUltimaEtapa || dataUltimaEtapa === 'N/A' || dataUltimaEtapa === '' || dataUltimaEtapa === 'Data inválida') {
        return 'N/A';
    }
    
    try {
        let dataEtapa;
        
        if (dataUltimaEtapa.includes('/') && dataUltimaEtapa.includes(':')) {
            const [dataPart, horaPart] = dataUltimaEtapa.split(' ');
            const [dia, mes, ano] = dataPart.split('/');
            const [hora, minuto, segundo] = horaPart.split(':');
            
            dataEtapa = new Date(
                parseInt(ano), 
                parseInt(mes) - 1,
                parseInt(dia),
                parseInt(hora), 
                parseInt(minuto), 
                parseInt(segundo)
            );
            
        } else if (dataUltimaEtapa.includes('GMT')) {
            dataEtapa = new Date(dataUltimaEtapa);
        } else {
            dataEtapa = new Date(dataUltimaEtapa);
        }
        
        if (isNaN(dataEtapa.getTime())) {
            return 'Data inválida';
        }
        
        const hoje = new Date();
        const hojeZerado = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate(), 0, 0, 0);
        const dataEtapaZerada = new Date(dataEtapa.getFullYear(), dataEtapa.getMonth(), dataEtapa.getDate(), 0, 0, 0);
        
        const diffTempo = hojeZerado.getTime() - dataEtapaZerada.getTime();
        const diffDias = Math.floor(diffTempo / (1000 * 3600 * 24));
        
        if (diffDias === 0) return 'Hoje';
        if (diffDias === 1) return '1 dia';
        if (diffDias > 1) return `${diffDias} dias`;
        if (diffDias < 0) return 'Futuro';
        
        return 'N/A';
        
    } catch (error) {
        console.error("❌ Erro ao calcular defasagem:", error, "Data:", dataUltimaEtapa);
        return 'Erro no cálculo';
    }
}

// FUNÇÕES WAITLABELS
function inicializarWaitlabels() {
  google.script.run
    .withSuccessHandler(function(waitlabel) {
      waitlabelAtual = waitlabel;
      criarBotoesWaitlabels();
      atualizarInterfaceWaitlabel();
    })
    .withFailureHandler(function(error) {
      criarBotoesWaitlabels();
    })
    .getWaitlabelAtual();
}

function criarBotoesWaitlabels() {
  const container = document.getElementById('waitlabelButtons');
  let html = '';
  
  WAITLABELS_CONFIG.WAITLABELS.forEach(waitlabel => {
    const cor = WAITLABELS_CONFIG.CORES[waitlabel];
    const isActive = waitlabel === waitlabelAtual;
    const classeAtiva = isActive ? 'active' : '';
    
    html += `
      <button class="waitlabel-btn ${classeAtiva}" 
              onclick="selecionarWaitlabel('${waitlabel}')"
              style="border-color: ${cor}; ${isActive ? `background: ${cor}; color: white;` : `color: ${cor};`}">
        <span class="waitlabel-indicator" style="background: ${cor};"></span>
        ${formatarNomeWaitlabel(waitlabel)}
      </button>
    `;
  });
  
  container.innerHTML = html;
}

function formatarNomeWaitlabel(nome) {
  const formatacoes = {
    'Sim_Facilita': 'Sim Facilita',
    'Set_9': 'Set 9',
    'Doktorbank': 'DoktorBank',
    'Dr_Parcela': 'Dr Parcela',
    'Result': 'Result'
  };
  return formatacoes[nome] || nome;
}

function selecionarWaitlabel(waitlabel) {
  waitlabelAtual = waitlabel;
  criarBotoesWaitlabels();
  atualizarInterfaceWaitlabel();
  
  google.script.run
    .withSuccessHandler(function(res) {
      showMessage('success', `✅ Waitlabel alterado para: ${formatarNomeWaitlabel(waitlabel)}`);
    })
    .withFailureHandler(function(error) {
      showMessage('error', '❌ Erro ao alterar waitlabel');
    })
    .setWaitlabelAtual(waitlabel);
}

function atualizarInterfaceWaitlabel() {
  const header = document.querySelector('.header');
  const cor = WAITLABELS_CONFIG.CORES[waitlabelAtual] || '#7E3E9A';
  header.style.background = cor;
  
  const titulo = document.getElementById('tituloCadastros');
  if (titulo) {
    titulo.textContent = `Cadastros - ${formatarNomeWaitlabel(waitlabelAtual)}`;
  }
}

// FUNÇÕES APLICAR A TODOS
function toggleCampoParaTodos(campoId) {
    const campoParaAplicar = campoId === 'inputEtapaSearch' ? 'etapa' : campoId;
    
    camposParaAplicarATodos[campoParaAplicar] = !camposParaAplicarATodos[campoParaAplicar];
    
    const checkbox = document.querySelector(`[data-campo="${campoId}"]`);
    if (checkbox) {
        checkbox.checked = camposParaAplicarATodos[campoParaAplicar];
    }
}

async function aplicarAlteracoesATodos() {
  const filtrosSalvos = {
    situacaoAtiva: situacaoAtiva,
    filtrosAtivos: {...filtrosAtivos},
    etapasSelecionados: [...etapasSelecionados],
    fornecedoresSelecionados: [...fornecedoresSelecionados],
    pesquisa: document.getElementById('pesquisaCadastros').value,
    ordenacao: document.getElementById('ordenacaoCadastros').value
  };

  const btnAplicar = document.getElementById('btnAplicarATodos');
  if (btnAplicar && btnAplicar.disabled) {
    return;
  }
  
  if (btnAplicar) {
    btnAplicar.disabled = true;
    btnAplicar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aplicando...';
  }
  
  const camposSelecionados = Object.keys(camposParaAplicarATodos).filter(campo => camposParaAplicarATodos[campo]);
  
  if (camposSelecionados.length === 0) {
    showMessage('error', '❌ Selecione pelo menos um campo para aplicar a todos!');
    if (btnAplicar) {
      btnAplicar.disabled = false;
      btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
    }
    return;
  }

  const situacaoSelecionada = document.getElementById('situacao').value;
  const situacaoUpper = situacaoSelecionada ? situacaoSelecionada.toUpperCase().trim() : '';
  const etapaSelecionada = document.getElementById('inputEtapaSearch').value;
  
  const precisaEtapaEspecifica = situacaoUpper === 'NOVO REGISTRO' || situacaoUpper === 'EM ANDAMENTO';
  const etapaEstaSelecionada = camposParaAplicarATodos['inputEtapaSearch'] || camposParaAplicarATodos['etapa'];

  // VALIDAÇÃO 1: Se precisa de etapa, verificar se está marcada
  if (precisaEtapaEspecifica && !etapaEstaSelecionada) {
    showMessage('error', `❌ Para situações "${situacaoSelecionada}" você DEVE marcar o checkbox "Aplicar Etapa a todos"!`);
    
    if (btnAplicar) {
      btnAplicar.disabled = false;
      btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
    }
    
    const checkboxEtapa = document.querySelector('[data-campo="inputEtapaSearch"]');
    if (checkboxEtapa) {
      checkboxEtapa.scrollIntoView({ behavior: 'smooth', block: 'center' });
      checkboxEtapa.style.outline = '2px solid var(--danger)';
      checkboxEtapa.style.outlineOffset = '2px';
    }
    return;
  }

  // VALIDAÇÃO 2: Se etapa está selecionada, verificar se é válida
  if (etapaEstaSelecionada) {
    const etapaSelecionada = document.getElementById('inputEtapaSearch').value;
    
    if (!etapaSelecionada || etapaSelecionada.trim() === '') {
      showMessage('error', `❌ O campo "Etapa" não pode estar vazio quando aplicando a todos!`);
      
      if (btnAplicar) {
        btnAplicar.disabled = false;
        btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
      }
      
      const inputEtapa = document.getElementById('inputEtapaSearch');
      if (inputEtapa) {
        inputEtapa.style.border = '3px solid var(--danger)';
        inputEtapa.style.backgroundColor = '#fff5f5';
        inputEtapa.style.boxShadow = '0 0 10px rgba(220, 53, 69, 0.3)';
        inputEtapa.focus();
        inputEtapa.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        inputEtapa.style.animation = 'shake 0.5s ease-in-out';
        setTimeout(() => {
          inputEtapa.style.animation = '';
        }, 500);
      }
      return;
    }
    
    // Lista de etapas válidas para EM ANDAMENTO e NOVO REGISTRO
    const etapasValidas = [
      "PENDENTE FORNECEDOR(ES)",
      "PENDENTE SIM", 
      "PENDENTE RETORNO EXTERNO"
    ];
    
    // Lista de situações que NÃO podem ser usadas como etapa
    const situacoesInvalidasComoEtapa = [
      "CADASTRADO", "REJEITADO", "DESCREDENCIADO", "DESISTIU", 
      "NOVO REGISTRO", "EM ANDAMENTO"
    ];
    
    const etapaUpper = etapaSelecionada.toUpperCase().trim();
    
    // VALIDAÇÃO 2A: Verificar se não é uma situação sendo usada como etapa
    if (situacoesInvalidasComoEtapa.includes(etapaUpper)) {
      const mensagemErro = `❌ ETAPA INVÁLIDA!\n\nA etapa "${etapaSelecionada}" é uma SITUAÇÃO, não uma etapa do processo.\n\n📋 ETAPAS VÁLIDAS para "${situacaoSelecionada}":\n• PENDENTE FORNECEDOR(ES)\n• PENDENTE SIM\n• PENDENTE RETORNO EXTERNO`;
      
      showMessage('error', mensagemErro);
      
      if (btnAplicar) {
        btnAplicar.disabled = false;
        btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
      }
      
      const inputEtapa = document.getElementById('inputEtapaSearch');
      if (inputEtapa) {
        inputEtapa.style.border = '3px solid var(--danger)';
        inputEtapa.style.backgroundColor = '#fff5f5';
        inputEtapa.style.boxShadow = '0 0 10px rgba(220, 53, 69, 0.3)';
        inputEtapa.focus();
        inputEtapa.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        inputEtapa.style.animation = 'shake 0.5s ease-in-out';
        setTimeout(() => {
          inputEtapa.style.animation = '';
        }, 500);
      }
      return;
    }
    
    // VALIDAÇÃO 2B: Verificar se está na lista de etapas válidas
    if (!etapasValidas.includes(etapaUpper)) {
      const mensagemErro = `❌ ETAPA INVÁLIDA!\n\nA etapa "${etapaSelecionada}" não é válida.\n\n📋 ETAPAS VÁLIDAS para "${situacaoSelecionada}":\n• PENDENTE FORNECEDOR(ES)\n• PENDENTE SIM\n• PENDENTE RETORNO EXTERNO`;
      
      showMessage('error', mensagemErro);
      
      if (btnAplicar) {
        btnAplicar.disabled = false;
        btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
      }
      
      const inputEtapa = document.getElementById('inputEtapaSearch');
      if (inputEtapa) {
        inputEtapa.style.border = '3px solid var(--danger)';
        inputEtapa.style.backgroundColor = '#fff5f5';
        inputEtapa.style.boxShadow = '0 0 10px rgba(220, 53, 69, 0.3)';
        inputEtapa.focus();
        inputEtapa.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        inputEtapa.style.animation = 'shake 0.5s ease-in-out';
        setTimeout(() => {
          inputEtapa.style.animation = '';
        }, 500);
      }
      return;
    }
  }

  const dadosAtuais = coletarDadosFormulario();
  if (!dadosAtuais) {
    showMessage('error', '❌ Erro ao coletar dados do formulário');
    if (btnAplicar) {
      btnAplicar.disabled = false;
      btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
    }
    return;
  }
  
  const cnpjCorreto = document.getElementById('cnpj_cadastro')?.value || dadosAtuais.cnpj;
  
  if (!cnpjCorreto) {
    showMessage('error', '❌ CNPJ não identificado!');
    if (btnAplicar) {
      btnAplicar.disabled = false;
      btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
    }
    return;
  }
  
  mostrarPopupAplicarTodosMelhorado(cnpjCorreto, camposSelecionados, dadosAtuais, filtrosSalvos);
}

function mostrarPopupAplicarTodosMelhorado(cnpj, camposSelecionados, dados, filtrosSalvos) {
    const formatarValorParaPopup = (campo, valor) => {
        if (campo === 'ativacao' && valor && valor !== 'Não preenchido') {
            if (valor.includes('-')) {
                const partes = valor.split('-');
                if (partes.length === 3) {
                    return `${partes[2]}/${partes[1]}/${partes[0]}`;
                }
            }
            return valor;
        }
        
        if ((campo === 'mensalidade' || campo === 'adesao') && valor && valor !== 'Não preenchido') {
            if (typeof valor === 'number' || !isNaN(parseFloat(valor))) {
                const numero = parseFloat(valor);
                return numero.toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                });
            } else if (typeof valor === 'string') {
                const numeroMatch = valor.match(/[\d,\.]+/);
                if (numeroMatch) {
                    const numero = parseFloat(numeroMatch[0].replace(/\./g, '').replace(',', '.'));
                    if (!isNaN(numero)) {
                        return numero.toLocaleString('pt-BR', {
                            style: 'currency',
                            currency: 'BRL'
                        });
                    }
                }
            }
        }
        
        if (campo === 'etapa' && valor && valor !== 'Não preenchido') {
            return valor.charAt(0).toUpperCase() + valor.slice(1).toLowerCase();
        }
        
        return valor;
    };

    const modalHTML = `
        <div id="modalAplicarTodos" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:9999; font-family: 'Segoe UI', Arial, sans-serif;">
            <div style="background:linear-gradient(135deg, #ffffff 0%, #f8f6ff 100%); padding:25px; border-radius:12px; width:450px; box-shadow:0 8px 25px rgba(0,0,0,0.25); border:2px solid #8B5FBF; position:relative;">
                <div style="background:linear-gradient(135deg, #8B5FBF 0%, #6A4C9C 100%); color:white; padding:15px; margin:-25px -25px 20px -25px; border-radius:10px 10px 0 0; text-align:center;">
                    <h3 style="margin:0; font-size:18px; font-weight:600;">🎯 Aplicar Alterações em Lote</h3>
                </div>
                
                <div style="margin-bottom:15px;">
                    <div style="display:flex; align-items:center; margin-bottom:8px;">
                        <span style="background:#8B5FBF; color:white; padding:4px 8px; border-radius:15px; font-size:11px; font-weight:bold;">📋 CNPJ</span>
                        <span style="margin-left:8px; font-weight:600; color:#333; font-family: monospace;">${cnpj}</span>
                    </div>
                    
                    <div style="display:flex; align-items:center; margin-bottom:12px;">
                        <span style="background:#8B5FBF; color:white; padding:4px 8px; border-radius:15px; font-size:11px; font-weight:bold;">🏢 Registros</span>
                        <span style="margin-left:8px; color:#666;">Todos com este CNPJ</span>
                    </div>
                </div>
                
                <div style="background:#f0ebfa; padding:15px; border-radius:8px; margin-bottom:15px; border-left:3px solid #8B5FBF;">
                    <div style="display:flex; align-items:center; margin-bottom:10px;">
                        <span style="color:#8B5FBF; font-weight:bold; font-size:14px;">📝 Campos Selecionados (${camposSelecionados.length})</span>
                    </div>
                    <div style="max-height:120px; overflow-y:auto;">
                      ${camposSelecionados.map(campo => {
                          const nomeCampo = formatarNomeCampoPopup(campo);
                          let valorCampo = dados[campo] || document.getElementById(campo)?.value || 'Não preenchido';
                          valorCampo = formatarValorParaPopup(campo, valorCampo);
                          return `
                              <div style="display:flex; justify-content:space-between; align-items:center; padding:6px 4px; border-bottom:1px solid #e0e0e0;">
                                  <span style="color:#555; font-weight:500;">${nomeCampo}</span>
                                  <span style="background:#8B5FBF; color:white; padding:3px 8px; border-radius:10px; font-size:11px; font-weight:bold; max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${valorCampo}</span>
                              </div>
                          `;
                      }).join('')}
                    </div>
                </div>
                
                <div style="background:#e8f4fd; border:2px solid #2196F3; padding:12px; border-radius:6px; margin-bottom:15px;">
                    <div style="display:flex; align-items:flex-start; gap:10px;">
                        <span style="color:#2196F3; font-size:18px;">⏰</span>
                        <div>
                            <div style="color:#0c5460; font-weight:600; font-size:13px;">Processamento Seguro</div>
                            <div style="color:#0c5460; font-size:11px; margin-top:4px;">
                                • Delay entre requisições: 1 segundo<br>
                                • Processamento sequencial<br>
                                • Prevenção de erro 429
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="background:#fff3cd; border:2px solid #ffc107; padding:12px; border-radius:6px; margin-bottom:20px; display:flex; align-items:flex-start; gap:10px;">
                    <span style="color:#856404; font-size:18px; margin-top:2px;">⚠️</span>
                    <div>
                        <div style="color:#856404; font-weight:600; font-size:13px;">Atenção</div>
                        <div style="color:#856404; font-size:11px; margin-top:4px;">
                            Esta ação atualizará TODOS os registros com este CNPJ e não pode ser desfeita.
                        </div>
                    </div>
                </div>
                
                <div style="display:flex; gap:12px; justify-content:flex-end;">
                    <button onclick="fecharPopupAplicarTodos(false)" style="padding:10px 20px; border:2px solid #6c757d; background:white; color:#6c757d; border-radius:6px; cursor:pointer; font-weight:600; transition:all 0.3s; display:flex; align-items:center; gap:6px; min-width:100px; justify-content:center;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button onclick="processarAplicarATodosComDelay(${JSON.stringify(filtrosSalvos).replace(/"/g, '&quot;')})" style="padding:10px 20px; background:linear-gradient(135deg, #28a745 0%, #20c997 100%); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition:all 0.3s; display:flex; align-items:center; gap:6px; min-width:120px; justify-content:center; box-shadow:0 3px 10px rgba(40, 167, 69, 0.25);">
                        <i class="fas fa-play"></i> Iniciar
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    window.dadosAplicarTodos = {
        cnpj: cnpj,
        campos: camposSelecionados,
        dados: dados
    };
}

async function processarAplicarATodosComDelay(filtrosSalvos) {
    const modal = document.getElementById('modalAplicarTodos');
    if (modal) modal.remove();
    
    const { cnpj, campos, dados } = window.dadosAplicarTodos;
    const btnAplicar = document.getElementById('btnAplicarATodos');
    
    mostrarPopupAtualizando();
    
    try {
        // VALIDAÇÃO DUPLA NO FRONTEND (segurança extra)
        const situacaoUpper = dados.situacao ? dados.situacao.toUpperCase().trim() : '';
        const precisaValidarEtapa = situacaoUpper === 'EM ANDAMENTO' || situacaoUpper === 'NOVO REGISTRO';
        
        if (precisaValidarEtapa && dados.etapa) {
            const etapasValidas = [
                "PENDENTE FORNECEDOR(ES)",
                "PENDENTE SIM", 
                "PENDENTE RETORNO EXTERNO"
            ];
            
            const etapaUpper = dados.etapa.toUpperCase().trim();
            
            if (!etapasValidas.includes(etapaUpper)) {
                esconderPopupAtualizando();
                showMessage('error', `❌ ETAPA INVÁLIDA! A etapa "${dados.etapa}" não é válida para situações "${dados.situacao}".`);
                
                if (btnAplicar) {
                    btnAplicar.disabled = false;
                    btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
                }
                return;
            }
        }
        
        // CORREÇÃO: GARANTIR QUE A ETAPA SEJA A SITUAÇÃO QUANDO FOR SITUAÇÃO FINAL
        const dadosParaEnviar = { ...dados };
        
        // Se a situação for final, garantir que a etapa seja a mesma
        const ehSituacaoFinal = situacaoUpper === 'CADASTRADO' || 
                               situacaoUpper === 'REJEITADO' || 
                               situacaoUpper === 'DESCREDENCIADO' || 
                               situacaoUpper === 'DESISTIU';
        
        if (ehSituacaoFinal) {
            console.log("🔄 Situação final detectada:", situacaoUpper);
            console.log("📝 Etapa antes:", dadosParaEnviar.etapa);
            
            // Forçar a etapa a ser a mesma situação
            dadosParaEnviar.etapa = dadosParaEnviar.situacao;
            
            console.log("📝 Etapa depois:", dadosParaEnviar.etapa);
            
            // Garantir que o campo etapa esteja nos campos a aplicar
            if (!campos.includes('etapa') && !campos.includes('inputEtapaSearch')) {
                campos.push('etapa');
                console.log("✅ Etapa adicionada aos campos a aplicar");
            }
        }
        
        delete dadosParaEnviar.ultima_etapa;
        
        console.log("📤 Dados sendo enviados para 'Aplicar a Todos':", dadosParaEnviar);
        console.log("🎯 Campos a aplicar:", campos);
        
        google.script.run
            .withSuccessHandler(function(res) {
                esconderPopupAtualizando();
                
                if (btnAplicar) {
                    btnAplicar.disabled = false;
                    btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
                }
                
                if (res && res.success) {
                    showMessage('success', `✅ ${res.registrosAtualizados} registro(s) atualizado(s) com sucesso!`);
                    limparSelecaoAplicarATodos();
                    
                    if (document.getElementById('secaoCadastros').style.display === 'block') {
                        restaurarFiltros(filtrosSalvos);
                    }
                } else {
                    const inputEtapa = document.getElementById('inputEtapaSearch');
                    if (inputEtapa && res && res.message && res.message.includes('ETAPA')) {
                        inputEtapa.style.border = '3px solid var(--danger)';
                        inputEtapa.style.backgroundColor = '#fff5f5';
                        inputEtapa.style.boxShadow = '0 0 10px rgba(220, 53, 69, 0.3)';
                        inputEtapa.focus();
                        inputEtapa.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        inputEtapa.style.animation = 'shake 0.5s ease-in-out';
                        setTimeout(() => {
                            inputEtapa.style.animation = '';
                        }, 500);
                    }
                    
                    showMessage('error', '❌ ' + (res ? res.message : 'Erro ao aplicar alterações'));
                }
            })
            .withFailureHandler(function(error) {
                esconderPopupAtualizando();
                
                if (btnAplicar) {
                    btnAplicar.disabled = false;
                    btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
                }
                
                if (error.message && error.message.includes('429')) {
                    showMessage('error', '❌ Muitas requisições simultâneas. Aguarde alguns segundos e tente novamente.');
                } else {
                    showMessage('error', '❌ Erro: ' + error.message);
                }
            })
            .aplicarAlteracoesATodos(cnpj, dadosParaEnviar, campos);
            
    } catch (error) {
        esconderPopupAtualizando();
        
        if (btnAplicar) {
            btnAplicar.disabled = false;
            btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
        }
        
        showMessage('error', '❌ Erro crítico: ' + error.message);
    }
}

function fecharPopupAplicarTodos(confirmado) {
    const modal = document.getElementById('modalAplicarTodos');
    if (modal) modal.remove();
    
    if (confirmado) {
        const btnAplicar = document.getElementById('btnAplicarATodos');
        const camposSelecionados = Object.keys(camposParaAplicarATodos).filter(campo => camposParaAplicarATodos[campo]);
        const dadosAtuais = coletarDadosFormulario();
        const cnpjCorreto = document.getElementById('cnpj_cadastro')?.value || dadosAtuais.cnpj;
        
        mostrarPopupAtualizando();
        
        google.script.run
            .withSuccessHandler(function(res) {
                esconderPopupAtualizando();
                
                if (btnAplicar) {
                    btnAplicar.disabled = false;
                    btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
                }
                
                if (res && res.success) {
                    showMessage('success', `✅ ${res.registrosAtualizados} registro(s) atualizado(s) com sucesso!`);
                    limparSelecaoAplicarATodos();
                    if (document.getElementById('secaoCadastros').style.display === 'block') {
                        mostrarTodosCadastros();
                    }
                } else {
                    showMessage('error', '❌ ' + (res ? res.message : 'Erro ao aplicar alterações'));
                }
            })
            .withFailureHandler(function(error) {
                esconderPopupAtualizando();
                
                if (btnAplicar) {
                    btnAplicar.disabled = false;
                    btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
                }
                
                showMessage('error', '❌ Erro: ' + error.message);
            })
            .aplicarAlteracoesATodos(cnpjCorreto, dadosAtuais, camposSelecionados);
    } else {
        const btnAplicar = document.getElementById('btnAplicarATodos');
        if (btnAplicar) {
            btnAplicar.disabled = false;
            btnAplicar.innerHTML = '<i class="fas fa-copy"></i> Aplicar a Todos';
        }
    }
}

const formatarNomeCampoPopup = (campo) => {
    const nomes = {
        'razao_social': 'Razão Social',
        'nome_fantasia': 'Nome Fantasia', 
        'cnpj_cadastro': 'CNPJ',
        'contrato_enviado': 'Contrato Enviado',
        'contrato_assinado': 'Contrato Assinado',
        'ativacao': 'Ativação',
        'link': 'Link',
        'mensalidade': 'Mensalidade',
        'adesao': 'Adesão',
        'situacao': 'Situação',
        'etapa': 'Etapa',
        'observacoes': 'Observações',
        'inputEtapaSearch': 'Etapa'
    };
    
    return nomes[campo] || campo;
};

function limparSelecaoAplicarATodos() {
    camposParaAplicarATodos = {};
    cnpjAtualParaAplicar = null;
    
    document.querySelectorAll('[data-campo]').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    const btnAplicar = document.getElementById('btnAplicarATodos');
    if (btnAplicar) {
        btnAplicar.style.display = 'none';
    }
    
    document.querySelectorAll('.checkbox-aplicar-todos').forEach(checkbox => {
        checkbox.remove();
    });
    
    const titulo = document.getElementById('tituloAplicarTodos');
    if (titulo) {
        titulo.style.display = 'none';
        titulo.innerHTML = '';
    }
    
    document.getElementById('cardCadastro').classList.remove('modo-aplicar-todos');
}

function configurarAplicarATodos(cnpj, id) {
    fecharModalDetalhes();
    
    editarCadastroModal(id);
    
    setTimeout(() => {
        cnpjAtualParaAplicar = cnpj;
        cadastroAtualId = id;
        
        mostrarInterfaceAplicarATodos();
        
        showMessage('info', '🎯 Modo "Aplicar a Todos" ativado! Selecione os campos que deseja aplicar.');
    }, 1000);
}

function mostrarInterfaceAplicarATodos() {
    adicionarCheckboxesAosCampos();
    
    mostrarBotaoAplicarATodos();
    
    const titulo = document.getElementById('tituloAplicarTodos');
    if (titulo) {
        titulo.style.display = 'block';
        titulo.innerHTML = `
            <div style="background: linear-gradient(135deg, #FF6B35 0%, #FF8E35 100%); color: white; padding: 8px 12px; border-radius: 6px; margin-top: 8px; text-align: center;">
                <i class="fas fa-copy"></i> <strong>MODO APLICAR A TODOS</strong> - CNPJ: ${cnpjAtualParaAplicar}
                <br><small>Selecione os campos que deseja aplicar a todos os registros deste CNPJ</small>
            </div>
        `;
    }
    
    document.getElementById('cardCadastro').classList.add('modo-aplicar-todos');
}

function adicionarCheckboxesAosCampos() {
  const camposAplicaveis = [
    'razao_social', 'nome_fantasia','contrato_enviado', 
    'contrato_assinado', 'ativacao', 'link', 'mensalidade', 
    'mensalidade_sim', 'adesao', 'situacao', 'inputEtapaSearch'
  ];
    
    camposAplicaveis.forEach(campoId => {
        const campoElement = document.getElementById(campoId);
        if (campoElement) {
            const formGroup = campoElement.closest('.form-group');
            if (formGroup && !formGroup.querySelector('.checkbox-aplicar-todos')) {
                const checkboxHtml = `
                    <div class="checkbox-aplicar-todos">
                        <input type="checkbox" id="check_${campoId}" data-campo="${campoId}" 
                               onchange="toggleCampoParaTodos('${campoId}')">
                        <label for="check_${campoId}">
                            <i class="fas fa-copy"></i> Aplicar este campo a todos
                        </label>
                    </div>
                `;
                formGroup.insertAdjacentHTML('beforeend', checkboxHtml);
            }
        }
    });
}

function mostrarBotaoAplicarATodos() {
    const btnAplicar = document.getElementById('btnAplicarATodos');
    if (btnAplicar) {
        btnAplicar.style.display = 'block';
    }
}

// FUNÇÕES PRINCIPAIS DO SISTEMA
function cadastrar() {
  const camposInvalidos = validarCamposObrigatorios();
  if (camposInvalidos.length > 0) {
    showMessage('error', `❌ Preencha os campos obrigatórios: ${camposInvalidos.join(', ')}`);
    return;
  }

  const fornecedoresSelecionados = document.querySelectorAll('input[name="fornecedor"]:checked');
  if (fornecedoresSelecionados.length === 0) {
    showMessage('error', '❌ Selecione pelo menos um fornecedor!');
    return;
  }

  const dadosBase = coletarDadosFormulario();
  if (!dadosBase) {
    showMessage('error', '❌ Erro ao coletar dados do formulário');
    return;
  }

  const etapaSelecionada = dadosBase.etapa;
  const situacaoSelecionada = dadosBase.situacao;

  const situacaoUpper = situacaoSelecionada ? situacaoSelecionada.toUpperCase().trim() : '';
  const precisaValidarEtapa = situacaoUpper === 'EM ANDAMENTO' || situacaoUpper === 'NOVO REGISTRO';

  if (precisaValidarEtapa) {
    if (!etapaSelecionada) {
      showMessage('error', `❌ Para situações "${situacaoSelecionada}" o campo Etapa é obrigatório!`);
      
      const inputEtapa = document.getElementById('inputEtapaSearch');
      if (inputEtapa) {
        inputEtapa.style.border = '2px solid var(--danger)';
        inputEtapa.style.backgroundColor = '#fff5f5';
        inputEtapa.focus();
        inputEtapa.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      return;
    }
    
    const etapasValidas = [
      "PENDENTE FORNECEDOR(ES)",
      "PENDENTE SIM", 
      "PENDENTE RETORNO EXTERNO"
    ];
    
    const situacoesInvalidasComoEtapa = [
      "CADASTRADO", "REJEITADO", "DESCREDENCIADO", "DESISTIU", 
      "NOVO REGISTRO", "EM ANDAMENTO"
    ];
    
    const etapaUpper = etapaSelecionada.toUpperCase().trim();
    
    if (situacoesInvalidasComoEtapa.includes(etapaUpper)) {
      const mensagemErro = `❌ ETAPA INVÁLIDA!\n\nA etapa "${etapaSelecionada}" é uma SITUAÇÃO, não uma etapa do processo.\n\n📋 ETAPAS VÁLIDAS:\n• PENDENTE FORNECEDOR(ES)\n• PENDENTE SIM\n• PENDENTE RETORNO EXTERNO`;
      
      showMessage('error', mensagemErro);
      
      const inputEtapa = document.getElementById('inputEtapaSearch');
      if (inputEtapa) {
        inputEtapa.style.border = '3px solid var(--danger)';
        inputEtapa.style.backgroundColor = '#fff5f5';
        inputEtapa.style.boxShadow = '0 0 10px rgba(220, 53, 69, 0.3)';
        inputEtapa.focus();
        inputEtapa.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        inputEtapa.style.animation = 'shake 0.5s ease-in-out';
        setTimeout(() => {
          inputEtapa.style.animation = '';
        }, 500);
      }
      return;
    }
    
    if (!etapasValidas.includes(etapaUpper)) {
      const mensagemErro = `❌ ETAPA INVÁLIDA!\n\nA etapa "${etapaSelecionada}" não é válida.\n\n📋 ETAPAS VÁLIDAS:\n• PENDENTE FORNECEDOR(ES)\n• PENDENTE SIM\n• PENDENTE RETORNO EXTERNO`;
      
      showMessage('error', mensagemErro);
      
      const inputEtapa = document.getElementById('inputEtapaSearch');
      if (inputEtapa) {
        inputEtapa.style.border = '3px solid var(--danger)';
        inputEtapa.style.backgroundColor = '#fff5f5';
        inputEtapa.style.boxShadow = '0 0 10px rgba(220, 53, 69, 0.3)';
        inputEtapa.focus();
        inputEtapa.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        inputEtapa.style.animation = 'shake 0.5s ease-in-out';
        setTimeout(() => {
          inputEtapa.style.animation = '';
        }, 500);
      }
      return;
    }
  }

  dadosBase.acao = 'cadastrar';

  mostrarPopupAtualizando();

  const btnCadastrar = document.getElementById('btnCadastrar');
  btnCadastrar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cadastrando...';
  btnCadastrar.disabled = true;

  google.script.run
    .withSuccessHandler(function(res) {
      esconderPopupAtualizando();
      
      btnCadastrar.innerHTML = '<i class="fas fa-plus-circle"></i> Cadastrar';
      btnCadastrar.disabled = false;
      
      if (res.success) {
        showMessage('success', `✅ ${res.message} - ${res.registrosCriados} registro(s) criado(s)`);
        limparFormulario();
      } else {
        showMessage('error', '❌ ' + res.message);
      }
    })
    .withFailureHandler(function(error) {
      esconderPopupAtualizando();
      
      btnCadastrar.innerHTML = '<i class="fas fa-plus-circle"></i> Cadastrar';
      btnCadastrar.disabled = false;
      showMessage('error', '❌ Erro: ' + error.message);
    })
    .processarCadastroComWaitlabel(dadosBase, waitlabelAtual);
}

function atualizar() {
  const filtrosSalvos = {
    situacaoAtiva: situacaoAtiva,
    filtrosAtivos: {...filtrosAtivos},
    etapasSelecionados: [...etapasSelecionados],
    fornecedoresSelecionados: [...fornecedoresSelecionados],
    pesquisa: document.getElementById('pesquisaCadastros').value,
    ordenacao: document.getElementById('ordenacaoCadastros').value
  };

  mostrarPopupAtualizando();

  if (!cadastroAtualId) {
    esconderPopupAtualizando();
    showMessage('error', '❌ Nenhum cadastro selecionado para atualizar!');
    return;
  }

  const camposInvalidos = validarCamposObrigatorios();
  if (camposInvalidos.length > 0) {
    esconderPopupAtualizando();
    showMessage('error', `❌ Preencha os campos obrigatórios: ${camposInvalidos.join(', ')}`);
    return;
  }

  const fornecedoresSelecionadosForm = document.querySelectorAll('input[name="fornecedor"]:checked');
  if (fornecedoresSelecionadosForm.length === 0) {
    esconderPopupAtualizando();
    showMessage('error', '❌ Selecione pelo menos um fornecedor!');
    return;
  }

  const dados = coletarDadosFormulario();
  if (!dados) {
    esconderPopupAtualizando();
    showMessage('error', '❌ Erro ao coletar dados do formulário');
    return;
  }
  
  const etapaSelecionada = dados.etapa;
  const situacaoSelecionada = dados.situacao;

  const situacaoUpper = situacaoSelecionada ? situacaoSelecionada.toUpperCase().trim() : '';
  const precisaValidarEtapa = situacaoUpper === 'EM ANDAMENTO' || situacaoUpper === 'NOVO REGISTRO';

  if (precisaValidarEtapa) {
    if (!etapaSelecionada) {
      esconderPopupAtualizando();
      showMessage('error', `❌ Para situações "${situacaoSelecionada}" o campo Etapa é obrigatório!`);
      
      const inputEtapa = document.getElementById('inputEtapaSearch');
      if (inputEtapa) {
        inputEtapa.style.border = '2px solid var(--danger)';
        inputEtapa.style.backgroundColor = '#fff5f5';
        inputEtapa.focus();
        inputEtapa.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      return;
    }
    
    const etapasValidas = [
      "PENDENTE FORNECEDOR(ES)",
      "PENDENTE SIM", 
      "PENDENTE RETORNO EXTERNO"
    ];
    
    const situacoesInvalidasComoEtapa = [
      "CADASTRADO", "REJEITADO", "DESCREDENCIADO", "DESISTIU", 
      "NOVO REGISTRO", "EM ANDAMENTO"
    ];
    
    const etapaUpper = etapaSelecionada.toUpperCase().trim();
    
    if (situacoesInvalidasComoEtapa.includes(etapaUpper)) {
      esconderPopupAtualizando();
      const mensagemErro = `❌ ETAPA INVÁLIDA!\n\nA etapa "${etapaSelecionada}" é uma SITUAÇÃO, não uma etapa do processo.\n\n📋 ETAPAS VÁLIDAS:\n• PENDENTE FORNECEDOR(ES)\n• PENDENTE SIM\n• PENDENTE RETORNO EXTERNO`;
      
      showMessage('error', mensagemErro);
      
      const inputEtapa = document.getElementById('inputEtapaSearch');
      if (inputEtapa) {
        inputEtapa.style.border = '3px solid var(--danger)';
        inputEtapa.style.backgroundColor = '#fff5f5';
        inputEtapa.style.boxShadow = '0 0 10px rgba(220, 53, 69, 0.3)';
        inputEtapa.focus();
        inputEtapa.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        inputEtapa.style.animation = 'shake 0.5s ease-in-out';
        setTimeout(() => {
          inputEtapa.style.animation = '';
        }, 500);
      }
      return;
    }
    
    if (!etapasValidas.includes(etapaUpper)) {
      esconderPopupAtualizando();
      const mensagemErro = `❌ ETAPA INVÁLIDA!\n\nA etapa "${etapaSelecionada}" não é válida.\n\n📋 ETAPAS VÁLIDAS:\n• PENDENTE FORNECEDOR(ES)\n• PENDENTE SIM\n• PENDENTE RETORNO EXTERNO`;
      
      showMessage('error', mensagemErro);
      
      const inputEtapa = document.getElementById('inputEtapaSearch');
      if (inputEtapa) {
        inputEtapa.style.border = '3px solid var(--danger)';
        inputEtapa.style.backgroundColor = '#fff5f5';
        inputEtapa.style.boxShadow = '0 0 10px rgba(220, 53, 69, 0.3)';
        inputEtapa.focus();
        inputEtapa.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        inputEtapa.style.animation = 'shake 0.5s ease-in-out';
        setTimeout(() => {
          inputEtapa.style.animation = '';
        }, 500);
      }
      return;
    }
  }

  dados.acao = 'atualizar';
  dados.id = cadastroAtualId;

  mostrarPopupAtualizando();

  const btnAtualizar = document.getElementById('btnAtualizar');
  const btnOriginalHTML = btnAtualizar.innerHTML;
  btnAtualizar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
  btnAtualizar.disabled = true;

  google.script.run
    .withSuccessHandler(function(res) {
      esconderPopupAtualizando();
      
      btnAtualizar.innerHTML = btnOriginalHTML;
      btnAtualizar.disabled = false;
      
      if (res && res.success) {
        showMessage('success', '✅ ' + res.message);
        
        if (document.getElementById('secaoCadastros').style.display === 'block') {
          restaurarFiltros(filtrosSalvos);
        }
        
        limparFormulario();
      } else {
        showMessage('error', '❌ ' + (res ? res.message : 'Resposta inválida do servidor'));
      }
    })
    .withFailureHandler(function(error) {
      esconderPopupAtualizando();
      
      btnAtualizar.innerHTML = btnOriginalHTML;
      btnAtualizar.disabled = false;
      showMessage('error', '❌ Erro ao atualizar: ' + error.message);
    })
    .processarCadastroComWaitlabel(dados, waitlabelAtual);
}

function mostrarTodosCadastros() {
  mostrarPopupCarregandoLojas();
  
  const loading = document.getElementById('loadingCadastros');
  const tableContainer = document.getElementById('tableContainer');
  const filtrosContainer = document.getElementById('filtrosContainer');
  const secao = document.getElementById('secaoCadastros');

  loading.style.display = 'flex';
  tableContainer.style.display = 'none';
  filtrosContainer.style.display = 'none';
  secao.style.display = 'block';

  google.script.run
    .withSuccessHandler(function(cadastros) {
      esconderPopupCarregandoLojas();
      
      if (cadastros && cadastros.length > 0) {
        todosCadastros = cadastros;
        cadastrosFiltrados = [...cadastros];
        
        const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosFiltrados);
        
        cadastrosAgrupados.sort((a, b) => {
          const razaoA = a.razao_social || '';
          const razaoB = b.razao_social || '';
          return razaoA.localeCompare(razaoB, 'pt-BR', { sensitivity: 'base' });
        });
        
        exibirTabelaCadastrosAgrupada(cadastrosAgrupados, 'Todos os Cadastros');
        
        document.getElementById('filtrosContainer').style.display = 'flex';
        document.getElementById('ordenacaoCadastros').value = 'razao_social';
        
        showMessage('success', `✅ ${cadastros.length} cadastros carregados do ${formatarNomeWaitlabel(waitlabelAtual)}!`);
      } else {
        esconderPopupCarregandoLojas();
        loading.style.display = 'none';
        tableContainer.style.display = 'block';
        document.getElementById('tabelaCadastrosBody').innerHTML = `
          <tr>
            <td colspan="13" style="text-align: center; padding: 30px;">
              <i class="fas fa-inbox" style="font-size: 2.5rem; color: var(--gray); margin-bottom: 12px;"></i>
              <h3>Nenhum cadastro encontrado</h3>
              <p>Não há cadastros no waitlabel ${formatarNomeWaitlabel(waitlabelAtual)}.</p>
            </td>
          </tr>
        `;
        showMessage('info', `📝 Nenhum cadastro encontrado no ${formatarNomeWaitlabel(waitlabelAtual)}.`);
      }
    })
    .withFailureHandler(function(error) {
      esconderPopupCarregandoLojas();
      
      loading.style.display = 'none';
      showMessage('error', '❌ Erro ao carregar cadastros: ' + error.message);
    })
    .buscarTodosCadastrosComWaitlabel(waitlabelAtual);
}

function formatarMoeda(input) {
  let value = input.value.replace(/\D/g, '');
  value = (value / 100).toFixed(2);
  value = value.replace('.', ',');
  value = value.replace(/(\d)(?=(\d{3})+\,)/g, "$1.");
  input.value = 'R$ ' + value;
}

function formatarMoedaParaInput(valor) {
  if (!valor) return 'R$ 0,00';
  const numero = typeof valor === 'number' ? valor : parseFloat(valor);
  return 'R$ ' + numero.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
}

function showMessage(type, text) {
  const successEl = document.getElementById('messageSuccess');
  const errorEl = document.getElementById('messageError');
  const infoEl = document.getElementById('messageInfo');

  successEl.style.display = 'none';
  errorEl.style.display = 'none';
  infoEl.style.display = 'none';

  if (type === 'success') {
    successEl.querySelector('span').textContent = text;
    successEl.style.display = 'flex';
  } else if (type === 'error') {
    errorEl.querySelector('span').textContent = text;
    errorEl.style.display = 'flex';
  } else if (type === 'info') {
    infoEl.querySelector('span').textContent = text;
    infoEl.style.display = 'flex';
  }

  setTimeout(() => {
    successEl.style.display = 'none';
    errorEl.style.display = 'none';
    infoEl.style.display = 'none';
  }, 5000);
}

function padronizarNomeFornecedor(nome) {
  if (!nome) return '';
  
  const fornecedoresPadronizados = {
    'agil': 'AGIL',
    'bc': 'BC', 
    'parcelex': 'PARCELEX',
    'agoracred': 'AGORACRED',
    'afinz': 'AFINZ'
  };
  
  const nomeLower = nome.toLowerCase();
  return fornecedoresPadronizados[nomeLower] || nome.toUpperCase();
}

function coletarDadosFormulario() {
  try {
    const razaoSocial = document.getElementById('razao_social').value.trim();
    const cnpj = document.getElementById('cnpj_cadastro').value.trim();
    
    if (!razaoSocial || !cnpj) {
      showMessage('error', '❌ Razão Social e CNPJ são obrigatórios!');
      return null;
    }

    const situacaoSelecionada = document.getElementById('situacao').value;
    let etapaValue = document.getElementById('inputEtapaSearch').value || '';
    
    const isAplicarATodos = Object.keys(camposParaAplicarATodos).some(campo => camposParaAplicarATodos[campo]);
    const situacaoUpper = situacaoSelecionada ? situacaoSelecionada.toUpperCase().trim() : '';
    
    console.log("🔍 COLETAR DADOS - Debug:");
    console.log("📋 Situação selecionada:", situacaoSelecionada);
    console.log("🎯 Modo Aplicar a Todos:", isAplicarATodos);
    console.log("📝 Etapa do input:", etapaValue);
    console.log("✅ Campos selecionados:", camposParaAplicarATodos);

    // CORREÇÃO CRÍTICA: QUANDO APLICAR A TODOS E SITUAÇÃO FOR FINAL
    if (isAplicarATodos && camposParaAplicarATodos['situacao']) {
        console.log("🔄 Situação está sendo aplicada a todos");
        
        const ehSituacaoFinal = situacaoUpper === 'CADASTRADO' || 
                               situacaoUpper === 'REJEITADO' || 
                               situacaoUpper === 'DESCREDENCIADO' || 
                               situacaoUpper === 'DESISTIU';
        
        console.log("📊 É situação final?", ehSituacaoFinal);
        
        if (ehSituacaoFinal) {
            console.log("⚡ Situação final detectada, forçando etapa = situação");
            etapaValue = situacaoSelecionada;
            
            // Forçar o checkbox de etapa a ser marcado
            const checkboxEtapa = document.querySelector('[data-campo="inputEtapaSearch"]');
            if (checkboxEtapa) {
                checkboxEtapa.checked = true;
                camposParaAplicarATodos['inputEtapaSearch'] = true;
                console.log("✅ Checkbox de etapa marcado automaticamente");
            }
            
            // Atualizar visualmente
            document.getElementById('inputEtapaSearch').value = situacaoSelecionada;
        }
    }

    // Resto da função permanece igual...
    const cnpjFormatado = document.getElementById('cnpj_cadastro').value;

    let adesaoValue = document.getElementById('adesao').value;
    if (adesaoValue === 'R$ 0,00' || adesaoValue === '0,00' || adesaoValue === '0' || adesaoValue === 'R$ 0') {
      adesaoValue = 0;
    } else {
      adesaoValue = converterMoedaParaNumero(adesaoValue);
    }

    const checkboxesFornecedores = document.querySelectorAll('input[name="fornecedor"]:checked');
    const fornecedoresComConfiguracoes = [];

    if (checkboxesFornecedores.length === 0) {
      showMessage('error', '❌ Selecione pelo menos um fornecedor!');
      return null;
    }

    checkboxesFornecedores.forEach(checkbox => {
      const fornecedorNome = checkbox.value;
      const fornecedorPadronizado = padronizarNomeFornecedor(fornecedorNome);
      const fornecedorId = fornecedorNome.toLowerCase();
      
      const configDiv = document.getElementById(`config-${fornecedorId}`);
      if (!configDiv || configDiv.style.display !== 'grid') {
        return;
      }
      
      // Coletar valores de MDR, TIS e Rebate
      const mdrInput = document.querySelector(`input[name="mdr_${fornecedorId}"]`);
      const tisInput = document.querySelector(`input[name="tis_${fornecedorId}"]`);
      const rebateInput = document.querySelector(`input[name="rebate_${fornecedorId}"]`);
      
      let mdrValor = mdrInput ? mdrInput.value : '';
      let tisValor = tisInput ? tisInput.value : '';
      let rebateValor = rebateInput ? rebateInput.value : '';
      
      let mdrNumerico = converterPercentualParaNumero(mdrValor);
      let tisNumerico = converterPercentualParaNumero(tisValor);
      let rebateNumerico = converterPercentualParaNumero(rebateValor);

      fornecedoresComConfiguracoes.push({
          nome: fornecedorPadronizado,
          mdr: mdrNumerico,
          tis: tisNumerico,
          rebate: rebateNumerico,
          mdr_exibicao: mdrValor,
          tis_exibicao: tisValor,
          rebate_exibicao: rebateValor
      });
    });

    const dados = {
      razao_social: razaoSocial,
      nome_fantasia: document.getElementById('nome_fantasia').value,
      cnpj: cnpjFormatado,
      adesao: adesaoValue,
      fornecedores: fornecedoresComConfiguracoes,
      fornecedor: fornecedoresComConfiguracoes.length > 0 ? fornecedoresComConfiguracoes[0].nome : '',
      mdr: fornecedoresComConfiguracoes.length > 0 ? fornecedoresComConfiguracoes[0].mdr : 0,
      tis: fornecedoresComConfiguracoes.length > 0 ? fornecedoresComConfiguracoes[0].tis : 0,
      rebate: fornecedoresComConfiguracoes.length > 0 ? fornecedoresComConfiguracoes[0].rebate : 0,
      observacoes: document.getElementById('observacoes').value,
      contrato_enviado: document.getElementById('contrato_enviado').value,
      contrato_assinado: document.getElementById('contrato_assinado').value,
      ativacao: document.getElementById('ativacao').value,
      link: document.getElementById('link').value,
      mensalidade: converterMoedaParaNumero(document.getElementById('mensalidade').value),
      mensalidade_sim: converterMoedaParaNumero(document.getElementById('mensalidade_sim').value),
      situacao: situacaoSelecionada,
      etapa: etapaValue,
      operacao: 'aplicar_todos'
    };

    console.log("✅ Dados finais para enviar:", dados);

    return dados;

  } catch (error) {
    showMessage('error', '❌ Erro interno ao processar formulário: ' + error.message);
    return null;
  }
}

function formatarPercentualParaExibicao(percentual) {
    if (!percentual && percentual !== 0) return '';
    
    console.log("🔍 formatarPercentualParaExibicao recebeu:", percentual, "tipo:", typeof percentual);
    
    try {
        // Se for string (ex: "4,78%" ou "0.05%")
        if (typeof percentual === 'string') {
            const valorLimpo = percentual.replace('%', '').replace(',', '.').trim();
            const numero = parseFloat(valorLimpo);
            
            if (!isNaN(numero)) {
                // Se for número muito pequeno (ex: 0.05), provavelmente está errado
                if (numero < 1 && numero > 0) {
                    // Multiplica por 100 para corrigir: 0.05 → 5.00
                    const corrigido = (numero * 100).toFixed(2).replace('.', ',') + '%';
                    console.log("✅ Corrigido:", percentual, "→", corrigido);
                    return corrigido;
                }
                // Número normal (ex: 4.78)
                return numero.toFixed(2).replace('.', ',') + '%';
            }
            return percentual;
        }
        
        // Se for número
        if (typeof percentual === 'number') {
            // Se for número pequeno (ex: 0.05), provavelmente está errado
            if (percentual < 1 && percentual > 0) {
                // Multiplica por 100 para corrigir: 0.05 → 5.00
                const corrigido = (percentual * 100).toFixed(2).replace('.', ',') + '%';
                console.log("✅ Número corrigido:", percentual, "→", corrigido);
                return corrigido;
            }
            // Número normal (ex: 4.78)
            return percentual.toFixed(2).replace('.', ',') + '%';
        }
        
        return String(percentual);
        
    } catch (error) {
        console.error("❌ Erro em formatarPercentualParaExibicao:", error);
        return String(percentual || '');
    }
}

function converterPercentualParaNumero(valorInput) {
    if (!valorInput && valorInput !== 0) return 0;
    
    try {
        // Se já é número, retorna como está
        if (typeof valorInput === 'number') {
            console.log("🔢 Número recebido:", valorInput);
            return valorInput; // 4.20 → 4.20 (CORRETO)
        }
        
        // Se é string
        if (typeof valorInput === 'string') {
            console.log("📝 String recebida:", valorInput);
            
            // Remove % e espaços
            const strLimpa = valorInput.replace('%', '').replace(/\s/g, '').trim();
            
            // Troca vírgula por ponto
            const strComPonto = strLimpa.replace(',', '.');
            
            // Converte para número
            const numero = parseFloat(strComPonto);
            
            if (isNaN(numero)) {
                console.log("⚠️ Não é número válido:", valorInput);
                return 0;
            }
            
            console.log("✅ Número convertido:", numero);
            
            // ⚠️ CRÍTICO: NUNCA DIVIDIR POR 100!
            // "4,20%" deve virar 4.20, NÃO 0.042
            return numero;
        }
        
        // Para qualquer outro tipo
        const numeroFinal = parseFloat(valorInput) || 0;
        console.log("📦 Outro tipo convertido:", valorInput, "→", numeroFinal);
        return numeroFinal;
        
    } catch (error) {
        console.error("❌ Erro ao converter percentual:", error, "Valor:", valorInput);
        return 0;
    }
}

function validarPercentuais() {
    const inputsPercentual = document.querySelectorAll('input[name^="mdr_"], input[name^="tis_"], input[name^="rebate_"]');
    let todosValidos = true;
    
    inputsPercentual.forEach(input => {
        if (input.closest('.fornecedor-item').style.display === 'grid') {
            const valor = input.value.trim();
            if (valor && !valor.match(/^\d+[,]?\d*%$/)) {
                input.style.borderColor = 'var(--danger)';
                todosValidos = false;
            } else {
                input.style.borderColor = '';
            }
        }
    });
    
    return todosValidos;
}

function toggleFornecedorConfig(checkbox, fornecedorId) {
  const configDiv = document.getElementById(`config-${fornecedorId}`);
  
  if (checkbox.checked) {
    configDiv.style.display = 'grid';
    // Atualizar displays
    const mdrInput = configDiv.querySelector(`input[name="mdr_${fornecedorId}"]`);
    const tisInput = configDiv.querySelector(`input[name="tis_${fornecedorId}"]`);
    const rebateInput = configDiv.querySelector(`input[name="rebate_${fornecedorId}"]`);
    
    if (mdrInput) formatarPercentual(mdrInput, `mdr_${fornecedorId}_display`);
    if (tisInput) formatarPercentual(tisInput, `tis_${fornecedorId}_display`);
    if (rebateInput) formatarPercentual(rebateInput, `rebate_${fornecedorId}_display`);
  } else {
    configDiv.style.display = 'none';
  }
}
function formatarPercentual(input, displayId) {
    const cursorPos = input.selectionStart;
    let valor = input.value;
    
    console.log("⌨️ formatarPercentual input:", valor);
    
    // Permitir apenas números, vírgula e %
    valor = valor.replace(/[^\d,%]/g, '');
    
    // Garantir que tem % no final
    if (valor && !valor.includes('%')) {
        valor = valor + '%';
    }
    
    // Substituir ponto por vírgula
    valor = valor.replace('.', ',');
    
    input.value = valor;
    
    // Atualizar display
    const display = document.getElementById(displayId);
    if (display) {
        display.textContent = valor || 'N/A';
        console.log("🖥️ Display atualizado:", valor);
    }
    
    // Restaurar posição do cursor
    setTimeout(() => {
        let novaPos = Math.min(cursorPos, input.value.length);
        input.setSelectionRange(novaPos, novaPos);
    }, 0);
    
    // Validar formato
    const formatoValido = /^\d+[,]?\d*%$/;
    if (valor && !formatoValido.test(valor)) {
        input.style.borderColor = 'var(--danger)';
        console.log("❌ Formato inválido:", valor);
    } else {
        input.style.borderColor = '';
    }
}

function converterMoedaParaNumero(valorMoeda) {
  if (!valorMoeda) return 0;
  
  try {
    if (typeof valorMoeda === 'number') {
      return valorMoeda;
    }
    
    if (typeof valorMoeda === 'string') {
      let valorLimpo = valorMoeda
        .replace('R$', '')
        .replace(/\./g, '')
        .replace(',', '.')
        .trim();
      
      const numero = parseFloat(valorLimpo);
      
      if (isNaN(numero)) {
        return 0;
      }
      
      return numero;
    }
    
    return parseFloat(valorMoeda) || 0;
    
  } catch (error) {
    return 0;
  }
}

function preencherDadosCadastro(dados) {
  if (!dados.encontrado) {
    showMessage('error', '❌ ' + dados.mensagem);
    return;
  }

  try {
    preencherCampoSeExistir('razao_social', dados.razao_social);
    preencherCampoSeExistir('nome_fantasia', dados.nome_fantasia);
    preencherCampoSeExistir('cnpj_cadastro', dados.cnpj);
    preencherCampoSeExistir('observacoes', dados.observacoes);
    preencherCampoSeExistir('contrato_enviado', dados.contrato_enviado);
    preencherCampoSeExistir('contrato_assinado', dados.contrato_assinado);
    
    // CORREÇÃO: FORMATAR DATA DE ATIVAÇÃO PARA O INPUT DATE
    if (dados.ativacao) {
      const dataFormatada = formatarDataParaInputDate(dados.ativacao);
      preencherCampoSeExistir('ativacao', dataFormatada);
    } else {
      preencherCampoSeExistir('ativacao', '');
    }
    
    preencherCampoSeExistir('link', dados.link);
    preencherCampoSeExistir('situacao', dados.situacao || 'NOVO REGISTRO');
    
    preencherCampoSeExistir('mensalidade', formatarMoedaParaInput(dados.mensalidade));
    preencherCampoSeExistir('mensalidade_sim', formatarMoedaParaInput(dados.mensalidade_sim));
    preencherCampoSeExistir('adesao', dados.adesao === 'Isento' || dados.adesao === 0 ? 'R$ 0,00' : formatarMoedaParaInput(dados.adesao));
    
    // CORREÇÃO: QUANDO É SITUAÇÃO FINAL, PREENCHER ETAPA COM A SITUAÇÃO
    const situacaoUpper = dados.situacao ? dados.situacao.toUpperCase().trim() : '';
    const ehSituacaoFinal = situacaoUpper === 'CADASTRADO' || 
                           situacaoUpper === 'REJEITADO' || 
                           situacaoUpper === 'DESCREDENCIADO' || 
                           situacaoUpper === 'DESISTIU';
    
    if (ehSituacaoFinal) {
      preencherCampoSeExistir('inputEtapaSearch', dados.situacao);
    } else {
      preencherCampoSeExistir('inputEtapaSearch', dados.etapa);
    }
    
    preencherFornecedorComMDRTIS(dados);

    cadastroAtualId = dados.id;
    
    const btnCadastrar = document.getElementById('btnCadastrar');
    const btnAtualizar = document.getElementById('btnAtualizar');
    
    if (btnCadastrar) btnCadastrar.style.display = 'none';
    if (btnAtualizar) btnAtualizar.style.display = 'block';

    setTimeout(() => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 100);
    
    showMessage('success', '✅ Cadastro carregado para edição!');
    
  } catch (error) {
    showMessage('error', '❌ Erro ao carregar cadastro: ' + error.message);
  }
}

function formatarDataParaInputDate(data) {
  if (!data) return '';
  
  try {
    // Se já estiver no formato YYYY-MM-DD (input date)
    if (typeof data === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(data)) {
      return data;
    }
    
    // Se estiver no formato DD/MM/YYYY
    if (typeof data === 'string' && data.includes('/')) {
      const partes = data.split('/');
      if (partes.length === 3) {
        const [dia, mes, ano] = partes;
        // Verificar se é formato brasileiro
        if (dia.length === 2 && mes.length === 2 && ano.length === 4) {
          return `${ano}-${mes}-${dia}`;
        }
      }
    }
    
    // Se for um objeto Date ou string com GMT
    const dateObj = new Date(data);
    if (!isNaN(dateObj.getTime())) {
      const ano = dateObj.getFullYear();
      const mes = String(dateObj.getMonth() + 1).padStart(2, '0');
      const dia = String(dateObj.getDate()).padStart(2, '0');
      return `${ano}-${mes}-${dia}`;
    }
    
    return '';
  } catch (error) {
    console.error('Erro ao formatar data para input:', error);
    return '';
  }
}

function preencherCampoSeExistir(campoId, valor) {
  const campo = document.getElementById(campoId);
  if (campo) {
    campo.value = valor || '';
  }
}

function validarCamposObrigatorios() {
  document.querySelectorAll('.campo-obrigatorio').forEach(campo => {
    campo.classList.remove('campo-obrigatorio');
  });

  let camposInvalidos = [];

  const isAtualizacao = cadastroAtualId !== null;
  const isAplicarATodos = Object.keys(camposParaAplicarATodos).some(campo => camposParaAplicarATodos[campo]);
  
  const camposSempreObrigatorios = [
    { 
      id: 'razao_social', 
      nome: 'Razão Social', 
      elemento: document.getElementById('razao_social'),
      tipo: 'text'
    },
    { 
      id: 'cnpj_cadastro', 
      nome: 'CNPJ', 
      elemento: document.getElementById('cnpj_cadastro'),
      tipo: 'text'
    },
    { 
      id: 'mensalidade', 
      nome: 'Mensalidade', 
      elemento: document.getElementById('mensalidade'),
      tipo: 'moeda'
    },
    { 
      id: 'situacao', 
      nome: 'Situação', 
      elemento: document.getElementById('situacao'),
      tipo: 'select'
    }
  ];

  const camposApenasCadastro = [
    { 
      id: 'contrato_enviado', 
      nome: 'Contrato Enviado', 
      elemento: document.getElementById('contrato_enviado'),
      tipo: 'select'
    },
    { 
      id: 'contrato_assinado', 
      nome: 'Contrato Assinado', 
      elemento: document.getElementById('contrato_assinado'),
      tipo: 'select'
    }
  ];

  let camposParaValidar = [...camposSempreObrigatorios];
  
  if (!isAtualizacao) {
    camposParaValidar = [...camposParaValidar, ...camposApenasCadastro];
  }

  const situacaoSelecionada = document.getElementById('situacao').value;
  const situacaoNormalizada = situacaoSelecionada ? situacaoSelecionada.toUpperCase().trim() : '';
  const precisaValidarEtapa = situacaoNormalizada === 'EM ANDAMENTO' || situacaoNormalizada === 'NOVO REGISTRO';
  
  if (precisaValidarEtapa) {
    camposParaValidar.push({
      id: 'inputEtapaSearch', 
      nome: 'Etapa',
      elemento: document.getElementById('inputEtapaSearch'),
      tipo: 'text'
    });
  }

  for (const campo of camposParaValidar) {
    let valor = campo.elemento.value;
    let estaVazio = false;

    switch(campo.tipo) {
      case 'select':
        estaVazio = !valor || valor === '' || valor === '-- Selecione --';
        break;
      case 'moeda':
          estaVazio = !valor || valor.toString().trim() === '';
        break;
      default:
        estaVazio = !valor || valor.toString().trim() === '';
    }

    if (estaVazio) {
      campo.elemento.classList.add('campo-obrigatorio');
      camposInvalidos.push(campo.nome);
      
      if (camposInvalidos.length === 1) {
        campo.elemento.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  }

  return camposInvalidos;
}

function preencherFornecedorComMDRTIS(dados) {
  console.log("🔍 === DADOS CRUS DO SERVIDOR ===");
    console.log("MDR:", dados.mdr, "Tipo:", typeof dados.mdr);
    console.log("TIS:", dados.tis, "Tipo:", typeof dados.tis);
    console.log("Rebate:", dados.rebate, "Tipo:", typeof dados.rebate);
    console.log("=================================");
  const checkboxes = document.querySelectorAll('input[name="fornecedor"]');
  
  // 1. LIMPAR TODOS OS CHECKBOXES E CONFIGS
  checkboxes.forEach(cb => {
    cb.checked = false;
    const fornecedorId = cb.value.toLowerCase();
    const configDiv = document.getElementById(`config-${fornecedorId}`);
    
    if (configDiv) {
      configDiv.style.display = 'none';
      
      // Limpar inputs
      const mdrInput = configDiv.querySelector(`input[name="mdr_${fornecedorId}"]`);
      const tisInput = configDiv.querySelector(`input[name="tis_${fornecedorId}"]`);
      const rebateInput = configDiv.querySelector(`input[name="rebate_${fornecedorId}"]`);
      
      if (mdrInput) mdrInput.value = '';
      if (tisInput) tisInput.value = '';
      if (rebateInput) rebateInput.value = '';
      
      // Limpar displays
      const mdrDisplay = document.getElementById(`mdr_${fornecedorId}_display`);
      const tisDisplay = document.getElementById(`tis_${fornecedorId}_display`);
      const rebateDisplay = document.getElementById(`rebate_${fornecedorId}_display`);
      
      if (mdrDisplay) mdrDisplay.textContent = '';
      if (tisDisplay) tisDisplay.textContent = '';
      if (rebateDisplay) rebateDisplay.textContent = '';
    }
  });
  
  // 2. SE NÃO TIVER FORNECEDOR NOS DADOS, PARA AQUI
  if (!dados.fornecedor) {
    console.log("⚠️ Nenhum fornecedor nos dados para preencher");
    return;
  }
  
  const fornecedorBuscado = dados.fornecedor.toUpperCase().trim();
  console.log("🔍 Buscando fornecedor:", fornecedorBuscado);
  
  // 3. ENCONTRAR O CHECKBOX CORRESPONDENTE
  let checkboxEncontrado = null;
  
  checkboxes.forEach(cb => {
    const checkboxValor = cb.value.toUpperCase().trim();
    console.log(`  Comparando: "${checkboxValor}" com "${fornecedorBuscado}"`);
    
    if (checkboxValor === fornecedorBuscado) {
      checkboxEncontrado = cb;
    }
  });
  
  // 4. SE ENCONTROU, PREENCHER
  if (checkboxEncontrado) {
    console.log("✅ Fornecedor encontrado:", checkboxEncontrado.value);
    checkboxEncontrado.checked = true;
    
    const fornecedorId = checkboxEncontrado.value.toLowerCase();
    const configDiv = document.getElementById(`config-${fornecedorId}`);
    
    if (configDiv) {
      configDiv.style.display = 'grid';
      
      console.log("📊 Dados recebidos para preencher:");
      console.log("  MDR:", dados.mdr, "(tipo:", typeof dados.mdr, ")");
      console.log("  TIS:", dados.tis, "(tipo:", typeof dados.tis, ")");
      console.log("  Rebate:", dados.rebate, "(tipo:", typeof dados.rebate, ")");
      
      // 🎯 PREENCHER MDR (COM CORREÇÃO)
      if (dados.mdr !== undefined && dados.mdr !== null) {
        const mdrInput = configDiv.querySelector(`input[name="mdr_${fornecedorId}"]`);
        if (mdrInput) {
          // Usar a função corrigida para exibição
          let mdrFormatado = formatarPercentualParaExibicaoCorrigida(dados.mdr);
          mdrInput.value = mdrFormatado;
          console.log("  MDR formatado para input:", mdrFormatado);
          
          // Atualizar display
          formatarPercentual(mdrInput, `mdr_${fornecedorId}_display`);
        }
      }
      
      // 🎯 PREENCHER TIS (COM CORREÇÃO)
      if (dados.tis !== undefined && dados.tis !== null) {
        const tisInput = configDiv.querySelector(`input[name="tis_${fornecedorId}"]`);
        if (tisInput) {
          // Usar a função corrigida para exibição
          let tisFormatado = formatarPercentualParaExibicaoCorrigida(dados.tis);
          tisInput.value = tisFormatado;
          console.log("  TIS formatado para input:", tisFormatado);
          
          // Atualizar display
          formatarPercentual(tisInput, `tis_${fornecedorId}_display`);
        }
      }
      
      // 🎯 PREENCHER REBATE (COM CORREÇÃO)
      if (dados.rebate !== undefined && dados.rebate !== null) {
        const rebateInput = configDiv.querySelector(`input[name="rebate_${fornecedorId}"]`);
        if (rebateInput) {
          // Usar a função corrigida para exibição
          let rebateFormatado = formatarPercentualParaExibicaoCorrigida(dados.rebate);
          rebateInput.value = rebateFormatado;
          console.log("  Rebate formatado para input:", rebateFormatado);
          
          // Atualizar display
          formatarPercentual(rebateInput, `rebate_${fornecedorId}_display`);
        }
      }
    } else {
      console.log("❌ Config div não encontrada para:", fornecedorId);
    }
  } else {
    console.log("❌ Fornecedor não encontrado nos checkboxes:", fornecedorBuscado);
    console.log("Checkboxes disponíveis:");
    checkboxes.forEach(cb => {
      console.log(`  - ${cb.value}`);
    });
  }
}

function formatarPercentualParaExibicaoCorrigida(valor) {
    if (!valor && valor !== 0) {
        console.log("📭 Valor vazio ou null");
        return '';
    }
    
    console.log("🔧 formatarPercentualParaExibicaoCorrigida recebeu:", valor, "tipo:", typeof valor);
    
    try {
        // CASO 1: STRING JÁ FORMATADA (ex: "8,00%" ou "5,53%")
        if (typeof valor === 'string' && valor.includes('%')) {
            console.log("✅ String já formatada, retornando como está:", valor);
            return valor;
        }
        
        // CASO 2: STRING NUMÉRICA (ex: "8" ou "5.53")
        if (typeof valor === 'string') {
            const valorLimpo = valor.replace(',', '.').trim();
            const numero = parseFloat(valorLimpo);
            
            if (!isNaN(numero)) {
                console.log("✅ String numérica convertida:", valor, "→", numero);
                // MULTIPLICAR POR 100 se for menor que 1 (assumindo que é decimal)
                if (numero < 1) {
                    const corrigido = (numero * 100).toFixed(2).replace('.', ',') + '%';
                    console.log("🔄 Corrigido (decimal → percentual):", valor, "→", corrigido);
                    return corrigido;
                }
                // Se já for percentual (ex: 8.5)
                return numero.toFixed(2).replace('.', ',') + '%';
            }
            console.log("⚠️ String não numérica:", valor);
            return valor;
        }
        
        // CASO 3: NÚMERO (ex: 0.08, 0.0553, 0.688)
        if (typeof valor === 'number') {
            console.log("🔢 Processando número:", valor);
            
            // ⚠️ IMPORTANTE: MULTIPLICAR POR 100 SE FOR DECIMAL!
            if (valor < 1) {
                const formatado = (valor * 100).toFixed(2).replace('.', ',') + '%';
                console.log("✅ Decimal formatado:", valor, "→", formatado);
                return formatado;
            }
            // Se já for percentual (ex: 8)
            const formatado = valor.toFixed(2).replace('.', ',') + '%';
            console.log("✅ Percentual formatado:", valor, "→", formatado);
            return formatado;
        }
        
        // CASO 4: QUALQUER OUTRO TIPO
        console.log("📦 Outro tipo:", typeof valor, valor);
        return String(valor);
        
    } catch (error) {
        console.error("❌ Erro em formatarPercentualParaExibicaoCorrigida:", error);
        return String(valor || '');
    }
}

function limparFormulario() {
  document.getElementById('razao_social').value = '';
  document.getElementById('nome_fantasia').value = '';
  document.getElementById('cnpj_cadastro').value = '';
  
  const checkboxes = document.querySelectorAll('input[name="fornecedor"]');
  checkboxes.forEach(cb => {
    cb.checked = false;
    const fornecedorId = cb.value.toLowerCase();
    const configDiv = document.getElementById(`config-${fornecedorId}`);
    if (configDiv) {
      configDiv.style.display = 'none';
      
      const mdrInput = configDiv.querySelector(`input[name="mdr_${fornecedorId}"]`);
      const tisInput = configDiv.querySelector(`input[name="tis_${fornecedorId}"]`);
      const rebateInput = configDiv.querySelector(`input[name="rebate_${fornecedorId}"]`);
      
      if (mdrInput) mdrInput.value = '';
      if (tisInput) tisInput.value = '';
      if (rebateInput) rebateInput.value = '';
      
      // Limpar displays
      const mdrDisplay = document.getElementById(`mdr_${fornecedorId}_display`);
      const tisDisplay = document.getElementById(`tis_${fornecedorId}_display`);
      const rebateDisplay = document.getElementById(`rebate_${fornecedorId}_display`);
      
      if (mdrDisplay) mdrDisplay.textContent = '';
      if (tisDisplay) tisDisplay.textContent = '';
      if (rebateDisplay) rebateDisplay.textContent = '';
    }
  });
  
  document.getElementById('observacoes').value = '';
  document.getElementById('contrato_enviado').value = '';
  document.getElementById('contrato_assinado').value = '';
  document.getElementById('ativacao').value = '';
  document.getElementById('link').value = '';
  document.getElementById('mensalidade').value = 'R$ 0,00';
  document.getElementById('mensalidade_sim').value = 'R$ 0,00';
  
  document.getElementById('situacao').value = 'NOVO REGISTRO';
  document.getElementById('adesao').value = 'R$ 0,00';
  
  document.getElementById('inputEtapaSearch').value = '';
  document.getElementById('etapa').value = '';
  document.getElementById('suggestionsEtapaSearch').style.display = 'none';
  
  atualizarEtapas();
  
  document.getElementById('btnCadastrar').style.display = 'block';
  document.getElementById('btnAtualizar').style.display = 'none';
  cadastroAtualId = null;
  
  const checkboxesFornecedores = document.querySelectorAll('input[name="fornecedor"]');
  const configsFornecedores = document.querySelectorAll('[id^="config-"]');

  checkboxesFornecedores.forEach(checkbox => {
      checkbox.disabled = false;
      checkbox.style.cursor = 'pointer';
      checkbox.style.opacity = '1';
  });

  configsFornecedores.forEach(config => {
      const inputs = config.querySelectorAll('input, select');
      inputs.forEach(input => {
          input.disabled = false;
          input.style.cursor = 'pointer';
          input.style.opacity = '1';
      });
  });
  
  document.querySelectorAll('.campo-obrigatorio').forEach(campo => {
    campo.classList.remove('campo-obrigatorio');
    campo.style.borderColor = '';
    campo.style.backgroundColor = '';
  });
  
  limparSelecaoAplicarATodos();
  
  document.getElementById('btnAplicarATodos').style.display = 'none';
}

function configurarBotoesAplicarATodos(cnpj) {
    cnpjAtualParaAplicar = cnpj;
    
    limparSelecaoAplicarATodos();
    
    adicionarCheckboxesAosCampos();
    
    mostrarBotaoAplicarATodos();
}

function agruparCadastrosPorCNPJ(cadastros) {
  const agrupados = {};
  
  cadastros.forEach(cadastro => {
    if (!agrupados[cadastro.cnpj]) {
      agrupados[cadastro.cnpj] = {
        razao_social: cadastro.razao_social,
        nome_fantasia: cadastro.nome_fantasia,
        cnpj: cadastro.cnpj,
        lojas: []
      };
    }
    
    agrupados[cadastro.cnpj].lojas.push(cadastro);
  });
  
  return Object.values(agrupados);
}

function getSituacaoClass(situacao) {
  if (!situacao) return 'situacao-cadastrado';
  
  const situacaoUpper = situacao.toUpperCase().trim();
  
  if (situacaoUpper.includes('NOVO REGISTRO')) return 'situacao-novo-registro';
  else if (situacaoUpper.includes('CADASTRADO')) return 'situacao-cadastrado';
  else if (situacaoUpper.includes('EM ANDAMENTO')) return 'situacao-andamento';
  else if (situacaoUpper.includes('REJEITADO') || situacaoUpper.includes('REJEITADO')) return 'situacao-rejeitado';
  else if (situacaoUpper.includes('DESCREDENCIADO')) return 'situacao-descredenciado';
  else if (situacaoUpper.includes('DESISTIU')) return 'situacao-desistiu';
  else return 'situacao-cadastrado';
}

function editarCadastroModal(id) {
    fecharModalFornecedores(); // Fecha o modal de fornecedores se estiver aberto
    fecharModalDetalhes(); // Fecha o modal de detalhes se estiver aberto
    
    mostrarPopupCarregandoModal();
    
    google.script.run
        .withSuccessHandler(function(dados) {
            esconderPopupCarregandoModal();
            
            if (dados.encontrado) {
                preencherDadosCadastro(dados);
                document.getElementById('razao_social').scrollIntoView({ behavior: 'smooth' });
                showMessage('success', '✅ Cadastro carregado para edição!');
                
                configurarBotoesAplicarATodos(dados.cnpj);
                
                document.getElementById('btnAplicarATodos').style.display = 'block';
            } else {
                showMessage('error', '❌ ' + dados.mensagem);
            }
        })
        .withFailureHandler(function(error) {
            esconderPopupCarregandoModal();
            showMessage('error', '❌ Erro ao carregar cadastro: ' + error.message);
        })
        .buscarCadastroPorIDComWaitlabel(id, waitlabelAtual);
}

function atualizarEtapas() {
  const selectEtapa = document.getElementById('etapa');
  
  selectEtapa.innerHTML = '<option value="">-- Selecione uma etapa --</option>';
  
  const etapas = [
    ...etapasPendenteFornecedor,
    ...etapasPendenteSIM,
    ...etapasPendenteRetornoExterno
  ];
  
  etapas.forEach(etapa => {
    const option = document.createElement('option');
    option.value = etapa;
    option.textContent = etapa;
    selectEtapa.appendChild(option);
  });
  
  atualizarEtapasSearch();
}

function atualizarEtapasSearch() {
  const situacao = document.getElementById('situacao').value;
  const inputSearch = document.getElementById('inputEtapaSearch');
  
  inputSearch.value = '';
}

function filtrarSugestoesEtapaSearch() {
  const input = document.getElementById('inputEtapaSearch');
  const suggestions = document.getElementById('suggestionsEtapaSearch');
  const termo = input.value.toLowerCase().trim();
  
  const todasEtapas = [
    ...etapasPendenteFornecedor,
    ...etapasPendenteSIM,
    ...etapasPendenteRetornoExterno
  ];
  
  let etapasParaMostrar = todasEtapas;
  
  if (termo.length > 0) {
    etapasParaMostrar = todasEtapas.filter(etapa => 
      etapa.toLowerCase().includes(termo)
    );
  }
  
  if (etapasParaMostrar.length === 0) {
    suggestions.innerHTML = `
      <div class="suggestion-etapa-item-search" style="color: var(--gray);">
        <i class="fas fa-search"></i>
        Nenhuma etapa encontrada para "${termo}"
      </div>
    `;
  } else {
    let html = '';
    
    todasEtapas.forEach(etapa => {
      if (termo.length === 0 || etapa.toLowerCase().includes(termo)) {
        let cor = "#7E3E9A";
        let icone = "fas fa-calendar-check";
        
        if (etapasPendenteFornecedor.includes(etapa)) {
          cor = "#FF6B35";
          icone = "fas fa-truck";
        } else if (etapasPendenteSIM.includes(etapa)) {
          cor = "#7E3E9A";
          icone = "fas fa-building";
        } else if (etapasPendenteRetornoExterno.includes(etapa)) {
          cor = "#0682c5";
          icone = "fas fa-undo-alt";
        }
        
        html += `
          <div class="suggestion-etapa-item-search" 
               onclick="selecionarEtapaSearch('${etapa.replace(/'/g, "\\'")}')"
               data-etapa="${etapa}">
            <i class="${icone}" style="color: ${cor}"></i>
            <span>${etapa}</span>
          </div>
        `;
      }
    });
    
    suggestions.innerHTML = html;
  }
  
  suggestions.style.display = 'block';
}

function selecionarEtapaSearch(etapa) {
  const input = document.getElementById('inputEtapaSearch');
  const suggestions = document.getElementById('suggestionsEtapaSearch');
  const selectEtapa = document.getElementById('etapa');
  
  input.value = etapa;
  selectEtapa.value = etapa;
  
  suggestions.style.display = 'none';
}

function formatarDataParaExibicao(data) {
  if (!data) return 'N/A';
  
  try {
    // Se for string com formato ISO (YYYY-MM-DD)
    if (typeof data === 'string' && data.includes('-') && data.length >= 10) {
      // Extrair ano, mês, dia
      const partes = data.split('T')[0].split('-');
      if (partes.length >= 3) {
        const [ano, mes, dia] = partes;
        return `${dia.padStart(2, '0')}/${mes.padStart(2, '0')}/${ano}`;
      }
    }
    
    // Se for string com barras (DD/MM/YYYY)
    if (typeof data === 'string' && data.includes('/')) {
      const partes = data.split('/');
      if (partes.length === 3) {
        // Verificar se já está no formato correto
        if (partes[0].length === 2 && partes[1].length === 2 && partes[2].length === 4) {
          return data;
        }
      }
    }
    
    // Se for uma string que contém "GMT" ou é um timestamp
    if (typeof data === 'string' && (data.includes('GMT') || data.includes('('))) {
      // Limpar a string para extrair apenas a parte da data
      const dataLimpa = data.replace(/\(.*\)/g, '').trim();
      const dateObj = new Date(dataLimpa);
      
      if (!isNaN(dateObj.getTime())) {
        const dia = String(dateObj.getDate()).padStart(2, '0');
        const mes = String(dateObj.getMonth() + 1).padStart(2, '0');
        const ano = dateObj.getFullYear();
        return `${dia}/${mes}/${ano}`;
      }
    }
    
    // Tentar criar objeto Date diretamente
    const dateObj = new Date(data);
    if (!isNaN(dateObj.getTime())) {
      const dia = String(dateObj.getDate()).padStart(2, '0');
      const mes = String(dateObj.getMonth() + 1).padStart(2, '0');
      const ano = dateObj.getFullYear();
      return `${dia}/${mes}/${ano}`;
    }
    
    // Se nada funcionar, retornar N/A
    return 'N/A';
  } catch (error) {
    console.error('Erro ao formatar data:', error, 'Data:', data);
    return 'N/A';
  }
}

function limparBusca() {
  limparFormulario();
  
  document.getElementById('secaoCadastros').style.display = 'none';
  showMessage('info', 'Formulário limpo e busca cancelada!');
}

function configurarValidacaoEmTempoReal() {
  const campos = document.querySelectorAll('#razao_social, #cnpj_cadastro, #tipo');
  campos.forEach(campo => {
    campo.addEventListener('input', function() {
      this.style.borderColor = '';
    });
  });
}

function configurarModalSenha() {
  const inputSenha = document.getElementById('inputSenha');
  if (inputSenha) {
    inputSenha.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        validarSenha();
      }
    });
  }
  
  const modalSenha = document.getElementById('modalSenha');
  if (modalSenha) {
    modalSenha.addEventListener('click', function(e) {
      if (e.target === this) {
        fecharModalSenha();
      }
    });
  }
  
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('modalSenha').style.display === 'flex') {
      fecharModalSenha();
    }
  });
}

function solicitarSenha(campo) {
  campoEditavel = campo;
  
  document.getElementById('modalSenha').style.display = 'flex';
  
  const inputSenha = document.getElementById('inputSenha');
  if (inputSenha) {
    inputSenha.value = '';
    inputSenha.focus();
  }
}

function validarSenha() {
  const inputSenha = document.getElementById('inputSenha');
  if (!inputSenha) {
    return;
  }
  
  const senha = inputSenha.value;
  
  if (senha === SENHA_PERMITIDA) {
    const agora = new Date();
    const expiracao = new Date(agora.getTime() + (24 * 60 * 60 * 1000));
    
    localStorage.setItem('usuarioAutorizado', 'true');
    localStorage.setItem('autorizacaoExpiracao', expiracao.getTime().toString());
    localStorage.setItem('ultimaAutorizacao', agora.getTime().toString());
    
    fecharModalSenha();
    
    liberarTodosCamposProtegidos();
    
    showMessage('success', '✅ Todos os campos liberados por 24 horas!');
    
  } else {
    showMessage('error', '❌ Senha incorreta!');
    inputSenha.value = '';
    inputSenha.focus();
  }
}

function coletarDadosFormularioTemporario() {
  const dados = {
    razao_social: document.getElementById('razao_social').value,
    nome_fantasia: document.getElementById('nome_fantasia').value,
    cnpj_cadastro: document.getElementById('cnpj_cadastro').value,
    observacoes: document.getElementById('observacoes').value,
    contrato_enviado: document.getElementById('contrato_enviado').value,
    contrato_assinado: document.getElementById('contrato_assinado').value,
    ativacao: document.getElementById('ativacao').value,
    link: document.getElementById('link').value,
    mensalidade: document.getElementById('mensalidade').value,
    situacao: document.getElementById('situacao').value,
    adesao: document.getElementById('adesao').value,
    etapa: document.getElementById('inputEtapaSearch').value
  };
  
  const fornecedoresSelecionados = [];
  const checkboxes = document.querySelectorAll('input[name="fornecedor"]:checked');
  checkboxes.forEach(checkbox => {
    const fornecedorNome = checkbox.value;
    const fornecedorId = fornecedorNome.toLowerCase();
    const configDiv = document.getElementById(`config-${fornecedorId}`);
    
    if (configDiv && configDiv.style.display === 'grid') {
      const mdrInput = configDiv.querySelector(`input[name="mdr_${fornecedorId}"]`);
      const tisInput = configDiv.querySelector(`input[name="tis_${fornecedorId}"]`);
      const rebateInput = configDiv.querySelector(`input[name="rebate_${fornecedorId}"]`);
      
      fornecedoresSelecionados.push({
        nome: fornecedorNome,
        mdr: mdrInput ? mdrInput.value : '',
        tis: tisInput ? tisInput.value : '',
        rebate: rebateInput ? rebateInput.value : ''
      });
    }
  });

  dados.fornecedores = fornecedoresSelecionados;
  return dados;
}

function restaurarDadosFormulario(dados) {
  if (!dados) return;
  
  document.getElementById('razao_social').value = dados.razao_social || '';
  document.getElementById('nome_fantasia').value = dados.nome_fantasia || '';
  document.getElementById('cnpj_cadastro').value = dados.cnpj_cadastro || '';
  document.getElementById('observacoes').value = dados.observacoes || '';
  document.getElementById('contrato_enviado').value = dados.contrato_enviado || '';
  document.getElementById('contrato_assinado').value = dados.contrato_assinado || '';
  document.getElementById('ativacao').value = dados.ativacao || '';
  document.getElementById('link').value = dados.link || '';
  document.getElementById('mensalidade').value = dados.mensalidade || 'R$ 0,00';
  document.getElementById('situacao').value = dados.situacao || 'NOVO REGISTRO';
  document.getElementById('adesao').value = dados.adesao || 'R$ 0,00';
  document.getElementById('inputEtapaSearch').value = dados.etapa || '';
  
  if (dados.fornecedores && dados.fornecedores.length > 0) {
    dados.fornecedores.forEach(fornecedor => {
      const checkbox = document.querySelector(`input[name="fornecedor"][value="${fornecedor.nome}"]`);
      if (checkbox) {
        checkbox.checked = true;
        const fornecedorId = fornecedor.nome.toLowerCase();
        const configDiv = document.getElementById(`config-${fornecedorId}`);
        
        if (configDiv) {
          configDiv.style.display = 'grid';
          
          if (fornecedor.mdr) {
            const mdrInput = configDiv.querySelector(`input[name="mdr_${fornecedorId}"]`);
            if (mdrInput) {
              mdrInput.value = fornecedor.mdr;
              formatarPercentual(mdrInput, `mdr_${fornecedorId}_display`);
            }
          }
          
          if (fornecedor.tis) {
            const tisInput = configDiv.querySelector(`input[name="tis_${fornecedorId}"]`);
            if (tisInput) {
              tisInput.value = fornecedor.tis;
              formatarPercentual(tisInput, `tis_${fornecedorId}_display`);
            }
          }
          
          if (fornecedor.rebate) {
            const rebateInput = configDiv.querySelector(`input[name="rebate_${fornecedorId}"]`);
            if (rebateInput) {
              rebateInput.value = fornecedor.rebate;
              formatarPercentual(rebateInput, `rebate_${fornecedorId}_display`);
            }
          }
        }
      }
    });
  }
}

function fecharModalSenha() {
  document.getElementById('modalSenha').style.display = 'none';
  campoEditavel = null;
}

function liberarTodosCamposProtegidos() {
  const dadosAtuais = coletarDadosFormularioTemporario();
  
  const camposProtegidos = [
    'razao_social', 'nome_fantasia', 'cnpj_cadastro', 
    'mensalidade', 'adesao', 'situacao', 'data_status',
    'contrato_enviado', 'contrato_assinado', 'ativacao', 'link'
  ];
  
  camposProtegidos.forEach(id => {
    const campo = document.getElementById(id);
    if (campo) {
      const novoCampo = campo.cloneNode(true);
      novoCampo.removeAttribute('readonly');
      novoCampo.disabled = false;
      novoCampo.style.backgroundColor = '';
      novoCampo.style.cursor = 'text';
      novoCampo.style.opacity = '1';
      
      novoCampo.onfocus = null;
      novoCampo.onclick = null;
      
      campo.parentNode.replaceChild(novoCampo, campo);
    }
  });
  
  const camposFornecedor = document.querySelectorAll(`
    input[name="fornecedor"], 
    input[name^="mdr_"], 
    input[name^="tis_"],
    input[name^="rebate_"]
  `);
  
  camposFornecedor.forEach(campo => {
    const novoCampo = campo.cloneNode(true);
    novoCampo.disabled = false;
    novoCampo.style.cursor = '';
    novoCampo.style.opacity = '1';
    novoCampo.style.backgroundColor = '';
    
    novoCampo.onclick = null;
    novoCampo.onfocus = null;
    novoCampo.onmousedown = null;
    
    campo.parentNode.replaceChild(novoCampo, campo);
  });
  
  setTimeout(() => {
    restaurarDadosFormulario(dadosAtuais);
  }, 100);
}

function configurarCamposProtegidos() {
  const autorizado = localStorage.getItem('usuarioAutorizado');
  const expiracao = localStorage.getItem('autorizacaoExpiracao');
  const agora = new Date().getTime();
  
  let usuarioEstaAutorizado = false;
  
  if (autorizado === 'true' && expiracao) {
    const tempoExpiracao = parseInt(expiracao);
    
    if (agora < tempoExpiracao) {
      usuarioEstaAutorizado = true;
      
      setTimeout(() => {
        liberarTodosCamposProtegidos();
      }, 100);
      
    } else {
      localStorage.removeItem('usuarioAutorizado');
      localStorage.removeItem('autorizacaoExpiracao');
      localStorage.removeItem('ultimaAutorizacao');
    }
  }
  
  if (!usuarioEstaAutorizado) {
    const dadosAtuais = coletarDadosFormularioTemporario();
    
    const camposProtegidos = [
      'razao_social', 'nome_fantasia', 'cnpj_cadastro', 
      'mensalidade', 'adesao', 'situacao', 'data_status',
      'contrato_enviado', 'contrato_assinado', 'ativacao', 'link'
    ];
    
    camposProtegidos.forEach(id => {
      const campo = document.getElementById(id);
      if (campo) {
        campo.setAttribute('readonly', 'true');
        campo.disabled = false;
        campo.style.backgroundColor = '#f8f9fa';
        campo.style.cursor = 'not-allowed';
        campo.style.opacity = '1';
        
        const novoCampo = campo.cloneNode(true);
        campo.parentNode.replaceChild(novoCampo, campo);
        
        document.getElementById(id).addEventListener('focus', function(e) {
          e.preventDefault();
          solicitarSenha(this);
        });
      }
    });
    
    const checkboxesFornecedor = document.querySelectorAll('input[name="fornecedor"]');
    const inputsMDR = document.querySelectorAll('input[name^="mdr_"]');
    const inputsTIS = document.querySelectorAll('input[name^="tis_"]');
    const inputsRebate = document.querySelectorAll('input[name^="rebate_"]');

    checkboxesFornecedor.forEach(checkbox => {
      checkbox.disabled = true;
      checkbox.style.cursor = 'not-allowed';
      checkbox.style.opacity = '0.6';
    });

    inputsMDR.forEach(input => {
      input.disabled = false;
      input.style.cursor = 'pointer';
      input.style.opacity = '1';
    });

    inputsTIS.forEach(input => {
      input.disabled = false;
      input.style.cursor = 'pointer';
      input.style.opacity = '1';
    });

    inputsRebate.forEach(input => {
      input.disabled = false;
      input.style.cursor = 'pointer';
      input.style.opacity = '1';
    });
    
    setTimeout(() => {
      if (dadosAtuais && (dadosAtuais.razao_social || dadosAtuais.cnpj_cadastro)) {
        restaurarDadosFormulario(dadosAtuais);
      }
    }, 300);
  }
  
  const camposLiberados = ['etapa', 'observacoes', 'inputEtapaSearch'];
  camposLiberados.forEach(id => {
    const campo = document.getElementById(id);
    if (campo) {
      campo.removeAttribute('readonly');
      campo.disabled = false;
      campo.style.backgroundColor = '';
      campo.style.cursor = 'text';
      campo.style.opacity = '1';
    }
  });
}

function fecharModalDetalhes() {
  const modal = document.getElementById('modalDetalhes');
  modal.style.display = 'none';
  cadastroAtualModalId = null; // Limpar ID ao fechar
}

// FUNÇÕES PARA OS POPUPS
function mostrarPopupCarregandoLojas() {
  document.getElementById('popupCarregandoLojas').style.display = 'flex';
}

function esconderPopupCarregandoLojas() {
  document.getElementById('popupCarregandoLojas').style.display = 'none';
}

function mostrarPopupCarregandoModal() {
  document.getElementById('popupCarregandoModal').style.display = 'flex';
}

function esconderPopupCarregandoModal() {
  document.getElementById('popupCarregandoModal').style.display = 'none';
}

function mostrarPopupAtualizando() {
  document.getElementById('popupAtualizando').style.display = 'flex';
}

function esconderPopupAtualizando() {
  document.getElementById('popupAtualizando').style.display = 'none';
}

function restaurarFiltros(filtrosSalvos) {
  situacaoAtiva = filtrosSalvos.situacaoAtiva;
  filtrosAtivos = filtrosSalvos.filtrosAtivos || {};
  etapasSelecionados = filtrosSalvos.etapasSelecionados || [];
  fornecedoresSelecionados = filtrosSalvos.fornecedoresSelecionados || [];
  
  document.getElementById('pesquisaCadastros').value = filtrosSalvos.pesquisa || '';
  document.getElementById('ordenacaoCadastros').value = filtrosSalvos.ordenacao || 'razao_social';
  
  document.querySelectorAll('.filtro-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  const btnAtivo = document.querySelector(`.filtro-btn[data-situacao="${situacaoAtiva}"]`);
  if (btnAtivo) {
    btnAtivo.classList.add('active');
  } else {
    document.querySelector('.filtro-btn[data-situacao="all"]').classList.add('active');
  }
  
  atualizarEtapasSelecionados();
  atualizarFornecedoresSelecionados();
  
  aplicarTodosFiltros();
}
  </script>
</body>
</html>
