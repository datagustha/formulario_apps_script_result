<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Visualiza√ß√£o - Lojas</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    
    :root {
      --primary: #2EBE76; /* VERDE RESULT */
      --secondary: #A1CC4C;
      --accent: #FF6B35;
      --dark: #2D3047;
      --light: #FFFFFF;
      --success: #28A745;
      --warning: #FFC107;
      --danger: #DC3545;
      --info: #17A2B8;
      --gray: #6C757D;
      --border: #E0E0E0;
      --background: #F8F9FA;
    }
    
    body {
      background: var(--background);
      min-height: 100vh;
      padding: 15px;
      color: var(--dark);
      font-size: 14px;
    }
    
    .container {
      max-width: 1800px;
      margin: 0 auto;
      background: var(--light);
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }
    
    .header {
      background: var(--primary); /* VERDE RESULT */
      padding: 20px 30px;
      color: white;
      text-align: center;
    }

    .logo-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .logo-wrapper {
      display: flex;
      align-items: center;
      gap: 15px;
      justify-content: center;
    }

    .logo-result-wrapper {
      background: white;
      padding: 10px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-result {
      width: 70px;
      height: 70px;
      object-fit: contain;
    }
    
    .logo {
      width: 80px;
      height: 80px;
      background: white;
      padding: 10px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      object-fit: contain;
    }
    
    h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .subtitle {
      font-size: 1rem;
      opacity: 0.9;
    }
    
    .content {
      padding: 25px;
    }
    
    .card {
      background: var(--light);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.04);
      border: 1px solid var(--border);
    }
    
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--primary); /* VERDE RESULT */
    }
    
    .card-header i {
      color: var(--primary); /* VERDE RESULT */
      font-size: 1.5rem;
    }
    
    .card-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--primary); /* VERDE RESULT */
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--primary); /* VERDE RESULT */
      color: white;
    }
    
    .btn-primary:hover {
      background: #27a86c; /* Verde mais escuro */
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-warning {
      background: var(--warning);
      color: var(--dark);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-info {
      background: var(--info);
      color: white;
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary); /* VERDE RESULT */
      color: var(--primary); /* VERDE RESULT */
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.8rem;
    }

    .filtros-container .btn.active {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(46, 190, 118, 0.3); /* VERDE RESULT */
      border: 2px solid var(--primary) !important;
    }

    .filtros-container .btn.active[onclick*="all"] {
      background: var(--primary) !important; /* VERDE RESULT */
      color: white !important;
      border-color: var(--primary) !important;
    }

    .filtros-container .btn.active:not([onclick*="all"]) {
      border: 2px solid var(--primary) !important; /* VERDE RESULT */
      box-shadow: 0 0 0 3px rgba(46, 190, 118, 0.2) !important; /* VERDE RESULT */
    }
    
    .message {
      padding: 12px 16px;
      border-radius: 6px;
      margin: 12px 0;
      display: none;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }
    
    .success {
      background: #d4edda;
      color: var(--success);
      border: 1px solid #c3e6cb;
    }
    
    .error {
      background: #f8d7da;
      color: var(--danger);
      border: 1px solid #f5c6cb;
    }
    
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px;
      text-align: center;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary); /* VERDE RESULT */
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* POPUP DE CARREGAMENTO */
    .loading-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 20000;
      flex-direction: column;
    }

    .loading-popup-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border: 3px solid var(--primary); /* VERDE RESULT */
    }

    .loading-popup-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary); /* VERDE RESULT */
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    .loading-popup-text {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 10px;
    }

    .loading-popup-subtext {
      font-size: 0.9rem;
      color: var(--gray);
    }
    
    .table-container {
      margin-top: 15px;
      overflow: hidden;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .table-responsive {
      overflow-x: auto;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      font-size: 0.8rem;
      table-layout: fixed;
    }
    
    .data-table th {
      background: var(--primary); /* VERDE RESULT */
      color: white;
      padding: 12px 6px !important;
      text-align: center !important;
      font-weight: 700 !important;
      position: sticky;
      top: 0;
      white-space: nowrap;
      font-size: 0.85rem !important;
      letter-spacing: 0.5px;
      border-bottom: 2px solid rgba(255,255,255,0.2);
    }

    .data-table th:nth-child(1) {
      width: 18%;
      text-align: left !important;
      padding-left: 12px !important;
    }

    .data-table th:nth-child(2) { width: 12%; }
    .data-table th:nth-child(3) { width: 12%; }
    .data-table th:nth-child(4) { width: 10%; }
    .data-table th:nth-child(5) { 
      width: 14%; 
      text-align: left !important;
      padding-left: 12px !important;
    }
    .data-table th:nth-child(6) { width: 8%; }
    .data-table th:nth-child(7) { width: 10%; }
    .data-table th:nth-child(8) { width: 8%; }
    .data-table th:nth-child(9) { width: 8%; }
    
    .data-table td {
      padding: 12px 6px !important;
      border-bottom: 1px solid var(--border);
      word-wrap: break-word;
      vertical-align: middle !important;
      height: 100% !important;
    }

    .data-table td:nth-child(1) {
      text-align: left !important;
      vertical-align: top !important;
    }

    .data-table td:nth-child(2),
    .data-table td:nth-child(3),
    .data-table td:nth-child(4),
    .data-table td:nth-child(6),
    .data-table td:nth-child(7),
    .data-table td:nth-child(8),
    .data-table td:nth-child(9) {
      text-align: center !important;
      vertical-align: middle !important;
    }

    .data-table td:nth-child(5) {
      text-align: left !important;
      vertical-align: middle !important;
    }

    .data-table td:nth-child(7) {
      font-weight: 600;
      color: var(--success) !important;
    }

    .data-table td:nth-child(8) {
      font-weight: 600;
      color: var(--info) !important;
    }
    
    .data-table tbody tr {
      transition: all 0.3s ease;
      display: table-row;
      height: auto;
    }
    
    .data-table tbody tr:hover {
      background: #f8f9fa;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    
    .data-table .btn-sm {
      padding: 5px 10px;
      font-size: 0.75rem;
      margin: 2px;
    }
    
    .status-badge {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      text-align: center;
      display: inline-block;
      min-width: 80px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .acoes-cell {
      display: flex;
      gap: 4px;
      justify-content: center;
      align-items: center;
      height: 100% !important;
      min-height: 100% !important;
      padding: 0 !important;
      margin: 0 !important;
    }
    
    .action-buttons {
      display: flex;
      gap: 12px;
      margin: 30px 0 15px 0;
      flex-wrap: wrap;
    }
    
    .filtros-container {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin: 15px 0;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .filtro-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border: 2px solid var(--border);
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
      color: var(--dark);
      position: relative;
    }

    .filtro-btn.active {
      transform: translateY(-2px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.15);
      border-width: 2px;
    }

    .filtro-btn::before {
      content: '';
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 4px;
    }

    .filtro-btn[data-situacao="all"]::before { background: var(--primary); } /* VERDE RESULT */
    .filtro-btn[data-situacao="NOVO REGISTRO"]::before { background: #bfe1f6; }
    .filtro-btn[data-situacao="CADASTRADO"]::before { background: var(--success); }
    .filtro-btn[data-situacao="EM ANDAMENTO"]::before { background: var(--warning); }
    .filtro-btn[data-situacao="REJEITADO"]::before { background: var(--gray); }
    .filtro-btn[data-situacao="DESCREDENCIADO"]::before { background: var(--danger); }
    .filtro-btn[data-situacao="DESISTIU"]::before { background: #e6cff2; }

    .filtro-btn.active[data-situacao="all"] { 
      background: var(--primary);  /* VERDE RESULT */
      color: white; 
      border-color: var(--primary);  /* VERDE RESULT */
    }
    .filtro-btn.active[data-situacao="NOVO REGISTRO"] { 
      background: #bfe1f6; 
      color: #0c5aa3; 
      border-color: #bfe1f6; 
    }
    .filtro-btn.active[data-situacao="CADASTRADO"] { 
      background: var(--success); 
      color: white; 
      border-color: var(--success); 
    }
    .filtro-btn.active[data-situacao="EM ANDAMENTO"] { 
      background: var(--warning); 
      color: var(--dark); 
      border-color: var(--warning); 
    }
    .filtro-btn.active[data-situacao="REJEITADO"] { 
      background: var(--gray); 
      color: white; 
      border-color: var(--gray); 
    }
    .filtro-btn.active[data-situacao="DESCREDENCIADO"] { 
      background: var(--danger); 
      color: white; 
      border-color: var(--danger); 
    }
    .filtro-btn.active[data-situacao="DESISTIU"] { 
      background: #e6cff2; 
      color: #4a1e6b; 
      border-color: #e6cff2; 
    }

    .filtros-avancados {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin: 15px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .filtro-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filtro-label {
      font-weight: 600;
      color: var(--primary); /* VERDE RESULT */
      font-size: 0.85rem;
    }

    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary); /* VERDE RESULT */
    }

    .form-select {
      width: 100%;
      padding: 8px 10px;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-size: 0.85rem;
      background: white;
      cursor: pointer;
    }

    .contador-lojas {
      background: var(--primary); /* VERDE RESULT */
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .filtros-ativos {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 8px 0;
    }

    .filtro-chip {
      background: var(--primary); /* VERDE RESULT */
      color: white;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .filtro-chip .remover {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 0;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
    }

    .filtro-multiselect-container {
      position: relative;
      z-index: 100;
    }

    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid var(--primary); /* VERDE RESULT */
      border-top: none;
      border-radius: 0 0 6px 6px;
      z-index: 1001;
      max-height: 180px;
      overflow-y: auto;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      display: none;
      margin-top: -2px;
    }

    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: all 0.2s ease;
      font-size: 0.85rem;
    }

    .suggestion-item:hover {
      background: var(--primary); /* VERDE RESULT */
      color: white;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .tags-selecionadas {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .tag {
      background: var(--info);
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .tag.fornecedor {
      background: var(--secondary);
    }

    .tag .remover {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 0;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
    }

    .tag .remover:hover {
      background: rgba(255,255,255,0.3);
    }

    .btn-visualizar-compact {
      padding: 6px 10px !important;
      font-size: 0.75rem !important;
      min-width: 90px;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      height: 100% !important;
      min-height: 35px !important;
      width: 100%;
      border-radius: 5px !important;
      margin: 0 !important;
    }

    .defasagem-badge {
      padding: 6px 10px !important;
      border-radius: 8px !important;
      font-size: 0.75rem !important;
      font-weight: 700 !important;
      min-width: 70px;
      display: inline-block;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .defasagem-alta {
      background: #f8d7da;
      color: #721c24;
    }

    .defasagem-media {
      background: #fff3cd;
      color: #856404;
    }

    .defasagem-baixa {
      background: #d1e7dd;
      color: #0f5132;
    }

    .sem-defasagem {
      background: #e9ecef !important;
      color: #6c757d !important;
      border: 1px solid #dee2e6 !important;
    }

    .sem-defasagem-badge {
      padding: 6px 10px !important;
      border-radius: 8px !important;
      font-size: 0.75rem !important;
      font-weight: 600 !important;
      background: #e9ecef !important;
      color: #6c757d !important;
      border: 1px solid #dee2e6 !important;
      min-width: 70px;
      display: inline-block;
      text-align: center;
    }

    .search-container {
      position: relative;
    }

    .defasagem-container {
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
      height: 100% !important;
    }

    /* STATUS BADGES - REMOVIDAS BORDAS */
    .situacao-novo-registro {
      background-color: #bfe1f6 !important;
      color: #0c5aa3 !important;
    }
    
    .situacao-cadastrado {
      background: #D1E7DD !important;
      color: #0F5132 !important;
    }

    .situacao-andamento {
      background: #FFF3CD !important;
      color: #856404 !important;
    }
    
    .situacao-rejeitado {
      background: #E2E3E5 !important;
      color: #383D41 !important;
    }
    
    .situacao-descredenciado {
      background: #F8D7DA !important;
      color: #721C24 !important;
    }

    .situacao-desistiu {
      background: #e6cff2 !important;
      color: #4a1e6b !important;
    }

    /* MODAL STYLES - REMOVIDAS BORDAS */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 25px;
      max-width: 900px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 15px 50px rgba(0,0,0,0.25);
      /* REMOVIDA BORDA: border: 3px solid var(--primary); */
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 0;
      border-bottom: none;
    }

    .modal-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--primary); /* VERDE RESULT */
      margin: 0;
    }

    .btn-close {
      background: none;
      border: none;
      font-size: 1.3rem;
      cursor: pointer;
      color: var(--gray);
      padding: 4px;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .btn-close:hover {
      background: var(--danger);
      color: white;
    }

    .detalhes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      margin-bottom: 15px;
    }

    .detalhe-item {
      margin-bottom: 10px;
    }

    .detalhe-label {
      font-weight: 600;
      color: var(--primary); /* VERDE RESULT */
      margin-bottom: 4px;
      display: block;
      font-size: 0.9rem;
    }

    .detalhe-valor {
      color: var(--dark);
      background: white;
      padding: 12px 15px;
      border-radius: 10px;
      border-left: 4px solid var(--primary); /* VERDE RESULT */
      font-size: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
    }

    /* Header Profissional do CNPJ */
    .modal-cnpj-header-profissional {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: white;
      padding: 25px 30px;
      border-radius: 12px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .cnpj-header-content {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .cnpj-icon {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 50%;
      font-size: 1.5rem;
    }

    .cnpj-info {
      flex: 1;
    }

    .cnpj-title {
      font-size: 0.9rem;
      font-weight: 600;
      opacity: 0.9;
      margin: 0 0 5px 0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .cnpj-number {
      font-family: 'Courier New', monospace;
      font-size: 1.4rem;
      font-weight: 700;
      margin: 0 0 5px 0;
      letter-spacing: 1px;
    }

    .cnpj-subtitle {
      font-size: 0.85rem;
      opacity: 0.8;
      margin: 0;
    }

    .cnpj-badge {
      background: linear-gradient(135deg, var(--primary) 0%, #34d399 100%); /* VERDE RESULT */
      padding: 15px 20px;
      border-radius: 12px;
      text-align: center;
      min-width: 90px;
      border: 2px solid rgba(255,255,255,0.3);
      box-shadow: 0 4px 15px rgba(46, 190, 118, 0.4); /* VERDE RESULT */
      position: relative;
      overflow: hidden;
    }

    .cnpj-badge::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 50%);
    }

    .lojas-count {
      display: block;
      font-size: 1.8rem;
      font-weight: 700;
      position: relative;
      z-index: 2;
    }

    .cnpj-badge small {
      font-size: 0.75rem;
      opacity: 0.9;
      position: relative;
      z-index: 2;
    }

    /* Resumo Executivo */
    .modal-resumo-executivo {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
      border-left: 4px solid var(--primary); /* VERDE RESULT */
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .resumo-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: var(--dark);
      font-size: 1.1rem;
    }

    .resumo-item i {
      color: var(--primary); /* VERDE RESULT */
      font-size: 1.3rem;
    }

    .resumo-stats {
      display: flex;
      gap: 25px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-number {
      display: block;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary); /* VERDE RESULT */
    }

    .stat-label {
      font-size: 0.8rem;
      color: var(--gray);
      font-weight: 600;
    }

    /* Header da Lista */
    .fornecedores-list-header {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border);
    }

    .fornecedores-list-header h4 {
      color: var(--dark);
      margin: 0 0 5px 0;
      font-size: 1.3rem;
    }

    .fornecedores-list-header .subtitle {
      color: var(--gray);
      font-size: 0.9rem;
    }

    .fornecedor-badge {
      background: var(--primary); /* VERDE RESULT */
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .fornecedor-indice {
      display: block;
      text-align: center;
    }

    .fornecedor-subinfo {
      margin-top: 5px;
    }

    .info-tag {
      background: rgba(0,0,0,0.05);
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      color: var(--gray);
    }

    .etapa-destaque {
      font-weight: 700;
      color: var(--primary) !important; /* VERDE RESULT */
    }

    .percentual-destaque {
      background: var(--secondary);
      color: white;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 0.8rem;
      margin-left: 5px;
    }

    .valor-destaque {
      font-weight: 700;
      color: var(--success) !important;
    }

    /* STATUS BADGES PARA O MODAL - REMOVIDAS BORDAS */
    .modal-fornecedor-card .status-badge {
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      min-width: 85px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      text-align: center;
    }

    .modal-fornecedor-card .situacao-novo-registro {
      background: #bfe1f6 !important;
      color: #0c5aa3 !important;
    }

    .modal-fornecedor-card .situacao-cadastrado {
      background: #28a745 !important;
      color: white !important;
    }

    .modal-fornecedor-card .situacao-andamento {
      background: #ffc107 !important;
      color: #000000 !important;
    }

    .modal-fornecedor-card .situacao-rejeitado {
      background: #6c757d !important;
      color: white !important;
    }

    .modal-fornecedor-card .situacao-descredenciado {
      background: #dc3545 !important;
      color: white !important;
    }

    .modal-fornecedor-card .situacao-desistiu {
      background: #e6cff2 !important;
      color: #4a1e6b !important;
    }

    @media (max-width: 768px) {
      .content {
        padding: 15px;
      }
      
      .btn-group {
        flex-direction: column;
      }

      h1 {
        font-size: 1.8rem;
      }
      
      .logo {
        width: 60px;
        height: 60px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .card-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .filtros-container {
        margin-top: 12px;
      }
      
      .data-table {
        font-size: 0.75rem;
      }
      
      .acoes-cell {
        flex-direction: column;
      }

      .modal-content {
        padding: 20px;
        margin: 10px;
        max-width: 95%;
      }
      
      .modal-title {
        font-size: 1.2rem;
      }

      .detalhes-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
    }
  </style>
</head>
<body>
  <!-- POPUP DE CARREGAMENTO -->
  <div id="loadingPopup" class="loading-popup">
    <div class="loading-popup-content">
      <div class="loading-popup-spinner"></div>
      <div class="loading-popup-text" id="loadingPopupText">Carregando...</div>
      <div class="loading-popup-subtext" id="loadingPopupSubtext">Aguarde um momento</div>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <div class="logo-container">
        <div class="logo-wrapper">
          <img src="https://i.ibb.co/B2r5xtbS/sim-cred-5.png" class="logo" alt="SIM CRED">
          <div class="logo-result-wrapper">
            <img src="https://i.ibb.co/PvznTM8v/1739824422909-Result-Pay-Powered-by-Sim-2-removebg-preview.png" class="logo-result" alt="Result Pay">
          </div>
        </div>
        <div class="header-content">
          <h1>Visualiza√ß√£o de Lojas</h1>
          <div class="subtitle">Sistema de Consulta - Somente Leitura</div>
        </div>
      </div>
    </div>
    
    <div class="content">
      <!-- CARD PRINCIPAL COM TABELA -->
      <div class="card">
        <div class="card-header">
          <i class="fas fa-store"></i>
          <h2 class="card-title" id="tituloCadastros">Todos os Cadastros</h2>
          <span class="contador-lojas" id="contadorCadastros">0 cadastros</span>
        </div>

        <!-- BARRA DE PESQUISA PRINCIPAL -->
        <div class="search-container">
          <input type="text" id="pesquisaCadastros" class="form-control" 
                 placeholder="üîç Pesquisar por nome, CNPJ, fornecedor, etapa..."
                 oninput="filtrarPesquisa()">
        </div>

        <!-- FILTROS R√ÅPIDOS POR SITUA√á√ÉO -->
        <div class="filtros-container" id="filtrosContainer">
          <button type="button" class="filtro-btn active" data-situacao="all" onclick="aplicarFiltroSituacao('all')">
            Todos
          </button>
          <button type="button" class="filtro-btn" data-situacao="NOVO REGISTRO" onclick="aplicarFiltroSituacao('NOVO REGISTRO')">
            Novo Registro
          </button>
          <button type="button" class="filtro-btn" data-situacao="CADASTRADO" onclick="aplicarFiltroSituacao('CADASTRADO')">
            Cadastrado
          </button>
          <button type="button" class="filtro-btn" data-situacao="EM ANDAMENTO" onclick="aplicarFiltroSituacao('EM ANDAMENTO')">
            Em Andamento
          </button>
          <button type="button" class="filtro-btn" data-situacao="REJEITADO" onclick="aplicarFiltroSituacao('REJEITADO')">
            Rejeitado
          </button>
          <button type="button" class="filtro-btn" data-situacao="DESCREDENCIADO" onclick="aplicarFiltroSituacao('DESCREDENCIADO')">
            Descredenciado
          </button>
          <button type="button" class="filtro-btn" data-situacao="DESISTIU" onclick="aplicarFiltroSituacao('DESISTIU')">
            Desistiu
          </button>
          
          <button type="button" class="btn btn-info btn-sm" onclick="recarregarCadastros()" style="margin-left: auto;">
            <i class="fas fa-sync-alt"></i> Atualizar
          </button>
        </div>

        <!-- FILTROS AVAN√áADOS -->
        <div class="filtros-avancados" id="filtrosAvancadosContainer">
          <div class="filtro-group">
            <label class="filtro-label">üìÖ Filtrar por Etapa:</label>
            <div class="filtro-multiselect-container">
              <input type="text" id="filtroEtapa" class="form-control" 
                     placeholder="Digite para buscar etapas..." 
                     oninput="filtrarSugestoesEtapa()"
                     onfocus="mostrarSugestoesEtapaFiltro()">
              <div class="suggestions" id="suggestionsEtapa"></div>
              <div class="tags-selecionadas" id="etapasSelecionados"></div>
            </div>
          </div>
          
          <div class="filtro-group">
            <label class="filtro-label">üöö Filtrar por Fornecedor:</label>
            <div class="filtro-multiselect-container">
              <input type="text" id="filtroFornecedor" class="form-control" 
                     placeholder="Digite para buscar fornecedores..." 
                     oninput="filtrarSugestoesFornecedor()"
                     onfocus="mostrarSugestoesFornecedorFiltro()">
              <div class="suggestions" id="suggestionsFornecedor"></div>
              <div class="tags-selecionadas" id="fornecedoresSelecionados"></div>
            </div>
          </div>
          
          <div class="filtro-group">
            <label class="filtro-label">üìä Ordenar por:</label>
            <select id="ordenacaoCadastros" class="form-select" onchange="ordenarCadastros()">
              <option value="razao_social" selected>Raz√£o Social (A-Z)</option>
              <option value="razao_social_desc">Raz√£o Social (Z-A)</option>
              <option value="nome_fantasia">Nome Fantasia (A-Z)</option>
              <option value="nome_fantasia_desc">Nome Fantasia (Z-A)</option>
              <option value="situacao">Situa√ß√£o</option>
              <option value="fornecedor">Fornecedor</option>
              <option value="mensalidade">Mensalidade (Maior)</option>
              <option value="mensalidade_asc">Mensalidade (Menor)</option>
              <option value="adesao">Ades√£o (Maior)</option>
              <option value="adesao_asc">Ades√£o (Menor)</option>
              <option value="defasagem">Defasagem (Maior)</option>
              <option value="defasagem_asc">Defasagem (Menor)</option>
            </select>
          </div>

          <div class="filtro-group">
            <label class="filtro-label">üßπ Limpar Filtros:</label>
            <button type="button" class="btn btn-outline btn-sm" onclick="limparTodosFiltros()" style="margin-top: 6px;">
              <i class="fas fa-broom"></i> Limpar Tudo
            </button>
          </div>
        </div>

        <!-- TAGS DE FILTROS ATIVOS -->
        <div class="filtros-ativos" id="filtrosAtivosContainer" style="display: none;"></div>

        <!-- LOADING -->
        <div class="loading-container" id="loadingCadastros" style="display: none;">
          <div class="loading-spinner"></div>
          <p>Carregando cadastros...</p>
        </div>
        
        <!-- TABELA MAIOR COM MAIS INFORMA√á√ïES -->
        <div class="table-container" id="tableContainer" style="display: none;">
          <div class="table-responsive">
            <table class="data-table" id="tabelaCadastros">
              <thead>
                <tr>
                  <th width="18%">Raz√£o Social</th>
                  <th width="12%">CNPJ</th>
                  <th width="12%">Fornecedor</th>
                  <th width="10%">Situa√ß√£o</th>
                  <th width="14%">√öltima Etapa</th>
                  <th width="8%">Defasagem</th>
                  <th width="10%">Mensalidade</th>
                  <th width="8%">Ades√£o</th>
                  <th width="8%">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tabelaCadastrosBody">
                <!-- Dados ser√£o preenchidos via JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- MENSAGENS DO SISTEMA -->
      <div id="messageSuccess" class="message success" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <span></span>
      </div>
      
      <div id="messageError" class="message error" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span></span>
      </div>

      <div id="messageInfo" class="message info" style="display: none;">
        <i class="fas fa-info-circle"></i>
        <span></span>
      </div>
    </div>
  </div>

  <!-- MODAL 1: VISUALIZAR TODOS OS FORNECEDORES -->
  <div id="modalFornecedores" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">üè™ Todos os Fornecedores</h3>
        <button class="btn-close" onclick="fecharModalFornecedores()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div id="modalFornecedoresContent">
        <!-- Conte√∫do ser√° preenchido via JavaScript -->
      </div>

      <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
        <button class="btn btn-primary" onclick="fecharModalFornecedores()">
          <i class="fas fa-check"></i> Fechar
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL 2: DETALHES COMPLETOS -->
  <div id="modalDetalhes" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">üìã Detalhes do Cadastro</h3>
        <button class="btn-close" onclick="fecharModalDetalhes()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div id="modalDetalhesContent">
        <!-- Conte√∫do ser√° preenchido via JavaScript -->
      </div>

      <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
        <button class="btn btn-primary" onclick="fecharModalDetalhes()">
          <i class="fas fa-check"></i> Fechar
        </button>
      </div>
    </div>
  </div>

  <script>
// VARI√ÅVEIS GLOBAIS
let todosCadastros = [];
let cadastrosFiltrados = [];
let filtrosAtivos = {};
let situacaoAtiva = 'all';
let etapasSelecionados = [];
let fornecedoresSelecionados = [];
const waitlabelAtual = 'Result';

// ETAPAS PARA FILTRO
const etapasDisponiveis = [
  "PENDENTE FORNECEDOR(ES)", "PENDENTE SIM", "PENDENTE RETORNO EXTERNO"
].sort();

// FORNECEDORES DISPON√çVEIS
const fornecedoresDisponiveis = [
  "AGIL", "BC", "PARCELEX", "AGORACRED", "AFINZ"
].sort();

// INICIALIZA√á√ÉO - CARREGAR FILTROS SALVOS SE EXISTIREM
document.addEventListener('DOMContentLoaded', function() {
  console.log('Sistema de Visualiza√ß√£o - Carregando dados...');
  showLoadingPopup('Carregando Lojas', 'Aguarde enquanto buscamos os dados...');
  
  // VERIFICAR SE EXISTEM FILTROS SALVOS
  try {
    const filtrosSalvos = JSON.parse(localStorage.getItem('filtrosSalvos'));
    if (filtrosSalvos) {
      console.log("üìÅ Filtros salvos encontrados, restaurando...");
    }
  } catch (e) {
    console.log("üìÅ Nenhum filtro salvo encontrado");
  }
  
  carregarCadastros();
  configurarEventosFiltro();
});

// FUN√á√ïES DO POPUP DE CARREGAMENTO
function showLoadingPopup(texto, subtexto) {
  const popup = document.getElementById('loadingPopup');
  const textoEl = document.getElementById('loadingPopupText');
  const subtextoEl = document.getElementById('loadingPopupSubtext');
  
  textoEl.textContent = texto || 'Carregando...';
  subtextoEl.textContent = subtexto || 'Aguarde um momento';
  
  popup.style.display = 'flex';
}

function hideLoadingPopup() {
  const popup = document.getElementById('loadingPopup');
  console.log("üîí Fechando popup de loading...");
  popup.style.display = 'none';
  
  // FOR√áAR FECHAMENTO CASO PRECISE
  setTimeout(() => {
    if (popup.style.display !== 'none') {
      popup.style.display = 'none';
      console.log("üîí Popup for√ßado a fechar");
    }
  }, 1000);
}

// CONFIGURAR EVENTOS DOS FILTROS
function configurarEventosFiltro() {
  const inputEtapa = document.getElementById('filtroEtapa');
  const inputFornecedor = document.getElementById('filtroFornecedor');
  
  // Fechar sugest√µes ao clicar fora
  document.addEventListener('click', function(e) {
    const suggestionsEtapa = document.getElementById('suggestionsEtapa');
    const suggestionsFornecedor = document.getElementById('suggestionsFornecedor');
    
    if (suggestionsEtapa && !inputEtapa.contains(e.target) && !suggestionsEtapa.contains(e.target)) {
      suggestionsEtapa.style.display = 'none';
    }
    
    if (suggestionsFornecedor && !inputFornecedor.contains(e.target) && !suggestionsFornecedor.contains(e.target)) {
      suggestionsFornecedor.style.display = 'none';
    }
  });
  
  // Fechar sugest√µes com ESC
  inputEtapa.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.getElementById('suggestionsEtapa').style.display = 'none';
    }
    if (e.key === 'Enter') {
      e.preventDefault();
      const texto = inputEtapa.value.trim();
      if (texto && !etapasSelecionados.includes(texto.toUpperCase())) {
        adicionarEtapa(texto.toUpperCase());
      }
      inputEtapa.value = '';
      document.getElementById('suggestionsEtapa').style.display = 'none';
    }
  });
  
  inputFornecedor.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.getElementById('suggestionsFornecedor').style.display = 'none';
    }
    if (e.key === 'Enter') {
      e.preventDefault();
      const texto = inputFornecedor.value.trim();
      if (texto && !fornecedoresSelecionados.includes(texto.toUpperCase())) {
        adicionarFornecedor(texto.toUpperCase());
      }
      inputFornecedor.value = '';
      document.getElementById('suggestionsFornecedor').style.display = 'none';
    }
  });
}

// FUN√á√ïES DO FILTRO DE ETAPAS
function mostrarSugestoesEtapaFiltro() {
    const input = document.getElementById('filtroEtapa');
    const suggestions = document.getElementById('suggestionsEtapa');
    
    const todasEtapas = [...etapasDisponiveis];
    
    let html = '';
    
    todasEtapas.forEach(etapa => {
        const jaSelecionado = etapasSelecionados.includes(etapa);
        
        // Determinar √≠cone e cor
        let icone = "fas fa-calendar-check";
        let cor = "#2EBE76"; // VERDE RESULT
        
        if (etapa.includes("FORNECEDOR")) {
          icone = "fas fa-truck";
          cor = "#FF6B35";
        } else if (etapa.includes("SIM")) {
          icone = "fas fa-building";
          cor = "#2EBE76"; // VERDE RESULT
        } else if (etapa.includes("RETORNO")) {
          icone = "fas fa-undo-alt";
          cor = "#0682c5";
        }
        
        html += `
            <div class="suggestion-item ${jaSelecionado ? 'selecionado' : ''}" 
                 onclick="selecionarEtapaFiltro('${etapa.replace(/'/g, "\\'")}')"
                 data-etapa="${etapa}">
                <i class="${icone}" style="color: ${cor}"></i>
                <span>${etapa}</span>
                ${jaSelecionado ? '<i class="fas fa-check" style="margin-left: auto; color: var(--success);"></i>' : ''}
            </div>
        `;
    });
    
    suggestions.innerHTML = html;
    suggestions.style.display = 'block';
}

function selecionarEtapaFiltro(etapa) {
    if (!etapasSelecionados.includes(etapa)) {
        etapasSelecionados.push(etapa);
        atualizarEtapasSelecionados();
        aplicarFiltroEtapas();
    }
    
    document.getElementById('suggestionsEtapa').style.display = 'none';
    document.getElementById('filtroEtapa').value = '';
}

function mostrarSugestoesFornecedorFiltro() {
    const input = document.getElementById('filtroFornecedor');
    const suggestions = document.getElementById('suggestionsFornecedor');
    
    let html = '';
    
    fornecedoresDisponiveis.forEach(fornecedor => {
        const jaSelecionado = fornecedoresSelecionados.includes(fornecedor);
        
        html += `
            <div class="suggestion-item ${jaSelecionado ? 'selecionado' : ''}" 
                 onclick="selecionarFornecedorFiltro('${fornecedor}')"
                 data-fornecedor="${fornecedor}">
                <i class="fas fa-truck" style="color: var(--secondary)"></i>
                <span>${fornecedor}</span>
                ${jaSelecionado ? '<i class="fas fa-check" style="margin-left: auto; color: var(--success);"></i>' : ''}
            </div>
        `;
    });
    
    suggestions.innerHTML = html;
    suggestions.style.display = 'block';
}

function selecionarFornecedorFiltro(fornecedor) {
    if (!fornecedoresSelecionados.includes(fornecedor)) {
        fornecedoresSelecionados.push(fornecedor);
        atualizarFornecedoresSelecionados();
        aplicarFiltroFornecedores();
    }
    
    document.getElementById('suggestionsFornecedor').style.display = 'none';
    document.getElementById('filtroFornecedor').value = '';
}

function filtrarSugestoesEtapa() {
  const input = document.getElementById('filtroEtapa');
  const suggestions = document.getElementById('suggestionsEtapa');
  const termo = input.value.toLowerCase().trim();
  
  if (termo.length < 1) {
    suggestions.style.display = 'none';
    return;
  }
  
  const etapasUnicos = [...new Set(etapasDisponiveis)];
  const etapasFiltrados = etapasUnicos.filter(etapa => 
    etapa.toLowerCase().includes(termo) && !etapasSelecionados.includes(etapa)
  );
  
  if (etapasFiltrados.length === 0) {
    suggestions.innerHTML = `
      <div class="suggestion-item" style="color: var(--gray);">
        <i class="fas fa-search"></i> Nenhuma etapa encontrada
      </div>
    `;
  } else {
    let html = etapasFiltrados.map(etapa => `
      <div class="suggestion-item" onclick="adicionarEtapa('${etapa.replace(/'/g, "\\'")}')">
        <i class="fas fa-calendar-check"></i> ${etapa}
      </div>
    `).join('');
    
    suggestions.innerHTML = html;
  }
  
  suggestions.style.display = 'block';
}

function adicionarEtapa(etapa) {
  if (!etapasSelecionados.includes(etapa)) {
    etapasSelecionados.push(etapa);
    atualizarEtapasSelecionados();
    aplicarFiltroEtapas();
  }
  
  document.getElementById('filtroEtapa').value = '';
  document.getElementById('suggestionsEtapa').style.display = 'none';
}

function removerEtapa(etapa) {
  etapasSelecionados = etapasSelecionados.filter(e => e !== etapa);
  atualizarEtapasSelecionados();
  aplicarFiltroEtapas();
}

function atualizarEtapasSelecionados() {
  const container = document.getElementById('etapasSelecionados');
  
  if (etapasSelecionados.length === 0) {
    container.innerHTML = '';
    container.style.display = 'none';
    return;
  }
  
  container.style.display = 'flex';
  container.innerHTML = etapasSelecionados.map(etapa => `
    <div class="tag">
      <i class="fas fa-calendar"></i> ${etapa}
      <button class="remover" onclick="removerEtapa('${etapa}')">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `).join('');
}

function aplicarFiltroEtapas() {
  if (etapasSelecionados.length > 0) {
    filtrosAtivos.etapas = etapasSelecionados;
  } else {
    delete filtrosAtivos.etapas;
  }
  aplicarTodosFiltros();
}

function mostrarSugestoesFornecedor() {
  const input = document.getElementById('filtroFornecedor');
  if (input.value.trim().length > 0) {
    filtrarSugestoesFornecedor();
  }
}

function filtrarSugestoesFornecedor() {
  const input = document.getElementById('filtroFornecedor');
  const suggestions = document.getElementById('suggestionsFornecedor');
  const termo = input.value.toLowerCase().trim();
  
  if (termo.length < 1) {
    suggestions.style.display = 'none';
    return;
  }
  
  const fornecedoresFiltrados = fornecedoresDisponiveis.filter(fornecedor => 
    fornecedor.toLowerCase().includes(termo) && !fornecedoresSelecionados.includes(fornecedor)
  );
  
  if (fornecedoresFiltrados.length === 0) {
    suggestions.innerHTML = `
      <div class="suggestion-item" style="color: var(--gray);">
        <i class="fas fa-search"></i> Nenhum fornecedor encontrado
      </div>
    `;
  } else {
    let html = fornecedoresFiltrados.map(fornecedor => `
      <div class="suggestion-item" onclick="adicionarFornecedor('${fornecedor}')">
        <i class="fas fa-truck"></i> ${fornecedor}
      </div>
    `).join('');
    
    suggestions.innerHTML = html;
  }
  
  suggestions.style.display = 'block';
}

function adicionarFornecedor(fornecedor) {
  if (!fornecedoresSelecionados.includes(fornecedor)) {
    fornecedoresSelecionados.push(fornecedor);
    atualizarFornecedoresSelecionados();
    aplicarFiltroFornecedores();
  }
  
  document.getElementById('filtroFornecedor').value = '';
  document.getElementById('suggestionsFornecedor').style.display = 'none';
}

function removerFornecedor(fornecedor) {
  fornecedoresSelecionados = fornecedoresSelecionados.filter(f => f !== fornecedor);
  atualizarFornecedoresSelecionados();
  aplicarFiltroFornecedores();
}

function atualizarFornecedoresSelecionados() {
  const container = document.getElementById('fornecedoresSelecionados');
  
  if (fornecedoresSelecionados.length === 0) {
    container.innerHTML = '';
    container.style.display = 'none';
    return;
  }
  
  container.style.display = 'flex';
  container.innerHTML = fornecedoresSelecionados.map(fornecedor => `
    <div class="tag fornecedor">
      <i class="fas fa-truck"></i> ${fornecedor}
      <button class="remover" onclick="removerFornecedor('${fornecedor}')">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `).join('');
}

function aplicarFiltroFornecedores() {
  if (fornecedoresSelecionados.length > 0) {
    filtrosAtivos.fornecedores = fornecedoresSelecionados;
  } else {
    delete filtrosAtivos.fornecedores;
  }
  aplicarTodosFiltros();
}

// FUN√á√ÉO CORRIGIDA: ENCONTRAR FORNECEDOR MAIS ATRASADO COM PRIORIDADE
function encontrarFornecedorMaisAntigo(lojasDoCNPJ) {
  if (!lojasDoCNPJ || lojasDoCNPJ.length === 0) {
    return { fornecedor: 'N/A', data: 'N/A', etapa: 'N/A', dias: 9999 };
  }
  
  // Primeiro, verificar se h√° alguma loja com situa√ß√£o priorit√°ria
  const situacoesPrioritarias = ['EM ANDAMENTO', 'NOVO REGISTRO'];
  
  // Buscar por situa√ß√µes priorit√°rias
  for (const situacao of situacoesPrioritarias) {
    const lojasPrioritarias = lojasDoCNPJ.filter(loja => 
      loja.situacao && loja.situacao.toUpperCase() === situacao
    );
    
    if (lojasPrioritarias.length > 0) {
      // Entre as priorit√°rias, pegar a mais antiga
      const lojasComData = lojasPrioritarias.filter(loja => {
        if (!loja.ultima_etapa || loja.ultima_etapa === 'N/A') return false;
        try {
          const data = new Date(loja.ultima_etapa.split('/').reverse().join('-'));
          return !isNaN(data.getTime());
        } catch (error) {
          return false;
        }
      });
      
      if (lojasComData.length > 0) {
        const lojaMaisAntiga = lojasComData.reduce((maisAntiga, atual) => {
          try {
            const dataMaisAntiga = new Date(maisAntiga.ultima_etapa.split('/').reverse().join('-'));
            const dataAtual = new Date(atual.ultima_etapa.split('/').reverse().join('-'));
            return dataAtual < dataMaisAntiga ? atual : maisAntiga;
          } catch (error) {
            return maisAntiga;
          }
        });
        
        const diasDefasagem = calcularDiasDefasagem(lojaMaisAntiga.ultima_etapa);
        return {
          fornecedor: lojaMaisAntiga.fornecedor,
          data: lojaMaisAntiga.ultima_etapa,
          etapa: lojaMaisAntiga.etapa,
          dias: diasDefasagem,
          situacao: lojaMaisAntiga.situacao
        };
      } else if (lojasPrioritarias.length > 0) {
        // Se n√£o tem data v√°lida, retorna a primeira priorit√°ria
        return {
          fornecedor: lojasPrioritarias[0].fornecedor,
          data: 'N/A',
          etapa: lojasPrioritarias[0].etapa || 'N/A',
          dias: 9999,
          situacao: lojasPrioritarias[0].situacao
        };
      }
    }
  }
  
  // Se n√£o h√° situa√ß√µes priorit√°rias, usar a l√≥gica original (mais antiga)
  const lojasComData = lojasDoCNPJ.filter(loja => {
    if (!loja.ultima_etapa || loja.ultima_etapa === 'N/A') return false;
    try {
      const data = new Date(loja.ultima_etapa.split('/').reverse().join('-'));
      return !isNaN(data.getTime());
    } catch (error) {
      return false;
    }
  });
  
  if (lojasComData.length > 0) {
    const lojaMaisAntiga = lojasComData.reduce((maisAntiga, atual) => {
      try {
        const dataMaisAntiga = new Date(maisAntiga.ultima_etapa.split('/').reverse().join('-'));
        const dataAtual = new Date(atual.ultima_etapa.split('/').reverse().join('-'));
        return dataAtual < dataMaisAntiga ? atual : maisAntiga;
      } catch (error) {
        return maisAntiga;
      }
    });
    
    const diasDefasagem = calcularDiasDefasagem(lojaMaisAntiga.ultima_etapa);
    return {
      fornecedor: lojaMaisAntiga.fornecedor,
      data: lojaMaisAntiga.ultima_etapa,
      etapa: lojaMaisAntiga.etapa,
      dias: diasDefasagem,
      situacao: lojaMaisAntiga.situacao
    };
  }
  
  // Se n√£o encontrar lojas com data, retorne a primeira loja que tenha etapa
  const lojaComEtapa = lojasDoCNPJ.find(loja => loja.etapa && loja.etapa !== 'N/A');
  if (lojaComEtapa) {
    return {
      fornecedor: lojaComEtapa.fornecedor,
      data: 'N/A',
      etapa: lojaComEtapa.etapa,
      dias: 9999,
      situacao: lojaComEtapa.situacao
    };
  }
  
  // √öltimo recurso: retorne a primeira loja
  return {
    fornecedor: lojasDoCNPJ[0].fornecedor,
    data: 'N/A',
    etapa: lojasDoCNPJ[0].etapa || 'N/A',
    dias: 9999,
    situacao: lojasDoCNPJ[0].situacao
  };
}

// FUN√á√ÉO CORRIGIDA: Calcular defasagem correta por CNPJ
function calcularDefasagemPorCNPJ(lojasDoCNPJ) {
  if (!lojasDoCNPJ || lojasDoCNPJ.length === 0) {
    return { dias: 9999, fornecedor: 'N/A', data: 'N/A', etapa: 'N/A' };
  }
  
  const fornecedorMaisAntigo = encontrarFornecedorMaisAntigo(lojasDoCNPJ);
  
  return {
    dias: fornecedorMaisAntigo.dias,
    fornecedor: fornecedorMaisAntigo.fornecedor,
    data: fornecedorMaisAntigo.data,
    etapa: fornecedorMaisAntigo.etapa
  };
}

function carregarCadastros() {
  console.log("üéØ Carregando cadastros...");
  
  showLoading();
  document.getElementById('tableContainer').style.display = 'none';

  // SALVAR FILTROS ATUAIS ANTES DE RECARREGAR
  const filtrosSalvos = {
    situacaoAtiva: situacaoAtiva,
    filtrosAtivos: {...filtrosAtivos},
    etapasSelecionados: [...etapasSelecionados],
    fornecedoresSelecionados: [...fornecedoresSelecionados],
    pesquisa: document.getElementById('pesquisaCadastros').value,
    ordenacao: document.getElementById('ordenacaoCadastros').value
  };

  // SALVAR NO localStorage PARA GARANTIR PERSIST√äNCIA
  localStorage.setItem('filtrosSalvos', JSON.stringify(filtrosSalvos));

  google.script.run
    .withSuccessHandler(function(cadastros) {
      hideLoading();
      hideLoadingPopup();
      
      console.log("‚úÖ Cadastros recebidos:", cadastros);
      
      if (cadastros && cadastros.length > 0) {
        // ORDENAR POR RAZ√ÉO SOCIAL (A-Z) AO CARREGAR
        const cadastrosOrdenados = cadastros.sort((a, b) => {
          const nomeA = (a.razao_social || '').toLowerCase();
          const nomeB = (b.razao_social || '').toLowerCase();
          return nomeA.localeCompare(nomeB);
        });
        
        todosCadastros = cadastrosOrdenados;
        cadastrosFiltrados = [...cadastrosOrdenados];
        
        // RESTAURAR FILTROS AP√ìS CARREGAR
        setTimeout(() => {
          restaurarFiltros(filtrosSalvos);
        }, 100);
        
        document.getElementById('filtrosContainer').style.display = 'flex';
        
        showMessage('success', `‚úÖ ${cadastros.length} cadastros carregados!`);
      } else {
        document.getElementById('tabelaCadastrosBody').innerHTML = `
          <tr>
            <td colspan="9" style="text-align: center; padding: 40px;">
              <i class="fas fa-inbox" style="font-size: 3rem; color: var(--gray); margin-bottom: 15px;"></i>
              <h3>Nenhum cadastro encontrado</h3>
              <p>N√£o h√° cadastros no sistema.</p>
            </td>
          </tr>
        `;
        document.getElementById('tableContainer').style.display = 'block';
        showMessage('info', 'üìù Nenhum cadastro encontrado.');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      hideLoadingPopup();
      console.error("‚ùå Erro ao carregar cadastros:", error);
      showMessage('error', '‚ùå Erro ao carregar cadastros: ' + error.message);
      
      // TENTAR RESTAURAR FILTROS MESMO COM ERRO
      try {
        const filtrosSalvos = JSON.parse(localStorage.getItem('filtrosSalvos') || '{}');
        restaurarFiltros(filtrosSalvos);
      } catch (e) {
        console.error("Erro ao restaurar filtros:", e);
      }
    })
    .buscarTodosCadastrosComWaitlabel(waitlabelAtual);
}

function restaurarFiltros(filtrosSalvos) {
  if (!filtrosSalvos) {
    // TENTAR RECUPERAR DO localStorage SE N√ÉO FOR PASSADO
    try {
      filtrosSalvos = JSON.parse(localStorage.getItem('filtrosSalvos') || '{}');
    } catch (e) {
      console.error("Erro ao recuperar filtros do localStorage:", e);
      return;
    }
  }
  
  console.log("üîÑ Restaurando filtros:", filtrosSalvos);
  
  // Restaurar vari√°veis globais
  situacaoAtiva = filtrosSalvos.situacaoAtiva || 'all';
  filtrosAtivos = {...(filtrosSalvos.filtrosAtivos || {})};
  etapasSelecionados = [...(filtrosSalvos.etapasSelecionados || [])];
  fornecedoresSelecionados = [...(filtrosSalvos.fornecedoresSelecionados || [])];
  
  // Restaurar elementos da interface
  if (document.getElementById('pesquisaCadastros')) {
    document.getElementById('pesquisaCadastros').value = filtrosSalvos.pesquisa || '';
  }
  
  if (document.getElementById('ordenacaoCadastros')) {
    document.getElementById('ordenacaoCadastros').value = filtrosSalvos.ordenacao || 'razao_social';
  }
  
  // Atualizar bot√µes de situa√ß√£o
  document.querySelectorAll('.filtro-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  const btnAtivo = document.querySelector(`.filtro-btn[data-situacao="${situacaoAtiva}"]`);
  if (btnAtivo) {
    btnAtivo.classList.add('active');
  } else {
    // Fallback para "Todos"
    const btnTodos = document.querySelector('.filtro-btn[data-situacao="all"]');
    if (btnTodos) {
      btnTodos.classList.add('active');
      situacaoAtiva = 'all';
    }
  }
  
  // Atualizar tags selecionadas
  atualizarEtapasSelecionados();
  atualizarFornecedoresSelecionados();
  
  // Reaplicar os filtros
  aplicarTodosFiltros();
  
  // Reordenar se necess√°rio
  if (filtrosSalvos.ordenacao) {
    setTimeout(() => {
      ordenarCadastros();
    }, 150);
  }
}

// AGRUPAR CADASTROS POR CNPJ
function agruparCadastrosPorCNPJ(cadastros) {
  const agrupados = {};
  
  cadastros.forEach(cadastro => {
    if (!agrupados[cadastro.cnpj]) {
      agrupados[cadastro.cnpj] = {
        razao_social: cadastro.razao_social,
        nome_fantasia: cadastro.nome_fantasia,
        cnpj: cadastro.cnpj,
        lojas: []
      };
    }
    
    agrupados[cadastro.cnpj].lojas.push(cadastro);
  });
  
  return Object.values(agrupados);
}

// FUN√á√ÉO criarLinhaTabelaAgrupada COMPLETA - COM A L√ìGICA CORRIGIDA
function criarLinhaTabelaAgrupada(grupo) {
  const row = document.createElement('tr');
  
  // NOVA L√ìGICA: Priorizar situa√ß√µes
  const situacoes = grupo.lojas.map(l => l.situacao);
  
  // Ordem de prioridade
  let situacaoPrincipal = 'CADASTRADO'; // padr√£o
  
  if (situacoes.includes('EM ANDAMENTO')) {
    situacaoPrincipal = 'EM ANDAMENTO';
  } else if (situacoes.includes('NOVO REGISTRO')) {
    situacaoPrincipal = 'NOVO REGISTRO';
  } else if (situacoes.includes('DESCREDENCIADO')) {
    situacaoPrincipal = 'DESCREDENCIADO';
  } else if (situacoes.includes('REJEITADO')) {
    situacaoPrincipal = 'REJEITADO';
  } else if (situacoes.includes('DESISTIU')) {
    situacaoPrincipal = 'DESISTIU';
  }
  
  const fornecedorMaisAntigo = encontrarFornecedorMaisAntigo(grupo.lojas);
  
  let dataHoraMaisAntiga = 'N/A';
  let dataHoraCorrigida = 'N/A';

  if (fornecedorMaisAntigo.data && fornecedorMaisAntigo.data !== 'N/A') {
    dataHoraMaisAntiga = fornecedorMaisAntigo.data;
    
    if (typeof dataHoraMaisAntiga === 'string' && dataHoraMaisAntiga.includes('/') && dataHoraMaisAntiga.includes(':')) {
      dataHoraCorrigida = corrigirHoraFrontend(dataHoraMaisAntiga);
    } else {
      dataHoraCorrigida = dataHoraMaisAntiga.toString();
    }
  }

  const etapaMaisAntiga = fornecedorMaisAntigo.etapa || 'N/A';
  const nomeFornecedorAntigo = fornecedorMaisAntigo.fornecedor || 'N/A';

  // VERIFICAR SE DEVE MOSTRAR HORA E FORNECEDOR
  const mostrarHoraFornecedor = situacaoPrincipal === 'EM ANDAMENTO' || situacaoPrincipal === 'NOVO REGISTRO';

  // L√ìGICA PARA √öLTIMA ETAPA - MOSTRAR HORA/FORNECEDOR APENAS PARA EM ANDAMENTO E NOVO REGISTRO
  let ultimaEtapaInfo = '';
  
  if (dataHoraCorrigida !== 'N/A' && etapaMaisAntiga !== 'N/A') {
    if (dataHoraCorrigida.includes('/') && dataHoraCorrigida.includes(':')) {
      const [dataPart, horaPart] = dataHoraCorrigida.split(' ');
      
      if (mostrarHoraFornecedor) {
        // MOSTRAR ETAPA, HORA E FORNECEDOR (EM ANDAMENTO e NOVO REGISTRO)
        ultimaEtapaInfo = `
          <div style="font-size: 0.75rem;">
            <div style="font-weight: 500; margin-bottom: 2px;">${etapaMaisAntiga}</div>
            <div style="color: var(--gray); font-size: 0.65rem;">
              ${dataPart} ${horaPart || ''}
            </div>
            <div style="color: var(--danger); font-size: 0.6rem; margin-top: 2px;">
              ‚ö†Ô∏è ${nomeFornecedorAntigo}
            </div>
          </div>
        `;
      } else {
        // MOSTRAR APENAS A ETAPA (outras situa√ß√µes)
        ultimaEtapaInfo = `
          <div style="font-size: 0.75rem;">
            <div style="font-weight: 500; margin-bottom: 2px;">${etapaMaisAntiga}</div>
            <div style="color: var(--gray); font-size: 0.65rem;">
              Finalizado
            </div>
          </div>
        `;
      }
    } else {
      if (mostrarHoraFornecedor) {
        // MOSTRAR ETAPA E FORNECEDOR (sem hora v√°lida)
        ultimaEtapaInfo = `
          <div style="font-size: 0.75rem;">
            <div style="font-weight: 500; margin-bottom: 2px;">${etapaMaisAntiga}</div>
            <div style="color: var(--gray); font-size: 0.65rem;">${dataHoraCorrigida}</div>
            <div style="color: var(--danger); font-size: 0.6rem; margin-top: 2px;">
              ‚ö†Ô∏è ${nomeFornecedorAntigo}
            </div>
          </div>
        `;
      } else {
        // MOSTRAR APENAS A ETAPA
        ultimaEtapaInfo = `
          <div style="font-size: 0.75rem;">
            <div style="font-weight: 500; margin-bottom: 2px;">${etapaMaisAntiga}</div>
            <div style="color: var(--gray); font-size: 0.65rem;">Etapa registrada</div>
          </div>
        `;
      }
    }
  } else {
    if (mostrarHoraFornecedor) {
      // MOSTRAR ETAPA E FORNECEDOR (sem data)
      ultimaEtapaInfo = `
        <div style="font-size: 0.75rem;">
          <div style="font-weight: 500; margin-bottom: 2px;">${etapaMaisAntiga}</div>
          <div style="color: var(--gray); font-size: 0.65rem;">N/A</div>
          <div style="color: var(--danger); font-size: 0.6rem; margin-top: 2px;">
            ‚ö†Ô∏è ${nomeFornecedorAntigo}
          </div>
        </div>
      `;
    } else {
      // MOSTRAR APENAS A ETAPA
      ultimaEtapaInfo = `
        <div style="font-size: 0.75rem;">
          <div style="font-weight: 500; margin-bottom: 2px;">${etapaMaisAntiga}</div>
          <div style="color: var(--gray); font-size: 0.65rem;">Sem informa√ß√µes</div>
        </div>
      `;
    }
  }

  // CORRE√á√ÉO: S√ì MOSTRAR DEFASAGEM SE HOUVER LOJA EM ANDAMENTO
  const temLojaEmAndamento = grupo.lojas.some(loja => 
    loja.situacao && loja.situacao.toUpperCase() === 'EM ANDAMENTO'
  );

  let defasagemHTML = '';
  if (temLojaEmAndamento) {
    const defasagemInfo = calcularDefasagemPorCNPJ(grupo.lojas);
    const defasagemTexto = defasagemInfo.dias === 0 ? 'Hoje' : 
                          defasagemInfo.dias === 1 ? '1 dia' : 
                          defasagemInfo.dias > 1 && defasagemInfo.dias < 9999 ? `${defasagemInfo.dias} dias` : 'N/A';
    const defasagemClass = getDefasagemClass(defasagemTexto);
    
    defasagemHTML = `
      <td style="text-align: center;">
        <div class="defasagem-container">
          <span class="defasagem-badge ${defasagemClass}" title="Fornecedor mais antigo: ${defasagemInfo.fornecedor}">
            ${defasagemTexto}
          </span>
        </div>
      </td>
    `;
  } else {
    defasagemHTML = `
      <td style="text-align: center;">
        <div class="defasagem-container">
          <span class="sem-defasagem-badge" title="Nenhuma loja em andamento">
            Sem defasagem
          </span>
        </div>
      </td>
    `;
  }

  row.innerHTML = `
    <td>
      <div style="font-weight: 600; color: var(--primary); margin-bottom: 2px;">${grupo.razao_social || 'N/A'}</div>
      <div style="font-size: 0.7rem; color: var(--gray);">${grupo.nome_fantasia || 'Sem nome fantasia'}</div>
      <div style="font-size: 0.65rem; color: var(--info); margin-top: 2px;">
        <strong>${grupo.lojas.length}</strong> fornecedor(es)
      </div>
    </td>
    <td>
      <div style="font-family: monospace; font-size: 0.75rem; font-weight: 600; color: var(--dark);">
        ${grupo.cnpj || 'N/A'}
      </div>
    </td>
    <td>
      <div style="font-weight: 500; color: var(--dark);">
        ${grupo.lojas.map(l => l.fornecedor).join(', ')}
      </div>
    </td>
    <td>
      <span class="status-badge ${getSituacaoClass(situacaoPrincipal)}">${situacaoPrincipal}</span>
    </td>
    <td>
      ${ultimaEtapaInfo}
    </td>
    ${defasagemHTML}
    <td style="font-weight: 600; color: var(--success); text-align: center;">
      ${formatarMoedaParaInput(grupo.lojas[0]?.mensalidade)}
    </td>
    <td style="font-weight: 600; color: var(--info); text-align: center;">
      ${grupo.lojas[0]?.adesao === 'Isento' || grupo.lojas[0]?.adesao === 0 ? 'Isento' : formatarMoedaParaInput(grupo.lojas[0]?.adesao)}
    </td>
    <td style="text-align: center;">
      <button class="btn btn-info btn-sm btn-visualizar-compact" onclick="verTodosFornecedores('${grupo.cnpj}')" title="Visualizar Todos">
        <i class="fas fa-eye"></i> Ver Todos
      </button>
    </td>
  `;

  return row;
}

// EXIBIR TABELA AGRUPADA
function exibirTabelaCadastros() {
  const tabelaBody = document.getElementById('tabelaCadastrosBody');
  const loading = document.getElementById('loadingCadastros');
  const tableContainer = document.getElementById('tableContainer');

  tabelaBody.innerHTML = '';

  if (cadastrosFiltrados.length === 0) {
    tabelaBody.innerHTML = `
      <tr>
        <td colspan="9" style="text-align: center; padding: 40px;">
          <i class="fas fa-search" style="font-size: 3rem; color: var(--gray); margin-bottom: 15px;"></i>
          <h3>Nenhum resultado encontrado</h3>
          <p>Tente alterar os filtros de pesquisa.</p>
        </td>
      </tr>
    `;
  } else {
    const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosFiltrados);
    cadastrosAgrupados.forEach(grupo => {
      const row = criarLinhaTabelaAgrupada(grupo);
      tabelaBody.appendChild(row);
    });
  }

  loading.style.display = 'none';
  tableContainer.style.display = 'block';
  atualizarContador();
}

// FUN√á√ïES DE FILTRO
function aplicarFiltroSituacao(situacao) {
  document.querySelectorAll('.filtro-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  if (situacao !== situacaoAtiva) {
    const btnAtivo = document.querySelector(`.filtro-btn[data-situacao="${situacao}"]`);
    if (btnAtivo) {
      btnAtivo.classList.add('active');
    }
    situacaoAtiva = situacao;
  } else {
    situacaoAtiva = 'all';
    const btnTodos = document.querySelector('.filtro-btn[data-situacao="all"]');
    if (btnTodos) {
      btnTodos.classList.add('active');
    }
  }

  if (situacaoAtiva === 'all') {
    delete filtrosAtivos.situacao;
  } else {
    filtrosAtivos.situacao = situacaoAtiva;
  }
  aplicarTodosFiltros();
}

function filtrarPesquisa() {
  const termo = document.getElementById('pesquisaCadastros').value.toLowerCase().trim();
  if (termo) {
    filtrosAtivos.pesquisa = termo;
  } else {
    delete filtrosAtivos.pesquisa;
  }
  aplicarTodosFiltros();
}

// APLICAR TODOS OS FILTROS
function aplicarTodosFiltros() {
  console.log("üéØ [FILTRO] Aplicando todos os filtros...");
  
  let resultado = [...todosCadastros];
  
  if (filtrosAtivos.situacao) {
    resultado = resultado.filter(cadastro => 
      cadastro.situacao === filtrosAtivos.situacao
    );
  }
  
  if (filtrosAtivos.etapas && filtrosAtivos.etapas.length > 0) {
    resultado = resultado.filter(cadastro => 
      filtrosAtivos.etapas.some(etapa => 
        cadastro.etapa && cadastro.etapa.toUpperCase().includes(etapa)
      )
    );
  }
  
  if (filtrosAtivos.fornecedores && filtrosAtivos.fornecedores.length > 0) {
    resultado = resultado.filter(cadastro => 
      filtrosAtivos.fornecedores.includes(cadastro.fornecedor)
    );
  }
  
  if (filtrosAtivos.pesquisa) {
    resultado = resultado.filter(cadastro => 
      (cadastro.razao_social && cadastro.razao_social.toLowerCase().includes(filtrosAtivos.pesquisa)) ||
      (cadastro.nome_fantasia && cadastro.nome_fantasia.toLowerCase().includes(filtrosAtivos.pesquisa)) ||
      (cadastro.cnpj && cadastro.cnpj.includes(filtrosAtivos.pesquisa)) ||
      (cadastro.fornecedor && cadastro.fornecedor.toLowerCase().includes(filtrosAtivos.pesquisa)) ||
      (cadastro.etapa && cadastro.etapa.toLowerCase().includes(filtrosAtivos.pesquisa))
    );
  }
  
  cadastrosFiltrados = resultado;
  console.log(`‚úÖ [FILTRO] Filtros aplicados: ${resultado.length} de ${todosCadastros.length} registros`);
  
  exibirTabelaCadastros();
}

// ORDENA√á√ÉO
function ordenarCadastros() {
  const criterio = document.getElementById('ordenacaoCadastros').value;
  
  console.log("üéØ Ordenando por:", criterio);
  
  const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosFiltrados);
  
  cadastrosAgrupados.sort((a, b) => {
    switch(criterio) {
      case 'razao_social':
        return (a.razao_social || '').localeCompare(b.razao_social || '');
      case 'razao_social_desc':
        return (b.razao_social || '').localeCompare(a.razao_social || '');
      case 'nome_fantasia':
        return (a.nome_fantasia || '').localeCompare(b.nome_fantasia || '');
      case 'nome_fantasia_desc':
        return (b.nome_fantasia || '').localeCompare(a.nome_fantasia || '');
      case 'situacao':
        const situacaoA = a.lojas[0]?.situacao || '';
        const situacaoB = b.lojas[0]?.situacao || '';
        return situacaoA.localeCompare(situacaoB);
      case 'fornecedor':
        const fornecedorA = a.lojas[0]?.fornecedor || '';
        const fornecedorB = b.lojas[0]?.fornecedor || '';
        return fornecedorA.localeCompare(fornecedorB);
      case 'defasagem':
        const defasagemA = calcularDefasagemParaOrdenacao(a.lojas);
        const defasagemB = calcularDefasagemParaOrdenacao(b.lojas);
        return defasagemB - defasagemA;
      case 'defasagem_asc':
        const defasagemAAsc = calcularDefasagemParaOrdenacao(a.lojas);
        const defasagemBAsc = calcularDefasagemParaOrdenacao(b.lojas);
        return defasagemAAsc - defasagemBAsc;
      case 'mensalidade':
        const mensalidadeA = parseFloat(a.lojas[0]?.mensalidade || 0);
        const mensalidadeB = parseFloat(b.lojas[0]?.mensalidade || 0);
        return mensalidadeB - mensalidadeA;
      case 'mensalidade_asc':
        const mensalidadeAAsc = parseFloat(a.lojas[0]?.mensalidade || 0);
        const mensalidadeBAsc = parseFloat(b.lojas[0]?.mensalidade || 0);
        return mensalidadeAAsc - mensalidadeBAsc;
      case 'adesao':
        const adesaoA = a.lojas[0]?.adesao === 'Isento' || a.lojas[0]?.adesao === 0 ? 0 : parseFloat(a.lojas[0]?.adesao || 0);
        const adesaoB = b.lojas[0]?.adesao === 'Isento' || b.lojas[0]?.adesao === 0 ? 0 : parseFloat(b.lojas[0]?.adesao || 0);
        return adesaoB - adesaoA;
      case 'adesao_asc':
        const adesaoAAsc = a.lojas[0]?.adesao === 'Isento' || a.lojas[0]?.adesao === 0 ? 0 : parseFloat(a.lojas[0]?.adesao || 0);
        const adesaoBAsc = b.lojas[0]?.adesao === 'Isento' || b.lojas[0]?.adesao === 0 ? 0 : parseFloat(b.lojas[0]?.adesao || 0);
        return adesaoAAsc - adesaoBAsc;
      default:
        return 0;
    }
  });
  
  exibirTabelaCadastrosAgrupada(cadastrosAgrupados, 'Cadastros Ordenados');
}

function exibirTabelaCadastrosAgrupada(cadastrosAgrupados, titulo) {
  const tabelaBody = document.getElementById('tabelaCadastrosBody');
  const loading = document.getElementById('loadingCadastros');
  const tableContainer = document.getElementById('tableContainer');

  tabelaBody.innerHTML = '';

  if (cadastrosAgrupados.length === 0) {
    tabelaBody.innerHTML = `
      <tr>
        <td colspan="9" style="text-align: center; padding: 40px;">
          <i class="fas fa-search" style="font-size: 3rem; color: var(--gray); margin-bottom: 15px;"></i>
          <h3>Nenhum resultado encontrado</h3>
          <p>Tente alterar os filtros de pesquisa.</p>
        </td>
      </tr>
    `;
  } else {
    cadastrosAgrupados.forEach(grupo => {
      const row = criarLinhaTabelaAgrupada(grupo);
      tabelaBody.appendChild(row);
    });
  }

  loading.style.display = 'none';
  tableContainer.style.display = 'block';
  atualizarContador();
}

function limparTodosFiltros() {
  filtrosAtivos = {};
  situacaoAtiva = 'all';
  etapasSelecionados = [];
  fornecedoresSelecionados = [];
  document.getElementById('pesquisaCadastros').value = '';
  document.getElementById('ordenacaoCadastros').value = 'razao_social';
  document.getElementById('filtroEtapa').value = '';
  document.getElementById('filtroFornecedor').value = '';
  
  document.querySelectorAll('.filtro-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector('.filtro-btn[data-situacao="all"]').classList.add('active');
  
  atualizarEtapasSelecionados();
  atualizarFornecedoresSelecionados();
  
  aplicarTodosFiltros();
}

function verTodosFornecedores(cnpj) {
  showLoadingPopup('Carregando Fornecedores', 'Buscando informa√ß√µes dos fornecedores...');
  
  setTimeout(() => {
    const lojasDoCNPJ = todosCadastros.filter(cadastro => cadastro.cnpj === cnpj);
    exibirModalFornecedores(cnpj, lojasDoCNPJ);
    hideLoadingPopup();
  }, 500);
}

function exibirModalFornecedores(cnpj, lojas) {
    const modal = document.getElementById('modalFornecedores');
    const content = document.getElementById('modalFornecedoresContent');
    
    let lojasHTML = '';
    
    if (lojas && lojas.length > 0) {
        lojasHTML = lojas.map((loja, index) => {
            const ultimaEtapaCorrigida = loja.ultima_etapa ? 
                corrigirHoraFrontend(loja.ultima_etapa) : 'N/A';
            
            const situacaoClass = getSituacaoClass(loja.situacao);
            const corBorda = getCorBordaSituacao(loja.situacao);
            
            return `
            <div class="modal-fornecedor-card" style="border-left: 4px solid ${corBorda}; margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <!-- Header com n√∫mero e informa√ß√µes principais -->
              <div class="modal-fornecedor-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                <div class="fornecedor-badge" style="background: var(--primary); color: white; padding: 8px 12px; border-radius: 6px; font-weight: 700;">
                  <span class="fornecedor-indice" style="display: block; text-align: center;">#${index + 1}</span>
                </div>
                <div class="fornecedor-title" style="display: flex; align-items: center; gap: 10px; flex: 1; margin-left: 15px;">
                  <i class="fas fa-store" style="color: var(--primary);"></i>
                  <div>
                    <h4 class="modal-fornecedor-nome" style="margin: 0; color: var(--dark); font-size: 1.1rem;">${loja.fornecedor || 'Fornecedor'}</h4>
                    <div class="fornecedor-subinfo">
                      <span class="info-tag" style="background: rgba(0,0,0,0.05); padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; color: var(--gray);">
                        <i class="fas fa-info-circle"></i>
                        ${loja.situacao || 'N/A'}
                      </span>
                    </div>
                  </div>
                </div>
                <span class="status-badge ${situacaoClass}" 
          style="background: ${corBorda}; color: white;">
      ${loja.situacao || 'N/A'}
    </span>
              </div>
              
              <!-- Grid de informa√ß√µes principais -->
              <div class="modal-fornecedor-info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div class="modal-info-item" style="display: flex; align-items: center; gap: 10px;">
                  <div class="info-icon" style="font-size: 1.2rem;">üìã</div>
                  <div class="info-content">
                    <span class="modal-info-label" style="display: block; font-size: 0.8rem; color: var(--gray); margin-bottom: 2px;">Etapa Atual</span>
                    <span class="modal-info-value etapa-destaque" style="font-weight: 700; color: var(--primary);">${loja.etapa || 'N/A'}</span>
                  </div>
                </div>
                
                <div class="modal-info-item" style="display: flex; align-items: center; gap: 10px;">
                  <div class="info-icon" style="font-size: 1.2rem;">üí∞</div>
                  <div class="info-content">
                    <span class="modal-info-label" style="display: block; font-size: 0.8rem; color: var(--gray); margin-bottom: 2px;">Configura√ß√£o</span>
                    <span class="modal-info-value" style="font-weight: 600;">
                      ${loja.tarifa || 'N/A'} 
                      <span class="percentual-destaque" style="background: var(--secondary); color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.8rem; margin-left: 5px;">
                        ${formatarPercentualCorrigido(loja.percentual_tarifa)}
                      </span>
                    </span>
                  </div>
                </div>
                
                <div class="modal-info-item" style="display: flex; align-items: center; gap: 10px;">
                  <div class="info-icon" style="font-size: 1.2rem;">üíµ</div>
                  <div class="info-content">
                    <span class="modal-info-label" style="display: block; font-size: 0.8rem; color: var(--gray); margin-bottom: 2px;">Mensalidade</span>
                    <span class="modal-info-value valor-destaque" style="font-weight: 700; color: var(--success);">${formatarMoedaParaInput(loja.mensalidade)}</span>
                  </div>
                </div>
                
                <div class="modal-info-item" style="display: flex; align-items: center; gap: 10px;">
                  <div class="info-icon" style="font-size: 1.2rem;">ü§ù</div>
                  <div class="info-content">
                    <span class="modal-info-label" style="display: block; font-size: 0.8rem; color: var(--gray); margin-bottom: 2px;">Ades√£o</span>
                    <span class="modal-info-value valor-destaque" style="font-weight: 700; color: var(--info);">
                      ${loja.adesao === 'Isento' || loja.adesao === 0 ? 'Isento' : formatarMoedaParaInput(loja.adesao)}
                    </span>
                  </div>
                </div>
              </div>
              
              <!-- Se√ß√£o de timeline e acompanhamento -->
              <div class="timeline-section" style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                <div class="timeline-item" style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                  <div class="timeline-icon" style="font-size: 1.1rem;">‚è∞</div>
                  <div class="timeline-content">
                    <span class="timeline-label" style="display: block; font-size: 0.8rem; color: var(--gray); margin-bottom: 2px;">√öltima Atualiza√ß√£o</span>
                    <span class="timeline-value" style="font-weight: 600; color: var(--dark);">${ultimaEtapaCorrigida}</span>
                  </div>
                </div>
                
                <div class="timeline-item" style="display: flex; align-items: center; gap: 10px;">
                  <div class="timeline-icon" style="font-size: 1.1rem;">üìä</div>
                  <div class="timeline-content">
                    <span class="timeline-label" style="display: block; font-size: 0.8rem; color: var(--gray); margin-bottom: 2px;">Tempo de Processo</span>
                    <span class="timeline-value ${loja.situacao && loja.situacao.toUpperCase() === 'EM ANDAMENTO' ? 
                      (calcularDefasagem(loja.ultima_etapa).includes('30') || calcularDefasagem(loja.ultima_etapa).includes('31') ? 
                      'defasagem-alerta' : 'defasagem-normal') : 'defasagem-inativa'}" 
                      style="font-weight: 600; ${loja.situacao && loja.situacao.toUpperCase() === 'EM ANDAMENTO' ? 
                      (calcularDefasagem(loja.ultima_etapa).includes('30') || calcularDefasagem(loja.ultima_etapa).includes('31') ? 
                      'color: var(--danger);' : 'color: var(--warning);') : 'color: var(--gray);'}">
                      ${loja.situacao && loja.situacao.toUpperCase() === 'EM ANDAMENTO' ? 
                        calcularDefasagem(loja.ultima_etapa) : 'Sem acompanhamento'}
                    </span>
                  </div>
                </div>
              </div>

              <!-- SE√á√ÉO DE OBSERVA√á√ïES NO FINAL CORRETO - DEPOIS DO TEMPO DE PROCESSO -->
              ${loja.observacoes ? `
              <div class="observacoes-section" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                <div class="observacao-item" style="display: flex; align-items: flex-start; gap: 10px;">
                  <div class="observacao-icon" style="font-size: 1.1rem; color: #856404;">üìù</div>
                  <div class="observacao-content" style="flex: 1;">
                    <span class="observacao-label" style="display: block; font-size: 0.8rem; color: #856404; font-weight: 600; margin-bottom: 4px;">Observa√ß√µes</span>
                    <span class="observacao-value" style="font-size: 0.85rem; color: #856404; line-height: 1.4;">
                      ${loja.observacoes}
                    </span>
                  </div>
                </div>
              </div>
              ` : ''}
              
              <!-- A√ß√µes -->
              <div class="modal-actions" style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn btn-warning btn-sm btn-action" 
                        onclick="verDetalhesCadastroModal('${loja.id}'); fecharModalFornecedores();"
                        title="Ver detalhes deste fornecedor"
                        style="padding: 6px 12px; border: none; border-radius: 4px; background: var(--warning); color: var(--dark); cursor: pointer; font-size: 0.8rem;">
                  <i class="fas fa-eye"></i> Detalhes
                </button>
              </div>
            </div>
          `}).join('');
    } else {
        lojasHTML = `
        <div class="empty-state" style="text-align: center; padding: 40px;">
          <i class="fas fa-store-slash" style="font-size: 4rem; color: #6c757d; margin-bottom: 20px;"></i>
          <h4 style="color: #6c757d; margin-bottom: 10px;">Nenhuma loja encontrada</h4>
          <p style="color: #8a8a8a;">N√£o h√° lojas cadastradas para este CNPJ.</p>
        </div>
      `;
    }

    // Fun√ß√£o auxiliar para formatar CNPJ
    const formatarCNPJParaModal = (cnpj) => {
      if (!cnpj) return 'N/A';
      const cnpjLimpo = cnpj.replace(/\D/g, '');
      if (cnpjLimpo.length === 14) {
        return cnpjLimpo.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
      }
      return cnpj;
    };

    const cnpjFormatado = formatarCNPJParaModal(cnpj);
    const primeiraLoja = lojas && lojas.length > 0 ? lojas[0] : null;
    const razaoSocial = primeiraLoja ? primeiraLoja.razao_social : 'N/A';

    content.innerHTML = `
      <!-- Header Profissional do CNPJ -->
      <div class="modal-cnpj-header-profissional">
        <div class="cnpj-header-content">
          <div class="cnpj-icon">
            <i class="fas fa-building"></i>
          </div>
          <div class="cnpj-info">
            <h3 class="cnpj-title">CNPJ</h3>
            <div class="cnpj-number">${cnpjFormatado}</div>
            <div class="cnpj-subtitle">${razaoSocial}</div>
          </div>
          <div class="cnpj-badge">
            <span class="lojas-count">${lojas ? lojas.length : 0}</span>
            <small>Fornecedores</small>
          </div>
        </div>
      </div>
      
      <!-- Lista de Fornecedores -->
      <div class="modal-content-scroll">
        <div class="fornecedores-list-header">
          <h4><i class="fas fa-list-ul"></i> Fornecedores Vinculados</h4>
          <span class="subtitle">Lista completa de integra√ß√µes</span>
        </div>
        ${lojasHTML}
      </div>
    `;
    
    modal.style.display = 'flex';
    hideLoadingPopup();
}

function fecharModalFornecedores() {
  const modal = document.getElementById('modalFornecedores');
  modal.style.display = 'none';
}

function verDetalhesCadastroModal(id) {
  console.log("üëÄ Visualizando detalhes ID:", id);
  
  showLoadingPopup('Carregando Detalhes', 'Buscando informa√ß√µes completas...');
  
  google.script.run
    .withSuccessHandler(function(dados) {
      console.log("‚úÖ Dados recebidos para detalhes:", dados);
      exibirModalDetalhesCompleto(dados);
      hideLoadingPopup();
    })
    .withFailureHandler(function(error) {
      hideLoadingPopup();
      showMessage('error', '‚ùå Erro ao carregar detalhes: ' + error.message);
    })
    .buscarCadastroPorIDComWaitlabel(id, waitlabelAtual);
}

function exibirModalDetalhesCompleto(dados) {
    const modal = document.getElementById('modalDetalhes');
    const content = document.getElementById('modalDetalhesContent');
    
    const mensalidadeFormatada = formatarMoedaParaInput(dados.mensalidade);
    const mensalidadeSimFormatada = formatarMoedaParaInput(dados.mensalidade_sim || 0);
    const adesaoFormatada = dados.adesao === 'Isento' || dados.adesao === 0 ? 'Isento' : formatarMoedaParaInput(dados.adesao);
    
    // CORRIGIR DATAS PARA EXIBI√á√ÉO
    const ultimaEtapaCorrigida = dados.ultima_etapa ? corrigirHoraFrontend(dados.ultima_etapa) : 'N/A';

    // CORRE√á√ÉO: S√ì MOSTRAR DEFASAGEM SE FOR EM ANDAMENTO
    const mostrarDefasagem = dados.situacao && dados.situacao.toUpperCase() === 'EM ANDAMENTO';
    const defasagem = calcularDefasagem(ultimaEtapaCorrigida);

    // SE√á√ÉO DE DEFASAGEM (S√ì SE FOR EM ANDAMENTO)
    const secaoDefasagem = mostrarDefasagem && defasagem !== 'N/A' && defasagem !== '0 dias' && defasagem !== 'Data inv√°lida' && defasagem !== 'Erro no c√°lculo' ? `
    <div class="detalhe-item" style="grid-column: 1 / -1; background: #fff5f5; border-left: 4px solid #dc3545; margin-top: 10px;">
        <span class="detalhe-label" style="font-size: 1.1em; color: #dc3545;">
            <i class="fas fa-clock"></i> ‚ö†Ô∏è INFORMA√á√ïES DE DEFASAGEM
        </span>
    </div>
    
    <div class="detalhe-item">
        <span class="detalhe-label">‚è∞ Defasagem</span>
        <div class="detalhe-valor">
            <span style="display: inline-flex; align-items: center; gap: 5px; background: #dc3545; color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.9rem; font-weight: 600;">
                <i class="fas fa-clock"></i>
                ${defasagem}
            </span>
        </div>
    </div>
    ` : mostrarDefasagem ? '' : `
    <div class="detalhe-item" style="grid-column: 1 / -1; background: #e9ecef; border-left: 4px solid #6c757d; margin-top: 10px;">
        <span class="detalhe-label" style="font-size: 1.1em; color: #6c757d;">
            <i class="fas fa-clock"></i> INFORMA√á√ïES DE DEFASAGEM
        </span>
    </div>
    
    <div class="detalhe-item">
        <span class="detalhe-label">‚è∞ Defasagem</span>
        <div class="detalhe-valor">
            <span style="display: inline-flex; align-items: center; gap: 5px; background: #e9ecef; color: #6c757d; padding: 4px 10px; border-radius: 15px; font-size: 0.9rem; font-weight: 600;">
                <i class="fas fa-clock"></i>
                Sem defasagem
            </span>
        </div>
    </div>
    `;

    content.innerHTML = `
    <div class="detalhes-grid">
        <!-- SE√á√ÉO: INFORMA√á√ïES PRINCIPAIS -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0f8ff; border-left: 4px solid #2EBE76;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #2EBE76;">
                <i class="fas fa-info-circle"></i> üìã INFORMA√á√ïES PRINCIPAIS
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üè¢ Raz√£o Social</span>
            <div class="detalhe-valor" style="font-weight: bold; color: #2EBE76;">${dados.razao_social || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üè∑Ô∏è Nome Fantasia</span>
            <div class="detalhe-valor">${dados.nome_fantasia || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üî¢ CNPJ</span>
            <div class="detalhe-valor" style="font-family: monospace;">${dados.cnpj || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üöö Fornecedor</span>
            <div class="detalhe-valor">${dados.fornecedor || 'N/A'}</div>
        </div>

        <!-- SE√á√ÉO: FINANCEIRO -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0fff0; border-left: 4px solid #28a745; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #28a745;">
                <i class="fas fa-chart-line"></i> üí∞ INFORMA√á√ïES FINANCEIRAS
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üíµ Mensalidade</span>
            <div class="detalhe-valor" style="color: var(--success); font-weight: 600;">${mensalidadeFormatada}</div>
        </div>

        <div class="detalhe-item">
            <span class="detalhe-label" style="color: var(--primary); font-weight: 700;">üíö Mensalidade SIM</span>
            <div class="detalhe-valor" style="color: var(--primary); font-weight: 600;">${mensalidadeSimFormatada}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">ü§ù Ades√£o</span>
            <div class="detalhe-valor" style="color: var(--info); font-weight: 600;">${adesaoFormatada}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üí∞ Tarifa</span>
            <div class="detalhe-valor">${dados.tarifa || 'N/A'} ${formatarPercentualParaExibicao(dados.percentual_tarifa)}</div>
        </div>

        <!-- SE√á√ÉO: CONTRATOS E DATAS -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #fff8f0; border-left: 4px solid #ff6b35; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #ff6b35;">
                <i class="fas fa-file-contract"></i> üìÑ CONTRATOS E DATAS
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üìÑ Contrato Enviado</span>
            <div class="detalhe-valor">${dados.contrato_enviado || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">‚úçÔ∏è Contrato Assinado</span>
            <div class="detalhe-valor">${dados.contrato_assinado || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üöÄ Data Ativa√ß√£o</span>
            <div class="detalhe-valor">${formatarDataAtivacao(dados.ativacao)}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üìÖ √öltima Etapa</span>
            <div class="detalhe-valor">${ultimaEtapaCorrigida}</div>
        </div>

        <!-- SE√á√ÉO: STATUS E ACOMPANHAMENTO -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0f0f8; border-left: 4px solid #6f42c1; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #6f42c1;">
                <i class="fas fa-tasks"></i> üìä STATUS E ACOMPANHAMENTO
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üéØ Situa√ß√£o</span>
            <div class="detalhe-valor">
                <span class="status-badge ${getSituacaoClass(dados.situacao)}">${dados.situacao || 'N/A'}</span>
            </div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üìÖ Etapa</span>
            <div class="detalhe-valor">${dados.etapa || 'N/A'}</div>
        </div>

        <!-- SE√á√ÉO: LINKS E OBSERVA√á√ïES -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0f0f0; border-left: 4px solid #6c757d; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #6c757d;">
                <i class="fas fa-sticky-note"></i> üîó LINKS E OBSERVA√á√ïES
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üîó Link</span>
            <div class="detalhe-valor">
                ${dados.link ? 
                    `<a href="${dados.link}" target="_blank" style="color: #007bff; text-decoration: none;">
                        <i class="fas fa-external-link-alt"></i> ${dados.link}
                    </a>` 
                    : 'N/A'
                }
            </div>
        </div>
        
        <div class="detalhe-item" style="grid-column: 1 / -1;">
            <span class="detalhe-label">üìù Observa√ß√µes</span>
            <div class="detalhe-valor" style="max-height: 100px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                ${dados.observacoes || 'Nenhuma observa√ß√£o registrada'}
            </div>
        </div>

        <!-- SE√á√ÉO: DEFASAGEM - AGORA CORRETA -->
        ${secaoDefasagem}
    </div>
    `;
    
    modal.style.display = 'flex';
}

function fecharModalDetalhes() {
  const modal = document.getElementById('modalDetalhes');
  modal.style.display = 'none';
}

// FUN√á√ïES AUXILIARES
function corrigirHoraFrontend(dataHoraString) {
    if (!dataHoraString || !dataHoraString.includes('/') || !dataHoraString.includes(':')) {
        return dataHoraString;
    }
    
    try {
        const [dataPart, horaPart] = dataHoraString.split(' ');
        const [dia, mes, ano] = dataPart.split('/');
        const [hora, minuto, segundo] = horaPart.split(':');
        
        const dataOriginal = new Date(
            parseInt(ano),
            parseInt(mes) - 1,
            parseInt(dia),
            parseInt(hora),
            parseInt(minuto), 
            parseInt(segundo)
        );
        
        const dataCorrigida = new Date(dataOriginal.getTime() - (4 * 60 * 60 * 1000));
        
        const diaCorrigido = String(dataCorrigida.getDate()).padStart(2, '0');
        const mesCorrigido = String(dataCorrigida.getMonth() + 1).padStart(2, '0');
        const anoCorrigido = dataCorrigida.getFullYear();
        const horaCorrigida = String(dataCorrigida.getHours()).padStart(2, '0');
        const minutoCorrigido = String(dataCorrigida.getMinutes()).padStart(2, '0');
        const segundoCorrigido = String(dataCorrigida.getSeconds()).padStart(2, '0');
        
        const resultado = `${diaCorrigido}/${mesCorrigido}/${anoCorrigido} ${horaCorrigida}:${minutoCorrigido}:${segundoCorrigido}`;
        
        return resultado;
        
    } catch (error) {
        return dataHoraString;
    }
}

function formatarDataAtivacao(data) {
    if (!data) return 'N/A';
    
    try {
        if (typeof data === 'string' && data.includes('/')) {
            const partes = data.split('/');
            if (partes.length === 3) {
                return `${partes[0]}/${partes[1]}/${partes[2]}`;
            }
            return data;
        }
        
        if (typeof data === 'string' && data.includes('-')) {
            const [ano, mes, dia] = data.split('-');
            return `${dia}/${mes}/${ano}`;
        }
        
        const dateObj = new Date(data);
        if (!isNaN(dateObj.getTime())) {
            const dia = String(dateObj.getDate()).padStart(2, '0');
            const mes = String(dateObj.getMonth() + 1).padStart(2, '0');
            const ano = dateObj.getFullYear();
            return `${dia}/${mes}/${ano}`;
        }
        
        return String(data);
    } catch (error) {
        return String(data || 'N/A');
    }
}

function calcularDefasagem(dataUltimaEtapa) {
    const dataCorrigida = corrigirHoraFrontend(dataUltimaEtapa);
    
    if (!dataCorrigida || dataCorrigida === 'N/A' || dataCorrigida === '' || dataCorrigida === 'Data inv√°lida') {
        return 'N/A';
    }
    
    try {
        let dataEtapa;
        
        if (dataCorrigida.includes('/') && dataCorrigida.includes(':')) {
            const [dataPart, horaPart] = dataCorrigida.split(' ');
            const [dia, mes, ano] = dataPart.split('/');
            const [hora, minuto, segundo] = horaPart.split(':');
            
            dataEtapa = new Date(
                parseInt(ano), 
                parseInt(mes) - 1,
                parseInt(dia),
                parseInt(hora), 
                parseInt(minuto), 
                parseInt(segundo)
            );
            
        } else {
            dataEtapa = new Date(dataCorrigida);
        }
        
        if (isNaN(dataEtapa.getTime())) {
            return 'Data inv√°lida';
        }
        
        const hoje = new Date();
        const hojeZerado = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
        const dataEtapaZerada = new Date(dataEtapa.getFullYear(), dataEtapa.getMonth(), dataEtapa.getDate());
        
        const diffTempo = hojeZerado.getTime() - dataEtapaZerada.getTime();
        const diffDias = Math.floor(diffTempo / (1000 * 3600 * 24));
        
        if (diffDias === 0) return 'Hoje';
        if (diffDias === 1) return '1 dia';
        if (diffDias > 1) return `${diffDias} dias`;
        if (diffDias < 0) return 'Futuro';
        
        return 'N/A';
        
    } catch (error) {
        return 'Erro no c√°lculo';
    }
}

function calcularDiasDefasagem(dataUltimaEtapa) {
  const defasagem = calcularDefasagem(dataUltimaEtapa);
  
  if (defasagem === 'N/A' || defasagem === 'Erro' || defasagem === 'Futuro' || defasagem === 'Data inv√°lida' || defasagem === 'Erro no c√°lculo') {
    return 9999;
  }
  if (defasagem === 'Hoje') return 0;
  if (defasagem === '1 dia') return 1;
  
  const match = defasagem.match(/(\d+)\s*dias?/);
  if (match && match[1]) {
    return parseInt(match[1]);
  }
  
  const dias = parseInt(defasagem);
  if (isNaN(dias)) return 9999;
  
  return dias;
}

function getDefasagemClass(defasagem) {
  if (defasagem === 'N/A' || defasagem === 'Erro') return 'defasagem-media';
  if (defasagem === 'Hoje') return 'defasagem-baixa';
  if (defasagem === '1 dia') return 'defasagem-baixa';
  
  const dias = parseInt(defasagem);
  if (isNaN(dias)) return 'defasagem-media';
  
  if (dias <= 3) return 'defasagem-baixa';
  if (dias <= 7) return 'defasagem-media';
  return 'defasagem-alta';
}

function getSituacaoClass(situacao) {
  if (!situacao) return 'situacao-cadastrado';
  
  const situacaoUpper = situacao.toUpperCase().trim();
  
  if (situacaoUpper.includes('NOVO REGISTRO')) return 'situacao-novo-registro';
  else if (situacaoUpper.includes('CADASTRADO')) return 'situacao-cadastrado';
  else if (situacaoUpper.includes('EM ANDAMENTO')) return 'situacao-andamento';
  else if (situacaoUpper.includes('REJEITADO')) return 'situacao-rejeitado';
  else if (situacaoUpper.includes('DESCREDENCIADO')) return 'situacao-descredenciado';
  else if (situacaoUpper.includes('DESISTIU')) return 'situacao-desistiu';
  else return 'situacao-cadastrado';
}

function getCorBordaSituacao(situacao) {
  const situacaoLower = situacao ? situacao.toLowerCase() : '';
  
  if (situacaoLower.includes('novo registro')) return '#bfe1f6';
  else if (situacaoLower.includes('cadastrado')) return '#D1E7DD';
  else if (situacaoLower.includes('em andamento')) return '#FFF3CD';
  else if (situacaoLower.includes('rejeitado')) return '#E2E3E5';
  else if (situacaoLower.includes('descredenciado')) return '#F8D7DA';
  else if (situacaoLower.includes('desistiu')) return '#e6cff2';
  else return 'var(--border)';
}

function formatarPercentualCorrigido(percentual) {
    if (!percentual && percentual !== 0) return 'N/A';
    
    try {
        const numero = typeof percentual === 'string' ? 
            parseFloat(percentual.replace(',', '.')) : percentual;
        
        if (isNaN(numero)) return String(percentual);
        
        let valorFormatado = numero;
        if (numero <= 1) {
            valorFormatado = numero * 100;
        }
        
        const valorString = valorFormatado.toFixed(2);
        return valorString.replace('.', ',') + '%';
        
    } catch (error) {
        return String(percentual);
    }
}

function formatarPercentualParaExibicao(percentual) {
    if (!percentual && percentual !== 0) return '';
    
    try {
        const numero = typeof percentual === 'string' ? 
            parseFloat(percentual.replace(',', '.')) : percentual;
        
        if (isNaN(numero)) return String(percentual || '');
        
        let valorFormatado = numero;
        if (numero <= 1) {
            valorFormatado = numero * 100;
        }
        
        const valorString = valorFormatado.toFixed(2);
        return valorString.replace('.', ',') + '%';
        
    } catch (error) {
        return String(percentual || '');
    }
}

function formatarMoedaParaInput(valor) {
  if (!valor) return 'R$ 0,00';
  const numero = typeof valor === 'number' ? valor : parseFloat(valor);
  return 'R$ ' + numero.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
}

function calcularDefasagemParaOrdenacao(lojasDoCNPJ) {
  if (!lojasDoCNPJ || lojasDoCNPJ.length === 0) {
    return 0;
  }
  
  const temLojaEmAndamento = lojasDoCNPJ.some(loja => 
    loja.situacao && loja.situacao.toUpperCase() === 'EM ANDAMENTO'
  );
  
  if (!temLojaEmAndamento) {
    return 0;
  }
  
  const defasagemInfo = calcularDefasagemPorCNPJ(lojasDoCNPJ);
  
  return defasagemInfo.dias < 9999 ? defasagemInfo.dias : 0;
}

function recarregarCadastros() {
  console.log("üîÑ Recarregando cadastros mantendo filtros...");
  showLoadingPopup('Atualizando Dados', 'Recarregando informa√ß√µes...');
  showLoading();
  
  // SALVAR FILTROS ATUAIS ANTES DE RECARREGAR
  const filtrosSalvos = {
    situacaoAtiva: situacaoAtiva,
    filtrosAtivos: {...filtrosAtivos},
    etapasSelecionados: [...etapasSelecionados],
    fornecedoresSelecionados: [...fornecedoresSelecionados],
    pesquisa: document.getElementById('pesquisaCadastros').value,
    ordenacao: document.getElementById('ordenacaoCadastros').value
  };
  
  localStorage.setItem('filtrosSalvos', JSON.stringify(filtrosSalvos));
  
  google.script.run
    .withSuccessHandler(function(cadastros) {
      hideLoading();
      hideLoadingPopup();
      
      if (cadastros && cadastros.length > 0) {
        // ORDENAR POR RAZ√ÉO SOCIAL (A-Z) AO CARREGAR
        const cadastrosOrdenados = cadastros.sort((a, b) => {
          const nomeA = (a.razao_social || '').toLowerCase();
          const nomeB = (b.razao_social || '').toLowerCase();
          return nomeA.localeCompare(nomeB);
        });
        
        todosCadastros = cadastrosOrdenados;
        cadastrosFiltrados = [...cadastrosOrdenados];
        
        // RESTAURAR FILTROS AP√ìS CARREGAR
        setTimeout(() => {
          restaurarFiltros(filtrosSalvos);
        }, 100);
        
        showMessage('success', `‚úÖ Dados atualizados! ${cadastros.length} cadastros carregados.`);
      } else {
        showMessage('info', 'üìù Nenhum cadastro encontrado ap√≥s atualiza√ß√£o.');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      hideLoadingPopup();
      console.error("‚ùå Erro ao recarregar:", error);
      showMessage('error', '‚ùå Erro ao atualizar: ' + error.message);
      
      // TENTAR RESTAURAR FILTROS MESMO COM ERRO
      try {
        restaurarFiltros(filtrosSalvos);
      } catch (e) {
        console.error("Erro ao restaurar filtros:", e);
      }
    })
    .buscarTodosCadastrosComWaitlabel(waitlabelAtual);
}

function atualizarContador() {
  const contador = document.getElementById('contadorCadastros');
  const cadastrosVisiveis = cadastrosFiltrados.length;
  const totalCadastros = todosCadastros.length;
  
  if (cadastrosVisiveis === totalCadastros) {
    contador.textContent = `${totalCadastros} cadastro${totalCadastros !== 1 ? 's' : ''}`;
  } else {
    contador.textContent = `${cadastrosVisiveis} de ${totalCadastros} cadastros`;
  }
}

function showLoading() {
  document.getElementById('loadingCadastros').style.display = 'flex';
  document.getElementById('tableContainer').style.display = 'none';
}

function hideLoading() {
  document.getElementById('loadingCadastros').style.display = 'none';
}

function showMessage(type, text) {
  const successEl = document.getElementById('messageSuccess');
  const errorEl = document.getElementById('messageError');
  const infoEl = document.getElementById('messageInfo');

  successEl.style.display = 'none';
  errorEl.style.display = 'none';
  infoEl.style.display = 'none';

  if (type === 'success') {
    successEl.querySelector('span').textContent = text;
    successEl.style.display = 'flex';
  } else if (type === 'error') {
    errorEl.querySelector('span').textContent = text;
    errorEl.style.display = 'flex';
  } else if (type === 'info') {
    infoEl.querySelector('span').textContent = text;
    infoEl.style.display = 'flex';
  }

  setTimeout(() => {
    successEl.style.display = 'none';
    errorEl.style.display = 'none';
    infoEl.style.display = 'none';
  }, 5000);
}

// FECHAR MODAIS COM ESC E CLIQUE FORA
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    fecharModalDetalhes();
    fecharModalFornecedores();
  }
});

document.getElementById('modalDetalhes').addEventListener('click', function(e) {
  if (e.target === this) {
    fecharModalDetalhes();
  }
});

document.getElementById('modalFornecedores').addEventListener('click', function(e) {
  if (e.target === this) {
    fecharModalFornecedores();
  }
});
  </script>
</body>
</html>
