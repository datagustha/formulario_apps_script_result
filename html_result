<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Cadastros - VISUALIZA√á√ÉO</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    
    :root {
      --primary: #2EBE76;
      --secondary: #A1CC4C;
      --accent: #FF6B35;
      --dark: #2D3047;
      --light: #FFFFFF;
      --success: #28A745;
      --warning: #FFC107;
      --danger: #DC3545;
      --info: #17A2B8;
      --gray: #6C757D;
      --border: #E0E0E0;
      --background: #F8F9FA;
    }
    
    body {
      background: var(--background);
      min-height: 100vh;
      padding: 20px;
      color: var(--dark);
    }
    
    .container {
      max-width: 1800px;
      margin: 0 auto;
      background: var(--light);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .header {
      background: var(--primary);
      padding: 25px 40px;
      color: white;
      text-align: center;
    }

    .logo-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
    }
    
    .logo {
      width: 80px;
      height: 80px;
      background: white;
      padding: 10px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      object-fit: contain;
    }
    
    h1 {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .content {
      padding: 30px;
    }

    .card {
      background: var(--light);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--border);
    }
    
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid var(--primary);
    }
    
    .card-header i {
      color: var(--primary);
      font-size: 1.8rem;
    }
    
    .card-title {
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--primary);
    }

    /* üî• FILTROS COM ESTILO WHITELABEL */
    .filtros-container {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .filtro-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border: 2px solid var(--border);
      border-radius: 25px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
      color: var(--dark);
      position: relative;
    }

    .filtro-btn.active {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      border-width: 3px;
    }

    .filtro-btn::before {
      content: '';
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
    }

    .filtro-btn[data-situacao="all"]::before { background: var(--primary); }
    .filtro-btn[data-situacao="NOVO REGISTRO"]::before { background: #bfe1f6; }
    .filtro-btn[data-situacao="CADASTRADO"]::before { background: var(--success); }
    .filtro-btn[data-situacao="EM ANDAMENTO"]::before { background: var(--warning); }
    .filtro-btn[data-situacao="REJEITADO"]::before { background: var(--gray); }
    .filtro-btn[data-situacao="DESCREDENCIADO"]::before { background: var(--danger); }
    .filtro-btn[data-situacao="DESISTIU"]::before { background: #e6cff2; }

    .filtro-btn.active[data-situacao="all"] { 
      background: var(--primary); 
      color: white; 
      border-color: var(--primary); 
    }
    .filtro-btn.active[data-situacao="NOVO REGISTRO"] { 
      background: #bfe1f6; 
      color: #0c5aa3; 
      border-color: #bfe1f6; 
    }
    .filtro-btn.active[data-situacao="CADASTRADO"] { 
      background: var(--success); 
      color: white; 
      border-color: var(--success); 
    }
    .filtro-btn.active[data-situacao="EM ANDAMENTO"] { 
      background: var(--warning); 
      color: var(--dark); 
      border-color: var(--warning); 
    }
    .filtro-btn.active[data-situacao="REJEITADO"] { 
      background: var(--gray); 
      color: white; 
      border-color: var(--gray); 
    }
    .filtro-btn.active[data-situacao="DESCREDENCIADO"] { 
      background: var(--danger); 
      color: white; 
      border-color: var(--danger); 
    }
    .filtro-btn.active[data-situacao="DESISTIU"] { 
      background: #e6cff2; 
      color: #4a1e6b; 
      border-color: #e6cff2; 
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-warning {
      background: var(--warning);
      color: var(--dark);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-info {
      background: var(--info);
      color: white;
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-sm {
      padding: 8px 16px;
      font-size: 0.85rem;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* üî• PESQUISA E FILTROS AVAN√áADOS */
    .search-container {
      margin: 20px 0;
    }

    .filtros-avancados {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .filtro-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filtro-label {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.9rem;
    }

    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
      background: white;
      cursor: pointer;
    }

    .contador-lojas {
      background: var(--primary);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    /* üî• TAGS DE FILTROS ATIVOS */
    .filtros-ativos {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 10px 0;
    }

    .filtro-chip {
      background: var(--primary);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filtro-chip .remover {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 0;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    /* üî• FILTRO DE EVENTOS E FORNECEDORES COM TAGS */
    .filtro-multiselect-container {
      position: relative;
    }

    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid var(--primary);
      border-top: none;
      border-radius: 0 0 8px 8px;
      z-index: 1000;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      display: none;
    }

    .suggestion-item {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .suggestion-item:hover {
      background: var(--primary);
      color: white;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .tags-selecionadas {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .tag {
      background: var(--info);
      color: white;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tag.fornecedor {
      background: var(--secondary);
    }

    .tag .remover {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 0;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
    }

    .tag .remover:hover {
      background: rgba(255,255,255,0.3);
    }

    /* üî• TABELA MAIOR */
    .table-container {
      margin-top: 20px;
      overflow: hidden;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .table-responsive {
      overflow-x: auto;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      font-size: 0.85rem;
    }
    
    .data-table th {
      background: var(--primary);
      color: white;
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      white-space: nowrap;
    }
    
    .data-table td {
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
      word-wrap: break-word;
      vertical-align: top;
    }
    
    .data-table tbody tr {
      transition: all 0.3s ease;
    }
    
    .data-table tbody tr:hover {
      background: #f8f9fa;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-visualizar-compact {
      padding: 6px 10px !important;
      font-size: 0.75rem !important;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    /* üî• STATUS BADGES */
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      text-align: center;
      display: inline-block;
      min-width: 70px;
    }
    
    .situacao-novo-registro {
      background-color: #bfe1f6 !important;
      color: #0c5aa3 !important;
      border: 1px solid #8bc9f0 !important;
    }
    
    .situacao-cadastrado {
      background: #D1E7DD;
      color: #0F5132;
    }

    .situacao-andamento {
      background: #FFF3CD;
      color: #856404;
    }
    
    .situacao-rejeitado {
      background: #E2E3E5;
      color: #383D41;
    }
    
    .situacao-descredenciado {
      background: #F8D7DA;
      color: #721C24;
    }

    .situacao-desistiu {
      background: #e6cff2 !important;
      color: #4a1e6b !important;
      border: 1px solid #d4b5e6 !important;
    }

    .defasagem-badge {
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 600;
      min-width: 70px;
      display: inline-block;
      text-align: center;
    }

    .defasagem-alta {
      background: #f8d7da;
      color: #721c24;
    }

    .defasagem-media {
      background: #fff3cd;
      color: #856404;
    }

    .defasagem-baixa {
      background: #d1e7dd;
      color: #0f5132;
    }

    /* üî• LOADING */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* üî• MENSAGENS */
    .message {
      padding: 15px 20px;
      border-radius: 8px;
      margin: 15px 0;
      display: none;
      align-items: center;
      gap: 10px;
    }
    
    .success {
      background: #d4edda;
      color: var(--success);
      border: 1px solid #c3e6cb;
    }
    
    .error {
      background: #f8d7da;
      color: var(--danger);
      border: 1px solid #f5c6cb;
    }
    
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    /* üî• MODAL */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      max-width: 900px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      border: 3px solid var(--primary);
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--primary);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
    }

    .btn-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray);
      padding: 5px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .btn-close:hover {
      background: var(--danger);
      color: white;
    }

    .detalhes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .detalhe-item {
      margin-bottom: 12px;
    }

    .detalhe-label {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 5px;
      display: block;
    }

    .detalhe-valor {
      color: var(--dark);
      background: #f8f9fa;
      padding: 8px 12px;
      border-radius: 8px;
      border-left: 3px solid var(--primary);
    }

    /* üî• ESTILOS PARA LOJAS AGRUPADAS */
    .loja-item {
      border: 3px solid;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    @media (max-width: 1200px) {
      .data-table {
        font-size: 0.8rem;
      }
      
      .data-table th,
      .data-table td {
        padding: 8px 6px;
      }
    }

    @media (max-width: 768px) {
      .content {
        padding: 20px;
      }
      
      .filtros-container {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filtros-avancados {
        grid-template-columns: 1fr;
      }
      
      .btn {
        justify-content: center;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .contador-lojas {
        align-self: flex-start;
      }
    }

    /* üî• ADICIONE AQUI O CSS DA PARCERIA */
.logo-wrapper {
  display: flex;
  align-items: center;
  gap: 15px;
}

.logo-result-wrapper {
  background: white;
  padding: 10px;
  border-radius: 15px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  width: 80px;
  height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.logo-result {
  width: 70px;
  height: 70px;
  object-fit: contain;
}

  </style>
</head>
<body>
  <div class="container">
  <div class="header">
    <div class="logo-container">
      <div class="logo-wrapper">
        <img src="https://i.ibb.co/B2r5xtbS/sim-cred-5.png" class="logo" alt="SIM CRED">
        <div class="logo-result-wrapper">
          <img src="https://i.ibb.co/PvznTM8v/1739824422909-Result-Pay-Powered-by-Sim-2-removebg-preview.png" class="logo-result" alt="Result Pay">
        </div>
      </div>
      <div class="header-content">
        <h1>Cadastros de Lojas</h1>
        <div class="subtitle">Visualiza√ß√£o de Dados - Somente Leitura</div>
      </div>
    </div>
  </div>
    
    <div class="content">
      <!-- CARD PRINCIPAL COM TABELA -->
      <div class="card">
        <div class="card-header">
          <i class="fas fa-store"></i>
          <h2 class="card-title" id="tituloCadastros">Todos os Cadastros</h2>
          <span class="contador-lojas" id="contadorCadastros">0 cadastros</span>
        </div>

        <!-- BARRA DE PESQUISA PRINCIPAL -->
        <div class="search-container">
          <input type="text" id="pesquisaCadastros" class="form-control" 
                 placeholder="üîç Pesquisar por nome, CNPJ, fornecedor, evento..."
                 oninput="filtrarPesquisa()">
        </div>

        <!-- FILTROS R√ÅPIDOS POR SITUA√á√ÉO - NOVO ESTILO -->
        <div class="filtros-container" id="filtrosContainer">
          <button type="button" class="filtro-btn active" data-situacao="all" onclick="aplicarFiltroSituacao('all')">
            Todos
          </button>
          <button type="button" class="filtro-btn" data-situacao="NOVO REGISTRO" onclick="aplicarFiltroSituacao('NOVO REGISTRO')">
            Novos
          </button>
          <button type="button" class="filtro-btn" data-situacao="CADASTRADO" onclick="aplicarFiltroSituacao('CADASTRADO')">
            Cadastrados
          </button>
          <button type="button" class="filtro-btn" data-situacao="EM ANDAMENTO" onclick="aplicarFiltroSituacao('EM ANDAMENTO')">
            Em Andamento
          </button>
          <button type="button" class="filtro-btn" data-situacao="REJEITADO" onclick="aplicarFiltroSituacao('REJEITADO')">
            Rejeitado
          </button>
          <button type="button" class="filtro-btn" data-situacao="DESCREDENCIADO" onclick="aplicarFiltroSituacao('DESCREDENCIADO')">
            Descredenciados
          </button>
          <button type="button" class="filtro-btn" data-situacao="DESISTIU" onclick="aplicarFiltroSituacao('DESISTIU')">
            Desistiu
          </button>
          
          <!-- BOT√ÉO ATUALIZAR -->
          <button type="button" class="btn btn-info btn-sm" onclick="carregarCadastros()" style="margin-left: auto;">
            <i class="fas fa-sync-alt"></i> Atualizar
          </button>
        </div>

        <!-- FILTROS AVAN√áADOS -->
        <div class="filtros-avancados">
          <!-- üî• NOVO: FILTRO DE EVENTOS COM TAGS -->
          <div class="filtro-group">
            <label class="filtro-label">üìÖ Filtrar por Evento:</label>
            <div class="filtro-multiselect-container">
              <input type="text" id="filtroEvento" class="form-control" 
                     placeholder="Digite para buscar eventos..." 
                     oninput="filtrarSugestoesEvento()"
                     onfocus="mostrarSugestoesEvento()">
              <div class="suggestions" id="suggestionsEvento"></div>
              <div class="tags-selecionadas" id="eventosSelecionados"></div>
            </div>
          </div>
          
          <!-- üî• NOVO: FILTRO DE FORNECEDORES COM TAGS -->
          <div class="filtro-group">
            <label class="filtro-label">üöö Filtrar por Fornecedor:</label>
            <div class="filtro-multiselect-container">
              <input type="text" id="filtroFornecedor" class="form-control" 
                     placeholder="Digite para buscar fornecedores..." 
                     oninput="filtrarSugestoesFornecedor()"
                     onfocus="mostrarSugestoesFornecedor()">
              <div class="suggestions" id="suggestionsFornecedor"></div>
              <div class="tags-selecionadas" id="fornecedoresSelecionados"></div>
            </div>
          </div>
          
          <div class="filtro-group">
            <label class="filtro-label">üìä Ordenar por:</label>
            <select id="ordenacao" class="form-select" onchange="ordenarCadastros()">
              <option value="razao_social">Raz√£o Social (A-Z)</option>
              <option value="razao_social_desc">Raz√£o Social (Z-A)</option>
              <option value="nome_fantasia">Nome Fantasia (A-Z)</option>
              <option value="nome_fantasia_desc">Nome Fantasia (Z-A)</option>
              <option value="situacao">Situa√ß√£o</option>
              <option value="fornecedor">Fornecedor</option>
              <option value="mensalidade">Mensalidade (Maior)</option>
              <option value="mensalidade_asc">Mensalidade (Menor)</option>
              <option value="adesao">Ades√£o (Maior)</option>
              <option value="adesao_asc">Ades√£o (Menor)</option>
              <option value="defasagem">Defasagem (Maior)</option>
              <option value="defasagem_asc">Defasagem (Menor)</option>
            </select>
          </div>

          <div class="filtro-group">
            <label class="filtro-label">üßπ Limpar Filtros:</label>
            <button type="button" class="btn btn-outline btn-sm" onclick="limparTodosFiltros()" style="margin-top: 8px;">
              <i class="fas fa-broom"></i> Limpar Tudo
            </button>
          </div>
        </div>

        <!-- TAGS DE FILTROS ATIVOS (ESCONDIDO) -->
        <div class="filtros-ativos" id="filtrosAtivosContainer" style="display: none;"></div>

        <!-- LOADING -->
        <div class="loading-container" id="loadingCadastros">
          <div class="loading-spinner"></div>
          <p>Carregando cadastros...</p>
        </div>
        
        <!-- TABELA MAIOR COM MAIS INFORMA√á√ïES -->
        <div class="table-container" id="tableContainer" style="display: none;">
          <div class="table-responsive">
            <table class="data-table" id="tabelaCadastros">
              <thead>
                <tr>
                  <th width="18%">Raz√£o Social</th>
                  <th width="12%">CNPJ</th>
                  <th width="12%">Fornecedor</th>
                  <th width="10%">Situa√ß√£o</th>
                  <th width="14%">√öltimo Evento</th>
                  <th width="8%">Defasagem</th>
                  <th width="10%">Mensalidade</th>
                  <th width="8%">Ades√£o</th>
                  <th width="8%">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tabelaCadastrosBody">
                <!-- Dados ser√£o preenchidos via JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- MENSAGENS DO SISTEMA -->
      <div id="messageSuccess" class="message success" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <span></span>
      </div>
      
      <div id="messageError" class="message error" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span></span>
      </div>

      <div id="messageInfo" class="message info" style="display: none;">
        <i class="fas fa-info-circle"></i>
        <span></span>
      </div>
    </div>
  </div>

  <!-- MODAL 1: VISUALIZAR TODOS OS FORNECEDORES -->
  <div id="modalFornecedores" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">üè™ Todos os Fornecedores</h3>
        <button class="btn-close" onclick="fecharModalFornecedores()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div id="modalFornecedoresContent">
        <!-- Conte√∫do ser√° preenchido via JavaScript -->
      </div>

      <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border);">
        <button class="btn btn-primary" onclick="fecharModalFornecedores()">
          <i class="fas fa-check"></i> Fechar
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL 2: DETALHES COMPLETOS -->
  <div id="modalDetalhes" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">üìã Detalhes do Cadastro</h3>
        <button class="btn-close" onclick="fecharModalDetalhes()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div id="modalDetalhesContent">
        <!-- Conte√∫do ser√° preenchido via JavaScript -->
      </div>

      <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border);">
        <button class="btn btn-primary" onclick="fecharModalDetalhes()">
          <i class="fas fa-check"></i> Fechar
        </button>
      </div>
    </div>
  </div>

  <script>
// üî• VARI√ÅVEIS GLOBAIS
let todosCadastros = [];
let cadastrosFiltrados = [];
let filtrosAtivos = {};
let situacaoAtiva = 'all';
let eventosSelecionados = [];
let fornecedoresSelecionados = [];
const waitlabelAtual = 'Result';

// üî• EVENTOS PARA FILTRO - CORRIGIDO (SEM DUPLICADOS)
const eventosDisponiveis = [
  "NOVO CADASTRO", "PRIMEIRO CONTATO", "CLIENTE INTERESSADO", "SOLICITOU MAIS INFORMACOES",
  "AGENDAMENTO DE DEMONSTRACAO", "PROPOSTA ENVIADA", "AGUARDANDO RETORNO", "LOJA CADASTRADA",
  "DOCUMENTACAO RECEBIDA", "CONTRATO ENVIADO", "AGUARDANDO ASSINATURA", "CADASTRO APROVADO",
  "AGUARDANDO ATIVACAO", "AGUARDANDO ACEITE DA LOJA", "AGUARDANDO ACEITE DO FORNECEDOR",
  "AGUARDANDO DOCUMENTOS", "CLIENTE NAO INTERESSADO", "CONDICAO ESPECIAL", "CONTRATO ASSINADO",
  "DESISTIU", "DOCUMENTACAO INCOMPLETA", "EM IMPLANTACAO", "EM TREINAMENTO", "ENVIO DE BOLETO",
  "ENVIO DE WHATSAPP", "FOLLOW-UP NECESSARIO", "FORNECEDOR ALTERADO", "LIGACAO REALIZADA",
  "NEGOCIACAO EM ANDAMENTO", "PAGAMENTO EFETUADO", "PAGAMENTO PENDENTE", "QUANTIDADE DE LOJAS ALTERADA",
  "RECADO REGISTRADO", "REUNIAO AGENDADA", "SEM RETORNO", "REJEITADO", "BLOQUEADO", "DESCREDENCIADO",
  "CONTRATO CANCELADO", "LOJA DESATIVADA", "FORNECEDOR REMOVIDO", "PROCESSO ENCERRADO", "CADASTRO EXPIRADO"
].sort();

// üî• FORNECEDORES DISPON√çVEIS
const fornecedoresDisponiveis = [
  "AGIL", "BC", "PARCELEX", "AGORACRED", "AFINZ"
].sort();

// üî• INICIALIZA√á√ÉO
document.addEventListener('DOMContentLoaded', function() {
  console.log('Sistema de Visualiza√ß√£o - Carregando dados...');
  carregarCadastros();
  configurarEventosFiltro();
});

// üî• CONFIGURAR EVENTOS DOS FILTROS
function configurarEventosFiltro() {
  const inputEvento = document.getElementById('filtroEvento');
  const inputFornecedor = document.getElementById('filtroFornecedor');
  
  // Fechar sugest√µes ao clicar fora
  document.addEventListener('click', function(e) {
    const suggestionsEvento = document.getElementById('suggestionsEvento');
    const suggestionsFornecedor = document.getElementById('suggestionsFornecedor');
    
    if (suggestionsEvento && !inputEvento.contains(e.target) && !suggestionsEvento.contains(e.target)) {
      suggestionsEvento.style.display = 'none';
    }
    
    if (suggestionsFornecedor && !inputFornecedor.contains(e.target) && !suggestionsFornecedor.contains(e.target)) {
      suggestionsFornecedor.style.display = 'none';
    }
  });
  
  // Fechar sugest√µes com ESC
  inputEvento.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.getElementById('suggestionsEvento').style.display = 'none';
    }
    if (e.key === 'Enter') {
      e.preventDefault();
      const texto = inputEvento.value.trim();
      if (texto && !eventosSelecionados.includes(texto.toUpperCase())) {
        adicionarEvento(texto.toUpperCase());
      }
      inputEvento.value = '';
      document.getElementById('suggestionsEvento').style.display = 'none';
    }
  });
  
  inputFornecedor.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.getElementById('suggestionsFornecedor').style.display = 'none';
    }
    if (e.key === 'Enter') {
      e.preventDefault();
      const texto = inputFornecedor.value.trim();
      if (texto && !fornecedoresSelecionados.includes(texto.toUpperCase())) {
        adicionarFornecedor(texto.toUpperCase());
      }
      inputFornecedor.value = '';
      document.getElementById('suggestionsFornecedor').style.display = 'none';
    }
  });
}

// üî• FUN√á√ïES DO FILTRO DE EVENTOS
function mostrarSugestoesEvento() {
  const input = document.getElementById('filtroEvento');
  if (input.value.trim().length > 0) {
    filtrarSugestoesEvento();
  }
}

function filtrarSugestoesEvento() {
  const input = document.getElementById('filtroEvento');
  const suggestions = document.getElementById('suggestionsEvento');
  const termo = input.value.toLowerCase().trim();
  
  if (termo.length < 1) {
    suggestions.style.display = 'none';
    return;
  }
  
  // üî• CORRE√á√ÉO: Remover duplicatas usando Set
  const eventosUnicos = [...new Set(eventosDisponiveis)];
  const eventosFiltrados = eventosUnicos.filter(evento => 
    evento.toLowerCase().includes(termo) && !eventosSelecionados.includes(evento)
  );
  
  if (eventosFiltrados.length === 0) {
    suggestions.innerHTML = `
      <div class="suggestion-item" style="color: var(--gray);">
        <i class="fas fa-search"></i> Nenhum evento encontrado
      </div>
    `;
  } else {
    let html = eventosFiltrados.map(evento => `
      <div class="suggestion-item" onclick="adicionarEvento('${evento}')">
        <i class="fas fa-calendar-check"></i> ${evento}
      </div>
    `).join('');
    
    suggestions.innerHTML = html;
  }
  
  suggestions.style.display = 'block';
}

function adicionarEvento(evento) {
  if (!eventosSelecionados.includes(evento)) {
    eventosSelecionados.push(evento);
    atualizarEventosSelecionados();
    aplicarFiltroEventos();
  }
  
  document.getElementById('filtroEvento').value = '';
  document.getElementById('suggestionsEvento').style.display = 'none';
}

function removerEvento(evento) {
  eventosSelecionados = eventosSelecionados.filter(e => e !== evento);
  atualizarEventosSelecionados();
  aplicarFiltroEventos();
}

function atualizarEventosSelecionados() {
  const container = document.getElementById('eventosSelecionados');
  
  if (eventosSelecionados.length === 0) {
    container.innerHTML = '';
    container.style.display = 'none';
    return;
  }
  
  container.style.display = 'flex';
  container.innerHTML = eventosSelecionados.map(evento => `
    <div class="tag">
      <i class="fas fa-calendar"></i> ${evento}
      <button class="remover" onclick="removerEvento('${evento}')">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `).join('');
}

function aplicarFiltroEventos() {
  if (eventosSelecionados.length > 0) {
    filtrosAtivos.eventos = eventosSelecionados;
  } else {
    delete filtrosAtivos.eventos;
  }
  aplicarTodosFiltros();
}

// üî• FUN√á√ïES DO FILTRO DE FORNECEDORES
function mostrarSugestoesFornecedor() {
  const input = document.getElementById('filtroFornecedor');
  if (input.value.trim().length > 0) {
    filtrarSugestoesFornecedor();
  }
}

function filtrarSugestoesFornecedor() {
  const input = document.getElementById('filtroFornecedor');
  const suggestions = document.getElementById('suggestionsFornecedor');
  const termo = input.value.toLowerCase().trim();
  
  if (termo.length < 1) {
    suggestions.style.display = 'none';
    return;
  }
  
  const fornecedoresFiltrados = fornecedoresDisponiveis.filter(fornecedor => 
    fornecedor.toLowerCase().includes(termo) && !fornecedoresSelecionados.includes(fornecedor)
  );
  
  if (fornecedoresFiltrados.length === 0) {
    suggestions.innerHTML = `
      <div class="suggestion-item" style="color: var(--gray);">
        <i class="fas fa-search"></i> Nenhum fornecedor encontrado
      </div>
    `;
  } else {
    let html = fornecedoresFiltrados.map(fornecedor => `
      <div class="suggestion-item" onclick="adicionarFornecedor('${fornecedor}')">
        <i class="fas fa-truck"></i> ${fornecedor}
      </div>
    `).join('');
    
    suggestions.innerHTML = html;
  }
  
  suggestions.style.display = 'block';
}

function adicionarFornecedor(fornecedor) {
  if (!fornecedoresSelecionados.includes(fornecedor)) {
    fornecedoresSelecionados.push(fornecedor);
    atualizarFornecedoresSelecionados();
    aplicarFiltroFornecedores();
  }
  
  document.getElementById('filtroFornecedor').value = '';
  document.getElementById('suggestionsFornecedor').style.display = 'none';
}

function removerFornecedor(fornecedor) {
  fornecedoresSelecionados = fornecedoresSelecionados.filter(f => f !== fornecedor);
  atualizarFornecedoresSelecionados();
  aplicarFiltroFornecedores();
}

function atualizarFornecedoresSelecionados() {
  const container = document.getElementById('fornecedoresSelecionados');
  
  if (fornecedoresSelecionados.length === 0) {
    container.innerHTML = '';
    container.style.display = 'none';
    return;
  }
  
  container.style.display = 'flex';
  container.innerHTML = fornecedoresSelecionados.map(fornecedor => `
    <div class="tag fornecedor">
      <i class="fas fa-truck"></i> ${fornecedor}
      <button class="remover" onclick="removerFornecedor('${fornecedor}')">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `).join('');
}

function aplicarFiltroFornecedores() {
  if (fornecedoresSelecionados.length > 0) {
    filtrosAtivos.fornecedores = fornecedoresSelecionados;
  } else {
    delete filtrosAtivos.fornecedores;
  }
  aplicarTodosFiltros();
}

// üî• CARREGAR CADASTROS
function carregarCadastros() {
  console.log("üéØ Carregando cadastros...");
  
  showLoading();
  document.getElementById('filtrosContainer').style.display = 'none';
  document.getElementById('tableContainer').style.display = 'none';
  limparTodosFiltros();

  google.script.run
    .withSuccessHandler(function(cadastros) {
      hideLoading();
      
      console.log("‚úÖ Cadastros recebidos:", cadastros);
      
      if (cadastros && cadastros.length > 0) {
        const cadastrosOrdenados = cadastros.sort((a, b) => {
          const nomeA = (a.razao_social || '').toLowerCase();
          const nomeB = (b.razao_social || '').toLowerCase();
          return nomeA.localeCompare(nomeB);
        });
        
        todosCadastros = cadastrosOrdenados;
        cadastrosFiltrados = [...cadastrosOrdenados];
        
        exibirTabelaCadastros();
        
        document.getElementById('filtrosContainer').style.display = 'flex';
        
        showMessage('success', `‚úÖ ${cadastros.length} cadastros carregados!`);
      } else {
        document.getElementById('tabelaCadastrosBody').innerHTML = `
          <tr>
            <td colspan="9" style="text-align: center; padding: 40px;">
              <i class="fas fa-inbox" style="font-size: 3rem; color: var(--gray); margin-bottom: 15px;"></i>
              <h3>Nenhum cadastro encontrado</h3>
              <p>N√£o h√° cadastros no sistema.</p>
            </td>
          </tr>
        `;
        document.getElementById('tableContainer').style.display = 'block';
        showMessage('info', 'üìù Nenhum cadastro encontrado.');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      console.error("‚ùå Erro ao carregar cadastros:", error);
      showMessage('error', '‚ùå Erro ao carregar cadastros: ' + error.message);
    })
    .buscarTodosCadastrosComWaitlabel(waitlabelAtual);
}

// üî• EXIBIR TABELA AGRUPADA
function exibirTabelaCadastros() {
  const tabelaBody = document.getElementById('tabelaCadastrosBody');
  const loading = document.getElementById('loadingCadastros');
  const tableContainer = document.getElementById('tableContainer');

  tabelaBody.innerHTML = '';

  if (cadastrosFiltrados.length === 0) {
    tabelaBody.innerHTML = `
      <tr>
        <td colspan="9" style="text-align: center; padding: 40px;">
          <i class="fas fa-search" style="font-size: 3rem; color: var(--gray); margin-bottom: 15px;"></i>
          <h3>Nenhum resultado encontrado</h3>
          <p>Tente alterar os filtros de pesquisa.</p>
        </td>
      </tr>
    `;
  } else {
    const cadastrosAgrupados = agruparCadastrosPorCNPJ(cadastrosFiltrados);
    cadastrosAgrupados.forEach(grupo => {
      const row = criarLinhaTabelaAgrupada(grupo);
      tabelaBody.appendChild(row);
    });
  }

  loading.style.display = 'none';
  tableContainer.style.display = 'block';
  atualizarContador();
}

// üî• AGRUPAR CADASTROS POR CNPJ
function agruparCadastrosPorCNPJ(cadastros) {
  const agrupados = {};
  
  cadastros.forEach(cadastro => {
    if (!agrupados[cadastro.cnpj]) {
      agrupados[cadastro.cnpj] = {
        razao_social: cadastro.razao_social,
        nome_fantasia: cadastro.nome_fantasia,
        cnpj: cadastro.cnpj,
        lojas: []
      };
    }
    
    agrupados[cadastro.cnpj].lojas.push(cadastro);
  });
  
  return Object.values(agrupados);
}

// üî• CORRE√á√ÉO DA FUN√á√ÉO criarLinhaTabelaAgrupada - COMPLETA E FUNCIONAL
function criarLinhaTabelaAgrupada(grupo) {
  const row = document.createElement('tr');
  
  const situacoes = grupo.lojas.map(l => l.situacao);
  const situacaoPrincipal = situacoes.includes('DESCREDENCIADO') ? 'DESCREDENCIADO' :
                           situacoes.includes('REJEITADO') ? 'REJEITADO' :
                           situacoes.includes('EM ANDAMENTO') ? 'EM ANDAMENTO' :
                           situacoes.includes('NOVO REGISTRO') ? 'NOVO REGISTRO' :
                           situacoes.includes('DESISTIU') ? 'DESISTIU' :
                           'CADASTRADO';

  // üî• CORRE√á√ÉO: ENCONTRAR O FORNECEDOR MAIS ATRASADO
  const fornecedorMaisAntigo = encontrarFornecedorMaisAntigo(grupo.lojas);
  
  console.log("üîç FORNECEDOR MAIS ANTIGO ENCONTRADO:", fornecedorMaisAntigo);

  // üî• CORRE√á√ÉO DEFINITIVA: APLICAR CORRE√á√ÉO DE HORAS
  const dataHoraMaisAntiga = fornecedorMaisAntigo.data || 'N/A';
  const dataHoraCorrigida = dataHoraMaisAntiga !== 'N/A' ? 
      corrigirHoraFrontend(dataHoraMaisAntiga) : 'N/A';

  const eventoMaisAntigo = fornecedorMaisAntigo.evento || 'N/A';
  const nomeFornecedorAntigo = fornecedorMaisAntigo.fornecedor || 'N/A';

  // üî• CALCULAR DEFASAGEM (USA O MESMO FORNECEDOR MAIS ATRASADO)
  const defasagemInfo = calcularDefasagemPorCNPJ(grupo.lojas);
  
  const defasagemTexto = defasagemInfo.dias === 0 ? 'Hoje' : 
                        defasagemInfo.dias === 1 ? '1 dia' : 
                        defasagemInfo.dias > 1 && defasagemInfo.dias < 9999 ? `${defasagemInfo.dias} dias` : 'N/A';
  const defasagemClass = getDefasagemClass(defasagemTexto);

  // üî• AGORA MOSTRA DATA E HORA CORRIGIDA
  let ultimoEventoInfo = '';
  if (dataHoraCorrigida !== 'N/A') {
    const [dataPart, horaPart] = dataHoraCorrigida.split(' ');
    ultimoEventoInfo = `
      <div style="font-size: 0.75rem;">
        <div style="font-weight: 500; margin-bottom: 2px;">${eventoMaisAntigo}</div>
        <div style="color: var(--gray); font-size: 0.65rem;">
          ${dataPart} ${horaPart}
        </div>
        <div style="color: var(--danger); font-size: 0.6rem; margin-top: 2px;">
          ‚ö†Ô∏è ${nomeFornecedorAntigo}
        </div>
      </div>
    `;
  } else {
    ultimoEventoInfo = `
      <div style="font-size: 0.75rem;">
        <div style="font-weight: 500; margin-bottom: 2px;">${eventoMaisAntigo}</div>
        <div style="color: var(--gray); font-size: 0.65rem;">N/A</div>
        <div style="color: var(--danger); font-size: 0.6rem; margin-top: 2px;">
          ‚ö†Ô∏è ${nomeFornecedorAntigo}
        </div>
      </div>
    `;
  }

  row.innerHTML = `
    <td>
      <div style="font-weight: 600; color: var(--primary); margin-bottom: 2px;">${grupo.razao_social || 'N/A'}</div>
      <div style="font-size: 0.7rem; color: var(--gray);">${grupo.nome_fantasia || 'Sem nome fantasia'}</div>
      <div style="font-size: 0.65rem; color: var(--info); margin-top: 2px;">
        <strong>${grupo.lojas.length}</strong> fornecedor(es)
      </div>
    </td>
    <td>
      <div style="font-family: monospace; font-size: 0.75rem; font-weight: 600; color: var(--dark);">
        ${grupo.cnpj || 'N/A'}
      </div>
    </td>
    <td>
      <div style="font-weight: 500; color: var(--dark);">
        ${grupo.lojas.map(l => l.fornecedor).join(', ')}
      </div>
    </td>
    <td>
      <span class="status-badge ${getSituacaoClass(situacaoPrincipal)}">${situacaoPrincipal}</span>
    </td>
    <td>
      ${ultimoEventoInfo}
    </td>
    <td style="text-align: center;">
      <div class="defasagem-container">
        <span class="defasagem-badge ${defasagemClass}" title="Fornecedor mais antigo: ${defasagemInfo.fornecedor}">
          ${defasagemTexto}
        </span>
      </div>
    </td>
    <td style="font-weight: 600; color: var(--success); text-align: center;">
      ${formatarMoedaParaInput(grupo.lojas[0]?.mensalidade)}
    </td>
    <td style="font-weight: 600; color: var(--info); text-align: center;">
      ${grupo.lojas[0]?.adesao === 'Isento' || grupo.lojas[0]?.adesao === 0 ? 'Isento' : formatarMoedaParaInput(grupo.lojas[0]?.adesao)}
    </td>
    <td style="text-align: center;">
      <button class="btn btn-info btn-sm btn-visualizar-compact" onclick="verTodosFornecedores('${grupo.cnpj}')" title="Visualizar Todos">
        <i class="fas fa-eye"></i> Ver Todos
      </button>
    </td>
  `;

  return row;
}

// üî• FUN√á√ÉO AUXILIAR PARA ENCONTRAR FORNECEDOR MAIS ATRASADO
function encontrarFornecedorMaisAntigo(lojasDoCNPJ) {
  if (!lojasDoCNPJ || lojasDoCNPJ.length === 0) {
    return { fornecedor: 'N/A', data: 'N/A', evento: 'N/A', dias: 9999 };
  }
  
  console.log("üîç Buscando fornecedor mais antigo entre", lojasDoCNPJ.length, "lojas");
  
  // Filtrar apenas lojas com data v√°lida
  const lojasComData = lojasDoCNPJ.filter(loja => {
    if (!loja.ultimo_evento || loja.ultimo_evento === 'N/A') return false;
    
    try {
      const data = new Date(loja.ultimo_evento.split('/').reverse().join('-'));
      return !isNaN(data.getTime());
    } catch (error) {
      return false;
    }
  });
  
  if (lojasComData.length === 0) {
    console.log("‚ùå Nenhuma loja com data v√°lida encontrada");
    return { fornecedor: 'N/A', data: 'N/A', evento: 'N/A', dias: 9999 };
  }
  
  // Encontrar a loja com evento mais antigo
  const lojaMaisAntiga = lojasComData.reduce((maisAntiga, atual) => {
    try {
      const dataMaisAntiga = new Date(maisAntiga.ultimo_evento.split('/').reverse().join('-'));
      const dataAtual = new Date(atual.ultimo_evento.split('/').reverse().join('-'));
      
      console.log(`üìä Comparando: ${atual.fornecedor} (${dataAtual}) vs ${maisAntiga.fornecedor} (${dataMaisAntiga})`);
      
      return dataAtual < dataMaisAntiga ? atual : maisAntiga;
    } catch (error) {
      console.log("‚ùå Erro ao comparar datas:", error);
      return maisAntiga;
    }
  });
  
  const diasDefasagem = calcularDiasDefasagem(lojaMaisAntiga.ultimo_evento);
  
  console.log("‚úÖ Fornecedor mais antigo encontrado:", {
    fornecedor: lojaMaisAntiga.fornecedor,
    data: lojaMaisAntiga.ultimo_evento,
    evento: lojaMaisAntiga.evento,
    dias: diasDefasagem
  });
  
  return {
    fornecedor: lojaMaisAntiga.fornecedor,
    data: lojaMaisAntiga.ultimo_evento,
    evento: lojaMaisAntiga.evento,
    dias: diasDefasagem
  };
}

// üî• NOVA FUN√á√ÉO: Calcular defasagem correta por CNPJ (usando o mais antigo)
function calcularDefasagemPorCNPJ(lojasDoCNPJ) {
  if (!lojasDoCNPJ || lojasDoCNPJ.length === 0) {
    return { dias: 9999, fornecedor: 'N/A', data: 'N/A', evento: 'N/A' };
  }
  
  console.log("üîç Calculando defasagem para CNPJ com", lojasDoCNPJ.length, "lojas");
  
  // Filtrar apenas lojas com data v√°lida
  const lojasComData = lojasDoCNPJ.filter(loja => {
    if (!loja.ultimo_evento || loja.ultimo_evento === 'N/A') return false;
    
    try {
      const data = new Date(loja.ultimo_evento.split('/').reverse().join('-'));
      return !isNaN(data.getTime());
    } catch (error) {
      return false;
    }
  });
  
  if (lojasComData.length === 0) {
    console.log("‚ùå Nenhuma loja com data v√°lida encontrada");
    return { dias: 9999, fornecedor: 'N/A', data: 'N/A', evento: 'N/A' };
  }
  
  // Encontrar a loja com evento mais antigo
  const lojaMaisAntiga = lojasComData.reduce((maisAntiga, atual) => {
    try {
      const dataMaisAntiga = new Date(maisAntiga.ultimo_evento.split('/').reverse().join('-'));
      const dataAtual = new Date(atual.ultimo_evento.split('/').reverse().join('-'));
      
      console.log(`üìä Comparando: ${atual.fornecedor} (${dataAtual}) vs ${maisAntiga.fornecedor} (${dataMaisAntiga})`);
      
      return dataAtual < dataMaisAntiga ? atual : maisAntiga;
    } catch (error) {
      console.log("‚ùå Erro ao comparar datas:", error);
      return maisAntiga;
    }
  });
  
  const diasDefasagem = calcularDiasDefasagem(lojaMaisAntiga.ultimo_evento);
  
  console.log("‚úÖ Fornecedor mais antigo encontrado:", {
    fornecedor: lojaMaisAntiga.fornecedor,
    data: lojaMaisAntiga.ultimo_evento,
    dias: diasDefasagem
  });
  
  return {
    dias: diasDefasagem,
    fornecedor: lojaMaisAntiga.fornecedor,
    data: lojaMaisAntiga.ultimo_evento,
    evento: lojaMaisAntiga.evento
  };
}

// üî• FUN√á√ïES DE FILTRO
function aplicarFiltroSituacao(situacao) {
  document.querySelectorAll('.filtro-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  if (situacao !== situacaoAtiva) {
    const btnAtivo = document.querySelector(`.filtro-btn[data-situacao="${situacao}"]`);
    if (btnAtivo) {
      btnAtivo.classList.add('active');
    }
    situacaoAtiva = situacao;
  } else {
    situacaoAtiva = 'all';
    const btnTodos = document.querySelector('.filtro-btn[data-situacao="all"]');
    if (btnTodos) {
      btnTodos.classList.add('active');
    }
  }

  if (situacaoAtiva === 'all') {
    delete filtrosAtivos.situacao;
  } else {
    filtrosAtivos.situacao = situacaoAtiva;
  }
  aplicarTodosFiltros();
}

function filtrarPesquisa() {
  const termo = document.getElementById('pesquisaCadastros').value.toLowerCase().trim();
  if (termo) {
    filtrosAtivos.pesquisa = termo;
  } else {
    delete filtrosAtivos.pesquisa;
  }
  aplicarTodosFiltros();
}

// üî• APLICAR TODOS OS FILTROS
function aplicarTodosFiltros() {
  console.log("üéØ [FILTRO] Aplicando todos os filtros...");
  
  let resultado = [...todosCadastros];
  
  if (filtrosAtivos.situacao) {
    resultado = resultado.filter(cadastro => 
      cadastro.situacao === filtrosAtivos.situacao
    );
  }
  
  if (filtrosAtivos.eventos && filtrosAtivos.eventos.length > 0) {
    resultado = resultado.filter(cadastro => 
      filtrosAtivos.eventos.some(evento => 
        cadastro.evento && cadastro.evento.toUpperCase().includes(evento)
      )
    );
  }
  
  if (filtrosAtivos.fornecedores && filtrosAtivos.fornecedores.length > 0) {
    resultado = resultado.filter(cadastro => 
      filtrosAtivos.fornecedores.includes(cadastro.fornecedor)
    );
  }
  
  if (filtrosAtivos.pesquisa) {
    resultado = resultado.filter(cadastro => 
      (cadastro.razao_social && cadastro.razao_social.toLowerCase().includes(filtrosAtivos.pesquisa)) ||
      (cadastro.nome_fantasia && cadastro.nome_fantasia.toLowerCase().includes(filtrosAtivos.pesquisa)) ||
      (cadastro.cnpj && cadastro.cnpj.includes(filtrosAtivos.pesquisa)) ||
      (cadastro.fornecedor && cadastro.fornecedor.toLowerCase().includes(filtrosAtivos.pesquisa)) ||
      (cadastro.evento && cadastro.evento.toLowerCase().includes(filtrosAtivos.pesquisa))
    );
  }
  
  cadastrosFiltrados = resultado;
  console.log(`‚úÖ [FILTRO] Filtros aplicados: ${resultado.length} de ${todosCadastros.length} registros`);
  
  exibirTabelaCadastros();
}

// üî• ORDENA√á√ÉO - CORRIGIDA COM MENSALIDADE E ADES√ÉO
function ordenarCadastros() {
  const criterio = document.getElementById('ordenacao').value;
  
  console.log("üéØ Ordenando por:", criterio);
  
  const cadastrosParaOrdenar = [...cadastrosFiltrados];
  
  cadastrosParaOrdenar.sort((a, b) => {
    switch(criterio) {
      case 'razao_social':
        const razaoA = (a.razao_social || '').toLowerCase();
        const razaoB = (b.razao_social || '').toLowerCase();
        return razaoA.localeCompare(razaoB);
        
      case 'razao_social_desc':
        const razaoADesc = (a.razao_social || '').toLowerCase();
        const razaoBDesc = (b.razao_social || '').toLowerCase();
        return razaoBDesc.localeCompare(razaoADesc);
        
      case 'nome_fantasia':
        const fantasiaA = (a.nome_fantasia || '').toLowerCase();
        const fantasiaB = (b.nome_fantasia || '').toLowerCase();
        return fantasiaA.localeCompare(fantasiaB);
        
      case 'nome_fantasia_desc':
        const fantasiaADesc = (a.nome_fantasia || '').toLowerCase();
        const fantasiaBDesc = (b.nome_fantasia || '').toLowerCase();
        return fantasiaBDesc.localeCompare(fantasiaADesc);
        
      case 'situacao':
        const situacaoA = (a.situacao || '').toLowerCase();
        const situacaoB = (b.situacao || '').toLowerCase();
        return situacaoA.localeCompare(situacaoB);
        
      case 'fornecedor':
        const fornecedorA = (a.fornecedor || '').toLowerCase();
        const fornecedorB = (b.fornecedor || '').toLowerCase();
        return fornecedorA.localeCompare(fornecedorB);
        
      case 'mensalidade':
        const mensalidadeA = parseFloat(a.mensalidade || 0);
        const mensalidadeB = parseFloat(b.mensalidade || 0);
        return mensalidadeB - mensalidadeA; // Maior primeiro
        
      case 'mensalidade_asc':
        const mensalidadeAAsc = parseFloat(a.mensalidade || 0);
        const mensalidadeBAsc = parseFloat(b.mensalidade || 0);
        return mensalidadeAAsc - mensalidadeBAsc; // Menor primeiro
        
      case 'adesao':
        const adesaoA = a.adesao === 'Isento' || a.adesao === 0 ? 0 : parseFloat(a.adesao || 0);
        const adesaoB = b.adesao === 'Isento' || b.adesao === 0 ? 0 : parseFloat(b.adesao || 0);
        return adesaoB - adesaoA; // Maior primeiro
        
      case 'adesao_asc':
        const adesaoAAsc = a.adesao === 'Isento' || a.adesao === 0 ? 0 : parseFloat(a.adesao || 0);
        const adesaoBAsc = b.adesao === 'Isento' || b.adesao === 0 ? 0 : parseFloat(b.adesao || 0);
        return adesaoAAsc - adesaoBAsc; // Menor primeiro
        
      case 'defasagem':
        const defasagemA = calcularDiasDefasagem(a.ultimo_evento);
        const defasagemB = calcularDiasDefasagem(b.ultimo_evento);
        return defasagemB - defasagemA; // Maior primeiro
        
      case 'defasagem_asc':
        const defasagemAAsc = calcularDiasDefasagem(a.ultimo_evento);
        const defasagemBAsc = calcularDiasDefasagem(b.ultimo_evento);
        return defasagemAAsc - defasagemBAsc; // Menor primeiro
        
      default:
        return 0;
    }
  });
  
  cadastrosFiltrados = cadastrosParaOrdenar;
  exibirTabelaCadastros();
}

function limparTodosFiltros() {
  filtrosAtivos = {};
  situacaoAtiva = 'all';
  eventosSelecionados = [];
  fornecedoresSelecionados = [];
  document.getElementById('pesquisaCadastros').value = '';
  document.getElementById('ordenacao').value = 'razao_social';
  document.getElementById('filtroEvento').value = '';
  document.getElementById('filtroFornecedor').value = '';
  
  document.querySelectorAll('.filtro-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector('.filtro-btn[data-situacao="all"]').classList.add('active');
  
  atualizarEventosSelecionados();
  atualizarFornecedoresSelecionados();
  
  aplicarTodosFiltros();
}

// üî• FUN√á√ïES DOS MODAIS
function verTodosFornecedores(cnpj) {
  const lojasDoCNPJ = todosCadastros.filter(cadastro => cadastro.cnpj === cnpj);
  exibirModalFornecedores(cnpj, lojasDoCNPJ);
}

function exibirModalFornecedores(cnpj, lojas) {
    const modal = document.getElementById('modalFornecedores');
    const content = document.getElementById('modalFornecedoresContent');
    
    let lojasHTML = '';
    
    if (lojas && lojas.length > 0) {
        lojasHTML = lojas.map(loja => {
            // üî• CORRIGIR DATA DO √öLTIMO EVENTO
            const ultimoEventoCorrigido = corrigirHoraFrontend(loja.ultimo_evento);
            
            return `
            <div class="loja-item" style="border-color: ${getCorBordaSituacao(loja.situacao)};">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <h4 style="margin: 0; color: var(--primary);">üè™ ${loja.fornecedor || 'Fornecedor'}</h4>
                    <span class="status-badge ${getSituacaoClass(loja.situacao)}">${loja.situacao || 'N/A'}</span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div><strong>üìÖ Evento:</strong> ${loja.evento || 'N/A'}</div>
                    <div><strong>üí∞ Tarifa:</strong> ${loja.tarifa || 'N/A'} ${formatarPercentualCorrigido(loja.percentual_tarifa)}</div>
                    <div><strong>üíµ Mensalidade:</strong> ${formatarMoedaParaInput(loja.mensalidade)}</div>
                    <div><strong>ü§ù Ades√£o:</strong> ${loja.adesao === 'Isento' || loja.adesao === 0 ? 'Isento' : formatarMoedaParaInput(loja.adesao)}</div>
                </div>
                
                <div style="background: #f8f9fa; padding: 8px 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid var(--warning);">
                    <strong>‚è∞ Defasagem:</strong> 
                    <span style="color: ${calcularDefasagem(loja.ultimo_evento).includes('30') || calcularDefasagem(loja.ultimo_evento).includes('31') ? 'var(--danger)' : 'var(--dark)'}; font-weight: 600;">
                        ${calcularDefasagem(loja.ultimo_evento)}
                    </span>
                    <div style="font-size: 0.8rem; color: var(--gray); margin-top: 4px;">
                        √öltimo evento: ${ultimoEventoCorrigido}
                    </div>
                </div>
                
                <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-warning btn-sm" onclick="verDetalhesCadastroModal('${loja.id}'); fecharModalFornecedores();">
                        <i class="fas fa-eye"></i> Detalhes
                    </button>
                </div>
            </div>
            `;
        }).join('');
    } else {
        lojasHTML = `
        <div style="text-align: center; padding: 40px; color: var(--gray);">
            <i class="fas fa-store-slash" style="font-size: 3rem; margin-bottom: 15px;"></i>
            <h4>Nenhuma loja encontrada</h4>
            <p>N√£o h√° lojas cadastradas para este CNPJ.</p>
        </div>
        `;
    }

    content.innerHTML = `
    <div style="margin-bottom: 15px;">
        <div style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
            <strong>CNPJ:</strong> ${cnpj}
        </div>
    </div>
    
    <div style="max-height: 60vh; overflow-y: auto;">
        <h4 style="color: var(--primary); margin-bottom: 15px;">
            üìä ${lojas ? lojas.length : 0} loja(s) encontrada(s)
        </h4>
        ${lojasHTML}
    </div>
    `;
    
    modal.style.display = 'flex';
}

function fecharModalFornecedores() {
  const modal = document.getElementById('modalFornecedores');
  modal.style.display = 'none';
}

function verDetalhesCadastroModal(id) {
  console.log("üëÄ Visualizando detalhes ID:", id);
  
  google.script.run
    .withSuccessHandler(function(dados) {
      console.log("‚úÖ Dados recebidos para detalhes:", dados);
      exibirModalDetalhesCompleto(dados);
    })
    .withFailureHandler(function(error) {
      showMessage('error', '‚ùå Erro ao carregar detalhes: ' + error.message);
    })
    .buscarCadastroPorIDComWaitlabel(id, waitlabelAtual);
}

function exibirModalDetalhesCompleto(dados) {
    const modal = document.getElementById('modalDetalhes');
    const content = document.getElementById('modalDetalhesContent');
    
    const mensalidadeFormatada = formatarMoedaParaInput(dados.mensalidade);
    const mensalidadeSimFormatada = formatarMoedaParaInput(dados.mensalidade_sim || 0);
    const adesaoFormatada = dados.adesao === 'Isento' || dados.adesao === 0 ? 'Isento' : formatarMoedaParaInput(dados.adesao);
    
    // üî• CORRIGIR DATAS PARA EXIBI√á√ÉO
    const ultimoEventoCorrigido = corrigirHoraFrontend(dados.ultimo_evento);
    const ativacaoCorrigida = dados.ativacao ? corrigirHoraFrontend(dados.ativacao) : 'N/A';
    const contratoEnviadoCorrigido = dados.contrato_enviado ? corrigirHoraFrontend(dados.contrato_enviado) : 'N/A';
    const contratoAssinadoCorrigido = dados.contrato_assinado ? corrigirHoraFrontend(dados.contrato_assinado) : 'N/A';

    content.innerHTML = `
    <div class="detalhes-grid">
        <!-- üî• SE√á√ÉO: INFORMA√á√ïES PRINCIPAIS -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0f8ff; border-left: 4px solid #7E3E9A;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #7E3E9A;">
                <i class="fas fa-info-circle"></i> üìã INFORMA√á√ïES PRINCIPAIS
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üè¢ Raz√£o Social</span>
            <div class="detalhe-valor" style="font-weight: bold; color: #7E3E9A;">${dados.razao_social || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üè∑Ô∏è Nome Fantasia</span>
            <div class="detalhe-valor">${dados.nome_fantasia || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üî¢ CNPJ</span>
            <div class="detalhe-valor" style="font-family: monospace;">${dados.cnpj || 'N/A'}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üöö Fornecedor</span>
            <div class="detalhe-valor">${dados.fornecedor || 'N/A'}</div>
        </div>

        <!-- üî• SE√á√ÉO: FINANCEIRO -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0fff0; border-left: 4px solid #28a745; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #28a745;">
                <i class="fas fa-chart-line"></i> üí∞ INFORMA√á√ïES FINANCEIRAS
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üíµ Mensalidade</span>
            <div class="detalhe-valor" style="color: var(--success); font-weight: 600;">${mensalidadeFormatada}</div>
        </div>

        <div class="detalhe-item">
            <span class="detalhe-label" style="color: var(--primary); font-weight: 700;">üíú Mensalidade SIM</span>
            <div class="detalhe-valor" style="color: var(--primary); font-weight: 600;">${mensalidadeSimFormatada}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">ü§ù Ades√£o</span>
            <div class="detalhe-valor" style="color: var(--info); font-weight: 600;">${adesaoFormatada}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üí∞ Tarifa</span>
            <div class="detalhe-valor">${dados.tarifa || 'N/A'} ${formatarPercentualParaExibicao(dados.percentual_tarifa)}</div>
        </div>

        <!-- üî• SE√á√ÉO: CONTRATOS E DATAS -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #fff8f0; border-left: 4px solid #ff6b35; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #ff6b35;">
                <i class="fas fa-file-contract"></i> üìÑ CONTRATOS E DATAS
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üìÑ Contrato Enviado</span>
            <div class="detalhe-valor">${contratoEnviadoCorrigido}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">‚úçÔ∏è Contrato Assinado</span>
            <div class="detalhe-valor">${contratoAssinadoCorrigido}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üöÄ Data Ativa√ß√£o</span>
            <div class="detalhe-valor">${ativacaoCorrigida}</div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üìÖ √öltimo Evento</span>
            <div class="detalhe-valor">${ultimoEventoCorrigido}</div>
        </div>

        <!-- üî• SE√á√ÉO: STATUS E ACOMPANHAMENTO -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0f0f8; border-left: 4px solid #6f42c1; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #6f42c1;">
                <i class="fas fa-tasks"></i> üìä STATUS E ACOMPANHAMENTO
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üéØ Situa√ß√£o</span>
            <div class="detalhe-valor">
                <span class="status-badge ${getSituacaoClass(dados.situacao)}">${dados.situacao || 'N/A'}</span>
            </div>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üìÖ Evento</span>
            <div class="detalhe-valor">${dados.evento || 'N/A'}</div>
        </div>

        <!-- üî• SE√á√ÉO: LINKS E OBSERVA√á√ïES -->
        <div class="detalhe-item" style="grid-column: 1 / -1; background: #f0f0f0; border-left: 4px solid #6c757d; margin-top: 10px;">
            <span class="detalhe-label" style="font-size: 1.1em; color: #6c757d;">
                <i class="fas fa-sticky-note"></i> üîó LINKS E OBSERVA√á√ïES
            </span>
        </div>
        
        <div class="detalhe-item">
            <span class="detalhe-label">üîó Link</span>
            <div class="detalhe-valor">
                ${dados.link ? 
                    `<a href="${dados.link}" target="_blank" style="color: #007bff; text-decoration: none;">
                        <i class="fas fa-external-link-alt"></i> ${dados.link}
                    </a>` 
                    : 'N/A'
                }
            </div>
        </div>
        
        <div class="detalhe-item" style="grid-column: 1 / -1;">
            <span class="detalhe-label">üìù Observa√ß√µes</span>
            <div class="detalhe-valor" style="max-height: 100px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                ${dados.observacoes || 'Nenhuma observa√ß√£o registrada'}
            </div>
        </div>
    </div>
    `;
    
    modal.style.display = 'flex';
}

function fecharModalDetalhes() {
  const modal = document.getElementById('modalDetalhes');
  modal.style.display = 'none';
}

// üî• CORRE√á√ÉO DEFINITIVA - UTC para GMT-3 (3 horas de diferen√ßa)
function corrigirHoraFrontend(dataHoraString) {
    if (!dataHoraString || !dataHoraString.includes('/') || !dataHoraString.includes(':')) {
        return dataHoraString;
    }
    
    try {
        const [dataPart, horaPart] = dataHoraString.split(' ');
        const [dia, mes, ano] = dataPart.split('/');
        const [hora, minuto, segundo] = horaPart.split(':');
        
        // üî• CORRE√á√ÉO: UTC para GMT-3 = SUBTRAIR 3 HORAS
        const dataUTC = new Date(Date.UTC(
            parseInt(ano),
            parseInt(mes) - 1,
            parseInt(dia),
            parseInt(hora),
            parseInt(minuto), 
            parseInt(segundo)
        ));
        
        const dataGMT3 = new Date(dataUTC.getTime() - (5 * 60 * 60 * 1000));
        
        // Formatar de volta para string
        const diaCorrigido = String(dataGMT3.getUTCDate()).padStart(2, '0');
        const mesCorrigido = String(dataGMT3.getUTCMonth() + 1).padStart(2, '0');
        const anoCorrigido = dataGMT3.getUTCFullYear();
        const horaCorrigida = String(dataGMT3.getUTCHours()).padStart(2, '0');
        const minutoCorrigido = String(dataGMT3.getUTCMinutes()).padStart(2, '0');
        const segundoCorrigido = String(dataGMT3.getUTCSeconds()).padStart(2, '0');
        
        const resultado = `${diaCorrigido}/${mesCorrigido}/${anoCorrigido} ${horaCorrigida}:${minutoCorrigido}:${segundoCorrigido}`;
        
        return resultado;
        
    } catch (error) {
        console.error("‚ùå Erro ao corrigir data:", error);
        return dataHoraString;
    }
}

// üî• CORRE√á√ÉO DEFINITIVA DA DEFASAGEM
function calcularDefasagem(dataUltimoEvento) {
    // üî• PRIMEIRO aplicar a corre√ß√£o de UTC para GMT-3
    const dataCorrigida = corrigirHoraFrontend(dataUltimoEvento);
    
    // üî• AGORA calcular com a data corrigida
    if (!dataCorrigida || dataCorrigida === 'N/A' || dataCorrigida === '' || dataCorrigida === 'Data inv√°lida') {
        return 'N/A';
    }
    
    try {
        let dataEvento;
        
        if (dataCorrigida.includes('/') && dataCorrigida.includes(':')) {
            const [dataPart, horaPart] = dataCorrigida.split(' ');
            const [dia, mes, ano] = dataPart.split('/');
            const [hora, minuto, segundo] = horaPart.split(':');
            
            dataEvento = new Date(
                parseInt(ano), 
                parseInt(mes) - 1,
                parseInt(dia),
                parseInt(hora), 
                parseInt(minuto), 
                parseInt(segundo)
            );
            
        } else {
            dataEvento = new Date(dataCorrigida);
        }
        
        if (isNaN(dataEvento.getTime())) {
            return 'Data inv√°lida';
        }
        
        const hoje = new Date();
        
        // üî• CORRE√á√ÉO: Zerar horas para comparar apenas datas
        const hojeZerado = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
        const dataEventoZerada = new Date(dataEvento.getFullYear(), dataEvento.getMonth(), dataEvento.getDate());
        
        const diffTempo = hojeZerado.getTime() - dataEventoZerada.getTime();
        const diffDias = Math.floor(diffTempo / (1000 * 3600 * 24));
        
        if (diffDias === 0) return 'Hoje';
        if (diffDias === 1) return '1 dia';
        if (diffDias > 1) return `${diffDias} dias`;
        if (diffDias < 0) return 'Futuro';
        
        return 'N/A';
        
    } catch (error) {
        return 'Erro no c√°lculo';
    }
}

// üî• CORRE√á√ÉO DA FUN√á√ÉO calcularDiasDefasagem
function calcularDiasDefasagem(dataUltimoEvento) {
    const defasagem = calcularDefasagem(dataUltimoEvento);
    
    if (defasagem === 'N/A' || defasagem === 'Erro' || defasagem === 'Futuro' || defasagem === 'Data inv√°lida' || defasagem === 'Erro no c√°lculo') {
        return 9999;
    }
    if (defasagem === 'Hoje') return 0;
    if (defasagem === '1 dia') return 1;
    
    // Extrair n√∫mero de dias de strings como "5 dias"
    const match = defasagem.match(/(\d+)\s*dias?/);
    if (match && match[1]) {
        return parseInt(match[1]);
    }
    
    const dias = parseInt(defasagem);
    if (isNaN(dias)) return 9999;
    
    return dias;
}

function getDefasagemClass(defasagem) {
  if (defasagem === 'N/A' || defasagem === 'Erro') return 'defasagem-media';
  if (defasagem === 'Hoje') return 'defasagem-baixa';
  if (defasagem === '1 dia') return 'defasagem-baixa';
  
  const dias = parseInt(defasagem);
  if (isNaN(dias)) return 'defasagem-media';
  
  if (dias <= 3) return 'defasagem-baixa';
  if (dias <= 7) return 'defasagem-media';
  return 'defasagem-alta';
}

function getSituacaoClass(situacao) {
  if (!situacao) return 'situacao-cadastrado';
  
  const situacaoUpper = situacao.toUpperCase().trim();
  
  if (situacaoUpper.includes('NOVO REGISTRO')) return 'situacao-novo-registro';
  else if (situacaoUpper.includes('CADASTRADO')) return 'situacao-cadastrado';
  else if (situacaoUpper.includes('EM ANDAMENTO')) return 'situacao-andamento';
  else if (situacaoUpper.includes('REJEITADO')) return 'situacao-rejeitado';
  else if (situacaoUpper.includes('DESCREDENCIADO')) return 'situacao-descredenciado';
  else if (situacaoUpper.includes('DESISTIU')) return 'situacao-desistiu';
  else return 'situacao-cadastrado';
}

function getCorBordaSituacao(situacao) {
  const situacaoLower = situacao ? situacao.toLowerCase() : '';
  
  if (situacaoLower.includes('novo registro')) return '#bfe1f6';
  else if (situacaoLower.includes('cadastrado')) return '#D1E7DD';
  else if (situacaoLower.includes('em andamento')) return '#FFF3CD';
  else if (situacaoLower.includes('rejeitado')) return '#E2E3E5';
  else if (situacaoLower.includes('descredenciado')) return '#F8D7DA';
  else if (situacaoLower.includes('desistiu')) return '#e6cff2';
  else return 'var(--border)';
}

function formatarPercentualCorrigido(percentual) {
    if (!percentual && percentual !== 0) return 'N/A';
    
    try {
        const numero = typeof percentual === 'string' ? parseFloat(percentual) : percentual;
        
        if (isNaN(numero)) return String(percentual);
        
        const porcentagem = numero * 100;
        return porcentagem.toFixed(2).replace('.', ',') + '%';
        
    } catch (error) {
        return String(percentual);
    }
}

function formatarPercentualParaExibicao(percentual) {
    if (!percentual && percentual !== 0) return '';
    
    try {
        if (typeof percentual === 'string') {
            if (percentual.match(/^\d*\.?\d+$/)) {
                const numero = parseFloat(percentual);
                if (!isNaN(numero)) {
                    const valorFormatado = numero * 100;
                    const valorString = valorFormatado.toFixed(2);
                    return valorString.replace('.', ',') + '%';
                }
            }
            if (percentual.includes('%')) {
                return percentual;
            }
            return percentual + '%';
        }
        
        if (typeof percentual === 'number') {
            let valorFormatado = percentual * 100;
            const valorString = valorFormatado.toFixed(2);
            return valorString.replace('.', ',') + '%';
        }
        
        return String(percentual);
        
    } catch (error) {
        return String(percentual || '');
    }
}

function formatarMoedaParaInput(valor) {
  if (!valor) return 'R$ 0,00';
  const numero = typeof valor === 'number' ? valor : parseFloat(valor);
  return 'R$ ' + numero.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
}

function atualizarContador() {
  const contador = document.getElementById('contadorCadastros');
  const cadastrosVisiveis = cadastrosFiltrados.length;
  const totalCadastros = todosCadastros.length;
  
  if (cadastrosVisiveis === totalCadastros) {
    contador.textContent = `${totalCadastros} cadastro${totalCadastros !== 1 ? 's' : ''}`;
  } else {
    contador.textContent = `${cadastrosVisiveis} de ${totalCadastros} cadastros`;
  }
}

function showLoading() {
  document.getElementById('loadingCadastros').style.display = 'flex';
  document.getElementById('tableContainer').style.display = 'none';
}

function hideLoading() {
  document.getElementById('loadingCadastros').style.display = 'none';
}

function showMessage(type, text) {
  const successEl = document.getElementById('messageSuccess');
  const errorEl = document.getElementById('messageError');
  const infoEl = document.getElementById('messageInfo');

  successEl.style.display = 'none';
  errorEl.style.display = 'none';
  infoEl.style.display = 'none';

  if (type === 'success') {
    successEl.querySelector('span').textContent = text;
    successEl.style.display = 'flex';
  } else if (type === 'error') {
    errorEl.querySelector('span').textContent = text;
    errorEl.style.display = 'flex';
  } else if (type === 'info') {
    infoEl.querySelector('span').textContent = text;
    infoEl.style.display = 'flex';
  }

  setTimeout(() => {
    successEl.style.display = 'none';
    errorEl.style.display = 'none';
    infoEl.style.display = 'none';
  }, 5000);
}

// üî• FECHAR MODAIS COM ESC E CLIQUE FORA
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    fecharModalDetalhes();
    fecharModalFornecedores();
  }
});

document.getElementById('modalDetalhes').addEventListener('click', function(e) {
  if (e.target === this) {
    fecharModalDetalhes();
  }
});

document.getElementById('modalFornecedores').addEventListener('click', function(e) {
  if (e.target === this) {
    fecharModalFornecedores();
  }
});
  </script>
</body>
</html>
