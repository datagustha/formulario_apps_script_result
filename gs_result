// CONFIGURA√á√ÉO DA PLANILHA FILHA (SOMENTE LEITURA) - AJUSTADO COM MESMOS NOMES
const CONFIG_FILHA = {
  ID_PLANILHA_MAE: "1V4iGN14UpIQcwf3qKU0_Wbiy2exdW2WUmrYTniy0upA",
  WAITLABEL_FILHA: "Result",
  TIMEZONE: "America/Sao_Paulo"
};

// üî• ESTRUTURA DAS COLUNAS - EXATAMENTE IGUAL AO CADASTROS
const COLUNAS_RESULT = {
  RAZAO_SOCIAL: 0,
  NOME_FANTASIA: 1,
  CNPJ: 2,
  FORNECEDOR: 3,
  ULTIMA_ETAPA: 4,
  ETAPA: 5,
  OBSERVACAO: 6,
  CONTRATO_ENVIADO: 7,
  CONTRATO_ASSINADO: 8,
  ATIVACAO: 9,
  LINK: 10,
  MENSALIDADE: 11,
  MENSALIDADE_SIM: 12,
  MDR: 13,
  TIS: 14,
  REBATE: 15,
  ADESAO: 16,
  SITUACAO: 17
};

// üî• FUN√á√ÉO PRINCIPAL
function doGet() {
  const htmlOutput = HtmlService.createHtmlOutputFromFile('IndexFilha')
    .setTitle('Sistema - Visualiza√ß√£o de Dados')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  
  return htmlOutput;
}

// üî• BUSCAR TODOS OS CADASTROS - COM MESMA L√ìGICA DO CADASTROS
function buscarTodosCadastrosComWaitlabel(waitlabel) {
  try {
    console.log("üîç [VISUALIZA√á√ÉO RESULT] Buscando dados no waitlabel:", waitlabel);
    
    const ss = SpreadsheetApp.openById(CONFIG_FILHA.ID_PLANILHA_MAE);
    const aba = ss.getSheetByName(waitlabel);
    
    if (!aba) {
      console.log("‚ùå Aba n√£o encontrada:", waitlabel);
      return [];
    }
    
    const ultimaLinha = aba.getLastRow();
    console.log("üìä √öltima linha encontrada:", ultimaLinha);
    
    if (ultimaLinha < 2) return [];
    
    // Buscar dados com todas as colunas (18 colunas conforme estrutura)
    const dados = aba.getRange(2, 1, ultimaLinha - 1, 18).getValues();
    console.log("üìà Dados brutos encontrados:", dados.length, "linhas x", dados[0]?.length || 0, "colunas");
    
    const cadastros = [];
    
    for (let i = 0; i < dados.length; i++) {
      const linha = dados[i];
      
      if (!linha || !linha[0] || linha[0].toString().trim() === '') continue;

      // üî• Processamento de datas - IGUAL AO CADASTROS
      let ultimaEtapaFormatada = linha[COLUNAS_RESULT.ULTIMA_ETAPA] ? linha[COLUNAS_RESULT.ULTIMA_ETAPA].toString() : '';
      
      if (linha[COLUNAS_RESULT.ULTIMA_ETAPA] instanceof Date) {
        const dataUTC = linha[COLUNAS_RESULT.ULTIMA_ETAPA];
        const dataBrasilia = new Date(dataUTC.getTime() - (5 * 60 * 60 * 1000));
        ultimaEtapaFormatada = Utilities.formatDate(dataBrasilia, CONFIG_FILHA.TIMEZONE, "dd/MM/yyyy HH:mm:ss");
      }
      
      let ativacaoFormatada = linha[COLUNAS_RESULT.ATIVACAO] ? linha[COLUNAS_RESULT.ATIVACAO].toString() : '';
      
      if (linha[COLUNAS_RESULT.ATIVACAO] instanceof Date) {
        ativacaoFormatada = Utilities.formatDate(linha[COLUNAS_RESULT.ATIVACAO], CONFIG_FILHA.TIMEZONE, "dd/MM/yyyy");
      }

      // üî• Processamento do MDR - EXATAMENTE IGUAL AO CADASTROS
      let mdrFormatado = formatarPercentualParaExibicao(linha[COLUNAS_RESULT.MDR]);
      
      // üî• Processamento do TIS - EXATAMENTE IGUAL AO CADASTROS
      let tisFormatado = formatarPercentualParaExibicao(linha[COLUNAS_RESULT.TIS]);
      
      // üî• Processamento do REBATE - EXATAMENTE IGUAL AO CADASTROS
      let rebateFormatado = formatarPercentualParaExibicao(linha[COLUNAS_RESULT.REBATE]);

      // üî• Processamento da ades√£o - EXATAMENTE IGUAL AO CADASTROS
      let adesaoFormatada = processarAdesao(linha[COLUNAS_RESULT.ADESAO]);

      const cadastro = {
        id: i + 2,
        razao_social: linha[COLUNAS_RESULT.RAZAO_SOCIAL]?.toString().trim() || '',
        nome_fantasia: linha[COLUNAS_RESULT.NOME_FANTASIA]?.toString().trim() || '',
        cnpj: formatarCNPJNoSheets(linha[COLUNAS_RESULT.CNPJ]?.toString().trim() || ''),
        fornecedor: linha[COLUNAS_RESULT.FORNECEDOR]?.toString().trim() || '',
        ultima_etapa: ultimaEtapaFormatada,
        etapa: linha[COLUNAS_RESULT.ETAPA]?.toString().trim() || '',
        observacoes: linha[COLUNAS_RESULT.OBSERVACAO]?.toString().trim() || '',
        contrato_enviado: linha[COLUNAS_RESULT.CONTRATO_ENVIADO]?.toString().trim() || '',
        contrato_assinado: linha[COLUNAS_RESULT.CONTRATO_ASSINADO]?.toString().trim() || '',
        ativacao: ativacaoFormatada,
        link: linha[COLUNAS_RESULT.LINK]?.toString().trim() || '',
        
        // üî• DADOS FINANCEIROS - MESMOS NOMES DO CADASTROS:
        mensalidade: typeof linha[COLUNAS_RESULT.MENSALIDADE] === 'number' ? linha[COLUNAS_RESULT.MENSALIDADE] : 0,
        mensalidade_sim: typeof linha[COLUNAS_RESULT.MENSALIDADE_SIM] === 'number' ? linha[COLUNAS_RESULT.MENSALIDADE_SIM] : 0,
        mdr: mdrFormatado,           // MESMO NOME: mdr
        tis: tisFormatado,           // MESMO NOME: tis
        rebate: rebateFormatado,     // MESMO NOME: rebate
        
        adesao: adesaoFormatada,
        situacao: (linha[COLUNAS_RESULT.SITUACAO]?.toString().trim() || 'Novo registro'),
        waitlabel: waitlabel
      };
      
      cadastros.push(cadastro);
    }
    
    console.log("‚úÖ Dados carregados para visualiza√ß√£o:", cadastros.length);
    return cadastros;
    
  } catch (error) {
    console.error("‚ùå Erro na busca:", error);
    return [];
  }
}

// üî• BUSCAR CADASTRO POR ID - COM MESMA L√ìGICA DO CADASTROS
function buscarCadastroPorIDComWaitlabel(id, waitlabel) {
  try {
    console.log("üîç [VISUALIZA√á√ÉO RESULT] Buscando cadastro por ID:", id, "no waitlabel:", waitlabel);
    
    const ss = SpreadsheetApp.openById(CONFIG_FILHA.ID_PLANILHA_MAE);
    const aba = ss.getSheetByName(waitlabel);
    if (!aba) return { encontrado: false, mensagem: "Waitlabel n√£o encontrado" };
    
    const ultimaLinha = aba.getLastRow();
    if (ultimaLinha < id) return { encontrado: false, mensagem: "Registro n√£o encontrado" };
    
    const linha = aba.getRange(id, 1, 1, 18).getValues()[0];
    
    if (!linha[0] || linha[0].toString().trim() === '') {
      return { encontrado: false, mensagem: "Registro vazio ou n√£o encontrado" };
    }

    // üî• Processamento de datas - IGUAL AO CADASTROS
    let ultimaEtapaFormatada = linha[COLUNAS_RESULT.ULTIMA_ETAPA] ? linha[COLUNAS_RESULT.ULTIMA_ETAPA].toString() : '';
    
    if (linha[COLUNAS_RESULT.ULTIMA_ETAPA] instanceof Date) {
      const dataUTC = linha[COLUNAS_RESULT.ULTIMA_ETAPA];
      const dataBrasilia = new Date(dataUTC.getTime() - (5 * 60 * 60 * 1000));
      ultimaEtapaFormatada = Utilities.formatDate(dataBrasilia, CONFIG_FILHA.TIMEZONE, "dd/MM/yyyy HH:mm:ss");
    }
    
    let ativacaoFormatada = '';
    if (linha[COLUNAS_RESULT.ATIVACAO]) {
      if (linha[COLUNAS_RESULT.ATIVACAO] instanceof Date) {
        ativacaoFormatada = Utilities.formatDate(linha[COLUNAS_RESULT.ATIVACAO], CONFIG_FILHA.TIMEZONE, "yyyy-MM-dd");
      } else {
        const dataStr = linha[COLUNAS_RESULT.ATIVACAO].toString();
        if (dataStr.includes('/')) {
          const partes = dataStr.split('/');
          if (partes.length === 3) {
            ativacaoFormatada = `${partes[2]}-${partes[1]}-${partes[0]}`;
          } else {
            ativacaoFormatada = dataStr;
          }
        } else {
          ativacaoFormatada = dataStr;
        }
      }
    }

    // üî• Processamento do MDR - EXATAMENTE IGUAL AO CADASTROS
    let mdrFormatado = formatarPercentualParaExibicao(linha[COLUNAS_RESULT.MDR]);
    
    // üî• Processamento do TIS - EXATAMENTE IGUAL AO CADASTROS
    let tisFormatado = formatarPercentualParaExibicao(linha[COLUNAS_RESULT.TIS]);
    
    // üî• Processamento do REBATE - EXATAMENTE IGUAL AO CADASTROS
    let rebateFormatado = formatarPercentualParaExibicao(linha[COLUNAS_RESULT.REBATE]);

    // üî• Processamento da ades√£o - EXATAMENTE IGUAL AO CADASTROS
    let adesaoFormatada = processarAdesao(linha[COLUNAS_RESULT.ADESAO]);

    // Criar objeto fornecedor para formul√°rio
    const fornecedorParaFormulario = {
      nome: linha[COLUNAS_RESULT.FORNECEDOR]?.toString().trim() || '',
      mdr: mdrFormatado,
      tis: tisFormatado,
      rebate: rebateFormatado
    };
    
    const resultado = {
      encontrado: true,
      id: id,
      razao_social: linha[COLUNAS_RESULT.RAZAO_SOCIAL]?.toString().trim() || '',
      nome_fantasia: linha[COLUNAS_RESULT.NOME_FANTASIA]?.toString().trim() || '',
      cnpj: formatarCNPJNoSheets(linha[COLUNAS_RESULT.CNPJ]?.toString().trim() || ''),
      fornecedor: linha[COLUNAS_RESULT.FORNECEDOR]?.toString().trim() || '',
      fornecedores: [fornecedorParaFormulario],
      ultima_etapa: ultimaEtapaFormatada,
      etapa: linha[COLUNAS_RESULT.ETAPA]?.toString().trim() || '',
      observacoes: linha[COLUNAS_RESULT.OBSERVACAO]?.toString().trim() || '',
      contrato_enviado: linha[COLUNAS_RESULT.CONTRATO_ENVIADO]?.toString().trim() || '',
      contrato_assinado: linha[COLUNAS_RESULT.CONTRATO_ASSINADO]?.toString().trim() || '',
      ativacao: ativacaoFormatada,
      link: linha[COLUNAS_RESULT.LINK]?.toString().trim() || '',
      
      // üî• DADOS FINANCEIROS - MESMOS NOMES:
      mensalidade: parseFloat(linha[COLUNAS_RESULT.MENSALIDADE]) || 0,
      mensalidade_sim: parseFloat(linha[COLUNAS_RESULT.MENSALIDADE_SIM]) || 0,
      mdr: mdrFormatado,          // MESMO NOME: mdr
      tis: tisFormatado,          // MESMO NOME: tis
      rebate: rebateFormatado,    // MESMO NOME: rebate
      
      adesao: adesaoFormatada,
      situacao: (linha[COLUNAS_RESULT.SITUACAO]?.toString().trim() || 'Novo registro'),
      waitlabel: waitlabel
    };

    console.log("‚úÖ [RESULT] Cadastro processado:", {
      id: resultado.id,
      razao_social: resultado.razao_social,
      mensalidade: resultado.mensalidade,
      mdr: resultado.mdr
    });
    
    return resultado;
    
  } catch (error) {
    console.error("‚ùå Erro em buscarCadastroPorIDComWaitlabel:", error);
    return { encontrado: false, mensagem: "Erro: " + error.message };
  }
}

// üî• FUN√á√ÉO PARA OBTER FILTROS
function obterFiltrosDisponiveis() {
  try {
    const waitlabelAtual = CONFIG_FILHA.WAITLABEL_FILHA;
    const cadastros = buscarTodosCadastrosComWaitlabel(waitlabelAtual);
    
    const etapasValidas = [
      "PENDENTE FORNECEDOR(ES)",
      "PENDENTE SIM", 
      "PENDENTE RETORNO EXTERNO"
    ];
    
    const situacoesValidas = [
      "NOVO REGISTRO",
      "EM ANDAMENTO", 
      "DESISTIU",
      "REJEITADO",
      "CADASTRADO",
      "DESCREDENCIADO"
    ];
    
    const etapasEncontradas = new Set();
    const situacoesEncontradas = new Set();
    const fornecedoresEncontrados = new Set();
    
    cadastros.forEach(cadastro => {
      if (cadastro.etapa && cadastro.etapa.trim() !== '') {
        const etapaNormalizada = normalizarTexto(cadastro.etapa);
        if (etapasValidas.includes(etapaNormalizada)) {
          etapasEncontradas.add(cadastro.etapa);
        }
      }
      
      if (cadastro.situacao && cadastro.situacao.trim() !== '') {
        situacoesEncontradas.add(cadastro.situacao);
      }
      
      if (cadastro.fornecedor && cadastro.fornecedor.trim() !== '') {
        fornecedoresEncontrados.add(cadastro.fornecedor);
      }
    });
    
    const etapasOrdenadas = Array.from(etapasEncontradas).sort();
    const situacoesOrdenadas = Array.from(situacoesEncontradas).sort();
    const fornecedoresOrdenados = Array.from(fornecedoresEncontrados).sort();
    
    console.log("üéØ [RESULT] Filtros dispon√≠veis - Etapas:", etapasOrdenadas);
    console.log("üéØ [RESULT] Filtros dispon√≠veis - Situa√ß√µes:", situacoesOrdenadas);
    
    return {
      etapas: etapasOrdenadas,
      situacoes: situacoesOrdenadas,
      fornecedores: fornecedoresOrdenados,
      etapasValidas: etapasValidas,
      situacoesValidas: situacoesValidas
    };
    
  } catch (error) {
    console.error("‚ùå Erro em obterFiltrosDisponiveis:", error);
    return {
      etapas: [],
      situacoes: [],
      fornecedores: [],
      etapasValidas: [],
      situacoesValidas: []
    };
  }
}

// üî•üî•üî• FUN√á√ïES AUXILIARES - COPIADAS DIRETO DO CADASTROS

function formatarPercentualParaExibicao(valor) {
  if (valor === null || valor === undefined || valor === '') {
    return '';
  }
  
  console.log("üîß GS->Front: formatarPercentualParaExibicao recebeu:", valor, "tipo:", typeof valor);
  
  try {
    if (typeof valor === 'string' && valor.includes('%')) {
      return valor;
    }
    
    if (typeof valor === 'number') {
      // üî• CORRE√á√ÉO: N√ÉO multiplica por 100 - usa o valor direto
      // Se √© 0.98, mostra 0,98%
      const formatado = valor.toFixed(2).replace('.', ',') + '%';
      console.log("‚úÖ GS->Front: N√∫mero formatado:", valor, "‚Üí", formatado);
      return formatado;
    }
    
    return String(valor || '');
    
  } catch (error) {
    console.error("‚ùå GS->Front: Erro em formatarPercentualParaExibicao:", error);
    return String(valor || '');
  }
}

function processarAdesao(valorAdesao) {
  if (!valorAdesao && valorAdesao !== 0) return 'Isento';
  const valorStr = valorAdesao.toString().trim();
  if (valorStr === 'Isento' || valorStr === '0' || valorStr === '0.00' || valorStr === 'R$ 0,00') {
    return 'Isento';
  }
  const numero = parseFloat(valorStr);
  if (!isNaN(numero)) {
    return numero;
  }
  return valorStr;
}

function formatarCNPJNoSheets(cnpj) {
  if (!cnpj) return '';
  if (cnpj.toString().includes('.') || cnpj.toString().includes('/') || cnpj.toString().includes('-')) {
    return cnpj.toString();
  }
  const cnpjStr = cnpj.toString().replace(/\D/g, '');
  if (cnpjStr.length === 14) {
    return cnpjStr.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
  }
  return cnpj;
}

function normalizarTexto(texto) {
  if (!texto || typeof texto !== 'string') return texto;
  return texto
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .toUpperCase()
    .trim();
}

// üî• FUN√á√ÉO PARA BUSCAR POR CNPJ
function buscarTodosCadastrosPorCNPJComWaitlabel(cnpj, waitlabel) {
  try {
    const cadastros = buscarTodosCadastrosComWaitlabel(waitlabel);
    const cnpjBuscado = cnpj.toString().replace(/\D/g, '');
    const cadastrosEncontrados = [];
    
    for (const cadastro of cadastros) {
      const cnpjCadastro = cadastro.cnpj?.toString().replace(/\D/g, '') || '';
      if (cnpjCadastro === cnpjBuscado) {
        cadastrosEncontrados.push(cadastro);
      }
    }
    
    return cadastrosEncontrados;
    
  } catch (error) {
    console.error("‚ùå Erro em buscarTodosCadastrosPorCNPJComWaitlabel:", error);
    return [];
  }
}

// üî• FUN√á√ÉO DE TESTE
function testar() {
  const totalCadastros = buscarTodosCadastrosComWaitlabel(CONFIG_FILHA.WAITLABEL_FILHA).length;
  const filtros = obterFiltrosDisponiveis();
  
  // Testar estrutura de uma linha
  const ss = SpreadsheetApp.openById(CONFIG_FILHA.ID_PLANILHA_MAE);
  const aba = ss.getSheetByName(CONFIG_FILHA.WAITLABEL_FILHA);
  
  let estruturaTeste = null;
  if (aba && aba.getLastRow() >= 2) {
    const primeiraLinha = aba.getRange(2, 1, 1, 18).getValues()[0];
    estruturaTeste = {
      colunas: primeiraLinha.length,
      colunas_nomes: [
        "RAZAO_SOCIAL", "NOME_FANTASIA", "CNPJ", "FORNECEDOR", "ULTIMA_ETAPA", "ETAPA", "OBSERVACAO",
        "CONTRATO_ENVIADO", "CONTRATO_ASSINADO", "ATIVACAO", "LINK", 
        "MENSALIDADE", "MENSALIDADE_SIM", "MDR", "TIS", "REBATE",
        "ADESAO", "SITUACAO"
      ],
      valores_amostra: primeiraLinha.slice(0, 18)
    };
  }
  
  return { 
    success: true, 
    message: "‚úÖ Sistema de VISUALIZA√á√ÉO RESULT funcionando!",
    modo: "Somente leitura - MESMA ESTRUTURA DO CADASTROS",
    waitlabel: CONFIG_FILHA.WAITLABEL_FILHA,
    totalCadastros: totalCadastros,
    colunas: "MESMAS DO CADASTROS: MENSALIDADE, MENSALIDADE_SIM, MDR, TIS, REBATE",
    estrutura_teste: estruturaTeste,
    timestamp: new Date().toISOString()
  };
}
