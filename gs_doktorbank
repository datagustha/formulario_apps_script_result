// CONFIGURAÃ‡ÃƒO DA PLANILHA FILHA DOKTORBANK (SOMENTE LEITURA) - CORRIGIDA PARA USAR ETAPAS
const CONFIG_FILHA = {
  ID_PLANILHA_MAE: "1V4iGN14UpIQcwf3qKU0_Wbiy2exdW2WUmrYTniy0upA",
  WAITLABEL_FILHA: "Doktorbank", // Waitlabel especÃ­fico do Doktorbank
  TIMEZONE: "America/Sao_Paulo"
};

// ğŸ”¥ğŸ”¥ğŸ”¥ FUNÃ‡ÃƒO CORRIGIDA - SIMPLIFICADA PARA VISUALIZAÃ‡ÃƒO
function formatarDataBrasilVisualizacao(data) {
  if (!data) return '';
  
  try {
    console.log("ğŸ“… formatarDataBrasilVisualizacao - Entrada:", data, "Tipo:", typeof data);
    
    // ğŸ”¥ CORREÃ‡ÃƒO: Se jÃ¡ Ã© string no formato correto, retornar COMO ESTÃ
    if (typeof data === 'string') {
      // Verificar se jÃ¡ estÃ¡ no formato dd/MM/yyyy HH:mm:ss
      if (data.match(/^\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}:\d{2}$/)) {
        console.log("âœ… JÃ¡ estÃ¡ no formato correto - retornando como estÃ¡:", data);
        return data;
      }
      // Verificar se estÃ¡ no formato dd/MM/yyyy
      if (data.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
        console.log("âœ… JÃ¡ estÃ¡ no formato data simples - retornando como estÃ¡:", data);
        return data;
      }
    }
    
    // Se Ã© objeto Date, formatar CORRETAMENTE
    if (data instanceof Date) {
      const dataBrasil = Utilities.formatDate(data, CONFIG_FILHA.TIMEZONE, "dd/MM/yyyy HH:mm:ss");
      console.log("âœ… Date convertido:", data.toString(), "â†’", dataBrasil);
      return dataBrasil;
    }
    
    // Para outros casos, tentar converter
    try {
      const dataObj = new Date(data);
      if (!isNaN(dataObj.getTime())) {
        const dataBrasil = Utilities.formatDate(dataObj, CONFIG_FILHA.TIMEZONE, "dd/MM/yyyy HH:mm:ss");
        console.log("âœ… Outro tipo convertido:", data, "â†’", dataBrasil);
        return dataBrasil;
      }
    } catch (e) {
      console.log("âš ï¸ NÃ£o conseguiu converter, retornando original:", data);
      return data.toString();
    }
    
    return data ? data.toString() : '';
    
  } catch (error) {
    console.error("âŒ Erro em formatarDataBrasilVisualizacao:", error);
    return data ? data.toString() : '';
  }
}

// ğŸ”¥ğŸ”¥ğŸ”¥ FUNÃ‡ÃƒO PRINCIPAL CORRIGIDA
function doGet() {
  const htmlOutput = HtmlService.createHtmlOutputFromFile('IndexFilha')
    .setTitle('Sistema Doktorbank - VisualizaÃ§Ã£o de Dados')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  
  return htmlOutput;
}

// ğŸ”¥ğŸ”¥ğŸ”¥ BUSCAR TODOS OS CADASTROS - VERSÃƒO CORRIGIDA PARA USAR ETAPAS
function buscarTodosCadastrosComWaitlabel(waitlabel) {
  try {
    console.log("ğŸ” [DOKTORBANK] Buscando dados no waitlabel:", waitlabel);
    
    const ss = SpreadsheetApp.openById(CONFIG_FILHA.ID_PLANILHA_MAE);
    const aba = ss.getSheetByName(waitlabel);
    
    if (!aba) {
      console.log("âŒ Aba nÃ£o encontrada:", waitlabel);
      return [];
    }
    
    const ultimaLinha = aba.getLastRow();
    console.log("ğŸ“Š Ãšltima linha encontrada:", ultimaLinha);
    
    if (ultimaLinha < 2) return [];
    
    // Buscar dados - usar nÃºmero fixo de colunas para consistÃªncia
    const dados = aba.getRange(2, 1, ultimaLinha - 1, 17).getValues();
    console.log("ğŸ“ˆ Dados brutos encontrados:", dados.length);
    
    const cadastros = [];
    
    for (let i = 0; i < dados.length; i++) {
      const linha = dados[i];
      
      if (!linha || !linha[0] || linha[0].toString().trim() === '') continue;

      // ğŸ”¥ğŸ”¥ğŸ”¥ CORREÃ‡ÃƒO CRÃTICA: Processamento SIMPLIFICADO de datas
      let ultimaEtapaFormatada = linha[4] ? linha[4].toString() : '';
      
      // Se Ã© Date, formatar corretamente
      if (linha[4] instanceof Date) {
        ultimaEtapaFormatada = Utilities.formatDate(linha[4], CONFIG_FILHA.TIMEZONE, "dd/MM/yyyy HH:mm:ss");
      }
      
      let ativacaoFormatada = linha[9] ? linha[9].toString() : '';
      
      // Se Ã© Date, formatar para exibiÃ§Ã£o simples
      if (linha[9] instanceof Date) {
        ativacaoFormatada = Utilities.formatDate(linha[9], CONFIG_FILHA.TIMEZONE, "dd/MM/yyyy");
      }

      // ğŸ”¥ CORREÃ‡ÃƒO: Processamento do percentual - MAIS SIMPLES
      let percentualTarifa = '0%';
      if (linha[14] !== null && linha[14] !== undefined && linha[14] !== '') {
        const valor = linha[14];
        
        if (typeof valor === 'number') {
          // NÃºmero direto: 0.035 â†’ 3.50%
          percentualTarifa = (valor * 100).toFixed(2) + '%';
        } else if (typeof valor === 'string') {
          const valorStr = valor.toString().trim();
          if (valorStr.includes('%')) {
            percentualTarifa = valorStr;
          } else {
            // Tentar converter string para nÃºmero
            const valorNum = parseFloat(valorStr.replace(',', '.'));
            if (!isNaN(valorNum)) {
              percentualTarifa = valorNum.toFixed(2) + '%';
            }
          }
        }
      }

      // ğŸ”¥ CORREÃ‡ÃƒO: Processamento da adesÃ£o - MAIS SIMPLES
      let adesaoFormatada = 'Isento';
      if (linha[15] !== null && linha[15] !== undefined && linha[15] !== '') {
        const valorAdesao = linha[15];
        if (typeof valorAdesao === 'number' && valorAdesao > 0) {
          adesaoFormatada = valorAdesao;
        } else if (typeof valorAdesao === 'string') {
          const valorStr = valorAdesao.toString().trim();
          if (valorStr !== 'Isento' && valorStr !== '0' && valorStr !== '0.00') {
            const valorNum = parseFloat(valorStr.replace('R$', '').replace(/\./g, '').replace(',', '.').trim());
            if (!isNaN(valorNum) && valorNum > 0) {
              adesaoFormatada = valorNum;
            }
          }
        }
      }

      // ğŸ”¥ğŸ”¥ğŸ”¥ CORREÃ‡ÃƒO: AGORA USA "ETAPA" EM VEZ DE "EVENTO"
      const cadastro = {
        id: i + 2,
        razao_social: linha[0]?.toString().trim() || '',
        nome_fantasia: linha[1]?.toString().trim() || '',
        cnpj: formatarCNPJNoSheets(linha[2]?.toString().trim() || ''),
        fornecedor: linha[3]?.toString().trim() || '',
        ultima_etapa: ultimaEtapaFormatada, // ğŸ”¥ MUDOU: ultima_etapa em vez de ultimo_evento
        etapa: linha[5]?.toString().trim() || '', // ğŸ”¥ MUDOU: etapa em vez de evento
        observacoes: linha[6]?.toString().trim() || '',
        contrato_enviado: linha[7]?.toString().trim() || '',
        contrato_assinado: linha[8]?.toString().trim() || '',
        ativacao: ativacaoFormatada,
        link: linha[10]?.toString().trim() || '',
        mensalidade: typeof linha[11] === 'number' ? linha[11] : 0,
        mensalidade_sim: typeof linha[12] === 'number' ? linha[12] : 0,
        tarifa: linha[13]?.toString().trim() || '',
        percentual_tarifa: percentualTarifa,
        adesao: adesaoFormatada,
        situacao: (linha[16]?.toString().trim() || 'Novo registro'),
        waitlabel: waitlabel
      };
      
      cadastros.push(cadastro);
    }
    
    console.log("âœ… [DOKTORBANK] Dados carregados para visualizaÃ§Ã£o:", cadastros.length);
    return cadastros;
    
  } catch (error) {
    console.error("âŒ [DOKTORBANK] Erro na busca:", error);
    return [];
  }
}

// ğŸ”¥ğŸ”¥ğŸ”¥ BUSCAR CADASTRO POR ID - VERSÃƒO CORRIGIDA PARA USAR ETAPAS
function buscarCadastroPorIDComWaitlabel(id, waitlabel) {
  try {
    console.log("ğŸ” [DOKTORBANK] Buscando cadastro por ID:", id, "no waitlabel:", waitlabel);
    
    const ss = SpreadsheetApp.openById(CONFIG_FILHA.ID_PLANILHA_MAE);
    const aba = ss.getSheetByName(waitlabel);
    if (!aba) return { encontrado: false, mensagem: "Waitlabel nÃ£o encontrado" };
    
    const ultimaLinha = aba.getLastRow();
    if (ultimaLinha < id) return { encontrado: false, mensagem: "Registro nÃ£o encontrado" };
    
    const linha = aba.getRange(id, 1, 1, 17).getValues()[0];
    
    if (!linha[0] || linha[0].toString().trim() === '') {
      return { encontrado: false, mensagem: "Registro vazio ou nÃ£o encontrado" };
    }

    console.log("ğŸ“Š [DOKTORBANK] DEBUG - Linha encontrada na linha", id);
    console.log("ğŸ” Coluna E [4] - Ãšltima etapa:", linha[4], "Tipo:", typeof linha[4]);
    console.log("ğŸ” Coluna J [9] - AtivaÃ§Ã£o:", linha[9], "Tipo:", typeof linha[9]);

    // ğŸ”¥ğŸ”¥ğŸ”¥ CORREÃ‡ÃƒO CRÃTICA: Processamento DIRETO das datas
    let ultimaEtapaFormatada = linha[4] ? linha[4].toString() : '';
    
    // Se Ã© Date, formatar mantendo o formato brasileiro
    if (linha[4] instanceof Date) {
      ultimaEtapaFormatada = Utilities.formatDate(linha[4], CONFIG_FILHA.TIMEZONE, "dd/MM/yyyy HH:mm:ss");
    }
    
    let ativacaoFormatada = '';
    if (linha[9]) {
      if (linha[9] instanceof Date) {
        // ğŸ”¥ CORREÃ‡ÃƒO: Para input date, usar formato yyyy-MM-dd
        ativacaoFormatada = Utilities.formatDate(linha[9], CONFIG_FILHA.TIMEZONE, "yyyy-MM-dd");
      } else {
        // Se jÃ¡ Ã© string, verificar formato e converter se necessÃ¡rio
        const dataStr = linha[9].toString();
        if (dataStr.includes('/')) {
          // Converter de dd/MM/yyyy para yyyy-MM-dd
          const partes = dataStr.split('/');
          if (partes.length === 3) {
            ativacaoFormatada = `${partes[2]}-${partes[1]}-${partes[0]}`;
          } else {
            ativacaoFormatada = dataStr;
          }
        } else {
          ativacaoFormatada = dataStr;
        }
      }
    }

    // ğŸ”¥ CORREÃ‡ÃƒO: Processamento SIMPLIFICADO do percentual
    let percentualTarifa = '0%';
    if (linha[14] !== null && linha[14] !== undefined && linha[14] !== '') {
      const valor = linha[14];
      
      if (typeof valor === 'number') {
        percentualTarifa = (valor * 100).toFixed(2) + '%';
      } else if (typeof valor === 'string') {
        const valorStr = valor.toString().trim();
        if (valorStr.includes('%')) {
          percentualTarifa = valorStr;
        } else {
          const valorNum = parseFloat(valorStr.replace(',', '.'));
          if (!isNaN(valorNum)) {
            percentualTarifa = valorNum.toFixed(2) + '%';
          }
        }
      }
    }

    // ğŸ”¥ CORREÃ‡ÃƒO: Processamento SIMPLIFICADO da adesÃ£o
    let adesaoFormatada = 'Isento';
    if (linha[15] !== null && linha[15] !== undefined && linha[15] !== '') {
      const valorAdesao = linha[15];
      if (typeof valorAdesao === 'number' && valorAdesao > 0) {
        adesaoFormatada = valorAdesao;
      } else if (typeof valorAdesao === 'string') {
        const valorStr = valorAdesao.toString().trim();
        if (valorStr !== 'Isento' && valorStr !== '0' && valorStr !== '0.00') {
          const valorNum = parseFloat(valorStr.replace('R$', '').replace(/\./g, '').replace(',', '.').trim());
          if (!isNaN(valorNum) && valorNum > 0) {
            adesaoFormatada = valorNum;
          }
        }
      }
    }

    // ğŸ”¥ğŸ”¥ğŸ”¥ CORREÃ‡ÃƒO: AGORA USA "ETAPA" EM VEZ DE "EVENTO"
    const resultado = {
      encontrado: true,
      id: id,
      razao_social: linha[0]?.toString().trim() || '',
      nome_fantasia: linha[1]?.toString().trim() || '',
      cnpj: formatarCNPJNoSheets(linha[2]?.toString().trim() || ''),
      fornecedor: linha[3]?.toString().trim() || '',
      ultima_etapa: ultimaEtapaFormatada, // ğŸ”¥ MUDOU: ultima_etapa em vez de ultimo_evento
      etapa: linha[5]?.toString().trim() || '', // ğŸ”¥ MUDOU: etapa em vez de evento
      observacoes: linha[6]?.toString().trim() || '',
      contrato_enviado: linha[7]?.toString().trim() || '',
      contrato_assinado: linha[8]?.toString().trim() || '',
      ativacao: ativacaoFormatada,
      link: linha[10]?.toString().trim() || '',
      mensalidade: typeof linha[11] === 'number' ? linha[11] : 0,
      mensalidade_sim: typeof linha[12] === 'number' ? linha[12] : 0,
      tarifa: linha[13]?.toString().trim() || '',
      percentual_tarifa: percentualTarifa,
      adesao: adesaoFormatada,
      situacao: (linha[16]?.toString().trim() || 'Novo registro'),
      waitlabel: waitlabel
    };

    console.log("âœ… [DOKTORBANK] Cadastro processado:", {
      id: resultado.id,
      razao_social: resultado.razao_social,
      ultima_etapa: resultado.ultima_etapa, // ğŸ”¥ MUDOU
      etapa: resultado.etapa, // ğŸ”¥ MUDOU
      ativacao: resultado.ativacao
    });
    
    return resultado;
    
  } catch (error) {
    console.error("âŒ [DOKTORBANK] Erro em buscarCadastroPorIDComWaitlabel:", error);
    return { encontrado: false, mensagem: "Erro: " + error.message };
  }
}

// ğŸ”¥ğŸ”¥ğŸ”¥ FUNÃ‡ÃƒO DE TESTE ATUALIZADA PARA ETAPAS
function testarDatasVisualizacao() {
  try {
    console.log("=== ğŸ§ª [DOKTORBANK] TESTE ESPECÃFICO PARA VISUALIZAÃ‡ÃƒO ===");
    
    const ss = SpreadsheetApp.openById(CONFIG_FILHA.ID_PLANILHA_MAE);
    const aba = ss.getSheetByName(CONFIG_FILHA.WAITLABEL_FILHA);
    
    if (!aba) {
      return { error: "Aba nÃ£o encontrada" };
    }
    
    // Buscar algumas linhas para testar
    const dadosTeste = aba.getRange(2, 1, 5, 17).getValues();
    const resultadosTeste = [];
    
    for (let i = 0; i < dadosTeste.length; i++) {
      const linha = dadosTeste[i];
      if (!linha[0] || linha[0].toString().trim() === '') continue;
      
      const ultimaEtapaOriginal = linha[4]; // ğŸ”¥ MUDOU: ultima_etapa
      const etapaAtual = linha[5]; // ğŸ”¥ NOVO: etapa atual
      const ativacaoOriginal = linha[9];
      
      // Processar como na funÃ§Ã£o corrigida
      let ultimaEtapaFormatada = ultimaEtapaOriginal ? ultimaEtapaOriginal.toString() : '';
      if (ultimaEtapaOriginal instanceof Date) {
        ultimaEtapaFormatada = Utilities.formatDate(ultimaEtapaOriginal, CONFIG_FILHA.TIMEZONE, "dd/MM/yyyy HH:mm:ss");
      }
      
      let ativacaoFormatada = '';
      if (ativacaoOriginal) {
        if (ativacaoOriginal instanceof Date) {
          ativacaoFormatada = Utilities.formatDate(ativacaoOriginal, CONFIG_FILHA.TIMEZONE, "yyyy-MM-dd");
        } else {
          ativacaoFormatada = ativacaoOriginal.toString();
        }
      }
      
      resultadosTeste.push({
        linha: i + 2,
        razao_social: linha[0]?.toString().trim() || '',
        etapa_atual: etapaAtual?.toString().trim() || '', // ğŸ”¥ NOVO: mostrar etapa atual
        ultima_etapa_original: ultimaEtapaOriginal, // ğŸ”¥ MUDOU
        ultima_etapa_formatada: ultimaEtapaFormatada, // ğŸ”¥ MUDOU
        ativacao_original: ativacaoOriginal,
        ativacao_formatada: ativacaoFormatada
      });
    }
    
    console.log("ğŸ“… [DOKTORBANK] Resultados do teste de visualizaÃ§Ã£o:", resultadosTeste);
    
    return {
      success: true,
      teste_visualizacao: resultadosTeste,
      message: "Teste de visualizaÃ§Ã£o Doktorbank concluÃ­do"
    };
    
  } catch (error) {
    console.error("âŒ [DOKTORBANK] Erro no teste de visualizaÃ§Ã£o:", error);
    return { error: error.message };
  }
}

// ğŸ”¥ FUNÃ‡Ã•ES AUXILIARES (MANTIDAS)
function formatarCNPJNoSheets(cnpj) {
  if (!cnpj) return '';
  if (cnpj.toString().includes('.') || cnpj.toString().includes('/') || cnpj.toString().includes('-')) {
    return cnpj.toString();
  }
  const cnpjStr = cnpj.toString().replace(/\D/g, '');
  if (cnpjStr.length === 14) {
    return cnpjStr.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
  }
  return cnpj;
}

// ğŸ”¥ FUNÃ‡ÃƒO DE TESTE ATUALIZADA
function testar() {
  const totalCadastros = buscarTodosCadastrosComWaitlabel(CONFIG_FILHA.WAITLABEL_FILHA).length;
  const testeDatas = testarDatasVisualizacao();
  
  return { 
    success: true, 
    message: "âœ… Sistema DOKTORBANK funcionando!",
    modo: "Somente leitura - CORRIGIDO PARA ETAPAS",
    waitlabel: CONFIG_FILHA.WAITLABEL_FILHA,
    totalCadastros: totalCadastros,
    teste_datas: testeDatas,
    timestamp: new Date().toISOString()
  };
}
