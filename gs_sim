// CONFIGURA√á√ÉO DA PLANILHA FILHA SIM (SOMENTE LEITURA) - CORRIGIDO COM ESTRUTURA ATUALIZADA
const CONFIG_FILHA = {
  ID_PLANILHA_MAE: "1V4iGN14UpIQcwf3qKU0_Wbiy2exdW2WUmrYTniy0upA",
  WAITLABEL_FILHA: "Sim_Facilita", // Waitlabel espec√≠fico do Sim
  TIMEZONE: "America/Sao_Paulo"
};

// üî•üî•üî• ESTRUTURA ATUALIZADA - SEGUNDO O FORMUL√ÅRIO (21 COLUNAS)
const COLUNAS_SIM_FACILITA = {
  RAZAO_SOCIAL: 0,
  NOME_FANTASIA: 1,
  CNPJ: 2,
  FORNECEDOR: 3,
  ULTIMA_ETAPA: 4,
  ETAPA: 5,
  OBSERVACAO: 6,
  CONTRATO_ENVIADO: 7,
  CONTRATO_ASSINADO: 8,
  ATIVACAO: 9,
  LINK: 10,
  PLANO: 11,           // üî• NOVA COLUNA
  MENSALIDADE: 12,     // üî• POSI√á√ÉO CORRIGIDA
  VENC: 13,            // üî• NOVA COLUNA
  METODO_PGTO: 14,     // üî• NOVA COLUNA
  MDR: 15,             // üî• POSI√á√ÉO CORRIGIDA
  TIS: 16,             // üî• POSI√á√ÉO CORRIGIDA
  REBATE: 17,          // üî• POSI√á√ÉO CORRIGIDA
  ADESAO: 18,          // üî• POSI√á√ÉO CORRIGIDA
  PGTO_ADESAO: 19,     // üî• NOVA COLUNA
  SITUACAO: 20         // üî• POSI√á√ÉO CORRIGIDA
};

// üî• FUN√á√ÉO PARA OBTER CONFIGURA√á√ÉO CORRETA
function getColunasConfigSim() {
  return COLUNAS_SIM_FACILITA;
}

// üî• FUN√á√ÉO PRINCIPAL
function doGet() {
  const htmlOutput = HtmlService.createHtmlOutputFromFile('IndexFilha')
    .setTitle('Sistema Sim - Visualiza√ß√£o de Dados')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  
  return htmlOutput;
}

// üî• BUSCAR TODOS OS CADASTROS - ATUALIZADO COM ESTRUTURA CORRETA
function buscarTodosCadastrosComWaitlabel(waitlabel) {
  try {
    console.log("üîç [SIM-ATUALIZADO] Buscando dados no waitlabel:", waitlabel);
    
    const ss = SpreadsheetApp.openById(CONFIG_FILHA.ID_PLANILHA_MAE);
    const aba = ss.getSheetByName(waitlabel);
    
    if (!aba) {
      console.log("‚ùå Aba n√£o encontrada:", waitlabel);
      return [];
    }
    
    const ultimaLinha = aba.getLastRow();
    console.log("üìä √öltima linha encontrada:", ultimaLinha);
    
    if (ultimaLinha < 2) return [];
    
    const COLUNAS = getColunasConfigSim();
    const TOTAL_COLUNAS = 21; // üî• AGORA S√ÉO 21 COLUNAS
    
    // Buscar dados com todas as colunas (21 colunas conforme estrutura ATUAL)
    const dados = aba.getRange(2, 1, ultimaLinha - 1, TOTAL_COLUNAS).getValues();
    console.log("üìà Dados brutos encontrados:", dados.length, "linhas x", dados[0]?.length || 0, "colunas");
    
    const cadastros = [];
    
    for (let i = 0; i < dados.length; i++) {
      const linha = dados[i];
      
      if (!linha || !linha[0] || linha[0].toString().trim() === '') continue;

      // üî• Processamento de datas
      let ultimaEtapaFormatada = linha[COLUNAS.ULTIMA_ETAPA] ? linha[COLUNAS.ULTIMA_ETAPA].toString() : '';
      
      if (linha[COLUNAS.ULTIMA_ETAPA] instanceof Date) {
        const dataUTC = linha[COLUNAS.ULTIMA_ETAPA];
        const dataBrasilia = new Date(dataUTC.getTime() - (5 * 60 * 60 * 1000));
        ultimaEtapaFormatada = Utilities.formatDate(dataBrasilia, CONFIG_FILHA.TIMEZONE, "dd/MM/yyyy HH:mm:ss");
      }
      
      let ativacaoFormatada = linha[COLUNAS.ATIVACAO] ? linha[COLUNAS.ATIVACAO].toString() : '';
      
      if (linha[COLUNAS.ATIVACAO] instanceof Date) {
        ativacaoFormatada = Utilities.formatDate(linha[COLUNAS.ATIVACAO], CONFIG_FILHA.TIMEZONE, "dd/MM/yyyy");
      }
      
      let pgtoAdesaoFormatado = '';
      if (linha[COLUNAS.PGTO_ADESAO]) {
        if (linha[COLUNAS.PGTO_ADESAO] instanceof Date) {
          pgtoAdesaoFormatado = Utilities.formatDate(linha[COLUNAS.PGTO_ADESAO], CONFIG_FILHA.TIMEZONE, "dd/MM/yyyy");
        } else {
          pgtoAdesaoFormatado = linha[COLUNAS.PGTO_ADESAO].toString().trim();
        }
      }

      // üî• Processamento dos percentuais usando as fun√ß√µes do formul√°rio
      let mdrFormatado = formatarPercentualParaExibicao(linha[COLUNAS.MDR]);
      let tisFormatado = formatarPercentualParaExibicao(linha[COLUNAS.TIS]);
      let rebateFormatado = formatarPercentualParaExibicao(linha[COLUNAS.REBATE]);

      // üî• Processamento da ades√£o
      let adesaoFormatada = processarAdesao(linha[COLUNAS.ADESAO]);

      const cadastro = {
        id: i + 2,
        razao_social: linha[COLUNAS.RAZAO_SOCIAL]?.toString().trim() || '',
        nome_fantasia: linha[COLUNAS.NOME_FANTASIA]?.toString().trim() || '',
        cnpj: formatarCNPJNoSheets(linha[COLUNAS.CNPJ]?.toString().trim() || ''),
        fornecedor: linha[COLUNAS.FORNECEDOR]?.toString().trim() || '',
        ultima_etapa: ultimaEtapaFormatada,
        etapa: linha[COLUNAS.ETAPA]?.toString().trim() || '',
        observacoes: linha[COLUNAS.OBSERVACAO]?.toString().trim() || '',
        contrato_enviado: linha[COLUNAS.CONTRATO_ENVIADO]?.toString().trim() || '',
        contrato_assinado: linha[COLUNAS.CONTRATO_ASSINADO]?.toString().trim() || '',
        ativacao: ativacaoFormatada,
        link: linha[COLUNAS.LINK]?.toString().trim() || '',
        
        // üî• DADOS ESPEC√çFICOS DO SIM_FACILITA:
        plano: linha[COLUNAS.PLANO]?.toString().trim() || '',           // üî• NOVO
        mensalidade: formatarMoedaParaExibicao(linha[COLUNAS.MENSALIDADE] || 0),
        vencimento: linha[COLUNAS.VENC]?.toString().trim() || '',      // üî• NOVO
        metodo_pgto: linha[COLUNAS.METODO_PGTO]?.toString().trim() || '', // üî• NOVO
        mdr: mdrFormatado,
        tis: tisFormatado,
        rebate: rebateFormatado,
        adesao: adesaoFormatada,
        pgto_adesao: pgtoAdesaoFormatado,                               // üî• NOVO
        
        situacao: (linha[COLUNAS.SITUACAO]?.toString().trim() || 'NOVO REGISTRO'),
        waitlabel: waitlabel
      };
      
      console.log(`‚úÖ [SIM-ATUALIZADO] Linha ${i+2} - Raz√£o Social: "${cadastro.razao_social}", Plano: "${cadastro.plano}"`);
      
      cadastros.push(cadastro);
    }
    
    console.log("‚úÖ [SIM-ATUALIZADO] Dados carregados para visualiza√ß√£o:", cadastros.length);
    return cadastros;
    
  } catch (error) {
    console.error("‚ùå [SIM-ATUALIZADO] Erro na busca:", error);
    return [];
  }
}

// üî• BUSCAR CADASTRO POR ID - ATUALIZADO COM ESTRUTURA CORRETA
function buscarCadastroPorIDComWaitlabel(id, waitlabel) {
  try {
    console.log("üîç [SIM-ATUALIZADO] Buscando cadastro por ID:", id, "no waitlabel:", waitlabel);
    
    const ss = SpreadsheetApp.openById(CONFIG_FILHA.ID_PLANILHA_MAE);
    const aba = ss.getSheetByName(waitlabel);
    if (!aba) return { encontrado: false, mensagem: "Waitlabel n√£o encontrado" };
    
    const ultimaLinha = aba.getLastRow();
    if (ultimaLinha < id) return { encontrado: false, mensagem: "Registro n√£o encontrado" };
    
    const COLUNAS = getColunasConfigSim();
    const TOTAL_COLUNAS = 21;
    
    const linha = aba.getRange(id, 1, 1, TOTAL_COLUNAS).getValues()[0];
    
    if (!linha[0] || linha[0].toString().trim() === '') {
      return { encontrado: false, mensagem: "Registro vazio ou n√£o encontrado" };
    }

    // üî• Processamento de datas
    let ultimaEtapaFormatada = linha[COLUNAS.ULTIMA_ETAPA] ? linha[COLUNAS.ULTIMA_ETAPA].toString() : '';
    
    if (linha[COLUNAS.ULTIMA_ETAPA] instanceof Date) {
      const dataUTC = linha[COLUNAS.ULTIMA_ETAPA];
      const dataBrasilia = new Date(dataUTC.getTime() - (5 * 60 * 60 * 1000));
      ultimaEtapaFormatada = Utilities.formatDate(dataBrasilia, CONFIG_FILHA.TIMEZONE, "dd/MM/yyyy HH:mm:ss");
    }
    
    let ativacaoFormatada = '';
    if (linha[COLUNAS.ATIVACAO]) {
      if (linha[COLUNAS.ATIVACAO] instanceof Date) {
        ativacaoFormatada = Utilities.formatDate(linha[COLUNAS.ATIVACAO], CONFIG_FILHA.TIMEZONE, "yyyy-MM-dd");
      } else {
        const dataStr = linha[COLUNAS.ATIVACAO].toString();
        if (dataStr.includes('/')) {
          const partes = dataStr.split('/');
          if (partes.length === 3) {
            ativacaoFormatada = `${partes[2]}-${partes[1]}-${partes[0]}`;
          } else {
            ativacaoFormatada = dataStr;
          }
        } else {
          ativacaoFormatada = dataStr;
        }
      }
    }
    
    let pgtoAdesaoFormatado = '';
    if (linha[COLUNAS.PGTO_ADESAO]) {
      if (linha[COLUNAS.PGTO_ADESAO] instanceof Date) {
        pgtoAdesaoFormatado = Utilities.formatDate(linha[COLUNAS.PGTO_ADESAO], CONFIG_FILHA.TIMEZONE, "yyyy-MM-dd");
      } else {
        const dataStr = linha[COLUNAS.PGTO_ADESAO].toString();
        if (dataStr.includes('/')) {
          const partes = dataStr.split('/');
          if (partes.length === 3) {
            pgtoAdesaoFormatado = `${partes[2]}-${partes[1]}-${partes[0]}`;
          } else {
            pgtoAdesaoFormatado = dataStr;
          }
        } else {
          pgtoAdesaoFormatado = dataStr;
        }
      }
    }

    // üî• Processamento dos percentuais
    let mdrFormatado = formatarPercentualParaExibicao(linha[COLUNAS.MDR]);
    let tisFormatado = formatarPercentualParaExibicao(linha[COLUNAS.TIS]);
    let rebateFormatado = formatarPercentualParaExibicao(linha[COLUNAS.REBATE]);

    // üî• Processamento da ades√£o
    let adesaoFormatada = processarAdesao(linha[COLUNAS.ADESAO]);

    // Criar objeto fornecedor para formul√°rio
    const fornecedorParaFormulario = {
      nome: linha[COLUNAS.FORNECEDOR]?.toString().trim() || '',
      mdr: mdrFormatado,
      tis: tisFormatado,
      rebate: rebateFormatado
    };
    
    const resultado = {
      encontrado: true,
      id: id,
      razao_social: linha[COLUNAS.RAZAO_SOCIAL]?.toString().trim() || '',
      nome_fantasia: linha[COLUNAS.NOME_FANTASIA]?.toString().trim() || '',
      cnpj: formatarCNPJNoSheets(linha[COLUNAS.CNPJ]?.toString().trim() || ''),
      fornecedor: linha[COLUNAS.FORNECEDOR]?.toString().trim() || '',
      fornecedores: [fornecedorParaFormulario],
      ultima_etapa: ultimaEtapaFormatada,
      etapa: linha[COLUNAS.ETAPA]?.toString().trim() || '',
      observacoes: linha[COLUNAS.OBSERVACAO]?.toString().trim() || '',
      contrato_enviado: linha[COLUNAS.CONTRATO_ENVIADO]?.toString().trim() || '',
      contrato_assinado: linha[COLUNAS.CONTRATO_ASSINADO]?.toString().trim() || '',
      ativacao: ativacaoFormatada,
      link: linha[COLUNAS.LINK]?.toString().trim() || '',
      
      // üî• DADOS ESPEC√çFICOS DO SIM_FACILITA:
      plano: linha[COLUNAS.PLANO]?.toString().trim() || '',              // üî• NOVO
      mensalidade: formatarMoedaParaExibicao(linha[COLUNAS.MENSALIDADE] || 0),
      vencimento: linha[COLUNAS.VENC]?.toString().trim() || '',         // üî• NOVO
      metodo_pgto: linha[COLUNAS.METODO_PGTO]?.toString().trim() || '', // üî• NOVO
      mdr: mdrFormatado,
      tis: tisFormatado,
      rebate: rebateFormatado,
      adesao: adesaoFormatada,
      pgto_adesao: pgtoAdesaoFormatado,                                  // üî• NOVO
      
      situacao: (linha[COLUNAS.SITUACAO]?.toString().trim() || 'NOVO REGISTRO'),
      waitlabel: waitlabel
    };

    console.log("‚úÖ [SIM-ATUALIZADO] Cadastro processado:", {
      id: resultado.id,
      razao_social: resultado.razao_social,
      plano: resultado.plano,
      situacao: resultado.situacao,
      mensalidade: resultado.mensalidade,
      vencimento: resultado.vencimento
    });
    
    return resultado;
    
  } catch (error) {
    console.error("‚ùå [SIM-ATUALIZADO] Erro em buscarCadastroPorIDComWaitlabel:", error);
    return { encontrado: false, mensagem: "Erro: " + error.message };
  }
}

// üî•üî•üî• FUN√á√ïES AUXILIARES - ATUALIZADAS

function formatarPercentualParaExibicao(valor) {
  // üî• USANDO A MESMA FUN√á√ÉO DO FORMUL√ÅRIO
  if (valor === null || valor === undefined || valor === '') {
    return '';
  }
  
  console.log("üîß [SIM-ATUALIZADO] formatarPercentualParaExibicao recebeu:", valor, "tipo:", typeof valor);
  
  try {
    // Se j√° √© string com %, retornar como est√°
    if (typeof valor === 'string' && valor.includes('%')) {
      console.log("‚úÖ J√° tem %, retornando:", valor);
      return valor;
    }
    
    let numero;
    
    if (typeof valor === 'string') {
      // Limpar a string - remover % e converter v√≠rgula para ponto
      const valorLimpo = valor.replace('%', '').replace(',', '.');
      numero = parseFloat(valorLimpo);
      
      if (isNaN(numero)) {
        console.log("‚ö†Ô∏è String n√£o √© n√∫mero v√°lido:", valor);
        return valor;
      }
    } else if (typeof valor === 'number') {
      numero = valor;
    } else {
      console.log("‚ö†Ô∏è Tipo n√£o suportado:", typeof valor);
      return String(valor);
    }
    
    // üî• CORRE√á√ÉO: Se < 1 (decimal), multiplica por 100; se >= 1, mant√©m
    let valorParaExibir;
    
    if (numero < 1) {
      // √â decimal (0.0553) ‚Üí converte para percentual (5.53)
      valorParaExibir = numero * 100;
      console.log("üìä Decimal <1 convertido para exibi√ß√£o:", numero, "‚Üí", valorParaExibir);
    } else if (numero >= 1 && numero <= 100) {
      // J√° est√° em percentual (5.53) ‚Üí mant√©m
      valorParaExibir = numero;
      console.log("üìä J√° est√° em percentual, mantendo:", valorParaExibir);
    } else {
      // N√∫mero grande, provavelmente j√° √© percentual de alguma forma
      valorParaExibir = numero;
      console.log("üìä N√∫mero grande, mantendo como est√°:", valorParaExibir);
    }
    
    // Formatar com 2 casas decimais e adicionar %
    const formatado = valorParaExibir.toFixed(2).replace('.', ',') + '%';
    console.log("‚úÖ Formatado para exibi√ß√£o:", formatado);
    
    return formatado;
    
  } catch (error) {
    console.error("‚ùå Erro em formatarPercentualParaExibicao:", error);
    return String(valor || '');
  }
}

function formatarMoedaParaExibicao(valor) {
  if (valor === null || valor === undefined || valor === '') {
    return 'R$ 0,00';
  }
  
  try {
    const numero = typeof valor === 'string' ? 
                   parseFloat(valor.replace('R$', '').replace(/\./g, '').replace(',', '.').trim()) : 
                   parseFloat(valor);
    
    if (isNaN(numero)) {
      return 'R$ 0,00';
    }
    
    // Formatar como moeda brasileira
    return numero.toLocaleString('pt-BR', { 
      style: 'currency', 
      currency: 'BRL',
      minimumFractionDigits: 2
    });
  } catch (error) {
    console.error("‚ùå Erro ao formatar moeda:", error);
    return 'R$ 0,00';
  }
}

function processarAdesao(valorAdesao) {
  if (!valorAdesao && valorAdesao !== 0) return 'Isento';
  const valorStr = valorAdesao.toString().trim();
  if (valorStr === 'Isento' || valorStr === '0' || valorStr === '0.00' || valorStr === 'R$ 0,00') {
    return 'Isento';
  }
  const numero = parseFloat(valorStr);
  if (!isNaN(numero)) {
    return numero;
  }
  return valorStr;
}

function formatarCNPJNoSheets(cnpj) {
  if (!cnpj) return '';
  if (cnpj.toString().includes('.') || cnpj.toString().includes('/') || cnpj.toString().includes('-')) {
    return cnpj.toString();
  }
  const cnpjStr = cnpj.toString().replace(/\D/g, '');
  if (cnpjStr.length === 14) {
    return cnpjStr.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
  }
  return cnpj;
}

function normalizarTexto(texto) {
  if (!texto || typeof texto !== 'string') return texto;
  return texto
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .toUpperCase()
    .trim();
}

// üî• FUN√á√ÉO PARA BUSCAR POR CNPJ - ATUALIZADA
function buscarTodosCadastrosPorCNPJComWaitlabel(cnpj, waitlabel) {
  try {
    const cadastros = buscarTodosCadastrosComWaitlabel(waitlabel);
    const cnpjBuscado = cnpj.toString().replace(/\D/g, '');
    const cadastrosEncontrados = [];
    
    for (const cadastro of cadastros) {
      const cnpjCadastro = cadastro.cnpj?.toString().replace(/\D/g, '') || '';
      if (cnpjCadastro === cnpjBuscado) {
        cadastrosEncontrados.push(cadastro);
      }
    }
    
    return cadastrosEncontrados;
    
  } catch (error) {
    console.error("‚ùå [SIM-ATUALIZADO] Erro em buscarTodosCadastrosPorCNPJComWaitlabel:", error);
    return [];
  }
}

// üî• FUN√á√ÉO DE TESTE - PARA VERIFICAR A ESTRUTURA ATUALIZADA
function testar() {
  try {
    const ss = SpreadsheetApp.openById(CONFIG_FILHA.ID_PLANILHA_MAE);
    const aba = ss.getSheetByName(CONFIG_FILHA.WAITLABEL_FILHA);
    
    if (!aba) {
      return { error: "Aba n√£o encontrada: " + CONFIG_FILHA.WAITLABEL_FILHA };
    }
    
    // Testar estrutura da planilha
    const ultimaColuna = aba.getLastColumn();
    const ultimaLinha = aba.getLastRow();
    
    console.log("üìä Estrutura da planilha:", {
      linhas: ultimaLinha,
      colunas: ultimaColuna,
      esperado: 21
    });
    
    // Testar algumas linhas
    const dadosTeste = aba.getRange(2, 1, 5, 21).getValues();
    const resultadosTeste = [];
    
    for (let i = 0; i < dadosTeste.length; i++) {
      const linha = dadosTeste[i];
      if (!linha[0] || linha[0].toString().trim() === '') continue;
      
      resultadosTeste.push({
        linha: i + 2,
        razao_social: linha[COLUNAS_SIM_FACILITA.RAZAO_SOCIAL]?.toString().trim() || '',
        cnpj: linha[COLUNAS_SIM_FACILITA.CNPJ]?.toString().trim() || '',
        fornecedor: linha[COLUNAS_SIM_FACILITA.FORNECEDOR]?.toString().trim() || '',
        plano: linha[COLUNAS_SIM_FACILITA.PLANO]?.toString().trim() || '',           // üî• NOVO
        situacao: linha[COLUNAS_SIM_FACILITA.SITUACAO]?.toString().trim() || '',
        etapa: linha[COLUNAS_SIM_FACILITA.ETAPA]?.toString().trim() || '',
        mensalidade: linha[COLUNAS_SIM_FACILITA.MENSALIDADE] || 0,
        vencimento: linha[COLUNAS_SIM_FACILITA.VENC]?.toString().trim() || '',      // üî• NOVO
        metodo_pgto: linha[COLUNAS_SIM_FACILITA.METODO_PGTO]?.toString().trim() || '', // üî• NOVO
        mdr: linha[COLUNAS_SIM_FACILITA.MDR] || '',
        tis: linha[COLUNAS_SIM_FACILITA.TIS] || '',
        rebate: linha[COLUNAS_SIM_FACILITA.REBATE] || '',
        adesao: linha[COLUNAS_SIM_FACILITA.ADESAO] || '',
        pgto_adesao: linha[COLUNAS_SIM_FACILITA.PGTO_ADESAO]?.toString().trim() || ''  // üî• NOVO
      });
    }
    
    // Testar busca de cadastros
    const totalCadastros = buscarTodosCadastrosComWaitlabel(CONFIG_FILHA.WAITLABEL_FILHA).length;
    
    return { 
      success: true, 
      message: "‚úÖ Sistema de VISUALIZA√á√ÉO SIM ATUALIZADO funcionando!",
      modo: "Somente leitura - ESTRUTURA ATUALIZADA DO SIM_FACILITA",
      waitlabel: CONFIG_FILHA.WAITLABEL_FILHA,
      totalCadastros: totalCadastros,
      estrutura: {
        colunas_totais: ultimaColuna,
        esperado: 21,
        colunas_novas: ["PLANO", "VENC", "METODO_PGTO", "PGTO_ADESAO"],
        status: ultimaColuna === 21 ? "‚úÖ CORRETO" : `‚ùå ERRO: Esperado 21, encontrado ${ultimaColuna}`
      },
      estrutura_teste: resultadosTeste,
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    console.error("‚ùå Erro no teste:", error);
    return { 
      error: error.message,
      stack: error.stack 
    };
  }
}
