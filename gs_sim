// CONFIGURA√á√ÉO DA PLANILHA FILHA SIM (SOMENTE LEITURA) - AJUSTADO COM MESMOS NOMES
const CONFIG_FILHA = {
  ID_PLANILHA_MAE: "1V4iGN14UpIQcwf3qKU0_Wbiy2exdW2WUmrYTniy0upA",
  WAITLABEL_FILHA: "Sim_Facilita", // Waitlabel espec√≠fico do Sim
  TIMEZONE: "America/Sao_Paulo"
};

// üî• ESTRUTURA DAS COLUNAS - EXATAMENTE IGUAL AO CADASTROS/RESULT
const COLUNAS_SIM = {
  RAZAO_SOCIAL: 0,
  NOME_FANTASIA: 1,
  CNPJ: 2,
  FORNECEDOR: 3,
  ULTIMA_ETAPA: 4,
  ETAPA: 5,
  OBSERVACAO: 6,
  CONTRATO_ENVIADO: 7,
  CONTRATO_ASSINADO: 8,
  ATIVACAO: 9,
  LINK: 10,
  MENSALIDADE: 11,
  MENSALIDADE_SIM: 12,
  MDR: 13,        // üî• AGORA √â MDR (era tarifa)
  TIS: 14,        // üî• AGORA √â TIS (era percentual_tarifa)
  REBATE: 15,     // üî• AGORA √â REBATE (nova coluna)
  ADESAO: 16,
  SITUACAO: 17
};

// üî• FUN√á√ÉO PRINCIPAL
function doGet() {
  const htmlOutput = HtmlService.createHtmlOutputFromFile('IndexFilha')
    .setTitle('Sistema Sim - Visualiza√ß√£o de Dados')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  
  return htmlOutput;
}

// üî• BUSCAR TODOS OS CADASTROS - COM MESMA L√ìGICA DO RESULT
function buscarTodosCadastrosComWaitlabel(waitlabel) {
  try {
    console.log("üîç [SIM] Buscando dados no waitlabel:", waitlabel);
    
    const ss = SpreadsheetApp.openById(CONFIG_FILHA.ID_PLANILHA_MAE);
    const aba = ss.getSheetByName(waitlabel);
    
    if (!aba) {
      console.log("‚ùå Aba n√£o encontrada:", waitlabel);
      return [];
    }
    
    const ultimaLinha = aba.getLastRow();
    console.log("üìä √öltima linha encontrada:", ultimaLinha);
    
    if (ultimaLinha < 2) return [];
    
    // Buscar dados com todas as colunas (18 colunas conforme estrutura)
    const dados = aba.getRange(2, 1, ultimaLinha - 1, 18).getValues();
    console.log("üìà Dados brutos encontrados:", dados.length, "linhas x", dados[0]?.length || 0, "colunas");
    
    const cadastros = [];
    
    for (let i = 0; i < dados.length; i++) {
      const linha = dados[i];
      
      if (!linha || !linha[0] || linha[0].toString().trim() === '') continue;

      // üî• Processamento de datas - IGUAL AO RESULT
      let ultimaEtapaFormatada = linha[COLUNAS_SIM.ULTIMA_ETAPA] ? linha[COLUNAS_SIM.ULTIMA_ETAPA].toString() : '';
      
      if (linha[COLUNAS_SIM.ULTIMA_ETAPA] instanceof Date) {
        const dataUTC = linha[COLUNAS_SIM.ULTIMA_ETAPA];
        const dataBrasilia = new Date(dataUTC.getTime() - (5 * 60 * 60 * 1000));
        ultimaEtapaFormatada = Utilities.formatDate(dataBrasilia, CONFIG_FILHA.TIMEZONE, "dd/MM/yyyy HH:mm:ss");
      }
      
      let ativacaoFormatada = linha[COLUNAS_SIM.ATIVACAO] ? linha[COLUNAS_SIM.ATIVACAO].toString() : '';
      
      if (linha[COLUNAS_SIM.ATIVACAO] instanceof Date) {
        ativacaoFormatada = Utilities.formatDate(linha[COLUNAS_SIM.ATIVACAO], CONFIG_FILHA.TIMEZONE, "dd/MM/yyyy");
      }

      // üî• Processamento do MDR - EXATAMENTE IGUAL AO RESULT
      let mdrFormatado = formatarPercentualParaExibicao(linha[COLUNAS_SIM.MDR]);
      
      // üî• Processamento do TIS - EXATAMENTE IGUAL AO RESULT
      let tisFormatado = formatarPercentualParaExibicao(linha[COLUNAS_SIM.TIS]);
      
      // üî• Processamento do REBATE - EXATAMENTE IGUAL AO RESULT
      let rebateFormatado = formatarPercentualParaExibicao(linha[COLUNAS_SIM.REBATE]);

      // üî• Processamento da ades√£o - EXATAMENTE IGUAL AO RESULT
      let adesaoFormatada = processarAdesao(linha[COLUNAS_SIM.ADESAO]);

      const cadastro = {
        id: i + 2,
        razao_social: linha[COLUNAS_SIM.RAZAO_SOCIAL]?.toString().trim() || '',
        nome_fantasia: linha[COLUNAS_SIM.NOME_FANTASIA]?.toString().trim() || '',
        cnpj: formatarCNPJNoSheets(linha[COLUNAS_SIM.CNPJ]?.toString().trim() || ''),
        fornecedor: linha[COLUNAS_SIM.FORNECEDOR]?.toString().trim() || '',
        ultima_etapa: ultimaEtapaFormatada,
        etapa: linha[COLUNAS_SIM.ETAPA]?.toString().trim() || '',
        observacoes: linha[COLUNAS_SIM.OBSERVACAO]?.toString().trim() || '',
        contrato_enviado: linha[COLUNAS_SIM.CONTRATO_ENVIADO]?.toString().trim() || '',
        contrato_assinado: linha[COLUNAS_SIM.CONTRATO_ASSINADO]?.toString().trim() || '',
        ativacao: ativacaoFormatada,
        link: linha[COLUNAS_SIM.LINK]?.toString().trim() || '',
        
        // üî• DADOS FINANCEIROS - MESMOS NOMES DO RESULT:
        mensalidade: typeof linha[COLUNAS_SIM.MENSALIDADE] === 'number' ? linha[COLUNAS_SIM.MENSALIDADE] : 0,
        mensalidade_sim: typeof linha[COLUNAS_SIM.MENSALIDADE_SIM] === 'number' ? linha[COLUNAS_SIM.MENSALIDADE_SIM] : 0,
        mdr: mdrFormatado,           // MESMO NOME: mdr
        tis: tisFormatado,           // MESMO NOME: tis
        rebate: rebateFormatado,     // MESMO NOME: rebate
        
        adesao: adesaoFormatada,
        situacao: (linha[COLUNAS_SIM.SITUACAO]?.toString().trim() || 'Novo registro'),
        waitlabel: waitlabel
      };
      
      console.log(`‚úÖ [SIM] Linha ${i+2} - Situa√ß√£o: "${cadastro.situacao}"`);
      
      cadastros.push(cadastro);
    }
    
    console.log("‚úÖ [SIM] Dados carregados para visualiza√ß√£o:", cadastros.length);
    return cadastros;
    
  } catch (error) {
    console.error("‚ùå [SIM] Erro na busca:", error);
    return [];
  }
}

// üî• BUSCAR CADASTRO POR ID - COM MESMA L√ìGICA DO RESULT
function buscarCadastroPorIDComWaitlabel(id, waitlabel) {
  try {
    console.log("üîç [SIM] Buscando cadastro por ID:", id, "no waitlabel:", waitlabel);
    
    const ss = SpreadsheetApp.openById(CONFIG_FILHA.ID_PLANILHA_MAE);
    const aba = ss.getSheetByName(waitlabel);
    if (!aba) return { encontrado: false, mensagem: "Waitlabel n√£o encontrado" };
    
    const ultimaLinha = aba.getLastRow();
    if (ultimaLinha < id) return { encontrado: false, mensagem: "Registro n√£o encontrado" };
    
    const linha = aba.getRange(id, 1, 1, 18).getValues()[0];
    
    if (!linha[0] || linha[0].toString().trim() === '') {
      return { encontrado: false, mensagem: "Registro vazio ou n√£o encontrado" };
    }

    // üî• Processamento de datas - IGUAL AO RESULT
    let ultimaEtapaFormatada = linha[COLUNAS_SIM.ULTIMA_ETAPA] ? linha[COLUNAS_SIM.ULTIMA_ETAPA].toString() : '';
    
    if (linha[COLUNAS_SIM.ULTIMA_ETAPA] instanceof Date) {
      const dataUTC = linha[COLUNAS_SIM.ULTIMA_ETAPA];
      const dataBrasilia = new Date(dataUTC.getTime() - (5 * 60 * 60 * 1000));
      ultimaEtapaFormatada = Utilities.formatDate(dataBrasilia, CONFIG_FILHA.TIMEZONE, "dd/MM/yyyy HH:mm:ss");
    }
    
    let ativacaoFormatada = '';
    if (linha[COLUNAS_SIM.ATIVACAO]) {
      if (linha[COLUNAS_SIM.ATIVACAO] instanceof Date) {
        ativacaoFormatada = Utilities.formatDate(linha[COLUNAS_SIM.ATIVACAO], CONFIG_FILHA.TIMEZONE, "yyyy-MM-dd");
      } else {
        const dataStr = linha[COLUNAS_SIM.ATIVACAO].toString();
        if (dataStr.includes('/')) {
          const partes = dataStr.split('/');
          if (partes.length === 3) {
            ativacaoFormatada = `${partes[2]}-${partes[1]}-${partes[0]}`;
          } else {
            ativacaoFormatada = dataStr;
          }
        } else {
          ativacaoFormatada = dataStr;
        }
      }
    }

    // üî• Processamento do MDR - EXATAMENTE IGUAL AO RESULT
    let mdrFormatado = formatarPercentualParaExibicao(linha[COLUNAS_SIM.MDR]);
    
    // üî• Processamento do TIS - EXATAMENTE IGUAL AO RESULT
    let tisFormatado = formatarPercentualParaExibicao(linha[COLUNAS_SIM.TIS]);
    
    // üî• Processamento do REBATE - EXATAMENTE IGUAL AO RESULT
    let rebateFormatado = formatarPercentualParaExibicao(linha[COLUNAS_SIM.REBATE]);

    // üî• Processamento da ades√£o - EXATAMENTE IGUAL AO RESULT
    let adesaoFormatada = processarAdesao(linha[COLUNAS_SIM.ADESAO]);

    // Criar objeto fornecedor para formul√°rio
    const fornecedorParaFormulario = {
      nome: linha[COLUNAS_SIM.FORNECEDOR]?.toString().trim() || '',
      mdr: mdrFormatado,
      tis: tisFormatado,
      rebate: rebateFormatado
    };
    
    const resultado = {
      encontrado: true,
      id: id,
      razao_social: linha[COLUNAS_SIM.RAZAO_SOCIAL]?.toString().trim() || '',
      nome_fantasia: linha[COLUNAS_SIM.NOME_FANTASIA]?.toString().trim() || '',
      cnpj: formatarCNPJNoSheets(linha[COLUNAS_SIM.CNPJ]?.toString().trim() || ''),
      fornecedor: linha[COLUNAS_SIM.FORNECEDOR]?.toString().trim() || '',
      fornecedores: [fornecedorParaFormulario],
      ultima_etapa: ultimaEtapaFormatada,
      etapa: linha[COLUNAS_SIM.ETAPA]?.toString().trim() || '',
      observacoes: linha[COLUNAS_SIM.OBSERVACAO]?.toString().trim() || '',
      contrato_enviado: linha[COLUNAS_SIM.CONTRATO_ENVIADO]?.toString().trim() || '',
      contrato_assinado: linha[COLUNAS_SIM.CONTRATO_ASSINADO]?.toString().trim() || '',
      ativacao: ativacaoFormatada,
      link: linha[COLUNAS_SIM.LINK]?.toString().trim() || '',
      
      // üî• DADOS FINANCEIROS - MESMOS NOMES:
      mensalidade: parseFloat(linha[COLUNAS_SIM.MENSALIDADE]) || 0,
      mensalidade_sim: parseFloat(linha[COLUNAS_SIM.MENSALIDADE_SIM]) || 0,
      mdr: mdrFormatado,          // MESMO NOME: mdr
      tis: tisFormatado,          // MESMO NOME: tis
      rebate: rebateFormatado,    // MESMO NOME: rebate
      
      adesao: adesaoFormatada,
      situacao: (linha[COLUNAS_SIM.SITUACAO]?.toString().trim() || 'Novo registro'),
      waitlabel: waitlabel
    };

    console.log("‚úÖ [SIM] Cadastro processado:", {
      id: resultado.id,
      razao_social: resultado.razao_social,
      situacao: resultado.situacao, // üî• VERIFICAR SITUA√á√ÉO
      mensalidade: resultado.mensalidade,
      mdr: resultado.mdr
    });
    
    return resultado;
    
  } catch (error) {
    console.error("‚ùå [SIM] Erro em buscarCadastroPorIDComWaitlabel:", error);
    return { encontrado: false, mensagem: "Erro: " + error.message };
  }
}

// üî•üî•üî• FUN√á√ïES AUXILIARES - COPIADAS DIRETO DO RESULT

function formatarPercentualParaExibicao(valor) {
  if (valor === null || valor === undefined || valor === '') {
    return '';
  }
  
  console.log("üîß [SIM] GS->Front: formatarPercentualParaExibicao recebeu:", valor, "tipo:", typeof valor);
  
  try {
    if (typeof valor === 'string' && valor.includes('%')) {
      return valor;
    }
    
    if (typeof valor === 'number') {
      // üî• CORRE√á√ÉO: N√ÉO multiplica por 100 - usa o valor direto
      // Se √© 0.98, mostra 0,98%
      const formatado = valor.toFixed(2).replace('.', ',') + '%';
      console.log("‚úÖ [SIM] GS->Front: N√∫mero formatado:", valor, "‚Üí", formatado);
      return formatado;
    }
    
    return String(valor || '');
    
  } catch (error) {
    console.error("‚ùå [SIM] GS->Front: Erro em formatarPercentualParaExibicao:", error);
    return String(valor || '');
  }
}

function processarAdesao(valorAdesao) {
  if (!valorAdesao && valorAdesao !== 0) return 'Isento';
  const valorStr = valorAdesao.toString().trim();
  if (valorStr === 'Isento' || valorStr === '0' || valorStr === '0.00' || valorStr === 'R$ 0,00') {
    return 'Isento';
  }
  const numero = parseFloat(valorStr);
  if (!isNaN(numero)) {
    return numero;
  }
  return valorStr;
}

function formatarCNPJNoSheets(cnpj) {
  if (!cnpj) return '';
  if (cnpj.toString().includes('.') || cnpj.toString().includes('/') || cnpj.toString().includes('-')) {
    return cnpj.toString();
  }
  const cnpjStr = cnpj.toString().replace(/\D/g, '');
  if (cnpjStr.length === 14) {
    return cnpjStr.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
  }
  return cnpj;
}

function normalizarTexto(texto) {
  if (!texto || typeof texto !== 'string') return texto;
  return texto
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .toUpperCase()
    .trim();
}

// üî• FUN√á√ÉO PARA BUSCAR POR CNPJ
function buscarTodosCadastrosPorCNPJComWaitlabel(cnpj, waitlabel) {
  try {
    const cadastros = buscarTodosCadastrosComWaitlabel(waitlabel);
    const cnpjBuscado = cnpj.toString().replace(/\D/g, '');
    const cadastrosEncontrados = [];
    
    for (const cadastro of cadastros) {
      const cnpjCadastro = cadastro.cnpj?.toString().replace(/\D/g, '') || '';
      if (cnpjCadastro === cnpjBuscado) {
        cadastrosEncontrados.push(cadastro);
      }
    }
    
    return cadastrosEncontrados;
    
  } catch (error) {
    console.error("‚ùå [SIM] Erro em buscarTodosCadastrosPorCNPJComWaitlabel:", error);
    return [];
  }
}

// üî• FUN√á√ÉO DE TESTE - PARA VERIFICAR A ESTRUTURA
function testar() {
  try {
    const ss = SpreadsheetApp.openById(CONFIG_FILHA.ID_PLANILHA_MAE);
    const aba = ss.getSheetByName(CONFIG_FILHA.WAITLABEL_FILHA);
    
    if (!aba) {
      return { error: "Aba n√£o encontrada: " + CONFIG_FILHA.WAITLABEL_FILHA };
    }
    
    // Testar algumas linhas
    const dadosTeste = aba.getRange(2, 1, 5, 18).getValues();
    const resultadosTeste = [];
    
    for (let i = 0; i < dadosTeste.length; i++) {
      const linha = dadosTeste[i];
      if (!linha[0] || linha[0].toString().trim() === '') continue;
      
      resultadosTeste.push({
        linha: i + 2,
        razao_social: linha[COLUNAS_SIM.RAZAO_SOCIAL]?.toString().trim() || '',
        cnpj: linha[COLUNAS_SIM.CNPJ]?.toString().trim() || '',
        fornecedor: linha[COLUNAS_SIM.FORNECEDOR]?.toString().trim() || '',
        situacao: linha[COLUNAS_SIM.SITUACAO]?.toString().trim() || '',
        etapa: linha[COLUNAS_SIM.ETAPA]?.toString().trim() || '',
        mensalidade: linha[COLUNAS_SIM.MENSALIDADE] || 0,
        mensalidade_sim: linha[COLUNAS_SIM.MENSALIDADE_SIM] || 0,
        mdr: linha[COLUNAS_SIM.MDR] || '',
        tis: linha[COLUNAS_SIM.TIS] || '',
        rebate: linha[COLUNAS_SIM.REBATE] || '',
        adesao: linha[COLUNAS_SIM.ADESAO] || ''
      });
    }
    
    // Testar busca de cadastros
    const totalCadastros = buscarTodosCadastrosComWaitlabel(CONFIG_FILHA.WAITLABEL_FILHA).length;
    
    return { 
      success: true, 
      message: "‚úÖ Sistema de VISUALIZA√á√ÉO SIM funcionando!",
      modo: "Somente leitura - MESMA ESTRUTURA DO RESULT",
      waitlabel: CONFIG_FILHA.WAITLABEL_FILHA,
      totalCadastros: totalCadastros,
      colunas: "MESMAS DO RESULT: MENSALIDADE, MENSALIDADE_SIM, MDR, TIS, REBATE",
      estrutura_teste: resultadosTeste,
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    console.error("‚ùå Erro no teste:", error);
    return { 
      error: error.message,
      stack: error.stack 
    };
  }
}
